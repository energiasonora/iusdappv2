<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERC-20 Token Selectors</title>
    <script src="js/ethers-6.13.2.umd.min.js"></script>

    <style>
        .token-info {
            font-weight: bold;
            margin-top: 5px;
        }

        body {
            background-color: black;
            color: green;
        }
    </style>
</head>

<body>

    <h1>TOKEN SELECTOR FOR IUS NATURALIS</h1>
    <p>---------------</p>
    <div id="address"></div>
    <div id="data"></div>
    <pre id="yourAddress"> </pre>



    <h1>token selectors</h1>
    <div>
        <label for="tokenSelector1">Select Default Token:</label>
        <select id="tokenSelector1" class="token-selector">
            <!-- Options will be populated dynamically -->
        </select>
    </div>

    <div>
        <label for="tokenSelector2">Select Default Token:</label>
        <select id="tokenSelector2" class="token-selector">
            <!-- Options will be populated dynamically -->
        </select>
    </div>

    <div>
        <label for="tokenSelector3">Select Default Token:</label>
        <select id="tokenSelector3" class="token-selector">
            <!-- Options will be populated dynamically -->
        </select>
    </div>


    <h1 class="codrops-header__title" id="userData">TOKEN: __ ()</h1>
    <div id="bigBalanceWalletmodal"></div>
    <div id="bigBalanceWalletsendmodal"></div>


    <script>
     

        function adjustBalances(chainName, chainId, explorer, userAddress, nativeBalance, tokenName) {
            // chainName y chainId son obligatorios

            // const userDataHtml = `
            //     <a target="_blank" rel="noopener noreferrer" href="${explorer}/address/${userAddress}">
            //     ${nativeBalance} ${tokenName}
            //     </a> 
            //     <svg class='hoverIcon' xmlns="http://www.w3.org/2000/svg" width="18" height="16" viewBox="0 0 512 512" id='reloadBalance' onclick="event.stopPropagation();reloadBalance()">
            //     <path fill='#d17c78' d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/>
            //     </svg> 
            // `;

            const modalHtml = `
            <span class="top">${chainName} (${chainId})</span>
            <span class="bal">${nativeBalance}</span>
            <span class="eth">${tokenName}</span>
        `;

            document.getElementById('userData').innerHTML = modalHtml;
            //   document.getElementById('bigBalanceWalletsendmodal').innerHTML = userDataHtml;
            //   document.getElementById('bigBalanceWalletmodal').innerHTML = modalHtml;
        }



        // -----------------------------------------
        //  FUNCTIONS
        // -----------------------------------------
        // [{"tokenName":"TROK","chainName":"Arbitrum Sepolia","chainId":421614,"contractAddr":"0x3723A0d04ABDFA902d47426973E0cb49C2fC3B86","rpcs":["https://sepolia-rollup.arbitrum.io/rpc"],"explorers":[{"name":"Arbitrum Sepolia Rollup Testnet Explorer","url":"https://sepolia-explorer.arbitrum.io","standard":"EIP3091"}]},{"tokenName":"USDC","chainName":"Sepolia","chainId":11155111,"contractAddr":"0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238","rpcs":["https://rpc.sepolia.org","https://rpc2.sepolia.org","https://rpc-sepolia.rockx.com","https://rpc.sepolia.ethpandaops.io","https://sepolia.gateway.tenderly.co","https://ethereum-sepolia-rpc.publicnode.com","https://sepolia.drpc.org","https://rpc-sepolia.rockx.com"],"explorers":[{"name":"etherscan-sepolia","url":"https://sepolia.etherscan.io","standard":"EIP3091"},{"name":"otterscan-sepolia","url":"https://sepolia.otterscan.io","standard":"EIP3091"}]}]

        // Array of tokens to populate the selectors 
        let tokens = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];

        // Get all selectors by class name
        const selectors = document.querySelectorAll('.token-selector');

        // Function to populate a <select> element with options
        function populateSelector(selector) {
            tokens.forEach(token => {
                const option = document.createElement('option');
                option.value = `${token.contractAddr},${token.chainId}`;
                option.textContent = `${token.tokenName} ${token.chainName} (${token.chainId})`;
                selector.appendChild(option);
                // console.log('OPTION:', option)
            });

            // Retrieve and set the saved value from localStorage
            const savedValue = localStorage.getItem(selector.dataset.selectorId);
            if (savedValue) {
                selector.value = savedValue;
            }
        }

        // Populate each selector with token options and set the saved default
        selectors.forEach(selector => {
            populateSelector(selector);

            // Save selected option to localStorage on change
            selector.addEventListener('change', () => {
                localStorage.setItem(selector.dataset.selectorId, selector.value);
            });
        });

    </script>



    <div id="tokenSelector1-info" class="token-info"></div>
    <div id="tokenSelector2-info" class="token-info"></div>
    <div id="tokenSelector3-info" class="token-info"></div>


    <script>

        // -----------------------------------------
        // WALLET FUNCTIONS
        // -----------------------------------------


        // Function to derive an address on demand
        async function deriveAddressWallet(mnemonic, index) {
            const basePath = "m/44'/60'/0'/0/";
            const path = `${basePath}${index}`;
            const derivedNode = ethers.HDNodeWallet.fromPhrase(mnemonic, path);
            return derivedNode
        }

        async function aliceWallet() {
            let aliceMnemonic = localStorage.getItem('aliceMnemonic');
            if (!aliceMnemonic) {
                console.error('NO aliceMnemonic  in localStorage!');

                const randmnemonic = await ethers.HDNodeWallet.createRandom()
                aliceMnemonic = randmnemonic.mnemonic.phrase;
                localStorage.setItem('aliceMnemonic', aliceMnemonic);

            } else {
                console.log('aliceMnemonic is in localStorage!');

            }
            let aliceWall = deriveAddressWallet(aliceMnemonic, 0)
            return aliceWall
        }

        // 1- GET  PRIV KEY(IF not CREATE IT)
        async function bobWallet() {
            let bobMnemonic = localStorage.getItem('bobMnemonic');
            if (!bobMnemonic) {
                console.error('NO bobMnemonic  in localStorage!');

                const randmnemonic = await ethers.HDNodeWallet.createRandom()
                bobMnemonic = randmnemonic.mnemonic.phrase;
                console.log(bobMnemonic)
                localStorage.setItem('bobMnemonic', bobMnemonic);

            } else {
                console.log('bobMnemonic is in localStorage!');

            }

            let bobWall = deriveAddressWallet(bobMnemonic, 0)
            return bobWall

        }


        // ----------------------------------------------------------------------------
        // Cargar las entradas desde localStorage o usar los datos iniciales
        // ----------------------------------------------------------------------------

        window.onload = async () => {
            let alicewallet = await aliceWallet()
            a = alicewallet
            const userAddress = alicewallet.address;
            document.getElementById('yourAddress').setAttribute('address', userAddress);
            yourAddress.innerHTML = `${userAddress} <svg id='copyAddress' onclick="event.stopPropagation();copy2clipboard('${userAddress}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill='currentColor' d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"/></svg> <svg id='shareAddress' onclick="event.stopPropagation();copy2clipboard('${userAddress}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><path fill='currentColor'  d="M352 224c53 0 96-43 96-96s-43-96-96-96s-96 43-96 96c0 4 .2 8 .7 11.9l-94.1 47C145.4 170.2 121.9 160 96 160c-53 0-96 43-96 96s43 96 96 96c25.9 0 49.4-10.2 66.6-26.9l94.1 47c-.5 3.9-.7 7.8-.7 11.9c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-25.9 0-49.4 10.2-66.6 26.9l-94.1-47c.5-3.9 .7-7.8 .7-11.9s-.2-8-.7-11.9l94.1-47C302.6 213.8 326.1 224 352 224z"/></svg>`;
            console.log(`Your address: ${userAddress} `)


        };

        // Global variable to store the selected token and token data
        let selectedToken = '';
        const tokenState = {
            tokenData: {}, // Caches token data to avoid redundant fetches
        };

       

        function updateAllSelectors(newToken) {
            console.warn('updateAllSelectors:', newToken)
            // Loop through all selectors and set their value to the new token
            document.querySelectorAll('.token-selector').forEach(selector => {
                selector.value = newToken;
            });
        }




        function updateUI(data) {
            // Update the UI for all selectors with the token information
            document.querySelectorAll('.token-info').forEach(infoDiv => {
                infoDiv.textContent = `${data.name} (${data.symbol}) - Decimals: ${data.decimals}`;
            });
        }



        async function onSelectorChange(event) {
            const input = event.target.value; // Suponiendo que es algo como "0xDireccionContrato,1"
            console.log("onSelectorChange input:", input);
            const [pretokenAddress, prechainId] = input.split(',');
            let tokenAddress = pretokenAddress.trim();
            let  chainId = prechainId;
            // Update the selected token and synchronize selectors
            selectedToken = tokenAddress;
            console.warn("ONSELECTOR CHANGE", `${tokenAddress},${chainId}`);
            updateAllSelectors(`${tokenAddress},${chainId}`);

            // Check if we have token data cached, fetch if not
            if (!tokenState.tokenData[tokenAddress]) {
                console.log('TOKEN IS CACHED!')
                const data = await fetchTokenData(tokenAddress,chainId);
                // const data = await fetchTokenData(tokenAddress);
                tokenState.tokenData[tokenAddress] = data; // Cache the token data
                updateUI(data);
            } else {
                updateUI(tokenState.tokenData[tokenAddress]);
            }
        }

        // Attach event listener to all selectors
        document.querySelectorAll('.token-selector').forEach(selector => {
            selector.addEventListener('change', onSelectorChange);
        });


         // Function to fetch token data
            async function fetchTokenData(tokenAddress, chainId) {
            console.warn('FETCHING!!!',tokenAddress, chainId)

            // return
            const erc20Abi = [
                "function name() view returns (string)",
                "function symbol() view returns (string)",
                "function decimals() view returns (uint8)",
            ];
            const provider = new ethers.JsonRpcProvider(`https://arbitrum-sepolia.blockpi.network/v1/rpc/public`);
            const tokenContract = new ethers.Contract(tokenAddress, erc20Abi, provider);
            const [name, symbol, decimals] = await Promise.all([
                tokenContract.name(),
                tokenContract.symbol(),
                tokenContract.decimals(),
            ]);
            return { name, symbol, decimals };
        }



    </script>

</body>

</html>