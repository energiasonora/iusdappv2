<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENCRYPT ETH PRIVATE KEY TO STORE IT </title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />

    <style>
        /* body {
            background-color: rgb(7, 42, 60);
            color: green;
        } */

        #result {
            word-wrap: break-word;

        }
    </style>


</head>

<body>
    <h1>ENCRYPTv3 </h1>
    <p>Encrypt private key (with elliptic)</p>
    <div id="messagesResult"></div>
    <p>
    <div id="result"></div>

    <script src="js/ethers-6.12.1.umd.min.js" type="application/javascript"></script>
 


    <script type="module">

        import elliptic from 'elliptic';
        window.elliptic = elliptic;


        import EthCrypto from 'eth-crypto';
        window.EthCrypto = EthCrypto;



        async function init() {


            //GENERATE ETHEREUM KEYPAIR
            const ethWallet = ethers.Wallet.createRandom();
            ethPrivateKey = ethWallet.privateKey;
            ethPubKey = ethWallet.publicKey;
            console.log('ethPrivateKey:', ethPrivateKey)
            result.innerHTML += '<strong> ETH PRIVATE KEY TO ENCRYPT:</strong> ' + ethPrivateKey
            result.innerHTML += '<br><strong> ETH PUBLIC KEY:</strong> <br>' + ethPubKey

            //GENERATE STARKNET KEYPAIR
            const EC = elliptic.ec;
            starkEC = new EC('secp256k1');  // Ensure you use the correct curve used by StarkNet
            console.log('starkEC:', starkEC)
            result.innerHTML += '<br><br><strong> STARKNET  KEYPAIR</strong>:'
            starkKeyPair = starkEC.genKeyPair();
            let starkPublicKey = starkKeyPair.getPublic('hex');
            let starkPrivateKey = starkKeyPair.getPrivate('hex');
            // console.log('starkPublicKey:', starkPublicKey);
            result.innerHTML += '<br><strong> PUBLIC </strong> ' + starkPublicKey
            // console.log('starkPrivateKey:', starkPrivateKey)
            result.innerHTML += '<br><strong>PRIVATE</strong>:<br> ' + starkPrivateKey




// 0. coniverte en estring la eth priv key
const secretMessage = EthCrypto.cipher.stringify(ethPrivateKey);
console.log('ethPrivKeyString: ', secretMessage)


//1. firma el hash del mensaje
//2. arma un payload con el mensaje + la firma 
//3. lo encrpta
//4. lo convierte en estring
// const bob = EthCrypto.createIdentity();


// 1.
const signature = EthCrypto.sign(
    starkPrivateKey,
    EthCrypto.hash.keccak256(secretMessage)
);
console.log('signature: ', signature)

// 2.
const payload = {
    message: secretMessage,
    signature
};

// 3.
const encrypted = await EthCrypto.encryptWithPublicKey(
    starkPublicKey, // by encrypting with his own publicKey, only she can decrypt the payload with his privateKey
    // bob.publicKey, // by encrypting with bobs publicKey, only bob can decrypt the payload with his privateKey
    JSON.stringify(payload) // we have to stringify the payload before we can encrypt it
);

console.log('Alice encrypted ETH private key to store in registry:', encrypted)
// messagesResult.innerHTML +='Alice encrypted message to Bob:', encrypted;
/*  { iv: 'c66fbc24cc7ef520a7...', ephemPublicKey: '048e34ce5cca0b69d4e1f5...', ciphertext: '27b91fe986e3ab030...', mac: 'dd7b78c16e462c42876745c7...' }
*/


// 4.
// we convert the object into a smaller string-representation
const encryptedString = EthCrypto.cipher.stringify(encrypted);
console.log('Alice encrypted ETH private key to store in registry STRING: ', encryptedString)

            // return encryptedString


 
// we parse the string into the object again
const encryptedObject = EthCrypto.cipher.parse(encryptedString);

const decrypted = await EthCrypto.decryptWithPrivateKey(
    starkPrivateKey,
    // bob.privateKey,
    encryptedObject
);
const decryptedPayload = JSON.parse(decrypted);

// check signature
const senderAddress = EthCrypto.recover(
    decryptedPayload.signature,
    EthCrypto.hash.keccak256(decryptedPayload.message)
);

console.log( 'ETH Private key stored  by  ' + senderAddress + 'is: ' + decryptedPayload.message );

result.innerHTML +='<br><br>ETH Private key stored  by  ' + senderAddress + ' is: <br> ' + decryptedPayload.message



        }

        init()

    </script>
</body>

</html>