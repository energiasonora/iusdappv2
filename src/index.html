<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>IUS NATURALIS DAPP</title>
	<meta name="description"
		content="a DID managing tool to communicate your public and private data with sovereignty" />
	<meta name="keywords" content="did, starknet " />
	<meta name="author" content="Xunorus" />
	<link rel="shortcut icon" href="favicon.ico">
	<link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet">
	<script src="js/sweetalert2.all.min.js"></script>
	<script src="js/qr-code-styling.js"></script>

	<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/css/autoComplete.01.min.css"> -->

	<!-- @5.1.3 -->
	<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script> -->
	<script src="js/bootstrap.bundle.min.js"></script>
	<!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"> -->
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<!-- @5.1.3 -->
	<link rel="stylesheet" type="text/css" href="css/cropper.css" />
	<link rel="stylesheet" type="text/css" href="css/iusdapp.css" />
	<link rel="stylesheet" type="text/css" href="css/buttons.css" />
	<link rel="stylesheet" type="text/css" href="css/numbers.css" />

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
	<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/css/autoComplete.02.min.css"> -->

	<!--[if IE]>
  		<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
	<script>document.documentElement.className = 'js';</script>
</head>

<body class="demo-1">

	<div id="headerNotes"></div>

	<!-- /*********************************************************************************************
  .) OVERLAY
  **********************************************************************************************/ -->

	<div class="overlay"></div>


	<!-- /*********************************************************************************************
  .) LOCK UNLOCK BANNER
  **********************************************************************************************/ -->
	<div id='lockscreen' class="cover-container" style="display: none;">
		<img src="img/logowt.png" alt="Cover Image" class="cover-image" id="logoLockscreen">
		<button id="unlockButton" class="btn btn-primary btn-unlock"
			onclick="event.stopPropagation();unlockLocalwallet()">Unlock</button>
	</div>

	<!-- /*********************************************************************************************
  .) SIDEBAR
  **********************************************************************************************/ -->
	<div id="sidebar" class='sidebar'>
		<a class='closeonclick' href="/">
			<div class='title'> </div>
		</a>

		<input name="avatarIMG" id="avatarIMGfile" type="file" style="display:none" accept="image/*" />
		<!-- ex fileCreateItemFile -->
		<img id="avatarIMG" src="img/anonym.jpg" alt="Avatar" class=""> <!-- ex itemImgMINT -->

		<span id="userAlias" class="d-flex align-items-center justify-content-center"
			style=" word-break: break-all; "></span>

		<div class="container mt-3">
			<div class="row">
				<div class="col text-center" id="configButtons">

					<button type="button"   class="btn btn-primary" onclick="event.stopPropagation();addAddress()">
						<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 640 512">
							<path
								d="M96 128a128 128 0 1 1 256 0A128 128 0 1 1 96 128zM0 482.3C0 383.8 79.8 304 178.3 304h91.4C368.2 304 448 383.8 448 482.3c0 16.4-13.3 29.7-29.7 29.7H29.7C13.3 512 0 498.7 0 482.3zM504 312V248H440c-13.3 0-24-10.7-24-24s10.7-24 24-24h64V136c0-13.3 10.7-24 24-24s24 10.7 24 24v64h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H552v64c0 13.3-10.7 24-24 24s-24-10.7-24-24z" />
						</svg>
					</button>

					<!-- ESTOS DOS BOTONES PROXIMO CAMBIO  -->

					<button type="button"   class="btn btn-danger" onclick="event.stopPropagation(); showWallet()">
						<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">
							<path
								d="M64 32C28.7 32 0 60.7 0 96L0 416c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64l0-224c0-35.3-28.7-64-64-64L80 128c-8.8 0-16-7.2-16-16s7.2-16 16-16l368 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L64 32zM416 272a32 32 0 1 1 0 64 32 32 0 1 1 0-64z" />
						</svg>
					</button>

					<!-- <button type="button"   class="btn btn-danger" onclick="event.stopPropagation(); scanAddress()">
					<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512">
						<path
						d="M0 80C0 53.5 21.5 32 48 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V80zM64 96v64h64V96H64zM0 336c0-26.5 21.5-48 48-48h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V336zm64 16v64h64V352H64zM304 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H304c-26.5 0-48-21.5-48-48V80c0-26.5 21.5-48 48-48zm80 64H320v64h64V96zM256 304c0-8.8 7.2-16 16-16h64c8.8 0 16 7.2 16 16s7.2 16 16 16h32c8.8 0 16-7.2 16-16s7.2-16 16-16s16 7.2 16 16v96c0 8.8-7.2 16-16 16H368c-8.8 0-16-7.2-16-16s-7.2-16-16-16s-16 7.2-16 16v64c0 8.8-7.2 16-16 16H272c-8.8 0-16-7.2-16-16V304zM368 480a16 16 0 1 1 0-32 16 16 0 1 1 0 32zm64 0a16 16 0 1 1 0-32 16 16 0 1 1 0 32z" />
					</svg>
				</button> -->

					<!-- FIN de ESTOS DOS BOTONES PROXIMO CAMBIO  -->

					<button type="button"   class="btn btn-success" onclick="event.stopPropagation(); settings()">
						<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">
							<path
								d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z" />
						</svg>
					</button>
				</div>
			</div>
		</div>

		<button class="btn btn-primary fullwidth" style="display: none;" id="updateOnchain"
			onclick="event.stopPropagation(); updateOnchainDID()" disabled> Update
		</button>

		<ul id="cwContacts" class="nav"> </ul>

		<!-- id="createIPFSDelivery" -->
		<button class="btn btn-primary btn-lg fullwidth "
			onclick="event.stopPropagation();publishInDID((this.parentElement))" disabled data-translate="publicipfs">
			<i class="fa-solid fa-envelope-circle-check"></i> Preparer comme Envoi
			IPFS</button>

		<button class="btn btn-primary fullwidth" id="mintOrUpdate" onclick="event.stopPropagation(); mintOrUpdate()"
			disabled> Mint
		</button>

	</div>


	<!-----------------------------
	LOADER 
	--------------------------->
	<div class="loaderDiv" id="loader"> <span class="loader"></span> </div>

	<svg class="hidden">
		<defs>

			<!-- 1 -->
			<symbol id="icon-menu" viewBox="0 0 24 24">
				<title>menu</title>
				<image preserveAspectRatio="none" inkscape:svg-dpi="300" width="17.49" height="19.988571"
					style="image-rendering:optimizeQuality"
					xlink:href="data:image/svg+xml;base64,PHN2ZyBpZD0iaWNvbi1tZW51IiB2aWV3Qm94PSIwIDAgNDQ4IDUxMiI+CjxwYXRoIGQ9Ik0wIDk2 QzAgNzguMyAxNC4zIDY0IDMyIDY0SDQxNmMxNy43IDAgMzIgMTQuMyAzMiAzMnMtMTQuMyAzMi0z MiAzMkgzMkMxNC4zIDEyOCAwIDExMy43IDAgOTZ6TTAgMjU2YzAtMTcuNyAxNC4zLTMyIDMyLTMy SDQxNmMxNy43IDAgMzIgMTQuMyAzMiAzMnMtMTQuMyAzMi0zMiAzMkgzMmMtMTcuNyAwLTMyLTE0 LjMtMzItMzJ6TTQ0OCA0MTZjMCAxNy43LTE0LjMgMzItMzIgMzJIMzJjLTE3LjcgMC0zMi0xNC4z LTMyLTMyczE0LjMtMzIgMzItMzJINDE2YzE3LjcgMCAzMiAxNC4zIDMyIDMyeiIvPgo8L3N2Zz4K "
					id="image120" x="3.2550001" y="2.0057144" />
			</symbol>
			<!-- 1 -->
			<symbol id="icon-arrow" viewBox="0 0 24 24">
				<title>arrow</title>
				<polygon points="6.3,12.8 20.9,12.8 20.9,11.2 6.3,11.2 10.2,7.2 9,6 3.1,12 9,18 10.2,16.8 " />
			</symbol>

			<symbol id="icon-drop" viewBox="0 0 24 24">
				<title>drop</title>
				<path
					d="M12,21c-3.6,0-6.6-3-6.6-6.6C5.4,11,10.8,4,11.4,3.2C11.6,3.1,11.8,3,12,3s0.4,0.1,0.6,0.3c0.6,0.8,6.1,7.8,6.1,11.2C18.6,18.1,15.6,21,12,21zM12,4.8c-1.8,2.4-5.2,7.4-5.2,9.6c0,2.9,2.3,5.2,5.2,5.2s5.2-2.3,5.2-5.2C17.2,12.2,13.8,7.3,12,4.8z" />
				<path
					d="M12,18.2c-0.4,0-0.7-0.3-0.7-0.7s0.3-0.7,0.7-0.7c1.3,0,2.4-1.1,2.4-2.4c0-0.4,0.3-0.7,0.7-0.7c0.4,0,0.7,0.3,0.7,0.7C15.8,16.5,14.1,18.2,12,18.2z" />
			</symbol>
			<symbol id="icon-search" viewBox="0 0 24 24">
				<title>search</title>
				<path
					d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
			</symbol>
			<symbol id="icon-cross" viewBox="0 0 24 24">
				<title>cross</title>
				<path
					d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
			</symbol>
		</defs>
	</svg>
	
	
	
				<!-- <div class="search-wrap">
					<button id="btn-search" class="btn btn--search" style="display: none;"> <svg class="icon icon--search">
							<use xlink:href="#icon-search"></use>
						</svg></button>
				</div> -->

	<main class="main-wrap">
		<header class="codrops-header">
			<button id="lightButton" class="traffic-light"></button>


		
				 <!-- <section   class="tokenBalance">
					<span class="top"> Arbitrum Sepolia(461614):</span>
					<span class="bal">-999.9999</span>
					<span class="eth">ETH</span>
					<span class="bottom"> 0.00043 ETH</span>
				</section> -->
				<section   class="tokenBalance">
					<span class="top"> </span>
					<span class="bal">
				</span>
					<span class="eth"> </span>
					<!-- <button>Send</button> -->
					<span class="bottom">Loading balance <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div>
				</span>
				</section>


			<button   class="right hamburger hamburger--elastic" type="button" aria-label="Menu"
			aria-controls="navigation">
			<span class="badge bg-primary" id="chatBadge">-</span>
				<span class="hamburger-box">
					<span class="hamburger-inner"></span>
				</span>
			</button>


		</header>

		<!-- =================== -->
		<div id="qrtroqcontainer" class=" container swiperSlide">


			<div class=" responsive-svg" id="canvas"></div>

		</div>
		<pre id="yourAddress"> </pre>
		<!-- ======================= -->


		<div id="qrresult"> </div>


		<!-- ADD PUBLIC DOCUMENTS -->
		<div class="bottom-nav">
			<nav class="codrops-demos">
				<span>v5.20</span>
			</nav>
		</div>

		<!-- FIN UI -->

	</main>


	<div class="search" id="chatContainer">
		<!-- <button id="btn-search-close" class="btn btn--search-close" aria-label="Close search form" onclick="event.stopPropagation();deleteChat((this.parentElement))"><svg class="icon icon--cross"><use xlink:href="#icon-cross"></use></svg></button> -->

		<div id="chatheader" class="">
			<span id="chatAddress"></span>
			<div id="singleChatlightButton" class="traffic-light"></div>
			<span class="alignright " id="actionButtons"> </span>
		</div>



		<div class="search__related" id="chatBox">
			<div class="search__suggestion">
				<h3>WELCOME</h3>
				<p>Your chat is being prepared.</p>
				<p>Please, be patient</p>
				<div class="loader"></div>

			</div>

		</div>


		<form class="search__form" action="" id="chatfooter" onsubmit="sendMessage()">

			<input id="chatTextInput" class="search__input" name="search" placeholder="Type a message..."
				autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled />

			<button class="btn btn-primary" id="send-button" onclick="sendMessage()" disabled>
				<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">
					<path
						d="M440 6.5L24 246.4c-34.4 19.9-31.1 70.8 5.7 85.9L144 379.6V464c0 46.4 59.2 65.5 86.6 28.6l43.8-59.1 111.9 46.2c5.9 2.4 12.1 3.6 18.3 3.6 8.2 0 16.3-2.1 23.6-6.2 12.8-7.2 21.6-20 23.9-34.5l59.4-387.2c6.1-40.1-36.9-68.8-71.5-48.9zM192 464v-64.6l36.6 15.1L192 464zm212.6-28.7l-153.8-63.5L391 169.5c10.7-15.5-9.5-33.5-23.7-21.2L155.8 332.6 48 288 464 48l-59.4 387.3z" />
				</svg>
			</button>

			<button class="btn btn-primary" id="send-attachment" onclick="sendAttachment()" disabled>

				<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512">
					<path
						d="M364.2 83.8c-24.4-24.4-64-24.4-88.4 0l-184 184c-42.1 42.1-42.1 110.3 0 152.4s110.3 42.1 152.4 0l152-152c10.9-10.9 28.7-10.9 39.6 0s10.9 28.7 0 39.6l-152 152c-64 64-167.6 64-231.6 0s-64-167.6 0-231.6l184-184c46.3-46.3 121.3-46.3 167.6 0s46.3 121.3 0 167.6l-176 176c-28.6 28.6-75 28.6-103.6 0s-28.6-75 0-103.6l144-144c10.9-10.9 28.7-10.9 39.6 0s10.9 28.7 0 39.6l-144 144c-6.7 6.7-6.7 17.7 0 24.4s17.7 6.7 24.4 0l176-176c24.4-24.4 24.4-64 0-88.4z" />
				</svg>
			</button>

			<span class="search__info">Hit enter to send or ESC to close</span>
			<!-- <span id="lightButton">🔴</span> -->
			<!-- <span id="lightButton" class="traffic-light"></span> -->

		</form>


	</div><!-- /search chat-->


	<!-- MODALS -->

	
	<!-- DID Minter Mdal -->

	<div class="modal fade" id="didMinterModal" tabindex="-1" aria-labelledby="didMinterModal" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="didMinterModalLabel">DID MINTER</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">

					<h1>Let's Mint your Self Soveraing DID 💪</h1>

					<div id="didMinterUpdates"></div>

					<div class="row mb-3">
						<div class="col-12">
							<label for="mintAliasName" class="form-label">Alias Name</label>
							<input type="text" class="form-control" id="mintAliasName" placeholder="Enter alias name">
							<form class="mt-3">
								<div id="additionalFields"></div>
								<button type="button" class="btn btn-secondary btn-sm" onclick="mintDID()">MINT
								</button>
							</form>
						</div>
					</div>


				</div>
			</div>
		</div>
	</div>

	<!-- fin Modal DID SAVE -->



	<!-- Modal DID SAVE -->

	<!-- Modal DID MANAGER -->
	<div class="modal fade" id="didManagerModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="didManagerModalLabel" data-translate="userinfo" >User Information</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<!-- First row: Picture and Change Avatar button -->
					<div class="row mb-3">
						<div class="col-12 text-center">
							<img src="https://via.placeholder.com/150" id="aliasAvatar" alt="Avatar"
								class="img-thumbnail">
							<div class="mt-2">
								<button class="btn btn-secondary btn-sm" id="changeAvatar" data-translate="changeavatar">Change Avatar</button>
							</div>
						</div>
					</div>
					<!-- Second row: Text input field and additional form -->


					<div class="row mb-3">
						<div class="col-12">
							<label for="aliasName" class="form-label" data-translate="aliasname">Alias Name</label>
							<div class="input-group">
								<input type="text" class="form-control" id="aliasName"  placeholder="Enter alias name" readonly>
								<!-- <input type="text" class="form-control" id="aliasName" data-translate="enteraliasname"  placeholder="Enter alias name" readonly> -->
								<button type="button" id="editAlias" class="btn btn-secondary"  data-translate="edit">Edit</button>
							</div>
						</div>
					</div>
					<!-- <div class="row mb-3">
            <div class="col-12">
              <label for="aliasName" class="form-label">Alias Name</label>
              <input type="text" class="form-control" id="aliasName" placeholder="Enter alias name">
            
			  
            </div>
		</div> -->
					<!-- <form class="mt-3">
		  <div id="additionalFields"></div>
		  <button type="button" class="btn btn-secondary btn-sm" onclick="addDoc()">Add Public Document +</button>
		</form> -->
					<!-- Third row: Save DID button -->
					<!-- PUBLIC DOCS INSERTION -->

					<section id="uploaddocs" class="container">

						<p data-translate="addDocs" class="heading">1- ADD PUBLIC DOCUMENTS</p>


						<div id="documentos">
							<div id="historial">
								<button type="button" class="btn btn-outline-secondary"
									onclick="event.stopPropagation();addDoc('#addDocument')" id='addDocumentButton'>
									<i id='plusAddDocumentButton' class="fa-solid fa-plus" aria-hidden="true"></i>
									<i id='spinAddDocumentButton' style='display:none'
										class="fas fa-circle-notch fa-spin"></i>

									<span data-translate="adddoc">Add document</span></button>

								<div id="tbody"> </div>



							</div>
						</div>
						<br>
						<div id="addDocsButtons" class="">
							<!-- <button class="btn btn-primary btn-lg " id="createIPFSDelivery"
		onclick="event.stopPropagation();publishInDID((this.parentElement))" disabled data-translate="publicipfs">
		<i class="fa-solid fa-envelope-circle-check"></i> Preparer comme Envoi
		IPFS</button>
	  <br> -->

					</section>


					<section id="createenvoi" class="container">


						<ul id="IPFSDeliveries">

						</ul>


						<p id="vosenvois"></p>
						<div id="qrcode"></div>

						<pre id="sigresult"></pre>

						<br />



					</section>


					<!-- FIN PUBLIC DOCS INSERTION -->


					<!-- <div class="row">
            <div class="col-12 text-center">
              <button type="button" class="btn btn-primary">SAVE DID</button>
            </div>
          </div> -->


				</div>
			</div>
		</div>
	</div>

	<!-- fin Modal DID MANAGER -->


	<!-- Modal PASSWORD WALLET -->
	<div class="modal fade" data-bs-backdrop="static" id="walletPassword" tabindex="-1" role="dialog" aria-labelledby=""
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="viewmnemonic"  >VIEW MNEMONIC PHRASE</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body" id="backedWalletMnemonic">


					<!-- ====== -->


					<!-- ==== -->


				</div>
				<div class="modal-footer justify-content-center">
					<a target="_blank"
						href="https://iusnaturalis.web.app/docs/index.html#/?id=la-auto-custodia">Documentation</a>
				</div>


			</div>
		</div>
	</div>

	<!-- Modal BACKUP WALLET -->
	<div class="modal fade" data-bs-backdrop="static" id="walletBackp" tabindex="-1" role="dialog" aria-labelledby=""
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="walletCreation"  >WALLET CREATION</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

				</div>
				<div class="modal-body" id="walletHiddenContent">
					<div id="displayPubKey"></div>
					<div id="displayPK"></div>
					<!-- <div id="displayMnemonic" ></div> -->
					<div id="displayMnemonic" translate="no"></div>
					<div id="displayDecrypt"></div>
					<div id="success_message2" class="alert alert-success" role="alert" style="display: none;"></div>
				</div>
				<div class="modal-footer justify-content-center" id="walletbackpfooter">
					<!-- <a target="_blank"  href="https://iusnaturalis.web.app/docs/index.html#/?id=la-auto-custodia">Check out the wiki!</a>  -->
				</div>


			</div>
		</div>
	</div>


	<!-- Modal wallet RESTORE -->
	<div class="modal fade" data-bs-backdrop="static" id="walletRestore" tabindex="-1" role="dialog" aria-labelledby=""
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="walletrestore"  >WALLET RESTORE</h5>
				</div>
				<div class="modal-body">
					<!-- SEED -->
					<div id="seedData">
						<div class="mb-3">
							<label for="seedTextarea" class="form-label">Paste your seed, mnemonic or Private
								key</label>
							<textarea class="form-control" id="seedTextarea" rows="3"></textarea>
						</div>
						<!-- PASSWORD -->
						<div class="row g-3 align-items-center">
							<div class="col-auto">
								<label for="seedPassword" class="col-form-label">Password</label>
							</div>
							<div class="col-auto">
								<input type="password" id="seedPassword" class="form-control"
									aria-describedby="passwordHelpInline">
								<div class="valid-feedback">Valid.</div>
								<div class="invalid-feedback">Please set a password.</div>
							</div>

							<div class=" col-auto">
								<input type="checkbox" class="form-check-input" id="wrememberPassword" checked>
								<label class="form-check-label" for="rememberPassword">Remember me</label>
							</div>


						</div>
					</div>
					<div id="displayRestoreProgress"></div>
					<div id="success_message3" class="alert alert-success" role="alert" style="display: none;"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary closeWalletBkp" id="closeWalletRestore"
						data-bs-dismiss="modal" data-translate="close">Cancel</button>
					<button type="button" class="btn btn-outline-secondary closeWalletBkp" id="setWalletRestore"
						data-translate="restore" onclick="event.stopPropagation(); restoreSeed()"
						disabled>Restore</button>
				</div>
			</div>
		</div>
	</div>
	<!-- fin walelt RESTORE WALLET-->

	<!-- SCAN MODAL -->
	<div class="modal fade" data-bs-backdrop="static" id="scanModal" tabindex="-1" role="dialog" aria-labelledby=""
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="scanqr">Scan QR</h5>
				</div>

				<div class="modal-body"  >
					<div class="">
						<div class="responsive-svg" id="qrcanvas"></div>
						<video id="qrScanVideo" width="300" height="300"></video>
						<div id="scanResult"></div>

					</div>

					<div class="modal-footer">
						<button type="button" class="btn btn-outline-secondary closeWalletBkp" id="closeScanModal"
							data-translate="close">Close</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- fin SCAN MODAL-->



	<!-- SETTINGS MODAL -->
	<div class="modal fade" id="settingsModal" data-bs-backdrop="static" tabindex="-1"
		aria-labelledby="settingsModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="settingsModalLabel" data-translate="settings" >SETTINGS </h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>


				<div class="modal-body" id="settingsCardContainer">



					<h4 data-translate="keysmanagement" class="capital">Keys management</h4>

					<button type="button"   class="btn btn-primary" onclick="event.stopPropagation(); backup()">
						<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">
							<path fill="currentColor"
								d="M512 32c0 113.6-84.6 207.5-194.2 222c-7.1-53.4-30.6-101.6-65.3-139.3C290.8 46.3 364 0 448 0h32c17.7 0 32 14.3 32 32zM0 96C0 78.3 14.3 64 32 64H64c123.7 0 224 100.3 224 224v32V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V320C100.3 320 0 219.7 0 96z" />
						</svg> <span data-translate="backup">Backup</span> </button>

					<button type="button"   class="btn btn-primary"
						onclick="event.stopPropagation(); restoreWallet()"> <svg xmlns="http://www.w3.org/2000/svg"
							height="16" width="16" viewBox="0 0 512 512">
							<path fill="currentColor"
								d="M174.7 45.1C192.2 17 223 0 256 0s63.8 17 81.3 45.1l38.6 61.7 27-15.6c8.4-4.9 18.9-4.2 26.6 1.7s11.1 15.9 8.6 25.3l-23.4 87.4c-3.4 12.8-16.6 20.4-29.4 17l-87.4-23.4c-9.4-2.5-16.3-10.4-17.6-20s3.4-19.1 11.8-23.9l28.4-16.4L283 79c-5.8-9.3-16-15-27-15s-21.2 5.7-27 15l-17.5 28c-9.2 14.8-28.6 19.5-43.6 10.5c-15.3-9.2-20.2-29.2-10.7-44.4l17.5-28zM429.5 251.9c15-9 34.4-4.3 43.6 10.5l24.4 39.1c9.4 15.1 14.4 32.4 14.6 50.2c.3 53.1-42.7 96.4-95.8 96.4L320 448v32c0 9.7-5.8 18.5-14.8 22.2s-19.3 1.7-26.2-5.2l-64-64c-9.4-9.4-9.4-24.6 0-33.9l64-64c6.9-6.9 17.2-8.9 26.2-5.2s14.8 12.5 14.8 22.2v32l96.2 0c17.6 0 31.9-14.4 31.8-32c0-5.9-1.7-11.7-4.8-16.7l-24.4-39.1c-9.5-15.2-4.7-35.2 10.7-44.4zm-364.6-31L36 204.2c-8.4-4.9-13.1-14.3-11.8-23.9s8.2-17.5 17.6-20l87.4-23.4c12.8-3.4 26 4.2 29.4 17L182 241.2c2.5 9.4-.9 19.3-8.6 25.3s-18.2 6.6-26.6 1.7l-26.5-15.3L68.8 335.3c-3.1 5-4.8 10.8-4.8 16.7c-.1 17.6 14.2 32 31.8 32l32.2 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-32.2 0C42.7 448-.3 404.8 0 351.6c.1-17.8 5.1-35.1 14.6-50.2l50.3-80.5z" />
						</svg> <span data-translate="restore">Restore</span>  </button>

					<br>
					<br>
					<hr>

					<!-- -------------------------- -->
					<h4 data-translate="token" class="capital">TOKEN</h4>

					<!-- Radio Buttons -->

					<!-- <div class="form-check">
						<input class="form-check-input" type="radio" name="tokenType" id="inactiveOption"
							value="inactive">
						<label class="form-check-label" for="inactiveOption">Inactive</label>
					</div> -->

					<div class="form-check">
						<input class="form-check-input" type="radio" name="tokenType" id="erc20Option" value="evm" checked>
						<label class="form-check-label" for="erc20Option">EVM( eth, erc20, etc)</label>
					</div>

					<!-- ERC-20 Options -->
					<!-- <div id="erc20Options" class="mt-3" style="display: none;"> -->
					<div id="erc20Options" class="mt-3" >
						<!-- <select class="form-select mb-3 token-selector" id="erc20Selector"> </select> -->
						<select class="form-select mb-3 token-selector"  id="erc20Selector" disabled>
							<option class="loading-option" data-translate="loadingtokens">Loading tokens</option>
						  </select>

						  
						<button type="button" class="btn btn-primary mt-2"   onclick="addToken()">+ Add</button>
						<button type="button" class="btn btn-danger mt-2" id="removeErc20Address">Remove</button>
						<button type="button" class="btn btn-info mt-2" id="infoErc20Address">Info</button>
					</div>


					<br>

					<div class="form-check">
                        <input class="form-check-input" type="radio" name="tokenType" id="g1Option" value="g1"
                            disabled>
                        <label class="form-check-label" for="g1Option">G1</label>
                    </div>



					<div class="form-check">
                        <input class="form-check-input" type="radio" name="tokenType" id="moneroOption" value="monero"
                            disabled>
                        <label class="form-check-label" for="moneroOption">MONERO</label>
                    </div>

					<div class="form-check">
                        <input class="form-check-input" type="radio" name="tokenType" id="btcOption" value="btc"
                            disabled>
                        <label class="form-check-label" for="btcOption">BTC</label>
                    </div>


					<br>
					<br>
					<hr>

					<!-- ----------------------------- -->



					<h4 data-translate="wallet" class="capital">WALLET</h4>
			 

					<div class="form-check">
						<input class="form-check-input" type="checkbox" id="autoPaygas2meCheckbox"
							name="autopayGas">
						<label class="form-check-label" for="autoPaygas2meCheckbox"> ⛽ Autopay gas requests (if you are the recipient)</label>
					</div>



					<div class="form-check">
						<input class="form-check-input" type="checkbox" id="stealthaddrAlwaysOnCheckbox"
							name="stealthAddress">
						<label class="form-check-label" for="stealthaddrAlwaysOnCheckbox"> 🦹‍♂️↔️🦹‍♀️ Stealth addresses always on</label>
					</div>
					<br>
					<br>
					<hr>



					<h4 class="capital" data-translate="notifications">NOTIFICATIONS</h4>

					<div class="container mt-5">
						<!-- <h2>Notification Settings</h2> -->

						<!-- Toggle Input -->
						<div class="form-check form-switch mt-3">
							<input class="form-check-input" type="checkbox" id="notificationToggle">
							<label class="form-check-label" for="notificationToggle" data-translate="enablenotifications">Enable Notifications</label>
						</div>

						<!-- Notification Message -->
						<div id="notificationMessage" class="alert alert-success" data-translate="enabled">
							Notifications are now enabled.
						</div>

					</div>

					<br>
					<br>
					<hr>

					<!-- ----------------------------- -->
					<h4 class="capital"  data-translate="language">Language</h4>

					<div class="options">

						<select class="right translation" id="langswitch">
							<option value="en">en</option>
							<option value="fr">fr</option>
							<option value="es">es</option>
						</select>
					</div>
					<div style="display: block;">
						<hr>


						<h4 class="capital" data-translate="contacts">Contacts</h4>
						<button class="btn btn-primary" onclick="event.stopPropagation();saveContacts()"><svg
								xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">
								<path fill="currentColor"
									d="M64 32C28.7 32 0 60.7 0 96L0 416c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-242.7c0-17-6.7-33.3-18.7-45.3L352 50.7C340 38.7 323.7 32 306.7 32L64 32zm0 96c0-17.7 14.3-32 32-32l192 0c17.7 0 32 14.3 32 32l0 64c0 17.7-14.3 32-32 32L96 224c-17.7 0-32-14.3-32-32l0-64zM224 288a64 64 0 1 1 0 128 64 64 0 1 1 0-128z" />
							</svg> <span data-translate="save">Save</span>  </button>


						<button class="btn btn-primary" onclick="event.stopPropagation();importContacts()">
							<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">
								<path fill="currentColor"
									d="M128 64c0-35.3 28.7-64 64-64L352 0l0 128c0 17.7 14.3 32 32 32l128 0 0 288c0 35.3-28.7 64-64 64l-256 0c-35.3 0-64-28.7-64-64l0-112 174.1 0-39 39c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l80-80c9.4-9.4 9.4-24.6 0-33.9l-80-80c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l39 39L128 288l0-224zm0 224l0 48L24 336c-13.3 0-24-10.7-24-24s10.7-24 24-24l104 0zM512 128l-128 0L384 0 512 128z" />
							</svg>
							<span data-translate="import">Import</span> </button>
						<input type="file" id="fileInput" accept=".json" style="display: none;">


						<br>
						<!-- <div class="options"  >
								<input type="checkbox" id="saveToDID" name="save2did">
								<label for="save2did">Save to DID</label>
							</div> -->
					</div>

					<div style="display: none;">
						<hr>


						<h4>Signatures to broadcast</h4>

						<ul class="options" id="sig2Broadcast">
							<li>lkasdmfklnsfdlkgnsdfpgioenpwnglkfdsxnclkdsnklfdnsalkfnldksanflksndfl</li>
							<li>nrew,nernpnvopxcoivopcxiovidopixcopvioxcpvocxipvoickxpvoicxopviocpx</li>


							<button class="btn btn-primary">publish</button>
							<span>
								<input type="checkbox" id="muteCheckbox" name="muteCheckbox">
								<label for="muteCheckbox">AutoPublish(when its connected to the internet)</label>
							</span>

						</ul>
					</div>

					<hr>


					<h4 class="capital"  data-translate="chats">Chats</h4>

					<button type="button"   class="btn btn-primary"
						onclick="event.stopPropagation(); createGroupChat()" disabled>

						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" height="16" width="16">
							<path fill="currentColor"
								d="M72 88a56 56 0 1 1 112 0A56 56 0 1 1 72 88zM64 245.7C54 256.9 48 271.8 48 288s6 31.1 16 42.3V245.7zm144.4-49.3C178.7 222.7 160 261.2 160 304c0 34.3 12 65.8 32 90.5V416c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V389.2C26.2 371.2 0 332.7 0 288c0-61.9 50.1-112 112-112h32c24 0 46.2 7.5 64.4 20.3zM448 416V394.5c20-24.7 32-56.2 32-90.5c0-42.8-18.7-81.3-48.4-107.7C449.8 183.5 472 176 496 176h32c61.9 0 112 50.1 112 112c0 44.7-26.2 83.2-64 101.2V416c0 17.7-14.3 32-32 32H480c-17.7 0-32-14.3-32-32zm8-328a56 56 0 1 1 112 0A56 56 0 1 1 456 88zM576 245.7v84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM320 32a64 64 0 1 1 0 128 64 64 0 1 1 0-128zM240 304c0 16.2 6 31 16 42.3V261.7c-10 11.3-16 26.1-16 42.3zm144-42.3v84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM448 304c0 44.7-26.2 83.2-64 101.2V448c0 17.7-14.3 32-32 32H288c-17.7 0-32-14.3-32-32V405.2c-37.8-18-64-56.5-64-101.2c0-61.9 50.1-112 112-112h32c61.9 0 112 50.1 112 112z" />
						</svg>
						<span data-translate="createmultisigchat">CREATE MULTISIG GRUPAL CHAT</span> 
						</button>
					<!-- scan this qr to be added to this group -->


					<button type="button"   class="btn btn-primary"
						onclick="event.stopPropagation(); createGroupChat()" disabled>

						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" height="16" width="16">
							<path fill="currentColor"
								d="M72 88a56 56 0 1 1 112 0A56 56 0 1 1 72 88zM64 245.7C54 256.9 48 271.8 48 288s6 31.1 16 42.3V245.7zm144.4-49.3C178.7 222.7 160 261.2 160 304c0 34.3 12 65.8 32 90.5V416c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V389.2C26.2 371.2 0 332.7 0 288c0-61.9 50.1-112 112-112h32c24 0 46.2 7.5 64.4 20.3zM448 416V394.5c20-24.7 32-56.2 32-90.5c0-42.8-18.7-81.3-48.4-107.7C449.8 183.5 472 176 496 176h32c61.9 0 112 50.1 112 112c0 44.7-26.2 83.2-64 101.2V416c0 17.7-14.3 32-32 32H480c-17.7 0-32-14.3-32-32zm8-328a56 56 0 1 1 112 0A56 56 0 1 1 456 88zM576 245.7v84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM320 32a64 64 0 1 1 0 128 64 64 0 1 1 0-128zM240 304c0 16.2 6 31 16 42.3V261.7c-10 11.3-16 26.1-16 42.3zm144-42.3v84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM448 304c0 44.7-26.2 83.2-64 101.2V448c0 17.7-14.3 32-32 32H288c-17.7 0-32-14.3-32-32V405.2c-37.8-18-64-56.5-64-101.2c0-61.9 50.1-112 112-112h32c61.9 0 112 50.1 112 112z" />
						</svg>
						<span data-translate="joingroupethroughqr">JOIN GROUPE TRHOUGH QR</span> 

						</button>

				</div>



				<div class="modal-footer d-flex justify-content-center">
					<button type="button" class="btn btn-primary btn-lg" onclick="lock()"><svg
							xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="18" height="16">
							<path fill="currentColor"
								d="M144 144l0 48 160 0 0-48c0-44.2-35.8-80-80-80s-80 35.8-80 80zM80 192l0-48C80 64.5 144.5 0 224 0s144 64.5 144 144l0 48 16 0c35.3 0 64 28.7 64 64l0 192c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64L0 256c0-35.3 28.7-64 64-64l16 0z" />
						</svg>
						<span data-translate="lock">LOCK</span> 
						
					</button>
				</div>

			</div>
		</div>
	</div>
	<!-- SETTINGS SETTINGS -->


	<!-- walletReceive -->
	<!-- Modal WALLET RECEIVE/-->
	<div class="modal fade" id="walletReceive" tabindex="-1" aria-labelledby="walletReceiveLabel" aria-hidden="true"
		data-bs-backdrop="static">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				
				<div class="modal-header">
					<h5 class="modal-title" id="walletReceiveLabel">ReceiveTransaction</h5>
					<button type="button" id="walletReceiveXClose" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>


				<div class="modal-body">




					<!-- ------------------------------------ -->

					<form id="transactionFormWalletReceive">
						<div class="input-group mb-3">
							<span class="input-group-text iusbutton">Token</span>
							<!-- <select class="form-select token-selector"  > </select> -->

							<select class="token-selector" disabled>
								<option class="loading-option" data-translate="loadingtokens">Loading tokens</option>
							  </select>

							<span  style="display: none;"> </span>
						</div>

						<!-- <div class="mb-3 fullwith">
							<span class="input-group-text iusbutton" for="yourReceiptAddress">Recipient
								Address</span>
							<input type="text" class="form-control" id="yourReceiptAddress" placeholder="0x..."
								required readonly>
						</div> -->

						<div id="stealthSection" class=" mb-3 list-group-item list-group-item-warning">
							<input class="form-check-input" type="checkbox"  name="stealthAddress">
							<label for="sarecipientAddress" class="form-label">🦹‍♂️ Stealth Address 🦹‍♀️ </label>
								<div >

									<div  class="wwrap"></div>
								</div>
							<div   class=""></div>
						</div>


						<div class="input-group mb-3"  >
							<input type="number" class="form-control amountsendgroup amount"  placeholder="0.00" step="0.01"
								min="0" required="">
							<!-- <span class="input-group-text iusbutton">Amount to receive</span> -->
							<span class="input-group-text iusbutton" style="display: block; text-align: center;">
								<span>Amount to receive</span>
								<span class="tokenConversor" id="tokenConversorSend"></span>
							  </span>
							<div class="invalid-feedback">
								Please enter a valid amount.
							</div>
						</div>

						<div   class="mb-3 d-none">
							<label for="erc20ContractAddress" class="form-label">ERC-20 Contract Address</label>
							<input type="text" class="form-control"  
								placeholder="0x...">
						</div>
						<button type="button" class="btn btn-primary fullwidth"  >
							<svg xmlns="http://www.w3.org/2000/svg" height="16" width="20"
								viewBox="0 0 512 512">
								<path fill="currentColor"
									d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480V396.4c0-4 1.5-7.8 4.2-10.7L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z">
								</path>
							</svg>Send payment Request</button>
					</form>



				</div>
			</div>
		</div>
	</div>


	<!-- fin RECEIVE WALLET-->



	<!-- Modal WALLET SEND/-->
	<div class="modal fade" id="walletSend" tabindex="-1" aria-labelledby="walletSendLabel" aria-hidden="true"
		data-bs-backdrop="static">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<section id="bigBalanceWalletsendmodal" > </section>
					<button type="button" id="walletSendXClose" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>


				<div class="modal-body">
					<ul class="nav nav-tabs" id="myTab" role="tablist" style="display: none;">
						<li class="nav-item" role="presentation">
							<button class="nav-link active" id="preparetx-tab" data-bs-toggle="tab"
								data-bs-target="#preparetx" type="button" role="tab" aria-controls="form"
								aria-selected="true">Form</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="confirmation-tab" data-bs-toggle="tab"
								data-bs-target="#confirmation" type="button" role="tab" aria-controls="confirmation"
								aria-selected="false">Confirmation</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="result-tab" data-bs-toggle="tab" data-bs-target="#result"
								type="button" role="tab" aria-controls="result" aria-selected="false">Result</button>
						</li>
					</ul>



					<div class="tab-content" id="walletSendContent">
						<div class="tab-pane fade show active" id="preparetx" role="tabpanel"
							aria-labelledby="preparetx-tab">
							<form id="transactionFormWalletSend">
								<div class="input-group mb-3">
									<span class="input-group-text iusbutton">Token</span>
									<select class="form-select token-selector"  id="tokenType" disabled>
										<option class="loading-option" data-translate="loadingtokens">Loading tokens</option>
									  </select>

									<span id="fixedtokenType" style="display: none;"> </span>
								</div>

								<div class="mb-3 fullwith">
									<span class="input-group-text iusbutton" for="recipientAddress">Recipient
										Address</span>
									<input type="text" class="form-control" id="recipientAddress" placeholder="0x..."
										required readonly>
								</div>

								<div id="stealthSection" class=" mb-3 list-group-item list-group-item-warning">
									<input class="form-check-input" type="checkbox" id="stealthAddressCheckbox" name="stealthAddress">
									<label for="sarecipientAddress" class="form-label">🦹‍♂️ Stealth Address 🦹‍♀️ </label>
										<div id="stealthInfo">

											<div id="sarecipientAddress" class="wwrap"></div>
										</div>
									<div id="staddrInfo" class=""></div>
								</div>


								<div class="input-group mb-3 amountsendgroup" id="amountsendgroup">
									<input type="number" class="form-control amount" id="amount" placeholder="0.00" step="0.01"
										min="0" required="">
									<!-- <span class="input-group-text iusbutton">Amount to send</span> -->
									<span class="input-group-text iusbutton" style="display: block; text-align: center;">
										<span>Amount to send</span>
										<span class="tokenConversor" id="tokenConversorSend"></span>
									  </span>
									<div class="invalid-feedback">
										Please enter a valid amount.
									</div>
								</div>

								<div id="erc20Details" class="mb-3 d-none">
									<label for="erc20ContractAddress" class="form-label">ERC-20 Contract Address</label>
									<input type="text" class="form-control" id="erc20ContractAddress"
										placeholder="0x...">
								</div>
								<button type="button" class="btn btn-primary fullwidth" id="sendTransactionBtn">
									<svg xmlns="http://www.w3.org/2000/svg" height="16" width="20"
										viewBox="0 0 512 512">
										<path fill="currentColor"
											d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480V396.4c0-4 1.5-7.8 4.2-10.7L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z">
										</path>
									</svg>Send</button>
							</form>
						</div>

						<div class="tab-pane fade" id="confirmation" role="tabpanel" aria-labelledby="confirmation-tab">
							<h5>Confirm Transaction</h5>
							<p id="transactionDetails"></p>
							<button type="button" class="btn btn-secondary" id="cancelTransactionBtn">Cancel</button>
							<button type="button" class="btn btn-primary" id="confirmTransactionBtn">Confirm</button>
						</div>

						<div class="tab-pane fade" id="result" role="tabpanel" aria-labelledby="result-tab">
							<h5>Transaction Result</h5>
							<p id="resultMessage"></p>
							<button type="button" class="btn btn-primary" data-bs-dismiss="modal"
								id="walletSendClose">Close</button>
						</div>
					</div>



				</div>
			</div>
		</div>
	</div>


	<!-- fin SEND WALLET-->



	<!-- ---------------------------------------------- -->
	<!--  Modal addNewToken -->
	<!-- ---------------------------------------------- -->
	<div class="modal fade" id="addNewTokenModal" tabindex="-1" aria-labelledby="addNewTokenModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="addNewTokenModalLabel">Add Token</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">


					<div class="mb-3">
						<label for="autoComplete" class="form-label">Select EVM chain</label>
						<div class="input-group">
							<span class="input-group-text">
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#d17c78"
									class="bi bi-search" viewBox="0 0 16 16">
									<path
										d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.415l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
								</svg>
							</span>
							<input type="search" class="form-control" id="autoComplete" placeholder="Enter search term"
								tabindex="1">
						</div>
					</div>



					<div class="selection"></div>

					<div class="alert alert-warning alert-dismissible fade show" id="selectionResult"
						style="display: none;"> </div>

					<!-- ERC-20 Options -->
					<div id="erc20SetContract" class="mt-3" style="display: none;">

						<!-- Contract Address Selector -->
						<div class="mb-3">
							<label for="contractAddress" class="form-label">ERC-20 Smart Contract Address</label>
							<input type="text" class="form-control" id="contractAddress" placeholder="0x..." required
								pattern="^0x[a-fA-F0-9]{40}$">
							<div class="invalid-feedback">
								Please provide a valid Ethereum smart contract address (0x followed by 40 hex
								characters).
							</div>
							<div class="valid-feedback">
								Looks good!
								<span id="validLink"></span>
							</div>
						</div>

						<button type="button" class="btn btn-primary" id="addERC20contract" onclick="addConctract()"
							style="display: none;">Add ERC-20</button>
					</div>


					<button type="button" class="btn btn-primary" id="addNativeToken" onclick="addConctract()"
						style="display: none;">Add Native Token</button>



				</div>


				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>




	<!-- ---------------------------------------------- -->
	<!--  Modal defaultToken -->
	<!-- ---------------------------------------------- -->
	<div class="modal fade" id="defaultTokenModal" tabindex="-1" aria-labelledby="defaultTokenModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="defaultTokenModalLabel">Default Token</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">





				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
	</div>






	<!-- Modal addDocument -->
	<div class="modal fade" data-bs-backdrop="static" id="addDocument" tabindex="-1" role="dialog"
		aria-labelledby="uplodad2ipfs" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="title" id="uplodad2ipfs">Upload to IPFS</h5>
				</div>
				<div class="modal-body">

					<div id="headModal"></div>
					<div class="input-group">
						<label class="input-group-btn">
							<span class="btn btn-primary">
								Browse
								<input type="file" style="display: none;" name="Upload" class="form-control"
									accept="application/pdf" id="input_image">
							</span>
						</label>

						<input type="text" id="fileToUpload" class="form-control " readonly>
					</div>
					<input type="text" class="form-control taskInput " id="taskInput" placeholder="Title"
						aria-describedby="inputGroupPrepend3" required autocomplete="off">

					<div id="success_message" class="alert alert-success" role="alert" style="display: none;"></div>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary  " data-bs-dismiss="modal"
						data-translate="close">Close</button>
					<button type="button" class="btn btn-outline-primary  " id="submit_button"
						data-translate="upload">Upload</button>
					<button style='display: none;' type="button" class="btn btn-primary" data-translate="addanother"
						id="addAnother_button">Add another</button>

				</div>
			</div>
		</div>
	</div>
	<!-- fin MODAL -->



	<!-- WALLET BALANCES MODAL  -->
	<div class="modal fade" id="walletModal" data-bs-backdrop="static" tabindex="-1"
		aria-labelledby="settingsModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
			<!-- <h1>WALLET</h1> -->
			<h5 class="modal-title"  >WALLET BALANCES </h5>


					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>


				<div class="modal-body" id="walletCardContainer">
					
					<section id="bigBalanceWalletmodal" class="tokenBalance">
						<span class="top"> Arbitrum Sepolia(461614):</span>
						<span class="bal">-999.9999</span>
						<span class="eth">ETH</span>
						<span class="bottom">
							<a class="miniversion" target="_blank" rel="noopener noreferrer" href="">gas: 0.0002</a>
						</span>

					</section>
					<h4>TOKEN</h4>

					<select class="form-select mb-3 token-selector"  id="" disabled>
						<option class="loading-option" data-translate="loadingtokens">Loading tokens</option>
					  </select>


					<br>
					<br>
					<hr>
					<!-- -------------------------- -->
					<h4>PUBLIC TXs</h4>

					<div class="container mt-4">
						<div   id="loadingSpinner" class="loader-banner">
							<div class="spinner"></div>
							<p>Loading...</p>
						  </div>
						<div class="row" id="transaction-history">
					<p>Public transactions will display here...</p>

							<!-- Each transaction will be added here as a card -->

						</div>
					</div>
 

					  <button id="clearCacheBtn" class="btn btn-warning">Clear Cache</button>


					<hr>

					<!-- ----------------------------- -->

					<!-- -------------------------- -->
					<h4>PRIVATE</h4>
						<p>Private stealth transactions will display here...</p>
					<!-- <ul> -->

					<!-- <h4 class="tertiary">Total</h4> -->
					<!-- <p class="amount">1.493 <span class="secondary" id="currency-name">ETH</span> 👤 from Claude
						<button type="button"   class="sendto" onclick="event.stopPropagation(); send()" disabled> SEND TO </button>
						<button type="button"   class="claim" onclick="event.stopPropagation(); claim()" disabled> CLAIM </button>
					</p>
					<p class="coin-value">982.40 <span class="secondary currency-name">USD</span> 👤 from Dan
						<button type="button"   class="sendto" onclick="event.stopPropagation(); send()" disabled> SEND TO </button>
						<button type="button"   class="claim" onclick="event.stopPropagation(); claim()" disabled> CLAIM </button>
					</p>
					<p class="coin-value">0.1038 <span class="secondary  currency-name">BTC
							<button type="button"   class="sendto" onclick="event.stopPropagation(); send()" disabled> SEND TO </button>
							<button type="button"   class="claim" onclick="event.stopPropagation(); claim()" disabled> CLAIM </button>
						</span>
					</p> -->

					<br>
					<br>
					<hr>
					<!-- ----------------------------- -->

				</div>

				<div class="modal-footer d-flex justify-content-center">
					<button type="button" class="btn btn-primary btn-lg" onclick="lock()"><svg
							xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="18" height="16">
							<path fill="currentColor"
								d="M144 144l0 48 160 0 0-48c0-44.2-35.8-80-80-80s-80 35.8-80 80zM80 192l0-48C80 64.5 144.5 0 224 0s144 64.5 144 144l0 48 16 0c35.3 0 64 28.7 64 64l0 192c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64L0 256c0-35.3 28.7-64 64-64l16 0z" />
						</svg>LOCK</button>
				</div>

			</div>
		</div>
	</div>
	<!-- fin WALLET BALANCES MODAL  -->



	<!-- PAY/SIGN WITH QR MODAL  -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
		  <div class="modal-content">
			<div class="modal-header">
			  <h5 class="modal-title" id="paymentModalLabel">Scan QR Code to Pay/Sign</h5>
			  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body text-center">
			  <div id="qrCodeContainer"></div>
			  <p id="countdown" class="mt-3 fs-5">Expires in: 15:00</p>
			</div>
			<div class="modal-footer">
			  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
			</div>
		  </div>
		</div>
	  </div>
	<!-- fin PAY/SIGN WITH QR MODAL  -->
	 

	<!--  PAY/SIGN WITH QR MODAL v2  -->
	<!-- Modal -->
<div class="modal fade" id="scansignModal" tabindex="-1" aria-labelledby="scansignModalLabel" aria-hidden="true">
	<div class="modal-dialog">
	  <div class="modal-content">
		<div class="modal-header">
		  <h5 class="modal-title" id="exampleModalLabel">Sign <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" height="30px">
				<!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
				<path fill="currentColor" d="M192 128c0-17.7 14.3-32 32-32s32 14.3 32 32l0 7.8c0 27.7-2.4 55.3-7.1 82.5l-84.4 25.3c-40.6 12.2-68.4 49.6-68.4 92l0 71.9c0 40 32.5 72.5 72.5 72.5c26 0 50-13.9 62.9-36.5l13.9-24.3c26.8-47 46.5-97.7 58.4-150.5l94.4-28.3-12.5 37.5c-3.3 9.8-1.6 20.5 4.4 28.8s15.7 13.3 26 13.3l128 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-83.6 0 18-53.9c3.8-11.3 .9-23.8-7.4-32.4s-20.7-11.8-32.2-8.4L316.4 198.1c2.4-20.7 3.6-41.4 3.6-62.3l0-7.8c0-53-43-96-96-96s-96 43-96 96l0 32c0 17.7 14.3 32 32 32s32-14.3 32-32l0-32zm-9.2 177l49-14.7c-10.4 33.8-24.5 66.4-42.1 97.2l-13.9 24.3c-1.5 2.6-4.3 4.3-7.4 4.3c-4.7 0-8.5-3.8-8.5-8.5l0-71.9c0-14.1 9.3-26.6 22.8-30.7zM24 368c-13.3 0-24 10.7-24 24s10.7 24 24 24l40.3 0c-.2-2.8-.3-5.6-.3-8.5L64 368l-40 0zm592 48c13.3 0 24-10.7 24-24s-10.7-24-24-24l-310.1 0c-6.7 16.3-14.2 32.3-22.3 48L616 416z"/></svg>

		  </h5>
		  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>
		<div class="modal-body">
		  <!-- Buttons -->
		  <div class="d-grid gap-2">
			<button type="button" class="btn btn-secondary">Escanear código QR</button>
			<button type="button" class="btn btn-secondary" id="pasteAndSignBtn">Paste and Sign</button>
		  </div>
  
		  <!-- Input Field (Initially Hidden) -->
		  <div id="pasteField" style="display: none; margin-top: 15px;">
			<!-- <label for="pastedCommand" class="form-label">Pasted Command:</label>
			<input type="text" class="form-control" id="pastedCommand" placeholder="Paste your command here"> -->

			<div id="pastedTxToSign"></div>

		  </div>
		</div>
		<div class="modal-footer">
		  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
		</div>
	  </div>
	</div>
  </div>

	<!-- fin PAY/SIGN WITH QR MODAL  v2-->


	<!-- /*********************************************************************************************
  .) FIN MODALS
  **********************************************************************************************/ -->


	<!-- <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/autoComplete.min.js"></script> -->
	<script src="js/autoComplete.min.js"></script><!-- v10.2.7 -->
	<script src="js/Tone.min.js"></script> 
	<!-- v14.8.29 -->
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.29/Tone.min.js"></script> -->
	<script src="js/ethers-6.13.2.umd.min.js"></script>

	<script type="module" src="js/demo1.js"></script>
	<script src="js/dictionary.js"></script>
	<script type="module">
		// XMTP
		import { Client } from '@xmtp/xmtp-js'
		window.Client = Client;

		import QrScanner from "qr-scanner/qr-scanner.min.js";
		window.QrScanner = QrScanner; //make global
		QrScanner.hasCamera(); // test

		import { Polybase } from "@polybase/client";
		window.Polybase = Polybase; //make global

		import Cropper from 'cropperjs'
		window.Cropper = Cropper; //make global
		import { throttle } from '@github/mini-throttle'
		window.throttle = throttle; //make global

		import EthCrypto from 'eth-crypto';
		window.EthCrypto = EthCrypto;

		import lighthouse from '@lighthouse-web3/sdk'
		window.lighthouse = lighthouse

		import { getPublicKey, utils } from '@noble/secp256k1';
		import * as secp from '@noble/secp256k1';
		window.getPublicKey = getPublicKey;
		window.utils = utils;
		window.secp = secp;

	</script>

	<script>


		/*********************************************************************************************
		.) VARIABLES
		// https://sepolia.etherscan.io/address/0xc4bF5CbDaBE595361438F8c6a187bDc330539c60#code

		**********************************************************************************************/
		const apiKeyLighthouse = '0e06cd16.4d3bf2536b7c4219bfb7520bd7b7346e';//lighthouse
		const INFURA_API_KEY = "9219faae2bac4d24b95c2d967b22005a"; // Replace with your actual Infura API key

		window.globalOptionsList = [
			{
                'ALCHEMY_API_KEY': 'X048z0PxuDPd5vbTiKLbWJgogG9Tvd2I',
                'INFURA_API_KEY' : '9219faae2bac4d24b95c2d967b22005a',
				'IPFS_GATEWAY': 'https://gateway.lighthouse.storage/ipfs/',
				"POLYBASE_DB": "https://explorer.testnet.polybase.xyz/studio/pk%2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3%2FSTARKID/collections/STARKID",
				"ZK_PUBKEY": "2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3"
			},
        ]
		window.optionsList = [
			{
				"ERC20_TOKEN_ADDRESS": "0x3723A0d04ABDFA902d47426973E0cb49C2fC3B86",//trok arb sepolia
				"ERC20_TOKEN_ABI": 'troktoken',
				"REGISTRY_CONTRACT_ADDRESS": "0xEeF51be62Cc32e2f7c0Bf490a7ED355A2e7a0a3A",
				"TOKEN_CHAIN_NAME": 'ARBITRUM(SEPOLIA)',
				"TOKEN_NAME": "TROK",
				"SYMBOL": "TROK",
				"API": 'https://arbitrum-sepolia.blockpi.network/v1/rpc/public',
				"TOKEN_CHAINID": '421614',
				"EXPLORER": 'https://sepolia.arbiscan.io/',
				'IPFS_GATEWAY': 'https://gateway.lighthouse.storage/ipfs/',
				"POLYBASE_DB": "https://explorer.testnet.polybase.xyz/studio/pk%2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3%2FSTARKID/collections/STARKID",
				"ZK_PUBKEY": "2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3"
			},
			{
				"ERC20_TOKEN_ADDRESS": "0x6DE727032A1B2B93B430873b52eebf20FD44180E",//trok arb sepolia
				"REGISTRY_CONTRACT_ADDRESS": "0xEeF51be62Cc32e2f7c0Bf490a7ED355A2e7a0a3A",
				"TOKEN_CHAIN_NAME": 'ARBITRUM(SEPOLIA)',
				"TOKEN_NAME": "TROK",
				"SYMBOL": "TROK",
				"API": 'https://arbitrum-sepolia.blockpi.network/v1/rpc/public',
				"TOKEN_CHAINID": '421614',
				"EXPLORER": 'https://sepolia.arbiscan.io/',
				"ERC20_TOKEN_ABI": 'troktoken',
				"POLYBASE_DB": "https://explorer.testnet.polybase.xyz/studio/pk%2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3%2FSTARKID/collections/STARKID",
				"ZK_PUBKEY": "2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3"
			},
			{
				"ERC20_TOKEN_ADDRESS": "0x4874d782022507E9a4F82C6D6Df32e332A8D30fB",//trok arb sepolia
				"REGISTRY_CONTRACT_ADDRESS": "0xEeF51be62Cc32e2f7c0Bf490a7ED355A2e7a0a3A",
				"TOKEN_CHAIN_NAME": 'ARBITRUM(SEPOLIA)',
				"TOKEN_NAME": "TROK",
				"SYMBOL": "TROK",
				"API": 'https://arbitrum-sepolia.blockpi.network/v1/rpc/public',
				"TOKEN_CHAINID": '421614',
				"EXPLORER": 'https://sepolia.arbiscan.io/',
				"ERC20_TOKEN_ABI": 'troktoken',
				"POLYBASE_DB": "https://explorer.testnet.polybase.xyz/studio/pk%2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3%2FSTARKID/collections/STARKID",
				"ZK_PUBKEY": "2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3"
			},

		]


		ABIs = {
			troktoken: [{ "inputs": [], "stateMutability": "nonpayable", "type": "constructor" }, { "inputs": [], "name": "AccessControlBadConfirmation", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }, { "internalType": "bytes32", "name": "neededRole", "type": "bytes32" }], "name": "AccessControlUnauthorizedAccount", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "approve", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "ECDSAInvalidSignature", "type": "error" }, { "inputs": [{ "internalType": "uint256", "name": "length", "type": "uint256" }], "name": "ECDSAInvalidSignatureLength", "type": "error" }, { "inputs": [{ "internalType": "bytes32", "name": "s", "type": "bytes32" }], "name": "ECDSAInvalidSignatureS", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "allowance", "type": "uint256" }, { "internalType": "uint256", "name": "needed", "type": "uint256" }], "name": "ERC20InsufficientAllowance", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "sender", "type": "address" }, { "internalType": "uint256", "name": "balance", "type": "uint256" }, { "internalType": "uint256", "name": "needed", "type": "uint256" }], "name": "ERC20InsufficientBalance", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "approver", "type": "address" }], "name": "ERC20InvalidApprover", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "receiver", "type": "address" }], "name": "ERC20InvalidReceiver", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "sender", "type": "address" }], "name": "ERC20InvalidSender", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }], "name": "ERC20InvalidSpender", "type": "error" }, { "inputs": [{ "internalType": "uint256", "name": "deadline", "type": "uint256" }], "name": "ERC2612ExpiredSignature", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "signer", "type": "address" }, { "internalType": "address", "name": "owner", "type": "address" }], "name": "ERC2612InvalidSigner", "type": "error" }, { "inputs": [{ "internalType": "bytes32", "name": "role", "type": "bytes32" }, { "internalType": "address", "name": "account", "type": "address" }], "name": "grantRole", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }, { "internalType": "uint256", "name": "currentNonce", "type": "uint256" }], "name": "InvalidAccountNonce", "type": "error" }, { "inputs": [], "name": "InvalidShortString", "type": "error" }, { "inputs": [{ "internalType": "string", "name": "str", "type": "string" }], "name": "StringTooLong", "type": "error" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "owner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "spender", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Approval", "type": "event" }, { "anonymous": false, "inputs": [], "name": "EIP712DomainChanged", "type": "event" }, { "inputs": [{ "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "mint", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "uint256", "name": "deadline", "type": "uint256" }, { "internalType": "uint8", "name": "v", "type": "uint8" }, { "internalType": "bytes32", "name": "r", "type": "bytes32" }, { "internalType": "bytes32", "name": "s", "type": "bytes32" }], "name": "permit", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "bytes32", "name": "role", "type": "bytes32" }, { "internalType": "address", "name": "callerConfirmation", "type": "address" }], "name": "renounceRole", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "bytes32", "name": "role", "type": "bytes32" }, { "internalType": "address", "name": "account", "type": "address" }], "name": "revokeRole", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "bytes32", "name": "role", "type": "bytes32" }, { "indexed": true, "internalType": "bytes32", "name": "previousAdminRole", "type": "bytes32" }, { "indexed": true, "internalType": "bytes32", "name": "newAdminRole", "type": "bytes32" }], "name": "RoleAdminChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "bytes32", "name": "role", "type": "bytes32" }, { "indexed": true, "internalType": "address", "name": "account", "type": "address" }, { "indexed": true, "internalType": "address", "name": "sender", "type": "address" }], "name": "RoleGranted", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "bytes32", "name": "role", "type": "bytes32" }, { "indexed": true, "internalType": "address", "name": "account", "type": "address" }, { "indexed": true, "internalType": "address", "name": "sender", "type": "address" }], "name": "RoleRevoked", "type": "event" }, { "inputs": [{ "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "transfer", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "from", "type": "address" }, { "indexed": true, "internalType": "address", "name": "to", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Transfer", "type": "event" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "transferFrom", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }], "name": "allowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "decimals", "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "DEFAULT_ADMIN_ROLE", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "DOMAIN_SEPARATOR", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "eip712Domain", "outputs": [{ "internalType": "bytes1", "name": "fields", "type": "bytes1" }, { "internalType": "string", "name": "name", "type": "string" }, { "internalType": "string", "name": "version", "type": "string" }, { "internalType": "uint256", "name": "chainId", "type": "uint256" }, { "internalType": "address", "name": "verifyingContract", "type": "address" }, { "internalType": "bytes32", "name": "salt", "type": "bytes32" }, { "internalType": "uint256[]", "name": "extensions", "type": "uint256[]" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "bytes32", "name": "role", "type": "bytes32" }], "name": "getRoleAdmin", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "bytes32", "name": "role", "type": "bytes32" }, { "internalType": "address", "name": "account", "type": "address" }], "name": "hasRole", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "MAX_MINT_AMOUNT", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "", "type": "address" }], "name": "mintingInfo", "outputs": [{ "internalType": "uint256", "name": "lastMintTimestamp", "type": "uint256" }, { "internalType": "uint256", "name": "amountMinted", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "name", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }], "name": "nonces", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "bytes4", "name": "interfaceId", "type": "bytes4" }], "name": "supportsInterface", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "symbol", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "totalSupply", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "VALIDATOR_ROLE", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }],
			usdctoken: [{ "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "owner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "spender", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Approval", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "authorizer", "type": "address" }, { "indexed": true, "internalType": "bytes32", "name": "nonce", "type": "bytes32" }], "name": "AuthorizationCanceled", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "authorizer", "type": "address" }, { "indexed": true, "internalType": "bytes32", "name": "nonce", "type": "bytes32" }], "name": "AuthorizationUsed", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "_account", "type": "address" }], "name": "Blacklisted", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "newBlacklister", "type": "address" }], "name": "BlacklisterChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "burner", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "Burn", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "newMasterMinter", "type": "address" }], "name": "MasterMinterChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "minter", "type": "address" }, { "indexed": true, "internalType": "address", "name": "to", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "Mint", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "minter", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "minterAllowedAmount", "type": "uint256" }], "name": "MinterConfigured", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "oldMinter", "type": "address" }], "name": "MinterRemoved", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "previousOwner", "type": "address" }, { "indexed": false, "internalType": "address", "name": "newOwner", "type": "address" }], "name": "OwnershipTransferred", "type": "event" }, { "anonymous": false, "inputs": [], "name": "Pause", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "newAddress", "type": "address" }], "name": "PauserChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "newRescuer", "type": "address" }], "name": "RescuerChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "from", "type": "address" }, { "indexed": true, "internalType": "address", "name": "to", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Transfer", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "_account", "type": "address" }], "name": "UnBlacklisted", "type": "event" }, { "anonymous": false, "inputs": [], "name": "Unpause", "type": "event" }, { "inputs": [], "name": "CANCEL_AUTHORIZATION_TYPEHASH", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "DOMAIN_SEPARATOR", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "PERMIT_TYPEHASH", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "RECEIVE_WITH_AUTHORIZATION_TYPEHASH", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "TRANSFER_WITH_AUTHORIZATION_TYPEHASH", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }], "name": "allowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "approve", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "authorizer", "type": "address" }, { "internalType": "bytes32", "name": "nonce", "type": "bytes32" }], "name": "authorizationState", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_account", "type": "address" }], "name": "blacklist", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "blacklister", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_amount", "type": "uint256" }], "name": "burn", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "authorizer", "type": "address" }, { "internalType": "bytes32", "name": "nonce", "type": "bytes32" }, { "internalType": "uint8", "name": "v", "type": "uint8" }, { "internalType": "bytes32", "name": "r", "type": "bytes32" }, { "internalType": "bytes32", "name": "s", "type": "bytes32" }], "name": "cancelAuthorization", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "authorizer", "type": "address" }, { "internalType": "bytes32", "name": "nonce", "type": "bytes32" }, { "internalType": "bytes", "name": "signature", "type": "bytes" }], "name": "cancelAuthorization", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "minter", "type": "address" }, { "internalType": "uint256", "name": "minterAllowedAmount", "type": "uint256" }], "name": "configureMinter", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "currency", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "decimals", "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "decrement", "type": "uint256" }], "name": "decreaseAllowance", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "increment", "type": "uint256" }], "name": "increaseAllowance", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "string", "name": "tokenName", "type": "string" }, { "internalType": "string", "name": "tokenSymbol", "type": "string" }, { "internalType": "string", "name": "tokenCurrency", "type": "string" }, { "internalType": "uint8", "name": "tokenDecimals", "type": "uint8" }, { "internalType": "address", "name": "newMasterMinter", "type": "address" }, { "internalType": "address", "name": "newPauser", "type": "address" }, { "internalType": "address", "name": "newBlacklister", "type": "address" }, { "internalType": "address", "name": "newOwner", "type": "address" }], "name": "initialize", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "string", "name": "newName", "type": "string" }], "name": "initializeV2", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "lostAndFound", "type": "address" }], "name": "initializeV2_1", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address[]", "name": "accountsToBlacklist", "type": "address[]" }, { "internalType": "string", "name": "newSymbol", "type": "string" }], "name": "initializeV2_2", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_account", "type": "address" }], "name": "isBlacklisted", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "isMinter", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "masterMinter", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_to", "type": "address" }, { "internalType": "uint256", "name": "_amount", "type": "uint256" }], "name": "mint", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "minter", "type": "address" }], "name": "minterAllowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "name", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }], "name": "nonces", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "pause", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "paused", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "pauser", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "uint256", "name": "deadline", "type": "uint256" }, { "internalType": "bytes", "name": "signature", "type": "bytes" }], "name": "permit", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "uint256", "name": "deadline", "type": "uint256" }, { "internalType": "uint8", "name": "v", "type": "uint8" }, { "internalType": "bytes32", "name": "r", "type": "bytes32" }, { "internalType": "bytes32", "name": "s", "type": "bytes32" }], "name": "permit", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "uint256", "name": "validAfter", "type": "uint256" }, { "internalType": "uint256", "name": "validBefore", "type": "uint256" }, { "internalType": "bytes32", "name": "nonce", "type": "bytes32" }, { "internalType": "bytes", "name": "signature", "type": "bytes" }], "name": "receiveWithAuthorization", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "uint256", "name": "validAfter", "type": "uint256" }, { "internalType": "uint256", "name": "validBefore", "type": "uint256" }, { "internalType": "bytes32", "name": "nonce", "type": "bytes32" }, { "internalType": "uint8", "name": "v", "type": "uint8" }, { "internalType": "bytes32", "name": "r", "type": "bytes32" }, { "internalType": "bytes32", "name": "s", "type": "bytes32" }], "name": "receiveWithAuthorization", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "minter", "type": "address" }], "name": "removeMinter", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "contract IERC20", "name": "tokenContract", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "rescueERC20", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "rescuer", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "symbol", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "totalSupply", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "transfer", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "transferFrom", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "uint256", "name": "validAfter", "type": "uint256" }, { "internalType": "uint256", "name": "validBefore", "type": "uint256" }, { "internalType": "bytes32", "name": "nonce", "type": "bytes32" }, { "internalType": "bytes", "name": "signature", "type": "bytes" }], "name": "transferWithAuthorization", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "uint256", "name": "validAfter", "type": "uint256" }, { "internalType": "uint256", "name": "validBefore", "type": "uint256" }, { "internalType": "bytes32", "name": "nonce", "type": "bytes32" }, { "internalType": "uint8", "name": "v", "type": "uint8" }, { "internalType": "bytes32", "name": "r", "type": "bytes32" }, { "internalType": "bytes32", "name": "s", "type": "bytes32" }], "name": "transferWithAuthorization", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_account", "type": "address" }], "name": "unBlacklist", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "unpause", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_newBlacklister", "type": "address" }], "name": "updateBlacklister", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_newMasterMinter", "type": "address" }], "name": "updateMasterMinter", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_newPauser", "type": "address" }], "name": "updatePauser", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "newRescuer", "type": "address" }], "name": "updateRescuer", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "version", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "pure", "type": "function" }],
		}

		erc20Abi = [
			"function totalSupply() view returns (uint256)",
			"function balanceOf(address account) view returns (uint256)",
			"function transfer(address recipient, uint256 amount) returns (bool)",
			"function transferFrom(address sender, address recipient, uint256 amount) returns (bool)",
			"function approve(address spender, uint256 amount) returns (bool)",
			"function allowance(address owner, address spender) view returns (uint256)",
			"function symbol() view returns (string)",
			"function decimals() view returns (uint8)"  // Added the decimals function
		];





		// UX LOAD IMPROVERS
 
		function saveLastUXInfo(data) {
  const {
    chainName,
    chainId,
    tokenName,
    explorer,
    addr,
    gasBalance,
    formatedBalance,
    contractAddr,
  } = data;

  // Create an object and only include keys with defined values
  const lastUXInfo = {
    chainName,
    chainId,
    tokenName,
    explorer,
    addr,
    gasBalance,
  };

  if (formatedBalance) {
    lastUXInfo.formatedBalance = formatedBalance;
  }

  if (contractAddr) {
    lastUXInfo.contractAddr = contractAddr;
  }

  // Save to localStorage as a JSON string
  localStorage.setItem("lastUXInfo", JSON.stringify(lastUXInfo));
}



			function getLastUXInfo() {
				const savedInfo = localStorage.getItem("lastUXInfo");
				if (savedInfo) {
				try {
					return JSON.parse(savedInfo);
				} catch (error) {
					console.error("Error parsing lastUXInfo from localStorage:", error);
					return null;
				}
				}
				return null;
			}




		async function init(signer) {


			console.log(`

██╗██╗   ██╗███████╗
██║██║   ██║██╔════╝
██║██║   ██║███████╗
██║██║   ██║╚════██║
██║╚██████╔╝███████║
╚═╝ ╚═════╝ ╚══════╝
                    

███╗   ██╗ █████╗ ████████╗██╗   ██╗██████╗  █████╗ ██╗     ██╗███████╗
████╗  ██║██╔══██╗╚══██╔══╝██║   ██║██╔══██╗██╔══██╗██║     ██║██╔════╝
██╔██╗ ██║███████║   ██║   ██║   ██║██████╔╝███████║██║     ██║███████╗
██║╚██╗██║██╔══██║   ██║   ██║   ██║██╔══██╗██╔══██║██║     ██║╚════██║
██║ ╚████║██║  ██║   ██║   ╚██████╔╝██║  ██║██║  ██║███████╗██║███████║
╚═╝  ╚═══╝╚═╝  ╚═╝   ╚═╝    ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝╚══════╝╚═╝╚══════╝
                                                                       
                               
																				

`);
			console.log('init()')

				// ----------------------------------------------------------------------------------
				//Preload UI with saved data
				// IMPROVING LOAD TIME since v5.14
			// ----------------------------------------------------------------------------------
			const lastUXInfo = getLastUXInfo();
			
			if (lastUXInfo) {
			  console.log("⏱️Preloaded data:", lastUXInfo);
					setAddress(lastUXInfo.addr)
					populateBalances(lastUXInfo.chainName,lastUXInfo.chainId, lastUXInfo.tokenName, lastUXInfo.explorer, lastUXInfo.addr, lastUXInfo.gasBalance, lastUXInfo.formatedBalance, lastUXInfo.contractAddr) 
			}
			
			// ----------------------------------------------------------------------------------
			// Load contacts from localStorage
			// ----------------------------------------------------------------------------------
			// 1. check if tehre is something in localstorage
			// 2. if not tries to get the contacts from the privateData in the user did
			// 3. if there is data (only address and localName shoul be saved) reconstructs the minified avatar and saves it to localstorage

			// OBSERVATIONS: only when user starts a opens a chat the info checks for updates in avatar img
			
			loadContactsFromLocalstorage()

			// ----------------------------------------------------------------------------------
			// Load avatar from localStorage
			// ----------------------------------------------------------------------------------
				let avatar = localStorage.getItem('userAvatar');
					if (avatar) {
						try {
							let parsedAvatar = JSON.parse(avatar); // If stored as JSON
							document.getElementById('avatarIMG').src = parsedAvatar;
							document.getElementById('aliasAvatar').src = parsedAvatar;
							console.log('👩‍🍳👩‍🍳👩‍🍳 Avatar loaded from localStorage.');
						} catch {
							document.getElementById('avatarIMG').src = avatar;
							document.getElementById('aliasAvatar').src = avatar;
							console.log('👨‍🍳👨‍🍳👨‍🍳Avatar loaded from localStorage (raw).');
						}
					} else {
						console.log(' 👨‍🎤👨‍🎤👨‍🎤No avatar found in localStorage.');
						// load avatar later from did if available
					}
	
			// ----------------------------------------------------------------------------------
			// ONLINE OFFLINE
			// ----------------------------------------------------------------------------------
			reloadTranslations(); //load globallang before checking status
			updateStatus();
			// Listen for online and offline events
			window.addEventListener('online', updateStatus);
			window.addEventListener('offline', updateStatus);
			
			// reloadTranslations()
			
			 

			// ----------------------------------------------------------------------------------
			// Check if password exists in sessionStorage
			// ----------------------------------------------------------------------------------
			const storedPassword = sessionStorage.getItem("password");
			if (storedPassword) {
				console.log("Password found in sessionStorage!!");
			} else {
				console.log("No password found in sessionStorage.");
			}


			// ----------------------------------------------------------------------------------
			// Check if siger is passed at into this function
			// ----------------------------------------------------------------------------------

			if (typeof signer === 'undefined') {
				console.warn('No signer passed at init()');

				signer = await getSigner();
				if (signer === false) { console.log("The function returned false."); return; }
			} else {
				console.warn("SIGNER:", signer);
			}



			// ----------------------------------------------------------------------------------
			// SET ADDRESS
			// ----------------------------------------------------------------------------------
			console.warn('EVM ADDRESS (getSigner): ', signer.address)
			setAddress(signer.address)
			getPreferredToken()

			// ----------------------------------------------------------------------------------
			// CREATE CHAT
			// ----------------------------------------------------------------------------------

			await createXMPTchat(signer);

			// --------------
			// LOAD DEFAULT TOKENS
			// - USDC(erc20/ arbitrum sepolia) ==> FAUCET: 
			// - ETH( native token/ arbitrum sepolia) ==> FAUCET: 
			// --------------
			 




			// --------------
			// LOAD BALANCE
			// --------------
			let currentTokenContract = await loadToken(signer.address)
			console.log("currentTokenContract()", currentTokenContract)
			console.warn('USER ADDRESS', signer.address)

		 

			// POPULATE TOKEN SELECTORS
			populateTokenSelector()
			loadSettingsPreferences()// All options in settings MODAL UI-language-notif

			// -----------

			// LOAD USER DID
			await loadDID(signer)


			// -----------------------------------------
			// CHECK IF USER IS ARROBED
			// Define the pattern to match the "/@username" part
			// -----------------------------------------

			// Get the current URL
			const currentUrl = window.location.href;
			const url = new URL(currentUrl);
			const pathname = url.pathname;
			const pattern = /^\/@(\w+)/;

			// Check if the pathname matches the pattern
			const match = pathname.match(pattern);

			if (match) {
				// Extract the username from the pathname
				const username = match[1];

				// Do something with the username
				console.warn(`Username detected: ${username}`);
			} else {
				console.log("No username detected in the URL.");
			}
			// ----------------------------------------------------------------------------------
			//  CHECK IF USER COMES FROM A LINK
			// ----------------------------------------------------------------------------------
			const urlParams = new URLSearchParams(window.location.search);

			const chatValue = urlParams.get('chat');
			if (chatValue !== null) {

				console.warn(`( ⤵️⤵️⤵️⤵️comes from a  link)chat FOUND! TRYING TO CHAT WITH: ${chatValue}`);
				openChat()

				// check if has did
				const regexDID = /^did:ius:0x[a-fA-F0-9]{40}$/;
				const regexAddress = /^0x[a-fA-F0-9]{40}$/;
				if (regexDID.test(chatValue)) {
					// IF THIS IS A DID
					const parts = chatValue.split(':');

					// The Ethereum address is the last part
					const ethAddress = parts[parts.length - 1];

					// Optionally, validate the Ethereum address using ethers.js
					if (ethers.isAddress(ethAddress)) {
						console.log("🚀🚀🚀Valid Ethereum Address:", ethAddress);
						evmAddr = ethAddress;

					} else {
						console.log("Invalid Ethereum Address:", ethAddress);
					}

					console.warn('✅ chatValue is in the correct format, FETCHING DID: ', chatValue)

					let didData = await fetchDID(chatValue)
					dd = didData
					let avatar;



					let chatavatar;
					if (didData.data.avatar != '') {
						console.log(' HAS AAVATAR!');
						avatar = didData.data.avatar;
						chatavatar = JSON.parse(avatar)
					} else {
						console.warn(' DOESN\'T HAVE A AVATAR ');
						avatar = "./anonym.jpg"
						chatavatar = avatar
					}

					console.warn(` alias: ${didData.data.alias}`);


					// ?????????????????????????????????????????
					// HAcer aqui o en SaveContactsToLocalStorage la verificacion de si existe un did?
					// ?????????????????????????????????????????
					let contact = { address: didData.data.alias, username: null, avatar: avatar, did: chatValue }
					console.warn('CONTACTO POR URL!', contact)
					SaveContactsToLocalStorage(contact);

					console.warn('chatWith()', evmAddr, chatavatar)
					try { await chatWith(evmAddr, chatavatar) }
					catch (error) { Toast.fire('Error', error.message, "error"); }

				}

				else if (regexAddress.test(chatValue)) {
					// IF THIS IS AN ADDRESS
					console.warn('(⭐ THIS IS AN ADDRES ⭐ )chatValue is and ETH ADDress in the correct format.', chatValue);



					let didData = await fetchDID(chatValue)
					dd = didData
					let avatar;
					let chatavatar;
					if (didData.data.avatar != '') {
						console.log(' HAS AAVATAR!');
						avatar = didData.data.avatar;
						chatavatar = JSON.parse(avatar)
					} else {
						console.warn(' DOESN\'T HAVE A AVATAR ');
						avatar = "anonym.jpg"
						// avatar = "./anonym.jpg"
						chatavatar = avatar
					}

					console.warn(` alias: ${didData.data.alias}`);

					let contact = { address: didData.data.alias, username: null, avatar: avatar, did: chatValue }
					console.warn('CONTACTO POR URL!', contact)
					SaveContactsToLocalStorage(contact);

					try { await chatWith(chatValue, chatavatar) }
					catch (error) { Toast.fire('Error', error.message, "error"); }

				}

				else {
					console.warn('❌ chatValue is NOT in the correct format.');
				}

			} else {
				console.warn('chat parameter not found in the URL');
			}
			//  FIN CHECK IF USER COMES FROM A LINK
			// ----------------------------------------------------------------------------------

			startBalanceListener();

			// ----------------------------------------------------------------------------------
			// SET PREFERED CHAIN OPTION
			// ----------------------------------------------------------------------------------

			GLOBALCHAIN = localStorage.getItem("GLOBALCHAIN");
			if (GLOBALCHAIN === null) {
				console.log('GLOBALCHAIN is null');
				localStorage.setItem("GLOBALCHAIN", 0);
				GLOBALCHAIN = 0;

			} else {
				console.log('GLOBALCHAIN :', GLOBALCHAIN);
			}
			// -----------------------------------------
			// para que lo uso?, historial?
			await getChatAddresses()
			await listenAllNewAddresses()

		}
		init()

		// ----------------------
		// Start the balance listener
// Function to check balance
// async function checkBalance() {
//     console.log('⏰ BALANCE CHECKED!');
//     try {
//         // const balance = await tokenContract.balanceOf(walletAddress);
//         reloadBalance();
//         console.log(`Current balance: ${ethers.formatUnits(balance, 18)} tokens`);
//     } catch (error) {
//         console.error('Error fetching balance:', error);
//     }
// }

// Set interval to check balance every 15 seconds
const interval = 15000; // 15 seconds

let balanceCheckInterval;

// Function to start the balance listener
function startBalanceListener() {
    console.log('Starting balance listener...');
	
    // Start the interval only if the page is visible
    if (document.visibilityState === 'visible') {
		console.warn('STARTING reloadBalances');
        balanceCheckInterval = setInterval(reloadBalances, interval);
    }

    // Listen for visibility changes
    document.addEventListener('visibilitychange', handleVisibilityChange);
}

// Function to handle visibility changes
function handleVisibilityChange() {
    if (document.visibilityState === 'visible') {
        console.log('Tab is visible, starting balance checks...');
        // Restart the interval if the tab becomes visible
        if (!balanceCheckInterval) {
            balanceCheckInterval = setInterval(reloadBalances, interval);
        }
    } else {
        console.log('Tab is hidden, stopping balance checks...');
        // Clear the interval if the tab becomes hidden
        clearInterval(balanceCheckInterval);
        balanceCheckInterval = null;
    }
}

// Start the balance listener
// startBalanceListener();
		// // Function to check balance
		// async function checkBalance() {
		// 	console.log('⏰ BALANCE CHECKED! ')
		// 	try {
		// 		// const balance = await tokenContract.balanceOf(walletAddress);
		// 		reloadBalance()

		// 		console.log(`Current balance: ${ethers.formatUnits(balance, 18)} tokens`);
		// 	} catch (error) {
		// 		console.error('Error fetching balance:', error);
		// 	}
		// }

		// // Set interval to check balance every 15 seconds
		// const interval = 15000; // 15 seconds

		// // Start the balance listener
		// function startBalanceListener() {
		// 	console.log('Starting balance listener...');
		// 	setInterval(checkBalance, interval);
		// }


		// ------------------------------------------------------
		// var isFullscreen = false;
		var body = document.querySelector('body');
		var lastTapTime = 0;
		var isFullscreen = false;
		// ---------------------------------------------------------

		function toggleFullscreen() {
			if (!isFullscreen) {
				// Toast.fire({ icon: 'info', title: 'full screen in on!', text:' (double click again to turn it of)'});
				Swal.fire({
					title: 'Full screen 🖵',
					position: 'top',
					timer: 1500,
					showClass: {
						popup: `
      animate__animated
      animate__fadeInDown
      animate__faster
    `,
					},
					hideClass: {
						popup: `
      animate__animated
      animate__fadeOutUp
      animate__faster
    `,
					},
					grow: 'row',
					showConfirmButton: false,
					showCloseButton: true,
				})

				if (document.documentElement.requestFullscreen) {
					document.documentElement.requestFullscreen();
				} else if (document.documentElement.msRequestFullscreen) {
					document.documentElement.msRequestFullscreen();
				} else if (document.documentElement.mozRequestFullScreen) {
					document.documentElement.mozRequestFullScreen();
				} else if (document.documentElement.webkitRequestFullscreen) {
					document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
				}
				isFullscreen = true;
			} else {
				Toast.fire({ icon: 'info', title: 'full screen in off!', text: '' });

				if (document.exitFullscreen) {
					document.exitFullscreen();
				} else if (document.msExitFullscreen) {
					document.msExitFullscreen();
				} else if (document.mozCancelFullScreen) {
					document.mozCancelFullScreen();
				} else if (document.webkitExitFullscreen) {
					document.webkitExitFullscreen();
				}
				isFullscreen = false;
			}
		}


		



		// You would replace this ABI with the one fetched from Etherscan or another source
		const permitToken = [
			{
				"constant": false,
				"inputs": [
					{ "name": "owner", "type": "address" },
					{ "name": "spender", "type": "address" },
					{ "name": "value", "type": "uint256" },
					{ "name": "deadline", "type": "uint256" },
					{ "name": "v", "type": "uint8" },
					{ "name": "r", "type": "bytes32" },
					{ "name": "s", "type": "bytes32" }
				],
				"name": "permit",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			}
		];

		// Check if the ERC-20 token implements the permit function
		async function checkEIP2612Compatibility() {
			const tokenInterface = new ethers.Interface(permitToken);

			try {
				const functionSignature = tokenInterface.getSighash('permit(address,address,uint256,uint256,uint8,bytes32,bytes32)');
				const hasPermitFunction = abi.some((item) => item.type === 'function' && item.signature === functionSignature);
				console.log('EIP-2612 compatible:', hasPermitFunction);
			} catch (error) {
				console.log('EIP-2612 not compatible:', error);
			}

		}


		/*********************************************************************************************
		.) SOUNDS
		**********************************************************************************************/

	

		// Initialize Tone.js
		Tone.start();
		console.log("tone started");
		// Create a simple click sound with different parameters
		const clickSynth = new Tone.Synth({
			oscillator: {
				type: "sine", // You can experiment with different oscillator types
			},
			envelope: {
				attack: 0.01,
				decay: 0.1,
				sustain: 0.1,
				release: 0.5,
			},
		}).toDestination();

		function playincomingCall() {
  // Create a synth
  const synth = new Tone.Synth().toDestination();

  // Define a sequence of notes for the success sound
  const now = Tone.now();
  synth.triggerAttackRelease("C4", "8n", now);         // Middle C
  synth.triggerAttackRelease("E4", "8n", now + 0.2);  // E note
  synth.triggerAttackRelease("G4", "8n", now + 0.4);  // G note
  synth.triggerAttackRelease("C5", "8n", now + 0.6);  // High C
}

function playtxReceived() {
  // Create a synth with a smooth, bell-like tone
  const synth = new Tone.Synth({
    oscillator: { type: "triangle" },
    envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 }
  }).toDestination();

  // Play a longer, faster ascending arpeggio
  const now = Tone.now();
  const notes = ["C4", "D4", "E4", "G4", "A4", "B4", "C5", "E5"]; // Ascending scale
  notes.forEach((note, index) => {
    synth.triggerAttackRelease(note, "16n", now + index * 0.05); // Faster timing
  });

  // Add a final "chime" for emphasis
  synth.triggerAttackRelease("G5", "8n", now + notes.length * 0.05); // After the arpeggio
}

// Test the sound
// playDynamicSuccessSound();

// playQRscanned
		function playQRscanned() {
			var AudioContext = window.AudioContext || window.webkitAudioContext;
			var audioCtx = new AudioContext();

			var oscillator = audioCtx.createOscillator();
			oscillator.type = "sine"; // Set the waveform type
			oscillator.frequency.value = 864; // Set the frequency (Hz)

			oscillator.connect(audioCtx.destination);
			oscillator.start();

			// Stop the oscillator after 100 milliseconds
			setTimeout(function () {
				oscillator.stop();
			}, 100);
		}

		function playButtonClickSound() {
			// Trigger the synth to produce a short click sound
			clickSynth.triggerAttackRelease("C4", "8n");
		}


		// Function to play a tic sound
		function playTic() {
			// Create a ping sound using a simple synthesizer
			const synth = new Tone.Synth({
				oscillator: {
					type: 'sine' // Sine wave for a soft tic sound
				},
				envelope: {
					attack: 0.001,
					decay: 0.1,
					sustain: 0,
					release: 0.1
				}
			}).toDestination();

			// Play a high-pitched short note to mimic a tic sound
			synth.triggerAttackRelease("C6", "8n");
		}

		// Function to play a cartoonish tic sound
		function cartoonPlayTic() {
			// Create a more playful sound using a square wave oscillator
			const synth = new Tone.Synth({
				oscillator: {
					type: 'square' // Square wave for a more cartoonish sound
				},
				envelope: {
					attack: 0.001, // Very short attack for a quick sound
					decay: 0.05,   // Fast decay to give it a pluck-like feel
					sustain: 0.2,  // Brief sustain to keep it light
					release: 0.05  // Short release to avoid lingering notes
				}
			}).toDestination();

			// Play a high-pitched note for a short duration
			synth.triggerAttackRelease("G6", "16n");
		}

		// Function to play a boing or pop sound
		function playBoing() {
			const synth = new Tone.Synth({
				oscillator: {
					type: 'triangle' // Smooth waveform for a bouncing effect
				},
				envelope: {
					attack: 0.05,  // Slight delay in attack for a stretchy feel
					decay: 0.2,    // Longer decay to let the sound bounce
					sustain: 0,    // No sustain, keeping it short
					release: 0.2   // Short release to cut it off cleanly
				},
				portamento: 0.2  // This creates the pitch glide for a boing effect
			}).toDestination();

			// Start with a high note and glide downward quickly
			synth.triggerAttackRelease("C7", "8n");
		}

		 // Create a function to play the bubble pop sound
		 function playBubblePop() {
      // Create a synth with a custom envelope and filter
      const bubbleSynth = new Tone.Synth({
        oscillator: {
          type: 'sine', // Sine wave for a smooth, round sound
        },
        envelope: {
          attack: 0.01,  // Very fast attack
          decay: 0.3,    // Medium decay to fade out quickly
          sustain: 0,    // No sustain (short sound)
          release: 0.1   // Short release
        }
      }).toDestination();

      // Add a lowpass filter to soften the sound
      const filter = new Tone.Filter(800, 'lowpass').toDestination();
      bubbleSynth.connect(filter);

      // Trigger the note (C5 is a good starting pitch for a bubble-like sound)
      bubbleSynth.triggerAttackRelease('C5', '8n'); // Play the note for an 8th note duration
    }
		/*********************************************************************************************
		.) MANAGE MODALS
		**********************************************************************************************/


		function openModalId(id, event) {
			console.log("openingModal", id, event);
			setTimeout(() => {
				window[id + "Modal"] = new bootstrap.Modal(document.querySelector(`${id}`));
				window[id + "Modal"].show(event);

				// Check if the modal is open
				var isModalOpen = window[id + "Modal"]._isShown;
				// console.log("Is modal open?", window[id + "Modal"], isModalOpen);
			}, 50);
		}

		function closeModalId(id, event) {
			console.log("closing modal", id, event);
			var modal = window[id + "Modal"];
			if (modal && modal._isShown) {
				// console.log("Is modal open?", modal, modal._isShown);
				modal.hide(event);
			} else {
				console.log("Modal is not open or not defined.");
			}
		}

		/*********************************************************************************************
		.) sweetalert2
		// position: "top-right",
		**********************************************************************************************/

		const ToastTop = Swal.mixin({
			toast: true,
			position: "bottom-end",
			showConfirmButton: false,
			timer: 3000,
			timerProgressBar: true,
			didOpen: (toast) => {
				toast.addEventListener("mouseenter", Swal.stopTimer);
				toast.addEventListener("mouseleave", Swal.resumeTimer);
			},
			iconColor: "white",
			customClass: {
				popup: "colored-toast",
			},
		});

	

		const superToast = Swal.mixin({
			toast: true,
			position: "bottom-end",
			showConfirmButton: false,
			timer: 1000,
			timerProgressBar: true,
			didOpen: (toast) => {
				toast.addEventListener("mouseenter", Swal.stopTimer);
				toast.addEventListener("mouseleave", Swal.resumeTimer);
			},
			iconColor: "white",
			customClass: {
				popup: "colored-toast",
			},
		});
		const newMessageToast = swal.mixin({
			toast: true,
			position: "bottom-left",
			showConfirmButton: false,
			showDenyButton: false,
			showCancelButton: false,
			timer: 7000,

			// iconColor: "white",
			customClass: {
				popup: "supercolored-toast",
			},
		});

		const Toast = Swal.mixin({
			toast: true,
			position: "bottom-end",
			showConfirmButton: false,
			timer: 3000,
			timerProgressBar: true,
			didOpen: (toast) => {
				toast.addEventListener("mouseenter", Swal.stopTimer);
				toast.addEventListener("mouseleave", Swal.resumeTimer);
			},
			iconColor: "white",
			customClass: {
				popup: "colored-toast",
			},
		});

		const fixToast = Swal.mixin({
			toast: true,
			position: "bottom-end",
			showConfirmButton: false,
			didOpen: (toast) => {
				toast.addEventListener("mouseenter", Swal.stopTimer);
				toast.addEventListener("mouseleave", Swal.resumeTimer);
			},
			iconColor: "white",
			customClass: {
				popup: "colored-toast",
			},
		});
		const fixedToast = swal.mixin({
			toast: true,
			position: "bottom-end",
			showConfirmButton: false,
			showDenyButton: false,
			showCancelButton: false,
			iconColor: "white",
			customClass: {
				popup: "colored-toast",
			},
		});


		/*********************************************************************************************
		.)  SIDEBAR
		**********************************************************************************************/

		// Get the navigation button and add a click event listener
		var navBtn = document.querySelector(".hamburger");
		navBtn.addEventListener("click", plToggle);

		// Define the plToggle function
		function plToggle(event) {
			//   console.log("TOOGLE NAVBAR", event);
			navBtn.classList.toggle("is-active");

			// Toggle classes for elements with class 'content', 'sidebar', and 'overlay'
			document.querySelector(".sidebar").classList.toggle("isOpen");
			document.querySelector(".overlay").classList.toggle("overlayisOpen");

			// Get the container element with class 'sidebar'
			var container = document.querySelector(".sidebar");
		}

		// Add a click event listener to the overlay element
		document.querySelector(".overlay").addEventListener("click", function (event) {
			console.log("clickeado en nav li");
			plToggle();
		});


		/*********************************************************************************************
		.)  COPYFadd 
		**********************************************************************************************/
      
		function showSuccessIcon(element) {
                        const svgElement = element.closest("svg");
            if (!svgElement) return;

            
            svgElement.innerHTML = `
                <path fill="green" d="M504 75c-9.4-9.4-24.6-9.4-33.9 0L184.4 360.7l-112-112c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l128 128c9.4 9.4 24.6 9.4 33.9 0l304-304c9.3-9.4 9.3-24.6-.1-33.9z"></path>
            `;
            setTimeout(() => {
                svgElement.innerHTML = `<path fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"></path>`
            }, 1500);
        }

		// ----------------------------------------------------------------------
		// ----------------------------------------------------------------------
		  /*********************************************************************************************
        .)  COPYFadd 
        **********************************************************************************************/
        function copy2clipboard(text) {
            let thisEl= event.target;
 
            try {
              // Check if Clipboard API is supported
              if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                  console.log('Copied to clipboard:', text);
                  showSuccessIcon(thisEl); // Use event.target to get the clicked element

                }).catch(err => {
                  console.error('Failed to copy using Clipboard API:', err);
                  fallbackCopy(text); // Fallback to execCommand if API fails
                  showSuccessIcon(thisEl); // Use event.target to get the clicked element

                });
              } else {
                  fallbackCopy(text); // Fallback for older browsers
                  showSuccessIcon(thisEl); // Use event.target to get the clicked element

              }
            } catch (err) {
              console.error('Copy failed:', err);
            }
          }
          
          function fallbackCopy(text) {
            // Create a temporary, invisible textarea
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; // Prevent scrolling issues
            textarea.style.opacity = '0'; // Invisible
            textarea.style.zIndex = '-1'; // Avoid modal interference
            document.body.appendChild(textarea);
            textarea.select();
            try {
              document.execCommand('copy');
              console.log('Copied to clipboard (fallback):', text);
            } catch (err) {
              console.error('Fallback copy failed:', err);
            }
            document.body.removeChild(textarea);
          }
            
          function showSuccessIcon(element) {
                        const svgElement = element.closest("svg");
            if (!svgElement) return;

            
            svgElement.innerHTML = `
                <path fill="green" d="M504 75c-9.4-9.4-24.6-9.4-33.9 0L184.4 360.7l-112-112c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l128 128c9.4 9.4 24.6 9.4 33.9 0l304-304c9.3-9.4 9.3-24.6-.1-33.9z"></path>
            `;
            setTimeout(() => {
                svgElement.innerHTML = `<path fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"></path>`
            }, 1500);
        }


		// --------------
		// function copy2clipboard(text) {
		// 	console.log('COPIED!', text)
		// 	let textLink = `<a target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/address/${text}">${text}</a>`;

		// 	if (window.clipboardData && window.clipboardData.setData) {
		// 		ToastTop.fire('Copied to Clipboard', textLink, "success");
		// 		return window.clipboardData.setData("Text", text);
		// 	}
		// 	else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
		// 		var textarea = document.createElement("textarea");
		// 		textarea.textContent = text;
		// 		textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in Microsoft Edge.
		// 		document.body.appendChild(textarea);
		// 		textarea.select();
		// 		try {
		// 			ToastTop.fire('Copied to Clipboard!', textLink, "success");
		// 			return document.execCommand("copy");  // Security exception may be thrown by some browsers.
		// 		}
		// 		catch (ex) {
		// 			console.warn("Copy to clipboard failed.", ex);
		// 			return prompt("Copy to clipboard: Ctrl+C, Enter", text);
		// 		}
		// 		finally {
		// 			document.body.removeChild(textarea);
		// 		}
		// 	}
		// }


		// ----------------------------------------------------------------------
		// ----------------------------------------------------------------------
		// ----------------------------------------------------------------------
		function shortAddressETH(address) {
			if (typeof address !== 'string' || address.length < 42) {
				throw new Error('Invalid Ethereum address');
			}
			return address.substring(0, 6) + "..." + address.substring(38, 42);
		}

		function shortAddressSTARK(address) {
			if (typeof address !== 'string' || address.length < 64) {
				throw new Error('Invalid StarkNet address');
			}
			return address.substring(0, 6) + "..." + address.substring(address.length - 4);
		}



		async function getLocalWalletSigner() {
			console.warn('getLocalWalletSigner()');



			return Swal.fire({
				title: dictionary[globalLang]["unlockWallet"],
				input: 'password',
				inputAttributes: { autocapitalize: 'off' },
				showLoaderOnConfirm: true,
				backdrop: true,
				showCancelButton: false,
				showDenyButton: true,
				confirmButtonText: 'Enter',
				denyButtonText: `Cancel`,



				html: `
		<input type="checkbox" id="rememberPassword" name="rememberPassword" checked> 
		<label for="rememberPassword">${dictionary[globalLang]["rememberPassword"]}</label> 
		`,
				footer: '<a href="/docs/index.html#" target="_blank" rel="noopener noreferrer">Docs</a>',
				preConfirm: (value) => {
					if (!value) {
						Swal.showValidationMessage('<i class="fa fa-info-circle"></i> A password is required')
					}

				},
				allowOutsideClick: () => { const popup = Swal.getPopup(); popup.classList.remove('swal2-show'); setTimeout(() => { popup.classList.add('animate__animated', 'animate__headShake'); }); setTimeout(() => { popup.classList.remove('animate__animated', 'animate__headShake'); }, 500); return false; },
			})
				.then(async (result) => {

					if (result.isConfirmed) {

						// =========================
						//   if input rememberPassword is clicked


						const password = result.value;
						const rememberPasswordCheckbox = Swal.getPopup().querySelector('#rememberPassword');

						console.log('password entered!');

						if (rememberPasswordCheckbox.checked) {
							sessionStorage.setItem("password", password);

						} else {
							sessionStorage.removeItem("password");

						}

						// Continue with your logic using the entered password
						// return password;
						// =========================

						let encryptedjson = localStorage.getItem('encryptedWallet');
						let ew = JSON.parse(encryptedjson);
						console.log('pub key of wallet in localstorage:', ew.address);


						try {
							const localWallet = await ethers.Wallet.fromEncryptedJson(encryptedjson, result.value);
							console.log('localWallet.publicKey:', localWallet.publicKey);
							const provider = new ethers.JsonRpcProvider(`${optionsList[0].API}`);
							const signer = localWallet.connect(provider);
							console.log('SIGNER:', signer);
							return signer;
						} catch (error) {
							console.error('Error during wallet decryption:', error);
							Swal.fire({
								icon: "error",
								title: "Error 🚨",
								text: error.message,
							})
								.then((result) => {
									if (result.isConfirmed) {
										console.log('OK button clicked');
										lockscreen.style.display = 'flex'
									}

								});

							// REMOVE PASSWORD FROM SESSION 
							sessionStorage.removeItem("password");
							return null;
						}

					}


				});
		}

		// ---------------------------------------------

		function toChecksumAddress(address) {
			return ethers.getAddress(address);
		}


		// -----------------------
		// ------------------------------
		async function unlockLocalwallet() {

			console.log('unlockLocalwallet()')
			// LOAD CHAT
			let signer;
			console.log('there is no signer')
			try {
				signer = await getLocalWalletSigner();

				if (!signer || !signer.address) {
					throw new Error("Signer is undefined or does not have an address");
					document.getElementById('lockscreen').style.display = 'block'

				}

				// Use signer.address here safely
				console.log('Signer address:', signer.address);

			} catch (error) {
				console.log('Error at getLocalWalletSigner():', error.message);
				return;
			}
			lockscreen.style.display = 'none'


			await loadDID(signer)
			reloadBalances()
			await init(signer)

			if (!signer) {
				console.log('Handle case where signer is not obtained');
				lockscreen.style.display = 'flex'
				return; // Or throw an error, or handle the case in another way
			}

		}

		// ---------------------------------------------

		async function getSigner() {
			console.warn('*** getSigner() ***')

			let signer;
			// 1- GET  PRIV KEY(IF not CREATE IT)
			const chatETHPrivKey = localStorage.getItem('chatETHPrivKey');
			if (!chatETHPrivKey) {
				console.warn('No chatETHPrivKey found. Checking for unbackedWallet.');

				// 2- NO PRIV KEY, IS UNBACKEDWALLET?
				const unbackedWallet = localStorage.getItem('unbackedWallet');
				if (!unbackedWallet) {
					console.warn('No unbackedWallet found. Checking for encryptedWallet.');

					// 3-  NO UNBACKED WALLET, is JSONWALLET?
					const encryptedWallet = localStorage.getItem('encryptedWallet');
					if (!encryptedWallet) {
						console.warn('No encryptedWallet found.');
						// CREATE UNBACKED WALLET
						try { signer = await ethers.Wallet.createRandom() }
						catch (error) {
							console.log(error.message);
							fixedToast.fire('Error', error.message, "error");
						}
						console.warn('RANDOM WALLET CREATED!:', signer.address, 'mnemonic:', signer.mnemonic.phrase, 'privkey:', signer.privateKey)
						localStorage.setItem('unbackedWallet', JSON.stringify(signer.mnemonic.phrase))

						setTimeout(() => {
							console.warn('ADDING REMEMBER TO BACKUP WALLET TO HEADERNOTES ^^^^^^^^^^')

							headerNotes.innerHTML = `
					<div class="alert alert-warning alert-dismissible fade show headerNotes">
						<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
						<strong>Alert!</strong> Remember to backup your wallet.
						<button type="button" class="btn btn-primary" onclick="backup()">Backup Now</button>
					</div>
					`;
						}, 5000);

						// return signer; // Return the signer here

					} else {
						// Handle encryptedWallet
						console.warn('3- encryptedWallet found. Checking for jsonWalletPassword.');
						const jsonWalletPassword = sessionStorage.getItem('password');
						if (!jsonWalletPassword) {
							console.warn('No jsonWalletPassword found.');

							// 1. get and form address from json wallet
							let addr = JSON.parse(encryptedWallet).address;
							const checksumAddress = toChecksumAddress(`0x${addr}`);

							// 2. shot it into qr
							setAddress(checksumAddress)

							// 3. display UI in lock mode
							document.getElementById("loader").style.display = "none";//flex
							lockscreen.style.display = 'flex'

							return false

						} else {
							// Handle encryptedWallet and jsonWalletPassword
							console.log('encryptedWallet and jsonWalletPassword found.');
							// FIX1?: catch the signer here?
							// let signer;
							try {
								signer = await ethers.Wallet.fromEncryptedJson(encryptedWallet, jsonWalletPassword)
								console.warn('SIGNER GLOBAL TRUE ***')

							} catch (error) {
								console.warn(error.message, 'ERROR WALLET!');
								fixedToast.fire({ icon: 'error', title: error.message });
								sessionStorage.removeItem('password')
								return false
							}
							// return signer; // Return the signer here

						}

					}


				}
				else {
					// Handle unbackedWallet
					console.warn('2- YES unbackedWallet')
					const walletData = JSON.parse(unbackedWallet);
					try {
						signer = ethers.Wallet.fromPhrase(walletData);
						setTimeout(() => {
							console.warn('ADDING REMEMBER TO BACKUP WALLET TO HEADERNOTES ****************^^^^^^^^^^')
							headerNotes.innerHTML = `
					<div class="alert  alert-dismissible fade show ">
						<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
						<strong>Alert!</strong> Remember to backup your wallet.
						<button type="button" class="" onclick="backup()">Backup Now</button>
					</div>
					`;
						}, 5000);
					}
					catch (error) { console.warn(error.message, 'ERROR WALLET!'); localStorage.removeItem('unbackedWallet'); }


				}

			} // fin chatETHPrivKey
			else {
				// Handle chatETHPrivKey
				console.warn('1- YES chatETHPrivKey', chatETHPrivKey)
				try {
					signer = await new ethers.Wallet(chatETHPrivKey)

				}
				catch (error) {
					console.log(error.message);
					document.getElementById("loader").style.display = "none";//flex
					lockscreen.style.display = 'flex';
				}
			}


			return signer


		}


		/*********************************************************************************************
		.)  BAKCUP
		**********************************************************************************************/
		function backupWallet(mnemonic) {
			console.log('now, (is this used?) backupWallet()', mnemonic)
			//////////////////////
			// CREATE WALLET
			Swal.fire({
				title: dictionary[globalLang]["createpasswordtoencryptwallet"],
				input: 'password',
				inputAttributes: {
					autocapitalize: 'off'
				},
				showCancelButton: true,
				confirmButtonText: 'create',
				showLoaderOnConfirm: true,
				// preConfirm: (login) => { },
				backdrop: true,

				inputValidator: (value) => {
					if (!value) {
						return 'You need to set a password to create your wallet!'
					}
				},

				allowOutsideClick: () => {
					const popup = Swal.getPopup()
					popup.classList.remove('swal2-show')
					setTimeout(() => { popup.classList.add('animate__animated', 'animate__headShake') })
					setTimeout(() => { popup.classList.remove('animate__animated', 'animate__headShake') }, 500)
					return false
				},

			})
				.then(async (result) => {
					if (result.isConfirmed) {
						// console.log('PASSWORD RESULT:',result.value)

						await makeBackup(result.value, mnemonic)
						return result.value
					}
				})


		}


		async function makeBackup(pwd, mnemonic) {

			// console.log('MAKE BACKUP address:', signer.address)
			console.log('MAKE BACKUP mnemonic:', mnemonic)


			// WRITE YOUR MNEMONIC PHRASE
			// displayMnemonic.innerHTML = ` <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height='40px' width='40px' fill="currentColor"> <path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/></svg>Write down your mnemonic phrase to access your wallet in the future! :</h3> <div class="alert alert-warning alert-dismissible fade show"  > <strong translate="no">${mnemonic}</strong> </div> `
			displayMnemonic.innerHTML = ` <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height='40px' width='40px' fill="currentColor"> <path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/></svg>${dictionary[globalLang]["writedown"]} :</h3> <div class="alert alert-warning alert-dismissible fade show"  > <strong translate="no">${mnemonic}</strong> </div> `
			// CREATING ENCRYPTED LOCAL WALLET
			displayMnemonic.innerHTML += ` <div  id="loaderCW"  > <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span> creating encrypted wallet ... </div> `


			walletbackpfooter.innerHTML = `<a href="/docs/index.html#/?id=la-frase-mnemot%c3%a9cnica" target="_blank" rel="noopener noreferrer">Check out the documentation!</a> `

			// SAVE TO LOCALSTORAGE (encrypted?)
			console.log('password: ', pwd)
			try {
				// wallet = ethers.HDNodeWallet.fromMnemonic(mnemonic);
				wallet = ethers.Wallet.fromPhrase(mnemonic)
			}
			catch {
				console.warn(error)
			}
			const promisseJSON = wallet.encrypt(pwd);
			promisseJSON.then((encryptedWallet) => {
				console.log(encryptedWallet)
				console.log('WALLET ENCRYPTED')

				// loaderCW
				document.getElementById('loaderCW').innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
<symbol id="check-circle-fill" fill="currentColor" viewBox="0 0 16 16">
<path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
</symbol>
<symbol id="info-fill" fill="currentColor" viewBox="0 0 16 16">
<path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
</symbol>
<symbol id="exclamation-triangle-fill" fill="currentColor" viewBox="0 0 16 16">
<path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
</symbol>
</svg>

<div class="alert alert-success d-flex align-items-center" role="alert">
<svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Success:"><use xlink:href="#check-circle-fill"/></svg>
<div>
Wallet encrypted and saved into localstorage
</div>
</div>
`


				localStorage.setItem('encryptedWallet', encryptedWallet)
				console.log(' ENCRYPTED JSONWALLET SAVED INTO LOCALSTORAGE')
				//   localStorage.setItem('encryptedAddress', wallet.address)
				console.log(' ENCRYPTED ADDRESS SAVED INTO LOCALSTORAGE')

				setTimeout(() => {
					const checkbox = document.getElementById('mnemonicBackedup');
					// const button = document.getElementById('closeWalletBkp');
					const button = document.getElementById('closeBackupmodal');

					mnemonicBackedup.disabled = false;
					// closeBackupmodal
					// Add an event listener to the checkbox to track its state
					checkbox.addEventListener('change', function () {
						// If the checkbox is checked, enable the button; otherwise, disable it
						button.disabled = !this.checked;
						mnemonicBackedup.disabled = true;
						console.log('close mnemonic activated')

						// NOW DELETE unbackedWallet
						localStorage.removeItem('unbackedWallet')

					});
					// init();
				}, 1000);


			});


			setTimeout(() => {
				openModalId('#walletBackp')

			}, 50);

		}
		/*********************************************************************************************
			.)  QR
			**********************************************************************************************/
		async function showqr(addr) {
			const qrColor = getComputedStyle(document.body).getPropertyValue('--qr');

			var isMobile = window.matchMedia("only screen and (max-width: 768px)");

			// let qrSize
			if (isMobile.matches) {
				console.log("Mobile screen detected");
				qrSize = 310;
				window.scrollTo(0, 0);


			} else {
				console.log("Not a mobile screen");
				qrSize = 370
			}

			//QR
			let logoImgCompress = `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAY4AAAGOCAMAAAC32hROAAAAtFBMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////oK74hAAAAO3RSTlMA+AXy7AkNIhHnFb3LxrRC4xkvHpDcz9c939NINCbBq5yLpypjVJiUhrijbK9nOHtvX0x3UIJ0f6BbWN+ygOMAAFubSURBVHja7NrXdtpAEIDhWRWaCqIIME0K3RSDMf1///fKOdhxHMcEKQGfgPmuVVazOzu7kuRSaI3a41MxDMZW0676aeOZ4h1lPPP8qt20xkFYfHqsNTS5OZncfO3e8ZPybHfoE4Pyx+t5Tm7+UWa+dNO80Ktu/2n3kBPJFw1e6b5j3QdB4FpOWectazDoD607Xnjuep6Sm7/T7mzKr4Ec7Oo/IpkaldjzrOKk0jDlLTNZm/WbOnv6MvM8z3UH9wbPqv3uLU3iakwCAwBlh7Ps2yFdD9VLVDNykJbvDNMAaliXF4XF0vXYK4ePSbmJJrMdegB4rVFek7fMjg0o9zEjx9WnNkBz8bYM7fpV9rzN7jZxHVVfOwcHcG5gAFYnehgbax8oT8xfurv70iXKWjXk5hCt1ksD3H04ETVCBXqvLfFkx4D3qL3LwEWxBED5W/a2Cv6A2R0aAM40/2FdHwPpVUriKxR1qM7lvdxjywAwWl1Tbt7Q5kMd0IMDRSHxTYEx/duoZb7pYDU+uO/DsgSgb2458qoSGoDRPxiSug/64F8qb6YHavrh9ZOrJkC6WJcbKax9QB/ONTlkpcBNyr/JW1CtHOiskQNQnn7x5a+5tQDlbk05KOGC15V/tzVgeajTk9MqgLP9upNW45sBOKPMHw8qQzEhp5AJoFk4nD+DO8AYfMkU0boWoPePLFxrBl5WTmWnYyzksGygALcmX0xqdQdUJ8eG/QSC1CkTsgTTP2bQkw/4q6+0Y08WdVCtihwzQO+cOCl70DJFjqWIHn6VDXs9ALxp7njo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`;

			const qrCode = new QRCodeStyling({
				width: `${qrSize}`, height: `${qrSize}`, type: "png", data: addr, image: logoImgCompress,
				// width: `${qrSize}`, height: `${qrSize}`, type: "png", data: addr, image: `./logowhite.png`,
				dotsOptions: { color: `${qrColor}`, type: "extra-rounded" },
				backgroundOptions: { color: "var(--qrbackground)", },
				imageOptions: { crossOrigin: "anonymous", margin: 0 }
			});
			qrCode.append(document.getElementById("canvas"));
			console.log('qr code APPENDED')
			document.querySelector('.main-wrap').style.backgroundImage = 'none';
			loader.style.display = 'none'

		}


		// function displayQR(data) {
		// 	console.log('displayQR(data)')
		// 	const qrCode = new QRCodeStyling({
		// 		width: 500, height: 500, type: "png", data: data, image: `id5.svg`,
		// 		dotsOptions: { color: "#1568B0", type: "extra-rounded" },
		// 		backgroundOptions: { color: "var(--qrbackground)", },
		// 		imageOptions: { crossOrigin: "anonymous", margin: 3 }
		// 	});
		// 	qrCode.append(document.getElementById("canvas"));
		// 	// canvas.classList.add('animate')
		// }

		function setAddress(userAddress) {
			console.log('setAddress()', userAddress)

			// v1
			// var currentURL = window.location.href;
			var baseUrl = window.location.protocol + '//' + window.location.host + '/';
			// var baseUrl = 'https://192.168.43.129:4343' + '/';
			// var baseUrl = 'https://iusnaturalis.web.app' + '/';
			let did = `did:ius:${userAddress}`
			const parameters = { chat: did };
			const urlParams = createURLParams(parameters);
			const url = `${baseUrl}?${urlParams}`;

			// 3- SHOW QR
			canvas.innerHTML = '';
			showqr(url);

			// 	// var isFullscreen = false;
			// 	var body = document.querySelector('body');
			// var lastTapTime = 0;
			// var isFullscreen = false;

			canvas.onclick = function (e) {
				console.log('CHATWALLET: clicked on QR')
				var currentTime = new Date().getTime();
				var tapLength = currentTime - lastTapTime;
				if (tapLength < 500 && tapLength > 0) {
					toggleFullscreen();
				}
				lastTapTime = currentTime;
			}

			// let shortAddr = userAddress.substring(0, 6) + "..." + userAddress.substring(38, 42);
			let shortAddr = shortAddressETH(userAddress)
			var preElement = document.getElementById('yourAddress');
			preElement.setAttribute('address', userAddress);

			yourAddress.innerHTML = `${shortAddr} <svg id='copyAddress' onclick="event.stopPropagation();copy2clipboard('${userAddress}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill='currentColor' d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"/></svg> 			
		
			<svg id='shareAddress' onclick="event.stopPropagation();copy2clipboard('${url}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><path fill='currentColor'  d="M352 224c53 0 96-43 96-96s-43-96-96-96s-96 43-96 96c0 4 .2 8 .7 11.9l-94.1 47C145.4 170.2 121.9 160 96 160c-53 0-96 43-96 96s43 96 96 96c25.9 0 49.4-10.2 66.6-26.9l94.1 47c-.5 3.9-.7 7.8-.7 11.9c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-25.9 0-49.4 10.2-66.6 26.9l-94.1-47c.5-3.9 .7-7.8 .7-11.9s-.2-8-.7-11.9l94.1-47C302.6 213.8 326.1 224 352 224z"/></svg>			
			
			<svg id='simplesend' onclick="event.stopPropagation();simpleSend()" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <defs > <clipPath clipPathUnits="userSpaceOnUse" > <rect width="106.35429" height="78.068573" x="9.0514288" y="187.25142" /> </clipPath> </defs> <g transform="matrix(1.0583559,0,0,1.0583559,678.18141,477.32181)"> <path fill="currentColor" d="M 122.34961 22.404297 C 102.90845 22.541942 83.4884 23.208407 64.123047 25.130859 C 32.005914 32.74301 13.633824 64.1977 0.21875 91.888672 C 0.59031759 190.50417 -1.4164071 289.14446 1.4707031 387.73828 C -3.2139611 442.01413 47.311879 490.4789 100.67578 488.32227 C 204.56767 490.26899 308.49622 489.76604 412.37695 487.41016 C 455.00842 491.66379 499.19766 461.88412 507.98047 419.36328 C 511.41267 368.1022 508.76569 316.55734 508.78125 265.18555 C 507.78692 215.81739 510.67596 166.53718 511.68359 117.21094 C 515.55612 76.22511 486.62687 34.631163 445.61328 27.0625 C 370.4731 21.75639 294.91505 23.445051 219.58984 22.759766 C 187.21286 23.414564 154.75154 22.174889 122.34961 22.404297 z M 201.33008 50.462891 C 212.79999 49.869523 223.82167 54.325756 218.06445 67.503906 C 209.21938 71.892696 199.05142 70.553919 189.57227 69.984375 C 171.09491 60.335654 186.58305 51.225791 201.33008 50.462891 z M 378.60742 50.566406 C 390.32146 49.91717 401.56028 54.29308 395.27734 67.503906 C 386.45439 71.191451 376.63239 70.842293 367.3125 69.888672 C 347.70261 60.542435 363.54651 51.401138 378.60742 50.566406 z M 322.3125 50.871094 C 331.96784 50.788552 340.38367 54.86352 337.62695 66.570312 C 330.16888 73.751755 318.8153 69.887874 309.69727 69.847656 C 286.68559 62.694044 306.22027 51.008663 322.3125 50.871094 z M 264.42578 50.941406 C 274.04887 51.473285 281.70092 56.245902 276.58398 68.197266 C 268.02568 71.247765 258.77202 70.661056 249.875 70.027344 C 226.87374 60.949739 248.38729 50.054941 264.42578 50.941406 z M 142.29883 51.388672 C 153.70762 50.793577 164.46957 55.141948 159.0625 68.197266 C 148.96874 70.847251 138.41711 70.813462 128.07422 70.197266 C 111.89302 61.089951 127.63038 52.153794 142.29883 51.388672 z M 77.707031 52.076172 C 92.665231 51.670858 108.69779 64.278245 87.421875 71.65625 C 80.094115 76.927688 59.493487 74.453071 61.580078 62.40625 C 64.330772 55.131697 70.90785 52.260405 77.707031 52.076172 z M 437.95117 52.96875 C 446.58069 53.499952 453.61391 57.964614 448.89453 69.212891 C 443.09003 74.370841 435.13393 71.031306 428.54102 69.896484 C 404.75443 62.12546 423.56864 52.083413 437.95117 52.96875 z M 467.25 80.292969 C 476.05807 81.586828 488.63451 99.731074 478.24023 109.76172 C 466.60642 116.16445 463.30811 98.48209 460.08594 91.316406 C 460.02046 82.597419 463.24633 79.704851 467.25 80.292969 z M 46.603516 86.378906 C 55.239528 88.381655 54.94777 115.64672 45.767578 124.4668 C 27.678762 132.02244 32.290326 103.51577 34.990234 94.416016 C 39.854266 87.850904 43.724845 85.711323 46.603516 86.378906 z M 475.48633 127.70508 C 482.88498 128.68897 484.4465 151.48356 480.40625 160.5957 C 466.82241 175.97111 460.27278 144.01616 466.13281 135.30664 C 469.90454 129.47352 473.02011 127.37711 475.48633 127.70508 z M 40.814453 145.95508 C 49.217435 147.73322 53.436635 176.59025 44.138672 185.625 C 25.792326 195.14735 31.36027 164.06133 31.361328 154.93945 C 34.746186 147.77739 38.013459 145.36236 40.814453 145.95508 z M 40.980469 208.54102 C 52.108736 209.14498 50.554573 235.88456 45.646484 247.69336 C 23.833505 257.07186 35.227386 222.776 31.134766 212.80273 C 35.168308 209.6538 38.412407 208.40164 40.980469 208.54102 z M 39.839844 272.02734 C 47.059432 271.21967 54.10366 277.1786 48.970703 290.89062 C 53.446289 317.27501 29.027322 321.93058 29.65625 293.76172 C 25.225649 280.40896 32.620256 272.83501 39.839844 272.02734 z M 41.21875 334.38086 C 52.218054 336.41594 49.773587 364.74996 44.185547 374.0332 C 22.790671 382.03895 32.805162 348.13594 31.330078 337.73047 C 35.426918 334.84191 38.680449 333.91123 41.21875 334.38086 z M 471.94531 344.46094 C 478.73409 344.06655 486.56003 350.35745 480.28711 360.78516 C 480.87081 383.10497 465.25145 377.82384 465.10938 358.71484 C 462.01336 349.11908 466.66515 344.76768 471.94531 344.46094 z M 470.67188 395.33984 C 478.65718 394.06626 486.55386 416.73373 475.44727 424.66406 C 464.24942 442.94477 451.89416 417.35385 463.35742 406.02734 C 465.33878 398.85039 468.01011 395.76437 470.67188 395.33984 z M 39.148438 396.43164 C 47.847352 396.03896 61.578726 413.3123 53.775391 426.22266 C 43.216724 433.89031 34.462757 418.70246 32.900391 409.98633 C 32.280075 400.43953 35.194385 396.61013 39.148438 396.43164 z M 434.27539 440.71289 C 446.12895 441.04492 455.68569 447.75243 440.74805 457.34375 C 433.99085 464.01104 415.7483 463.43418 412.89062 453.14844 C 414.44671 444.05227 425.05595 440.45464 434.27539 440.71289 z M 81.375 441.21289 C 91.803448 441.12577 102.40272 445.68911 97.503906 458.07031 C 90.667329 462.10042 82.378987 460.01552 75.302734 457.87891 C 54.842676 449.12311 67.966996 441.32491 81.375 441.21289 z M 198.75195 442.04102 C 213.4483 442.93836 227.47155 463.64651 203.53711 462.19922 C 187.4029 470.94821 164.91368 452.25832 188.92773 445.10156 C 191.93254 442.68284 195.36049 441.83394 198.75195 442.04102 z M 141.35742 442.52539 C 154.60522 442.21689 166.14334 462.95414 145.95898 462.19336 C 121.76352 471.47841 104.66936 448.36725 135.66211 444.07031 C 137.537 443.04316 139.46488 442.56946 141.35742 442.52539 z M 263.73242 443.12109 C 277.19347 442.15213 282.34051 468.51692 262.22656 462.17383 L 261.14258 462.19141 C 238.2028 472.70994 231.45057 437.16585 257.50391 445.38477 C 259.71688 443.95564 261.80941 443.25952 263.73242 443.12109 z M 379.1582 443.6582 C 388.70431 443.42939 397.27041 447.13603 395.02344 458.26562 C 386.99499 462.49158 377.5563 462.2952 368.7793 461.44922 C 344.61406 455.35156 363.24802 444.03956 379.1582 443.6582 z M 319.95703 443.70898 C 329.25388 443.54534 337.67159 447.22686 336.33203 457.82812 C 328.18613 464.52763 316.89905 461.83691 307.25195 462.34961 C 286.52546 454.93748 304.46229 443.98172 319.95703 443.70898 z " transform="matrix(0.94486174,0,0,0.94486174,-640.78767,-451.00312)" /> <ellipse cx="-202.56619" cy="-210.81996" rx="27.581959" ry="26.432711" /> <path d="m -273.24879,-343.55709 c 13.57934,10.94417 4.11256,28.6271 3.41272,42.97431 -10.35834,67.32918 -20.71667,134.65835 -31.07501,201.987523 -3.43922,19.509709 -24.89016,15.261767 -37.40273,7.947861 -17.40404,-7.232275 -34.80807,-14.464554 -52.21211,-21.696824 -14.03121,14.463338 -26.74618,30.398355 -41.64405,43.894173 -18.22479,9.955603 -29.72162,-11.436298 -26.27918,-27.030747 0.34571,-12.376906 -0.72391,-24.885926 0.5957,-37.171936 27.04118,-31.56409 56.15653,-61.55691 84.00114,-92.51238 11.76322,-6.14486 16.85643,-30.97909 -2.7603,-22.80647 -37.13867,32.99389 -74.27734,65.98779 -111.41601,98.98168 -17.34792,-9.11662 -35.49459,-16.87377 -52.30927,-26.89798 -15.32278,-14.96944 2.6642,-30.2801 16.70772,-36.00336 77.25242,-44.14424 154.50483,-88.28848 231.75725,-132.43272 5.69186,-3.32683 13.22323,-3.00646 18.62413,0.76687 z" /> </g> </svg>


<svg id="scan-icon" onclick="event.stopPropagation();scanAndSign()"  xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path fill="currentColor" d="M0 80C0 53.5 21.5 32 48 32l96 0c26.5 0 48 21.5 48 48l0 96c0 26.5-21.5 48-48 48l-96 0c-26.5 0-48-21.5-48-48L0 80zM64 96l0 64 64 0 0-64L64 96zM0 336c0-26.5 21.5-48 48-48l96 0c26.5 0 48 21.5 48 48l0 96c0 26.5-21.5 48-48 48l-96 0c-26.5 0-48-21.5-48-48l0-96zm64 16l0 64 64 0 0-64-64 0zM304 32l96 0c26.5 0 48 21.5 48 48l0 96c0 26.5-21.5 48-48 48l-96 0c-26.5 0-48-21.5-48-48l0-96c0-26.5 21.5-48 48-48zm80 64l-64 0 0 64 64 0 0-64zM256 304c0-8.8 7.2-16 16-16l64 0c8.8 0 16 7.2 16 16s7.2 16 16 16l32 0c8.8 0 16-7.2 16-16s7.2-16 16-16s16 7.2 16 16l0 96c0 8.8-7.2 16-16 16l-64 0c-8.8 0-16-7.2-16-16s-7.2-16-16-16s-16 7.2-16 16l0 64c0 8.8-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16l0-160zM368 480a16 16 0 1 1 0-32 16 16 0 1 1 0 32zm64 0a16 16 0 1 1 0-32 16 16 0 1 1 0 32z"/></svg>
			
<svg  onclick="event.stopPropagation();scanAndSign()"  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"  height="1em" > <path fill="currentColor"d="M64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-19.3c-2.7 1.1-5.4 2-8.2 2.7l-60.1 15c-3 .7-6 1.2-9 1.4c-.9 .1-1.8 .2-2.7 .2l-64 0c-6.1 0-11.6-3.4-14.3-8.8l-8.8-17.7c-1.7-3.4-5.1-5.5-8.8-5.5s-7.2 2.1-8.8 5.5l-8.8 17.7c-2.9 5.9-9.2 9.4-15.7 8.8s-12.1-5.1-13.9-11.3L144 381l-9.8 32.8c-6.1 20.3-24.8 34.2-46 34.2L80 448c-8.8 0-16-7.2-16-16s7.2-16 16-16l8.2 0c7.1 0 13.3-4.6 15.3-11.4l14.9-49.5c3.4-11.3 13.8-19.1 25.6-19.1s22.2 7.8 25.6 19.1l11.6 38.6c7.4-6.2 16.8-9.7 26.8-9.7c15.9 0 30.4 9 37.5 23.2l4.4 8.8 8.9 0c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7L384 203.6l0-43.6-128 0c-17.7 0-32-14.3-32-32L224 0 64 0zM256 0l0 128 128 0L256 0zM549.8 139.7c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM311.9 321c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L512.1 262.7l-71-71L311.9 321z"/></svg>

`;
console.log(`Your address: ${userAddress} `)
console.log(`Your did: ${did} `)
}

// <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path fill="currentColor"  d="M192 128c0-17.7 14.3-32 32-32s32 14.3 32 32l0 7.8c0 27.7-2.4 55.3-7.1 82.5l-84.4 25.3c-40.6 12.2-68.4 49.6-68.4 92l0 71.9c0 40 32.5 72.5 72.5 72.5c26 0 50-13.9 62.9-36.5l13.9-24.3c26.8-47 46.5-97.7 58.4-150.5l94.4-28.3-12.5 37.5c-3.3 9.8-1.6 20.5 4.4 28.8s15.7 13.3 26 13.3l128 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-83.6 0 18-53.9c3.8-11.3 .9-23.8-7.4-32.4s-20.7-11.8-32.2-8.4L316.4 198.1c2.4-20.7 3.6-41.4 3.6-62.3l0-7.8c0-53-43-96-96-96s-96 43-96 96l0 32c0 17.7 14.3 32 32 32s32-14.3 32-32l0-32zm-9.2 177l49-14.7c-10.4 33.8-24.5 66.4-42.1 97.2l-13.9 24.3c-1.5 2.6-4.3 4.3-7.4 4.3c-4.7 0-8.5-3.8-8.5-8.5l0-71.9c0-14.1 9.3-26.6 22.8-30.7zM24 368c-13.3 0-24 10.7-24 24s10.7 24 24 24l40.3 0c-.2-2.8-.3-5.6-.3-8.5L64 368l-40 0zm592 48c13.3 0 24-10.7 24-24s-10.7-24-24-24l-310.1 0c-6.7 16.3-14.2 32.3-22.3 48L616 416z"/></svg>

		/*********************************************************************************************
		.)  URL
		**********************************************************************************************/
		// Function to create URL parameters from an object
		function createURLParams(params) {
			console.log('createURLParams', params)

			const keys = Object.keys(params);
			const encodedParams = keys.map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`);
			return encodedParams.join('&');
		}

		/*********************************************************************************************
	.) QR SCAN
	**********************************************************************************************/
		async function scanAddress() {
			console.log('SCANNING FOR A NEW USER ADDRESS')

			Swal.close(); // Close the modal

			var audioContext = new AudioContext();

			// open modal
			openModalId('#scanModal')
			document.getElementById('scanResult').innerHTML = ''
			setTimeout(() => {
				var videoElem = document.getElementById("qrScanVideo");
				window.qrScanner = new QrScanner(videoElem, result => qrscanned(result), {
					highlightScanRegion: true,
					highlightCodeOutline: true,
				});

				qrScanner.setInversionMode('both');
				qrScanner.start();

			}, 1000);

		}

		async function qrscanned(result) {
			console.log('🔎 🔰 💬scanned decoded qr code:', result.data)
			x1 = result.data;
			document.getElementById('scanResult').innerHTML = ` <div class="success-message"> <svg viewBox="0 0 76 76" class="success-message__icon icon-checkmark"> <circle cx="38" cy="38" r="36"/> <path fill="none" stroke="#FFFFFF" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M17.7,40.9l10.9,10.9l28.7-28.7"/> </svg> <h1 class="success-message__title">SCANED!</h1> <div class="success-message__content"> <p>${result.data}</p> </div> </div> `
			qrScanner.stop();
			qrScanner.destroy();
			qrScanner = null;
			playQRscanned();
			await setTimeout(() => {
				closeModalId('#scanModal')
			}, 1500);
			// console.log('KEEP DOING SOMETHING', result.data)

			// SEARCH FOR chat
			const url = new URL(result.data);
			console.log('qr url:', url)
			const urlParams = new URLSearchParams(url.search);
			const chatValue = urlParams.get('chat');
			if (chatValue !== null) {
				console.log(`Value of chat parameter: ${chatValue}`);
				Toast.fire({ icon: 'info', title: 'ABOUT THIS CHAT:', text: chatValue });
				plToggle()
				let did; // Define did outside the conditional blocks
				let ethaddress;

				// CHECK THE URL TYPE (DID or address)
				if (chatValue.startsWith('did:ius:')) {//DID
					console.log('DID detected:', chatValue);
					ethaddress = chatValue.split(':').pop();

				} else if (/^0x[a-fA-F0-9]{40}$/.test(chatValue)) {//ETH ADDR
					console.log('Ethereum address detected:', chatValue);
					did = `did:ius:${chatValue}`
					address = chatValue; // Assuming chatValue is directly an Ethereum address

				}

				else {
					console.log('Unknown format or invalid input:', chatValue);
					did = chatValue
				}




				try {
					let didData = await fetchDID(did);
					console.log('didData', didData);
					if (didData && didData.data && didData.data.alias) {
						console.log('alias is not null', didData.data.alias);
					} else {
						console.log('User doesn\'t have a DID or alias is null');
					}
				} catch (error) {
					console.error('Error fetching DID data:', error);
					console.log('User doesn\'t have a DID or there was an error fetching the data');
				}


				let contact = { address: chatValue, username: null, avatar: null, did: did }
				console.log('🍧🍧🍧 SAVING NEW CONTACT TO LOCALSTORAGE', contact)
				SaveContactsToLocalStorage(contact);




				await chatWith(ethaddress)


			} else {
				console.log('chat parameter not found in the URL');
			}


		}




		async function selectChat(el) {
			console.warn('selectChat()')
			const address = el.dataset.address;
			console.log('CLICKED CONTACT (selectChat()):', address);
			var imgElement = el.querySelector("img");
			let imgSrc = imgElement.getAttribute("src");
			console.log('imgSrc: ', imgSrc.length)

			// 0- remove newmessage class
			document.getElementById(address).classList.remove('newmessage');

			// 1- close navbar
			plToggle()

			// 2- chat with address funciton 
			let currentChat = document.body.getAttribute('currentChat');
			console.warn('CURRENTCHAT', currentChat)

			// INTENTO FIX DUPLICA Y MULTIPLICA MENSAJES
			let alreadyChatting = (currentChat === address) ? true : false;
			if (alreadyChatting) {
				//  if alreadyChatting is true
				console.log('🤓 already chatting with this contact 🤓')
				openChat()
			} else {
				console.log('🤓 start chatting with new contact 🤓')
				// if not in contacts store it, else do nothing
				let contact = { address: el.dataset.address }
				SaveContactsToLocalStorage(contact);
				await chatWith(address)
				await updateBadge()

			}
		}


		document.getElementById("closeScanModal").onclick = () => {
			qrScanner.stop();
			closeModalId('#scanModal')
			qrScanner.destroy();
			qrScanner = null;

		}




		async function updateBadge() {
			// console.log('updateBadge()')
			var ulElement = document.getElementById('cwContacts');
			var newMessageElements = ulElement.getElementsByClassName('newmessage');
			var count = newMessageElements.length;
			if (count === 0) {
				// console.log('updateBadge(): No elements with class "newmessage" found.');
				document.getElementById('chatBadge').style.display = 'none'
				document.getElementById('chatBadge').innerText = ''
			} else {
				console.log('Number of elements with class "newmessage":', count);
				document.getElementById('chatBadge').style.display = 'inline'
				document.getElementById('chatBadge').innerText = `${count}`
			}

		}


		/*********************************************************************************************
		.) NEWQRCHAT
		**********************************************************************************************/
		async function createXMPTchat(signer) {
			console.log('createXMPTchat()')


			const iusnaturalisxmtp = await Client.create(signer)
			const conversations = iusnaturalisxmtp.conversations

			// get eth address for chat
			userAddress = signer.address;
			console.log('Your chat Address (eth) : ', userAddress)

			window.iusnaturalisxmtp = iusnaturalisxmtp;// make GLOBAL
			window.chats = iusnaturalisxmtp.conversations
			window.userAddress = userAddress

			return iusnaturalisxmtp
		}




		async function getChatAddresses() {
			const allConversations = await iusnaturalisxmtp.conversations.list()
			console.warn('🧸 🧸 🧸 YOU HAVE ', allConversations.length, "ADDRESSES AVAILABLE IN XMTP at getChatAddresses()")

			const peerAddressesArray = [];

			allConversations.forEach(async (conversation, index) => {
				peerAddressesArray.push(conversation.peerAddress);
				// console.log('allConversations foerEach')
				// ADD ADDRESS TO AGENDA IN UI
				// Here

			})
			paa = peerAddressesArray;
			console.log('🧶 🧶 🧶 peerAddressesArray(paa) DECLARED!', peerAddressesArray)

			// HOW MANY OF THEM ARE TRUSTED BY USER?

		}





		async function createGroupChat() {
			console.log('createGroupChat()')
			Swal.fire({
				icon: "error",
				title: "Oops...",
				text: "This is not yet implemented!",
				footer: '<a href="#">Why do I have this issue?</a>'
			});
		}



		// Initialize an empty list to store processed addresses
		let processedAddresses = [];

		// Function to create a new conversation if not already processed
		async function createConversation(toAddr) {
			if (!processedAddresses.includes(toAddr)) {
				// Address not yet processed, create a new conversation
				let conversation = await iusnaturalisxmtp.conversations.newConversation(toAddr);

				// Store the address in the list to prevent duplicate processing
				processedAddresses.push(toAddr);

				// Return the conversation or perform other actions as needed
				return conversation;
			} else {
				console.log(`Conversation with ${toAddr} already exists.`);
			}
		}


		// Initialize an empty Map to store addresses and their corresponding conversation instances
		let conversationsMap = new Map();
		cmap = conversationsMap
		// Function to get or create a conversation
		async function getOrCreateConversation(toAddr) {
			if (conversationsMap.has(toAddr)) {
				// Address already has a conversation, return the existing one
				return conversationsMap.get(toAddr);
			} else {
				// Address not found, create a new conversation
				let conversation = await iusnaturalisxmtp.conversations.newConversation(toAddr);

				// Store the new conversation in the Map
				conversationsMap.set(toAddr, conversation);

				// Return the new conversation
				return conversation;
			}
		}









		// ------------------------
		// NEW
		// 1111111111111111
		// Set to store addresses of active conversations
		// const activeChats = new Set();
		// achs = activeChats

		// OUTSIDE
		const activeChats = new Set();
		achs = activeChats

function preloadChatUI(toAddr){
	console.warn('preloadChatUI() LOADING PRECHAT UI')
	// <!-- EASY PRE LOAD UI CHAT WITH PEER -->


// let toAddr= '0x1234'
let avatar  = "./anonym.jpg";


chatAddress.innerHTML = `<div class="" id="peerAddr" data-address="${toAddr}" >
	<img src='${avatar}' alt="avatar" class="rounded rounded-circle img-thumbnail" width='40px' id='avatarImage'  onclick="event.stopPropagation();openCard('${toAddr}','${avatar}')">
	<strong onclick="event.stopPropagation();openCard('${toAddr}','${avatar}')">  (${toAddr.substring(38, 42)})</strong>
	</div>`;

 
actionButtons.innerHTML = `
<button type="button" id="peerSend" class="btn btn-approve item" style="display: none;"
onclick="event.stopPropagation(); openSend('${toAddr.toString()}')" >
<svg xmlns="http://www.w3.org/2000/svg" height="26" width="30" viewBox="0 0 512 512"> <defs > <clipPath clipPathUnits="userSpaceOnUse" > <rect width="106.35429" height="78.068573" x="9.0514288" y="187.25142" /> </clipPath> </defs> <g transform="matrix(1.0583559,0,0,1.0583559,678.18141,477.32181)"> <path fill="currentColor" d="M 122.34961 22.404297 C 102.90845 22.541942 83.4884 23.208407 64.123047 25.130859 C 32.005914 32.74301 13.633824 64.1977 0.21875 91.888672 C 0.59031759 190.50417 -1.4164071 289.14446 1.4707031 387.73828 C -3.2139611 442.01413 47.311879 490.4789 100.67578 488.32227 C 204.56767 490.26899 308.49622 489.76604 412.37695 487.41016 C 455.00842 491.66379 499.19766 461.88412 507.98047 419.36328 C 511.41267 368.1022 508.76569 316.55734 508.78125 265.18555 C 507.78692 215.81739 510.67596 166.53718 511.68359 117.21094 C 515.55612 76.22511 486.62687 34.631163 445.61328 27.0625 C 370.4731 21.75639 294.91505 23.445051 219.58984 22.759766 C 187.21286 23.414564 154.75154 22.174889 122.34961 22.404297 z M 201.33008 50.462891 C 212.79999 49.869523 223.82167 54.325756 218.06445 67.503906 C 209.21938 71.892696 199.05142 70.553919 189.57227 69.984375 C 171.09491 60.335654 186.58305 51.225791 201.33008 50.462891 z M 378.60742 50.566406 C 390.32146 49.91717 401.56028 54.29308 395.27734 67.503906 C 386.45439 71.191451 376.63239 70.842293 367.3125 69.888672 C 347.70261 60.542435 363.54651 51.401138 378.60742 50.566406 z M 322.3125 50.871094 C 331.96784 50.788552 340.38367 54.86352 337.62695 66.570312 C 330.16888 73.751755 318.8153 69.887874 309.69727 69.847656 C 286.68559 62.694044 306.22027 51.008663 322.3125 50.871094 z M 264.42578 50.941406 C 274.04887 51.473285 281.70092 56.245902 276.58398 68.197266 C 268.02568 71.247765 258.77202 70.661056 249.875 70.027344 C 226.87374 60.949739 248.38729 50.054941 264.42578 50.941406 z M 142.29883 51.388672 C 153.70762 50.793577 164.46957 55.141948 159.0625 68.197266 C 148.96874 70.847251 138.41711 70.813462 128.07422 70.197266 C 111.89302 61.089951 127.63038 52.153794 142.29883 51.388672 z M 77.707031 52.076172 C 92.665231 51.670858 108.69779 64.278245 87.421875 71.65625 C 80.094115 76.927688 59.493487 74.453071 61.580078 62.40625 C 64.330772 55.131697 70.90785 52.260405 77.707031 52.076172 z M 437.95117 52.96875 C 446.58069 53.499952 453.61391 57.964614 448.89453 69.212891 C 443.09003 74.370841 435.13393 71.031306 428.54102 69.896484 C 404.75443 62.12546 423.56864 52.083413 437.95117 52.96875 z M 467.25 80.292969 C 476.05807 81.586828 488.63451 99.731074 478.24023 109.76172 C 466.60642 116.16445 463.30811 98.48209 460.08594 91.316406 C 460.02046 82.597419 463.24633 79.704851 467.25 80.292969 z M 46.603516 86.378906 C 55.239528 88.381655 54.94777 115.64672 45.767578 124.4668 C 27.678762 132.02244 32.290326 103.51577 34.990234 94.416016 C 39.854266 87.850904 43.724845 85.711323 46.603516 86.378906 z M 475.48633 127.70508 C 482.88498 128.68897 484.4465 151.48356 480.40625 160.5957 C 466.82241 175.97111 460.27278 144.01616 466.13281 135.30664 C 469.90454 129.47352 473.02011 127.37711 475.48633 127.70508 z M 40.814453 145.95508 C 49.217435 147.73322 53.436635 176.59025 44.138672 185.625 C 25.792326 195.14735 31.36027 164.06133 31.361328 154.93945 C 34.746186 147.77739 38.013459 145.36236 40.814453 145.95508 z M 40.980469 208.54102 C 52.108736 209.14498 50.554573 235.88456 45.646484 247.69336 C 23.833505 257.07186 35.227386 222.776 31.134766 212.80273 C 35.168308 209.6538 38.412407 208.40164 40.980469 208.54102 z M 39.839844 272.02734 C 47.059432 271.21967 54.10366 277.1786 48.970703 290.89062 C 53.446289 317.27501 29.027322 321.93058 29.65625 293.76172 C 25.225649 280.40896 32.620256 272.83501 39.839844 272.02734 z M 41.21875 334.38086 C 52.218054 336.41594 49.773587 364.74996 44.185547 374.0332 C 22.790671 382.03895 32.805162 348.13594 31.330078 337.73047 C 35.426918 334.84191 38.680449 333.91123 41.21875 334.38086 z M 471.94531 344.46094 C 478.73409 344.06655 486.56003 350.35745 480.28711 360.78516 C 480.87081 383.10497 465.25145 377.82384 465.10938 358.71484 C 462.01336 349.11908 466.66515 344.76768 471.94531 344.46094 z M 470.67188 395.33984 C 478.65718 394.06626 486.55386 416.73373 475.44727 424.66406 C 464.24942 442.94477 451.89416 417.35385 463.35742 406.02734 C 465.33878 398.85039 468.01011 395.76437 470.67188 395.33984 z M 39.148438 396.43164 C 47.847352 396.03896 61.578726 413.3123 53.775391 426.22266 C 43.216724 433.89031 34.462757 418.70246 32.900391 409.98633 C 32.280075 400.43953 35.194385 396.61013 39.148438 396.43164 z M 434.27539 440.71289 C 446.12895 441.04492 455.68569 447.75243 440.74805 457.34375 C 433.99085 464.01104 415.7483 463.43418 412.89062 453.14844 C 414.44671 444.05227 425.05595 440.45464 434.27539 440.71289 z M 81.375 441.21289 C 91.803448 441.12577 102.40272 445.68911 97.503906 458.07031 C 90.667329 462.10042 82.378987 460.01552 75.302734 457.87891 C 54.842676 449.12311 67.966996 441.32491 81.375 441.21289 z M 198.75195 442.04102 C 213.4483 442.93836 227.47155 463.64651 203.53711 462.19922 C 187.4029 470.94821 164.91368 452.25832 188.92773 445.10156 C 191.93254 442.68284 195.36049 441.83394 198.75195 442.04102 z M 141.35742 442.52539 C 154.60522 442.21689 166.14334 462.95414 145.95898 462.19336 C 121.76352 471.47841 104.66936 448.36725 135.66211 444.07031 C 137.537 443.04316 139.46488 442.56946 141.35742 442.52539 z M 263.73242 443.12109 C 277.19347 442.15213 282.34051 468.51692 262.22656 462.17383 L 261.14258 462.19141 C 238.2028 472.70994 231.45057 437.16585 257.50391 445.38477 C 259.71688 443.95564 261.80941 443.25952 263.73242 443.12109 z M 379.1582 443.6582 C 388.70431 443.42939 397.27041 447.13603 395.02344 458.26562 C 386.99499 462.49158 377.5563 462.2952 368.7793 461.44922 C 344.61406 455.35156 363.24802 444.03956 379.1582 443.6582 z M 319.95703 443.70898 C 329.25388 443.54534 337.67159 447.22686 336.33203 457.82812 C 328.18613 464.52763 316.89905 461.83691 307.25195 462.34961 C 286.52546 454.93748 304.46229 443.98172 319.95703 443.70898 z " transform="matrix(0.94486174,0,0,0.94486174,-640.78767,-451.00312)" /> <ellipse cx="-202.56619" cy="-210.81996" rx="27.581959" ry="26.432711" /> <path d="m -273.24879,-343.55709 c 13.57934,10.94417 4.11256,28.6271 3.41272,42.97431 -10.35834,67.32918 -20.71667,134.65835 -31.07501,201.987523 -3.43922,19.509709 -24.89016,15.261767 -37.40273,7.947861 -17.40404,-7.232275 -34.80807,-14.464554 -52.21211,-21.696824 -14.03121,14.463338 -26.74618,30.398355 -41.64405,43.894173 -18.22479,9.955603 -29.72162,-11.436298 -26.27918,-27.030747 0.34571,-12.376906 -0.72391,-24.885926 0.5957,-37.171936 27.04118,-31.56409 56.15653,-61.55691 84.00114,-92.51238 11.76322,-6.14486 16.85643,-30.97909 -2.7603,-22.80647 -37.13867,32.99389 -74.27734,65.98779 -111.41601,98.98168 -17.34792,-9.11662 -35.49459,-16.87377 -52.30927,-26.89798 -15.32278,-14.96944 2.6642,-30.2801 16.70772,-36.00336 77.25242,-44.14424 154.50483,-88.28848 231.75725,-132.43272 5.69186,-3.32683 13.22323,-3.00646 18.62413,0.76687 z" /> </g> </svg>
<span>SEND</span>
</button>

<button type="button" id="peerReceive" class="btn btn-reject item" style="display: none;"
onclick="event.stopPropagation(); openReceive('${toAddr.toString()}')"  >


<svg xmlns="http://www.w3.org/2000/svg" height="26" width="30" viewBox="0 0 512 512">

  <defs
     >
    <clipPath
       clipPathUnits="userSpaceOnUse"
       >
      <rect
         width="106.35429"
         height="78.068573"
         x="9.0514288"
         y="187.25142" />
    </clipPath>
  </defs>
  <g
     transform="matrix(1.0583559,0,0,1.0583559,678.18141,477.32181)">
    <path
    fill="currentColor"
       transform="matrix(0.94486174,0,0,0.94486174,-640.78767,-451.00312)"
       d="M 122.34961,22.404297 C 102.90845,22.541942 83.4884,23.208407 64.123047,25.130859 32.005914,32.74301 13.633824,64.1977 0.21875,91.888672 0.59031759,190.50417 -1.4164071,289.14446 1.4707031,387.73828 -3.2139611,442.01413 47.311879,490.4789 100.67578,488.32227 c 103.89189,1.94672 207.82044,1.44377 311.70117,-0.91211 42.63147,4.25363 86.82071,-25.52604 95.60352,-68.04688 3.4322,-51.26108 0.78522,-102.80594 0.80078,-154.17773 -0.99433,-49.36816 1.89471,-98.64837 2.90234,-147.97461 C 515.55612,76.22511 486.62687,34.631163 445.61328,27.0625 370.4731,21.75639 294.91505,23.445051 219.58984,22.759766 c -32.37698,0.654798 -64.8383,-0.584877 -97.24023,-0.355469 z m 78.98047,28.058594 c 11.46991,-0.593368 22.49159,3.862865 16.73437,17.041015 -8.84507,4.38879 -19.01303,3.050013 -28.49218,2.480469 -18.47736,-9.648721 -2.98922,-18.758584 11.75781,-19.521484 z m 177.27734,0.103515 c 11.71404,-0.649236 22.95286,3.726674 16.66992,16.9375 -8.82295,3.687545 -18.64495,3.338387 -27.96484,2.384766 -19.60989,-9.346237 -3.76599,-18.487534 11.29492,-19.322266 z m -56.29492,0.304688 c 9.65534,-0.08254 18.07117,3.992426 15.31445,15.699218 -7.45807,7.181443 -18.81165,3.317562 -27.92968,3.277344 -23.01168,-7.153612 -3.477,-18.838993 12.61523,-18.976562 z m -57.88672,0.07031 c 9.62309,0.531879 17.27514,5.304496 12.1582,17.25586 -8.5583,3.050499 -17.81196,2.46379 -26.70898,1.830078 -23.00126,-9.077605 -1.48771,-19.972403 14.55078,-19.085938 z m -122.12695,0.447266 c 11.40879,-0.595095 22.17074,3.753276 16.76367,16.808594 -10.09376,2.649985 -20.64539,2.616196 -30.98828,2 -16.1812,-9.107315 -0.44384,-18.043472 14.22461,-18.808594 z m -64.591799,0.6875 c 14.9582,-0.405314 30.990759,12.202073 9.714844,19.580078 -7.32776,5.271438 -27.928388,2.796821 -25.841797,-9.25 2.750694,-7.274553 9.327772,-10.145845 16.126953,-10.330078 z M 437.95117,52.96875 c 8.62952,0.531202 15.66274,4.995864 10.94336,16.244141 -5.8045,5.15795 -13.7606,1.818415 -20.35351,0.683593 -23.78659,-7.771024 -4.97238,-17.813071 9.41015,-16.927734 z M 467.25,80.292969 c 8.80807,1.293859 21.38451,19.438105 10.99023,29.468751 -11.63381,6.40273 -14.93212,-11.27963 -18.15429,-18.445314 -0.0655,-8.718987 3.16039,-11.611555 7.16406,-11.023437 z M 46.603516,86.378906 c 8.636012,2.002749 8.344254,29.267814 -0.835938,38.087894 -18.088816,7.55564 -13.477252,-20.95103 -10.777344,-30.050784 4.864032,-6.565112 8.734611,-8.704693 11.613282,-8.03711 z M 475.48633,127.70508 c 7.39865,0.98389 8.96017,23.77848 4.91992,32.89062 -13.58384,15.37541 -20.13347,-16.57954 -14.27344,-25.28906 3.77173,-5.83312 6.8873,-7.92953 9.35352,-7.60156 z m -434.671877,18.25 c 8.402982,1.77814 12.622182,30.63517 3.324219,39.66992 -18.346346,9.52235 -12.778402,-21.56367 -12.777344,-30.68555 3.384858,-7.16206 6.652131,-9.57709 9.453125,-8.98437 z m 0.166016,62.58594 c 11.128267,0.60396 9.574104,27.34354 4.666015,39.15234 -21.812979,9.3785 -10.419098,-24.91736 -14.511718,-34.89063 4.033542,-3.14893 7.277641,-4.40109 9.845703,-4.26171 z m -1.140625,63.48632 c 7.219588,-0.80767 14.263816,5.15126 9.130859,18.86328 4.475586,26.38439 -19.943381,31.03996 -19.314453,2.8711 -4.430601,-13.35276 2.964006,-20.92671 10.183594,-21.73438 z m 1.378906,62.35352 c 10.999304,2.03508 8.554837,30.3691 2.966797,39.65234 -21.394876,8.00575 -11.380385,-25.89726 -12.855469,-36.30273 4.09684,-2.88856 7.350371,-3.81924 9.888672,-3.34961 z m 430.72656,10.08008 c 6.78878,-0.39439 14.61472,5.89651 8.3418,16.32422 0.5837,22.31981 -15.03566,17.03868 -15.17773,-2.07032 -3.09602,-9.59576 1.55577,-13.94716 6.83593,-14.2539 z m -1.27343,50.8789 c 7.9853,-1.27358 15.88198,21.39389 4.77539,29.32422 -11.19785,18.28071 -23.55311,-7.31021 -12.08985,-18.63672 1.98136,-7.17695 4.65269,-10.26297 7.31446,-10.6875 z m -431.523442,1.0918 c 8.698914,-0.39268 22.430288,16.88066 14.626953,29.79102 -10.558667,7.66765 -19.312634,-7.5202 -20.875,-16.23633 -0.620316,-9.5468 2.293994,-13.3762 6.248047,-13.55469 z m 395.126952,44.28125 c 11.85356,0.33203 21.4103,7.03954 6.47266,16.63086 -6.7572,6.66729 -24.99975,6.09043 -27.85743,-4.19531 1.55609,-9.09617 12.16533,-12.6938 21.38477,-12.43555 z m -352.90039,0.5 c 10.428448,-0.0871 21.02772,4.47622 16.128906,16.85742 -6.836577,4.03011 -15.124919,1.94521 -22.201172,-0.1914 -20.460058,-8.7558 -7.335738,-16.554 6.072266,-16.66602 z m 117.37695,0.82813 c 14.69635,0.89734 28.7196,21.60549 4.78516,20.1582 -16.13421,8.74899 -38.62343,-9.9409 -14.60938,-17.09766 3.00481,-2.41872 6.43276,-3.26762 9.82422,-3.06054 z m -57.39453,0.48437 c 13.2478,-0.3085 24.78592,20.42875 4.60156,19.66797 -24.19546,9.28505 -41.28962,-13.82611 -10.29687,-18.12305 1.87489,-1.02715 3.80277,-1.50085 5.69531,-1.54492 z m 122.375,0.5957 c 13.46105,-0.96896 18.60809,25.39583 -1.50586,19.05274 l -1.08398,0.0176 c -22.93978,10.51853 -29.69201,-25.02556 -3.63867,-16.80664 2.21297,-1.42913 4.3055,-2.12525 6.22851,-2.26368 z m 115.42578,0.53711 c 9.54611,-0.22881 18.11221,3.47783 15.86524,14.60742 -8.02845,4.22596 -17.46714,4.02958 -26.24414,3.1836 -24.16524,-6.09766 -5.53128,-17.40966 10.3789,-17.79102 z m -59.20117,0.0508 c 9.29685,-0.16364 17.71456,3.51788 16.375,14.11914 -8.1459,6.69951 -19.43298,4.00879 -29.08008,4.52149 -20.72649,-7.41213 -2.78966,-18.36789 12.70508,-18.64063 z" />
    <ellipse
       cx="-202.56619"
       cy="-210.81996"
       rx="27.581959"
       ry="26.432711" />
    <path
       d="m -273.5957,-76.572091 c -12.74642,11.903856 -28.92098,0.0427 -43.02695,-2.669356 -65.20124,-19.73106 -130.40236,-39.462213 -195.60342,-59.193613 -18.83158,-6.15078 -11.60698,-26.7902 -2.60488,-38.14888 9.60987,-16.21296 19.2194,-32.42599 28.82916,-48.63894 -12.34463,-15.92709 -26.33158,-30.75826 -37.59644,-47.40719 -7.29163,-19.4445 15.50515,-27.81638 30.46018,-22.21328 12.20509,2.08401 24.74016,2.78564 36.71823,5.82113 27.44416,31.2144 53.04076,64.26098 79.76943,96.18514 4.42812,12.51097 28.29834,21.04862 22.96785,0.47689 -27.43862,-41.41247 -54.87721,-82.82506 -82.31598,-124.2376 11.46735,-15.89216 21.70134,-32.76651 33.99218,-48.00304 16.97706,-13.06342 29.60375,6.89936 33.2937,21.60852 32.83239,82.69634 65.66488,165.39256 98.49729,248.088889 2.49255,6.103429 1.11559,13.514761 -3.3804,18.33088 z"
        />
  </g>
</svg>


<span>RECEIVE</span>
</button>

<button id="btn-search-close" class="btn  item" aria-label="Close search form"
onclick="event.stopPropagation(); deleteChat('${toAddr.toString()}')">
<svg class="icon icon--cross">
	<use xlink:href="#icon-cross"></use>
</svg>
</button>
`


peerSend.style.display = 'inline';
peerReceive.style.display = 'inline'
// peerSend.disabled = false;
// peerReceive.disabled = false;

document.getElementById("chatBox").innerHTML = '';//clear chat window

// --------
// document.getElementById("chatBox").innerHTML = `
//   <div class="loader-banner">
//     <div class="spinner"></div>
//     <p>Loading chat history...</p>
//   </div>
// `;



// --------



headerNotes.innerHTML = ``

}

		async function chatWith(toAddr, imgsrc) {
			console.log('chatWith(): ESTABLISHING NEW CHAT WITH', toAddr)
			preloadChatUI(toAddr)
			headerNotes.innerHTML = ``
			
			// document.getElementById("chatBox").innerHTML = '';//clear chat window
// --------
document.getElementById("chatBox").innerHTML = `
  <div class="loader-banner">
    <div class="spinner"></div>
    <p>Loading chat history...</p>
  </div>
`;



// --------
			
			console.log('clear chatBox window')
			let userAddress = document.getElementById('yourAddress').getAttribute('address');

			console.log(toAddr, userAddress)
			if (toAddr == userAddress) {
				console.warn('CANCELING chatwith() because CANNOT WITH SELF ADDRESS')
				Toast.fire('CANNOT CHAT WITH SELF ADDRESS', '', "warning");
				localStorage.removeItem('toAddress')// detele "TO" address from localStorage
				return
			}

			superToast.fire({ icon: 'success', title: '💬 CHAT WITH:', position: 'center', text: toAddr });



			// // ----------------------------------------------------
			// GOT TO CHAT TAB
			console.log(' doing openChat')
			openChat()
			console.warn('------- PREPARING CHAT ----------');
			localStorage.setItem('toAddress', toAddr)
			updateBadge()
			let shortAddr = toAddr.substring(0, 6) + "..." + toAddr.substring(38, 42);

			if (imgsrc != null) {
				try {
					new URL(imgsrc);
					console.log('YES IMAGE SOURCE: Valid URL');
					avatar = imgsrc;  // Assign if valid
				} catch (e) {
					console.log('Invalid image source URL', imgsrc);
					avatar = 'anonym.jpg';  // Use a default image if invalid
				}

			} else {

			 
				let did = toAddr.startsWith("did:ius:") ? toAddr : `did:ius:${toAddr}`;

				console.log('💝💝💝💝💝',did); // Outputs the DID with the correct prefix

				const didresult = await readDIDRecord(did);
				const avtr = didresult.data.avatar;
				const alias = didresult.data.alias;  // Check for alias

				if (avtr && avtr.trim() !== '') {
					console.log('Avatar found in DID record');
					avatar = JSON.parse(avtr);
				} else {
					console.log('NO IMAGE SOURCE or AVATAR data is empty');
					avatar = "./anonym.jpg";
				}

				// Check for alias
				if (alias && alias.trim() !== '') {
					console.log(`Alias found: ${alias}🥪🥪`);

					// check alias is not an address(if address shorten it)
					if (isNotEthereumAddress(alias)) {
						console.log("🥕🥕This is not an Ethereum address.", alias);
						shortAddr = alias
					} else {
						console.log("🥦🥦This is a valid Ethereum address.", alias);
					}

				} else {
					console.log('No alias found 🍿🍿');
					shortAddr = toAddr.substring(0, 6) + "..." + toAddr.substring(38, 42);

				}
			}
		// fin else

			// ADD ADDRESS IN UI
			let htmlData = `<address>${toAddr} <svg   onclick="event.stopPropagation();customcopy2clipboard('${toAddr}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z" ></path></svg> </address><br><p>no info available</p>`;
			chatAddress.innerHTML = `<div class="" id="peerAddr" data-address="${toAddr}" >
			<img src='${avatar}' alt="avatar" class="rounded rounded-circle img-thumbnail" width='40px' id='avatarImage'  onclick="event.stopPropagation();openCard('${toAddr}','${avatar}')">
			<strong onclick="event.stopPropagation();openCard('${toAddr}','${avatar}')">${shortAddr}(${toAddr.substring(38, 42)})</strong>
			</div>`;




			// -------------------
			// just dont update ui....
		// 	actionButtons.innerHTML = `
        //         <button type="button" id="peerSend" class="btn btn-approve item" style="display: none;"
        // onclick="event.stopPropagation(); openSend('${toAddr.toString()}')" >
		// <svg xmlns="http://www.w3.org/2000/svg"    height="16" width="20" viewBox="0 0 512 512">
		// 	<path fill="currentColor" d="M512 80c0 18-14.3 34.6-38.4 48c-29.1 16.1-72.5 27.5-122.3 30.9c-3.7-1.8-7.4-3.5-11.3-5C300.6 137.4 248.2 128 192 128c-8.3 0-16.4 .2-24.5 .6l-1.1-.6C142.3 114.6 128 98 128 80c0-44.2 86-80 192-80S512 35.8 512 80zM160.7 161.1c10.2-.7 20.7-1.1 31.3-1.1c62.2 0 117.4 12.3 152.5 31.4C369.3 204.9 384 221.7 384 240c0 4-.7 7.9-2.1 11.7c-4.6 13.2-17 25.3-35 35.5c0 0 0 0 0 0c-.1 .1-.3 .1-.4 .2c0 0 0 0 0 0s0 0 0 0c-.3 .2-.6 .3-.9 .5c-35 19.4-90.8 32-153.6 32c-59.6 0-112.9-11.3-148.2-29.1c-1.9-.9-3.7-1.9-5.5-2.9C14.3 274.6 0 258 0 240c0-34.8 53.4-64.5 128-75.4c10.5-1.5 21.4-2.7 32.7-3.5zM416 240c0-21.9-10.6-39.9-24.1-53.4c28.3-4.4 54.2-11.4 76.2-20.5c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 19.3-16.5 37.1-43.8 50.9c-14.6 7.4-32.4 13.7-52.4 18.5c.1-1.8 .2-3.5 .2-5.3zm-32 96c0 18-14.3 34.6-38.4 48c-1.8 1-3.6 1.9-5.5 2.9C304.9 404.7 251.6 416 192 416c-62.8 0-118.6-12.6-153.6-32C14.3 370.6 0 354 0 336l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 342.6 135.8 352 192 352s108.6-9.4 148.1-25.9c7.8-3.2 15.3-6.9 22.4-10.9c6.1-3.4 11.8-7.2 17.2-11.2c1.5-1.1 2.9-2.3 4.3-3.4l0 3.4 0 5.7 0 26.3zm32 0l0-32 0-25.9c19-4.2 36.5-9.5 52.1-16c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 10.5-5 21-14.9 30.9c-16.3 16.3-45 29.7-81.3 38.4c.1-1.7 .2-3.5 .2-5.3zM192 448c56.2 0 108.6-9.4 148.1-25.9c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 44.2-86 80-192 80S0 476.2 0 432l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 438.6 135.8 448 192 448z"/>
		// 	</svg>

        // <svg xmlns="http://www.w3.org/2000/svg" height="16" width="20" viewBox="0 0 512 512">
        //     <path fill="currentColor"
        //         d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480V396.4c0-4 1.5-7.8 4.2-10.7L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/>
        // </svg>
        // <span>SEND</span>
		// </button>

		// <button type="button" id="peerReceive" class="btn btn-reject item" style="display: none;"
		// 		onclick="event.stopPropagation(); openReceive('${toAddr.toString()}')"  >
		// 		<svg xmlns="http://www.w3.org/2000/svg"    height="16" width="20" viewBox="0 0 512 512">
		// 	<path fill="currentColor" d="M512 80c0 18-14.3 34.6-38.4 48c-29.1 16.1-72.5 27.5-122.3 30.9c-3.7-1.8-7.4-3.5-11.3-5C300.6 137.4 248.2 128 192 128c-8.3 0-16.4 .2-24.5 .6l-1.1-.6C142.3 114.6 128 98 128 80c0-44.2 86-80 192-80S512 35.8 512 80zM160.7 161.1c10.2-.7 20.7-1.1 31.3-1.1c62.2 0 117.4 12.3 152.5 31.4C369.3 204.9 384 221.7 384 240c0 4-.7 7.9-2.1 11.7c-4.6 13.2-17 25.3-35 35.5c0 0 0 0 0 0c-.1 .1-.3 .1-.4 .2c0 0 0 0 0 0s0 0 0 0c-.3 .2-.6 .3-.9 .5c-35 19.4-90.8 32-153.6 32c-59.6 0-112.9-11.3-148.2-29.1c-1.9-.9-3.7-1.9-5.5-2.9C14.3 274.6 0 258 0 240c0-34.8 53.4-64.5 128-75.4c10.5-1.5 21.4-2.7 32.7-3.5zM416 240c0-21.9-10.6-39.9-24.1-53.4c28.3-4.4 54.2-11.4 76.2-20.5c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 19.3-16.5 37.1-43.8 50.9c-14.6 7.4-32.4 13.7-52.4 18.5c.1-1.8 .2-3.5 .2-5.3zm-32 96c0 18-14.3 34.6-38.4 48c-1.8 1-3.6 1.9-5.5 2.9C304.9 404.7 251.6 416 192 416c-62.8 0-118.6-12.6-153.6-32C14.3 370.6 0 354 0 336l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 342.6 135.8 352 192 352s108.6-9.4 148.1-25.9c7.8-3.2 15.3-6.9 22.4-10.9c6.1-3.4 11.8-7.2 17.2-11.2c1.5-1.1 2.9-2.3 4.3-3.4l0 3.4 0 5.7 0 26.3zm32 0l0-32 0-25.9c19-4.2 36.5-9.5 52.1-16c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 10.5-5 21-14.9 30.9c-16.3 16.3-45 29.7-81.3 38.4c.1-1.7 .2-3.5 .2-5.3zM192 448c56.2 0 108.6-9.4 148.1-25.9c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 44.2-86 80-192 80S0 476.2 0 432l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 438.6 135.8 448 192 448z"/>
		// 	</svg>
		// 		<svg height="16" width="20" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">
		// 			<path fill="currentColor"
		// 				d="m 506.43491,498.16358 c -7,10.1 -19.1,15.4 -31.2,13.5 l -416.000001,-64 c -9.7,-1.5 -18.2,-7.4 -23,-16 -4.8,-8.6 -5.4,-18.9 -1.6,-28 l 49.7,-119.6 -74.1,-68.5 c -9.70000029,-8.9 -12.9000003,-22.9 -8.1000003,-35.2 4.8,-12.3 16.7000003,-20.3 29.9000003,-20.3 h 83.600001 c 4,0 7.8,1.5 10.7,4.2 l 182.9,167.6 c 6.3,5.8 16,5.6 22,-0.4 6,-6 6.4,-15.7 0.7,-22 l -180.7,-203.4 44.2,-88.300001 c 5.3,-10.5999996 15.9,-17.39999965 27.7,-17.69999965 11.8,-0.3 22.8,5.90000005 28.7,16.09999965 l 256,448.000001 c 6.1,10.7 5.5,23.9 -1.4,34 z"/>
		// 		</svg>
		// 		<span>RECEIVE</span>
		// </button>

		// <button id="btn-search-close" class="btn  item" aria-label="Close search form"
		// 		onclick="event.stopPropagation(); deleteChat('${toAddr.toString()}')">
		// 		<svg class="icon icon--cross">
		// 			<use xlink:href="#icon-cross"></use>
		// 		</svg>
		// </button>
		// `


			// activate buttons
			peerSend.style.display = 'inline';
			peerReceive.style.display = 'inline'
			
			peerSend.disabled = false;
			peerReceive.disabled = false;

			// ------------------------------------
			// AVOID REOPENING COMS WITH ADDRESESS
			// SACAR/ si lo saco falla...
			const allConversations = await iusnaturalisxmtp.conversations.list()
			console.log('available addresses:', allConversations.length)
			const customAddressToCheck = toAddr; // Replace this with the address you want to check
			let addressExists = false;
			for (const conversation of allConversations) {
				if (conversation.peerAddress === customAddressToCheck) {
					addressExists = true;
					cc = conversation
					break; // Exit the loop early if the address is found
				}
			}



			if (addressExists) {
				console.warn(`YOU DO HAVE A CHAT HISTORY WITH ${customAddressToCheck} `);
				console.log('USER: ', userAddress)

				// document.getElementById("chatBox").innerHTML = `
				// <div class="loader-banner">
				// 	<div class="spinner"></div>
				// 	<p>Loading chat history...</p>
				// </div>
				// `;



				let h = await cc.messages()

				document.getElementById("chatBox").innerHTML = ``

				// CREATE THIS FUNCTON ==> loadChatHistory(h)
				for (let i = 0; i < h.length; i++) {

					if (h[i].senderAddress === userAddress) {
						let timestamp = simplifyDate(h[i].sent)
						document.getElementById('chatBox').innerHTML += `<div><strong class='who'>You:</strong> ${h[i].content}<span class="timestamp">  ${timestamp} &check; </span></div>`;

					} else {
						let timestamp = simplifyDate(h[i].sent)

						// 01010101001010101001010101010101010010101010101010
						// DIsplay saved name , if not set display shortAddr
						// 01010101001010101001010101010101010010101010101010
						let shortAddr = h[i].senderAddress.substring(38, 42);

						document.getElementById('chatBox').innerHTML += `<div><strong class='who notyou'>${shortAddr}:</strong> ${h[i].content}<span class="timestamp">  ${timestamp} &check; </span></div>`;
					}

				}


				console.log('history:', h.length)
				hhh = h.lengh



			} else {
				console.warn(`YOU DONT HAVE A CHAT HISTORY WITH ${customAddressToCheck} `);

				document.getElementById("chatBox").innerHTML = `
				<div class="loader-banner">
					<p>YOU DONT HAVE A CHAT HISTORY WITH ${customAddressToCheck}.</p>
					<p>Send a message!</p>
				</div>
				`;
			}
			// FIN AVOID REOPENING COMS WITH ADDRESESS
			// ------------------------------------

			// CREATE CHAT (client was already created)
			// 12312312312312312312312312312
			// AQUI EVITAR DUPLICADOS
			// 12312312312312312312312312312



			// 13123123123123123123123123123123
			// CAN CHAT?
			const isOnProdNetwork = await iusnaturalisxmtp.canMessage(toAddr);
			console.log("Can message?: " + isOnProdNetwork);






			// ----------------------------------------------------
			// Check if the chat is already being listened to
			if (activeChats.has(toAddr)) {
				// console.log(`📣📣📣 Already chating with toAddrsenderAddress}`);
				console.warn('------- READY TO CHAT 💬 ----------');


				// CHANGE STATUS LIGHT:
				document.getElementById('singleChatlightButton').style.backgroundColor = 'yellow'
				// document.getElementById('lightButton').innerHTML= '🟢'


				// ADD ATTRIBUTE TO BODY(fix dup messg)
				document.body.setAttribute('currentChat', toAddr);

				// ACTIVATE CHAT BUTTONS
				document.getElementById('chatTextInput').disabled = false;
				document.getElementById('send-button').disabled = false;
				document.getElementById('chatTextInput').focus();


			} else {
				// Start listening to the conversation
				activeChats.add(toAddr);

				console.warn(' 📛 📛 CREATE CHAT (client was already created)')
				conversation = await iusnaturalisxmtp.conversations.newConversation(toAddr)
				console.log('conversation:', conversation)
				console.log(`💖 💌 Started new conversation with ${toAddr}`);


				// ----------------------------------------------------


				console.warn('------- READY TO CHAT 💬 ----------');
				document.getElementById('singleChatlightButton').style.backgroundColor = 'green'

				// ADD ATTRIBUTE TO BODY(fix dup messg)
				document.body.setAttribute('currentChat', toAddr);

				// ACTIVATE CHAT BUTTONS
				document.getElementById('chatTextInput').disabled = false;
				document.getElementById('send-button').disabled = false;
				document.getElementById('chatTextInput').focus();
				// -----------


				var chatBox = document.getElementById("chatBox");
				let shortTo = toAddr.substring(38, 42);

				// Listen for new messages in the conversation
				for await (const message of await conversation.streamMessages()) {
					const now = new Date();
					const hours = now.getHours().toString().padStart(2, '0'); // Ensure two-digit format
					const minutes = now.getMinutes().toString().padStart(2, '0'); // Ensure two-digit format
					const timestamp = `${hours}:${minutes}`;
					console.log('logMSG:', message)
					let preferedWallet = localStorage.getItem('preferedWallet');
					if (!preferedWallet) { console.log('NO PREFERED WALLET SET') }
					if (preferedWallet) { const values = preferedWallet.split(',').map(item => item.trim()); userAddress = values[1]; }
					if (message.senderAddress === userAddress) {
						console.log('YOU')
						chatBox.innerHTML += `<div><strong class='who'>You:</strong> ${message.content}<span class="timestamp">  ${timestamp} &check; </span></div>`;
					}
					if (message.senderAddress == toAddr) {
						console.log('OTHER', shortTo)
						mm = message;
						// let timestamp = message
						// chatBox.innerHTML += `<div><strong class='who'>${shortTo}:</strong> ${message.content} </div>`;
						document.getElementById('chatBox').innerHTML += `<div><strong class='who notyou'>${shortTo}:</strong> ${message.content}<span class="timestamp">  ${timestamp} &check; </span></div>`;


					}
					console.log(`[${message.senderAddress}]: ${message.content}`)
					chatBox.scrollTop = chatBox.scrollHeight;


					// if (message.contentType.sameAs(ContentTypeMultiplyNumber)) {
					// 	return message.content; // 21
					// }
				}


			}





		}


		// NE MANAGEMENT INTENT
		let activeListeners = {};
		AL = activeListeners
		async function startConversation(contactAddress) {
			// Check if the listener for this contact already exists
			if (activeListeners[contactAddress]) {
				console.log('Listener already active for this conversation');
				return; // Do not create a new listener
			}

			try {
				// Start the new conversation
				const conversation = await xmtpClient.conversations.newConversation(contactAddress);

				// Set up the listener for this conversation
				const stream = await conversation.streamMessages();

				// Store the listener reference
				activeListeners[contactAddress] = stream;

				// Process messages
				for await (const message of stream) {
					console.log('New message:', message.content);
					// Handle the incoming message
				}

			} catch (error) {
				console.error('Error starting conversation:', error);
			}
		}

		function closeConversation(contactAddress) {
			// Cleanup the listener if it exists
			if (activeListeners[contactAddress]) {
				activeListeners[contactAddress].close(); // Close the message stream
				delete activeListeners[contactAddress]; // Remove from active listeners
			}
		}




		/*********************************************************************************************
		.) CONTACTS MANAGEMENT
		**********************************************************************************************/


		async function addUnknownContact(addr, msg) {
			console.warn('👤 addUnknownContact()', addr, msg)

			// add unknown contact to  localstorage and check each time against the list if we add it or not into the contacts tab
			let shortAddr = addr.substring(0, 6) + "..." + addr.substring(38, 42);
			let shortMsg = msg.substring(0, 16);


			let unknownContacts = JSON.parse(localStorage.getItem('unknowncontacts')) || [];
			a = addr
			var index = unknownContacts.findIndex(existingUnknownContacts => existingUnknownContacts === addr);

			if (index === -1) {
				console.log('PUSH UnknownContact to localstorage')
				unknownContacts.push(addr);

				document.getElementById('cwContacts').innerHTML += `
					<li data-address="${addr}"  id="${addr}" class='newmessage'> 
						<a onclick="event.stopPropagation();selectChat((this.parentElement))" >  
							<img src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
								<span>${shortMsg} <span>
									
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"width="18" height="16" >
										<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"/></svg>
										
										
										</a> 
										</li> `
				// <i class="fa-solid fa-trash"></i>

			} else {
				console.log('OVERWRITE ALREADY EXISTENT  UnknownContact!.');

				// Search for the element with the specified ID
				var elementToModify = document.getElementById(addr);

				// Check if the element exists
				if (elementToModify) {
					// Add a new class to the element
					elementToModify.classList.add('newmessage');
					elementToModify.querySelector("span").innerText = shortMsg

				} else {
					// If the element with the specified ID is not found, you may want to handle that case
					console.warn("Element with ID '" + addr + "' not found");
					document.getElementById('cwContacts').innerHTML += ` 
					<li data-address="${addr}" id="${addr}"  class='newmessage'> 
					<a onclick="event.stopPropagation();selectChat((this.parentElement))" >  
						<img src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
						<span>${shortMsg} <span>
							</a> </li> `
					// <i class="fa-solid fa-trash"></i>
				}


			}

			// CAMBIAR POR SaveContactsToLocalStorage??
			localStorage.setItem('unknowncontacts', JSON.stringify(unknownContacts));


		}

		async function addknownContact(addr, msg) {
			console.log('addknownContact()', addr, msg)

			let shortAddr = addr.substring(0, 6) + "..." + addr.substring(38, 42);
			let shortMsg = msg.substring(0, 16);
			var elementToModify = document.getElementById(addr);
			if (elementToModify) {
				elementToModify.classList.add('newmessage');
				elementToModify.querySelector("span").innerText = shortMsg
			}
			else {
				// NUEVO!
				document.getElementById('cwContacts').innerHTML += ` 
					<li data-address="${addr}" id="${addr}"  class='newmessage'> 
					<a onclick="event.stopPropagation();selectChat((this.parentElement))" >  
						<img src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
						<span>${shortMsg} <span>
							</a> </li> `
			}


		}


		async function loadHistory() {
			console.log('loadHistory()')

			// 1 check ist not in your agenda

			let chatList = await iusnaturalisxmtp.conversations.list()
			// c = chatList;
			let chatLength = chatList.length;
			console.log(chatLength, "addresses in history.")

			// Using a for loop
			for (let i = 0; i < chatLength; i++) {
				addHistoryContact(chatList[i].peerAddress, chatList[i].createdAt.toString())

			}


		}

		function isNotEthereumAddress(alias) {
			return !ethers.isAddress(alias); // Returns true if alias is NOT a valid Ethereum address
		}

// --------------------------------
// BACKUP CONTACTS IN POLYBASE
// --------------------------------
async function backupContactsToPolybase() {
			console.log('backupContactsToPolybase()')
			// let contct = document.getElementById('cwContacts')
			// contct.innerHTML = ''
			// let cwContacts = JSON.parse(window.localStorage.getItem('contacts'));
			let contactsToBackup = JSON.parse(window.localStorage.getItem('contacts'));

			if (!contactsToBackup) {
				console.log('YOU HAVE', 0, 'CONTACTS to backup in polybase')
			}
			if (contactsToBackup) {
				console.warn('🏄‍♀️🏄‍♀️🏄‍♀️ YOU HAVE', contactsToBackup.length, 'CONTACTS to backup in polybase')


				const promises = [];
				contactsToBackup.forEach((el, index) => {

					// NAME
					// username or contactname?
					if (el.contactname) {
						contactInfo = `<span>${el.contactname} <span>`;
						console.log('✅ contactname: ', el.contactname);
					} else if (el.username) {
						contactInfo = `<span>${el.username} <span>`;
						console.log('✅ username: ', el.username);
					} else {
						console.log('❌ No username or contactname: ', el);
						let shortAddr = `${el.address.substring(0, 6)}...${el.address.substring(38, 42)}`;
						contactInfo = `<span>${shortAddr} <span>`;
					}
						
				})
			}

		}


// --------------------------------
		async function loadContactsFromLocalstorage() {
			console.log('loadContactsFromLocalstorage()')
			let contct = document.getElementById('cwContacts')
			contct.innerHTML = ''
			let cwContacts = JSON.parse(window.localStorage.getItem('contacts'));
			if (!cwContacts) {
				console.log('YOU HAVE', 0, 'CONTACTS in LOCALSTORAGE at loadContactsFromLocalstorage()')
				console.warn('CHECK DID???')

			}
			if (cwContacts) {
				console.warn('🏄‍♀️🏄‍♀️🏄‍♀️ YOU HAVE', cwContacts.length, 'CONTACTS in LOCALSTORAGE at loadContactsFromLocalstorage()')

				cw=cwContacts;
				// contactname // username
				// contactname: set by user in their own agenda
				// username: set by owner in their own DID
				const promises = [];
				cwContacts.forEach((el, index) => {

					// NAME
					// username or contactname?
					if (el.contactname) {
						// If contactname exists, use it
						contactInfo = `<span>${el.contactname} <span>`;
						console.log('✅ contactname: ', el.contactname);
					} else if (el.username) {
						// If username exists but contactname is null or not present, use username
						contactInfo = `<span>${el.username} <span>`;
						console.log('✅ username: ', el.username);
					} else {
						// If both contactname and username are null/missing, fallback to a shortened address
						console.log('❌ No username or contactname: ', el);
						let shortAddr = `${el.address.substring(0, 6)}...${el.address.substring(38, 42)}`;
						contactInfo = `<span>${shortAddr} <span>`;
					}
						


					// AVATAR
					let avatar= "./anonym.jpg"
					if (el.avatar || null) {
						avatar = el.avatar
						console.log(' HAS AVATAR!',avatar);
					}

					// DID
					let did = el.address.startsWith("did:ius:") ? el.address : `did:ius:${el.address}`;


					// CREATE THE ELEMENT
					contct.innerHTML += `<li data-address="${el.address}" id="${el.address}" class=''> 
							<a onclick="event.stopPropagation();selectChat((this.parentElement))">  
								<img id ="${did}" src="${avatar}" alt="Avatar" class="rounded-circle"> 
									<span >${contactInfo}</span>
									<svg onclick="event.stopPropagation();editContact('${el.address}')" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="20" height="25" class='right'>
										<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"/>
										</svg>
										</a> 
										</li>`;

return


					// Add each asynchronous operation to the promises array
					promises.push(
						new Promise((resolve, reject) => {
							readDIDRecord(did)
								.then(didresult => {
									if (didresult.data != null) {
										console.log(did + ' HAS A RECORD ✅');

										let avtr = didresult.data.avatar;
										if (avtr) {
											// minifies the avatar before attachingi t into contacts in localstorage and then in did
											let preavatar = JSON.parse(avtr);
											resizeBase64Image(preavatar, 25, 25)
												.then((resizedAvatar) => {
													if (resizedAvatar) {
													console.log('Resized Avatar:✅✅✅', resizedAvatar);
													document.getElementById(did).src = resizedAvatar;

													x1 = didresult.data
													let thisAddr =  didresult.data.id.replace(/^did:ius:/, ""); // Remove the prefix if present
													console.warn('didresult.data.id???', thisAddr)

													// return
												updateAvatar(thisAddr, resizedAvatar)

													} else {
													console.error('Failed to resize avatar image.');
													}
												})
												.catch((error) => {
													console.error('Error resizing avatar image:', error);
												});

											// ----------------------------------

										} else {
											console.log('Avatar is empty 👀');
										}

										let alias = didresult.data.alias;  // Check for alias
										if (alias && alias.trim() !== '') {
											console.log(`🗽 Alias found in DID: ${alias}🥪🏁🥪`);

											if (isNotEthereumAddress(alias)) {
												console.log("🥐🥐🥐 This is not an Ethereum address: ", alias);
											} else {
												alias = shortAddressETH(alias)
												console.log(" 🍔🍔🍔 This is a valid Ethereum address: ", alias);
											}

											document.getElementById(el.address).querySelector('a span span').innerHTML = `<span class="custom-color">${alias}</span>
												<svg onclick="event.stopPropagation();editContact('${el.address}')" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="20" height="25" class='right'>
												<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"/>
											</svg>`;
										} else {
											console.log('No alias found 🍿🍿🍿');
										}

									} else {
										console.log(did + ' DOESN\'T HAVE A RECORD  📛 ');
									}
									resolve(); // Resolve the promise once the operation is done
								})
								.catch(error => {
									console.warn('🌰 Warn on DID record:', error);
									reject(error); // Reject the promise if an error occurs
								});
						})
					);

					contct.innerHTML += `<li data-address="${el.address}" id="${el.address}" class=''> 
							<a onclick="event.stopPropagation();selectChat((this.parentElement))">  
								<img id ="${did}" src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
									<span >${contactInfo}</span>
									<svg onclick="event.stopPropagation();editContact('${el.address}')" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="20" height="25" class='right'>
										<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"/>
										</svg>
										</a> 
										</li>`;
					});



			}



		
		}

		async function loadContacts() {
			console.log('loadContacts()')
			let contct = document.getElementById('cwContacts')
			contct.innerHTML = ''
			let cwContacts = JSON.parse(window.localStorage.getItem('contacts'));
			if (!cwContacts) {
				console.warn('YOU HAVE', 0, 'CONTACTS in LOCALSTORAGE at loadContacts()')

			}
			if (cwContacts) {
				console.warn('👨‍👩‍👦 👨‍👩‍👧 👨‍👩‍👧‍👦 YOU HAVE', cwContacts.length, 'CONTACTS in LOCALSTORAGE at loadContacts()')
				const promises = [];
				cwContacts.forEach((el, index) => {

					// ----------------------------
					// ALIAS OR USERNAME?
					// ALIAS: is a pseudime set by the contact book owner in his own list of contacts (contactName?)
					// USERNAME: is a pseudime set by the owner of the DID(onchain/ polybase) (username?)
					// ----------------------------
					if (el.username || null) {

						if (el.contactname || null) {
							// checkear aqui si hay un contactName
							contactInfo = `<span>${el.contactname} <span>`;
								console.log('✅ contactname: ',el.contactname);
						}

						else{
						// username is not null and contactname is null`
						contactInfo = `<span>${el.username} <span>`;
							console.log('✅ username: ',el.username);
						}

							
					} else {
						console.log('❌this ',el,'username is null');
						let shortAddr = el.address.substring(0, 6) + "..." + el.address.substring(38, 42);
						contactInfo = `<span>${shortAddr} <span>`;
					}



					let did = el.address.startsWith("did:ius:") ? el.address : `did:ius:${el.address}`;

					// Add each asynchronous operation to the promises array
					promises.push(
						new Promise((resolve, reject) => {
							readDIDRecord(did)
								.then(didresult => {
									if (didresult.data != null) {
										console.log(did + ' HAS A RECORD ✅');

										let avtr = didresult.data.avatar;
										if (avtr) {
											// minifies the avatar before attachingi t into contacts in localstorage and then in did
											let preavatar = JSON.parse(avtr);
											resizeBase64Image(preavatar, 25, 25)
												.then((resizedAvatar) => {
													if (resizedAvatar) {
													console.log('Resized Avatar:✅✅✅', resizedAvatar);
													document.getElementById(did).src = resizedAvatar;

													x1 = didresult.data
													let thisAddr =  didresult.data.id.replace(/^did:ius:/, ""); // Remove the prefix if present
													console.warn('didresult.data.id???', thisAddr)

													// return
												 updateAvatar(thisAddr, resizedAvatar)

													} else {
													console.error('Failed to resize avatar image.');
													}
												})
												.catch((error) => {
													console.error('Error resizing avatar image:', error);
												});

											// ----------------------------------

										} else {
											console.log('Avatar is empty 👀');
										}

										let alias = didresult.data.alias;  // Check for alias
										if (alias && alias.trim() !== '') {
											console.log(`🗽 Alias found in DID: ${alias}🥪🏁🥪`);

											if (isNotEthereumAddress(alias)) {
												console.log("🥐🥐🥐 This is not an Ethereum address: ", alias);
											} else {
												alias = shortAddressETH(alias)
												console.log(" 🍔🍔🍔 This is a valid Ethereum address: ", alias);
											}

											document.getElementById(el.address).querySelector('a span span').innerHTML = `<span class="custom-color">${alias}</span>
												<svg onclick="event.stopPropagation();editContact('${el.address}')" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="20" height="25" class='right'>
												<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"/>
											</svg>`;
										} else {
											console.log('No alias found 🍿🍿🍿');
										}

									} else {
										console.log(did + ' DOESN\'T HAVE A RECORD  📛 ');
									}
									resolve(); // Resolve the promise once the operation is done
								})
								.catch(error => {
									console.warn('🌰 Warn on DID record:', error);
									reject(error); // Reject the promise if an error occurs
								});
						})
					);

					contct.innerHTML += `<li data-address="${el.address}" id="${el.address}" class=''> 
                            <a onclick="event.stopPropagation();selectChat((this.parentElement))">  
                                <img id ="${did}" src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
									<span >${contactInfo}</span>
									<svg onclick="event.stopPropagation();editContact('${el.address}')" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="20" height="25" class='right'>
										<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"/>
										</svg>
										</a> 
										</li>`;
				});

				// Execute all promises concurrently
				Promise.all(promises)
					.then(() => {
						console.log('⭐⭐⭐ All DID record processing completed.⭐⭐⭐');
						// change status button
						document.getElementById('lightButton').style.backgroundColor = 'green'
					})
					.catch(error => {
						console.error('❌❌❌ Error while processing DID records:', error);
						document.getElementById('lightButton').style.backgroundColor = 'yellow'
						return
					});

			}

		}
		// fin loadContacts





		async function saveContacts() {
			console.log('saveContacts()')

			// Retrieve the contacts from localStorage
			const contacts = localStorage.getItem('contacts');

			if (!contacts) {
				console.error('No contacts found in localStorage.');
				return;
			}


			// 	// encrypt contacts to store it in yourt DID
				let signer = await getSigner() 
					if (!signer) {
					console.log('Handle case where signer is not obtained');
					}
				let userAddress = signer.address;
			// 	let pubkey = signer.publicKey;
			// 	let encryptedContacts = await encryptData(contacts, pubkey);
			// console.log('encryptedContacts: ', encryptedContacts)

			// return
			// Create a Blob from the contacts data
			const blob = new Blob([contacts], { type: 'application/json' });

			// Create a link element
			const link = document.createElement('a');

			// Set the download attribute with the filename
			link.download = `contacts_${userAddress}.json`;
			// link.download = 'contacts.json';

			// Create a URL for the Blob and set it as the href attribute
			link.href = window.URL.createObjectURL(blob);

			// Append the link to the body (it won't be visible)
			document.body.appendChild(link);

			// Programmatically click the link to trigger the download
			link.click();

			// Remove the link from the document
			document.body.removeChild(link);
			Toast.fire({ icon: 'success', title: 'Contacts saved into JSON file!', text: '' });


		}

		function importContacts() {
			const input = document.createElement('input');
			input.type = 'file';
			input.accept = '.json';

			input.onchange = function (event) {
				importJSONContacts(event);
			};

			input.click();
		}


		function importJSONContacts(event) {
			const file = event.target.files[0]; // Get the selected file

			if (!file) {
				console.error('No file selected.');
				return;
			}

			const reader = new FileReader();

			reader.onload = function (e) {
				const content = e.target.result;

				try {
					// Parse the JSON content to ensure it's valid
					const contacts = JSON.parse(content);

					// Save the parsed JSON into localStorage
					localStorage.setItem('contacts', JSON.stringify(contacts));

					console.log('Contacts successfully loaded into localStorage.');
				} catch (error) {
					console.error('Error parsing JSON:', error);
			fixedToast.fire({ icon: 'error', title:'Error importing contacts!', text: error });
			return

				}
			};

			// Read the file as text
			reader.readAsText(file);
			Toast.fire({ icon: 'success', title: 'Contacts imported!', text: '' });
			loadContactsFromLocalstorage()
			// write changes to DID
			// todo..

		}

		// Example usage: Attach the function to an input element
		// document.getElementById('fileInput').addEventListener('change', loadContacts);

		// <button  class="btn btn-primary" onclick="event.stopPropagation();loadContacts()">Import</button>
		// function importContacts()
		/*********************************************************************************************
		.) OLD QRCHAT
		**********************************************************************************************/
		async function xmtp(wallet) {

			let to = localStorage.getItem('toAddress')
			if (!to) {
				console.log('NO "TO" ADDRESS')
				const xmtp = await Client.create(wallet)
				console.log('XMTP CLIENT CREATED: ', xmtp)
				// xm = xmtp;
				return
			}
			else {
				console.log('YES "TO" ADDRESS')
				const xmtp = await Client.create(wallet)
				localStorage.setItem('chatxmtp', xmtp)
				// await chatWith(to)
			}



		}

		document.getElementById("chatTextInput").addEventListener("keydown", function (event) {
			console.log('Pressed ENTER')
			if (event.key === "Enter") {
				var userInput = this.value.trim(); // Trim whitespace from input
				if (userInput !== "") {
					console.log("User input:", userInput);
					// Do something with the user input here
					sendMessage(event);
				}
				// var userInput = this.value;
				// console.log("User input:", userInput);
				// // Do something with the user input here
				// sendMessage();
				event.preventDefault(); // Prevents the default behavior of the Enter key (submitting a form)
			}
		});

		document.getElementById("chatTextInput").addEventListener("blur", function (event) {
			var userInput = this.value.trim(); // Trim whitespace from input
			if (userInput !== "") {
				console.log("User input:", userInput);
				// Do something with the user input here
				sendMessage(event);
			}
			// var userInput = this.value;
			// console.log("User input:", userInput);
			// // Do something with the user input here
			// sendMessage();
		});

		async function sendMessage() {
			console.log('sendMessage()')
			event.preventDefault();

			var userInput = document.getElementById("chatTextInput").value;
			var chatBox = document.getElementById("chatBox");
			var message = document.createElement("div");

			if (userInput.trim() !== "") {
				// The input value is not empty
				console.log("Input is not empty");
			} else {
				// The input value is empty
				console.log("Input is empty");
				return
			}



			document.getElementById("chatTextInput").value = "";
			chatBox.scrollTop = chatBox.scrollHeight;
			if (conversation) {
				console.log('CONVESATION AVAILABLE NOW: ', conversation)
			} else {
				console.log('NO AVAILABLE CONVESATION: ')

			}


			// SEND
			await conversation.send(`${userInput}`);// Send a message


			// unfocus
			document.getElementById('chatTextInput').blur();

			// event.preventDefault(); // Prevents the default behavior of the Enter key (submitting a form)

		}




		function setToAddress() {
			var toaddr = document.getElementById("toAddr").value;

			console.log('setting TO adddress: ', toaddr)

			// if (ethers.utils.isAddress(toaddr)) {
			if (ethers.isAddress(toaddr)) {
				console.log('VALID ADDRESS')
				document.getElementById("invalid-address-alert").style.display = "none";
				localStorage.setItem('toAddress', toaddr)
				document.getElementById('results').innerHTML += `<br>TO address: ${toaddr}  <button class="btn btn-secondary" onclick="clearChat()">Clear</button>`


			} else {
				console.log('INVALID ADDRESS')
				document.getElementById("invalid-address-alert").style.display = "block";

			}


		}



		function customcopy2clipboard(text) {
			console.log('customcopy2clipboard()', text)

			let textLink = `<a href="${text}">${text}</a>`;

			if (window.clipboardData && window.clipboardData.setData) {
				console.log('Copied to Clipboard', text, "success");

				document.getElementById('innerAddress').innerHTML = '<path fill="currentColor"  d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/><p>Copied!</p>'

				setTimeout(() => {
					document.getElementById('innerAddress').innerHTML = ' <path fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"></path>'
				}, 1000);
				return window.clipboardData.setData("Text", text);
			}
			else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
				var textarea = document.createElement("textarea");
				textarea.textContent = text;
				textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in Microsoft Edge.
				document.body.appendChild(textarea);
				textarea.select();
				try {
					console.log('Copied to Clipboard', text, "success");
					document.getElementById('innerAddress').innerHTML = '<path fill="currentColor"  d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/><p>Copied!</p>'

					setTimeout(() => {
						document.getElementById('innerAddress').innerHTML = ' <path fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"></path>'
					}, 1000);

					return document.execCommand("copy");  // Security exception may be thrown by some browsers.
				}
				catch (ex) {
					console.warn("Copy to clipboard failed.", ex);
					return prompt("Copy to clipboard: Ctrl+C, Enter", text);
				}
				finally {
					document.body.removeChild(textarea);
				}
			}


		}


		async function addUser() {
			console.log('ADDING NEW USER ADDRESS')
		}



		// EDIT CONTACT LOCALNAME
		// el.address
		async function editContact(addr) {
			console.log('editContact()')
			const inputValue = '';

			// const { value: userName } = await Swal.fire({
				const { value: contactName } = await Swal.fire({
				title: "Enter a name for this conctact",
				input: "text",
				inputLabel: "contact name",
				inputValue,
				showCancelButton: true,
				inputValidator: (value) => {
					if (!value) {
						return "You need to write something!";
					}
				}
			});
			if (contactName) {
// alert('contactName:',contactName)
				// let contact = { address: addr, username: userName, avatar: null, did: null }
				// SaveContactsToLocalStorage(contact)
				// await updateUsername(addr, contactName)
				await updateContactname(addr, contactName)

				// return
				loadContactsFromLocalstorage()
				return
				await loadContacts()
				console.log('Contact Updated', contactName)
				// Swal.fire(`Your IP address is ${userName}`);
			}


		}

		// no usado?
		// function updateContactList(contact) {
		 
		// SAVE DOCUMENTS
		function SaveDocToLocalStorage(data) {
			let documents = JSON.parse(localStorage.getItem('documents')) || [];

			// Check if the document with the same scid exists
			const existingIndex = documents.findIndex(doc => doc.cid === data.cid);

			if (existingIndex !== -1) {
				// Overwrite the existing document
				console.log('Overwrite the existing document')
				documents[existingIndex] = data;
			} else {
				// Add the new document
				console.log(' Add the new document')
				documents.push(data);
			}

			// Save the updated list back to localStorage
			localStorage.setItem('documents', JSON.stringify(documents));
		}
		// function SaveDocToLocalStorage(data) {
		//       var a = [];
		//       a = JSON.parse(localStorage.getItem('documents')) || [];


		//       a.push(data);
		//       localStorage.setItem('documents', JSON.stringify(a));
		//     }

		// async function getEncryptedContacts(encryptedContacts) {
		// 	console.log('getEncryptedContacts()',encryptedContacts);


		// }


		// // SAVE CONTACTS 
		async function SaveContactsToLocalStorage(contact) {
			console.log('SaveContactsToLocalStorage()',contact);

			// Retrieve the contacts array from localStorage, or initialize an empty array if none exist
			let a = JSON.parse(localStorage.getItem('contacts')) || [];

			// Check if the address already exists
			var isDuplicate = a.some(existingContact => existingContact.address === contact.address);

			if (!isDuplicate) {
				console.warn('CONTACT IS NOT IN YOUR CONTACTS');
				alert('CONTACT IS NOT IN YOUR CONTACTS');
				a.push(contact);

				// Save the updated contacts list to localStorage
				localStorage.setItem('contacts', JSON.stringify(a));

			} else {
				console.warn('Address already exists in your contacts, skipping save...');

			}


				// Save the encrypted contacts to DID 
				try{
					await encryptContacts(a) 
					console.warn("🎖️🎖️🎖️ encryptContacts!");
					Toast.fire({ icon: 'success', title: 'Encrypted contacts synced and updated!', text: '' });

					
				} catch (error) {
					console.error("🥊🥊🥊 An error occurred:", error);
					fixedToast.fire('Error', error.message, "error");

			}
				

		}
 


		async function encryptContacts(contacts){

			// Save the encrypted contacts to DID 

				// Encrypt contacts to store in your DID
				let signer = await getSigner();
				if (!signer) {
					console.warn('Handle case where signer is not obtained');
					alert('Handle case where signer is not obtained');
					return;
				}
				
				let pubkey = signer.publicKey;
				let stringContacts = JSON.stringify(contacts)
				stc =stringContacts;

				let encryptedContacts = await encryptData(stringContacts, pubkey);
				encts=encryptedContacts
				console.log('encryptedContacts: ', encryptedContacts);

				// Save the encrypted contacts to DID into a private field (not shown in this code)
				let did = `did:ius:${signer.address}`
				try{
					await updatePrivDataDID(did, encryptedContacts, signer) 
					console.warn("🎖️🎖️🎖️ updatePrivDataDID!");
					// Toast.fire({ icon: 'success', title: 'Encrypted contacts synced and updated!', text: '' });

					
				} catch (error) {
					console.error("🥊🥊🥊 An error occurred:", error);
					// fixedToast.fire('Error', error.message, "error");

			}
		}


		async function decryptContacts(){
			
				let signer = await getSigner();
				if (!signer) {
					console.warn('Handle case where signer is not obtained');
					alert('Handle case where signer is not obtained');
					return;
				}
				
				let did = `did:ius:${signer.address}`
				const didresult = await readDIDRecord(did);
				let encryptedContacts = didresult.data.privData;
				let privkey = signer.privateKey;
				let decryptedContacts = await decryptData(encryptedContacts, privkey);
				console.log('decryptedContacts: ', decryptedContacts);
			
				return decryptedContacts
			 
			}



		function RemoveContactFromLocalStorage(address) {
			console.log('RemoveContactFromLocalStorage()');

			// Get the current contacts from local storage
			var contacts = JSON.parse(localStorage.getItem('contacts')) || [];

			// Filter out the contact with the specified address
			var updatedContacts = contacts.filter(contact => contact.address !== address);

			// Save the updated contacts back to local storage
			localStorage.setItem('contacts', JSON.stringify(updatedContacts));
			// encrypt and save to did?

			console.log('Contact removed successfully.');
			Toast.fire({ icon: 'warning', title: 'Contact removed successfully!', text: '' });
			loadContacts()
		}




		function addToAgenda() {
			console.log('addToAgenda()')
			// check if contact is already in your agenda

		}

		// async function updateUsername(ethAddress, newUsername) {
			async function updateContactname(ethAddress, newContactname) {
			console.warn('updateContactname() 🤹‍♀️🤹‍♀️🤹‍♀️');
			// alert('newContactname' , newContactname);

			var contacts = JSON.parse(localStorage.getItem('contacts')) || [];

			// Find the contact by address and update the username
			for (let i = 0; i < contacts.length; i++) {
				if (contacts[i].address === ethAddress) {
					contacts[i].contactname = newContactname;
					localStorage.setItem('contacts', JSON.stringify(contacts));
					console.log(`Username updated for contact with address ${ethAddress}`);
					Toast.fire({ icon: 'success', title: 'Contact updated!', text: '' });

					// return;
				}
				else {
					console.log(`Contact with address ${ethAddress} not present`);

				}
			}

			console.log(`Contact with address ${ethAddress} not found`);

			// RESETEA EL CONTACTO???
			let contact = { address: ethAddress, contactname: newContactname, did: null }
			// let contact = { address: ethAddress, username: newUsername, avatar: null, did: null }
			// let contact = { address: ethAddress, username: newUsername, did: null }


			// chequear aqui si el contacto tiene algunos campos para evitar sobreescribirlos/resetarlos
			
			SaveContactsToLocalStorage(contact)
		}


		// ESTRUCTURA DE CONTACTO EN LOCALSTORAGE
		// address : "0x314C51BB1589B005D9c5f7Df7c6fE84D20491937"
		// avatar : null
		// did : null
		// username : null
		async function updateAvatar(ethAddress, newAvatar) {
			console.log('updateAvatar()');
			// alert(`updateAvatar() , ${ethAddress} ${ newAvatar}`);
			var contacts = JSON.parse(localStorage.getItem('contacts')) || [];

			// Find the contact by address and update the username
			for (let i = 0; i < contacts.length; i++) {
				if (contacts[i].address === ethAddress) {
					contacts[i].avatar = newAvatar;
					localStorage.setItem('contacts', JSON.stringify(contacts));
					console.log(`Avatar updated for contact with address ${ethAddress}`);
					Toast.fire({ icon: 'success', title: 'Contact updated(avatar)!', text: '' });

					return;
				}
				else {
					console.log(`Contact with address ${ethAddress} not present`);

				}
			}

			console.log(`Contact with address ${ethAddress} not found`);
			alert(`Contact with address ${ethAddress} not found`);
			// let contact = { address: ethAddress, username: newUsername, avatar: null, did: null }
			let contact = { address: ethAddress, avatar: null }
			// alert('about to modify SaveContactsToLocalStorage (contacts)',ethAddress)
			SaveContactsToLocalStorage(contact)
		}



		async function buildAllMiniAvatars(DIDsArray) {
			console.log('buildAllMiniAvatars()');
			
			// Retrieve contacts from localStorage once
			const contactsRaw = localStorage.getItem('contacts');
			const cwContacts = contactsRaw ? JSON.parse(contactsRaw) : [];
		
			if (cwContacts.length === 0) {
				console.warn('YOU HAVE NO CONTACTS in LOCALSTORAGE to try to minify its avatar()');
				return;
			}
		
			console.warn('👨‍👩‍👦 👨‍👩‍👧 👨‍👩‍👧‍👦 YOU HAVE', cwContacts.length, 'CONTACTS in LOCALSTORAGE at buildAllMiniAvatars()');
		
			const promises = cwContacts.map(async (contact) => {
				const did = contact.address.startsWith("did:ius:") ? contact.address : `did:ius:${contact.address}`;
		
				try {
					const didResult = await readDIDRecord(did);
		
					if (!didResult?.data) {
						console.log(`${did} DOESN'T HAVE A RECORD 📛`);
						return;
					}
		
					console.log(`${did} HAS A RECORD ✅`);
					const avatar = didResult.data.avatar;
		
					if (!avatar) {
						console.log('👀 👀 👀 Avatar img is empty');
						return;
					}
		
					const resizedAvatar = await resizeBase64Image(JSON.parse(avatar), 25, 25);
		
					if (!resizedAvatar) {
						console.error('Failed to resize avatar image.');
						return;
					}
		
					console.log('Resized Avatar:✅✅✅', resizedAvatar);
					document.getElementById(did).src = resizedAvatar;
		
					// Update the contact in the cwContacts array
					const ethAddress = didResult.data.id.replace(/^did:ius:/, "");
					const existingContact = cwContacts.find(c => c.address === ethAddress);
		
					if (existingContact) {
						existingContact.avatar = resizedAvatar;
		
						// Save updated contacts back to localStorage
						localStorage.setItem('contacts', JSON.stringify(cwContacts));
						console.log(`Avatar updated for contact with address ${ethAddress}`);
						Toast.fire({ icon: 'success', title: 'Contact updated(avatar)!' });
					} else {
						console.log(`Contact with address ${ethAddress} not present`);
					}
				} catch (error) {
					console.warn('🌰 Warn on DID record:', error);
				}
			});
		
			try {
				await Promise.all(promises);
				console.log('⭐⭐⭐ All DID avatars minifying completed.⭐⭐⭐');
			} catch (error) {
				console.error('❌❌❌ Error while processing DID records:', error);
				document.getElementById('lightButton').style.backgroundColor = 'yellow';
			}
		}
			
		 

		async function chatHistory(addr) {

			let conversation = await iusnaturalisxmtp.conversations.newConversation(addr)
			const messages = await conversation.messages()

			for (const message of messages) {
				console.log(message.content);
			}
		}




		function simplifyDate(dateString) {
			// Create a new Date object
			var date = new Date(dateString);

			// Get current date
			var currentDate = new Date();

			// Define months array for formatting
			var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

			// Format the date
			var formattedDate;
			if (date.toDateString() === currentDate.toDateString()) {
				// If the date is today, display only time
				var hours = date.getHours();
				var minutes = date.getMinutes().toString().padStart(2, '0');
				var seconds = date.getSeconds().toString().padStart(2, '0');
				formattedDate = hours + ':' + minutes + ':' + seconds;
			} else {
				// If the date is not today, display day, month, and year
				formattedDate = date.getDate() + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
			}

			return formattedDate;
		}

		// // Example usage:
		// var dateString = "Wed May 01 2024 01:17:42 GMT-0300 (Argentina Standard Time)";
		// console.log(simplifyDate(dateString)); // Output: "01 May 2024"

		// The resizing avatar function 
function resizeBase64Image(base64Image, width, height) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      resolve(canvas.toDataURL('image/png'));
    };
    img.onerror = () => resolve(null);
    img.src = base64Image;
  });
}





		async function openCard(toAddr, avtr) {
			console.log('openCard()', toAddr, avtr);

			// CHECKS IF NEWAVATAR
			// Initial avatar image
			let avatar = "./anonym.jpg";

			// Prepare the basic HTML data
			let htmlData = `<address>${toAddr} <svg id="innerAddress" onclick="event.stopPropagation();customcopy2clipboard('${toAddr}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z" ></path></svg> </address><br>
				<p>Loading additional information  <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </p>`;

			// Show the initial modal with basic info
			Swal.fire({
				imageUrl: avtr,
				imageWidth: 300,
				imageHeight: 300,
				imageAlt: 'Avatar image',
				html: htmlData,
				showDenyButton: true,
				showCancelButton: false,
				showCloseButton: true,
				confirmButtonText: 'Trust',
				denyButtonText: 'Block',
				customClass: {
					actions: 'my-actions',
					cancelButton: 'order-1 right-gap',
					confirmButton: 'order-2',
					denyButton: 'order-3',
				},
			}).then((result) => {
				if (result.isConfirmed) {
					editContact(toAddr);
				} else if (result.isDenied) {
					RemoveContactFromLocalStorage(toAddr);
				}
			});

			// Fetch the DID record in the background
			let did = `did:ius:${toAddr}`;
			let rdid = await readDIDRecord(did);
			rdd = rdid;
			if (rdid.data == null) {
				console.warn('DID NULL, create ONE');
			} else {
					console.warn(`DID EXISTENT!:  ${rdid.data.id}`);

					// AVATAR if new resizes and stores in localstorage
					if (rdid.data.avatar) {
						avatar = JSON.parse(rdid.data.avatar);
						console.log('We have an avatar');

					} else {
						console.log('Avatar data is empty');
					}

					//  CONTACTALIAS (ex USERNAME/)
						let contactalias = rdid.data.contactalias;
					if (contactalias) {
						console.log('Contactalias in DID: ', contactalias);
					} else {
						console.log('Contactalias data is empty');
					}

					// ALIAS
					let alias = rdid.data.alias;
					// let contactname = rdid.data.contactname;
					if (alias) {
						console.log('Name in DID: ', alias);
					} else {
						console.log('Alias data is empty');
					}

					// DOCUMENTS
					let docs = rdid.data.cid;
					if (docs) {
						console.log('Docs in DID: ');
						docs = await loadPublicDocsCard(docs)
						pd = docs
					} else {
						console.log('No docs in DID');
					}

					// Update the Swal modal with the fetched data
					Swal.update({
						imageUrl: avatar || "./anonym.jpg",
						html: `
						<address>${toAddr} <svg id="innerAddress" onclick="event.stopPropagation();customcopy2clipboard('${toAddr}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z" ></path></svg> </address><br>
						${contactalias ? `<p>Contactalias: ${contactalias}</p>` : '<p>Contactalias not available</p>'}
						${alias ? `<p>Alias: ${alias}</p>` : '<p>Alias not available</p>'}
						${docs ? `<p>Public documents: ${docs}</p>` : '<p>No documents available</p>'}
						`
					});
			}
		}





		var cwContacts = document.getElementById('cwContacts');

		cwContacts.addEventListener('contextmenu', function (e) {
			e.preventDefault(); // Prevent the default context menu

			// Check if the right-click was on an li element
			if (e.target.tagName === 'LI') {
				// Increment your counter or perform any other action
				console.log('Right-clicked on li element');
			}
		});




		async function initChatClient(wallet) {
			console.warn(`
******************
initChatClient()
******************
`)
			// Create the client with your wallet. This will connect to the XMTP development network by default
			// const xmtp = await Client.create(wallet)
			const xmtp = await Client.create(wallet, { env: "dev", })

			// REGISTER CODECS

			// Support on-chain transaction references in your app built with XMTP
			// https://xmtp.org/docs/build/messages/transaction
			xmtp.registerCodec(new TransactionReferenceCodec());



			// const iusnaturalisxmtp = await Client.create(wallet)
			iusnaturalisxmtp = xmtp;//make global
			console.warn('iusnaturalisxmtp SET TO GLOBAL')
			// Listen for new conversations
			const stream = await iusnaturalisxmtp.conversations.stream()
			console.log('STREAM:', stream)

			//  registerCodecs(xmtp)
			await listExistingConversations(iusnaturalisxmtp)
			return xmtp
		}


		// // -----------------
		// // LISTEN TO ALLLLLL INCOMING!
		// OLD
		// 0000000000


		// -----------------
		// LISTEN TO ALLLLLL INCOMING!
		async function listenAllNewAddresses() {
			console.log('listenAllNewAddresses()')

			for await (const message of await iusnaturalisxmtp.conversations.streamAllMessages()) {

				// ppppppppppppppppppppppppppp
				// ALREADY LISTENING FIX
				// Set to store addresses of active conversations
				// const activeConversations = new Set();
				// aconv = activeConversations
				const senderAddress = message.senderAddress;
				sndadrr = senderAddress

				// Skip if the message is from yourself
				if (senderAddress === iusnaturalisxmtp.address) {
					console.log(`📣 conversation from yourself`);

					continue;
				}

				// // Check if the chat is already being listened to
				// if (activeConversations.has(senderAddress)) {
				//     console.log(`📣📣📣 Already listening to conversation with ${senderAddress}`);
				//     continue;
				// }

				// // Start listening to the conversation
				// activeConversations.add(senderAddress);
				// console.log(`Started new conversation with ${senderAddress}`);




				// ppppppppppppppppppppppp

				document.getElementById('chatBadge').style.display = 'inline'
				document.getElementById('chatBadge').innerText = '!'
				console.log(`New message from ${message.senderAddress}: ${message.content}`)
				newMessageToast.fire({ icon: 'info', title: `${message.senderAddress} says:`, text: message.content });
				showNotification(message.senderAddress, message.content)
				showNotification('new message:', ' check the dapp!')

				try {
					await playButtonClickSound()
					// addToAgenda()

				}
				catch (error) {
					console.error('Error getting did:', error.message);
				}

				// ########################
				// CHAT CODES
				// ########################
				if (message.content.includes("paymentReceived0x21")) {
					console.log("You received a payment from: ", message.senderAddress);
					m = message
					const txLinkMatch = message.content.match(/txLink="([^"]+)"/);
					let txLink;
					if (txLinkMatch && txLinkMatch[1]) {
						txLink = txLinkMatch[1];
						console.log("Transaction Link:", txLink);
					}
					else { console.log("txLink not found."); }
					Swal.fire({ icon: "success", title: `Received!🤑`, html: `<span class ="tx"> Here is the tx  <a href="${txLink}" target="_blank">Link</a> ✨✨✨</span>` });
				}

				if (message.content.includes("peerGasPaymentAccepted0x21")) {
					Swal.fire({ title: "Your gas is being payed by your peer!", width: 600, padding: "3em", background: "lightgreen ", backdrop: ` rgba(0,123,123,0.4) url("./nyan-cat.gif") left top no-repeat ` });

					setTimeout(() => {
						Swal.fire("Done!", "", "success");
						closeModalId('#walletSend')
					}, 3000);
				}

				if (message.content.includes("peerGasPaymentReques0x20")) {
					console.log("You received a peerGasPamentRequest from: ", message.senderAddress);
					conversation = await iusnaturalisxmtp.conversations.newConversation(message.senderAddress)
					Swal.fire({
						title: "Do you have some gas?",
						text: "your peer is asking you to pay for the gas",
						icon: "question",
						showDenyButton: true,
						showCancelButton: true,
						confirmButtonText: ` <i class="fa fa-thumbs-up"></i> Yes! `,
						denyButtonText: ` <i class="fa fa-thumbs-down"></i>  Decline`,
						cancelButtonText: `  Ignore`
					}).then(async (result) => {
						if (result.isConfirmed) {
							Swal.fire({ title: `You are paying for the gas for ${message.senderAddress} (it is being automaticalle discounted from your gas balance)!`, width: 600, padding: "3em", color: "#716add", background: "#fff ", backdrop: ` rgba(0,0,123,0.4) url("./nyan-cat.gif") left top no-repeat ` });
							await conversation.send(`user accepted to pay for the gas! <pre style="display: none;">peerGasPaymentAccepted0x21</pre>`);// Send a message
							setTimeout(() => {
								Swal.fire("Gas payed!(FAKE...)", "", "success");
							}, 5000);
						} else if (result.isDenied) {
							Swal.fire("You decline to pay for the gas", "", "info");
						}
					});
				}
				
				if (message.content.includes("addToken0x19")) {
					Swal.fire({ title: "Do you want to add this token?",
					width: 600, padding: "3em", background: "lightgreen ", 
					backdrop: ` rgba(0,123,123,0.4) url("./nyan-cat.gif") left top no-repeat ` });

					// setTimeout(() => {
					// 	Swal.fire("Done!", "", "success");
					// 	closeModalId('#walletSend')
					// }, 3000);
				}

				else { console.log("(DIRTYFIX)The message does not contain the text: 'can you pay for the gas?'"); }
				var storedContacts = [];
				let storedContacts = JSON.parse(localStorage.getItem('contacts')) || [];
				var index = storedContacts.findIndex(existingContact => existingContact.address === message.senderAddress);
				if (index === -1) {
					console.log('THIS ADDRESS IS NOT IN YOUR CONTACT LIST.. Adding new UNKNOWN (and unvalidated) contact.');
					addUnknownContact(message.senderAddress, message.content)
				}
				else {
					console.log('YES: THIS ADDRES IS IN YOUR CONTACT LIST')
					// alert('OVERWRITE last msg, INDEX:', storedContacts[index], index)
					console.log('OVERWRITE last msg, INDEX:', storedContacts[index], index)
					addknownContact(message.senderAddress, message.content)

				}

				updateBadge()
			}
		}



 
		/*********************************************************************************************
		.)  HANDLERS
		**********************************************************************************************/

		// ..................................................................
		// Handle different chat codes
		//declar all chatCodes here
		async function handleChatCodes(message) {
			const content = message.content;

			if (content.includes("paymentReceived0x21")) {
				handlePaymentReceived(message);
			} else if (content.includes("peerGasPaymentAccepted0x21")) {
				handleGasPaymentAccepted();
			} else if (content.includes("peerGasPaymentReques0x20")) {
				await handleGasPaymentRequest(message);
			} else if (content.includes("addToken0x19")) {
				await handleGasPaymentRequest(message);
			}
		}
		// ..................................................................
				// Handle "addToken" event
				function handleAddToken(message) {
			console.log("You will add this token: ", message.token);

			Swal.fire({
				icon: "success",
				title: "token added!🎉🎉🎉",
			});
		}

		// Handle "paymentReceived" event
		function handlePaymentReceived(message) {
			console.log("You received a payment from: ", message.senderAddress);
			const txLinkMatch = message.content.match(/txLink="([^"]+)"/);
			let txLink = txLinkMatch ? txLinkMatch[1] : null;
			console.log("Transaction Link:", txLink || "txLink not found.");

			Swal.fire({
				icon: "success",
				title: "Received!🤑",
				html: `<span class ="tx"> Here is the tx <a href="${txLink}" target="_blank">Link</a> ✨✨✨</span>`
			});
		}

		// Handle "peerGasPaymentAccepted" event
		function handleGasPaymentAccepted() {
			Swal.fire({
				title: "Your gas is being paid by your peer!",
				width: 600,
				padding: "3em",
				background: "lightgreen",
				backdrop: `rgba(0,123,123,0.4) url("./nyan-cat.gif") left top no-repeat`
			});

			setTimeout(() => {
				Swal.fire("Done!", "", "success");
				closeModalId('#walletSend');
			}, 3000);
		}

		// Handle "peerGasPaymentRequest" event
		async function handleGasPaymentRequest(message) {
			console.log("You received a peerGasPaymentRequest from: ", message.senderAddress);
			const conversation = await iusnaturalisxmtp.conversations.newConversation(message.senderAddress);

			Swal.fire({
				title: "Do you have some gas?",
				text: "Your peer is asking you to pay for the gas",
				icon: "question",
				showDenyButton: true,
				showCancelButton: true,
				confirmButtonText: `<i class="fa fa-thumbs-up"></i> Yes!`,
				denyButtonText: `<i class="fa fa-thumbs-down"></i> Decline`,
				cancelButtonText: `Ignore`
			}).then(async (result) => {
				if (result.isConfirmed) {
					await conversation.send(`user accepted to pay for the gas! <pre style="display: none;">peerGasPaymentAccepted0x21</pre>`);
					Swal.fire({ title: `You are paying for the gas for ${message.senderAddress}!`, backdrop: `rgba(0,0,123,0.4) url("./nyan-cat.gif") left top no-repeat` });
				} else if (result.isDenied) {
					Swal.fire("You declined to pay for the gas", "", "info");
				}
			});
		}

		// Update contacts and handle new unknown contacts
		async function updateContacts(message) {
			console.warn('updateCOntacts:', message)
			const senderAddress = message.senderAddress;
			let storedContacts = JSON.parse(localStorage.getItem('contacts')) || [];

			// Check if contact already exists
			const index = storedContacts.findIndex(contact => contact.address === senderAddress);

			if (index === -1) {
				console.log('Adding new UNKNOWN contact.');
				addUnknownContact(senderAddress, message.content);
			} else {
				console.log('Updating known contact.');
				addKnownContact(senderAddress, message.content);
			}
		}



		async function createAlias(addr) {
			// const formattedAddress = ethers.utils.getAddress(addr);
			console.log('CREATE AN ALIAS FOR THIS ADDRESS', addr)
			// console.log('CREATE AN ALIAS FOR THIS ADDRESS',formattedAddress)

			// TEST
			// await iusnaturalisxmtp.registerCodec(new ContentTypeMultiplyNumberCodec());

			// const numbersToMultiply = { a: 3, b: 7 };

			// await conversation.send(numbersToMultiply, {
			// contentType: ContentTypeMultiplyNumbers,
			// });

		}




		async function listExistingConversations(xmtp) {
			console.warn('listExistingConversations() NO USADO?????')
			// List existing conversations
			const allConversations = await xmtp.conversations.list()
			console.log('AVAILABLE CHATS:', allConversations.length)
			const peerAddressesArray = [];

			allConversations.forEach(async (conversation, index) => {
				peerAddressesArray.push(conversation.peerAddress);

				// QUITAR SOLO PARA PRUEBA
				console.warn('listenNewChats() OMITED HERE')
				// await listenNewChats(conversation.peerAddress)
			})
			paa = peerAddressesArray;
			console.warn('!!!!! paa DECLARED !!!!!!!!!')

		}



		async function deleteChat(addr) {
			console.warn('👋 🔌 DELETING CHAT', addr)
			// clear URL
			removeParam('chat');
			// remove body's ATTRIBUTE
			document.body.removeAttribute('currentChat');

			// remove "TO" address from localStorage
			localStorage.removeItem('toAddress')

			// GOT TO CHAT TAB
			// openChat()
			closeSearch()

			//clear UI
			chatAddress.innerHTML = ''
			document.getElementById('chatBox').innerHTML = `<div class="container"> <div class="row justify-content-center"> <div class="col-10"> <div id="svg-container"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"> <image href="./logoius.svg" width="100%" height="100%"></image> </svg> <button type="button"   class="btn btn-primary " style="display: inline;" onclick="event.stopPropagation(); openChat()"> CHAT </button> </div> </div> </div> </div> `
			// DEACTIVATE BUTTONS
			document.getElementById('chatTextInput').disabled = true;
			document.getElementById('send-button').disabled = true;


			// AQUI TAMBIEN ELIMITAR CHAT
			closeConversation(addr);


		}



		function removeParam(key) {
			var url = new URL(window.location.href);
			url.searchParams.delete(key);
			window.history.replaceState({}, '', url);
		}





		// ----------------------------------
		// CHECK VALID ADDRESS


		async function isValidETHAddress(address) {
			// return ethers.utils.isAddress(address);
			return ethers.isAddress(address);
		}

		function isValidHex(address) {
			// Regular expression to check if a string is a valid hexadecimal
			const hexRegex = /^[0-9a-fA-F]+$/;
			return hexRegex.test(address);
		}

		function isValidStarkNetAddress(address) {
			// Remove the '0x' prefix if it exists
			const normalizedAddress = address.startsWith('0x') ? address.slice(2) : address;

			// Check if the address is a valid hexadecimal string and has the correct length
			return isValidHex(normalizedAddress) && normalizedAddress.length === 64;
		}

		async function getAddressType(address) {
			console.log('getAddressType()')
			// Check if it's a valid Ethereum address
			const isValidETH = await isValidETHAddress(address);
			if (isValidETH) {
				return 'ETH';
			}

			// Check if it's a valid StarkNet address
			const isValidStarkNet = isValidStarkNetAddress(address);
			if (isValidStarkNet) {
				return 'StarkNet';
			}

			// If neither, it's invalid
			return 'Invalid';
		}

		async function addAddress() {
			console.log('addAddress()')

			let cid = dictionary[globalLang]["addAddress"];

			let addressToAdd = Swal.fire({
				title: dictionary[globalLang]["addAddress"],
				footer: `
				<button type="button"   class="btn btn-danger" onclick="event.stopPropagation(); scanAddress()">
					${dictionary[globalLang]["scanqr"]}
            <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512">
              <path d="M0 80C0 53.5 21.5 32 48 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V80zM64 96v64h64V96H64zM0 336c0-26.5 21.5-48 48-48h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V336zm64 16v64h64V352H64zM304 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H304c-26.5 0-48-21.5-48-48V80c0-26.5 21.5-48 48-48zm80 64H320v64h64V96zM256 304c0-8.8 7.2-16 16-16h64c8.8 0 16 7.2 16 16s7.2 16 16 16h32c8.8 0 16-7.2 16-16s7.2-16 16-16s16 7.2 16 16v96c0 8.8-7.2 16-16 16H368c-8.8 0-16-7.2-16-16s-7.2-16-16-16s-16 7.2-16 16v64c0 8.8-7.2 16-16 16H272c-8.8 0-16-7.2-16-16V304zM368 480a16 16 0 1 1 0-32 16 16 0 1 1 0 32zm64 0a16 16 0 1 1 0-32 16 16 0 1 1 0 32z"></path>
            </svg>
          </button>
				`,
				input: 'text',
				inputAttributes: { autocapitalize: 'off' },
				showCancelButton: true,
				confirmButtonText: 'ok',
				showLoaderOnConfirm: true,
				preConfirm: (login) => { },
				backdrop: true,
				inputValidator: async (value) => {
					if (!value) {
						return 'You need to set a password to create your wallet!'
					}


					//  ADDR VERIFICATION
					const isValid = await getAddressType(value);

					if (isValid) {
						console.log(`Address ${value} is valid.`);
						// ---------------------
						// ANALIZE ADDRESS
						if (isValid === 'ETH') {
							console.log('Perform action for Ethereum address 🌽🌽🌽');
							let contact = { address: value, username: null, avatar: null, did: null }
							let userAddress = document.getElementById('yourAddress').getAttribute('address');
							console.log(value, userAddress)
							if (value == userAddress) {
								console.warn('🙅‍♂️ CANCELING chatwith() because CANNOT WITH SELF ADDRESS')
								Toast.fire('CANNOT CHAT WITH SELF ADDRESS', '🙅‍♂️', "warning");
								localStorage.removeItem('toAddress')// detele "TO" address from localStorage
								return
							}

							SaveContactsToLocalStorage(contact)
							// chatWith(toAddr ,imgsrc)
							// get avatar if available or get it async

							console.log('continue to chat 🍓🍓🍓');
							await chatWith(value)

							// ??????
							// console.log('NOW DELETE CHAT???? 🧂🧂🧂')
							// await deleteChat()

						}
						// ---------------
						else if (isValid === 'StarkNet') {
							console.log('Perform action for StarkNet address');
							let did = `did:starkid:${value}`
							let didData = await fetchDID(did)
							console.log('didData', didData)
							if (didData.data.alias || null) {
								console.log('alias is not null', didData.data.alias);
								let contact = { address: didData.data.alias, username: null, avatar: null, did: did }
								SaveContactsToLocalStorage(contact);
								await chatWith(didData.data.alias)
								await deleteChat()

							} else {
								console.log('alias is null');
							}

						}


						else {
							console.warn('Invalid address');
						}

					} else {
						console.log(`Address ${value} is not valid.`);
						return 'Address is not valid!'

					}

				},

				allowOutsideClick: () => {
					const popup = Swal.getPopup()
					popup.classList.remove('swal2-show')
					setTimeout(() => { popup.classList.add('animate__animated', 'animate__headShake') })
					setTimeout(() => { popup.classList.remove('animate__animated', 'animate__headShake') }, 500)
					return false
				},
			})
				.then(async (result) => {
					if (result.isConfirmed) {
						console.log('result.isConfirmed:')
						// await decryptWallet(result.value)
						return result.value
					}
				})
			console.log('addressToAdd:', addressToAdd)

			// close nav
			plToggle()

		}


		/*********************************************************************************************
		.)  Show Password Toggle
		**********************************************************************************************/

		function showPassToggle() {
			console.log('showPassToggle()')

			var ShowPasswordToggle = document.querySelector("[type='password']");
			ShowPasswordToggle.onclick = function () {
				document.querySelector("[type='password']").classList.add("input-password");
				document.getElementById("toggle-password").classList.remove("d-none");

				const passwordInput = document.querySelector("[type='password']");
				const togglePasswordButton = document.getElementById("toggle-password");

				togglePasswordButton.addEventListener("click", togglePassword);
				function togglePassword() {
					if (passwordInput.type === "password") {
						passwordInput.type = "text";
						togglePasswordButton.setAttribute("aria-label", "Hide password.");
					} else {
						passwordInput.type = "password";
						togglePasswordButton.setAttribute(
							"aria-label",
							"Show password as plain text. Warning: this will display your password on the screen."
						);
					}
				}
			};

		}




		// -------

		// 2. Store the Password Securely Using Biometrics
		async function storePasswordWithBiometrics(password, walletAddress) {
			console.log('storePasswordWithBiometrics: ', password, walletAddress)
			const passwordBuffer = new TextEncoder().encode(password);

			const publicKey = {
				challenge: new Uint8Array(32), // Dummy challenge
				rp: { name: "Web3 App" },
				user: {
					id: new TextEncoder().encode(walletAddress),
					name: walletAddress,
					displayName: "User with Wallet " + walletAddress
				},
				pubKeyCredParams: [{ alg: -7, type: "public-key" }],
				authenticatorSelection: {
					authenticatorAttachment: "platform",
					userVerification: "required"
				},
				timeout: 60000,
				attestation: "direct"
			};

			// Create a new biometric credential
			const credential = await navigator.credentials.create({ publicKey });

			// Encrypt the password with the public key (or just store it if using symmetric encryption)
			const encryptedPassword = btoa(String.fromCharCode(...passwordBuffer));
			localStorage.setItem('encryptedPassword', encryptedPassword);
			localStorage.setItem('credentialID', btoa(String.fromCharCode(...new Uint8Array(credential.rawId))));
		}



		// 3. Recall the Password Using Biometrics
		async function recallPasswordWithBiometrics(walletAddress) {
			const credentialID = Uint8Array.from(atob(localStorage.getItem('credentialID')), c => c.charCodeAt(0));

			const publicKey = {
				challenge: new Uint8Array(32), // Dummy challenge
				allowCredentials: [{
					id: credentialID,
					type: "public-key"
				}],
				timeout: 60000,
				userVerification: "required"
			};

			const assertion = await navigator.credentials.get({ publicKey });

			// Retrieve and decrypt the password
			const encryptedPassword = localStorage.getItem('encryptedPassword');
			const password = atob(encryptedPassword);

			console.warn('password:', password)
			return password;
		}

		// -------

		let currentStep = 1;
		let mnemonicPhrase = ""; // This should be generated and set when creating the wallet
		const displayMnemonic = document.getElementById('displayMnemonic');


		async function prevStep() {
			currentStep--;
			showStep(currentStep);
		}


		async function nextStep() {
			console.log('nextStep: ', currentStep);

			if (currentStep == 1) {
				console.log('check password and remember options')

				const form = document.getElementById('passwordForm');
				const passwordInput = document.getElementById('password');
				const rememberPassword = document.getElementById('rememberPassword').checked;
				const rememberPasswordwithBiometry = document.getElementById('rememberWithBiometry').checked;

				// Trigger validation
				if (!form.checkValidity()) {
					form.classList.add('was-validated');
					document.getElementById('rememberPassword').checked = false; // Uncheck the checkbox if validation fails
					document.getElementById('rememberWithBiometry').checked = false; // Uncheck the checkbox if validation fails
					return
				} else {

					let password = document.getElementById('password').value;

					if (rememberPasswordwithBiometry) {
						// Execute your function when the checkbox is checked and password is valid
						console.warn("Remember password with BIOMETRY activated .");

						// let password =  passwordInput.value 
						let password = document.getElementById('password').value;
						let walletAddress = document.getElementById('yourAddress').getAttribute('address');

						try {
							await storePasswordWithBiometrics(password, walletAddress)
						} catch (error) {
							console.error("Password cannot be stored with Biometrics:", error);
							document.getElementById('rememberWithBiometry').checked = false
							return

						}


					} else {
						console.log("Remember password with BIOMETRY deactivated.");
						// BORRAR CREDENCIALES BIOMETRICAS
						localStorage.removeItem("encryptedPassword");
						localStorage.removeItem("credentialID");

					}

					if (rememberPassword) {
						console.warn("Remember password with SESSION_STORAGE activated.");
						// let password = document.getElementById('password').value;

						try {
							// await storePasswordInSession(password)
							sessionStorage.setItem("password", password);

						} catch (error) {
							console.error("Password cannot be stored with SESSION_STORAGE:", error);
							document.getElementById('rememberPassword').checked = false
							return

						}
					} else {
						console.log("Remember password with SESSION_STORAGE deactivated.");
						sessionStorage.removeItem("password");

					}

					// remember to delete this later in the code
					sessionStorage.setItem("tempPassword", password);

				}
			}



			currentStep++;
			showStep(currentStep);
		}

		async function getMnemonic() {
			// Replace this with actual mnemonic generation logic
			// return "example mnemonic phrase generated by your wallet";
			// const unbackedWallet = localStorage.getItem('unbackedWallet');
			// let mnemonicPhrase = JSON.parse(unbackedWallet)
			// return mnemonicPhrase
			const unbackedWallet = localStorage.getItem('unbackedWallet');

			if (unbackedWallet) {
				try {
					let mnemonicPhrase = JSON.parse(unbackedWallet);
					return mnemonicPhrase;
				} catch (e) {
					console.error('Error parsing JSON from localStorage:', e);
					// Handle parsing error or provide fallback
					return null; // or some default value
				}
			} else {
				console.warn('unbackedWallet is not present in localStorage.');
				// Handle the case when unbackedWallet is not found
				// let pass = 	sessionStorage.getItem("tempPassword");
				// const encryptedWallet = localStorage.getItem('encryptedWallet');
				// let wallet =  await ethers.Wallet.fromEncryptedJson(encryptedWallet, pass)
				// let mnemonic = wallet.mnemonic.phrase;
				// return mnemonic

				try {
					let pass = sessionStorage.getItem("tempPassword");
					const encryptedWallet = localStorage.getItem('encryptedWallet');
					let wallet = await ethers.Wallet.fromEncryptedJson(encryptedWallet, pass)
					let mnemonic = wallet.mnemonic.phrase;
					return mnemonic
					// return mnemonicPhrase;
				} catch (e) {
					console.error('Error parsing  encryptedWallet:', e);
					// Handle parsing error or provide fallback
					return null; // or some default value
				}
				// return ethers.Wallet.fromEncryptedJson(encryptedWallet, pass)
				// return null; // or some default value
			}
			// return JSON.parse(unbackedWallet)
		}


		async function showStep(step) {
			switch (step) {


				case 1:

					displayMnemonic.innerHTML = `
						<form id="passwordForm" class="needs-validation" novalidate>
							<label for="password" class="form-label">SET YOUR Password</label>
							<div class="input-group">
								<input type="password" id="password" class="form-control rounded" required>
								<button id="toggle-password" type="button" class="d-none"
									aria-label="Show password as plain text. Warning: this will display your password on the screen.">
								</button>
								<div class="invalid-feedback">
									Please enter your password.
								</div>
							</div>
							<br>
							<div class="mb-3 form-check">
								<input type="checkbox" class="form-check-input" id="rememberPassword" checked>
								<label class="form-check-label" for="rememberPassword">Remember me</label>
							</div>
								<div class="mb-3 form-check">
								<input type="checkbox" class="form-check-input" id="rememberWithBiometry" >
								<label class="form-check-label" for="rememberWithBiometry">Use your device biometrics to store password</label>
							</div>
							<button class="btn btn-primary" type="button" onclick="nextStep()">Next</button>
						</form>
					`;
					showPassToggle()
					// toggleRememberPassword()
					break;


				case 2:
					mnemonicPhrase = await getMnemonic(); // Generate or retrieve the mnemonic phrase
					randomIndices = generateRandomIndices(mnemonicPhrase.split(" ").length); // Generate indices once
					displayMnemonic.innerHTML = `
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height='40px' width='40px' fill="currentColor">
                        <path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/>
                    </svg>
					${dictionary[globalLang]["writedown"]}
                </h3>
                <div class="alert alert-warning alert-dismissible fade show">
                    <strong>${mnemonicPhrase}</strong>
                </div>
				<button class="btn btn-primary" type="button" onclick="prevStep()" >Prev</button>
                <button class="btn btn-primary" onclick="nextStep()">Next</button>
            `;
					break;
				case 3:
					// let mnemonicPhrase = await getMnemonic(); // Generate or retrieve the mnemonic phrase
					console.log('mnemonic in step 3:', mnemonicPhrase)
					displayMnemonic.innerHTML = `
                <form id="mnemonicForm" class="needs-validation" novalidate>
                    <h3>Verify your mnemonic phrase</h3>
                    <div id="mnemonicVerification">
                        ${generateVerificationFields(mnemonicPhrase)}
                    </div>
				<button class="btn btn-primary" type="button" onclick="prevStep()" >Prev</button>

                    <button class="btn btn-primary" type="submit">Verify</button>
                </form>
            `;

					const mnemonicForm = document.getElementById('mnemonicForm');
					mnemonicForm.addEventListener('input', verifyMnemonic, false); // Verify on each input
					mnemonicForm.addEventListener('submit', function (event) {

						const isValid = verifyMnemonic(); // Call the function to check if all words are correct

						if (!mnemonicForm.checkValidity() || !isValid) {
							event.preventDefault();
							event.stopPropagation();
						} else {
							event.preventDefault();
							// Action to perform when all mnemonic words are correct
							console.log("All words are correct!"); // Example action: log a message

							Toast.fire({ icon: 'success', title: 'All words are correct' });



							// You can replace the console log with any other action, such as:
							let tempPass = sessionStorage.getItem("tempPassword");
							encryptAndStoreWallet(tempPass)
							// mnemonicPhrase unbackedWallet or encryptedWallet?
							// - Navigating to the next step
							// - Displaying a success message
							// - Storing the information in local storage
							// - Triggering an API call

							// For example, to move to the next step:
							nextStep();



						}

						mnemonicForm.classList.add('was-validated');

					}, false);
					break;
				default:
					displayMnemonic.innerHTML = `
			<h3>✅ Mnemonic phrase backup completed! 🎉🎉🎉 </h3>
			<button class="btn btn-secondary center"  onclick="closeModalId('#walletBackp')">Close</button>
			`;
					sessionStorage.removeItem("tempPassword");


			}
		}

		async function encryptAndStoreWallet(password) {
			console.log('encryptAndStoreWallet()')
			// recreate unbacked wallet
			const unbackedWallet = localStorage.getItem('unbackedWallet');
			const walletData = JSON.parse(unbackedWallet);

			let wallet = ethers.Wallet.fromPhrase(walletData);

			// now encrypt the json wallet and save it lo localstorage
			let encSigner = await wallet.encrypt(password)
			// }
			// catch (error) { console.warn(error.message, 'ERROR 2 WALLET!');  }

			localStorage.setItem('encryptedWallet', encSigner)

			// Now delete unbackedWallet and create encryptedWallet/encryptedJsonWallet
			console.log('unbackedWallet deleted from localStorage')
			localStorage.removeItem('unbackedWallet')
		}


		function generateRandomIndices(length) {
			// Generate a unique set of indices
			const indices = new Set();
			while (indices.size < 3) {
				indices.add(Math.floor(Math.random() * length));
			}
			return Array.from(indices);
		}

		function generateVerificationFields(mnemonic) {
			const words = mnemonic.split(" ");
			let verificationFields = "";

			randomIndices.forEach(index => {
				verificationFields += `
            <div class="form-group">
                <label for="word${index}">Enter word #${index + 1}</label>
                <input type="text" id="word${index}" class="form-control" required>
                <div class="invalid-feedback">
                    Please enter the correct word.
                </div>
            </div>
        `;
			});

			return verificationFields;
		}

		function verifyMnemonic() {
			console.log('verifyMnemonic()')

			const words = mnemonicPhrase.split(" ");
			let allCorrect = true;

			randomIndices.forEach(index => {
				const input = document.getElementById(`word${index}`);
				if (input) {
					if (input.value.trim() !== words[index]) {
						allCorrect = false;
						input.classList.add("is-invalid");
						// Toast.fire({ icon: 'error', title: 'Please verify the mnemonic phrase again' });

					} else {
						input.classList.remove("is-invalid");
						input.classList.add("is-valid");
					}
				} else {
					allCorrect = false;
					Toast.fire({ icon: 'error', title: 'allCorrect = false' });

				}
			});

			// Toast.fire({ icon: 'info', title: `allCorrect = ${allCorrect}`});

			return allCorrect;
		}



		/*********************************************************************************************
		.)  SETTINGS
		**********************************************************************************************/
		async function getPasswordWithModal() {
			console.warn('getPasswordWithModal()')
			return Swal.fire({
				title: dictionary[globalLang]["unlockWallet"],
				showCancelButton: false,
				showDenyButton: true,

				confirmButtonText: 'Enter',
				denyButtonText: `Cancel`,

				showLoaderOnConfirm: true,
				// backdrop: true,

				input: 'password',
				inputAttributes: { autocapitalize: 'off' },
				backdrop: true,
				html: `				
					<br>
					<input type="checkbox" id="rememberPassword" name="rememberPassword" checked> 
					<label for="rememberPassword">Remember password</label> 
					`,
				footer: '<a href="/docs/index.html#" target="_blank" rel="noopener noreferrer">Docs</a>',
				preConfirm: (value) => {
					if (!value) {
						Swal.showValidationMessage('<i class="fa fa-info-circle"></i> A password is required')
					}

				},
				allowOutsideClick: () => { const popup = Swal.getPopup(); popup.classList.remove('swal2-show'); setTimeout(() => { popup.classList.add('animate__animated', 'animate__headShake'); }); setTimeout(() => { popup.classList.remove('animate__animated', 'animate__headShake'); }, 500); return false; },
			})
				.then(async (result) => {
					if (result.isConfirmed) {

						const password = result.value;
						const rememberCheckbox = Swal.getPopup().querySelector('#rememberPassword');
						console.log('password entered!', result.value);
						// console.log('rememberPasswordCheckboxentered!',rememberCheckbox.value);
						console.log('checked?', rememberCheckbox.checked);

						return { password, rememberCheckbox }
					}
					if (result.isDenied) {
						console.log('cancelled');
						return false

					}

					// return result.value

				})

		}

		async function settings() {
			console.log('settings()')
			openModalId('#settingsModal')
			loadSettingsPreferences()

		}



		/*********************************************************************************************
		.)  BACKUP
		**********************************************************************************************/

		async function backup(mnemonicPhrase) {
			console.warn('backup()')
			// openModalId('#walletBackp')
			// closeModalId('#settingsModal')
			walletbackpfooter.innerHTML = `<a href="/docs/index.html#/?id=la-frase-mnemot%c3%a9cnica" target="_blank" rel="noopener noreferrer">Check out the documentation!</a> `

			// REMOVE HEADER ALERT 
			headerNotes.innerHTML = ``

			// -----------------
			// get mnemonicphrase
			// -----------------

			//  IS UNBACKEDWALLET?
			const unbackedWallet = localStorage.getItem('unbackedWallet');
			if (!unbackedWallet) {
				console.warn('No unbackedWallet found. Checking for encryptedWallet.');

				// 3-  NO UNBACKED WALLET, is JSONWALLET?
				const encryptedWallet = localStorage.getItem('encryptedWallet');
				if (!encryptedWallet) {
					console.warn('No encryptedWallet found.');

				} else {
					// console.warn('3- YES JSON WALLET')
					console.warn('YES encryptedWallet found. Checking for jsonWalletPassword.');
					const jsonWalletPassword = sessionStorage.getItem('password');
					if (!jsonWalletPassword) {
						console.warn('No password found.');
						console.error('No password found.');

						// return

					} else {
						console.warn('encryptedWallet and jsonWalletPassword found.');
						// THIS IS FOR JUST BACKING UP THE MNEMONIC(as the unbacked wallet was already backed up)
						// GET password to decript the wallet
						// --------------------------------------------------------
					}
					closeModalId('#settingsModal')

					let getPassword = await getPasswordWithModal()
					if (!getPassword) {
						console.log("Password retrieval failed.");
						return
					} else {
						console.log("Password retrieved successfully.");
						console.log('PASSWORDDDDDD: ', getPassword)
						gp = getPassword
					}

					//  return
					openModalId('#walletPassword')

					//  let password= getPassword.value.backupPassword.value;
					let password = getPassword.password;
					let encryptedjson = localStorage.getItem('encryptedWallet');
					let ew = JSON.parse(encryptedjson);
					console.log('pub key of wallet in localstorage:', ew.address);
					let wallet;
					try {
						wallet = await ethers.Wallet.fromEncryptedJson(encryptedjson, password)
						w = wallet

					}
					catch (error) {
						console.error('Error during wallet decryption:', error);
						// Toast.fire('Error', error.message, "error");
						backedWalletMnemonic.innerHTML = `
								<div class="alert alert-danger alert-dismissible fade show" role="alert">
								<strong>Error!</strong> Something went wrong. Please try again.
								</div>

								`

						return null;
						// return null;
					}

					const rememberPasswordCheckbox = getPassword.rememberCheckbox

					if (rememberPasswordCheckbox.checked) {
						sessionStorage.setItem("password", password);

					} else {
						sessionStorage.removeItem("password");

					}

					console.warn('MNEMONIC: ', wallet.mnemonic.phrase)

					backedWalletMnemonic.innerHTML = `
									<h3>
										<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height='40px' width='40px' fill="currentColor">
											<path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/>
										</svg>
										${dictionary[globalLang]["writedown"]}
									</h3>
									<div class="alert alert-warning alert-dismissible fade show">
										<strong>${wallet.mnemonic.phrase}</strong>
									</div>
									<button class="btn btn-secondary center"  onclick="closeModalId('#walletPassword')">Close</button>
								
								`;
					// class="alert alert-danger alert-dismissible fade show"
					return
					// --------------------------------------------------------

					// }

				}
			} else {
				// Handle unbackedWallet
				console.warn('2- YES unbackedWallet')
				openModalId('#walletBackp')
				closeModalId('#settingsModal')
				showStep(currentStep);

			}

			// -----------------
			// Initialize the first step
			// showStep(currentStep);


			return

		}

		async function restoreWallet() {
			console.warn('restoreWallet()')
			openModalId('#walletRestore')
			closeModalId('#settingsModal')



			// DETECT IF ARE WORDS OR PRIVATE KEYS
			const input = document.getElementById("seedTextarea").value.trim();
			const privateKeyRegex = /^0x[a-fA-F0-9]{64}$/;
			const seedPhraseRegex = /^(\b[A-Za-z]+\b\s){11}(\b[A-Za-z]+\b)$/;

			seedTextarea.addEventListener('input', function (evt) {
				console.log(this.value);

				// IF PRIVATE KEY
				if (privateKeyRegex.test(this.value)) {
					console.warn("Private Key Detected");
					seedTextarea.classList.add("is-valid");
				}

				// IF SEEDPHRASE
				// else if (seedPhraseRegex.test(this.value)) {
				else if (seedPhraseRegex.test(this.value.trim())) {

					let cntwrds = countWords(this.value)

					if (cntwrds >= 12) {
						console.warn("Seed Phrase complete!");
						setWalletRestore.disabled = true;
						seedTextarea.classList.add("is-valid");
						// HERE
						setWalletRestore.disabled = false;


					} else {
						console.warn("less than 12 words");
						setWalletRestore.disabled = false;
						setWalletRestore.disabled = true;

					}
				}

				else {
					console.warn("not valid");
					seedTextarea.classList.remove("is-valid");

				}


			});
		}

		function successAnim() {

			function PathLoader(el) {
				this.el = el;
				this.strokeLength = el.getTotalLength();
				// set dash offset to 0
				this.el.style.strokeDasharray =
					this.el.style.strokeDashoffset = this.strokeLength;
			}

			PathLoader.prototype._draw = function (val) {
				this.el.style.strokeDashoffset = this.strokeLength * (1 - val);
			}

			PathLoader.prototype.setProgress = function (val, cb) {
				this._draw(val);
				if (cb && typeof cb === 'function') cb();
			}

			PathLoader.prototype.setProgressFn = function (fn) {
				if (typeof fn === 'function') fn(this);
			}

			var body = document.body,
				svg = document.querySelector('svg path');

			if (svg !== null) {
				svg = new PathLoader(svg);

				setTimeout(function () {
					document.body.classList.add('active');
					svg.setProgress(1);
				}, 200);
			}

			document.addEventListener('click', function () {

				if (document.body.classList.contains('active')) {
					document.body.classList.remove('active');
					svg.setProgress(0);
					return;
				}
				document.body.classList.add('active');
				svg.setProgress(1);
			});
		}

		function countWords(str) {
			let lngth = str.trim().split(/\s+/).length;
			console.log('countWords:', lngth)
			return lngth;
		}

		// not usded?
		async function restoreSeed() {
			console.warn('restoreSeed()')

			// check if password is set
			// #seedPassword
			const passwordInput = document.getElementById('seedPassword');

			// Check if the input is empty
			if (passwordInput.value.trim() === '') {
				passwordInput.classList.add('is-invalid');
				passwordInput.classList.remove('is-valid');
				return
			} else {
				passwordInput.classList.remove('is-invalid');
				passwordInput.classList.add('is-valid');
			}

			// CREATE WALLET:
			let seed = seedTextarea.value.trimStart().trimEnd();
			let wallet
			try {
				wallet = await ethers.Wallet.fromPhrase(seed);

			} catch (error) {
				console.log('error:', error)
			}
			w = wallet


			// ..............................................
			// if selected save password to sessionStorage
			let password = passwordInput.value.trim();
			let rememberPasswordCheckbox = document.getElementById('wrememberPassword')
			console.log('password entered!');

			if (rememberPasswordCheckbox.checked) {
				console.log("password checked");
				sessionStorage.setItem("password", password);

			} else {
				console.log("password NOT checked");
				sessionStorage.removeItem("password");

			}

			// now encrypt the json wallet and save it lo localstorage
			let encWallet = await wallet.encrypt(password)
			console.log('encWallet:', encWallet)
			localStorage.setItem('encryptedWallet', encWallet)
			await localStorage.removeItem('unbackedWallet')
			console.log('unbackedWallet deleted from localStorage')


			// RECREATE THE SIGNER
			// return
			// let decryptedWallet = ethers.Wallet.fromEncryptedJson()
			// let signer = wallet.connect
			closeModalId('#walletRestore')
			seedTextarea.value = ''
			console.log('signer:! ', wallet)

			headerNotes.innerHTML = ``
			setAddress(wallet.address)
			await loadDID(wallet)
			reloadBalances()

			// load encrypted Contacts
			let decryptedContacts;
			try{
					decryptedContacts = await decryptContacts() 
					console.warn("🎖️ decryptContacts 🎖️");
					Toast.fire({ icon: 'success', title: 'Contacts decrypted and synced!', text: '' });

					
				} catch (error) {
					console.error("🥊🥊🥊 An error occurred:", error);
					fixedToast.fire('Error', error.message, "error");

			}

			// loadDecryptedContacts(decryptedContacts)

			// let x = await decryptContacts()
			const contacts = JSON.parse(decryptedContacts);
			localStorage.setItem('contacts', JSON.stringify(contacts));
			console.log('Contacts successfully loaded into localStorage.');
			loadContactsFromLocalstorage() 


			// remove xmtp from localstorage
			const prefix = 'xmtp/dev/';
			for (let i = localStorage.length - 1; i >= 0; i--) {
				const key = localStorage.key(i);
				if (key && key.startsWith(prefix)) {
					localStorage.removeItem(key);
				}
			}
			await init(wallet)

		}


function loadDecryptedContacts(contacts){

	let contct = document.getElementById('cwContacts')
			contct.innerHTML = ''

	if (contacts) {
				console.warn('🏄‍♀️🏄‍♀️🏄‍♀️ YOU HAVE', contacts.length, 'CONTACTS in LOCALSTORAGE at loadContactsFromLocalstorage()')


				const promises = [];
				contacts.forEach((el, index) => {

					// NAME
					// username or contactname?
						// contactname // username
				// contactname: set by user in their own agenda
				// username: set by owner in their own DID
					if (el.contactname) {
						// If contactname exists, use it
						contactInfo = `<span>${el.contactname} <span>`;
						console.log('✅ contactname: ', el.contactname);
					} else if (el.username) {
						// If username exists but contactname is null or not present, use username
						contactInfo = `<span>${el.username} <span>`;
						console.log('✅ username: ', el.username);
					} else {
						// If both contactname and username are null/missing, fallback to a shortened address
						console.log('❌ No username or contactname: ', el);
						let shortAddr = `${el.address.substring(0, 6)}...${el.address.substring(38, 42)}`;
						contactInfo = `<span>${shortAddr} <span>`;
					}
						


					// AVATAR
					let avatar= "./anonym.jpg"
					if (el.avatar || null) {
						avatar = el.avatar
						console.log(' HAS AVATAR!',avatar);
					}

					// DID
					let did = el.address.startsWith("did:ius:") ? el.address : `did:ius:${el.address}`;


					// CREATE THE ELEMENT
					contct.innerHTML += `<li data-address="${el.address}" id="${el.address}" class=''> 
							<a onclick="event.stopPropagation();selectChat((this.parentElement))">  
								<img id ="${did}" src="${avatar}" alt="Avatar" class="rounded-circle"> 
									<span >${contactInfo}</span>
									<svg onclick="event.stopPropagation();editContact('${el.address}')" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="20" height="25" class='right'>
										<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"/>
										</svg>
										</a> 
										</li>`;

						})


					}
			}

// }

		/*********************************************************************************************
		.)   MANAGE DID
		**********************************************************************************************/
		// id: string; 
		// avatar: string; 
		// alias: string; 
		// privData: string; 
		// cid: string; 
		// publicKey: PublicKey;
		async function loadDID(signer) {
			console.warn(' 💒💒💒💒 loadDID()',signer)
			let did = `did:ius:${signer.address}`;
		
			// IF. READ DID 
			console.log('💬💬💬 READ YOUR DID:', did);
			let rdid = await readDIDRecord(did);
			rd = rdid;
		
			if (rdid.data == null) {
				console.warn('DID NULL, create ONE');
				let avatar = '';
				let alias = signer.address;
				let privData = '';
				let cid = '';
				try {
					const result = await createDIDRecord(did, avatar, alias, privData, cid, signer);
					if (result) {
						console.log('The DID record was created successfully.');
					} else {
						console.warn('Failed to create the DID record.');
					}
				} catch (error) {
					console.error('An error occurred while creating the DID record:', error);
				}
			} else {
				console.warn(`DID EXISTENT!:  ${rdid.data.id}`);

        // Avatar logic only if not already loaded
        // if (!document.getElementById('avatarIMG').src || document.getElementById('avatarIMG').src.endsWith('default.png')) {

			if (!document.getElementById('avatarIMG').src.startsWith("data:image/")){
            let avtr = rdid.data.avatar;
            if (avtr) {
                let avatar = avtr; // Use the raw avatar string
                localStorage.setItem('userAvatar', avatar); // Update localStorage
                try {
                    let parsedAvatar = JSON.parse(avatar);
                    document.getElementById('avatarIMG').src = parsedAvatar;
                    document.getElementById('aliasAvatar').src = parsedAvatar;
                } catch {
                    document.getElementById('avatarIMG').src = avatar;
                    document.getElementById('aliasAvatar').src = avatar;
                }
            } else {
                console.log('Avatar data is empty.');
            }
			
        }


        // localAlias or userName?
			// contactname // username
				// contactname: set by user in their own agenda
				// username: set by owner in their own DID
        let alias = rdid.data.alias;
        if (alias) {
            document.getElementById('aliasName').value = alias;
            document.getElementById('userAlias').innerText = alias;
        } else {
            console.log('aliasName data is empty.');
        }

        // ACTIVATE BUTTON TO MINT OR UPDATE
        document.getElementById('mintOrUpdate').disabled = false;
    }
}
 

		 

		async function fetchDID(did) {
			try {
				const didresult = await readDIDRecord(did);

				if (didresult.data != null) {
					console.log(did + ' HAS A RECORD!!!');
					return didresult
				} else {
					console.log(did + ' DOESN\'T HAVE A RECORD :(');
					return
				}
			} catch (error) {
				console.error('An error occurred while fetching the DID record:', error);
			}
		}

		async function fetchDIDRecord(did) {
			try {
				const didresult = await readDIDRecord(did);

				if (didresult.data) {
					console.log(`${did} HAS A RECORD!!!`);

					const avtr = didresult.data.avatar;
					if (avtr) {
						const avatar = JSON.parse(avtr);
						//   document.getElementById(did).src = avatar;
						return avatar
					}
				} else {
					console.log(`${did} DOESN'T HAVE A RECORD `);
				}
			} catch (error) {
				console.warn('Warn on DID record:', error);
				throw error;
			}
		}

		async function createDIDRecord(did, avatar, alias, privData, cid, signer) {
			console.log('Now you have the signer, do whatever you need with it:', signer);
			const db = new Polybase({ defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID", });
			const data = [did, avatar, alias, privData, cid];
			db.signer(async (data) => {
				const signature = await signer.signMessage(data);//FIXED!
				return { h: 'eth-personal-sign', sig: signature, };
			});

			const collectionReference = db.collection("STARKID");
			await collectionReference.create(data);

		}

		async function readDIDRecord(id) {
			const db = new Polybase({
				defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
			});

			const collectionReference = db.collection("STARKID");
			const record = await collectionReference.record(id).get();
			const { data } = record; // or const data = record.data
			const resultRecord = record.get();
			// console.log('resultRecord:', resultRecord)
			return resultRecord
		}

		async function deleteDID(did, signer) {
			console.log('deleteDID()')

			const db = new Polybase({
				defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
			});

			db.signer(async (did) => {
				console.log('data:', did)
				const signature = await signer.signMessage(did);
				return { h: 'eth-personal-sign', sig: signature, };
			});
			try {
				const recordData = await db
					.collection("STARKID")
					.record(did)
					.call("deleteDID");
			} catch (error) {
				console.error("An error occurred:", error);
			}
			return true

		}

		async function updateAvatarDID(did, newdata, signer) {
			console.log('updateDID()')

			const db = new Polybase({
				defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
			});

			// const newdatab = [did, newdata];

			db.signer(async (newdata) => {
				console.log('data:', newdata)
				const signature = await signer.signMessage(newdata);
				return { h: 'eth-personal-sign', sig: signature, };
			});
			try {
				const recordData = await db
					.collection("STARKID")
					.record(did)
					.call("updateAvatar", [newdata]);
				console.log("recordData:", recordData);
				console.warn('suscesfully updated DID')
				Toast.fire({ icon: 'success', title: 'suscesfully updated DID' });
			// updatelocalstorage/
			localStorage.setItem('userAvatar', newdata);

			} catch (error) {
				console.error("An error occurred:", error);
				fixedToast.fire('Error', error.message, "error");

			}
			return true

		}

		async function updateAliasDID(did, newdata, signer) {
			console.log('updateDID()')

			const db = new Polybase({
				defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
			});

			// const newdatab = [did, newdata];

			db.signer(async (newdata) => {
				console.log('data:', newdata)
				const signature = await signer.signMessage(newdata);
				return { h: 'eth-personal-sign', sig: signature, };
			});
			try {
				const recordData = await db
					.collection("STARKID")
					.record(did)
					.call("updateAlias", [newdata]);
				console.log("recordData:", recordData);
			} catch (error) {
				console.error("An error occurred:", error);
			}
			return true
		}



		async function updatePrivDataDID(did, newdata, signer) {
			console.log('updateDID()')

			const db = new Polybase({
				defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
			});

			// const newdatab = [did, newdata];

			db.signer(async (newdata) => {
				console.log('data:', newdata)
				const signature = await signer.signMessage(newdata);
				return { h: 'eth-personal-sign', sig: signature, };
			});
			try {
				const recordData = await db
					.collection("STARKID")
					.record(did)
					.call("updatePrivData", [newdata]);
				console.log("recordData:", recordData);
			} catch (error) {
				console.error("An error occurred:", error);
			}
			return true


		}


		async function updateDIDdocs(id, newdocs) {
			console.log('updateDIDdocs()')

			//   let signer = await getLocalWalletSigner();
			let signer = await getSigner()

			if (!signer) {
				console.log('Handle case where signer is not obtained');
			}
			else {
				console.log('Now you have the signer, do whatever you need with it:', signer);
				// defaultNamespace: "pk/0xee1b340c80295bb60ada66e0396a44b70c479a857c357b37883d27efe030aaf8baf25fde75eaf8881bb6c0f34fac20dbf6896fc373d5835e43ffe01f216feab9/IURISNATURALIS" 
				const db = new Polybase({
					defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
				});

				db.signer(async (newdocs) => {
					console.log('docs to sign:', newdocs)

					const hash = ethers.sha256(ethers.toUtf8Bytes(newdocs));
					console.log('sha-256', hash);

					const signature = await signer.signMessage(newdocs);
					console.log('signature:', signature)

					return { h: 'eth-personal-sign', sig: signature, };
				});

				try {
					const recordData = await db
						.collection("STARKID")
						.record(id)
						.call("updateCID", [newdocs]);
					console.log(" updateCID:", recordData);

				} catch (error) {
					console.error("An error occurred:", error);
					console.error("Error:", error.reason);
					fixedToast.fire('Error', error.message, "error");
				}
			}
		}



		/*********************************************************************************************
		.)   ENCRYPT FUNCITONS
		**********************************************************************************************/

		async function encryptPrivkey(privkey, pubkey, toEncrypt) {
			console.log('encryptPrivkey()', toEncrypt)
			// 0. coniverte en estring la eth priv key
			const secretMessage = EthCrypto.cipher.stringify(toEncrypt);
			console.log('ethPrivKeyString: ', secretMessage)

			// 1.
			const signature = EthCrypto.sign(privkey, EthCrypto.hash.keccak256(secretMessage));
			console.log('signature: ', signature)

			// 2.
			const payload = { message: secretMessage, signature };

			// 3.
			const encrypted = await EthCrypto.encryptWithPublicKey(pubkey, JSON.stringify(payload));

			console.log('Alice encrypted ETH private key to store in registry:', encrypted)

			// 4.
			// we convert the object into a smaller string-representation
			const encryptedString = EthCrypto.cipher.stringify(encrypted);
			console.log('Alice encrypted ETH private key to store in registry STRING: ', encryptedString)
			// return encryptedString
			return encryptedString

		}

		async function decryptPrivData(privkey, pubkey, toDecrypt) {
			console.log('encryptPrivkey()', toDecrypt)

			// ---------------
			// DECRYPTING
			// we parse the string into the object again
			const encryptedObject = EthCrypto.cipher.parse(toDecrypt);
			const decrypted = await EthCrypto.decryptWithPrivateKey(privkey, encryptedObject);
			const decryptedPayload = JSON.parse(decrypted);
			console.log('DECRYPRED✅!!!', decryptedPayload)
			// check signature
			const senderAddress = EthCrypto.recover(decryptedPayload.signature, EthCrypto.hash.keccak256(decryptedPayload.message));
			console.log('ETH Private key stored  by  ' + senderAddress + '<br>is: ' + decryptedPayload.message);
			// result.innerHTML = '<br><br>✅✅✅ STARKNET Private key DECRYPTED  ✅✅✅  by  ' + senderAddress + ' is: <br> ' + decryptedPayload.message

			return [decryptedPayload.message, senderAddress]


		}




		/*********************************************************************************************
		.)   UPDATE IMAGE AVATAR
		**********************************************************************************************/

		avatarIMG.onclick = function (e) {
			console.log('avatarIMG clicked')
			e.preventDefault()

			openModalId('#didManagerModal')
			// loadCroppedImg()
			loadDocs();

		};

		changeAvatar.onclick = function (e) {
			console.log('aliasAvatar clicked')
			e.preventDefault()

			loadCroppedImg()

		};

		async function compressImage(imageSrc, maxSizeKB) {
			return new Promise((resolve, reject) => {
				const img = new Image();
				img.onload = function () {
					const canvas = document.createElement('canvas');
					const ctx = canvas.getContext('2d');

					// Calculate new dimensions to maintain aspect ratio
					const MAX_WIDTH = 800;
					const MAX_HEIGHT = 600;
					let width = img.width;
					let height = img.height;
					if (width > height) {
						if (width > MAX_WIDTH) {
							height *= MAX_WIDTH / width;
							width = MAX_WIDTH;
						}
					} else {
						if (height > MAX_HEIGHT) {
							width *= MAX_HEIGHT / height;
							height = MAX_HEIGHT;
						}
					}

					// Set canvas dimensions
					canvas.width = width;
					canvas.height = height;

					// Draw image on canvas
					ctx.drawImage(img, 0, 0, width, height);

					// Convert canvas to Blob and compress to target size
					canvas.toBlob(function (blob) {
						// Check if compressed image is within target size
						if (blob.size / 1024 <= maxSizeKB) {
							// Resolve with the compressed data URL
							resolve(canvas.toDataURL());
						} else {
							// Reject if compressed image size exceeds target size
							reject('Compressed image size exceeds the specified limit');
						}
					}, 'image/jpeg', 0.7); // Adjust the quality factor (0.7 here) to achieve desired compression level
				};
				img.src = imageSrc;
			});
		}

		async function loadCroppedImg() {
			console.log('loadCroppedImg()');

			await avatarIMGfile.click();
			let previewsrc;

			avatarIMGfile.onchange = async function () {
				if (avatarIMGfile.files.length == 1) {
					const data = this.files[0];
					const name = data.name;

					// Read the file and get its base64 data
					let reader = new FileReader();
					reader.readAsDataURL(data);

					reader.onload = async function () {
						previewsrc = reader.result;

						// Compress the image
						const compressedDataUrl = await compressImage(previewsrc, 100); // 100KB limit

						// Display the image in a SweetAlert2 popup
						Swal.fire({
							html: `
                        <img id="preview" src="${compressedDataUrl}" style="display:none">
                        <div>
                            <img id="cropperjs" src="${compressedDataUrl}">
                        </div>
                    `,
							allowOutsideClick: () => {
								const popup = Swal.getPopup();
								popup.classList.remove('swal2-show');
								setTimeout(() => {
									popup.classList.add('animate__animated', 'animate__headShake');
								});
								setTimeout(() => {
									popup.classList.remove('animate__animated', 'animate__headShake');
								}, 500);
								return false;
							},
							willOpen: () => {
								const image = document.querySelector('#cropperjs');
								// const cropper = new Cropper(image, {
								cropper = new Cropper(image, {
									// aspectRatio: '4:3',
									aspectRatio: 1 / 1,
									viewMode: 1,
									crop: throttle(function () {
										const croppedCanvas = cropper.getCroppedCanvas();
										// console.log('croppedCanvas:', croppedCanvas);

										const preview = document.querySelector('#preview');
										preview.src = croppedCanvas.toDataURL();

										let cropperinfo = cropper.getContainerData()
										// console.log("cropperinfo:",cropperinfo)
									}, 25),
								});
							},
							preConfirm: () => {
								const popup = Swal.getPopup();
								if (popup) {
									const previewElement = popup.querySelector('#preview'); // Assuming preview is the ID of the image element
									if (previewElement instanceof HTMLImageElement) {
										return previewElement.src;
									}
								}
							},
						}).then(async function (result) {
							avatarIMG.src = result.value;
							aliasAvatar.src = result.value;
							let b64 = JSON.stringify(result.value);
							console.log('b64 image:', b64);
							localStorage.setItem('avatar', b64);
							avatarIMG.style.display = 'block';
							// Toast.fire('Avatar added', '', "success");


							// ...........................................................................................
							// 3.RECORD TO ZKROLLUP DB
							// ..........................................................................................

							let avatar = localStorage.getItem('avatar');
							let cid = '';

							// ------------------------------------
							// GET SIGNER
							let presigner = await getSigner()
							let provider = new ethers.JsonRpcProvider(`${optionsList[0].API}`); //v5
							let signer = presigner.connect(provider);
							console.log('SIGNER!:', signer);
							let did = `did:ius:${signer.address}`
							console.log('DID: ', did)

							// ---------------

							try {
								console.log('creating did RECORD, signer', signer)
								await updateAvatarDID(did, avatar, signer)
							} catch (error) {
								console.error('An error occurred while creating DID record:', error);
								return
							}

							// REMOVE FROM LOCALSTORAGE
							localStorage.removeItem('avatar');
							console.warn('AVATAR REMOVED FROM LOCALSTORAGE!🚫')


						});
					};
				}
			};
		}





		/*********************************************************************************************
		.)  MINT OR UPDATE ONCHAIN DID
		**********************************************************************************************/

		async function mintOrUpdate() {
			console.log('mintOrUpdate()')

			openModalId('#didMinterModal')

			return
			// Example CID to register
			const cid = "QmYwAPJzv5CZsnAztbqiXLypCQzqJGdUJwHThYro4Mwdd2";

			// Call the function
			await registerOnchainDID(cid);

		}


		async function registerOnchainDID(cid) {

			const provider = new ethers.JsonRpcProvider(optionsList[0].API);
			let chatETHPrivKey = localStorage.getItem('chatETHPrivKey');
			let signer = await new ethers.Wallet(chatETHPrivKey)
			const contractAddress = optionsList[0].REGISTRY_CONTRACT_ADDRESS
			const contractABI = [
				"function registerDID(string memory _cid) public",
				"event DIDRegistered(bytes32 indexed didHash, string cid)"
			];


			const connectedSigner = await signer.connect(provider);

			// Create contract instance
			const contract = new ethers.Contract(contractAddress, contractABI, connectedSigner);


			try {
				// Call the registerDID function
				const tx = await contract.registerDID(cid);

				console.log("Transaction sent:", tx.hash);

				// Wait for the transaction to be mined
				const receipt = await tx.wait();
				console.log("Transaction mined:", receipt);

				Swal.fire({
					icon: "success",
					title: "Done",
					text: "Tx succesfull!",
					footer: `<a target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/tx/${receipt.hash}">Tx link</a>`
				});


			} catch (error) {
				console.error("Error registering DID:", error);
				console.error("Error message:", error.error.message);
				e = error;
			}
		}


		async function updateOnchainDID(cid) {

			const provider = new ethers.JsonRpcProvider(optionsList[0].API);
			let chatETHPrivKey = localStorage.getItem('chatETHPrivKey');
			let signer = await new ethers.Wallet(chatETHPrivKey)
			const contractAddress = optionsList[0].REGISTRY_CONTRACT_ADDRESS
			const contractABI = [
				"function registerDID(string memory _cid) public",
				"event DIDRegistered(bytes32 indexed didHash, string cid)"
			];


			const connectedSigner = await signer.connect(provider);

			// Create contract instance
			const contract = new ethers.Contract(contractAddress, contractABI, connectedSigner);


			try {
				// Call the registerDID function
				const tx = await contract.registerDID(cid);

				console.log("Transaction sent:", tx.hash);

				// Wait for the transaction to be mined
				const receipt = await tx.wait();
				console.log("Transaction mined:", receipt);

				Swal.fire({
					icon: "success",
					title: "Done",
					text: "Tx succesfull!",
					footer: `<a target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/tx/${receipt.hash}">Tx link</a>`
				});


			} catch (error) {
				console.error("Error registering DID:", error);
			}
		}


		async function getDID() {
			const provider = new ethers.JsonRpcProvider(optionsList[0].API);
			let chatETHPrivKey = localStorage.getItem('chatETHPrivKey');
			let signer = await new ethers.Wallet(chatETHPrivKey)
			const contractAddress = optionsList[0].REGISTRY_CONTRACT_ADDRESS
			const contractABI = ["function cids(address) view returns (string)"];

			// Create contract instance
			const contract = new ethers.Contract(contractAddress, contractABI, provider);

			// Address to query
			let addressToQuery = signer.address;
			try {
				// Call the cids function
				const cid = await contract.cids(addressToQuery);
				console.log("CID:", cid);

			} catch (error) {
				console.error("Error querying CID:", error);
			}
		}





		/*********************************************************************************************
		.)  BALANCE
		**********************************************************************************************/

		async function getRandomProvider() {
			// console.log('getRandomProvider(#5879)')
			let isCurrentProvider = localStorage.getItem('currentProvider');

			if (isCurrentProvider !== null) {
				// console.log('currentProvider exists:', isCurrentProvider);
			} else {
				console.warn('📛📛📛 📛📛📛currentProvider does not exist', isCurrentProvider);
				// return
			}


			// get index
			let preferredIndex = localStorage.getItem('preferredTokenIndex');
			if (preferredIndex === null) {
				preferredIndex = 0;
			} else {
				preferredIndex = parseInt(preferredIndex, 10); // Convert the stored value to an integer
			}

			// get token data
			let storedData = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];
			let preferredToken = storedData[preferredIndex];

			// get random provider
			const length = preferredToken.rpcs.length;
			const randomnumber = Math.floor(Math.random() * length);
			const selectedProvider = preferredToken.rpcs[randomnumber];
			console.log('⚙️ selectedProvider:', selectedProvider, 'from ', length, 'providers.');

			// localStorage.setItem('currentProvider', selectedProvider)
			return selectedProvider
		}




		function lock() {
			console.log('lock()')
			document.getElementById("loader").style.display = "none";//flex
			lockscreen.style.display = 'flex'
			closeModalId('#settingsModal')
			document.querySelector(".sidebar").classList.remove("isOpen");
			document.querySelector(".overlay").classList.remove("overlayisOpen");
			sessionStorage.removeItem('password')
		}

		/*********************************************************************************************
	  .) GET PROVIDERS BY CHAIN ID FUNCTION
	  **********************************************************************************************/

		async function getRpcListByChainId(chainId) {
    try {
        // Step 1: Fetch the JSON data
        const response = await fetch("chainsv1.json");
        
        // Step 2: Parse the JSON data into a JavaScript object
        const chains = await response.json();
        
        // Step 3: Find the chain with the matching chainId
        const chain = chains.find(chain => chain.chainId === chainId);
        
        // Step 4: Return the RPC list if the chain is found
        if (chain) {
            return chain.rpc;
        } else {
            throw new Error(`No chain found with chainId: ${chainId}`);
        }
    } catch (error) {
        console.error("Error fetching or processing data:", error);
        return null;
    }
}

// Example usage:
// (async () => {
//     const chainId = 1; // Ethereum Mainnet
//     const rpcList = await getRpcListByChainId(chainId);
    
//     if (rpcList) {
//         console.log(`RPC List for chainId ${chainId}:`, rpcList);
//     } else {
//         console.log(`No RPC list found for chainId ${chainId}`);
//     }
// })();

		/*********************************************************************************************
	  .) BALANCES
	  **********************************************************************************************/
		async function reloadBalances(){
			console.warn('reloadBalances()')

			let addr = document.getElementById('yourAddress').getAttribute('address');
			let balance = await checkERC20Balance(addr)
			let gasBalance = await checkGasBalance(addr)
            let storedTokenType = localStorage.getItem('selectedTokenType');
			// -------------------------
			// .)  NATIVE 
			// -------------------------
			if (storedTokenType === 'native') {
				console.warn('💛💛💛 RE-LOADING NATIVE  ')
				populateBalances(gasBalance)
			}
			// -------------------------
			// .)  ERC20 
			// -------------------------
			if (storedTokenType === 'erc20') {
				console.warn('💚💚💚 RE-LOADING ERC20')
				const lastUXInfo = getLastUXInfo();
				
				if (lastUXInfo) {
				  console.log("⏱️Preloaded data:", lastUXInfo);
						setAddress(lastUXInfo.addr)
						populateBalances(lastUXInfo.chainName,lastUXInfo.chainId, lastUXInfo.tokenName, lastUXInfo.explorer, lastUXInfo.addr, gasBalance, balance, lastUXInfo.contractAddr) 
				}
				// populateBalances(gasBalance,balance)
	
			}
	
	return
			
			
		}



		async function checkGasBalance(address) {
			console.warn('💐💐💐checkGasBalance()')
			let token = await getPreferredToken()
			let selectedProvider = await selectRandomProvider(token.rpcs)
			let provider
			try {
				provider = await new ethers.JsonRpcProvider(selectedProvider);
				console.log("🤓Provider initialized successfully:", provider);
			} catch (error) { console.warn("🤬Failed to initialize provider:", error.message || error); }
			
			// let balance = await provider.getBalance(address);

			let balance
			try { balance = await provider.getBalance(address); } 
			catch (error) { console.error('Error checking balance:', error.reason); return null; }
			const gasBalance = ethers.formatEther(balance);
			console.log(`GAS Balance: ${gasBalance} `);
			return gasBalance

		}


		async function checkERC20Balance(userAddress) {
			console.log('💛💛💛💛 checkERC20Balance() of ', userAddress)
			// ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
			// REARMAR , primero llamar de localstorage al PREFERED_TOKEN
			// ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
			let pt = localStorage.getItem('PREFERRED_TOKEN')

			// Split the string by the '-' delimiter
			const parts = pt.split('-');

			// Extract the two parts
			const chainId = parts[0]; // '421614'
			const contractAddr = parts[1]; // '0xFb1cb5a6dADDcE008d86f72057265A3afC82d539'


			const rpcList = await getRpcListByChainId(Number(chainId));
			console.log('rpcList:', rpcList)
			// const length = rpcList.length;
			// const randomnumber = Math.floor(Math.random() * length);
			// // const selectedProvider = rpcList[randomnumber];
			let selectedProvider = await selectRandomProvider(rpcList)

			// write selectef provider to localstorage (then use localstorage first)
			// alert(selectedProvider)

			// ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
			// BORRADO POR DESUSO?(CONFIRMAR)
			// ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
			// Retrieve selector index  from localStorage
			// let preferredIndex = localStorage.getItem('preferredTokenIndex');
			// if (preferredIndex === null) {
			// 	preferredIndex = 0;
			// } else {
			// 	preferredIndex = parseInt(preferredIndex, 10); // Convert the stored value to an integer
			// }

			// // // Retrieve the stored data from localStorage
			// let storedData = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];

			// // // If the preferred index is within the range of stored tokens, return the corresponding token details
			// if (storedData[preferredIndex]) {
			// 	preferredToken = storedData[preferredIndex];
			// 	pref = preferredToken
			// } else {
			// 	console.log('some problem in checkERC20Balance')
			// 	return
			// }

			// const length = preferredToken.rpcs.length;
			// const randomnumber = Math.floor(Math.random() * length);
			// const selectedProvider = preferredToken.rpcs[randomnumber];
			// console.log('selectedProvider:', selectedProvider);
			// ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
			// ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
			// ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


			let provider;
			try { provider = await new ethers.JsonRpcProvider(selectedProvider); }
			catch (error) { console.warn('error creating provider', error) }
			// let contractAddr = preferredToken.contractAddr
			const tokenContract = await new ethers.Contract(contractAddr, erc20Abi, provider);
			t = tokenContract;
			const formattedAddress = ethers.getAddress(userAddress);
			let balance;
			try { balance = await tokenContract.balanceOf(formattedAddress); }
			catch (error) {
				if (error.message.includes('Failed to fetch')) { console.warn('Error getting balance: Network or fetch issue. refetch?'); }
				else { console.warn('Error getting balance:', error); }
			}
			b = balance
			const decimals = await tokenContract.decimals();
			console.log('decimals:', decimals)
			d = decimals
			let formatedBalance = ethers.formatUnits(balance, decimals);
			console.warn(`ERC-20 Balance of ${preferredToken.tokenName}: ${formatedBalance} `);
			return formatedBalance
			try {
				return formatedBalance
			} catch (error) {

				console.error('Error checking balance:', error);
				return null;
			}

		}



		async function checkNetwork() {
			console.log('CHEKGINS NETWORK!')
			let provider = await new ethers.JsonRpcProvider(`${optionsList[0].API}`);
			var selectElement = document.getElementById('userData');
			try {
				const blockNumber = await provider.getBlockNumber();
				console.log('Connected to network. Latest block number:', blockNumber);
				selectElement.style.color = 'green';
				return true
			} catch (error) {
				console.error('Error connecting to network:', error.message);
				selectElement.style.color = 'red';

				return false
			}

		}



		/*********************************************************************************************
	  .) TOKEN
	  **********************************************************************************************/
	  async function providerChecker(providerurl) {
		  const provider = new ethers.JsonRpcProvider(providerurl);
		  try {
			const blockNumber = await provider.getBlockNumber();
			console.log('🥶🥶🥶Connected successfully. Current block number:', blockNumber);
			return provider; // Successfully connected provider
		  } catch (error) {
			console.error('Failed to connect:', error.message);
			return null; // Indicate failure to connect
		  }
		}
		  
async function selectRandomProvider(rpcs) {
  console.log('selectRandomProvider', rpcs);
  
  while (rpcs.length > 0) {
    // Select a random provider
    const randomIndex = Math.floor(Math.random() * rpcs.length);
    let selectedProvider = rpcs[randomIndex];
    console.log('👁️‍🗨️ Selected Provider 👁️‍🗨️:', selectedProvider);
    // alert('👁️‍🗨️ Selected Provider 👁️‍🗨️:'+ selectedProvider);

    // Replace placeholders with actual API keys if necessary
    if (selectedProvider.includes("INFURA_API_KEY")) {
      const INFURA_API_KEY = globalOptionsList[0].INFURA_API_KEY;
      selectedProvider = `https://arbitrum-mainnet.infura.io/v3/${INFURA_API_KEY}`;
      console.log("INFURA URL:", selectedProvider);
    } else if (selectedProvider.includes("ALCHEMY_API_KEY")) {
      const ALCHEMY_API_KEY = globalOptionsList[0].ALCHEMY_API_KEY;
      selectedProvider = `https://arb-mainnet.g.alchemy.com/v2/${ALCHEMY_API_KEY}`;
      console.log("ALCHEMY URL:", selectedProvider);
    } else {
      console.log("OK! URL does not contain INFURA_API_KEY or ALCHEMY_API_KEY placeholder.");
    }

    // Try to connect to the selected provider
    let provider = await providerChecker(selectedProvider);

    if (provider) {
      console.log('✅ Connected to provider');
    //   console.log('✅ Successfully connected to provider:',provider);
    //   return provider; // Exit and return the working provider
      return selectedProvider; // Exit and return the working provider

    } else {
      console.log('❌ Failed to connect to provider. Removing provider from the list and retrying...');
      rpcs.splice(randomIndex, 1); // Remove the failed provider from the list
    }

  }

  console.error('⚠️ All providers failed to connect!');
  alert('⚠️ All providers failed to connect!');
  Swal.fire({
									title: 'Token doesn\'t exist',
									text: 'What should I do?',
									icon: 'warning',
									showCancelButton: true,
									confirmButtonText: 'Reset to Default',
									cancelButtonText: 'Ignore',
									reverseButtons: true,
								  }).then((result) => {
									if (result.isConfirmed) {
									  // Reset to default
									  console.log('Resetting to default...');
									setDefaultTokens ()
									// return									  
									  erc20Selector.selectedIndex = 0; // Example: Reset to the first option
									} else if (result.dismiss === Swal.DismissReason.cancel) {
									  // Ignore
									  console.log('Ignoring the issue...');
									  // Add your logic for ignoring the issue here
									}
								  });

  return null; // No working provider found
}

	       

// #####################
// NEW FUNCIONS

 

async function fetchBalance(addr,provider,chainId) {
    const localStorageKey = `balance_${addr}_${chainId}`;
    const staleTime = 5 * 60 * 1000; // 5 minutes in milliseconds

    // Load balance from localStorage
    const cachedData = localStorage.getItem(localStorageKey);
    if (cachedData) {
        const { balance, timestamp } = JSON.parse(cachedData);

        // Check if cached data is still fresh
        if (Date.now() - timestamp < staleTime) {
            return ethers.toBigInt(balance); // Return cached balance as BigNumber
        }
    }

    // Fetch fresh balance from provider
    try {
        const freshBalance = await provider.getBalance(addr);

        // Save the fresh balance to localStorage
        const dataToCache = {
            balance: freshBalance.toString(), // Convert BigNumber to string
            timestamp: Date.now(),
        };
        localStorage.setItem(localStorageKey, JSON.stringify(dataToCache));

        return freshBalance;
    } catch (error) {
        console.error('Error checking balance:', error.reason);
        return null;
    }
}

function saveBalanceToLocalStorage(addr, balance) {
    const data = {
        balance: balance.toString(), // Convert BigNumber to string for storage
        timestamp: Date.now(),      // Save the timestamp to track freshness
    };
    localStorage.setItem(`balance_${addr}`, JSON.stringify(data));
}

function loadBalanceFromLocalStorage(addr) {
    const data = localStorage.getItem(`balance_${addr}`);
    if (data) {
        return JSON.parse(data);
    }
    return null;
}

async function updateBalance(addr) {
    const balance = await fetchBalance(addr);
    if (balance !== null) {
        saveBalanceToLocalStorage(addr, balance);
        updateUIWithBalance(ethers.formatEther(balance)); // Update UI with new balance
    }
}


// #####################


async function loadToken(addr) {
    console.warn('🏦loadToken()')

    if (!addr) { // Check if addr is undefined, null, or an empty value
        console.log('Address not provided');
        addr = userAddress
    }

    let token = await getPreferredToken()
	te = token

    let selectedProvider = await selectRandomProvider(token.rpcs)
	selp= selectedProvider;

    let provider;
    try { provider = await new ethers.JsonRpcProvider(selectedProvider); } 
    catch (error) { 
		console.warn("🤬Failed to initialize provider:", error.message || error); 
		fixToast.fire('Error', error.message, "error"); 
		e=error;
		return
	}
    console.log("🤓Provider initialized successfully at loadToken():", provider);
	 document.querySelectorAll('.eth').innerHTML= `<span class="bottom">🤓Provider initialized <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div>`

	let balance = await fetchBalance(addr, provider);
    const gasBalance = ethers.formatEther(balance);
    console.log(`💛💛💛 GAS Balance: ${gasBalance} `);

    let chainName = token.chainName
    let chainId = token.chainId
    let tokenName = token.tokenName
    let explorerLengh = token.explorers.length;
    let randomExplorer = Math.floor(Math.random() * explorerLengh);
    let explorer = token.explorers[randomExplorer].url;
    console.log('explorer:', explorer)

	if(token.contractAddr ==='' || token.contractAddr ==='nativeToken'){
		// console.warn('💛💛💛💛 IS NATIVE ')
		console.log('populateBalances(💛💛💛💛NATIVE):',chainName,chainId, tokenName, explorer, addr, gasBalance) 
		populateBalances(chainName,chainId, tokenName, explorer,addr, gasBalance) 
		saveLastUXInfo({ chainName: chainName, chainId: chainId, tokenName: tokenName, explorer: explorer, addr:addr, gasBalance: gasBalance});

	}
	if( token.contractAddr !='nativeToken'){

		// console.warn('💛💛💛💛 IS ERC20 ')
		let contractAddr = token.contractAddr
		let tokenContract;
		try { tokenContract = await new ethers.Contract(contractAddr, erc20Abi, provider); } 
		catch (error) { console.error("Failed to initialize token contract:", error.message || error); }
		// console.log('tokenContract:', tokenContract);
		let erc20balance
		try { erc20balance = await tokenContract.balanceOf(addr); }
		catch (error) { console.warn("🤬Failed to get ERC20 Balance:", error.message || error); }

				const decimals = await tokenContract.decimals();
				console.log('decimals:', decimals);
				let formatedBalance = ethers.formatUnits(erc20balance, decimals);

		// console.log("ERC20 Balance gotten successfully:", erc20balance);
		console.log('populateBalances(💛💛💛💛 ERC20):',chainName,chainId, tokenName, explorer, addr, gasBalance, erc20balance, contractAddr) 
		populateBalances(chainName,chainId, tokenName, explorer, addr, gasBalance, formatedBalance, contractAddr) 
		saveLastUXInfo({ chainName: chainName, chainId: chainId, tokenName: tokenName, explorer: explorer, addr:addr, gasBalance: gasBalance, formatedBalance: formatedBalance, contractAddr: contractAddr });

	}


    }

	
    function populateBalances(chainName,chainId, tokenName, explorer, address,  gasBal, tokenBal, contractAddr) {
		console.warn(chainName,chainId, tokenName, explorer, address,  gasBal, tokenBal, contractAddr) 

		if (tokenBal === undefined) {
        console.log('means its a native token', gasBal,tokenBal)

		// round balance for ui
		const rounded = Math.round(gasBal * 100000) / 100000; // Multiply and divide by 10^5


        let link = explorer + '/address/'+address;
        const selectElements = document.querySelectorAll('.tokenBalance');
        selectElements.forEach(balanceDisplayer => {
			// balanceDisplayer.innerHTML = `loading...`
			console.log('FILLING BALANCE FOR NATIVE',chainName,chainId, tokenName ,gasBal, link)


            balanceDisplayer.innerHTML =    `
			<span class="top">${chainName} (${chainId})</span>
			<span class="bal" > ${rounded}</span>
			<span class="eth">${tokenName}</span>
			`
		


        });

    }
    else{
        console.log('means its a ERC20 token',tokenBal)

        let linktokenbalance = explorer + '/address/'+contractAddr;
        let linkgasbalance = explorer + '/address/'+address;
        let linktoken = explorer + '/token/'+contractAddr;
       
        const selectElements = document.querySelectorAll('.tokenBalance');
        selectElements.forEach(balanceDisplayer => {


// continuar esta idea de ponerlo encima de tokenBalances/
			// <select class="tokenBalanceSelector top token-selector"  > </select>
            balanceDisplayer.innerHTML =`
			<span class="top">${chainName} (${chainId})</span>
			<span class="bal" > ${tokenBal} </span>
			<span class="eth">${tokenName}</span> 
			<span class="bottom"> gas: ${gasBal} </span>
			`

			// CON LINKS
			// `
			// <span class="top">${chainName} (${chainId})</span>
			// <span class="bal" >
            //     <a class="" target="_blank" rel="noopener noreferrer" href="${linktokenbalance}">${tokenBal}</a>
			// 	</span>
			// <span class="eth">
            //     <a class="" target="_blank" rel="noopener noreferrer" href="${linktoken}">${tokenName}</a>
			// 	</span>
            // <span class="bottom">
            //     <a class="" target="_blank" rel="noopener noreferrer" href="${linkgasbalance}">gas: ${gasBal}</a>
            // </span>
			// `

 
        });
    }
}


	 

		function addToken() {
			closeModalId('#defaultTokenModal')
			openModalId('#addNewTokenModal')
		}





		/*********************************************************************************************
	  .) AUTOCOMPLETE JS -ADD TOKENS
	  **********************************************************************************************/

		const autoCompleteJS = new autoComplete({
			data: {
				src: async () => {
					try {
						document
							.getElementById("autoComplete")
							.setAttribute("placeholder", "Loading...");
						// const source = await fetch( "https://chainid.network/chains.json" );
						const source = await fetch("chainsv1.json");
						const data = await source.json();
						document
							.getElementById("autoComplete")
							.setAttribute("placeholder", autoCompleteJS.placeHolder);
						return data;
					} catch (error) {
						return error;
					}
				},
				keys: ["name", "chainId"],
				cache: true,
				filter: (list) => {
					const filteredResults = Array.from(
						new Set(list.map((value) => value.match))
					).map((token) => {
						return list.find((value) => value.match === token);
					});

					return filteredResults;
				}
			},
			placeHolder: "Search for name or chainID!",
			resultsList: {
				element: (list, data) => {
					const info = document.createElement("p");
					if (data.results.length > 0) {
						info.innerHTML = `Displaying <strong>${data.results.length}</strong> out of <strong>${data.matches.length}</strong> results`;
					} else {
						info.innerHTML = `Found <strong>${data.matches.length}</strong> matching results for <strong>"${data.query}"</strong>`;
					}
					list.prepend(info);
				},
				noResults: true,
				maxResults: 65,
				tabSelect: true,
				// searchEngine: "loose"
				searchEngine: "strict"
			},
			resultItem: {
				element: (item, data) => {
					item.style = "display: flex; justify-content: space-between;";
					item.innerHTML = `
                      <span class="hoverable" style="text-overflow: ellipsis; white-space: nowrap; overflow: hidden; cursor: pointer;">
                            ${data.match}
                        </span>
                        <span style="display: flex; align-items: center; font-size: 13px; font-weight: 100; text-transform: uppercase; color: rgba(0,0,0,.2);">
                            ${data.key}
                        </span>`;
				},
				highlight: true,
			},
			events: {
				input: {
					focus: () => {
						if (autoCompleteJS.input.value.length) {
							console.log('autoCompleteJS value', autoCompleteJS.input.value)
							autoCompleteJS.start();
						}
					}
				}
			}
		});



		autoCompleteJS.input.addEventListener("selection", function (event) {
			console.warn('SELECT: ', event.detail.selection)
			selectionResult.style.display = 'block'
			const feedback = event.detail;
			let resultado = event.detail.selection.value;
			r = resultado;
			// localStorage.setItem('chainFeedback', JSON.stringify(feedback))
			localStorage.setItem('chainResult', JSON.stringify(event.detail.selection))
			f = feedback
			autoCompleteJS.input.blur();
			const selection = feedback.selection.value[feedback.selection.key];

			// ----
			//   const httpsRpcAddresses = resultado.rpc.filter((address) =>
			//     address.startsWith("https://") && !address.includes("${INFURA_API_KEY}")
			//   );


			// const INFURA_API_KEY = "9219faae2bac4d24b95c2d967b22005a"; // Replace with your actual Infura API key
			const httpsRpcAddresses = resultado.rpc.map((address) => {
				if (address.startsWith("https://") && address.includes("${INFURA_API_KEY}")) {
					return address.replace("${INFURA_API_KEY}", INFURA_API_KEY);
				}
				return address;
			});



			const rpclength = httpsRpcAddresses.length;
			const randomnumber = Math.floor(Math.random() * rpclength);
			const selectedProvider = httpsRpcAddresses[randomnumber];
			console.log('selectedProvider:', selectedProvider);

			document.getElementById("selectionResult").innerHTML = `
			<strong>Chain:</strong> ${resultado.chain}
			<br><strong>Name:</strong> ${resultado.name}
			<br><strong>chainId:</strong> ${resultado.chainId}
			<br><strong>Short:</strong> ${resultado.shortName}
			<br><strong>Explorers[${resultado.explorers.length}]:</strong> ${resultado.explorers[0].url}
			<br><strong>Gas token:</strong> ${resultado.nativeCurrency.name}
			<br> <strong>RPC [${rpclength}]:</strong> ${httpsRpcAddresses[randomnumber]}
			<br><strong>Native Currency:</strong> ${resultado.nativeCurrency.symbol}`;

			autoCompleteJS.input.value = selection;
			console.warn('selection REDULT: ', selection)
			console.log("feedback: ", feedback);
			console.warn("resultado: ", resultado);


			erc20SetContract.style.display = 'inline'
			addNativeToken.style.display = 'inline'


		});



		const action = (action) => {
			console.log('action()')
			const title = document.querySelector("h5");
			const selection = document.querySelector(".selection");

			if (action === "dim") {
				title.style.opacity = 1;
				// mode.style.opacity = 1;
				selection.style.opacity = 1;
			} else {
				title.style.opacity = 0.3;
				// mode.style.opacity = 0.2;
				selection.style.opacity = 0.1;
			}
		};



		["focus", "blur"].forEach((eventType) => {
			autoCompleteJS.input.addEventListener(eventType, () => {
				if (eventType === "blur") {
					action("dim");
				} else if (eventType === "focus") {
					action("light");
				}
			});
		});



	
		/*********************************************************************************************
		 .) POPULATE TOKENS
		 **********************************************************************************************/

		async function createProv() {
			console.log('createProv()')
			// let feedback = JSON.parse(localStorage.getItem('chainFeedback'))
			let result = JSON.parse(localStorage.getItem('chainResult'))
			const httpsRpcAddresses = result.value.rpc.filter((address) => address.startsWith("https://") && !address.includes("${INFURA_API_KEY}"));
			// const httpsRpcAddresses = feedback.results[0].value.rpc.filter((address) => address.startsWith("https://") && !address.includes("${INFURA_API_KEY}"));
			const length = httpsRpcAddresses.length;
			const randomnumber = Math.floor(Math.random() * length);
			const selectedProvider = httpsRpcAddresses[randomnumber];
			console.log('selectedProvider:', selectedProvider);
			let provider = await new ethers.JsonRpcProvider(selectedProvider);
			console.log('provider:', provider);
			return provider
		}



		async function checkContract(addr) {
			console.log('checkContract()')
			let provider;
			try {
				provider = await createProv();
				const network = await provider.getNetwork();
				console.log('network:', network);
				// return
			} catch (error) {
				console.error('Could not create provider:', error);
				document.getElementById('validLink').innerHTML = `<br>❌ Could not create provider`
			}

			const tokenContract = await new ethers.Contract(addr, erc20Abi, provider);
			console.log('tokenContract:', tokenContract)

			let result = await JSON.parse(localStorage.getItem('chainResult'))
			let explorerLink = `<a target="_blank" rel="noopener noreferrer" href="${result.value.explorers[0].url}/address/${addr}">${addr}</a>`;
			document.getElementById('validLink').innerHTML = `<br>${explorerLink}`

			const symbol = await tokenContract.symbol();
			console.log("Token Symbol:", symbol);
			document.getElementById('validLink').innerHTML += `<br>Token Symbol: ${symbol}`
			document.getElementById('validLink').setAttribute('symbol', symbol);
			document.getElementById('validLink').setAttribute('address', addr);

			let ts = await tokenContract.totalSupply()
			console.log('TOTAL SUPPLY: ', ts)
			document.getElementById('validLink').innerHTML += `<br>Total Supply: ${ts}`

			return

		}






		// Function to validate Ethereum address
		function isValidEthAddress(address) {
			const pattern = /^0x[a-fA-F0-9]{40}$/;
			return pattern.test(address);
		}


		const { isAddress } = ethers;

		// Event listener for the input field
		document.getElementById('contractAddress').addEventListener('input', function () {
			const address = this.value;

			// Check if the address is valid
			if (isAddress(address)) {

				this.classList.remove('is-invalid');
				this.classList.add('is-valid');
				addERC20contract.style.display = 'inline'
				addNativeToken.style.display = 'none';// ocultar eth aqui

				// Call your function here when the address is valid
				checkContract(address)
			} else {
				this.classList.remove('is-valid');
				this.classList.add('is-invalid');
				addERC20contract.style.display = 'none'
				addNativeToken.style.display = 'inline'

			}
		});


		function addConctract() {
			console.log('addConctract() ')
			// Retrieve and parse existing chain data from localStorage
			let storedResult = JSON.parse(localStorage.getItem('chainResult')) || { results: [] };
			st = storedResult
			// Get the relevant elements and their values
			let tokenName = document.getElementById('validLink').getAttribute('symbol');
			const chainName = storedResult.value.name;
			const chainId = storedResult.value.chainId;
			let contractAddr = document.getElementById('contractAddress').value;
			const rpcs = storedResult.value.rpc.filter((address) => address.startsWith("https://") && !address.includes("${INFURA_API_KEY}"));
			const explorers = storedResult.value.explorers;
			//   const nativeToken =


			// let tokenName;
			// let contractAddr;

			if (contractAddr == '') {
				tokenName = storedResult.value.nativeCurrency.name;
				contractAddr = 'nativeToken';
			}

			// Create a new chain entry
			const newToken = {
				tokenName,
				chainName,
				chainId,
				contractAddr,
				rpcs,
				explorers
			};

			storeToken(newToken)

			// repopupulate select
			populateTokenSelector()
			// populateSelectInput('tokenType');//populate selec input inside wallet send


		}





		 // STORE TOKEN 
		 function storeToken(token) {
            console.log('storeToken()')
            storedtoken =token
            var tkn = [];
            tkn = JSON.parse(localStorage.getItem('EVM_TOKENS')) || [];

            // Check if the address already exists
            // var isDuplicate = tkn.some(existingToken => existingToken.contractAddr === token.contractAddr);
            var isDuplicate = tkn.some(existingToken => 
    existingToken.contractAddr === token.contractAddr && existingToken.chainId === token.chainId
);
            if (!isDuplicate) {
                console.warn('NEW TOKEN!')
                tkn.push(token);
                localStorage.setItem('EVM_TOKENS', JSON.stringify(tkn));

                console.log('TOKEN ADDED! ✅✅✅')

// UI UPDATES
// if(token.contractAddr ===''){
    if(token.contractAddr ==='' || token.contractAddr ==='nativeToken'){
    console.log('ADDED NATIVE TOKEN ')
    document.getElementById("autoComplete").value = "";
    document.getElementById("selectionResult").innerHTML=''


}
 
    else{

    console.log('ADDED ERC20 TOKEN ')

    document.getElementById("autoComplete").value = "";
    document.getElementById("contractAddress").value = "";
    document.getElementById('validLink').innerHTML =''
    document.getElementById("selectionResult").innerHTML=''
    // localStorage.removeItem('chainResult');
    
    document.querySelector(".valid-feedback").innerHTML = "";
    document.getElementById("validLink").removeAttribute("symbol");
    document.getElementById("validLink").removeAttribute("address");
    document.querySelector(".valid-feedback").style.display = "none";
}
// else{

// }

                // clear ui


            }
            else {
                console.warn('Token already exists , skipping save.');
                return
            }

            // REMOVE chainFeedback and clear UI
            localStorage.removeItem('chainResult');
            closeModalId('#addNewTokenModal')

            // ssuccss message
            // Toast.fire({ title: "Token added!", text: "", icon: "success" });
            Toast.fire({ title: "", text: "Token added!", icon: "success" });


        }





		// STORE TOKEN 
		// function storeToken(token) {
		// 	console.log('storeToken()', token)
		// 	var tkn = [];
		// 	tkn = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];

		// 	// Check if the address already exists
		// 	//   var isDuplicate = tkn.some(existingToken => existingToken.contractAddr === token.contractAddr);
		// 	var isDuplicate = tkn.some(existingToken =>
		// 		existingToken.contractAddr === token.contractAddr &&
		// 		existingToken.chainId === token.chainId
		// 	);

		// 	if (!isDuplicate) {
		// 		console.warn('NEW TOKEN!')
		// 		tkn.push(token);
		// 		localStorage.setItem('ERC20_TOKENS', JSON.stringify(tkn));
		// 	}
		// 	else {
		// 		console.warn('Token already exists , skipping save.');
		// 		return
		// 	}

		// 	// REMOVE chainFeedback and clear UI
		// 	localStorage.removeItem('chainResult');
		// 	console.warn('chainResult removed from localStorage')

		// 	// set prefered token index to this token
		// 	const length = document.getElementById('erc20Selector').length;
		// 	let newindex = length - 1;
		// 	localStorage.setItem('preferredTokenIndex', newindex);

		// 	// CLEAR UI
		// 	document.getElementById("autoComplete").value = "";
		// 	document.getElementById("contractAddress").value = "";
		// 	document.getElementById("selectionResult").innerHTML = "";
		// 	document.getElementById("validLink").innerHTML = "";
		// 	document.getElementById("selectionResult").style.display = "none";
		// 	document.getElementById("contractAddress").classList.remove('is-valid');

		// 	closeModalId('#addNewTokenModal')

		// 	Toast.fire({ title: "Token added!", text: "A new Token has been added.", icon: "success" });

		// }

		function removeToken(contractAddr) {
			console.log('removeToken()');
			var tkn = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];

			// Filter out the token with the matching contractAddr
			var newTkn = tkn.filter(existingToken => existingToken.contractAddr !== contractAddr);

			if (newTkn.length === tkn.length) {
				console.warn('Token not found , skipping removal.');
				return;
			}

			localStorage.setItem('ERC20_TOKENS', JSON.stringify(newTkn));

			// REMOVE chainFeedback and clear UI
			localStorage.removeItem('chainResult');


		}




		
	
		  // ----------------------------------------------------------------------------
        // POPULATE SELECTOR
        // ----------------------------------------------------------------------------

		function setDefaultTokens (){
			console.log('setDefaultTokens()')
			localStorage.removeItem('EVM_TOKENS')
			localStorage.removeItem('PREFERRED_TOKEN')
			localStorage.removeItem('lastUXInfo')
			
			// let storedTokens = JSON.parse(localStorage.getItem('EVM_TOKENS')) || [];
			let storedTokens =[];

			const defaultToken = {
                    tokenName: "USDC",
                    chainName: "Arbitrum Sepolia",
                    chainId: 421614,
                    contractAddr: "0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d",  // Example contract address
                    rpcs: ["https://arbitrum-sepolia.infura.io/v3/9219faae2bac4d24b95c2d967b22005a","https://arb-sepolia.g.alchemy.com/v2/X048z0PxuDPd5vbTiKLbWJgogG9Tvd2I"],   // Example RPC endpoint
                    explorers: [{ "name": "Arbitrum Sepolia Arbiscan Testnet Explorer", "url": "https://sepolia.arbiscan.io", "standard": "EIP3091" }] // Example explorer
                };
                storedTokens.push(defaultToken);

                  const defaultTokenB = {
                    tokenName: "ETH(arb)",
                    chainName: "Arbitrum Sepolia",
                    chainId: 421614,
                    contractAddr: "nativeToken",  // Example contract address
                    rpcs: ["https://arbitrum-sepolia.infura.io/v3/9219faae2bac4d24b95c2d967b22005a","https://arb-sepolia.g.alchemy.com/v2/X048z0PxuDPd5vbTiKLbWJgogG9Tvd2I"],   // Example RPC endpoint
                    explorers: [{ "name": "Arbitrum Sepolia Arbiscan Testnet Explorer", "url": "https://sepolia.arbiscan.io", "standard": "EIP3091" }] // Example explorer
                };
                storedTokens.push(defaultTokenB);


                localStorage.setItem('EVM_TOKENS', JSON.stringify(storedTokens));
                populateTokenSelector()
				return storedTokens
		}
		
		
		
		
		async  function getPreferredToken() {
          console.log('getPreferredToken()')

		//   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
		//   SIMPLIFICAR
		//   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

		// 1- GET TOKENS
		  let storedTokens = JSON.parse(localStorage.getItem('EVM_TOKENS')) || [];
		  strotok= storedTokens
            if (storedTokens.length === 0) {
                console.log('🤷🤷 There are no tokens (EVM_TOKENS) in localstorage. Adding DEFAULT USDC(arbitrum sepolia)  ')
				 setDefaultTokens ()

            } else {
                console.log('💁‍♂️💁‍♂️ YES EVM_TOKENS in localstorage', storedTokens)

            }



// 2- GET PREFERED TOKEN
            let preferredTokenKey = localStorage.getItem('PREFERRED_TOKEN');
			if (preferredTokenKey !== null) {
				console.log('PREFERRED_TOKEN exists in localStorage:', preferredTokenKey);
				// sanitize format (chainId-contractAddr)

				} else {
				console.log('PREFERRED_TOKEN does not exist in localStorage');
				// Get first in selector and set that as deffaullt
				let storedTokens = JSON.parse(localStorage.getItem('EVM_TOKENS'));
				let preferredTokenKey = `${storedTokens[0].chainId}-${storedTokens[0].contractAddr}`;
				setPreferredToken(preferredTokenKey)
                // let preferredTokenKey = localStorage.getItem('PREFERRED_TOKEN');
				// let defaultPreferredOption = `${storedTokens[0].chainId}-${storedTokens[0].contractAddr}`;
				// setPreferredToken(defaultPreferredOption)
				}

            // Split the preferred token key to get chainName and contractAddr
            const [preferredChainId, preferredContractAddr] = preferredTokenKey.split('-');
            console.log('preferredChainId:',preferredChainId)
            console.log('preferredContractAddr:',preferredContractAddr)

            return storedTokens.find(token => 
                token.chainId === JSON.parse(preferredChainId) && token.contractAddr === preferredContractAddr  );
        }

    
                    
        // Function to set the preferred token in localStorage
        function setPreferredToken(chainId, contractAddr) {
            console.warn('🤠 🤠 🤠prefered token CHANGED!')
            const preferredTokenKey = `${chainId}-${contractAddr}`;
            // localStorage.setItem('PREFERRED_TOKEN', preferredTokenKey);
			localStorage.removeItem('lastUXInfo')
            localStorage.setItem('PREFERRED_TOKEN', preferredTokenKey);

		 

        }


        
        // Function to populate all selectors with options, marking the preferred token as selected
        function populateTokenSelector() {
                let storedTokens = JSON.parse(localStorage.getItem('EVM_TOKENS')) || [];
                const preferredTokenKey = localStorage.getItem('PREFERRED_TOKEN');
                const tokenSelector = document.querySelectorAll('.token-selector');

                tokenSelector.forEach(selectElement => {
                    // Clear existing options
                    selectElement.innerHTML = '';
                    
                    // Populate options
                    storedTokens.forEach(token => {
                        const option = document.createElement('option');
                        option.value = `${token.chainId}-${token.contractAddr}`;
                        option.textContent = `${token.tokenName} ${token.chainName} (${token.chainId})`;

                        // Mark the option as selected if it matches the preferred token key
                        const tokenKey = `${token.chainId}-${token.contractAddr}`;
                        if (tokenKey === preferredTokenKey) {
                            option.selected = true;
                        }

                        selectElement.appendChild(option);
                    });

					// enable selectors
				selectElement.disabled = false;


					// tokenSelector.disabled = false;

					
                });
            }

		
			




            // Event listener to handle selector change and update the preferred token
            document.querySelectorAll('.token-selector').forEach(selectElement => {
				

                selectElement.addEventListener('change', async(event)  => {
                    const selectedValue = event.target.value;
                    console.warn(' 🤖🤖🤖 TOKEN SELECTOR CHANGED!',selectedValue)
                    s=selectedValue;


					const selectElements = document.querySelectorAll('.tokenBalance');
					selectElements.forEach(balanceDisplayer => {
						balanceDisplayer.innerHTML = ` <span class="top">Loading Balance</span> <span class="bal"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </span> `
						})



                    const [chainId, contractAddr] = selectedValue.split('-');
                    console.log('setPreferredToken::',chainId, contractAddr);
                    setPreferredToken(chainId, contractAddr);
					
					// Synchronize all selectors with the new preferred token
					populateTokenSelector();
					await loadToken(userAddress)

                });
            });

          

	 



		/*********************************************************************************************
		.) STEALTH WALLET
		**********************************************************************************************/


		//  createStealthWallet(privateKey, publicKey) 
		async function createStealthWallet(privateKey, publicKey) {

			console.warn('🦸‍♂️createStealthWallet()', privateKey, publicKey)
			const publicKeyHexWithoutPrefix = removeHexPrefix(publicKey);
			const pubPoint = secp.ProjectivePoint.fromHex(publicKeyHexWithoutPrefix);
			const sharedSecret = pubPoint.multiply(BigInt(privateKey)).toHex();
			console.log('👫sharedSecret  (at createStealthWallet ):', sharedSecret);
			const hashedSecret = ethers.keccak256('0x' + sharedSecret).slice(0, 42);


			// BOB can comput the private key to the stealth addres
			// b +hs
			const hprivkeyBigInt = BigInt(privateKey);  // hs should already be in hex or BigInt format
			// b = hprivkeyBigInt

			const hsBigInt = BigInt(hashedSecret);  // hs should already be in hex or BigInt format
			// hs = hsBigInt

			computedPrivKey = hprivkeyBigInt + hsBigInt
			console.warn('🛰️ computedPrivKey: ', computedPrivKey)

			eth2bigint = ethers.toBigInt(computedPrivKey)

			const stealthPrivateKey = ethers.zeroPadValue(ethers.toBeHex(computedPrivKey), 32);
			console.warn(' 🚁 stealthPrivateKey: ', stealthPrivateKey)
			const stealthwallet = new ethers.Wallet(stealthPrivateKey);
			const derivedStealthPubKey = stealthwallet.publicKey;
			console.warn(' 🪂🦹‍♂️ stealthPrivateKey: ', stealthPrivateKey)
			console.warn(' 🪂 stealthAddress: ', stealthwallet.address)


			return stealthwallet

		}







		// claim stealth address funds to self wallet
		// claimStealthAddrFunds()
		// async function claimBob(destAddress){
		async function claimStealthAddrFunds(destAddress) {
			console.log('claimStealthAddrFunds()')



			// 0 get user  priv key and peer pub key
			// --------------
			// PEER COMPRESSED PUB KEY
			// ---

			let peerAddr = document.getElementById('peerAddr').getAttribute('data-address')
			console.log('🤼‍♀️ peerAddr: ', peerAddr)
			let didData = await fetchDID(peerAddr)
			let peerPublicKey = didData.data.publicKey
			console.log('🤸‍♀️ peerPublicKey: ', peerPublicKey)
			const publicKeyJWK = peerPublicKey
			const xBase64 = base64UrlToBase64(publicKeyJWK.x);
			const yBase64 = base64UrlToBase64(publicKeyJWK.y);
			const xBytes = ethers.decodeBase64(xBase64);
			const yBytes = ethers.decodeBase64(yBase64);
			const yBigInt = BigInt(ethers.hexlify(yBytes));//quizas no es necesario bigint..
			const prefix = yBigInt % 2n === 0n ? 0x02 : 0x03;
			const precompressedPublicKey = ethers.concat([new Uint8Array([prefix]), xBytes]);
			const peerCompressedPublicKey = ethers.hexlify(precompressedPublicKey);
			console.log("Compressed Public Key:", peerCompressedPublicKey);

			// --------------
			// USER PRIVKEY
			// ---
			let signer = await getSigner()
			// let userPrivateKey  = signer.privateKey// your priv key


			// 1 generate bob stealthWallet
			// alicePublicKeyHex
			// let bobStealthWallet = await createStealthWallet(bobPrivateKeyHex, alicePublicKeyHex)
			console.log('createStealthWallet', signer.privateKey, peerCompressedPublicKey)
			let userStealthWallet = await createStealthWallet(signer.privateKey, peerCompressedPublicKey)

			let stealthAddress = userStealthWallet.address
			// 2. move funds to bob original wallet

			// Attach a provider to the stealth wallet so it can interact with the network
			let provider = await new ethers.JsonRpcProvider(optionsList[0].API);

			let userStealthWalletwithProvider = userStealthWallet.connect(provider);




			// If no destAddress is passed, perform some logic to set it
			if (!destAddress) {
				destAddress = signer.address; // Replace with Bob's actual address
				console.log(`CLAIM TO SEND to ${destAddress}  `);

			}
			let balance = await provider.getBalance(stealthAddress);
			console.log("Stealth wallet balance:", ethers.formatEther(balance));
			let formatedBalance = ethers.formatEther(balance)



			// SEND MAXIMUM MINUS ESTIMATED GAS
			// Create transaction object
			const pretx = {
				to: destAddress,          // Bob's current address
				value: balance,          // Amount of ETH to send (here it's all balance)SEND MAXIMUM MINUS ESTIMATED GAS
				gasLimit: undefined      // Will be estimated next
			};

			// pppppppppp

			// Estimate gas required for the transaction
			const gasLimit = await provider.estimateGas(pretx);
			console.log("⛽ Estimated gas:", gasLimit.toString());

			// Get the current gas price
			const feeData = await provider.getFeeData();
			let gasPrice = feeData.gasPrice;
			if (!gasPrice) {
				throw new Error('Gas price is not available');
			}
			console.log(`⛽ Gas Price: ${ethers.formatUnits(gasPrice, 'gwei')} gwei`);


			// Convert gasLimit and gasPrice to BigInt for arithmetic
			const gasLimitBigInt = BigInt(gasLimit);
			const gasPriceBigInt = BigInt(gasPrice);

			// 5. Calculate the gas fee in wei (gas limit * gas price)
			const gasFee = gasLimitBigInt * gasPriceBigInt;
			console.log("⛽ Gas Fee (wei):", gasFee.toString());

			// 6. Calculate the maximum amount of ETH to send after deducting gas fees
			maxAmountToSend = BigInt(balance) - gasFee;
			if (maxAmountToSend <= 0) {
				console.log("Not enough funds to cover gas fees.");
				return;
			}
			console.log(`💸 Max amount to send: ${ethers.formatEther(maxAmountToSend)} ETH`);


			// 6b. Apply a margin to the maxAmountToSend (e.g., reduce by 2%)
			const marginPercentage = 0.01; // 1% margin
			// const marginPercentage = 0.02; // 2% margin
			const marginAmount = maxAmountToSend * BigInt(marginPercentage * 100) / 100n;
			const adjustedAmountToSend = maxAmountToSend - marginAmount;

			document.getElementById('ReceivestealthInfo').innerHTML += `💸 Max amount to send with margin: ${ethers.formatEther(adjustedAmountToSend)} ETH`;
			console.log(`💸 Max amount to send with margin: ${ethers.formatEther(adjustedAmountToSend)} ETH`);

			// return 

			// 7. Update the transaction object with the correct amount
			const tx = {
				to: destAddress,
				value: adjustedAmountToSend, // Maximum ETH we can send
				gasLimit: gasLimit // Use the estimated gas limit
			};

			console.log('Sending transaction:', tx);
			try {
				// 8. Send the transaction
				const txResponse = await userStealthWalletwithProvider.sendTransaction(tx);
				console.log("Transaction sent:", txResponse.hash);

				// 9. Wait for the transaction to be mined
				const receipt = await txResponse.wait();
				let txLink = `<a target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/tx/${txResponse.hash}">Tx link</a>`;
				console.log("Transaction confirmed:", receipt);

				document.getElementById('ReceivestealthInfo').innerHTML += `✅ TRANSACTION SUCCESSFUL <a target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/tx/${txResponse.hash}">Tx link</a>`;
			} catch (error) {
				console.error("Transaction error:", error);
			}


		}



		// Function triggered by the initial button click
		function sendStAdrrFunds() {
			// Check if the input and send button have already been added
			if (!document.getElementById('sendFundsContainer')) {
				// Add an input field for entering the recipient's Ethereum address and a "Send" button
				document.getElementById('ReceivestaddrInfo').innerHTML += `
<div id="sendFundsContainer">
	<br>
	<input type="text" id="customrecipientAddress" placeholder="Enter recipient address" class="input-primary" required>
	<button class="button-primary" type="button" onclick="confirmSend()">Send Funds</button>
</div>
`;
			}
		}


		// Function to handle the confirmation and transaction sending
		function confirmSend() {
			const recipientAddress = document.getElementById('customrecipientAddress').value;

			if (ethers.isAddress(recipientAddress)) {
				// Add your logic to send funds to the recipient address here
				console.log(`Sending funds to: ${recipientAddress}`);

				// Example of sending funds logic (replace with your transaction logic)
				// await signer.sendTransaction({ to: recipientAddress, value: ethers.parseEther('0.01') });

				alert(`Sending fundsto ${recipientAddress}`);
				claimStealthAddrFunds(recipientAddress)
				// send
			} else {
				alert('Invalid Ethereum address');
			}
		}


		/*********************************************************************************************
		.)  SEND / RECEIVE TOKENS ERC20
		**********************************************************************************************/

		// Helper function to convert Base64 URL to Base64
		function base64UrlToBase64(base64Url) {
			return base64Url.replace(/-/g, '+').replace(/_/g, '/').padEnd(base64Url.length + (base64Url.length % 4), '=');
		}


		async function prepareStealthAddr (){
			console.log('preparing Stealth address');
			document.getElementById('sarecipientAddress').innerHTML = ` <p>Calculating stealth address  <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </p>`
				document.getElementById('stealthInfo').style.display = 'block'; // Example action

				// get peer publickey
				let peerAddr = document.getElementById('peerAddr').getAttribute('data-address')
				console.log('🤼‍♀️ peerAddr: ', peerAddr)
				let peerDId = `did:ius:${peerAddr}`;
				let didData = await fetchDID(peerDId)
				let peerPublicKey = didData.data.publicKey
				console.log('🤸‍♀️ peerPublicKey: ', peerPublicKey)

				// ---
				// convert public key
				// Step 0: Convert Base64 URL to Base64
				// Step 1: Decode base64 to raw bytes using ethers.decodeBase64 for Ethers.js v6
				// Step 2: Convert yBytes to a BigInt to check if it's even or odd
				// Step 3: Determine the prefix: 0x02 if y is even, 0x03 if y is odd
				// Step 4: Compress the public key (prefix + x coordinate)
				// ---
				const publicKeyJWK = peerPublicKey
				const xBase64 = base64UrlToBase64(publicKeyJWK.x);
				const yBase64 = base64UrlToBase64(publicKeyJWK.y);
				const xBytes = ethers.decodeBase64(xBase64);
				const yBytes = ethers.decodeBase64(yBase64);
				const yBigInt = BigInt(ethers.hexlify(yBytes));//quizas no es necesario bigint..
				const prefix = yBigInt % 2n === 0n ? 0x02 : 0x03;
				const precompressedPublicKey = ethers.concat([new Uint8Array([prefix]), xBytes]);
				const compressedPublicKey = ethers.hexlify(precompressedPublicKey);
				// console.log("Compressed Public Key:", compressedPublicKey);

				// ---------
				// PRIVKEY
				// ---------
				let signer = await getSigner()
				let alicePrivateKey = signer.privateKey;//
				let stealthAddress = await generateStealthAddress(alicePrivateKey, compressedPublicKey)
				console.log(`<br>👩👻Stealth address generated by YOU (A) to pay your PEER(B): ${stealthAddress.stealthAddress} <br>👫sharedSecret: ${stealthAddress.sharedSecret}`)
				document.getElementById('sarecipientAddress').innerHTML = stealthAddress.stealthAddress
 
				// CHECK STEALTH ADDRESS BALANCE (FOR NATIVE ONLY!)
				let provider = await new ethers.JsonRpcProvider(optionsList[0].API);
				let staddrBalance = await provider.getBalance(stealthAddress.stealthAddress);
				console.log("native token balance:", ethers.formatEther(staddrBalance));
				let stddrformatedBalance = ethers.formatEther(staddrBalance)
				document.getElementById('staddrInfo').innerHTML = `Peer Stealth's Balance: ${stddrformatedBalance} `

		}
		async function generateStealthAddress(privateKeyHex, publicKey) {

			console.warn('🏰 generateStealthAddress()')

			const hexPublicKey = publicKey.startsWith('0x') ? publicKey.slice(2) : publicKey;
			const pubPoint = secp.ProjectivePoint.fromHex(hexPublicKey);
			console.log('pubPoint:', pubPoint)

			const sharedSecret = pubPoint.multiply(BigInt(privateKeyHex)).toHex();
			console.log('👫sharedSecret( at generateStealthAddress):', sharedSecret);
			const hashedSecret = ethers.keccak256('0x' + sharedSecret).slice(0, 42);

			// 1.Multiply hs by the curve generator point (G): You can use the secp256k1 generator point (which is a constant) to compute the point hs * G.
			const G = secp.ProjectivePoint.BASE;  // Generator point G
			const hsBigInt = BigInt(hashedSecret);  // hs should already be in hex or BigInt format
			const hsPoint = G.multiply(hsBigInt);  // hs * G

			// 2.Add Bob’s public key: You now add Bob’s public key as an elliptic curve point to hs * G. Ensure Bob's public key is in the correct format for the addition.
			const stealthPubPoint = hsPoint.add(pubPoint);  // hs * G + Bob's public key

			// 3.Convert the resulting point to an Ethereum address: Finally, you convert the resulting elliptic curve point to an Ethereum address. This is typically done by compressing the point to its x-coordinate, hashing it, and then converting it to an Ethereum address.
			const stealthPubKey = stealthPubPoint.toHex();  // Convert to hex
			const stealthAddress = ethers.computeAddress('0x' + stealthPubKey);  // Convert to Ethereum address
			console.log('👻Stealth Address:', stealthAddress);
			return { stealthAddress, sharedSecret }
		}


		function isValidEvmAddress(address) {
  return ethers.isAddress(address);
}


async function scanAndSign(){
	console.warn('scanAndSign')
	// openModalId('#scanModal')
	openModalId('#scansignModal')

	// document.getElementById('scanResult').innerHTML = ''
	// 		setTimeout(() => {
	// 			var videoElem = document.getElementById("qrScanVideo");
	// 			window.qrScanner = new QrScanner(videoElem, result => qrscanned(result), {
	// 				highlightScanRegion: true,
	// 				highlightCodeOutline: true,
	// 			});

	// 			qrScanner.setInversionMode('both');
	// 			qrScanner.start();
	// 		}, 1000);

}

  // Show input field when "Paste and Sign" button is clicked
  document.getElementById('pasteAndSignBtn').addEventListener('click', function() {
    document.getElementById('pasteField').style.display = 'block';
	playBoing()
	pasteAndSign()
  });



        
  async function pasteAndSign() {
            console.log('PASTING TO SIGN')
            // try {
              // Check if the Clipboard API is supported
              if (navigator.clipboard && navigator.clipboard.readText) {
                let clipboardText = await navigator.clipboard.readText();
                // ANALIZE TEXT

                // Step 1: Check if it's already a JSON string
                let payload
                let cleanedJson
                if (clipboardText.startsWith('"') && clipboardText.endsWith('"')) {
                    // Remove outer quotes
                     cleanedJson = clipboardText.slice(1, -1).replace(/\\"/g, '"');
                    console.log('Remove outer quotes', cleanedJson);
                    document.getElementById('pastedTxToSign').innerHTML = cleanedJson;
                
                    // Step 2: Parse into an object
                    payload = JSON.parse(cleanedJson);
                    console.log(payload);
                    document.getElementById('pastedTxToSign').innerHTML = cleanedJson;

                } else {
                    // Directly parse
                    payload = JSON.parse(clipboardText);
                    console.log('Directly parse', payload);
                }

                p = payload;

                if (payload.action === "eth_requestAccounts") {
                    console.warn("Received eth_requestAccounts request:", payload);
                    
                    // Process the request
                    Swal.fire({
                        title: 'Sign this request to connect with the site:',
                        html: `<pre class='codeToSign'>${cleanedJson}</pre>`, // Display the rest of the message
                        // text: cleanedJson, // Display the rest of the message
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Sign ',
                        cancelButtonText: 'Refuse',
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            console.log("User chose to sign the message.");


                            // -----------------
                            // GET SIGNER's ADDRESS
                            // -----------------
							let presigner = await getSigner()
							let provider = new ethers.JsonRpcProvider(`${optionsList[0].API}`); //v5
							let signer = presigner.connect(provider);

                            // let alicewallet = await aliceWallet();
                            // let signer = await new ethers.Wallet(alicewallet.privateKey)
                            console.log('signer:', signer)

                            let address  = payload.requester;
                            // -----------------
                            // SIGN TX
                            // -----------------
                            const signature = await signer.signMessage(cleanedJson);
                            console.log('signature:', signature)
                            // document.getElementById('result').innerHTML = ``
                            document.getElementById('pastedTxToSign').innerHTML =`✅ signed!
                                <br><span class='sig'> ${signature}</span>`;
                            // -----------------
                            // TRANSMIT SIGNATURE THROUGH XMTP
                            // -----------------    
							// let signatureAndProvider = 
                            // await sendSignedMessage(iusnaturalisxmtp, address, signatureAndProvider)
                            console.log('sendSignedMessage: ',iusnaturalisxmtp, address, signature)
                            await sendSignedMessage(iusnaturalisxmtp, address, signature)


                        } else if (result.dismiss === Swal.DismissReason.cancel) {
                            console.log("User refused.");
                        }
                    });
                } 

                return
 
          }
        }



        async function sendSignedMessage(xmtpClient, address, messageContent) {
            try {
                // Open the chat and get the conversation
                // const conversation = await openChat(xmtpClient, address);
// 
                // console.log('sendSignedMessage(conversation):', conversation)
   
				let conversation = await iusnaturalisxmtp.conversations.newConversation(address);
	
				// Send the message
                await conversation.send(messageContent);
                console.log(`Message sent to ${address}: ${messageContent}`);

                // Optionally, add the sent message to the message store
                if (!messageStore[address]) {
                messageStore[address] = [];
                }
                messageStore[address].push({
                content: messageContent,
                timestamp: new Date(),
                sender: 'self', // Mark it as sent by the user
                });

                // Update the chat window
                // updateChatWindow(address, messageContent);
            } catch (err) {
                console.error(`Failed to send message to ${address}:`, err);
            }
        }




		async function simpleSend(){
			console.warn('simpleSend')

			openModalId('#walletSend')
			let recipientAddressInput = document.getElementById('recipientAddress');
			let stealthAddressCheckbox = document.getElementById("stealthAddressCheckbox");

			stealthAddressCheckbox.checked = false; // Uncheck if previously checked
			stealthAddressCheckbox.disabled = true; // Disable checkbox

			recipientAddressInput.removeAttribute('readonly');
			recipientAddressInput.value ='';


			
			document.getElementById("bigBalanceWalletsendmodal").innerHTML= '<h1>SEND</h1>'
			
			// let value= document.getElementById("amount").value;
			// document.getElementById("bigBalanceWalletsendmodal").innerHTML= `
			// <span class="top"> you are about to send:</span>
			// <span class="bal">  ${value} </span>
			// <span class="eth">ETH</span>`



			// listen to onchange en recipientAddressInput
		recipientAddressInput.addEventListener('input', function () {
			const recipientAddress = this.value.trim(); // Get the input value
			
			if (recipientAddress === "" || !isValidEvmAddress(recipientAddress)) {
				// Disable the checkbox if the address is invalid or empty
				stealthAddressCheckbox.checked = false; // Uncheck if previously checked
				stealthAddressCheckbox.disabled = true; // Disable checkbox
				this.removeAttribute("data-address"); // Remove data-address attribute if invalid
				// document.getElementById('peerAddr').removeAttribute("data-address"); // Remove data-address attribute if invalid
				
			} else {
				// Enable the checkbox if the address is valid
				stealthAddressCheckbox.disabled = false;
				this.setAttribute("data-address", recipientAddress); // Set data-address attribute
				// document.getElementById('peerAddr').setAttribute("data-address", recipientAddress); // Set data-address attribute
			}

			// if (recipientAddress === "" || !isValidEvmAddress(recipientAddress)) {
			// 	// Disable the checkbox if the address is invalid or empty
			// 	stealthAddressCheckbox.checked = false; // Uncheck if previously checked
			// 	stealthAddressCheckbox.disabled = true; // Disable checkbox
			// } else {
			// 	// Enable the checkbox if the address is valid
			// 	stealthAddressCheckbox.disabled = false;
			// }


			});
		}



		async function openReceive() {
			console.warn('openReceive')

						// open modal
						openModalId('#walletReceive')

						return
			// if 🦹‍♂️↔️🦹‍♀️ Stealth addresses always on
			const checkbox = document.getElementById("stealthAddressCheckbox");

			const stealthAddressOn = localStorage.getItem('stealthAddressAlwaysOn');
			if (stealthAddressOn === 'true') {
				console.log('stealthAddressAlwaysOn is on')
				checkbox.checked = true;
				localStorage.setItem('stealthAddressActive', true)

				prepareStealthAddr()


			} else {
				console.log('stealthAddressAlwaysOn is off')
				checkbox.checked = false;
				localStorage.setItem('stealthAddressActive', false)

			}

			if (addr) {
				console.log('there is address', addr)
			}
			else {
				console.log('there is not addr')
			}


			// // open modal
			// openModalId('#walletReceive')

			// get recipient address
			// document.getElementById("recipientAddress").value = addr;

		 

		}




		async function openSend(addr) {
			console.warn('openSend', addr)

			// if 🦹‍♂️↔️🦹‍♀️ Stealth addresses always on
			const checkbox = document.getElementById("stealthAddressCheckbox");

			const stealthAddressOn = localStorage.getItem('stealthAddressAlwaysOn');
			if (stealthAddressOn === 'true') {
				console.log('stealthAddressAlwaysOn is on')
				checkbox.checked = true;
				localStorage.setItem('stealthAddressActive', true)

				prepareStealthAddr()


			} else {
				console.log('stealthAddressAlwaysOn is off')
				checkbox.checked = false;
				localStorage.setItem('stealthAddressActive', false)

			}

			if (addr) {
				console.log('there is address', addr)
			}
			else {
				console.log('there is not addr')
			}


			// open modal
			openModalId('#walletSend')

			// get recipient address
			document.getElementById("recipientAddress").value = addr;

	

		 

		}



		// document.getElementById('tokenType').addEventListener('change', function () {
		// 	console.log('TOKEN TYPE CHANGED')

		// 	const selectedType = this.value;
		// 	const erc20Selector = document.getElementById('erc20Selector');
		// 	const erc20Details = document.getElementById('erc20Details');
		// 	if (this.value === 'erc20') {
		// 		erc20Details.classList.remove('d-none');
		// 	} else {
		// 		erc20Details.classList.add('d-none');
		// 	}
		// });





		///////////////////////////////////////
		// 1. SEND
		///////////////////////////////////////
		// PRESEND
		// Declare shared scope variables
let txGasEstimate;
let customRecipientAddress
let preferredToken

// CLICK SEND BUTTOn
		document.getElementById('sendTransactionBtn').addEventListener('click', async function (event) {
			console.log('CLICKED sendTransactionBtn')


			// clear ui
			document.getElementById('transactionDetails').innerHTML =''
			document.getElementById('confirmTransactionBtn').disabled = true;// disable CONFIRM button until gas estimation is loaded
			document.getElementById('confirmTransactionBtn').innerHTML = `<div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> `
			const amountInput = document.getElementById('amount');
			const amount = document.getElementById('amount').value;

			if (!amountInput.value) {
				amountInput.classList.add('is-invalid');
				event.preventDefault();
				return	
			} else {
				amountInput.classList.remove('is-invalid');
			}

	
				

			let transactionDetails = `Recipient: ${recipientAddress}\nAmount: ${amount} ${tokenType === 'eth' ? 'ETH' : 'Tokens'}`;
			const storedTokenType = localStorage.getItem('selectedTokenType');


			// is EVM TOKEN (hay que cambiar erc20 a EVM para hacerlo menos confuso)
			if (storedTokenType === 'evm') {
				console.warn(' IS ERC20 / EVM OTKEN')
				// console.log(' IS ERC20 / EVM OTKEN')
			}




			// Switch to confirmation tab
			const tab = new bootstrap.Tab(document.getElementById('confirmation-tab'));
			tab.show();
			let addr = document.getElementById('yourAddress').getAttribute('address');
			let toAddress; // Declare the variable outside the block for broader scope
			let peerElement = document.getElementById('peerAddr');

			if (peerElement) {
			toAddress = peerElement.getAttribute('data-address');
			console.log(toAddress); // Element exists, and the value is logged
			} else {
			console.error('Element with id "peerAddr" not found'); // Handle missing element gracefully
				 toAddress = document.getElementById('recipientAddress').value
				console.log('recipien address:', toAddress);

			}


		// ................................
		// GET TOKEN
		// ................................
		 preferredToken = await getPreferredToken()
		 let ticker = preferredToken.tokenName;


		 	// set amount to send message
			 document.getElementById("bigBalanceWalletsendmodal").innerHTML= `
			<h1>SENDING:</h1>
			<span class="bal" >${amount} </span>
			<span class="eth">${ticker}</span>
			`
		// ................................
		// GET PROVIDER
		// ................................
    let selectedProvider = await selectRandomProvider(preferredToken.rpcs)
    let provider
    try {
        provider = await new ethers.JsonRpcProvider(selectedProvider);
        console.log("🤓Provider initialized successfully:", provider);
    } catch (error) { console.warn("🤬Failed to initialize provider:", error.message || error); }
    

				// ................................
				// GET RECIPIENT(stealth or piublic address)
				// ................................
				let checkbox = document.getElementById("stealthAddressCheckbox").checked;
				console.log('🤺 CHECKBOZ 2:', checkbox)

				// let customRecipientAddress
				if (checkbox) {
					console.log("The checkbox is checked!");
					customRecipientAddress = document.getElementById('sarecipientAddress').innerText
					console.log('🎶stealthAddress is ON 🦍',customRecipientAddress)
				} else {
					console.log("The checkbox is not checked.");
					customRecipientAddress = document.getElementById('recipientAddress').value
					console.log('stealthAddress is OFF 🔔',customRecipientAddress)
				}



			// ................................................................................................
			// IF NATIVE 
			// NATIVE-BALANCE
			//  ELSE
			// ERC20-BALANCE
			// ................................................................................................
			const formattedAddress = ethers.getAddress(userAddress);
			let signer = await getSigner()
			let cws;
			let amountToSend;
			let txGasEstimage;
			let s;


// ...............................................................
// NATIVE TOKEN 
// ...............................................................
			if (preferredToken.contractAddr == 'nativeToken') {
				console.log('NATIVE TOKEN')
				document.getElementById('transactionDetails').innerHTML = `<br><span id="txbal"> NATIVE TOKEN balance:  <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </span> `;
				amountToSend = ethers.parseUnits(amountInput.value);  // 18 is the number of decimals for Ether

				//  let signer = await getSigner() 

				// ................................
				// GAS BALANCE
				// ................................
				const gasBalance = await provider.getBalance(signer.address);
				const formatedgasBalance = ethers.formatEther(gasBalance);
				console.log(`GAS Balance : ${formatedgasBalance} GAS`);
				s = signer.connect(provider);//signer(wallet connected to provider)
				console.log('connected signer to provider:', provider)
				// let s = signer.connect(provider);//signer(wallet connected to provider)
				// let cws;


				// ................................
				// NOW ESTIMATE GAS FEES
				// ................................

				const precurrentNonce = await provider.getTransactionCount(signer.address);
				console.log('CALCULATE NONCE: ', precurrentNonce)
				console.log(' Estimated Gas for NATIVE TOKEN')
				document.getElementById('txbal').innerHTML = `Native Token balance: ✅${formatedgasBalance}  `;
				document.getElementById('transactionDetails').innerHTML += `<br><span id="estgas"> 🔮 Estimating gas <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </span> `;

				const pretx = {
					to: customRecipientAddress,          // Bob's current address
					value: amountToSend,          // Amount of ETH to send (here it's all balance)SEND MAXIMUM MINUS ESTIMATED GAS
					gasLimit: undefined      // Will be estimated next
				};
				console.log('✍️🧠🗣️pretx', pretx)

				// let txGasEstimate;
				try {
					txGasEstimage = await s.estimateGas(pretx);
					console.log('Estimated gas:', txGasEstimage.toString());
				} catch (error) {
					console.error('Error estimating gas:', error);
					document.getElementById('estgas').innerHTML = `<span class="text-danger">⛽📛 Gas estimation error: ${error.shortMessage}</span>`;
					document.getElementById('confirmTransactionBtn').disabled = true
					document.getElementById('confirmTransactionBtn').innerHTML = `Confirm`
					return

				}

				tge = txGasEstimage;
				if (txGasEstimage) {
					console.log('Gas estimate available:', txGasEstimage.toString());
					document.getElementById('estgas').innerHTML = `Gas estimated for this tx ⛽: ${ethers.formatEther(txGasEstimage)}`
				}

			}

// ...............................................................
// ERC20
// ...............................................................
			else {
				console.log('if ERC20 TOKEN')

				let contractAddr = preferredToken.contractAddr
				const tokenContract = await new ethers.Contract(contractAddr, erc20Abi, provider);
				tk = tokenContract;
				console.log('CONTRACT READY!');
				console.log('GETTING ERC20 BALANCE ...');
				document.getElementById('transactionDetails').innerHTML += `<br><span id="txbal"> ERC-20 balance:  <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </span> `;



				let erc20balance;
				try { erc20balance = await tokenContract.balanceOf(formattedAddress); }
				catch (error) {
					document.getElementById('txbal').innerHTML = `❌ Error getting ERC-20 balance: ${error.reason}, using provider ${selectedProvider}`;
					if (error.message.includes('Failed to fetch')) { console.warn('Error getting balance: Network or fetch issue. refetch?'); }
					else { console.warn('Error getting balance:', error); }
				}
				const decimals = await tokenContract.decimals();
				console.log('decimals:', decimals);
				let formatedBalance = ethers.formatUnits(erc20balance, decimals);
				console.log('formatedBalance:', formatedBalance);
				console.warn(`ERC-20 Balance of ${preferredToken.tokenName}: ${formatedBalance} `);
				document.getElementById('txbal').innerHTML = `ERC-20 balance:  ${formatedBalance}`;
				// document.getElementById('transactionDetails').innerHTML += `<br><span id="estgas">🤠 Estimating gas <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </span> `;

				// ................................
				// CHECK IF ERC20 BALANCE >= AMOUNT
				// ................................
				amountToSend = ethers.parseUnits(amountInput.value, decimals);  // 18 is the number of decimals for Ether
				console.log('amountToSend:', amountToSend);
				if (erc20balance >= amountToSend) {
					document.getElementById('txbal').innerHTML += ` <br>✅ Enough ERC-20 balance to cover this transaction`;
				}
				else {
					document.getElementById('confirmTransactionBtn').innerHTML = `Confirm`
					document.getElementById('txbal').innerHTML = `Insufficient ERC-20 balance:  ${formatedBalance} ❌`;
					return
				}

				// ................................
				// GAS BALANCE
				// ................................
				document.getElementById('transactionDetails').innerHTML += `<br><span id="estgas">🤠 Estimating gas <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </span> `;

				const gasBalance = await provider.getBalance(signer.address);
				const formatedgasBalance = ethers.formatEther(gasBalance);
				console.log(`GAS Balance : ${formatedgasBalance} GAS`);
				let s = signer.connect(provider);//signer(wallet connected to provider)
				console.log('connected signer to provider:', provider)

				// ................................
				// NOW ESTIMATE GAS FEES
				// ................................
				const precurrentNonce = await provider.getTransactionCount(signer.address);
				console.log('CALCULATE NONCE: ', precurrentNonce)
				console.log('Estimated Gas for ERC20 TOKEN')
				cws = await tokenContract.connect(s);// connect tokenContract to signer(contract with signer)
				
				// ................................
				// ESTIMATE GAS
				// ................................
				// let txGasEstimage;
				try {
					console.log('🤳⚠️⛽🛢️estimateGas:', customRecipientAddress, amountToSend);
					console.log(typeof amountToSend); // Ensure it logs 'bigint'

					txGasEstimage = await cws.transfer.estimateGas(customRecipientAddress, amountToSend);

					// console.log("Gas estimate:", txGasEstimate);
				} catch (error) {
					console.error("Error estimating gas:", error);
					er = error 
					if (error.code === 'INSUFFICIENT_FUNDS') {
						console.error("Insufficient funds for gas estimation.");
					}
				}

				console.log("⛽ Gas estimate:", txGasEstimage);
				// console.log(`Estimated Gas: ${txGasEstimage.toString()}`);
				tge = txGasEstimage;

				const formatedtxGasEstimage = ethers.formatEther(txGasEstimage);
				console.log(`formatedtxGasEstimage: ${formatedtxGasEstimage}`);

				document.getElementById('txbal').innerHTML += `<br><br>Your Gas balance: ⛽${formatedgasBalance}  `;
				document.getElementById('estgas').innerHTML = `Estimated gas for this tx: ⛽${formatedtxGasEstimage} `;

				const feeData = await provider.getFeeData();
				const gasPrice = feeData.gasPrice;
				if (!gasPrice) {
					throw new Error('Gas price is not available');
				}
				console.log(`Gas Price: ${ethers.formatUnits(gasPrice, 'gwei')} gwei`);

				// Calculate the total gas cost in ETH
				const gasCostInEth = gasPrice * txGasEstimage;
				const gasCostInEthFormatted = ethers.formatUnits(gasCostInEth, 'ether');
				console.log(`Gas Cost in ETH: ${gasCostInEthFormatted}`);
				// Get the ETH to USD conversion rate
				const ethUsdPrice = await getEthUsdPrice();
				console.log(`ETH to USD: $${ethUsdPrice}`);

				// Convert gas cost to USD
				const gasCostInUsd = parseFloat(gasCostInEthFormatted) * ethUsdPrice;
				console.log(`Estimated Gas Cost in USD: $${gasCostInUsd.toFixed(6)}`);

				// txbuilder.style.display = 'none';
				document.getElementById('estgas').innerHTML += `<br>(Gas Cost in USD: 💵 $${gasCostInUsd.toFixed(6)})`



				// ((((((((((((((((((((((((()))))))))))))))))))))))))
				// ERC20 balance and gas balance to pay for this tx
				if (gasBalance >= gasCostInEth) {
					console.log(" ✅ Sufficient balance to cover transaction and gas fees!");
					document.getElementById('estgas').innerHTML += `<br> ✅ Enough gas balance to cover  gas fees  `;
				} else {
					console.log("❌Insufficient balance to cover transaction and gas fees.");
					document.getElementById('estgas').innerHTML += `<br> ❌Insufficient balance to cover transaction and gas fees  `;
					document.getElementById('confirmTransactionBtn').innerHTML = `Confirm`
					return
				}


			} //fin ERC20 TOKEN



			// ((((((((((((((((((((((((()))))))))))))))))))))))))

			// disable button until gas estimation is loaded
			document.getElementById('confirmTransactionBtn').disabled = false
			document.getElementById('confirmTransactionBtn').innerHTML = `Confirm`



//////////////////////////////////////////////////////////////////////////////
// 2. CONFIRM
// - do the tx
//////////////////////////////////////////////////////////////////////////////
			document.getElementById('confirmTransactionBtn').addEventListener('click', async function () {
				console.log('confirmTransactionBtn CLICKED!')

				//  Show result tab
				const resultTab = new bootstrap.Tab(document.getElementById('result-tab'));
				resultTab.show();
				document.getElementById('resultMessage').innerHTML = `<span id="makingtx"> Making transaction ( do not close this modal) <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </span>`;

				//  ---------------------------
				// check nonce 
				const currentNonce = await provider.getTransactionCount(signer.address);
				console.log('RECALCULATE NONCE: ', currentNonce)

				let tokenName;
// ...............................................................
// NATIVE TOKEN (coonfirmation)
// ...............................................................	// NATIVE TOKEN 2
				if (preferredToken.contractAddr == 'nativeToken') {
					// send NATIVE TOKEN
					console.log('🚀 SEND NATIVE TOKEN')
					console.log('🚀 SEND NATIVE TOKEN', customRecipientAddress,amountToSend,txGasEstimage)

					const pretx = {
						to: customRecipientAddress,          // Bob's current address
						value: amountToSend,          // Amount of ETH to send (here it's all balance)SEND MAXIMUM MINUS ESTIMATED GAS
						gasLimit: txGasEstimage      // Will be estimated next
					};
					console.log('pretx', pretx)

					try {
						tx = await s.sendTransaction(pretx);
					} catch (error) {
						console.error('Error estimating gas:', error);
						return

					}
					// SUCCESS
					console.log(`Transaction hash: ${tx.hash}`);
					tokenName = preferredToken.tokenName;
					const telength = preferredToken.explorers.length;
					const terandomnumber = Math.floor(Math.random() * telength);
					let tokenExplorer = preferredToken.explorers[terandomnumber].url;
					console.log('selectedTokenExplorer:', tokenExplorer);
					console.log('+ info: ', tokenName, tokenExplorer)

					// -------
					const receipt = await tx.wait();

					txLink = `${tokenExplorer}/tx/${tx.hash}`;//made global
					// let txLink = `${tokenExplorer}/tx/${tx.hash}`;
					console.log(`Transaction link: ${txLink}`);
					document.getElementById('resultMessage').innerHTML += `✅<br><span class ="tx"> SUCCESS 🎉🎉🎉!!! Here is the tx  <a href="${txLink}" target="_blank">Link</a> ✨✨✨</span>`

					// -------------
					//close modal and reset its UI
					closeModalId("#walletSend")
					resetWalletSendModal();
					Swal.fire({
						icon: "success",
						title: `Sent ${amount} ${tokenName}!💸`,
						html: `<span class ="tx">Transaction was mined in block ${receipt.blockNumber} ✅</span><br><span class ="tx"> Here is the tx  <a href="${txLink}" target="_blank">Link</a> ✨✨✨</span>`
					});
 


				} 
// ...............................................................
// ERC20 (confimation)
// ...............................................................
				else {
					console.log(' 🛫 SEND ERC20')
					console.log('🛫 SEND ERC20', customRecipientAddress,amountToSend,txGasEstimage)

					let tx;
					try {
						 tx = await cws.transfer(customRecipientAddress, amountToSend, { txGasEstimage });
				

					} catch (error) {
							// Handle insufficient funds error
							if (error.code === 'INSUFFICIENT_FUNDS') {
								console.error('Insufficient funds for the transaction.');
								document.getElementById('resultMessage').innerHTML += `<br><span class ="tx"> Error: Insufficient funds for the transaction. 🚫</span>`;
								document.getElementById('transactionDetails').innerHTML += `<br><span class ="tx"> Error: Insufficient funds for the transaction. 🚫</span>`;
							} else {
								// Handle any other errors
								console.error(`Transaction failed: ${error.message}`);
								document.getElementById('resultMessage').innerHTML += `<br><span class ="tx"> Error: ${error.message} 🚫</span>`;
								document.getElementById('transactionDetails').innerHTML += `<span class ="tx"> Error: ${error.message} 🚫</span>`;

							}

							const tab = new bootstrap.Tab(document.getElementById('confirmation-tab'));
							tab.show();
						}


					// ----
					// CONTINUE HERE
					console.log(`Transaction hash: ${tx.hash}`);
						document.getElementById('resultMessage').innerHTML = `<span class ="tx">Transaction hash:  ${tx.hash} ✅</span>`;
						document.getElementById('resultMessage').innerHTML += `<span class ="txdone">waiting for confirmation <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </span>`;

						// Wait for the transaction to be mined
						let receipt = await tx.wait();
						console.log(`Transaction was mined in block ${receipt.blockNumber}`);
						document.getElementById('resultMessage').innerHTML = `<span class ="tx">Transaction was mined in block ${receipt.blockNumber} ✅</span>`;

						// -------------
						// PREPARE RECEIPT
						// let preferredToken;
						// let tokenName;
						let tokenExplorer;

						console.warn('🐭 storedTokenType: ', storedTokenType)
						if (storedTokenType === 'evm') {
							console.log('EVM 👩‍🦳')
							preferredToken = await getPreferredToken();
							tokenName = preferredToken.tokenName;
							const telength = preferredToken.explorers.length;
							const terandomnumber = Math.floor(Math.random() * telength);
							tokenExplorer = preferredToken.explorers[terandomnumber].url;
							console.log('selectedTokenExplorer:', tokenExplorer);
						}

						// if (storedTokenType === 'erc20') {
							console.log('PREFERED TOKEN 👩‍🦳:',preferredToken )
							// preferredToken = await getPreferredToken();
							tokenName = preferredToken.tokenName;
							const telength = preferredToken.explorers.length;
							const terandomnumber = Math.floor(Math.random() * telength);
							tokenExplorer = preferredToken.explorers[terandomnumber].url;
							console.log('selectedTokenExplorer:', tokenExplorer);
						// }

						console.log('+ info: ', tokenName, tokenExplorer)
						pref=preferredToken;
						// -------
				// let txLink = `<a target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/tx/${txResponse.hash}">Tx link</a>`;

				 txLink = `${tokenExplorer}/tx/${tx.hash}`;//made global
				// let txLink = `${tokenExplorer}/tx/${tx.hash}`;
						console.log(`Transaction link: ${txLink}`);
						document.getElementById('resultMessage').innerHTML += `✅<br><span class ="tx"> SUCCESS 🎉🎉🎉!!! Here is the tx  <a href="${txLink}" target="_blank">Link</a> ✨✨✨</span>`

						// -------------
						//close modal and reset its UI
						closeModalId("#walletSend")
						resetWalletSendModal();

						// -------------
						// display success 
						Swal.fire({
							icon: "success",
							title: `Sent ${amount} ${tokenName}!💸`,
							html: `<span class ="tx">Transaction was mined in block ${receipt.blockNumber} ✅</span><br><span class ="tx"> Here is the tx  <a href="${txLink}" target="_blank">Link</a> ✨✨✨</span>`
						});



				}

							// CAN CHAT?
							const canChat = await iusnaturalisxmtp.canMessage(toAddress);
							console.log("Can message?: " + canChat);
						
							if (canChat) {
								// Uncaught (in promise) ReferenceError: tokenName is not defined

							  // Perform the action if the address can chat
							  console.log("The address can chat. Proceeding...");
							const conversation = await iusnaturalisxmtp.conversations.newConversation(toAddress)
							let message = `sent you ${amount} ${tokenName} <a href="${txLink}" target="_blank">Link</a> <pre style="display: none;" txLink="${txLink}" preferredToken="${JSON.stringify(preferredToken)}" >paymentReceived0x21</pre> `
							await conversation.send(`${message}`, {})
							} else {
							  console.log("The address cannot chat. Displaying a message...");
							}
							

							await loadToken(userAddress)// UPDATE BALANCE

							playtxReceived()



			});

			// return cws
		});





		document.getElementById('cancelTransactionBtn').addEventListener('click', function () {
			// Switch back to form tab if cancelled
			console.log('cancel send transaction PRESSED!')

			// const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
			const formTab = new bootstrap.Tab(document.getElementById('preparetx-tab'));

			formTab.show();
		});


		function resetWalletSendModal() {
    // Reset the form
    const form = document.getElementById('transactionFormWalletSend');
    if (form) {
        form.reset();
    }

    // Reset token selector
    const tokenType = document.getElementById('tokenType');
    if (tokenType) {
        // tokenType.innerHTML = '<option class="loading-option">Loading tokens</option>';
        tokenType.innerHTML = `<option class="loading-option">${dictionary[globalLang]["loadingtokens"]}</option>`;
        tokenType.disabled = true;
    }

    // Reset recipient address
    const recipientAddress = document.getElementById('recipientAddress');
    if (recipientAddress) {
        recipientAddress.value = '';
        recipientAddress.readOnly = true;
    }

    // Hide stealth section and reset its fields
    const stealthSection = document.getElementById('stealthSection');
    if (stealthSection) {
        stealthSection.classList.add('d-none');
        const stealthAddressCheckbox = document.getElementById('stealthAddressCheckbox');
        if (stealthAddressCheckbox) stealthAddressCheckbox.checked = false;

        const sarecipientAddress = document.getElementById('sarecipientAddress');
        if (sarecipientAddress) sarecipientAddress.innerHTML = '';

        const staddrInfo = document.getElementById('staddrInfo');
        if (staddrInfo) staddrInfo.innerHTML = '';
    }

    // Reset amount input
    const amount = document.getElementById('amount');
    if (amount) {
        amount.value = '';
        amount.step = '0.01';
        amount.min = '0';
    }

    // Reset ERC-20 details section
    const erc20Details = document.getElementById('erc20Details');
    if (erc20Details) {
        erc20Details.classList.add('d-none');
        const erc20ContractAddress = document.getElementById('erc20ContractAddress');
        if (erc20ContractAddress) erc20ContractAddress.value = '';
    }

    // Reset tab navigation
    const tabs = document.getElementById('myTab');
    if (tabs) tabs.style.display = 'none';

    const tabContent = document.getElementById('walletSendContent');
    if (tabContent) {
        const prepareTxTab = document.getElementById('preparetx-tab');
        const prepareTxPane = document.getElementById('preparetx');
        const confirmationPane = document.getElementById('confirmation');
        const resultPane = document.getElementById('result');

        if (prepareTxTab) prepareTxTab.classList.add('active');
        if (prepareTxPane) prepareTxPane.classList.add('show', 'active');
        if (confirmationPane) confirmationPane.classList.remove('show', 'active');
        if (resultPane) resultPane.classList.remove('show', 'active');
    }

    // Clear transaction details and result message
    const transactionDetails = document.getElementById('transactionDetails');
    if (transactionDetails) transactionDetails.innerHTML = '';

    const resultMessage = document.getElementById('resultMessage');
    if (resultMessage) resultMessage.innerHTML = '';
}



		// Function to get ETH to USD conversion rate from CoinGecko
		async function getEthUsdPrice() {
			const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd');
			const data = await response.json();
			return data.ethereum.usd;
		}


		// *********************************
		// ADD DOC
		// *********************************

		function addField() {
			console.log("addField()")
			const fieldContainer = document.getElementById('additionalFields');
			const newField = document.createElement('div');
			newField.classList.add('mb-2');
			newField.innerHTML = '<input type="text" class="form-control" placeholder="Enter text">';
			fieldContainer.appendChild(newField);
		}


		function addDoc(obj) {
			console.log('addDoc', obj)


			document.getElementById('input_image').click();

			document.getElementById('input_image').onchange = async function (e) {

				// 1- add 'adding document' spin to button
				addDocumentButton.disabled = true;
				plusAddDocumentButton.style.display = 'none'
				spinAddDocumentButton.style.display = 'inline'

				let name = input_image.files[0].name
				let title = name.substring(0, name.lastIndexOf('.')) || name;
				console.log('NEW title', title)

				let newStr = name.replace(/[\s-]/g, "");
				console.log('new compresed TITLE: ', newStr);

				const data = input_image.files[0]
				console.log('DATA: ', data);

				// V2 UPLOAD TO IPFS
				// let ipfsGateway = 'https://gateway.lighthouse.storage/ipfs/'
				const files = [new File([data], name, { type: 'application/pdf' })]
				console.log('files: ', files);
				const uploadResponse = await lighthouse.upload(files, apiKeyLighthouse);
				u = uploadResponse;
				console.log(uploadResponse);
				let cid = `${uploadResponse.data.Hash}`
				let ipfsGateway = optionsList[0].IPFS_GATEWAY;
				let ipfsLink = `${ipfsGateway}${uploadResponse.data.Hash}`
				const status = await lighthouse.dealStatus(`${uploadResponse.data.Hash}`)
				console.log('status:', status)
				let price = await lighthouse.getPrice(1024, "filecoin", "native")
				console.log('price:', price)

				Toast.fire(dictionary[globalLang]["fileuploaded"], '', "success");

				// ADD DOCS TO UI
				// 1-ADD TO UI(table)
				// let cid2ui = addCidToUI(title, cid)
				// console.log('cid2ui:', cid2ui)

				// ADD DOC NEW


				// RELOAD TRANSALATIONS
				reloadTranslations();


				// ADD TO LOCALSTORAGE
				let scid = cid.trim()
				let ct = [];
				let documentAttestLink = '';//null no es aceptado por polybase
				let doc = { title: title, cid: scid, courtesy_translations: ct, attestation: documentAttestLink }//NEW
				console.log('doc:', doc)
				SaveDocToLocalStorage(doc);
				d = doc

				// ADD DOCS TO UI
				loadDocs()

				// HASH OF DOCS
				const hash = ethers.sha256(ethers.toUtf8Bytes(JSON.stringify(doc)));
				console.log('sha-256', hash);


				// ADD TO DID
				let did = `did:ius:${userAddress}`;
				// getDocsFromLocalstorage
				let docsFromLS = localStorage.getItem('documents');

				await updateDIDdocs(did, docsFromLS)

				// activate envoi button
				console.log('ACTIVA BOTON ENVOI')
				// document.getElementById('createIPFSDelivery').disabled = false;// DESACTIVAR BOTON createIPFSDelivery
				// document.querySelector('#cancelAttesting').disabled = false;


				// RETORE toggleButton
				// 1- add 'adding document' spin to button
				addDocumentButton.disabled = false;
				plusAddDocumentButton.style.display = 'inline'
				spinAddDocumentButton.style.display = 'none'


			}




		}




		function addCidToUI(title, cid) {
			let o = `  <div class="card mb-3"> <div class="card-body"> 
        <h5 class="card-title">
          ${title}
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"  onclick="event.stopPropagation();editTitle('${title}',event)" height="13px">
              <path fill='currentColor' d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/></svg>
          </h5>
           <p class="card-text"></p> <p class="card-link" onclick="copyItem(event,innerHTML)"> ${cid}</p> </div> <div class="card-footer text-muted"><span> 
                
                <button type="button" class="btn btn-outline-info px-3 waves-effect" onclick="event.stopPropagation();viewItem('${cid}')"> <svg width="18" height="16" class="svg-inline--fa fa-eye" aria-hidden="true" data-prefix="fas" data-icon="eye" role="img" viewBox="0 0 576 512"> <path fill="currentColor" d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7 0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zm144 224c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zm-144-64c0 35.3-28.7 64-64 64-11.5 0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4 0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8 0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"> </path> </svg> </button>
                
                <button type="button" class="btn btn-outline-info waves-effect px-3"
                  onclick="event.stopPropagation();deleteItem((this.parentElement))">
                  <svg xmlns="http://www.w3.org/2000/svg"  width="18" height="16" viewBox="0 0 512 512">
                <path fill="currentColor" d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>
                    </button>
                    
                <button type="button" class="btn btn-outline-info waves-effect px-3"
                  onclick="event.stopPropagation();showCIDQR('${cid}','${title} ')"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="16" viewBox="0 0 512 512">
                <path fill="currentColor" d="M0 80C0 53.5 21.5 32 48 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V80zM64 96v64h64V96H64zM0 336c0-26.5 21.5-48 48-48h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V336zm64 16v64h64V352H64zM304 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H304c-26.5 0-48-21.5-48-48V80c0-26.5 21.5-48 48-48zm80 64H320v64h64V96zM256 304c0-8.8 7.2-16 16-16h64c8.8 0 16 7.2 16 16s7.2 16 16 16h32c8.8 0 16-7.2 16-16s7.2-16 16-16s16 7.2 16 16v96c0 8.8-7.2 16-16 16H368c-8.8 0-16-7.2-16-16s-7.2-16-16-16s-16 7.2-16 16v64c0 8.8-7.2 16-16 16H272c-8.8 0-16-7.2-16-16V304zM368 480a16 16 0 1 1 0-32 16 16 0 1 1 0 32zm64 0a16 16 0 1 1 0-32 16 16 0 1 1 0 32z"/></svg></button>
                
                <button type="button" class="btn btn-outline-info waves-effect px-3"
				onclick="event.stopPropagation();testifyDocument('${cid}','${title} ')"><i class="fa-solid fa-plus" aria-hidden="true"></i>
				<span data-translate="testifyDocument">Add</span></button>
                
				</span></div> </div>  `;
			document.getElementById('tbody').innerHTML += o;
			// <button type="button" class="btn btn-outline-info waves-effect px-3" onclick="event.stopPropagation();uploadCourtesyTranslation(this.parentElement)"><i class="fa-solid fa-plus" aria-hidden="true"></i> <span data-translate="addcourtesytranslation">Add</span></button>

		}



		/*********************************************************************************************
		.) EDIT TABLE ITEMS
		**********************************************************************************************/



		function viewItem(cid) {
			let ipfsGateway = optionsList[0].IPFS_GATEWAY;
			let ipfslink = `${ipfsGateway}${cid}`;
			console.log('ipfslink:', ipfslink);
			window.open(ipfslink, '_blank', 'fullscreen=yes');
			return false;
		}

		function openLink(link) {
			console.log('openLink:', link);
			window.open(link, '_blank', 'fullscreen=yes');
			return false;
		}

		function shareItem(cid) {
			// Logic to share the document by its CID (Content Identifier)
			// This could involve copying a link to the clipboard, sharing via an API, etc.

			// Example: Copy a link to the clipboard
			const shareLink = `https://example.com/ipfs/${cid}`;

			navigator.clipboard.writeText(shareLink).then(() => {
				alert('Link copied to clipboard!');
			}).catch(err => {
				console.error('Failed to copy link: ', err);
			});
		}



		async function showCIDQR(cid, title) {
			let ipfsGateway = optionsList[0].IPFS_GATEWAY;
			let linkIPFS = `${ipfsGateway}${cid}`
			console.log(cid, title, linkIPFS)
			const cidqr = new QRCodeStyling({
				width: 300, height: 300, type: "png", data: linkIPFS, image: `logo4.png`,
				dotsOptions: { color: "#41307c", type: "extra-rounded" }, backgroundOptions: { color: "#fff", }, imageOptions: {
					crossOrigin: "anonymous", margin: 0
				}
			});
			let cidqrRaw = await cidqr.getRawData('png')
			console.log(' WATCH showCIDQR cidqrRaw: ', cidqrRaw)
			let cidqrURL = URL.createObjectURL(cidqrRaw)

			console.log('xqr: ', cidqr)


			Swal.fire({
				text: title,
				imageUrl: cidqrURL,
				imageWidth: 300,
				imageHeight: 300,
				imageAlt: 'QR Code image',
			})
		}



		function editTitle(title, event) {
			console.log(title, event, event.target, event.target.parentNode)
			let curtitle = title
			Swal.fire({
				html: ` <h1>Current title: <span id="currenttitle">${curtitle}</span></h1> 
        
        <br>
        
        <h1>
        ${dictionary[globalLang]["newtitle"]}
        </h1>
        `,
				input: 'text',
				inputAttributes: {
					autocapitalize: 'off'
				},
				showCancelButton: true,
				confirmButtonText: 'change',
				showLoaderOnConfirm: true,
				preConfirm: (login) => { },
				allowOutsideClick: () => {
					const popup = Swal.getPopup()
					popup.classList.remove('swal2-show')
					setTimeout(() => { popup.classList.add('animate__animated', 'animate__headShake') })
					setTimeout(() => { popup.classList.remove('animate__animated', 'animate__headShake') }, 500)
					return false
				},

			})
				.then((result) => {
					if (result.isConfirmed) {
						console.log('RESULT:', result.value)
						let title = result.value;
						let htmlcontent = `${title} <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"  onclick="event.stopPropagation();editTitle('${title}',event)" height="13px"> <path fill='currentColor' d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/></svg> `
						event.target.parentNode.innerHTML = htmlcontent;
						setTimeout(() => { updateArray(); console.log(' saved!') }, 1000);
						return
					}
				})
		}



		async function loadPublicDocsCard(docs) {
			console.log('loadPublicDocsCard()', docs);

			let LoadDocs = JSON.parse(docs);
			let htmlContent = '';

			if (LoadDocs) {
				LoadDocs.forEach((e) => {
					let t = e.title,
						n = e.cid,
						i = e.courtesy_translations,
						at = e.attestation;

					var s = [];

					i.forEach((e, t) => {
						let n = e.lang,
							i = `<button type="button" class="btn btn-outline-info px-3 waves-effect" onclick="event.stopPropagation(); viewItem('${e.cid}')">  <span>${n} </span><svg width="18" height="16" class="svg-inline--fa fa-language" aria-hidden="true" data-prefix="fas" data-icon="language" role="img" viewBox="0 0 640 512"> <path fill="currentColor" d="M0 128c0-35.3 28.7-64 64-64h512c35.3 0 64 28.7 64 64v256c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128zm320 0v256h256V128H320zm-141.7 47.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2l19 42.8h-38l19-42.8zM448 164c11 0 20 9 20 20v4h60c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5 0-28.3s20.5-7.8 28.3 0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z" /> </svg></button>`;
						s.push(i);
					});

					let o = `<div class="card mb-3">
                <div class="card-body">
                  <h5 class="card-title">${t}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" onclick="event.stopPropagation();editTitle('${t}',event)" height="13px"> 
                      <path fill='currentColor' d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/>
                    </svg>
                  </h5>
                  <p class="card-text"></p>
                  <p class="card-link" onclick="copyItem(event,innerHTML)">${n}</p>
                </div>
                <div class="card-footer text-muted">
                  <span>
                    <button type="button" class="btn btn-outline-info px-3 waves-effect" onclick="event.stopPropagation();viewItem('${n}')"> 
                      <svg width="18" height="16" class="svg-inline--fa fa-eye" aria-hidden="true" data-prefix="fas" data-icon="eye" role="img" viewBox="0 0 576 512"> 
                        <path fill="currentColor" d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7 0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zm144 224c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zm-144-64c0 35.3-28.7 64-64 64-11.5 0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4 0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8 0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z">
                        </path>
                      </svg>
                    </button>
             
                    <button type="button" class="btn btn-outline-info waves-effect px-3" onclick="event.stopPropagation();copy2clipboard('${n}')">
                      <svg xmlns="http://www.w3.org/2000/svg"  width="18" height="16"  viewBox="0 0 512 512"> 
                        <path fill="currentColor" d="M352 320c-22.1 0-42.1 8.6-57.4 22.7l-126-78.3c.9-5 1.4-10.1 1.4-15.4s-.5-10.4-1.4-15.4l126-78.3C309.9 183.4 329.9 192 352 192c44.2 0 80-35.8 80-80s-35.8-80-80-80-80 35.8-80 80c0 5.3.5 10.4 1.4 15.4l-126 78.3c-15.3-14.1-35.3-22.7-57.4-22.7-44.2 0-80 35.8-80 80s35.8 80 80 80c22.1 0 42.1-8.6 57.4-22.7l126 78.3c-.9 5-1.4 10.1-1.4 15.4 0 44.2 35.8 80 80 80s80-35.8 80-80-35.8-80-80-80z">
                        </path>
                      </svg>
                    </button>

					</span>
					</div>
					</div>`;
					htmlContent += o;
				});
			}

			return htmlContent;
		}

		// <button type="button" class="btn btn-outline-info waves-effect px-3">${s.join("")}</button>

		async function loadDocs() {
			console.log('DOCS FUNCTION')
			document.getElementById('tbody').innerHTML = '';

			let LoadDocs = JSON.parse(window.localStorage.getItem('documents'));
			if (LoadDocs) {

				LoadDocs.forEach((e) => {
					let t = e.title,
						n = e.cid,
						i = e.courtesy_translations;

					var s = [];

					i.forEach((e, t) => {
						let n = e.lang,
							i = `<button type="button" class="btn btn-outline-info px-3 waves-effect" onclick="event.stopPropagation(); viewItem('${e.cid}')">  <span>${n} </span><svg width="18" height="16" class="svg-inline--fa fa-language" aria-hidden="true" data-prefix="fas" data-icon="language" role="img" viewBox="0 0 640 512"> <path fill="currentColor" d="M0 128c0-35.3 28.7-64 64-64h512c35.3 0 64 28.7 64 64v256c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128zm320 0v256h256V128H320zm-141.7 47.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2l19 42.8h-38l19-42.8zM448 164c11 0 20 9 20 20v4h60c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5 0-28.3s20.5-7.8 28.3 0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z" /> </svg></button>
                   `;
						s.push(i);
					});


					let o = `  <div class="card mb-3"> <div class="card-body"> 
                <h5 class="card-title"> ${t}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"  onclick="event.stopPropagation();editTitle('${t}',event)" height="13px"> <path fill='currentColor' d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/></svg> </h5>
                <p class="card-text"></p> <p class="card-link" onclick="copyItem(event,innerHTML)"> ${n}</p> </div> <div class="card-footer text-muted"><span> 
                
                <button type="button" class="btn btn-outline-info px-3 waves-effect" onclick="event.stopPropagation();viewItem('${n}')"> <svg width="18" height="16" class="svg-inline--fa fa-eye" aria-hidden="true" data-prefix="fas" data-icon="eye" role="img" viewBox="0 0 576 512"> <path fill="currentColor" d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7 0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zm144 224c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zm-144-64c0 35.3-28.7 64-64 64-11.5 0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4 0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8 0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"> </path> </svg> </button>
                
                <button type="button" class="btn btn-outline-info waves-effect px-3"
                  onclick="event.stopPropagation();deleteItem((this.parentElement))">
                  <svg xmlns="http://www.w3.org/2000/svg"  width="18" height="16" viewBox="0 0 512 512">
                <path fill="currentColor" d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>
                    </button>
                    
                <button type="button" class="btn btn-outline-info waves-effect px-3"
                  onclick="event.stopPropagation();showCIDQR('${n}','${t} ')"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="16" viewBox="0 0 512 512">
                <path fill="currentColor" d="M0 80C0 53.5 21.5 32 48 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V80zM64 96v64h64V96H64zM0 336c0-26.5 21.5-48 48-48h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V336zm64 16v64h64V352H64zM304 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H304c-26.5 0-48-21.5-48-48V80c0-26.5 21.5-48 48-48zm80 64H320v64h64V96zM256 304c0-8.8 7.2-16 16-16h64c8.8 0 16 7.2 16 16s7.2 16 16 16h32c8.8 0 16-7.2 16-16s7.2-16 16-16s16 7.2 16 16v96c0 8.8-7.2 16-16 16H368c-8.8 0-16-7.2-16-16s-7.2-16-16-16s-16 7.2-16 16v64c0 8.8-7.2 16-16 16H272c-8.8 0-16-7.2-16-16V304zM368 480a16 16 0 1 1 0-32 16 16 0 1 1 0 32zm64 0a16 16 0 1 1 0-32 16 16 0 1 1 0 32z"/></svg></button>
                <button type="button" class="btn btn-outline-info waves-effect px-3"
                  onclick="event.stopPropagation();uploadCourtesyTranslation(this.parentElement)"><i class="fa-solid fa-plus"
                    aria-hidden="true"></i> <span data-translate="addcourtesytranslation">Add</span></button>
                <button type="button" class="btn btn-outline-info waves-effect px-3"
                  onclick="event.stopPropagation();testifyDocument('${n}','${t} ')"><i class="fa-solid fa-plus" aria-hidden="true"></i>
                  <span data-translate="testifyDocument">Add</span></button>
                
                ${s.join("")} </span></div> </div>  `;
					document.getElementById('tbody').innerHTML += o;
				});

			}
		}




		async function deleteItem(obj) {
			console.log('deleteItem()', obj)
			Swal.fire({
				title: dictionary[globalLang]["sure"],
				text: dictionary[globalLang]["wontbeabletorevertthis"],
				icon: 'warning',
				showCancelButton: true,
				confirmButtonColor: '#3085d6',
				cancelButtonColor: '#d33',
				confirmButtonText: dictionary[globalLang]["yes"]
			})
				.then((result) => {
					if (result.isConfirmed) {

						// 1- GET INDEX
						let rowid = obj.parentNode.getAttribute('data-index');
						console.log('riwid: ', rowid)

						// 2- DELETE FROM LOCALSTORAGE
						let docs = Array.from(document.getElementById('uploadedDocuments').children);//HECHO GLOBAL TEMPORALMENTE.
						let docNames = [];
						docs.forEach(function (docs, index) {
							let t = docs.children[0].children[0].innerText//title
							let c = docs.children[0].children[2].innerText.trim();// cid
							let att = docs.children[0].children[3];// attestation
							let ctc = docs.children[0].children[4];// courtesy translations
							let ct = [];

							// Check if ctc is defined before proceeding
							if (ctc !== undefined) {
								var newArray = Array.from(ctc)
									.filter(function (item) {
										let x = item.hasAttribute('data-cid');
										if (item.hasAttribute('data-cid')) {
											let y = item.dataset.lang; // lang
											let z = item.dataset.cid.trim(); //cid
											let courtesytranslations = { lang: y, cid: z };
											ct.push(courtesytranslations);
										}
									});
							} else {
								// Handle the case where ctc is undefined
								console.warn("Courtesy translations are undefined");
							}

							let doc = { title: t, cid: c, courtesy_translations: ct }
							docNames.push(doc);
						});

						let updatedDocNames = docNames.filter(item => item !== docNames[rowid])
						localStorage.setItem('documents', JSON.stringify(updatedDocNames));


						// UPDATE DID
						let did = `did:ius:${userAddress}`;
						updateDIDdocs(did, updatedDocNames)

						// 4- SEND SWEET MESSAGE
						Toast.fire(dictionary[globalLang]["documentdeleted"], '', "success");

					}
				})
		}


		// async function decryptData(msg, privkey) {


		// }
		async function decryptData(encryptedString, privateKey) {
    // 1. Parse the encrypted string into an object
    const encryptedObject = EthCrypto.cipher.parse(encryptedString);

    // 2. Decrypt the payload using Bob's private key
    const decryptedPayload = await EthCrypto.decryptWithPrivateKey(
        privateKey, // Bob's private key
        encryptedObject
    );

    // 3. Parse the decrypted payload back into an object
    const payload = JSON.parse(decryptedPayload);

    // 4. Verify the signature
    const signerAddress = EthCrypto.recover(
        payload.signature,
        EthCrypto.hash.keccak256(payload.message)
    );

    console.log("Decrypted message:", payload.message);
    console.log("Signer address:", signerAddress);

    return payload.message;
}




		async function encryptData(msg, pubkey) {

			//1. firma el hash del mensaje
			//2. arma un payload con el mensaje + la firma 
			//3. lo encrpta
			//4. lo convierte en estring



			// 0. get priv key
			let signer = await getSigner()
			if (!signer) {
				console.log('Handle case where signer is not obtained');
			}
			let alicePrivateKeyA = signer.privateKey

			// 1.
			const signature = EthCrypto.sign(
				alicePrivateKeyA,
				EthCrypto.hash.keccak256(msg)
			);
			console.log('HASH of encryptData(): ', EthCrypto.hash.keccak256(msg))

			// 2.
			const payload = {
				message: msg,
				signature
			};
			console.log('payload:', payload)


			// 3.
			const encrypted = await EthCrypto.encryptWithPublicKey(
				ethers.getBytes(pubkey), // by encrypting with bobs publicKey, only bob can decrypt the payload with his privateKey
				JSON.stringify(payload) // we have to stringify the payload before we can encrypt it
			);


			// 4.
			const encryptedString = EthCrypto.cipher.stringify(encrypted);
			// console.log('🔒 Encrypted data:', encryptedString)

			return encryptedString
		}



		/*********************************************************************************************
		.) SHOW WALLET
		**********************************************************************************************/
		async function showWallet() {
			console.log('showWallet')

			Swal.close(); // Close the modal
			// open modal
			openModalId('#walletModal')

			document.getElementById("loadingSpinner").style.display = "flex";

			let addr = document.getElementById('yourAddress').getAttribute("address");

			const transactions = await handleTransactionHistory(addr);
			console.log("Loaded transactions:", transactions);

			document.getElementById("loadingSpinner").style.display = "none";
		
		

		}


		// DESKTOP NOTIFICATIONS
		function requestNotificationPermission() {
			if ("Notification" in window) {
				Notification.requestPermission().then(permission => {
					if (permission === "granted") {
						console.log("Notification permission granted.");
						localStorage.setItem("notificationsEnabled", "true");
						document.getElementById("notificationToggle").checked = true;
					} else {
						console.log("Notification permission denied.");
						localStorage.setItem("notificationsEnabled", "false");
						document.getElementById("notificationToggle").checked = false;
					}
				});
			} else {
				console.log("This browser does not support desktop notification.");
			}
		}

		// Set initial toggle state on page load
		function initializeNotificationToggle() {
			console.log('initializeNotificationToggle()👨‍🚀')
			// alert('initializeNotificationToggle()👨‍🚀')
			const toggle = document.getElementById("notificationToggle");
			const notificationsEnabled = localStorage.getItem("notificationsEnabled");

			// Set toggle based on stored permission state
			toggle.checked = notificationsEnabled === "true";

			// Add event listener to request permission if toggled on
			toggle.addEventListener("change", () => {
				if (toggle.checked) {
					requestNotificationPermission();
					notificationMessage.classList.remove('alert-danger');
					notificationMessage.classList.add('alert-success');
					notificationMessage.textContent = 'Notifications are now enabled.';
					notificationMessage.style.display = 'block';
				} else {
					localStorage.setItem("notificationsEnabled", "false");
					notificationMessage.classList.remove('alert-success');
					notificationMessage.classList.add('alert-danger');
					notificationMessage.textContent = 'Notifications are now disabled.';
					notificationMessage.style.display = 'block';
				}
			});
		}

		// Call initializeNotificationToggle when the page loads
		document.addEventListener("DOMContentLoaded", initializeNotificationToggle);



		function showNotification(title, body) {
			if (Notification.permission === "granted") {
				const options = {
					body: body,
					icon: "img/logowt.png"  // Optional icon
				};
				new Notification(title, options);
			}
		}




		// CUANDO TODO CARGO< CARGA ALGUNOS EVENTLISTENERS

		


		/*********************************************************************************************
		  .) DOMContentLoaded
		  **********************************************************************************************/

		  document.addEventListener('DOMContentLoaded', function () {
			console.log('👂 listen DOMContentLoaded')
			const erc20Option = document.getElementById('erc20Option');
			const erc20Options = document.getElementById('erc20Options');
			const addErc20Address = document.getElementById('addErc20Address');
			const erc20Selector = document.getElementById('erc20Selector');
			const removeErc20Address = document.getElementById('removeErc20Address');
			const infoErc20Address = document.getElementById('infoErc20Address');


			//   ------------------------------------
			// .) LISTEN TO EDIT ALIAS NAME CHANGE
			//   ------------------------------------

			const aliasInput = document.getElementById('aliasName');
			const editButton = document.getElementById('editAlias');

			function enableEditing() {
				console.log('edit alias name')
				aliasInput.readOnly = false;
				editButton.textContent = 'Save';
			}

			async function disableEditing() {
				aliasInput.readOnly = true;
				editButton.textContent = 'Edit';
				// You can add additional code here to save the changes, e.g., sending data to the server
				// GET SIGNER
				let presigner = await getSigner()
				let provider = new ethers.JsonRpcProvider(`${optionsList[0].API}`); //v5
				let signer = presigner.connect(provider);
				console.log('SIGNER!:', signer);
				let did = `did:ius:${signer.address}`
				console.log('DID: ', did)

				// ---------------

				try {
					console.log('creating did RECORD, signer', signer)
					await updateAliasDID(did, aliasInput.value, signer)
					// updateAliasDID
				} catch (error) {
					console.error('An error occurred while creating DID record:', error);
					return
				}



				console.log('Alias name saved:', aliasInput.value);
			}

			editButton.addEventListener('click', function () {
				if (aliasInput.readOnly) {
					enableEditing();
				} else {
					disableEditing();
				}
			});


			//   ------------------------------------
			// .) LISTEN  STEALTH ADDRESS ALWAYS ON CHECKBOX
			//   ------------------------------------
			document.getElementById('stealthaddrAlwaysOnCheckbox').addEventListener('change',async function () {
				if (this.checked) {
					localStorage.setItem('stealthAddressAlwaysOn', 'true');
					console.warn('Stealth Address always on is ACTIVE and stored in localStorage');
				} else {
					localStorage.setItem('stealthAddressAlwaysOn', 'false');
					console.warn('Stealth Address always on is DISABLED and stored in localStorage');
				}


			});


			//   ------------------------------------
			// .) LISTEN TO STEALTH ADDRESS CHECKBOX CHANGE
			//   ------------------------------------
			document.getElementById('stealthAddressCheckbox').addEventListener('change',async function () {

				console.log('👮‍♂️ stealthAddressCheckbox CHANGED..')
				 recipientAddress;
				// let recipientAddress;

				if (this.checked) {
					prepareStealthAddr()
					localStorage.setItem('stealthAddressActive', true)

				return

			 

				} else {
					// localStorage.setItem('stealthAddressActive', 'false');
					console.warn('Stealth Address disabled and stored in localStorage');
					localStorage.setItem('stealthAddressActive', false)

			document.getElementById('sarecipientAddress').innerHTML = ``

				// recipientAddress = document.getElementById('recipientAddress').value;

				}

			});

			//   ------------------------------------
			// .) LISTEN TO TOKENTYPE CHANGES
			//   ------------------------------------
			// Show or hide ERC-20 options based on the selected radio button
			document.querySelectorAll('input[name="tokenType"]').forEach(function (input) {
				input.addEventListener('change', async function () {
					console.log('🎏 tokenType CHANGED!')
					localStorage.setItem('selectedTokenType', input.value);
					populateTokenSelector()

					if (erc20Option.checked) {
						erc20Options.style.display = 'block';
					} else {
						erc20Options.style.display = 'none';
					}


					try {
						await loadToken()
					} catch (error) {
						console.warn(error)
					}
					Toast.fire({ title: "Token loaded!", text: "The Token has been loaded.", icon: "success" });

				});
			});

			//   ------------------------------------
			// .) REMOVE TOKEN
			//   ------------------------------------
			removeErc20Address.addEventListener('click', function () {

				Swal.fire({ title: "Are you sure?", text: "You won't be able to revert this!", icon: "warning", showCancelButton: true, confirmButtonColor: "#3085d6", cancelButtonColor: "#d33", confirmButtonText: "Yes, delete it!" })
					.then((result) => {
						if (result.isConfirmed) {

							const selectedOption = erc20Selector.options[erc20Selector.selectedIndex];
							if (selectedOption) {
								// Retrieve the stored data from localStorage
								let index = selectedOption.value
								let i = Number(index)
								let storedData = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];
								console.log(storedData[i].contractAddr)

								// remove token from localStorage
								removeToken(storedData[i].contractAddr)

								// Remove from select
								selectedOption.remove();



							} else {
								console.log('DOES NOT EXSITS')
								// alert('token doenst exist, what should i do?')
								Swal.fire({
									title: 'Token doesn\'t exist',
									text: 'What should I do?',
									icon: 'warning',
									showCancelButton: true,
									confirmButtonText: 'Reset to Default',
									cancelButtonText: 'Ignore',
									reverseButtons: true,
								  }).then((result) => {
									if (result.isConfirmed) {
									  // Reset to default
									  console.log('Resetting to default...');
									setDefaultTokens ()
									// return									  
									  erc20Selector.selectedIndex = 0; // Example: Reset to the first option
									} else if (result.dismiss === Swal.DismissReason.cancel) {
									  // Ignore
									  console.log('Ignoring the issue...');
									  // Add your logic for ignoring the issue here
									}
								  });
									
							}

							closeModalId('#defaultTokenModal')
							Toast.fire({ title: "Deleted!", text: "Token has been deleted.", icon: "success" });
							localStorage.setItem('preferredTokenIndex', 0);
							loadToken()
						}
					});



			});

			//   ------------------------------------
			// .) INFO TOKEN
			//   ------------------------------------
			// Show information about the selected ERC-20 contract
			infoErc20Address.addEventListener('click', function () {

				const selectedOption = erc20Selector.options[erc20Selector.selectedIndex];
				let index = selectedOption.value
				let i = Number(index)

				if (selectedOption) {
					// Retrieve the stored data from localStorage
					let storedData = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];
					console.log(storedData[i])
					alert(`Info: ${JSON.stringify(storedData[i])}`);

				}
			});

		});



		/*********************************************************************************************
		.) FIN DOMContentLoaded
		**********************************************************************************************/


		   
function loadSettingsPreferences(){
	console.log('loadSettingsPreferences()')

		//   ------------------------------------
		// .) EVM TOKENS
		//   ------------------------------------

		//   ------------------------------------
		// .) 🦹‍♂️↔️🦹‍♀️ Stealth addresses always on
		//   ------------------------------------
		const checkbox = document.getElementById("stealthaddrAlwaysOnCheckbox");
		const stealthAddressOn = localStorage.getItem('stealthAddressAlwaysOn');
			if (stealthAddressOn === 'true') {
				console.log('stealthAddressAlwaysOn is on')
				checkbox.checked = true;
			} else {
				console.log('stealthAddressAlwaysOn is off')
				checkbox.checked = false;
			}


}

// Cargar las entradas desde localStorage o usar los datos iniciales
window.onload = () => {
            // let savedEntries = JSON.parse(localStorage.getItem("blogEntries")) || initialEntries;
            // savedEntries.forEach(entry => addEntry(entry.title, entry.link, false));
        };

		/*********************************************************************************************
		.) DISPLAY USER HISTORICAL TXs user historical transactions
		**********************************************************************************************/
// The function to fetch transaction history from Arbiscan
async function getTransactionHistoryFromArbiscan(address) {
  const apiKey = "YOUR_ARBISCAN_API_KEY"; // Replace with your API key
  const url = `https://api-sepolia.arbiscan.io/api?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999&sort=asc&apikey=${apiKey}`;

  try {
    const response = await fetch(url);
    const data = await response.json();

    if (data.status === "1") {
      return data.result; // Return the transaction history array
    } else {
      console.error("Error:", data.message);
      return [];
    }
  } catch (error) {
    console.error("Error fetching transaction history:", error);
    return [];
  }
}

// Function to store data in localStorage
function storeTransactionHistory(address, transactions) {
  const key = `transactions_${address}`;
  const transactionsJSON = JSON.stringify(transactions);
  localStorage.setItem(key, transactionsJSON);
}

// Function to retrieve data from localStorage
function getTransactionHistoryFromStorage(address) {
  const key = `transactions_${address}`;
  const transactionsJSON = localStorage.getItem(key);
  return transactionsJSON ? JSON.parse(transactionsJSON) : null;
}


function displayTransactionHistory(transactions) {
    const historyContainer = document.getElementById('transaction-history');
    historyContainer.innerHTML = ''; // Clear previous content

    transactions.forEach((transaction, index) => {
        console.warn('transaction:', transaction);

        // Generate the transaction date
        const transactionDate = new Date(JSON.parse(transaction.timeStamp)).toLocaleString();

        // Create an accordion item for each transaction
        const accordionItem = document.createElement('div');
        accordionItem.classList.add('accordion-item');

        accordionItem.innerHTML = `
            <h2 class="accordion-header" id="heading-${index}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${index}" aria-expanded="false" aria-controls="collapse-${index}">
                    ${transactionDate} - ${transaction.value} ETH
                </button>
            </h2>
            <div id="collapse-${index}" class="accordion-collapse collapse" aria-labelledby="heading-${index}" data-bs-parent="#transaction-history">
                <div class="accordion-body">
                    <p><strong>Timestamp:</strong> ${transactionDate}</p>
                    <p><strong>Value:</strong> ${transaction.value} ETH</p>
                    <p><strong>Status:</strong> ${transaction.txreceipt_status}</p>
                    <p><strong>Transaction Hash:</strong> 
                        <a href="https://etherscan.io/tx/${transaction.hash}" class="transaction-link" target="_blank">
                            ${transaction.hash.slice(0, 6)}...${transaction.hash.slice(-4)}
                        </a>
                    </p>
                </div>
            </div>
        `;

        historyContainer.appendChild(accordionItem);
    });
}

 
 

// Function to handle fetching and displaying transactions
async function handleTransactionHistory(address) {
  // Check if data is already in localStorage
  const storedTransactions = getTransactionHistoryFromStorage(address);

  if (storedTransactions) {
    console.log("Using cached data.");
    displayTransactionHistory(storedTransactions);
  } else {
    console.log("Fetching new data.");
    const transactions = await getTransactionHistoryFromArbiscan(address);
    if (transactions.length > 0) {
      // Store fetched transactions in localStorage
      storeTransactionHistory(address, transactions);
      displayTransactionHistory(transactions);
    } else {
      console.log("No transactions found for this address.");
    }
  }
}
 

		//   OFFLINE ONLINE MODES
		 // Function to check and update online/offline status
		 function updateStatus() {
      const statusMessage = document.getElementById('headerNotes');

      if (navigator.onLine) {
        // statusMessage.textContent = 'You are back online!';
        statusMessage.textContent = dictionary[globalLang]["youarebackonline"];
        statusMessage.className = 'online';
        statusMessage.style.display = 'flex';
        setTimeout(() =>
        statusMessage.textContent = ''
		//  statusMessage.style.display = 'none!important'
		 , 3000);
      } else {
        // statusMessage.textContent = 'You are offline. Please check your connection.';
        statusMessage.textContent = dictionary[globalLang]["youareoffline"];
        statusMessage.className = 'offline';
        statusMessage.style.display = 'flex';
      }
    }

		  

	
// 	document.addEventListener('visibilitychange', () => {
//   if (document.visibilityState === 'visible') {
//     alert('The web app is visible to the user.');
//   } else {
//     console.log('The web app is not visible to the user.');
//   }
// });
	</script>

	<!-- <script type="module" src="js/demo1.js"></script> -->

</body>

</html>