<!DOCTYPE html>
<html lang="en" class="no-js">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>IUS NATURALIS DAPP</title>
		<meta name="description" content="a DID managing tool to communicate your public and private data with sovereignty" />
		<meta name="keywords" content="did, starknet " />
		<meta name="author" content="Xunorus" />
		<link rel="shortcut icon" href="favicon.ico">
		<link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet">
		
        <script src="js/sweetalert2.all.min.js"></script>
        <script src="js/qr-code-styling.js"></script>
		
		
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
		
		<link rel="stylesheet" type="text/css" href="css/cropper.css" />
		<!-- <link rel="stylesheet" type="text/css" href="css/meterchat.css" /> -->
		<link rel="stylesheet" type="text/css" href="css/iusdapp.css" />
		<link rel="stylesheet" type="text/css" href="css/buttons.css" />
 

		<!--[if IE]>
  		<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]--><script>document.documentElement.className = 'js';</script>
	</head>
	<body class="demo-1">
 	
	
		<!-- /*********************************************************************************************
  .) OVERLAY
  **********************************************************************************************/ -->

		<div class="overlay"></div>

 
 	<!-- /*********************************************************************************************
  .) LOCK UNLOCK BANNER
  **********************************************************************************************/ -->
  <div id='lockscreen' class="cover-container" style="display: none;" >
    <img src="img/logo.png" alt="Cover Image" class="cover-image"  >

    <!-- <h1 class="cover-heading">Locked</h1> -->
    <button id="unlockButton" class="btn btn-primary btn-unlock" onclick="event.stopPropagation();unlockLocalwallet()" >Unlock</button>
  </div>

  <!-- /*********************************************************************************************
  .) SIDEBAR
  **********************************************************************************************/ -->
  <div id="sidebar" class='sidebar'>
    <a class='closeonclick' href="/">
      <div class='title'> </div>
    </a>
   
    <input name="avatarIMG" id="avatarIMGfile" type="file" style="display:none" accept="image/*" /> <!-- ex fileCreateItemFile -->
    <img id="avatarIMG" src="img/anonym.jpg" alt="Avatar" class=""> <!-- ex itemImgMINT -->
 
    <div class="container mt-3">
      <div class="row">
        <div class="col text-center" id="configButtons">
          
			<button type="button" id="" class="btn btn-primary" onclick="event.stopPropagation();addAddress()">
            <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 640 512">
              <path
                d="M96 128a128 128 0 1 1 256 0A128 128 0 1 1 96 128zM0 482.3C0 383.8 79.8 304 178.3 304h91.4C368.2 304 448 383.8 448 482.3c0 16.4-13.3 29.7-29.7 29.7H29.7C13.3 512 0 498.7 0 482.3zM504 312V248H440c-13.3 0-24-10.7-24-24s10.7-24 24-24h64V136c0-13.3 10.7-24 24-24s24 10.7 24 24v64h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H552v64c0 13.3-10.7 24-24 24s-24-10.7-24-24z" />
            </svg>
          </button>
          <button type="button" id="" class="btn btn-danger" onclick="event.stopPropagation(); scanAddress()">
            <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512">
              <path
                d="M0 80C0 53.5 21.5 32 48 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V80zM64 96v64h64V96H64zM0 336c0-26.5 21.5-48 48-48h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V336zm64 16v64h64V352H64zM304 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H304c-26.5 0-48-21.5-48-48V80c0-26.5 21.5-48 48-48zm80 64H320v64h64V96zM256 304c0-8.8 7.2-16 16-16h64c8.8 0 16 7.2 16 16s7.2 16 16 16h32c8.8 0 16-7.2 16-16s7.2-16 16-16s16 7.2 16 16v96c0 8.8-7.2 16-16 16H368c-8.8 0-16-7.2-16-16s-7.2-16-16-16s-16 7.2-16 16v64c0 8.8-7.2 16-16 16H272c-8.8 0-16-7.2-16-16V304zM368 480a16 16 0 1 1 0-32 16 16 0 1 1 0 32zm64 0a16 16 0 1 1 0-32 16 16 0 1 1 0 32z" />
            </svg>
          </button>
          <button type="button" id="" class="btn btn-success" onclick="event.stopPropagation(); settings()">
            <svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">
              <path
                d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z" />
            </svg>
          </button>
        </div>
      </div>
    </div>
	<!-- <button class="btn btn-primary fullwidth" id="mintOrUpdate" onclick="event.stopPropagation(); mintOrUpdate()" disabled> Mint -->
		<!-- <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">
			<path
				d="M440 6.5L24 246.4c-34.4 19.9-31.1 70.8 5.7 85.9L144 379.6V464c0 46.4 59.2 65.5 86.6 28.6l43.8-59.1 111.9 46.2c5.9 2.4 12.1 3.6 18.3 3.6 8.2 0 16.3-2.1 23.6-6.2 12.8-7.2 21.6-20 23.9-34.5l59.4-387.2c6.1-40.1-36.9-68.8-71.5-48.9zM192 464v-64.6l36.6 15.1L192 464zm212.6-28.7l-153.8-63.5L391 169.5c10.7-15.5-9.5-33.5-23.7-21.2L155.8 332.6 48 288 464 48l-59.4 387.3z" />
		</svg> -->
	<!-- </button> -->

	<button class="btn btn-primary fullwidth" style="display: none;" id="updateOnchain" onclick="event.stopPropagation(); updateOnchainDID()" disabled> Update
	</button>
	
	<ul id="cwContacts" class="nav">
	<!--  
	<li data-address="0x137a64f5F1C1C0595d4C9c12E68f99fA6f841407" id="0x137a64f5F1C1C0595d4C9c12E68f99fA6f841407" class=""> 
		<a onclick="event.stopPropagation();selectChat((this.parentElement))">  
			<img id="did:ethr:0x137a64f5F1C1C0595d4C9c12E68f99fA6f841407" src="img/avatar.png" alt="Avatar" class="rounded-circle"> 
				<span>0x137a...1407 <span> 
			<i class="fa-solid fa-trash"></i>
			<svg onclick="event.stopPropagation();editContact('0x137a64f5F1C1C0595d4C9c12E68f99fA6f841407')" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="20" height="25" class="right">
				<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"></path>
			</svg>
		</span></span></a> 
	</li> -->
	
</ul>

<button class="btn btn-primary fullwidth" id="mintOrUpdate" onclick="event.stopPropagation(); mintOrUpdate()" disabled> Mint

</button>

  </div>


    <!-----------------------------
	LOADER 
	--------------------------->
<div class="loaderDiv" id="loader"> <span class="loader"></span> </div>

		<svg class="hidden">
			<defs>

				<!-- 1 -->
				<symbol id="icon-menu" viewBox="0 0 24 24" >
					<title >menu</title>
					<image preserveAspectRatio="none" inkscape:svg-dpi="300" width="17.49" height="19.988571" style="image-rendering:optimizeQuality" xlink:href="data:image/svg+xml;base64,PHN2ZyBpZD0iaWNvbi1tZW51IiB2aWV3Qm94PSIwIDAgNDQ4IDUxMiI+CjxwYXRoIGQ9Ik0wIDk2 QzAgNzguMyAxNC4zIDY0IDMyIDY0SDQxNmMxNy43IDAgMzIgMTQuMyAzMiAzMnMtMTQuMyAzMi0z MiAzMkgzMkMxNC4zIDEyOCAwIDExMy43IDAgOTZ6TTAgMjU2YzAtMTcuNyAxNC4zLTMyIDMyLTMy SDQxNmMxNy43IDAgMzIgMTQuMyAzMiAzMnMtMTQuMyAzMi0zMiAzMkgzMmMtMTcuNyAwLTMyLTE0 LjMtMzItMzJ6TTQ0OCA0MTZjMCAxNy43LTE0LjMgMzItMzIgMzJIMzJjLTE3LjcgMC0zMi0xNC4z LTMyLTMyczE0LjMtMzIgMzItMzJINDE2YzE3LjcgMCAzMiAxNC4zIDMyIDMyeiIvPgo8L3N2Zz4K " id="image120" x="3.2550001" y="2.0057144" />
				  </symbol>				 
				  <!-- 1 -->
				<symbol id="icon-arrow" viewBox="0 0 24 24">
					<title>arrow</title>
					<polygon points="6.3,12.8 20.9,12.8 20.9,11.2 6.3,11.2 10.2,7.2 9,6 3.1,12 9,18 10.2,16.8 "/>
				</symbol>

				<symbol id="icon-drop" viewBox="0 0 24 24">
					<title>drop</title>
					<path d="M12,21c-3.6,0-6.6-3-6.6-6.6C5.4,11,10.8,4,11.4,3.2C11.6,3.1,11.8,3,12,3s0.4,0.1,0.6,0.3c0.6,0.8,6.1,7.8,6.1,11.2C18.6,18.1,15.6,21,12,21zM12,4.8c-1.8,2.4-5.2,7.4-5.2,9.6c0,2.9,2.3,5.2,5.2,5.2s5.2-2.3,5.2-5.2C17.2,12.2,13.8,7.3,12,4.8z"/><path d="M12,18.2c-0.4,0-0.7-0.3-0.7-0.7s0.3-0.7,0.7-0.7c1.3,0,2.4-1.1,2.4-2.4c0-0.4,0.3-0.7,0.7-0.7c0.4,0,0.7,0.3,0.7,0.7C15.8,16.5,14.1,18.2,12,18.2z"/>
				</symbol>
				<symbol id="icon-search" viewBox="0 0 24 24">
					<title>search</title>
					<path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
				</symbol>
				<symbol id="icon-cross" viewBox="0 0 24 24">
					<title>cross</title>
					<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
				</symbol>
			</defs>
		</svg>

		
		
		<main class="main-wrap">
			<header class="codrops-header">
				<h1 class="codrops-header__title" id="userData">IUS NATURALIS</h1>
				<div class="search-wrap">
					<button id="btn-search" class="btn btn--search" style="display: none;"> <svg class="icon icon--search"><use xlink:href="#icon-search"></use></svg></button>

				</div>

				<span class="badge bg-primary" id="chatBadge">-</span>
				<button id="" class="right hamburger hamburger--elastic" type="button" aria-label="Menu" aria-controls="navigation">
				  <span class="hamburger-box">
					<span class="hamburger-inner"></span>
				  </span>
				</button>


			</header>

<!-- =================== -->
<div id="qrtroqcontainer" class=" container swiperSlide">


	<div class=" responsive-svg" id="canvas"></div>
		
</div>
<pre id="yourAddress"> </pre>
<!-- ======================= -->
 

<div id="qrresult"> </div>


<!-- boton -->
 <!-- ADD PUBLIC DOCUMENTS -->
<button class="btn btn-primary btn-lg " id="createIPFSDelivery"
onclick="event.stopPropagation();publishInDID((this.parentElement))" disabled data-translate="publicipfs">
<i class="fa-solid fa-envelope-circle-check"></i> Preparer comme Envoi
IPFS</button>

	<div class="bottom-nav">
		<nav class="codrops-demos">
			<span>v4.0 </span>
		</nav>
	</div>

<!-- FIN UI -->

</main>


<div class="search" id="chatContainer">
	<button id="btn-search-close" class="btn btn--search-close" aria-label="Close search form" onclick="event.stopPropagation();deleteChat((this.parentElement))"><svg class="icon icon--cross"><use xlink:href="#icon-cross"></use></svg></button>

	<div id="chatheader" class="">
		<span id="chatAddress"></span>
		<span class="alignright " id="actionButtons"> </span>
	</div>


	
	<div class="search__related" id="chatBox">
		<div class="search__suggestion">
			<h3>Contacts</h3>
			<p>#drone #funny #catgif #broken #lost #hilarious #good #red #blue #nono #why #yes #yesyes #aliens #green</p>

			<h3>Blocked</h3>
			<p>#0x123456789123456786,#0x123456789123456785,#0x123456789123456784</p>

			<h3>Unapproved contacts</h3>
			<p>#0x123456789123456789,#0x123456789123456788,#0x123456789123456787</p>
		</div>
	 
	</div>

 
<form class="search__form" action="" id="chatfooter" onsubmit="sendMessage()">

		<input   id="chatTextInput" class="search__input" name="search"   placeholder="Type a message..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled/>

		<button class="btn btn-primary" id="send-button" onclick="sendMessage()" disabled>
			<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">
				<path
					d="M440 6.5L24 246.4c-34.4 19.9-31.1 70.8 5.7 85.9L144 379.6V464c0 46.4 59.2 65.5 86.6 28.6l43.8-59.1 111.9 46.2c5.9 2.4 12.1 3.6 18.3 3.6 8.2 0 16.3-2.1 23.6-6.2 12.8-7.2 21.6-20 23.9-34.5l59.4-387.2c6.1-40.1-36.9-68.8-71.5-48.9zM192 464v-64.6l36.6 15.1L192 464zm212.6-28.7l-153.8-63.5L391 169.5c10.7-15.5-9.5-33.5-23.7-21.2L155.8 332.6 48 288 464 48l-59.4 387.3z" />
			</svg>
		</button>

		<button class="btn btn-primary" id="send-attachment" onclick="sendAttachment()" disabled>

			<svg xmlns="http://www.w3.org/2000/svg"  height="1em"viewBox="0 0 448 512">
				<path d="M364.2 83.8c-24.4-24.4-64-24.4-88.4 0l-184 184c-42.1 42.1-42.1 110.3 0 152.4s110.3 42.1 152.4 0l152-152c10.9-10.9 28.7-10.9 39.6 0s10.9 28.7 0 39.6l-152 152c-64 64-167.6 64-231.6 0s-64-167.6 0-231.6l184-184c46.3-46.3 121.3-46.3 167.6 0s46.3 121.3 0 167.6l-176 176c-28.6 28.6-75 28.6-103.6 0s-28.6-75 0-103.6l144-144c10.9-10.9 28.7-10.9 39.6 0s10.9 28.7 0 39.6l-144 144c-6.7 6.7-6.7 17.7 0 24.4s17.7 6.7 24.4 0l176-176c24.4-24.4 24.4-64 0-88.4z"/></svg>
		</button>
		
		<span class="search__info">Hit enter to send or ESC to close</span>
	</form>


</div><!-- /search chat-->


<!-- MODALS -->
	<!-- Modal DID SAVE -->
	
  <!-- Modal -->
  <div class="modal fade" id="didManagerModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="didManagerModalLabel">User Information</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- First row: Picture and Change Avatar button -->
          <div class="row mb-3">
            <div class="col-12 text-center">
              <img src="https://via.placeholder.com/150" id="aliasAvatar"  alt="Avatar" class="img-thumbnail" >
              <div class="mt-2">
                <button class="btn btn-secondary btn-sm" id="changeAvatar">Change Avatar</button>
              </div>
            </div>
          </div>
          <!-- Second row: Text input field and additional form -->
          <div class="row mb-3">
            <div class="col-12">
              <label for="aliasName" class="form-label">Alias Name</label>
              <input type="text" class="form-control" id="aliasName" placeholder="Enter alias name">
              <form class="mt-3">
                <div id="additionalFields"></div>
                <button type="button" class="btn btn-secondary btn-sm" onclick="addField()">Add More Fields</button>
              </form>
            </div>
          </div>
          <!-- Third row: Save DID button -->
          <div class="row">
            <div class="col-12 text-center">
              <button type="button" class="btn btn-primary">SAVE DID</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

	<!-- fin Modal DID SAVE -->

	<!-- Modal BACKUP WALLET -->
	<div class="modal fade" data-bs-backdrop="static" id="walletBackp" tabindex="-1" role="dialog" aria-labelledby=""
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="walletCreation" id="">WALLET CREATION</h5>
				</div>
				<div class="modal-body" id="walletHiddenContent">
					<div id="displayPubKey"></div>
					<div id="displayPK"></div>
					<div id="displayMnemonic"></div>
					<div id="displayDecrypt"></div>
					<div id="success_message2" class="alert alert-success" role="alert" style="display: none;"></div>
				</div>
				<div class="modal-footer">
					<div class="form-check">
						<input class="form-check-input" type="checkbox" value="" id="mnemonicBackedup" disabled>
						<label class="form-check-label" for="mnemonicBackedup">
							I wrote down the mnemonic phrase
						</label>
					</div>
					<button type="button" class="btn btn-outline-secondary closeWalletBkp" id="closeBackupmodal"
						data-bs-dismiss="modal" data-translate="close" disabled>Close</button>
				</div>
			</div>
		</div>
	</div>


	<!-- Modal wallet RESTORE -->
	<div class="modal fade" data-bs-backdrop="static" id="walletRestore" tabindex="-1" role="dialog" aria-labelledby=""
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="walletrestore" id="">WALLET RESTORE</h5>
				</div>
				<div class="modal-body">
					<!-- SEED -->
					<div id="seedData">
						<div class="mb-3">
							<label for="seedTextarea" class="form-label">Paste your seed, mnemonic or ETH Private key</label>
							<textarea class="form-control" id="seedTextarea" rows="3"></textarea>
						</div>
						<!-- PASSWORD -->
						<div class="row g-3 align-items-center">
							<div class="col-auto">
								<label for="seedPassword" class="col-form-label">Password</label>
							</div>
							<div class="col-auto">
								<input type="password" id="seedPassword" class="form-control"
									aria-describedby="passwordHelpInline">
								<div class="valid-feedback">Valid.</div>
								<div class="invalid-feedback">Please set a password.</div>
							</div>

						</div>
					</div>
					<div id="displayRestoreProgress"></div>
					<div id="success_message3" class="alert alert-success" role="alert" style="display: none;"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary closeWalletBkp" id="closeWalletRestore"
						data-bs-dismiss="modal" data-translate="close">Cancel</button>
					<button type="button" class="btn btn-outline-secondary closeWalletBkp" id="setWalletRestore"
						data-translate="restore" onclick="event.stopPropagation(); restoreSeed()"
						disabled>Restore</button>
				</div>
			</div>
		</div>
	</div>
	<!-- fin walelt RESTORE WALLET-->

	<!-- SCAN MODAL -->
	<div class="modal fade" data-bs-backdrop="static" id="scanModal" tabindex="-1" role="dialog" aria-labelledby=""
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="scanqr" id="">Scan QR</h5>
				</div>

				<div class="modal-body" id="">
					<div class="">
						<div class="responsive-svg" id="qrcanvas"></div>
						<video id="qrScanVideo" width="300" height="300"></video>
						<div id="scanResult"></div>

					</div>

					<div class="modal-footer">
						<button type="button" class="btn btn-outline-secondary closeWalletBkp" id="closeScanModal"
							data-translate="close">Close</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- fin SCAN MODAL-->



	<!-- SETTINGS MODAL -->
	<div class="modal fade" id="settingsModal" data-bs-backdrop="static" tabindex="-1"
		aria-labelledby="settingsModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="settingsModalLabel">SETTINGS </h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>


				<div class="modal-body" id="settingsCardContainer">
					<h4>Keys management</h4>

					<button type="button" id="" class="btn btn-primary" onclick="event.stopPropagation(); backup()">
						<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">
							<path fill="currentColor"
								d="M512 32c0 113.6-84.6 207.5-194.2 222c-7.1-53.4-30.6-101.6-65.3-139.3C290.8 46.3 364 0 448 0h32c17.7 0 32 14.3 32 32zM0 96C0 78.3 14.3 64 32 64H64c123.7 0 224 100.3 224 224v32V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V320C100.3 320 0 219.7 0 96z" />
						</svg> Backup </button>

					<button type="button" id="" class="btn btn-primary"
						onclick="event.stopPropagation(); restoreWallet()"> <svg xmlns="http://www.w3.org/2000/svg"
							height="16" width="16" viewBox="0 0 512 512">
							<path fill="currentColor"
								d="M174.7 45.1C192.2 17 223 0 256 0s63.8 17 81.3 45.1l38.6 61.7 27-15.6c8.4-4.9 18.9-4.2 26.6 1.7s11.1 15.9 8.6 25.3l-23.4 87.4c-3.4 12.8-16.6 20.4-29.4 17l-87.4-23.4c-9.4-2.5-16.3-10.4-17.6-20s3.4-19.1 11.8-23.9l28.4-16.4L283 79c-5.8-9.3-16-15-27-15s-21.2 5.7-27 15l-17.5 28c-9.2 14.8-28.6 19.5-43.6 10.5c-15.3-9.2-20.2-29.2-10.7-44.4l17.5-28zM429.5 251.9c15-9 34.4-4.3 43.6 10.5l24.4 39.1c9.4 15.1 14.4 32.4 14.6 50.2c.3 53.1-42.7 96.4-95.8 96.4L320 448v32c0 9.7-5.8 18.5-14.8 22.2s-19.3 1.7-26.2-5.2l-64-64c-9.4-9.4-9.4-24.6 0-33.9l64-64c6.9-6.9 17.2-8.9 26.2-5.2s14.8 12.5 14.8 22.2v32l96.2 0c17.6 0 31.9-14.4 31.8-32c0-5.9-1.7-11.7-4.8-16.7l-24.4-39.1c-9.5-15.2-4.7-35.2 10.7-44.4zm-364.6-31L36 204.2c-8.4-4.9-13.1-14.3-11.8-23.9s8.2-17.5 17.6-20l87.4-23.4c12.8-3.4 26 4.2 29.4 17L182 241.2c2.5 9.4-.9 19.3-8.6 25.3s-18.2 6.6-26.6 1.7l-26.5-15.3L68.8 335.3c-3.1 5-4.8 10.8-4.8 16.7c-.1 17.6 14.2 32 31.8 32l32.2 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-32.2 0C42.7 448-.3 404.8 0 351.6c.1-17.8 5.1-35.1 14.6-50.2l50.3-80.5z" />
						</svg> Restore </button>

					<br>
					<br>
						<!-- <input type="checkbox" id="muteCheckbox" name="muteCheckbox">
						<label for="muteCheckbox">Make Insecure(doenst require a password unlock the wallet)</label> -->
					<hr>

					<h4>Language</h4>

					<div class="options">

						<select class="right translation" id="langswitch">
							<option value="en">en</option>
							<option value="fr">fr</option>
							<option value="es">es</option>
						</select>
					</div>


					<hr>

					<h4>Signatures to broadcast</h4>

					<ul class="options" id="sig2Broadcast">
					<li>lkasdmfklnsfdlkgnsdfpgioenpwnglkfdsxnclkdsnklfdnsalkfnldksanflksndfl</li>
					<li>nrew,nernpnvopxcoivopcxiovidopixcopvioxcpvocxipvoickxpvoicxopviocpx</li>
					
					
					<button  class="btn btn-primary">publish</button>
					<span>
						<input type="checkbox" id="muteCheckbox" name="muteCheckbox">
							<label for="muteCheckbox">AutoPublish(when its connected to the internet)</label>
					</span>


					</ul>

					<hr>
					<!-- <h4>Audio</h4>

					<div class="options" id="audioOptions">
						<input type="checkbox" id="muteCheckbox" name="muteCheckbox">
						<label for="muteCheckbox">Mute</label>
					</div>

					<hr> -->

					<h4>Chats</h4>

					<button type="button" id="" class="btn btn-primary"
					onclick="event.stopPropagation(); createGroupChat()"> 
				
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"  height="16" width="16" >
						<!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
						<path fill="currentColor" d="M72 88a56 56 0 1 1 112 0A56 56 0 1 1 72 88zM64 245.7C54 256.9 48 271.8 48 288s6 31.1 16 42.3V245.7zm144.4-49.3C178.7 222.7 160 261.2 160 304c0 34.3 12 65.8 32 90.5V416c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V389.2C26.2 371.2 0 332.7 0 288c0-61.9 50.1-112 112-112h32c24 0 46.2 7.5 64.4 20.3zM448 416V394.5c20-24.7 32-56.2 32-90.5c0-42.8-18.7-81.3-48.4-107.7C449.8 183.5 472 176 496 176h32c61.9 0 112 50.1 112 112c0 44.7-26.2 83.2-64 101.2V416c0 17.7-14.3 32-32 32H480c-17.7 0-32-14.3-32-32zm8-328a56 56 0 1 1 112 0A56 56 0 1 1 456 88zM576 245.7v84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM320 32a64 64 0 1 1 0 128 64 64 0 1 1 0-128zM240 304c0 16.2 6 31 16 42.3V261.7c-10 11.3-16 26.1-16 42.3zm144-42.3v84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM448 304c0 44.7-26.2 83.2-64 101.2V448c0 17.7-14.3 32-32 32H288c-17.7 0-32-14.3-32-32V405.2c-37.8-18-64-56.5-64-101.2c0-61.9 50.1-112 112-112h32c61.9 0 112 50.1 112 112z"/></svg>

					QR groupe Invite</button>
					<!-- scan this qr to be added to this group -->

				</div>


				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<!-- SETTINGS SETTINGS -->



	<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.29/Tone.min.js"></script>

	<script src="js/ethers-6.12.1.umd.min.js" type="application/javascript"></script>
 
		<script type="module" src="js/demo1.js"></script>
		<script src="js/dictionary.js"></script>
		<script type="module">
	  // XMTP
	  import { Client } from '@xmtp/xmtp-js'
		window.Client = Client;


			import QrScanner from "qr-scanner/qr-scanner.min.js";
		window.QrScanner = QrScanner; //make global
		QrScanner.hasCamera(); // test

		// import { Buffer } from 'buffer';
		// globalThis.Buffer = Buffer;



	import { Polybase } from "@polybase/client";
	window.Polybase = Polybase; //make global

		// CROPPER		
		import Cropper from 'cropperjs'
		window.Cropper = Cropper; //make global
		import { throttle } from '@github/mini-throttle'
		window.throttle = throttle; //make global

		import EthCrypto from 'eth-crypto';
        window.EthCrypto = EthCrypto;


</script>

		<script>


		/*********************************************************************************************
		.) VARIABLES
		// https://sepolia.etherscan.io/address/0xc4bF5CbDaBE595361438F8c6a187bDc330539c60#code

		**********************************************************************************************/
		window.optionsList = [
		{
				"TOKEN_ADDRESS": "0x4cb6cef87d8cadf966b455e8bd58fff32aba49d1",//usdc sepolia
				"TOKEN_CHAIN_NAME": 'MTR',
				"TOKEN_NAME": "MTR",
				"SYMBOL": "MTR",
				"API": 'https://rpctest.meter.io',
				"TOKEN_CHAINID": '83',
				"EXPLORER": 'https://scan-warringstakes.meter.io',
				"ERC20_CONTRACT_ADDRESS": "0x8a419ef4941355476cf04933e90bf3bbf2f73814",//MTRG token
				"REGISTRY_CONTRACT_ADDRESS":"0x70F0B5fa20C296703fe101f294913cd1B6cCE053",
				"POLYBASE_DB" :"https://explorer.testnet.polybase.xyz/studio/pk%2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3%2FSTARKID/collections/STARKID",
				"ZK_PUBKEY" :"2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3"
			},
		]
		// https://docs.meter.io/developer-documentation/introduction
		// https://scan-warringstakes.meter.io/
		// https://explorer-warringstakes.meter.io/tx/0x2460b70dd8785c01be3baefe3c6ef3c9d7b0348b1dcb423412ccda2a3f77ddcf

async function init(signer){
	
		
console.log(`

‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                    

‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                                                                       
                               
																				

`);
					console.log('init()')
	
					reloadTranslations()
					// await loadContacts()
	


					if (typeof signer === 'undefined') {
						console.warn('No signer passed at init()');
						let signer = await getSigner()
						if (signer === false) {
							console.log("The function returned false.");
							return
						}
	
						await createXMPTchat(signer)
					} else {
						// console.log('Signer provided:', signer);
						console.warn("SIGNER:",signer)
						await createXMPTchat(signer)
					}
				// -----------------------------------------
				//  CHECK IF USER COMES FROM A LINK
				const urlParams = new URLSearchParams(window.location.search);
				const arroba = urlParams.get('@');
				if (arroba !== null) {
					console.warn('there is @ in url!',arroba)
				}

				const t2AddrValue = urlParams.get('T2Addr');
				if (t2AddrValue !== null) {
					console.warn(`T2Addr FOUND! TRYING TO CHAT WITH: ${t2AddrValue}`);
					openChat()
					
					
					// const ethAddress = t2AddrValue.match(/0x[a-fA-F0-9]{40}/)[0];
					// console.log('chatwith:',ethAddress);  // Output: 0x28316586D8AE43BCa91Bb0D14D1EB9241Aa2C873
					// await chatWith(ethAddress)//mal addre3ss
					
					// check if has did
					// const regex = /^did:meter:0x[a-fA-F0-9]{64}$/;
						const regexDID = /^did:ius:0x[a-fA-F0-9]{40}$/;
						const regexAddress = /^0x[a-fA-F0-9]{40}$/;
						if (regexDID.test(t2AddrValue)) {
							// RESOLVE DID
							console.warn('‚úÖ t2AddrValue is in the correct format, FETCHING DID: ',t2AddrValue)
							let didData = await fetchDID(t2AddrValue)
							// d=didData;
							// console.log( `<br><br>RESULT: <br>DID: ${didData.data.id} <br>alias: ${didData.data.alias} <br>avatar: ${didData.data.avatar} <br>cid: ${didData.data.cid} <br>privData: ${didData.data.privData}`);
							await chatWith(didData.data.alias,JSON.parse(didData.data.avatar))
							console.warn( ` alias: ${didData.data.alias}`);
							document.getElementById('avatarImage').src =JSON.parse(didData.data.avatar)
							// ?????????????????????????????????????????
							// HAcer aqui o en SaveContactsToLocalStorage la verificacion de si existe un did?
							// ?????????????????????????????????????????
							let contact = { address: didData.data.alias, username: null, avatar: didData.data.avatar, did: t2AddrValue }
							console.warn('CONTACTO POR URL!',contact)
							
							SaveContactsToLocalStorage(contact);
	
							// await chatWith(didData.data.alias,JSON.parse(didData.data.avatar))
	
						} 
						else if (regexAddress.test(t2AddrValue)) {
							console.warn('‚≠ê t2AddrValue is and ETH ADDress in the correct format.');
							await chatWith(t2AddrValue)
	
						}
	
						else {
							console.warn('‚ùå t2AddrValue is NOT in the correct format.');
						}
					 
				} else {
					console.warn('T2Addr parameter not found in the URL');
				}
				// -----------------------------------------
	
					await getChatAddresses()
					 await loadContacts()
					await listenAllNewAddresses()
					
					
				 
				
				}
				init()
				
	
		
						// var isFullscreen = false;
			var body = document.querySelector('body');
		var lastTapTime = 0;
		var isFullscreen = false;

	function toggleFullscreen() {
		if (!isFullscreen) {
			if (document.documentElement.requestFullscreen) {
				document.documentElement.requestFullscreen();
			} else if (document.documentElement.msRequestFullscreen) {
				document.documentElement.msRequestFullscreen();
			} else if (document.documentElement.mozRequestFullScreen) {
				document.documentElement.mozRequestFullScreen();
			} else if (document.documentElement.webkitRequestFullscreen) {
				document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
			}
			isFullscreen = true;
		} else {
			if (document.exitFullscreen) {
				document.exitFullscreen();
			} else if (document.msExitFullscreen) {
				document.msExitFullscreen();
			} else if (document.mozCancelFullScreen) {
				document.mozCancelFullScreen();
			} else if (document.webkitExitFullscreen) {
				document.webkitExitFullscreen();
			}
			isFullscreen = false;
		}
	}
	
	
    /*********************************************************************************************
		.) SOUNDS
		**********************************************************************************************/

		function playBeep() {
		var AudioContext = window.AudioContext || window.webkitAudioContext;
		var audioCtx = new AudioContext();

		var oscillator = audioCtx.createOscillator();
		oscillator.type = "sine"; // Set the waveform type
		oscillator.frequency.value = 864; // Set the frequency (Hz)

		oscillator.connect(audioCtx.destination);
		oscillator.start();

		// Stop the oscillator after 100 milliseconds
		setTimeout(function () {
			oscillator.stop();
		}, 100);
		}


		// Initialize Tone.js
		Tone.start();
		console.log("tone started");
		// Create a simple click sound with different parameters
		const clickSynth = new Tone.Synth({
		oscillator: {
			type: "sine", // You can experiment with different oscillator types
		},
		envelope: {
			attack: 0.01,
			decay: 0.1,
			sustain: 0.1,
			release: 0.5,
		},
		}).toDestination();

		function playButtonClickSound() {
		// Trigger the synth to produce a short click sound
		clickSynth.triggerAttackRelease("C4", "8n");
		}
		
		/*********************************************************************************************
		.) MANAGE MODALS
		**********************************************************************************************/


function openModalId(id, event) {
  console.log("openingModal", id, event);
  setTimeout(() => {
    window[id + "Modal"] = new bootstrap.Modal(document.querySelector(`${id}`));
    window[id + "Modal"].show(event);

    // Check if the modal is open
    var isModalOpen = window[id + "Modal"]._isShown;
    // console.log("Is modal open?", window[id + "Modal"], isModalOpen);
  }, 50);
}

function closeModalId(id, event) {
  console.log("closing modal", id, event);
  var modal = window[id + "Modal"];
  if (modal && modal._isShown) {
    // console.log("Is modal open?", modal, modal._isShown);
    modal.hide(event);
  } else {
    console.log("Modal is not open or not defined.");
  }
}

/*********************************************************************************************
.) sweetalert2
// position: "top-right",
**********************************************************************************************/

			const ToastTop = Swal.mixin({
			toast: true,
			position: "bottom-end",
			showConfirmButton: false,
			timer: 3000,
			timerProgressBar: true,
			didOpen: (toast) => {
				toast.addEventListener("mouseenter", Swal.stopTimer);
				toast.addEventListener("mouseleave", Swal.resumeTimer);
			},
			iconColor: "white",
			customClass: {
				popup: "colored-toast",
			},
			});

			const Toast = Swal.mixin({
			toast: true,
			position: "bottom-end",
			showConfirmButton: false,
			timer: 3000,
			timerProgressBar: true,
			didOpen: (toast) => {
				toast.addEventListener("mouseenter", Swal.stopTimer);
				toast.addEventListener("mouseleave", Swal.resumeTimer);
			},
			iconColor: "white",
			customClass: {
				popup: "colored-toast",
			},
			});

			const fixedToast = swal.mixin({
			toast: true,
			position: "bottom-end",
			showConfirmButton: false,
			showDenyButton: false,
			showCancelButton: true,
			cancelButtonText: "Now!",
			confirmButtonText: "later ...",
			denyButtonText: `Close`,
			iconColor: "white",
			customClass: {
				popup: "colored-toast",
			},
			});


    /*********************************************************************************************
    .)  SIDEBAR
    **********************************************************************************************/

    // Get the navigation button and add a click event listener
    var navBtn = document.querySelector(".hamburger");
    navBtn.addEventListener("click", plToggle);

    // Define the plToggle function
    function plToggle(event) {
    //   console.log("TOOGLE NAVBAR", event);
      navBtn.classList.toggle("is-active");

      // Toggle classes for elements with class 'content', 'sidebar', and 'overlay'
      document.querySelector(".sidebar").classList.toggle("isOpen");
      document.querySelector(".overlay").classList.toggle("overlayisOpen");

      // Get the container element with class 'sidebar'
      var container = document.querySelector(".sidebar");
    }

    // Add a click event listener to the overlay element
    document.querySelector(".overlay").addEventListener("click", function (event) {
      console.log("clickeado en nav li");
      plToggle();
    });


    /*********************************************************************************************
    .)  COPY
    **********************************************************************************************/

function copy2clipboard(text) {
			// let text = `${ipfsGateway}${cid}`;
			console.log('COPIED!', text)
			let textLink = `<a href="${text}">${text}</a>`;

			if (window.clipboardData && window.clipboardData.setData) {
				ToastTop.fire('Copied to Clipboard', textLink, "success");
				return window.clipboardData.setData("Text", text);
			}
			else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
				var textarea = document.createElement("textarea");
				textarea.textContent = text;
				textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in Microsoft Edge.
				document.body.appendChild(textarea);
				textarea.select();
				try {
					ToastTop.fire('Copied to Clipboard!', textLink, "success");
					return document.execCommand("copy");  // Security exception may be thrown by some browsers.
				}
				catch (ex) {
					console.warn("Copy to clipboard failed.", ex);
					return prompt("Copy to clipboard: Ctrl+C, Enter", text);
				}
				finally {
					document.body.removeChild(textarea);
				}
			}
		}

		function shortAddressETH(address) {
    if (typeof address !== 'string' || address.length < 42) {
        throw new Error('Invalid Ethereum address');
    }
    return address.substring(0, 6) + "..." + address.substring(38, 42);
}

function shortAddressSTARK(address) {
    if (typeof address !== 'string' || address.length < 64) {
        throw new Error('Invalid StarkNet address');
    }
    return address.substring(0, 6) + "..." + address.substring(address.length - 4);
}

function reloadBalance(){
	console.log('reloadBalance()')
}




async function getLocalWalletSigner() {
      console.log('getLocalWalletSigner()');
      return Swal.fire({
        // title: 'Unlock your LOCALWALLET',
        title: dictionary[globalLang]["unlocklocalwallet"],
        input: 'password',
        inputAttributes: { autocapitalize: 'off' },
        showCancelButton: true,
        confirmButtonText: 'Enter',
        showLoaderOnConfirm: true,
        backdrop: true,
        html:  `<label for="rememberPassword">Remember Password</label> <input type="checkbox" id="rememberPassword" name="rememberPassword"> `,
        preConfirm: (login) => { },
        allowOutsideClick: () => {
          const popup = Swal.getPopup();
          popup.classList.remove('swal2-show');
          setTimeout(() => {
            popup.classList.add('animate__animated', 'animate__headShake');
          });
          setTimeout(() => {
            popup.classList.remove('animate__animated', 'animate__headShake');
          }, 500);
          return false;
        },
      }).then(async (result) => {
        if (result.isConfirmed) {
          console.log('password entered!');
          if (result.value == '') {
            console.log('IS EMPTY');
            Toast.fire({ icon: 'error', title: 'Password cannot be empty' });
            return null;
          }

          let encryptedjson = localStorage.getItem('jsonWallet');
          let ew = JSON.parse(encryptedjson);
          console.log('pub key of wallet in localstorage:', ew.address);

          try {
            return ethers.Wallet.fromEncryptedJson(encryptedjson, result.value).then(async (localWallet) => {
              console.log('localWallet.publicKey:', localWallet.publicKey);
              let provider = new ethers.JsonRpcProvider(`${optionsList[0].API}`); //v6
              const signer = localWallet.connect(provider);
              console.log('SIGNER:', signer);
              return signer;
            });
          } catch (error) {
            console.error('Error during wallet decryption:', error);
            Toast.fire('Error', error.message, "error");
            Swal.fire({
              icon: "error",
              title: "Error",
              text: error.message,
            });
            return null;
          }
        }
        return null;
      }).catch(error => {
        console.error('Error during Swal prompt:', error.reason);
        Toast.fire('Error', error.message, "error");
        Swal.fire({
          icon: "error",
          title: "Error",
          text: error.message,
        });


        return null;
      });
    }

// ---------------------------------------------

function toChecksumAddress(address) {
    return ethers.getAddress(address);
}


// -----------------------
// ------------------------------
async  function unlockLocalwallet(){

console.log('unlockLocalwallet()')
  // LOAD CHAT
	  let signer;
  console.log('there is no signer')
  signer = await getLocalWalletSigner();
  lockscreen.style.display='none'
  init(signer)

  if (!signer) {
	console.log('Handle case where signer is not obtained');
	lockscreen.style.display='flex'
	return; // Or throw an error, or handle the case in another way
  }

}

// ---------------------------------------------

async function getSigner(){
            console.log('getSigner()')
		
// 1- GET  PRIV KEY(IF not CREATE IT)
const chatETHPrivKey = localStorage.getItem('chatETHPrivKey');
if (!chatETHPrivKey) {
    console.warn('No chatETHPrivKey found. Checking for unbackedWallet.');

// 2- NO PRIV KEY, IS UNBACKEDWALLET?
    const unbackedWallet = localStorage.getItem('unbackedWallet');
    if (!unbackedWallet) {
        console.warn('No unbackedWallet found. Checking for jsonWallet.');

// 3-  NO UNBACKED WALLET, is JSONWALLET?
        const jsonWallet = localStorage.getItem('jsonWallet');
        if (!jsonWallet) {
            console.warn('No jsonWallet found.');
			// CREATE UNBACKED WALLET
			try { signer = await ethers.Wallet.createRandom() }
			catch (error) { console.log(error.message); 
			fixedToast.fire('Error', error.message, "error"); }
			console.warn('RANDOM WALLET CREATED!:', signer.address, 'mnemonic:', signer.mnemonic.phrase, 'privkey:', signer.privateKey)
			localStorage.setItem('unbackedWallet', JSON.stringify(signer.mnemonic.phrase))
					
        } else {
            // Handle jsonWallet
			// console.warn('3- YES JSON WALLET')
			console.warn('3- jsonWallet found. Checking for jsonWalletPassword.');
            const jsonWalletPassword = localStorage.getItem('jsonWalletPassword');
            if (!jsonWalletPassword) {
                console.warn('No jsonWalletPassword found.');
					// now GET password , decript the wallet
					// what we can do is automatically try to decrypt with ''
				//  signer = await ethers.Wallet.fromEncryptedJson(jsonWallet, '')


				// 1. get and form address from json wallet
				let addr =JSON.parse(jsonWallet).address;
				const checksumAddress = toChecksumAddress(`0x${addr}`);


				// 2. shot it into qr
				setAddress(checksumAddress)

				
				// 3. display UI in lock mode
				document.getElementById("loader").style.display = "none";//flex
				lockscreen.style.display='flex'

				return false

				// 4.ask user to open?

            } else {
                // Handle jsonWallet and jsonWalletPassword
                console.log('jsonWallet and jsonWalletPassword found.',jsonWalletPassword);
				//  signer = await ethers.Wallet.fromEncryptedJson(jsonWallet, '')
				 signer = await ethers.Wallet.fromEncryptedJson(jsonWallet, JSON.parse(jsonWalletPassword))

				
            }

        }
    } else {
        // Handle unbackedWallet
	console.warn('2- YES unbackedWallet', unbackedWallet)
	const walletData = JSON.parse(unbackedWallet);
	try{ signer = ethers.Wallet.fromPhrase(walletData);}
	catch (error) { console.warn(error.message, 'ERROR WALLET!'); localStorage.removeItem('unbackedWallet'); }


    }
} else {
    // Handle chatETHPrivKey
	console.warn('1- YES chatETHPrivKey', chatETHPrivKey)
		try { signer = await new ethers.Wallet(chatETHPrivKey) }
		catch (error) { 
			console.log(error.message);  
				document.getElementById("loader").style.display = "none";//flex
				lockscreen.style.display='flex';
		 }
}
 

			/////////////////////////////
			// 2- SHOW QR WITH DID LINK
			/////////////////////////////
			console.warn('EVM ADDRESS (getSigner): ', signer.address)
			setAddress(signer.address)
			let balance= await checkGasBalance(signer.address) 
			userData.innerHTML = 'balance:'+ balance +` <svg xmlns="http://www.w3.org/2000/svg"  width="18" height="16" viewBox="0 0 512 512" id='reloadBalance'  onclick="event.stopPropagation();reloadBalance()"> <path fill="currentColor" d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/></svg> `;

			// 4- CREATE DID IF IT EXISTS READ IT (1st TRY read then write)
            // let did = `${signer.address}`; //JUST THE  ADDRESS
            // let did = `did:meter:${signer.address}`
            let did = `did:ius:${signer.address}`

			// IF. READ DID 
			console.log('üí¨ READ YOUR DID:', did)
			let rdid =  await readDIDRecord(did);

			if(rdid.data==null){
				console.warn('DID NULL, creatre ONE')
				// IF DID == nullWRITE DID
				
				let avatar = '';
				let alias = signer.address;
				let privData = '';
				let cid = '';
				try {
					const result = await createDIDRecord(did, avatar, alias, privData, cid, signer);
					if (result) {
						console.log('The DID record was created successfully.');
					} else {
						console.warn('Failed to create the DID record.');
					}
				} catch (error) {
					console.error('An error occurred while creating the DID record:', error);
				}

				// const result = await createDIDRecord(did, avatar, alias, privData, cid, signer);
				// if (result) {
				// 	console.log('The DID record was created successfully.');
				// } else {
				// 	console.warn('Failed to create the DID record.');
				// }
				
			} else {
				console.warn(`DID EXISTENT!:  ${rdid.data.id}`);

				// CHECK if avatar
				let avtr = rdid.data.avatar;
				if (avtr) {
					let avatar = JSON.parse(avtr);
					document.getElementById('avatarIMG').src = avatar;
					// Now you can use the avatar object
				} else {
					// Handle the case where avtr is empty
					console.log('Avatar data is empty');
				}

				// ACTIVATE BUTTON TO MINT OR UPDATE
				document.getElementById('mintOrUpdate').disabled = false;

			}

		 
			
			return signer
			
         
}


		/*********************************************************************************************
		.)  BAKCUP
		**********************************************************************************************/
		function backupWallet(mnemonic) {
			console.log('now, backupWallet()', mnemonic)
			//////////////////////
			// CREATE WALLET
			Swal.fire({
				title: dictionary[globalLang]["createpasswordtoencryptwallet"],
				input: 'password',
				inputAttributes: {
					autocapitalize: 'off'
				},
				showCancelButton: true,
				confirmButtonText: 'create',
				showLoaderOnConfirm: true,
				// preConfirm: (login) => { },
				backdrop: true,

				inputValidator: (value) => {
					if (!value) {
						return 'You need to set a password to create your wallet!'
					}
				},

				allowOutsideClick: () => {
					const popup = Swal.getPopup()
					popup.classList.remove('swal2-show')
					setTimeout(() => { popup.classList.add('animate__animated', 'animate__headShake') })
					setTimeout(() => { popup.classList.remove('animate__animated', 'animate__headShake') }, 500)
					return false
				},

			})
				.then(async (result) => {
					if (result.isConfirmed) {
						// console.log('PASSWORD RESULT:',result.value)

						await makeBackup(result.value, mnemonic)
						return result.value
					}
				})


		}
		async function makeBackup(pwd, mnemonic) {

// console.log('MAKE BACKUP address:', signer.address)
console.log('MAKE BACKUP mnemonic:', mnemonic)


// WRITE YOUR MNEMONIC PHRASE
displayMnemonic.innerHTML = ` <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height='40px' width='40px' fill="currentColor"> <path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/></svg>Write down your mnemonic phrase to access your wallet in the future! :</h3> <div class="alert alert-warning alert-dismissible fade show"> <strong>${mnemonic}</strong> </div> `


// CREATING ENCRYPTED LOCAL WALLET
displayMnemonic.innerHTML += ` <div  id="loaderCW"  > <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span> creating encrypted wallet ... </div> `

// SAVE TO LOCALSTORAGE (encrypted?)
console.log('password: ', pwd)
try {
	// wallet = ethers.HDNodeWallet.fromMnemonic(mnemonic);
	wallet = ethers.Wallet.fromPhrase(mnemonic)
}
catch{
	console.warn(error)
}
const promisseJSON = wallet.encrypt(pwd);
promisseJSON.then((jsonWallet) => {
	console.log(jsonWallet)
	console.log('WALLET ENCRYPTED')

	// loaderCW
	document.getElementById('loaderCW').innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
<symbol id="check-circle-fill" fill="currentColor" viewBox="0 0 16 16">
<path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
</symbol>
<symbol id="info-fill" fill="currentColor" viewBox="0 0 16 16">
<path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
</symbol>
<symbol id="exclamation-triangle-fill" fill="currentColor" viewBox="0 0 16 16">
<path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
</symbol>
</svg>

<div class="alert alert-success d-flex align-items-center" role="alert">
<svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Success:"><use xlink:href="#check-circle-fill"/></svg>
<div>
Wallet encrypted and saved into localstorage
</div>
</div>
`


	localStorage.setItem('jsonWallet', jsonWallet)
	console.log(' ENCRYPTED JSONWALLET SAVED INTO LOCALSTORAGE')
	//   localStorage.setItem('encryptedAddress', wallet.address)
	console.log(' ENCRYPTED ADDRESS SAVED INTO LOCALSTORAGE')

	setTimeout(() => {
		const checkbox = document.getElementById('mnemonicBackedup');
		// const button = document.getElementById('closeWalletBkp');
		const button = document.getElementById('closeBackupmodal');

		mnemonicBackedup.disabled = false;
		// closeBackupmodal
		// Add an event listener to the checkbox to track its state
		checkbox.addEventListener('change', function () {
			// If the checkbox is checked, enable the button; otherwise, disable it
			button.disabled = !this.checked;
			mnemonicBackedup.disabled = true;
			console.log('close mnemonic activated')

			// NOW DELETE unbackedWallet
			localStorage.removeItem('unbackedWallet')

		});
		// init();
	}, 1000);


});


setTimeout(() => {
	openModalId('#walletBackp')

}, 50);

}
	/*********************************************************************************************
		.)  QR
		**********************************************************************************************/
		async function showqr(addr) {
			const qrColor = getComputedStyle(document.body).getPropertyValue('--qr');

			var isMobile = window.matchMedia("only screen and (max-width: 768px)");

			// let qrSize
			if (isMobile.matches) {
				console.log("Mobile screen detected");
				qrSize = 310;
				window.scrollTo(0, 0);


			} else {
				// Code for larger screens
				console.log("Not a mobile screen");
				qrSize = 370

			}

			//QR
			// width: `${qrSize}`, height: `${qrSize}`, type: "png", data: addr, image: `./logo4.png`,
			const qrCode = new QRCodeStyling({
				width: `${qrSize}`, height: `${qrSize}`, type: "png", data: addr, image: `./logowhite.png`,
				dotsOptions: { color: `${qrColor}`, type: "extra-rounded" },
				backgroundOptions: { color: "var(--qrbackground)", },
				imageOptions: { crossOrigin: "anonymous", margin: 0 }
			});
			qrCode.append(document.getElementById("canvas"));
			console.log('qr code APPENDED')
			document.querySelector('.main-wrap').style.backgroundImage = 'none';
			loader.style.display= 'none'

		}


			async function fetchDID(did) {
							try {
								const didresult = await readDIDRecord(did);

								if (didresult.data != null) {
									console.log(did + ' HAS A RECORD!!!');
									// console.log( `<br><br>RESULT: <br>DID: ${didresult.data.id} <br>alias: ${didresult.data.alias} <br>avatar: ${didresult.data.avatar} <br>cid: ${didresult.data.cid} <br>privData: ${didresult.data.privData}`);
									// let avtr = didresult.data.avatar;
									// let avatar = JSON.parse(avtr);
									// document.getElementById(did).src = avatar;
									return didresult
								} else {
									console.log(did + ' DOESN\'T HAVE A RECORD :(');
									return
								}
							} catch (error) {
								console.error('An error occurred while fetching the DID record:', error);
							}
						}
 

function displayQR(data) {
    console.log('displayQR(data)')
            const qrCode = new QRCodeStyling({
                width: 500, height: 500, type: "png", data: data, image: `id5.svg`,
                dotsOptions: { color: "#1568B0", type: "extra-rounded" },
                backgroundOptions: { color: "var(--qrbackground)", },
                imageOptions: { crossOrigin: "anonymous", margin: 3 }
            });
            qrCode.append(document.getElementById("canvas"));
            // canvas.classList.add('animate')




        }

		function setAddress(userAddress) {
			console.log('setAddress()',userAddress)

			// v1
			// var currentURL = window.location.href;
			var baseUrl = window.location.protocol + '//' + window.location.host + '/';

			// var baseUrl = 'https://192.168.43.129:4242' + '/';
			// var baseUrl = 'https://meterchat.web.app' + '/';
            let did = `did:ius:${userAddress}`
			// const parameters = { T2Addr: userAddress, };
			const parameters = { T2Addr: did };
			const urlParams = createURLParams(parameters);
			const url = `${baseUrl}?${urlParams}`;

			// 3- SHOW QR
			canvas.innerHTML = '';
			showqr(url);
			
		// 	// var isFullscreen = false;
		// 	var body = document.querySelector('body');
		// var lastTapTime = 0;
		// var isFullscreen = false;

				canvas.onclick = function (e) {
				console.log('CHATWALLET: clicked on QR')
				var currentTime = new Date().getTime();
				var tapLength = currentTime - lastTapTime;
				if (tapLength < 500 && tapLength> 0) {
					toggleFullscreen();
					}
					lastTapTime = currentTime;
					}

			// let shortAddr = userAddress.substring(0, 6) + "..." + userAddress.substring(38, 42);
			let shortAddr = shortAddressETH(userAddress)
			var preElement = document.getElementById('yourAddress');
			preElement.setAttribute('address', userAddress);

			yourAddress.innerHTML = `${shortAddr} <svg id='copyAddress' onclick="event.stopPropagation();copy2clipboard('${userAddress}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill='currentColor' d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"/></svg> <svg id='shareAddress' onclick="event.stopPropagation();copy2clipboard('${url}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><path fill='currentColor'  d="M352 224c53 0 96-43 96-96s-43-96-96-96s-96 43-96 96c0 4 .2 8 .7 11.9l-94.1 47C145.4 170.2 121.9 160 96 160c-53 0-96 43-96 96s43 96 96 96c25.9 0 49.4-10.2 66.6-26.9l94.1 47c-.5 3.9-.7 7.8-.7 11.9c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-25.9 0-49.4 10.2-66.6 26.9l-94.1-47c.5-3.9 .7-7.8 .7-11.9s-.2-8-.7-11.9l94.1-47C302.6 213.8 326.1 224 352 224z"/></svg>`;
			console.log(`Your address: ${userAddress} `)
			console.log(`Your did: ${did} `)
		}


		/*********************************************************************************************
		.)  URL
		**********************************************************************************************/
		// Function to create URL parameters from an object
		function createURLParams(params) {
			console.log('createURLParams', params)

			const keys = Object.keys(params);
			const encodedParams = keys.map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`);
			return encodedParams.join('&');
		}

			/*********************************************************************************************
		.) QR SCAN
		**********************************************************************************************/
		async function scanAddress() {
			console.log('SCANNING FOR A NEW USER ADDRESS')
			var audioContext = new AudioContext();

			// open modal
			openModalId('#scanModal')
			document.getElementById('scanResult').innerHTML = ''
			setTimeout(() => {
				var videoElem = document.getElementById("qrScanVideo");
				window.qrScanner = new QrScanner(videoElem, result => qrscanned(result), {
					highlightScanRegion: true,
					highlightCodeOutline: true,
				});

				qrScanner.setInversionMode('invert');
				qrScanner.start();

			}, 1000);

		}

		async function qrscanned(result) {
			console.log('scanned decoded qr code:', result.data)
			x1 = result.data;
			document.getElementById('scanResult').innerHTML = ` <div class="success-message"> <svg viewBox="0 0 76 76" class="success-message__icon icon-checkmark"> <circle cx="38" cy="38" r="36"/> <path fill="none" stroke="#FFFFFF" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M17.7,40.9l10.9,10.9l28.7-28.7"/> </svg> <h1 class="success-message__title">SCANED!</h1> <div class="success-message__content"> <p>${result.data}</p> </div> </div> `
			qrScanner.stop();
			qrScanner.destroy();
			qrScanner = null;
			playBeep();
			await setTimeout(() => {
				closeModalId('#scanModal')
			}, 1500);
			console.log('KEEP DOING SOMETHING', result.data)

			// SEARCH FOR T2Addr
			const url = new URL(result.data);
			const urlParams = new URLSearchParams(url.search);
			const t2AddrValue = urlParams.get('T2Addr');
			if (t2AddrValue !== null) {
				console.log(`Value of T2Addr parameter: ${t2AddrValue}`);

				// address2.value = t2AddrValue;
				Toast.fire({ icon: 'info', title: 'CHAT WITH:', text: t2AddrValue });

				// close nav
				plToggle()
				// NOW SETUP THE CHAT AND OPEN IT
				// await chatWith(t2AddrValue)

					//  CREATE AND RESOLVE DID
					let did = `did:ius:${t2AddrValue}`

let didData = await fetchDID(did)
console.log( 'didData', didData)

if (didData.data.alias || null) {
console.log('alias is not null', didData.data.alias);
} 
else {
	console.log('user Doesnt have a did')
}



				
				let contact = { address: t2AddrValue, username: null, avatar: null, did: did }
							SaveContactsToLocalStorage(contact);
							await chatWith(t2AddrValue)


				// const swiperEl = document.getElementById('troqContainer');
				// swiperEl.swiper.slideNext();

			} else {
				console.log('T2Addr parameter not found in the URL');
			}


		}




		async function selectChat(el) {
			console.warn('selectChat()')
			const address = el.dataset.address;
			console.log('CLICKED CONTACT (selectChat()):', address);
			var imgElement = el.querySelector("img");
			let imgSrc = imgElement.getAttribute("src");
			console.log('imgSrc: ',imgSrc.length)
			// 1- close navbar
			plToggle()

			// 2- chat with address funciton 
			let currentChat = document.body.getAttribute('currentChat');
			console.warn('CURRENTCHAT', currentChat)
			
			// if(currentChat==address)?alreadyChatting==true
			let alreadyChatting = (currentChat === address) ? true : false;

			// INTENTO FIX DUPLICA Y MULTIPLICA MENSAJES
			if (alreadyChatting) {
				// Do something if alreadyChatting is true
				console.log('already chatting with this contact')
				openChat()
			} else {
				// Do something else if alreadyChatting is false
				console.log('start chatting with new contact')
				await deleteChat()
				await chatWith(address,imgSrc)
				await updateBadge()

			}
		}


		document.getElementById("closeScanModal").onclick = () => {
			qrScanner.stop();
			closeModalId('#scanModal')
			qrScanner.destroy();
			qrScanner = null;

		}


		

		async function updateBadge() {
			// console.log('updateBadge()')
			var ulElement = document.getElementById('cwContacts');
			var newMessageElements = ulElement.getElementsByClassName('newmessage');
			var count = newMessageElements.length;
			if (count === 0) {
				// console.log('updateBadge(): No elements with class "newmessage" found.');
				document.getElementById('chatBadge').style.display = 'none'
				document.getElementById('chatBadge').innerText = ''
			} else {
				console.log('Number of elements with class "newmessage":', count);
				document.getElementById('chatBadge').style.display = 'inline'
				document.getElementById('chatBadge').innerText = `${count}`
			}

		}


		/*********************************************************************************************
		.) NEWQRCHAT
		**********************************************************************************************/
		async function createXMPTchat(signer){
            console.log('createXMPTchat()')

			// check if DID is needed or not

			// let chatETHPrivKey = localStorage.getItem('chatETHPrivKey');
            // if (!chatETHPrivKey) {
			// 	// starknetPrivKey = stark.randomAddress();
			// 	try { wallet = await ethers.Wallet.createRandom() }
			// 	catch (error) { console.log(error.message);   }

            //     console.log('New CHAT ACCOUNT :\nprivateKey=', wallet.privateKey);
            //     localStorage.setItem('chatETHPrivKey', wallet.privateKey);
            //     console.log('chatETHPrivKey SAVED INTO LOCALSTORAGE');
            // } else {
			// 	console.log('chatETHPrivKey already exists in localStorage:', chatETHPrivKey);
			// 	try { wallet = await new ethers.Wallet(chatETHPrivKey) }
			// 	catch (error) { console.log(error.message);   }

            // }

            // console.log('<br>ETH private key:'+wallet.chatETHPrivKey)
			// window.wal =wallet;

            const iusnaturalisxmtp = await Client.create(signer)
            const conversations = iusnaturalisxmtp.conversations
    
			// get eth address for chat
			 userAddress = signer.address;
			console.log('Your chat Address (eth) : ',userAddress)

			window.iusnaturalisxmtp = iusnaturalisxmtp;// make GLOBAL
			window.chats= iusnaturalisxmtp.conversations
			window.userAddress= userAddress

            return iusnaturalisxmtp
        }

		async function  getChatAddresses(){
			const allConversations = await iusnaturalisxmtp.conversations.list()
			console.warn('YOU HAVE ', allConversations.length, "ADDRESSES AVAILABLE IN XMTP at getChatAddresses()")

			const peerAddressesArray = [];

			allConversations.forEach(async (conversation, index) => {
				peerAddressesArray.push(conversation.peerAddress);
				console.log('allConversations foerEach')
				// ADD ADDRESS TO AGENDA IN UI
						// Here

			})
			paa = peerAddressesArray;
			console.log('peerAddressesArray(paa) DECLARED!',peerAddressesArray)
			

		}
		
		async function chatWith(toAddr ,imgsrc) {
			console.warn('chatWith()', toAddr)

			console.log('ESTABLISHING NEW CHAT WITH', toAddr)

			document.getElementById("chatBox").innerHTML='';//clear chat window
			console.log('clear chatBox window')

			// return 

		console.log(toAddr, userAddress)
		if (toAddr == userAddress) {
			console.warn('CANCELING chatwith() because CANNOT WITH SELF ADDRESS')
			Toast.fire('CANNOT CHAT WITH SELF ADDRESS', '', "warning");
			localStorage.removeItem('toAddress')// detele "TO" address from localStorage
			return
		}

		
		
		
		// return
		// GOT TO CHAT TAB
		console.log(' doing openChat')
		openChat()
console.warn('------- PREPARING CHAT ----------');
		localStorage.setItem('toAddress', toAddr)
		
		// ---------
			 loadContacts()
			updateBadge()

			// return


if (imgsrc != null){
	console.log('YES IMAGE SOURCE', imgsrc)

	 avatar = imgsrc;
} else {
	console.log('NO IMAGE SOURCE')
	 avatar = "./anonym.jpg"
}
// add address in UI
let htmlData = `<address>${toAddr} <svg id="" onclick="event.stopPropagation();customcopy2clipboard('${toAddr}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z" ></path></svg> </address><br><p>no info available</p>`;
let shortAddr = toAddr.substring(0, 6) + "..." + toAddr.substring(38, 42);

chatAddress.innerHTML = `<div class="">
	<img src='${avatar}' alt="avatar" class="rounded rounded-circle img-thumbnail" width='40px' id='avatarImage'  onclick="event.stopPropagation();openCard('${toAddr}','${avatar}')">
	<strong onclick="event.stopPropagation();openCard('${toAddr}','${avatar}')">${shortAddr}</strong>
	  </div>`;




// -------------------

actionButtons.innerHTML = `
<button type="button" id="" class="btn btn-approve" style="display: none;"
		onclick="event.stopPropagation(); openSend('${toAddr.toString()}')" disabled>
		<svg xmlns="http://www.w3.org/2000/svg" height="16" width="20" viewBox="0 0 512 512">
			<path fill="currentColor"
				d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480V396.4c0-4 1.5-7.8 4.2-10.7L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z" />
			</svg>
		SEND</button>

		<button type="button" id="" class="btn btn-reject" style="display: none;"
		onclick="event.stopPropagation(); openSend('${toAddr.toString()}')"  disabled>
		<svg height="16" width="20" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">
			<path fill="currentColor"
				d="m 506.43491,498.16358 c -7,10.1 -19.1,15.4 -31.2,13.5 l -416.000001,-64 c -9.7,-1.5 -18.2,-7.4 -23,-16 -4.8,-8.6 -5.4,-18.9 -1.6,-28 l 49.7,-119.6 -74.1,-68.5 c -9.70000029,-8.9 -12.9000003,-22.9 -8.1000003,-35.2 4.8,-12.3 16.7000003,-20.3 29.9000003,-20.3 h 83.600001 c 4,0 7.8,1.5 10.7,4.2 l 182.9,167.6 c 6.3,5.8 16,5.6 22,-0.4 6,-6 6.4,-15.7 0.7,-22 l -180.7,-203.4 44.2,-88.300001 c 5.3,-10.5999996 15.9,-17.39999965 27.7,-17.69999965 11.8,-0.3 22.8,5.90000005 28.7,16.09999965 l 256,448.000001 c 6.1,10.7 5.5,23.9 -1.4,34 z"
				id="path992" />
			</svg>
		RECEIVE</button>
	<button class="honorloanbutton btn btn-secondary" onclick="sendHonorloanRequest(${toAddr.toString()})"
		style='display:none'>Loan
		<svg xmlns="http://www.w3.org/2000/svg" height="16" width="20" viewBox="0 0 640 512" style=" fill: #7cfc00; ">
			<path
				d="M80 104c0-22.1-17.9-40-40-40S0 81.9 0 104v56 64V325.5c0 25.5 10.1 49.9 28.1 67.9L128 493.3c12 12 28.3 18.7 45.3 18.7H240c26.5 0 48-21.5 48-48V385.1c0-29.7-11.8-58.2-32.8-79.2l-25.3-25.3 0 0-15.2-15.2-32-32c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l32 32 15.2 15.2c11 11 9.2 29.2-3.7 37.8c-9.7 6.5-22.7 5.2-31-3.1L98.7 309.5c-12-12-18.7-28.3-18.7-45.3V224 144 104zm480 0v40 80 40.2c0 17-6.7 33.3-18.7 45.3l-51.1 51.1c-8.3 8.3-21.3 9.6-31 3.1c-12.9-8.6-14.7-26.9-3.7-37.8l15.2-15.2 32-32c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-32 32-15.2 15.2 0 0-25.3 25.3c-21 21-32.8 49.5-32.8 79.2V464c0 26.5 21.5 48 48 48h66.7c17 0 33.3-6.7 45.3-18.7l99.9-99.9c18-18 28.1-42.4 28.1-67.9V224 160 104c0-22.1-17.9-40-40-40s-40 17.9-40 40z">
			</path>
		</svg> 
	</button>

	`
	 

// ------------------------------------
// AVOID REOPENING COMS WITH ADDRESESS
// SACAR/ si lo saco falla...
const allConversations = await iusnaturalisxmtp.conversations.list()
console.log('available addresses:', allConversations.length)
const customAddressToCheck = toAddr; // Replace this with the address you want to check
let addressExists = false;
for (const conversation of allConversations) {
	if (conversation.peerAddress === customAddressToCheck) {
		addressExists = true;
		cc = conversation
		break; // Exit the loop early if the address is found
	}
}


// -------
// FIx paa?
// const peerAddressesArray = [];

// allConversations.forEach(async (conversation, index) => {
// 	peerAddressesArray.push(conversation.peerAddress);
// })
// paa = peerAddressesArray;
// console.warn('peerAddressesArray ADDED',peerAddressesArray )
// -----------


if (addressExists) {
	console.warn(`YOU DO HAVE A CHAT HISTORY WITH ${customAddressToCheck} `);
	console.log('USER: ', userAddress)
	let h = await cc.messages()

	// CREATE THIS FUNCTON ==> loadChatHistory(h)
	for (let i = 0; i < h.length; i++) {
		// console.log('recipient address: ', h[i].recipientAddress)

		if (h[i].senderAddress === userAddress) {
			// console.log('YOU')
			let timestamp = simplifyDate(h[i].sent)
			document.getElementById('chatBox').innerHTML += `<div><strong class='who'>You:</strong> ${h[i].content}<span class="timestamp">  ${timestamp} &check; </span></div>`;


		} else {
			// console.log('NOT YOU')
			let timestamp = simplifyDate(h[i].sent)
			let shortAddr = h[i].senderAddress.substring(38, 42);

			document.getElementById('chatBox').innerHTML += `<div><strong class='who notyou'>${shortAddr}:</strong> ${h[i].content}<span class="timestamp">  ${timestamp} &check; </span></div>`;
		}

	}


	console.log('history:', history)
} else {
	console.warn(`YOU DONT HAVE A CHAT HISTORY WITH ${customAddressToCheck} `);

}
// FIN AVOID REOPENING COMS WITH ADDRESESS
// ------------------------------------

// CREATE CHAT (client was already created)
conversation = await iusnaturalisxmtp.conversations.newConversation(toAddr)
console.log('conversation:', conversation)
console.warn('------- READY TO CHAT üí¨ ----------');

// ADD ATTRIBUTE TO BODY(fix dup messg)
document.body.setAttribute('currentChat', toAddr);

	// ACTIVATE CHAT BUTTONS
	document.getElementById('chatTextInput').disabled = false;
document.getElementById('send-button').disabled = false;

// FOCUS ON INPUT
document.getElementById('chatTextInput').focus();
	// -----------


var chatBox = document.getElementById("chatBox");
let shortTo = toAddr.substring(38, 42);

// Listen for new messages in the conversation
for await (const message of await conversation.streamMessages()) {
	const now = new Date();
	const hours = now.getHours().toString().padStart(2, '0'); // Ensure two-digit format
	const minutes = now.getMinutes().toString().padStart(2, '0'); // Ensure two-digit format
	const timestamp = `${hours}:${minutes}`;
	console.log('logMSG:', message)
	let preferedWallet = localStorage.getItem('preferedWallet');
	if (!preferedWallet) { console.log('NO PREFERED WALLET SET') }
	if (preferedWallet) { const values = preferedWallet.split(',').map(item => item.trim()); userAddress = values[1]; }
	if (message.senderAddress === userAddress) {
		console.log('YOU')
		chatBox.innerHTML += `<div><strong class='who'>You:</strong> ${message.content}<span class="timestamp">  ${timestamp} &check; </span></div>`;
	}
	if (message.senderAddress == toAddr) {
		console.log('OTHER', shortTo)
		mm = message;
		// let timestamp = message
		// chatBox.innerHTML += `<div><strong class='who'>${shortTo}:</strong> ${message.content} </div>`;
		document.getElementById('chatBox').innerHTML += `<div><strong class='who notyou'>${shortTo}:</strong> ${message.content}<span class="timestamp">  ${timestamp} &check; </span></div>`;


	}
	// if (message.contentType.sameAs(ContentTypeMultiplyNumber)) {
	// 	return message.content; // 21
	// }
	console.log(`[${message.senderAddress}]: ${message.content}`)
	chatBox.scrollTop = chatBox.scrollHeight;

}
}




		/*********************************************************************************************
		.) CONTACTS MANAGEMENT
		**********************************************************************************************/


		async function addUnknownContact(addr, msg) {
			console.log('addUnknownContact()', addr, msg)

			// add unknown contact to  localstorage and check each time against the list if we add it or not into the contacts tab
			let shortAddr = addr.substring(0, 6) + "..." + addr.substring(38, 42);
			let shortMsg = msg.substring(0, 16);


			let unknownContacts = JSON.parse(localStorage.getItem('unknowncontacts')) || [];
			a = addr
			var index = unknownContacts.findIndex(existingUnknownContacts => existingUnknownContacts === addr);

			if (index === -1) {
				console.log('PUSH UnknownContact to localstorage')
				unknownContacts.push(addr);

				document.getElementById('cwContacts').innerHTML += `
					<li data-address="${addr}"  id="${addr}" class='newmessage'> 
						<a onclick="event.stopPropagation();selectChat((this.parentElement))" >  
							<img src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
								<span>${shortMsg} <span>
									
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"width="18" height="16" >
										<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"/></svg>
										
										
										</a> 
										</li> `
										// <i class="fa-solid fa-trash"></i>

			} else {
				console.log('OVERWRITE ALREADY EXISTENT  UnknownContact!.');

				// Search for the element with the specified ID
				var elementToModify = document.getElementById(addr);

				// Check if the element exists
				if (elementToModify) {
					// Add a new class to the element
					elementToModify.classList.add('newmessage');
					elementToModify.querySelector("span").innerText = shortMsg

				} else {
					// If the element with the specified ID is not found, you may want to handle that case
					console.warn("Element with ID '" + addr + "' not found");
					document.getElementById('cwContacts').innerHTML += ` 
					<li data-address="${addr}" id="${addr}"  class='newmessage'> 
					<a onclick="event.stopPropagation();selectChat((this.parentElement))" >  
						<img src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
						<span>${shortMsg} <span>
							</a> </li> `
							// <i class="fa-solid fa-trash"></i>
				}


			}

			// CAMBIAR POR SaveContactsToLocalStorage??
			localStorage.setItem('unknowncontacts', JSON.stringify(unknownContacts));


		}

		async function addknownContact(addr, msg) {
			console.log('addknownContact()', addr, msg)

			let shortAddr = addr.substring(0, 6) + "..." + addr.substring(38, 42);
			let shortMsg = msg.substring(0, 16);
			var elementToModify = document.getElementById(addr);
			if (elementToModify) {
				elementToModify.classList.add('newmessage');
				elementToModify.querySelector("span").innerText = shortMsg
			}

		}



async function loadContacts() {
			// console.log('loadContacts()')
			let contct = document.getElementById('cwContacts')
			contct.innerHTML = ''
			let cwContacts = JSON.parse(window.localStorage.getItem('contacts'));
			if (!cwContacts) {
				console.warn('YOU HAVE', 0, 'CONTACTS in LOCALSTORAGE at loadContacts()')

			}
				if (cwContacts) {
				console.warn('YOU HAVE', cwContacts.length, 'CONTACTS in LOCALSTORAGE at loadContacts()')
			const promises = [];
			cwContacts.forEach((el, index) => {
				// is username set?
				if (el.username || null) {
					console.log('‚úÖ username is not null');
					contactInfo = `<span>${el.username} <span>`;
				} else {
					console.log('‚ùå username is null');
					let shortAddr = el.address.substring(0, 6) + "..." + el.address.substring(38, 42);
					contactInfo = `<span>${shortAddr} <span>`;
				}

				let did = `did:ius:${el.address}`;

				// Add each asynchronous operation to the promises array
				promises.push(
					new Promise((resolve, reject) => {
						readDIDRecord(did)
							.then(didresult => {
								if (didresult.data != null) {
									console.log(did + ' HAS A RECORD!!!');
									d=didresult
									let avtr = didresult.data.avatar;
									if (avtr) {
										let avatar = JSON.parse(avtr);
										document.getElementById(did).src = avatar;
										// Now you can use the avatar object
									} else {
										// Handle the case where avtr is empty
										console.log('Avatar data is empty');
									}
								} else {
									console.log(did + ' DOESN\'T HAVE A RECORD :(#1464)');
								}
								resolve(); // Resolve the promise once the operation is done
							})
							.catch(error => {
								console.warn('Warn on DID record:', error);
								reject(error); // Reject the promise if an error occurs
							});
					})
				);

    contct.innerHTML += `<li data-address="${el.address}" id="${el.address}" class=''> 
                            <a onclick="event.stopPropagation();selectChat((this.parentElement))">  
                                <img id ="${did}" src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
                                    ${contactInfo} 
									<svg onclick="event.stopPropagation();editContact('${el.address}')" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="20" height="25" class='right'>
										<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"/>
										</svg>
										</a> 
										</li>`;
										// <i class="fa-solid fa-trash"></i>
});

// Execute all promises concurrently
Promise.all(promises)
    .then(() => {
        console.log('All DID record processing completed.');
    })
    .catch(error => {
        console.error('Error while processing DID records:', error);
    });


			}

		}// fin loadContacts





		/*********************************************************************************************
		.) OLD QRCHAT
		**********************************************************************************************/
		async function xmtp(wallet) {

		let to = localStorage.getItem('toAddress')
		if (!to) {
			console.log('NO "TO" ADDRESS')
			const xmtp = await Client.create(wallet)
			console.log('XMTP CLIENT CREATED: ', xmtp)
			// xm = xmtp;
			return
		}
		else {
			console.log('YES "TO" ADDRESS')
			const xmtp = await Client.create(wallet)
			localStorage.setItem('chatxmtp', xmtp)
			// await chatWith(to)
		}



}

document.getElementById("chatTextInput").addEventListener("keydown", function (event) {
	console.log('Pressed ENTER')
if (event.key === "Enter") {
	var userInput = this.value.trim(); // Trim whitespace from input
	if (userInput !== "") {
		console.log("User input:", userInput);
		// Do something with the user input here
		sendMessage(event);
	}
	// var userInput = this.value;
	// console.log("User input:", userInput);
	// // Do something with the user input here
	// sendMessage();
	event.preventDefault(); // Prevents the default behavior of the Enter key (submitting a form)
}
});

document.getElementById("chatTextInput").addEventListener("blur", function (event) {
var userInput = this.value.trim(); // Trim whitespace from input
if (userInput !== "") {
	console.log("User input:", userInput);
	// Do something with the user input here
	sendMessage(event);
}
// var userInput = this.value;
// console.log("User input:", userInput);
// // Do something with the user input here
// sendMessage();
});

async function sendMessage() {
console.log('sendMessage()')
event.preventDefault();

var userInput = document.getElementById("chatTextInput").value;
var chatBox = document.getElementById("chatBox");
var message = document.createElement("div");

if (userInput.trim() !== "") {
	// The input value is not empty
	console.log("Input is not empty");
} else {
	// The input value is empty
	console.log("Input is empty");
	return
}

 

document.getElementById("chatTextInput").value = "";
chatBox.scrollTop = chatBox.scrollHeight;
if(conversation){
	console.log('CONVESATION AVAILABLE NOW: ', conversation)
} else {
	console.log('NO AVAILABLE CONVESATION: ')
	
}
await conversation.send(`${userInput}`);// Send a message


// event.preventDefault(); // Prevents the default behavior of the Enter key (submitting a form)

}




function setToAddress() {
var toaddr = document.getElementById("toAddr").value;

console.log('setting TO adddress: ', toaddr)

// if (ethers.utils.isAddress(toaddr)) {
if (ethers.isAddress(toaddr)) {
	console.log('VALID ADDRESS')
	document.getElementById("invalid-address-alert").style.display = "none";
	localStorage.setItem('toAddress', toaddr)
	document.getElementById('results').innerHTML += `<br>TO address: ${toaddr}  <button class="btn btn-secondary" onclick="clearChat()">Clear</button>`


} else {
	console.log('INVALID ADDRESS')
	document.getElementById("invalid-address-alert").style.display = "block";

}


}

 

function customcopy2clipboard(text) {
console.log('customcopy2clipboard()', text)

let textLink = `<a href="${text}">${text}</a>`;

if (window.clipboardData && window.clipboardData.setData) {
	console.log('Copied to Clipboard', text, "success");

	document.getElementById('innerAddress').innerHTML = '<path fill="currentColor"  d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/><p>Copied!</p>'

	setTimeout(() => {
		document.getElementById('innerAddress').innerHTML = ' <path fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"></path>'
	}, 1000);
	return window.clipboardData.setData("Text", text);
}
else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
	var textarea = document.createElement("textarea");
	textarea.textContent = text;
	textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in Microsoft Edge.
	document.body.appendChild(textarea);
	textarea.select();
	try {
		console.log('Copied to Clipboard', text, "success");
		document.getElementById('innerAddress').innerHTML = '<path fill="currentColor"  d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/><p>Copied!</p>'

		setTimeout(() => {
			document.getElementById('innerAddress').innerHTML = ' <path fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"></path>'
		}, 1000);

		return document.execCommand("copy");  // Security exception may be thrown by some browsers.
	}
	catch (ex) {
		console.warn("Copy to clipboard failed.", ex);
		return prompt("Copy to clipboard: Ctrl+C, Enter", text);
	}
	finally {
		document.body.removeChild(textarea);
	}
}


}


async function addUser() {
console.log('ADDING NEW USER ADDRESS')
}



// EDIT CONTACT
// el.address
async function editContact(addr) {
console.log('editContact()')
const inputValue = '';

const { value: userName } = await Swal.fire({
	title: "Enter a name for this address",
	input: "text",
	inputLabel: "contact name",
	inputValue,
	showCancelButton: true,
	inputValidator: (value) => {
		if (!value) {
			return "You need to write something!";
		}
	}
});
if (userName) {

	let contact = { address: addr, username: userName, avatar: null, did: null }
	SaveContactsToLocalStorage(contact)
	await loadContacts()
	console.log('Contact Updated', userName)
	// Swal.fire(`Your IP address is ${userName}`);
}


}


function updateContactList(contact) {
// Retrieve existing contacts from localStorage
var contacts = JSON.parse(localStorage.getItem('contacts')) || [];

// Check if the contact already exists in the list
var existingContactIndex = contacts.findIndex(function (existingContact) {
	return existingContact.address === contact.address;
});

if (existingContactIndex !== -1) {
	// If the contact exists, update its details
	contacts[existingContactIndex] = contact;
} else {
	// If the contact doesn't exist, add it to the list
	contacts.push(contact);
}

// Save the updated contact list back to localStorage
localStorage.setItem('contacts', JSON.stringify(contacts));
}


// SAVE CONTACTS
function SaveContactsToLocalStorage(contact) {
	console.warn('SaveContactsToLocalStorage()',contact)
	var a = [];
	a = JSON.parse(localStorage.getItem('contacts')) || [];

// Check if the address already exists
var isDuplicate = a.some(existingContact => existingContact.address === contact.address);

if (!isDuplicate) {
	a.push(contact);
	localStorage.setItem('contacts', JSON.stringify(a));
}
else {
	// console.log('Address already exists in your contacts, skipping save.');
	console.log('Address already exists in your contacts, UPDATING.');
	updateContactList(contact)
}
}




// async function chatHistory(addr) {

// let conversation = await iusnaturalisxmtp.conversations.newConversation(addr)
// const messages = await conversation.messages()

// for (const message of messages) {
// 	console.log(message.content);
// }
// }



function simplifyDate(dateString) {
// Create a new Date object
var date = new Date(dateString);

// Get current date
var currentDate = new Date();

// Define months array for formatting
var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

// Format the date
var formattedDate;
if (date.toDateString() === currentDate.toDateString()) {
	// If the date is today, display only time
	var hours = date.getHours();
	var minutes = date.getMinutes().toString().padStart(2, '0');
	var seconds = date.getSeconds().toString().padStart(2, '0');
	formattedDate = hours + ':' + minutes + ':' + seconds;
} else {
	// If the date is not today, display day, month, and year
	formattedDate = date.getDate() + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
}

return formattedDate;
}

// // Example usage:
// var dateString = "Wed May 01 2024 01:17:42 GMT-0300 (Argentina Standard Time)";
// console.log(simplifyDate(dateString)); // Output: "01 May 2024"


function openCard(toAddr ,avtr) {
console.log(' openCard()', toAddr, avtr)
let a= toAddr;
let b= avtr;
console.log('OPENCARD DATA a:',a)
console.log('OPENCARD DATA b:',b)
let avatar = "./anonym.jpg"
let htmlData = `<address>${toAddr} <svg id="innerAddress" onclick="event.stopPropagation();customcopy2clipboard('${toAddr}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z" ></path></svg> </address><br><p>no more info available</p>`;
let shortAddr = toAddr.substring(0, 6) + "..." + toAddr.substring(38, 42);
// -----------

	Swal.fire({ imageUrl: avtr, 
			imageWidth: 300, 
			imageHeight: 300, 
			imageAlt: 'Avatar image', 
			html: htmlData,
			showDenyButton: true,
			showCancelButton: false,
			showCloseButton: true, 
			confirmButtonText: 'trust',
			denyButtonText: 'Block',
			customClass: {
				actions: 'my-actions',
				cancelButton: 'order-1 right-gap',
				confirmButton: 'order-2',
				denyButton: 'order-3',
},
}).then((result) => {
if (result.isConfirmed) {
	Swal.fire('Saved into your trusted contacts!', '', 'success')

} else if (result.isDenied) {
	Swal.fire('Address blocked', '', 'info')
}
})
// ---
}



var cwContacts = document.getElementById('cwContacts');

cwContacts.addEventListener('contextmenu', function (e) {
e.preventDefault(); // Prevent the default context menu

// Check if the right-click was on an li element
if (e.target.tagName === 'LI') {
	// Increment your counter or perform any other action
	console.log('Right-clicked on li element');
}
});

async function initChatClient(wallet) {
console.warn(`
******************
initChatClient()
******************
`)
// Create the client with your wallet. This will connect to the XMTP development network by default
// const xmtp = await Client.create(wallet)
const xmtp = await Client.create(wallet, { env: "dev", })

// REGISTER CODECS

// Support on-chain transaction references in your app built with XMTP
// https://xmtp.org/docs/build/messages/transaction
xmtp.registerCodec(new TransactionReferenceCodec());



// const iusnaturalisxmtp = await Client.create(wallet)
iusnaturalisxmtp = xmtp;//make global
console.warn('iusnaturalisxmtp SET TO GLOBAL')
// Listen for new conversations
const stream = await iusnaturalisxmtp.conversations.stream()
console.log('STREAM:', stream)

//  registerCodecs(xmtp)
await listExistingConversations(iusnaturalisxmtp)
return xmtp
}


// -----------------
// LISTEN TO ALLLLLL INCOMING!
async function listenAllNewAddresses() {
console.log('listenAllNewAddresses() - *B')

for await (const message of await iusnaturalisxmtp.conversations.streamAllMessages()) {
	if (message.senderAddress === iusnaturalisxmtp.address) {// This message was sent from me
		continue
	}

	document.getElementById('chatBadge').style.display = 'inline'
	document.getElementById('chatBadge').innerText = '!'
	console.log(`New message from ${message.senderAddress}: ${message.content}`)
	Toast.fire({ icon: 'info', title: `New message from ${message.senderAddress}`, text: message.content});

	
	try{
		await playButtonClickSound()
	}
	catch (error) {
			console.error('Error getting did:', error.message);
		}
	// peerGasPaymentAccept
	if (message.content.includes("peerGasPaymentAccepted0x21")) {
		Swal.fire({ title: "Your gas is being payed by your peer!", width: 600, padding: "3em", background: "lightgreen ", backdrop: ` rgba(0,123,123,0.4) url("./nyan-cat.gif") left top no-repeat ` });

		setTimeout(() => {
			Swal.fire("Done!", "", "success");
			closeModalId('#walletSend')
		}, 3000);
	}

	// peerGasPaymentRequest
	if (message.content.includes("peerGasPaymentReques0x20")) {
		console.log("You received a peerGasPamentRequest from: ", message.senderAddress);
		conversation = await iusnaturalisxmtp.conversations.newConversation(message.senderAddress)
		Swal.fire({
			title: "Do you have some gas?",
			text: "your peer is asking you to pay for the gas",
			icon: "question",
			showDenyButton: true,
			showCancelButton: true,
			confirmButtonText: ` <i class="fa fa-thumbs-up"></i> Yes! `,
			denyButtonText: ` <i class="fa fa-thumbs-down"></i>  Decline`,
			cancelButtonText: `  Ignore`
		}).then(async (result) => {
			if (result.isConfirmed) {
				Swal.fire({ title: `You are paying for the gas for ${message.senderAddress} (it is being automaticalle discounted from your gas balance)!`, width: 600, padding: "3em", color: "#716add", background: "#fff ", backdrop: ` rgba(0,0,123,0.4) url("./nyan-cat.gif") left top no-repeat ` });
				await conversation.send(`user accepted to pay for the gas! <pre style="display: none;">peerGasPaymentAccepted0x21</pre>`);// Send a message
				setTimeout(() => {
					Swal.fire("Gas payed!(FAKE...)", "", "success");
				}, 5000);
			} else if (result.isDenied) {
				Swal.fire("You decline to pay for the gas", "", "info");
			}
		});
	}
	else { console.log("(DIRTYFIX)The message does not contain the text: 'can you pay for the gas?'"); }

	// CHECK IF ADDRESS IS ALREADY IN YOUR CONTACTS (LOCALSTORAGE)
	var storedContacts = [];
	let storedContacts = JSON.parse(localStorage.getItem('contacts')) || [];

	// Find index of the message with the same address
	var index = storedContacts.findIndex(existingContact => existingContact.address === message.senderAddress);

	if (index === -1) {
		console.log('THIS ADDRESS IS NOT IN YOUR CONTACT LIST.. Adding new UNKNOWN (and unvalidated) contact.');
		addUnknownContact(message.senderAddress, message.content)

	} 
	else {
		console.log('YES: THIS ADDRES IS IN YOUR CONTACT LIST')
		console.log('OVERWRITE last msg, INDEX:', storedContacts[index], index)
		addknownContact(message.senderAddress, message.content)

	}

	updateBadge()
}
}


 


async function listExistingConversations(xmtp) {
console.warn('listExistingConversations() NO USADO?????')
// List existing conversations
const allConversations = await xmtp.conversations.list()
console.log('AVAILABLE CHATS:', allConversations.length)
const peerAddressesArray = [];

allConversations.forEach(async (conversation, index) => {
	peerAddressesArray.push(conversation.peerAddress);
	
	// QUITAR SOLO PARA PRUEBA
	console.warn('listenNewChats() OMITED HERE')
	// await listenNewChats(conversation.peerAddress)
})
paa = peerAddressesArray;
console.warn('!!!!! paa DECLARED !!!!!!!!!')

}



async function deleteChat() {
console.log('DELETING CHAT')
// clear URL
removeParam('T2Addr');
// remove body's ATTRIBUTE
	document.body.removeAttribute('currentChat');

// remove "TO" address from localStorage
localStorage.removeItem('toAddress')

// GOT TO CHAT TAB
openChat()

//clear UI
chatAddress.innerHTML = ''
document.getElementById('chatBox').innerHTML=`<div class="container"> <div class="row justify-content-center"> <div class="col-10"> <div class="rounded-circle border border-primary p-3" style="width: 90%; height: auto;"> <div id="svg-container"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"> <image href="./nochats.svg" width="100%" height="100%"></image> </svg>  <button type="button" id="" class="btn btn-primary " style="display: inline;" onclick="event.stopPropagation(); openChat()"> CHAT </button>   </div> </div> </div> </div> </div> `

// DEACTIVATE BUTTONS
document.getElementById('chatTextInput').disabled = true;
document.getElementById('send-button').disabled = true;


}

// center.onclick = function (e) {
// console.log('GO TO MAIN')
// const swiperEl = document.getElementById('troqContainer');
// swiperEl.swiper.slidePrev();
// }

function removeParam(key) {
var url = new URL(window.location.href);
url.searchParams.delete(key);
window.history.replaceState({}, '', url);
}




async function createAlias(addr) {
// const formattedAddress = ethers.utils.getAddress(addr);
console.log('CREATE AN ALIAS FOR THIS ADDRESS', addr)
// console.log('CREATE AN ALIAS FOR THIS ADDRESS',formattedAddress)

// TEST
// await iusnaturalisxmtp.registerCodec(new ContentTypeMultiplyNumberCodec());

// const numbersToMultiply = { a: 3, b: 7 };

// await conversation.send(numbersToMultiply, {
// contentType: ContentTypeMultiplyNumbers,
// });

}


// ----------------------------------
// CHECK VALID ADDRESS
  

		async function isValidETHAddress(address) {
			// return ethers.utils.isAddress(address);
			return ethers.isAddress(address);
		}
		
		function isValidHex(address) {
			// Regular expression to check if a string is a valid hexadecimal
			const hexRegex = /^[0-9a-fA-F]+$/;
			return hexRegex.test(address);
		}

		function isValidStarkNetAddress(address) {
			// Remove the '0x' prefix if it exists
			const normalizedAddress = address.startsWith('0x') ? address.slice(2) : address;

			// Check if the address is a valid hexadecimal string and has the correct length
			return isValidHex(normalizedAddress) && normalizedAddress.length === 64;
		}

		async function getAddressType(address) {
			console.log('getAddressType()')
    // Check if it's a valid Ethereum address
    const isValidETH = await isValidETHAddress(address);
    if (isValidETH) {
        return 'ETH';
    }
    
    // Check if it's a valid StarkNet address
    const isValidStarkNet = isValidStarkNetAddress(address);
    if (isValidStarkNet) {
        return 'StarkNet';
    }

    // If neither, it's invalid
    return 'Invalid';
}

	async function addAddress() {
	console.log('addAddress()')

			let addressToAdd = Swal.fire({
				title: "add Address",
				input: 'text',
				inputAttributes: { autocapitalize: 'off' },
				showCancelButton: true,
				confirmButtonText: 'ok',
				showLoaderOnConfirm: true,
				preConfirm: (login) => { },
				backdrop: true,
				inputValidator: async (value) => {
					if (!value) {
						return 'You need to set a password to create your wallet!'
					}


					//  ADDR VERIFICATION
					const isValid = await getAddressType(value);

					if (isValid) {
						console.log(`Address ${value} is valid.`);

						Toast.fire({ icon: 'success', title: 'CHAT WITH:', position: 'center', text: value });

							// ---------------------
							// ANALIZE ADDRESS
							if (isValid === 'ETH') {
								console.log('Perform action for Ethereum address');
								let contact = { address: value, username: null, avatar: null, did: null }
								SaveContactsToLocalStorage(contact)
								// ---------------
								await chatWith(value)
								await deleteChat()
						
							} 
							else if (isValid === 'StarkNet') {
								console.log('Perform action for StarkNet address');
							// ---------------
							//  CREATE AND RESOLVE DID
							let did = `did:starkid:${value}`
							let didData = await fetchDID(did)
							console.log( 'didData', didData)
							if (didData.data.alias || null) {
							console.log('alias is not null', didData.data.alias);
							// ---------------
							let contact = { address: didData.data.alias, username: null, avatar: null, did: did }
							SaveContactsToLocalStorage(contact);
							await chatWith(didData.data.alias)
							await deleteChat()

						} else {
							console.log('alias is null');

				}



							} else {
								console.log('Perform action for invalid address');
								// Add your code to handle invalid addresses here
							}


					} else {
						console.log(`Address ${value} is not valid.`);
						return 'Address is not valid!'

					}

				},

				allowOutsideClick: () => {
					const popup = Swal.getPopup()
					popup.classList.remove('swal2-show')
					setTimeout(() => { popup.classList.add('animate__animated', 'animate__headShake') })
					setTimeout(() => { popup.classList.remove('animate__animated', 'animate__headShake') }, 500)
					return false
				},
			})
				.then(async (result) => {
					if (result.isConfirmed) {
						console.log('result.isConfirmed:')
						// await decryptWallet(result.value)
						return result.value
					}
				})
			console.log('addressToAdd:', addressToAdd)

			// close nav
			plToggle()

		}




		/*********************************************************************************************
		.)  SETTINGS
		**********************************************************************************************/

		async function settings() {
			console.log('settings()')
			openModalId('#settingsModal')

		}


		async function backup(mnemonicPhrase) {
			console.log('backup()')
			openModalId('#walletBackp')
			closeModalId('#settingsModal')

			// -----------------
			// get mnemonicphrase
			// -----------------

			//  IS UNBACKEDWALLET?
			const unbackedWallet = localStorage.getItem('unbackedWallet');
			if (!unbackedWallet) {
				console.warn('No unbackedWallet found. Checking for jsonWallet.');

			// 3-  NO UNBACKED WALLET, is JSONWALLET?
				const jsonWallet = localStorage.getItem('jsonWallet');
				if (!jsonWallet) {
					console.warn('No jsonWallet found.');
							
				} else {
					// console.warn('3- YES JSON WALLET')
					console.warn('3- jsonWallet found. Checking for jsonWalletPassword.');
					const jsonWalletPassword = localStorage.getItem('jsonWalletPassword');
					if (!jsonWalletPassword) {
						console.warn('No jsonWalletPassword found.');
						console.error('No jsonWalletPassword found.');

						return

					} else {
						console.warn('jsonWallet and jsonWalletPassword found.');
						// GET password , decript the wallet

					
					}

				}
			} else {
				// Handle unbackedWallet
			console.warn('2- YES unbackedWallet', unbackedWallet)

			}

			// -----------------

			displayMnemonic.innerHTML = ` <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height='40px' width='40px' fill="currentColor"> <path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/></svg>Write down your mnemonic phrase to access your wallet in the future! :</h3> <div class="alert alert-warning alert-dismissible fade show"> <strong>${JSON.parse(unbackedWallet)}</strong> </div> `
			setTimeout(() => {
				const checkbox = document.getElementById('mnemonicBackedup');
				const button = document.getElementById('closeBackupmodal');
				mnemonicBackedup.disabled = false;
				checkbox.addEventListener('change', function () {
					button.disabled = !this.checked;
					mnemonicBackedup.disabled = true;
					console.log('close mnemonic activated')

					// NOW DELETE unbackedWallet
					// localStorage.removeItem('unbackedWallet')

				});
				// init();
			}, 1000);


		}

		async function restoreWallet() {
			console.warn('restoreWallet()')
			openModalId('#walletRestore')
			closeModalId('#settingsModal')



				// DETECT IF ARE WORDS OR PRIVATE KEYS
				const input = document.getElementById("seedTextarea").value.trim();
				const privateKeyRegex = /^0x[a-fA-F0-9]{64}$/;
				const seedPhraseRegex = /^(\b[A-Za-z]+\b\s){11}(\b[A-Za-z]+\b)$/;

				


			seedTextarea.addEventListener('input', function (evt) {
				console.log(this.value);

				// IF PRIVATE KEY
				if (privateKeyRegex.test(this.value)) {
					console.warn("Private Key Detected");
					seedTextarea.classList.add("is-valid");
				}

				// IF SEEDPHRASE
				else if (seedPhraseRegex.test(this.value)) {
					// else if (seedPhraseRegex.test(this.value.trim())) {

						let cntwrds = countWords(this.value)

				// 		if (cntwrds >= 12) {
				// 	setWalletRestore.disabled = false;
				// } else {
				// 	setWalletRestore.disabled = true;


					if (cntwrds >= 12) {
						console.warn("Seed Phrase complete!");
						setWalletRestore.disabled = true;
						seedTextarea.classList.add("is-valid");
						// HERE
					setWalletRestore.disabled = false;


					} else {
						console.warn("less than 12 words");
						setWalletRestore.disabled = false;
						setWalletRestore.disabled = true;

					}
				}

				else{
					console.warn("not valid");
					seedTextarea.classList.remove("is-valid");
					// seedTextarea.classList.add("is-valid");

				}

			



			});
		}

		function countWords(str) {
			let lngth = str.trim().split(/\s+/).length;
			console.log('countWords:', lngth)
			return lngth;
		}

		async function restoreSeed() {
			console.warn('restoreSeed()')

				// // IF PRIVATE KEY
				// if (privateKeyRegex.test(input)) {
				// 	console.warn("Private Key Detected");
					
				// }

				// // IF SEEDPHRASE
				// else if (seedPhraseRegex.test(input)) {
				// 	console.warn("Seed Phrase Detected");

				// }

			// NUEVO METODO V2
			// gets the first private key and stores a json encrypted wallet with just one priv key and remembers the password instead
				let seed = seedTextarea.value.trimStart().trimEnd();
				let w = ethers.Wallet.fromPhrase(seed);
				let pk = w.privateKey

				let signer = await new ethers.Wallet(pk) 
				let password= ''
				localStorage.setItem('jsonWalletPassword', password);// save password in localstorage
				await localStorage.removeItem('unbackedWallet')

				// await localStorage.removeItem('jsonWallet')
				console.log('signer:', signer)
				await init(signer)

				// now encrypt the json wallet and save it lo localstorage
				let encSigner = await signer.encrypt(password)
				localStorage.setItem('jsonWallet',encSigner )
				let decryptedWallet = ethers.Wallet.fromEncryptedJson()
				

				// ...
			// let seed = seedTextarea.value
			// console.log('seed:', seed)

			// localStorage.setItem('unbackedWallet', seed)
			// await localStorage.setItem('unbackedWallet', JSON.stringify(seed))




			closeModalId('#walletRestore')

			seedTextarea.value = ''
			await init()

		}




		/*********************************************************************************************
		.)   MANAGE DID
		**********************************************************************************************/
		
		// id: string; // avatar: string; // alias: string; // privData: string; // cid: string; // publicKey: PublicKey;
			async function createDIDRecord(did, avatar, alias, privData, cid, signer) {
            console.log('Now you have the signer, do whatever you need with it:', signer);
            const db = new Polybase({ defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID", });
            const data = [did, avatar, alias, privData, cid];
            db.signer(async (data) => {
                const signature = await signer.signMessage(data);//FIXED!
                return { h: 'eth-personal-sign', sig: signature, };
            });

            const collectionReference = db.collection("STARKID");
            await collectionReference.create(data);

        }


		async function readDIDRecord(id) {
            const db = new Polybase({
                defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
            });

            const collectionReference = db.collection("STARKID");
            const record = await collectionReference.record(id).get();
            const { data } = record; // or const data = record.data
            const resultRecord = record.get();
            console.log('resultRecord:', resultRecord)
            return resultRecord
        }

		async function deleteDID(did, signer) {
            console.log('deleteDID()')

            const db = new Polybase({
                defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
            });

            db.signer(async (did) => {
                console.log('data:', did)
                const signature = await signer.signMessage(did);
                return { h: 'eth-personal-sign', sig: signature, };
            });
            try {
                const recordData = await db
                    .collection("STARKID")
                    .record(did)
                    .call("deleteDID");
            } catch (error) {
                console.error("An error occurred:", error);
            }
            return true

        }


		async function updateAvatarDID(did, newdata, signer) {
            console.log('updateDID()')

            const db = new Polybase({
                defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
            });

            // const newdatab = [did, newdata];

            db.signer(async (newdata) => {
                console.log('data:', newdata)
                const signature = await signer.signMessage(newdata);
                return { h: 'eth-personal-sign', sig: signature, };
            });
            try {
                const recordData = await db
                    .collection("STARKID")
                    .record(did)
                    .call("updateAvatar", [newdata]);
                console.log("recordData:", recordData);
				console.warn('suscesfully updated DID')
				Toast.fire({ icon: 'success', title: 'suscesfully updated DID' });
				

            } catch (error) {
                console.error("An error occurred:", error);
				fixedToast.fire('Error', error.message, "error");

            }
            return true


        }


		async function updateAliasDID(did, newdata, signer) {
            console.log('updateDID()')

            const db = new Polybase({
                defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
            });

            // const newdatab = [did, newdata];

            db.signer(async (newdata) => {
                console.log('data:', newdata)
                const signature = await signer.signMessage(newdata);
                return { h: 'eth-personal-sign', sig: signature, };
            });
            try {
                const recordData = await db
                    .collection("STARKID")
                    .record(did)
                    .call("updateAlias", [newdata]);
                console.log("recordData:", recordData);
            } catch (error) {
                console.error("An error occurred:", error);
            }
            return true


        }



        async function updatePrivDataDID(did, newdata, signer) {
            console.log('updateDID()')

            const db = new Polybase({
                defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
            });

            // const newdatab = [did, newdata];

            db.signer(async (newdata) => {
                console.log('data:', newdata)
                const signature = await signer.signMessage(newdata);
                return { h: 'eth-personal-sign', sig: signature, };
            });
            try {
                const recordData = await db
                    .collection("STARKID")
                    .record(did)
                    .call("updatePrivData", [newdata]);
                console.log("recordData:", recordData);
            } catch (error) {
                console.error("An error occurred:", error);
            }
            return true


        }




        // --------------------------------------
        //    ENCRYPT FUNCITON
        async function encryptPrivkey(privkey, pubkey, toEncrypt) {
            console.log('encryptPrivkey()', toEncrypt)
            // 0. coniverte en estring la eth priv key
            const secretMessage = EthCrypto.cipher.stringify(toEncrypt);
            console.log('ethPrivKeyString: ', secretMessage)

            // 1.
            const signature = EthCrypto.sign(privkey, EthCrypto.hash.keccak256(secretMessage));
            console.log('signature: ', signature)

            // 2.
            const payload = { message: secretMessage, signature };

            // 3.
            const encrypted = await EthCrypto.encryptWithPublicKey(pubkey, JSON.stringify(payload));

            console.log('Alice encrypted ETH private key to store in registry:', encrypted)

            // 4.
            // we convert the object into a smaller string-representation
            const encryptedString = EthCrypto.cipher.stringify(encrypted);
            console.log('Alice encrypted ETH private key to store in registry STRING: ', encryptedString)
            // return encryptedString
            return encryptedString

        }

		  // -----------------------------------
        // DECRYPT
		async function decryptPrivData(privkey, pubkey, toDecrypt) {
            console.log('encryptPrivkey()', toDecrypt)

            // ---------------
            // DECRYPTING
            // we parse the string into the object again
            const encryptedObject = EthCrypto.cipher.parse(toDecrypt);

            const decrypted = await EthCrypto.decryptWithPrivateKey(privkey, encryptedObject);
            const decryptedPayload = JSON.parse(decrypted);
            console.log('DECRYPRED‚úÖ!!!', decryptedPayload)
            // check signature
            const senderAddress = EthCrypto.recover(decryptedPayload.signature, EthCrypto.hash.keccak256(decryptedPayload.message));
            console.log('ETH Private key stored  by  ' + senderAddress + '<br>is: ' + decryptedPayload.message);
            // result.innerHTML = '<br><br>‚úÖ‚úÖ‚úÖ STARKNET Private key DECRYPTED  ‚úÖ‚úÖ‚úÖ  by  ' + senderAddress + ' is: <br> ' + decryptedPayload.message

            return [decryptedPayload.message, senderAddress]
             

        }

    

    // ----------------------------
    // GET SIGNER


    async function getLocalWalletSigner() {
      console.log('getLocalWalletSigner()');
      return Swal.fire({
        // title: 'Unlock your LOCALWALLET',
        title: dictionary[globalLang]["unlocklocalwallet"],
        input: 'password',
        inputAttributes: { autocapitalize: 'off' },
        showCancelButton: true,
        confirmButtonText: 'Enter',
        showLoaderOnConfirm: true,
        backdrop: true,
        preConfirm: (login) => { },
        allowOutsideClick: () => {
          const popup = Swal.getPopup();
          popup.classList.remove('swal2-show');
          setTimeout(() => {
            popup.classList.add('animate__animated', 'animate__headShake');
          });
          setTimeout(() => {
            popup.classList.remove('animate__animated', 'animate__headShake');
          }, 500);
          return false;
        },
      }).then(async (result) => {
        if (result.isConfirmed) {
          console.log('password entered!');
          if (result.value == '') {
            console.log('IS EMPTY');
            Toast.fire({ icon: 'error', title: 'Password cannot be empty' });
            return null;
          }

          let encryptedjson = localStorage.getItem('jsonWallet');
          let ew = JSON.parse(encryptedjson);
          console.log('pub key of wallet in localstorage:', ew.address);

          try {
            return ethers.Wallet.fromEncryptedJson(encryptedjson, result.value).then(async (localWallet) => {
              console.log('localWallet.publicKey:', localWallet.publicKey);
              let provider = new ethers.JsonRpcProvider(`${optionsList[0].API}`); //v6
              const signer = localWallet.connect(provider);
              console.log('SIGNER:', signer);
              return signer;
            });
          } catch (error) {
            console.error('Error during wallet decryption:', error);
            Toast.fire('Error', error.message, "error");
            Swal.fire({
              icon: "error",
              title: "Error",
              text: error.message,
            });
            // Handle the error here, you can show a toast or do something else.
            return null;
          }
        }
        return null;
      }).catch(error => {
        console.error('Error during Swal prompt:', error.reason);
        // Toast.fire('Error', error.message, "error");
        Toast.fire('Error', error.message, "error");
        Swal.fire({
          icon: "error",
          title: "Error",
          text: error.message,
        });


        // Handle the error here, you can show a toast or do something else.
        return null;
      });
    }

 

 

		/*********************************************************************************************
		.)   UPDATE IMAGE AVATA
		**********************************************************************************************/

		avatarIMG.onclick = function (e) {
			console.log('avatarIMG clicked')
			e.preventDefault()

			openModalId('#didManagerModal')
			// loadCroppedImg()

		};

		changeAvatar.onclick = function (e) {
			console.log('aliasAvatar clicked')
			e.preventDefault()

			loadCroppedImg()

		};

		async function compressImage(imageSrc, maxSizeKB) {
			return new Promise((resolve, reject) => {
				const img = new Image();
				img.onload = function () {
					const canvas = document.createElement('canvas');
					const ctx = canvas.getContext('2d');

					// Calculate new dimensions to maintain aspect ratio
					const MAX_WIDTH = 800;
					const MAX_HEIGHT = 600;
					let width = img.width;
					let height = img.height;
					if (width > height) {
						if (width > MAX_WIDTH) {
							height *= MAX_WIDTH / width;
							width = MAX_WIDTH;
						}
					} else {
						if (height > MAX_HEIGHT) {
							width *= MAX_HEIGHT / height;
							height = MAX_HEIGHT;
						}
					}

					// Set canvas dimensions
					canvas.width = width;
					canvas.height = height;

					// Draw image on canvas
					ctx.drawImage(img, 0, 0, width, height);

					// Convert canvas to Blob and compress to target size
					canvas.toBlob(function (blob) {
						// Check if compressed image is within target size
						if (blob.size / 1024 <= maxSizeKB) {
							// Resolve with the compressed data URL
							resolve(canvas.toDataURL());
						} else {
							// Reject if compressed image size exceeds target size
							reject('Compressed image size exceeds the specified limit');
						}
					}, 'image/jpeg', 0.7); // Adjust the quality factor (0.7 here) to achieve desired compression level
				};
				img.src = imageSrc;
			});
		}



		async function loadCroppedImg() {
			console.log('loadCroppedImg()');

			// openModalId('#createDIDModal')
			// fileCreateItemFile => avatarIMGfile 

			await avatarIMGfile.click();
			let previewsrc;

			avatarIMGfile.onchange = async function () {
				if (avatarIMGfile.files.length == 1) {
					const data = this.files[0];
					const name = data.name;

					// Read the file and get its base64 data
					let reader = new FileReader();
					reader.readAsDataURL(data);

					reader.onload = async function () {
						previewsrc = reader.result;

						// Compress the image
						const compressedDataUrl = await compressImage(previewsrc, 100); // 100KB limit

						// Display the image in a SweetAlert2 popup
						Swal.fire({
							// title: 'crop',
							// title: dictionary[globalLang]["uploadsignature"],
							html: `
                        <img id="preview" src="${compressedDataUrl}" style="display:none">
                        <div>
                            <img id="cropperjs" src="${compressedDataUrl}">
                        </div>
                    `,
							allowOutsideClick: () => {
								const popup = Swal.getPopup();
								popup.classList.remove('swal2-show');
								setTimeout(() => {
									popup.classList.add('animate__animated', 'animate__headShake');
								});
								setTimeout(() => {
									popup.classList.remove('animate__animated', 'animate__headShake');
								}, 500);
								return false;
							},
							willOpen: () => {
								const image = document.querySelector('#cropperjs');
								// const cropper = new Cropper(image, {
									cropper = new Cropper(image, {
									// aspectRatio: '4:3',
									  aspectRatio: 1/1,
									viewMode: 1,
									crop: throttle(function () {
										const croppedCanvas = cropper.getCroppedCanvas();
										// console.log('croppedCanvas:', croppedCanvas);
										
										const preview = document.querySelector('#preview');
										preview.src = croppedCanvas.toDataURL();

										let cropperinfo = cropper.getContainerData()
										// console.log("cropperinfo:",cropperinfo)
									}, 25),
								});
							},
							preConfirm: () => {
								const popup = Swal.getPopup();
								if (popup) {
									const previewElement = popup.querySelector('#preview'); // Assuming preview is the ID of the image element
									if (previewElement instanceof HTMLImageElement) {
										return previewElement.src;
									}
								}
							},
						}).then(async  function (result) {
							avatarIMG.src = result.value;
							let b64 = JSON.stringify(result.value);
							console.log('b64 image:', b64);
							localStorage.setItem('avatar', b64);
							avatarIMG.style.display = 'block';
							// Toast.fire('Avatar added', '', "success");


							// ...........................................................................................
							// 3.RECORD TO ZKROLLUP DB
							// ..........................................................................................

							let avatar = localStorage.getItem('avatar');
							let cid = '';

								// ------------------------------------
								// GET SIGNER
							let presigner = await getSigner()

							let provider = new ethers.JsonRpcProvider(`${optionsList[0].API}`); //v5
								let signer = presigner.connect(provider);
								console.log('SIGNER!:', signer);
								// did = `did:ethr:${signer.address}`
								let did = `did:ius:${signer.address}`

								console.log('DID: ', did)



							// ---------------

							try {
								console.log('creating did RECORD, signer', signer)
								// await updateAvatarDIDRecord(did, avatar, cid, signer);
								await updateAvatarDID(did, avatar, signer) 
								// await createDIDRecord(did, avatar, cid, signer);
								//  https://explorer.testnet.polybase.xyz/studio/pk%2F0xee1b340c80295bb60ada66e0396a44b70c479a857c357b37883d27efe030aaf8baf25fde75eaf8881bb6c0f34fac20dbf6896fc373d5835e43ffe01f216feab9%2FIURISNATURALIS/collections/CHATWALLETDID
							} catch (error) {
								console.error('An error occurred while creating DID record:', error);
								return
							}

							// REMOVE FROM LOCALSTORAGE
							 localStorage.removeItem('avatar');
							console.warn('AVATAR REMOVED FROM LOCALSTORAGE!üö´')


						});
					};
				}
			};
		}





		/*********************************************************************************************
		.)  MINT OR UPDATE
		**********************************************************************************************/

		async function mintOrUpdate() {
			console.log('mintOrUpdate()')

			// Example CID to register
			const cid = "QmYwAPJzv5CZsnAztbqiXLypCQzqJGdUJwHThYro4Mwdd2";

			// Call the function
			await registerOnchainDID(cid);		

		}


		async function registerOnchainDID(cid) {

			const provider = new ethers.JsonRpcProvider(optionsList[0].API);
			let chatETHPrivKey = localStorage.getItem('chatETHPrivKey');
			let signer = await new ethers.Wallet(chatETHPrivKey) 
			const contractAddress = optionsList[0].REGISTRY_CONTRACT_ADDRESS
			const contractABI = [
				"function registerDID(string memory _cid) public",
				"event DIDRegistered(bytes32 indexed didHash, string cid)"
			];


			const connectedSigner = await signer.connect(provider);

			// Create contract instance
			const contract = new ethers.Contract(contractAddress, contractABI, connectedSigner);


				try {
					// Call the registerDID function
					const tx = await contract.registerDID(cid);

					console.log("Transaction sent:", tx.hash);

					// Wait for the transaction to be mined
					const receipt = await tx.wait();
					console.log("Transaction mined:", receipt);

					Swal.fire({
							icon: "success",
							title: "Done",
							text: "Tx succesfull!",
							footer: `<a target="_blank" rel="noopener noreferrer" href="https://explorer-warringstakes.meter.io/tx/${receipt.hash}">Tx link</a>`
						});


				} catch (error) {
					console.error("Error registering DID:", error);
					console.error("Error message:", error.error.message);
					e= error;
				}
			}


			async function updateOnchainDID(cid) {

				const provider = new ethers.JsonRpcProvider(optionsList[0].API);
				let chatETHPrivKey = localStorage.getItem('chatETHPrivKey');
				let signer = await new ethers.Wallet(chatETHPrivKey) 
				const contractAddress = optionsList[0].REGISTRY_CONTRACT_ADDRESS
				const contractABI = [
					"function registerDID(string memory _cid) public",
					"event DIDRegistered(bytes32 indexed didHash, string cid)"
				];


				const connectedSigner = await signer.connect(provider);

				// Create contract instance
				const contract = new ethers.Contract(contractAddress, contractABI, connectedSigner);


					try {
						// Call the registerDID function
						const tx = await contract.registerDID(cid);

						console.log("Transaction sent:", tx.hash);

						// Wait for the transaction to be mined
						const receipt = await tx.wait();
						console.log("Transaction mined:", receipt);

						Swal.fire({
								icon: "success",
								title: "Done",
								text: "Tx succesfull!",
								footer: `<a target="_blank" rel="noopener noreferrer" href="https://explorer-warringstakes.meter.io/tx/${receipt.hash}">Tx link</a>`
							});


					} catch (error) {
						console.error("Error registering DID:", error);
					}
				}




			async function getDID() {
				const provider = new ethers.JsonRpcProvider(optionsList[0].API);
				let chatETHPrivKey = localStorage.getItem('chatETHPrivKey');
				let signer = await new ethers.Wallet(chatETHPrivKey) 
				const contractAddress = optionsList[0].REGISTRY_CONTRACT_ADDRESS
				const contractABI = [ "function cids(address) view returns (string)" ];
				
				// Create contract instance
				const contract = new ethers.Contract(contractAddress, contractABI, provider);
				
				// Address to query
				let addressToQuery = signer.address;
				try {
					// Call the cids function
					const cid = await contract.cids(addressToQuery);
					console.log("CID:", cid);
					
				} catch (error) {
					console.error("Error querying CID:", error);
				}
			}



		async function checkGasBalance(walletAddress) {
			console.log('checkGasBalance() of ', walletAddress)

			let provider = await new ethers.JsonRpcProvider(`${optionsList[0].API}`);
			try {
				const balance = await provider.getBalance(walletAddress);
				const gasBalance = ethers.formatEther(balance);
				console.log(`GAS Balance of ${optionsList[0].TOKEN_ADDRESS}: ${gasBalance} GAS`);

				return gasBalance;
			} catch (error) {
				console.error('Error checking balance:', error.reason);
				return null;
			}
		}


		function addField() {
      const fieldContainer = document.getElementById('additionalFields');
      const newField = document.createElement('div');
      newField.classList.add('mb-2');
      newField.innerHTML = '<input type="text" class="form-control" placeholder="Enter text">';
      fieldContainer.appendChild(newField);
    }
			</script>
	</body>
</html>
