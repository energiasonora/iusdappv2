<!DOCTYPE html>
<html lang="en" class="no-js">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>STARK ID</title>
		<meta name="description" content="a DID managing tool to communicate your public and private data with sovereignty" />
		<meta name="keywords" content="did, starknet " />
		<meta name="author" content="Xunorus" />
		<link rel="shortcut icon" href="favicon.ico">
		<link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet">
		
        <script src="js/sweetalert2.all.min.js"></script>
        <script src="js/qr-code-styling.js"></script>
		
		
		
		<!-- <link rel="stylesheet" type="text/css" href="css/starkid.css" /> -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
		
		<link rel="stylesheet" type="text/css" href="css/starkid.css" />
		<link rel="stylesheet" type="text/css" href="css/buttons.css" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />

		<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" /> -->


		<!--[if IE]>
  		<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]--><script>document.documentElement.className = 'js';</script>
	</head>
	<body class="demo-1">

		<div class="overlay"></div>


  <!-- /*********************************************************************************************
  .) SIDEBAR
  **********************************************************************************************/ -->
  <div id="sidebar" class='sidebar'>
    <a class='closeonclick' href="/">
      <div class='title '> </div>
    </a>
   
    <input name="avatarIMG" id="avatarIMGfile" type="file" style="display:none" accept="image/*" /> <!-- ex fileCreateItemFile -->
    <img id="avatarIMG" src="img/anonym.jpg" alt="Avatar" class=""> <!-- ex itemImgMINT -->
 
    <div class="container mt-3">
      <div class="row">
        <div class="col text-center" id="configButtons">
          
			<button type="button" id="" class="btn btn-primary" onclick="event.stopPropagation();addAddress()">
            <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 640 512">
              <path
                d="M96 128a128 128 0 1 1 256 0A128 128 0 1 1 96 128zM0 482.3C0 383.8 79.8 304 178.3 304h91.4C368.2 304 448 383.8 448 482.3c0 16.4-13.3 29.7-29.7 29.7H29.7C13.3 512 0 498.7 0 482.3zM504 312V248H440c-13.3 0-24-10.7-24-24s10.7-24 24-24h64V136c0-13.3 10.7-24 24-24s24 10.7 24 24v64h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H552v64c0 13.3-10.7 24-24 24s-24-10.7-24-24z" />
            </svg>
          </button>
          <!-- <button type="button" id="" class="btn btn-reject" onclick="event.stopPropagation(); scanAddress()"> -->
          <button type="button" id="" class="btn btn-danger" onclick="event.stopPropagation(); scanAddress()">
            <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512">
              <path
                d="M0 80C0 53.5 21.5 32 48 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V80zM64 96v64h64V96H64zM0 336c0-26.5 21.5-48 48-48h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V336zm64 16v64h64V352H64zM304 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H304c-26.5 0-48-21.5-48-48V80c0-26.5 21.5-48 48-48zm80 64H320v64h64V96zM256 304c0-8.8 7.2-16 16-16h64c8.8 0 16 7.2 16 16s7.2 16 16 16h32c8.8 0 16-7.2 16-16s7.2-16 16-16s16 7.2 16 16v96c0 8.8-7.2 16-16 16H368c-8.8 0-16-7.2-16-16s-7.2-16-16-16s-16 7.2-16 16v64c0 8.8-7.2 16-16 16H272c-8.8 0-16-7.2-16-16V304zM368 480a16 16 0 1 1 0-32 16 16 0 1 1 0 32zm64 0a16 16 0 1 1 0-32 16 16 0 1 1 0 32z" />
            </svg>
          </button>
          <button type="button" id="" class="btn btn-success" onclick="event.stopPropagation(); settings()">
            <svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">
              <path
                d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z" />
            </svg>
          </button>
        </div>
      </div>
    </div>
    
	<!-- <ul id="cwContacts" class='nav'> </ul> -->
	<ul id="cwContacts" class="nav">
	<!--  
	<li data-address="0x137a64f5F1C1C0595d4C9c12E68f99fA6f841407" id="0x137a64f5F1C1C0595d4C9c12E68f99fA6f841407" class=""> 
		<a onclick="event.stopPropagation();selectChat((this.parentElement))">  
			<img id="did:ethr:0x137a64f5F1C1C0595d4C9c12E68f99fA6f841407" src="img/avatar.png" alt="Avatar" class="rounded-circle"> 
				<span>0x137a...1407 <span> 
			<i class="fa-solid fa-trash"></i>
			<svg onclick="event.stopPropagation();editContact('0x137a64f5F1C1C0595d4C9c12E68f99fA6f841407')" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="20" height="25" class="right">
				<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"></path>
			</svg>
		</span></span></a> 
	</li> -->
	
</ul>



  </div>


    <!-----------------------------
	LOADER 
	--------------------------->
<div class="loaderDiv" id="loader"> <span class="loader"></span> </div>

		<svg class="hidden">
			<defs>

				<!-- 1 -->
				<symbol id="icon-menu" viewBox="0 0 24 24" >
					<title >menu</title>
					<image preserveAspectRatio="none" inkscape:svg-dpi="300" width="17.49" height="19.988571" style="image-rendering:optimizeQuality" xlink:href="data:image/svg+xml;base64,PHN2ZyBpZD0iaWNvbi1tZW51IiB2aWV3Qm94PSIwIDAgNDQ4IDUxMiI+CjxwYXRoIGQ9Ik0wIDk2 QzAgNzguMyAxNC4zIDY0IDMyIDY0SDQxNmMxNy43IDAgMzIgMTQuMyAzMiAzMnMtMTQuMyAzMi0z MiAzMkgzMkMxNC4zIDEyOCAwIDExMy43IDAgOTZ6TTAgMjU2YzAtMTcuNyAxNC4zLTMyIDMyLTMy SDQxNmMxNy43IDAgMzIgMTQuMyAzMiAzMnMtMTQuMyAzMi0zMiAzMkgzMmMtMTcuNyAwLTMyLTE0 LjMtMzItMzJ6TTQ0OCA0MTZjMCAxNy43LTE0LjMgMzItMzIgMzJIMzJjLTE3LjcgMC0zMi0xNC4z LTMyLTMyczE0LjMtMzIgMzItMzJINDE2YzE3LjcgMCAzMiAxNC4zIDMyIDMyeiIvPgo8L3N2Zz4K " id="image120" x="3.2550001" y="2.0057144" />
				  </symbol>				 
				  <!-- 1 -->
				<symbol id="icon-arrow" viewBox="0 0 24 24">
					<title>arrow</title>
					<polygon points="6.3,12.8 20.9,12.8 20.9,11.2 6.3,11.2 10.2,7.2 9,6 3.1,12 9,18 10.2,16.8 "/>
				</symbol>

				<symbol id="icon-drop" viewBox="0 0 24 24">
					<title>drop</title>
					<path d="M12,21c-3.6,0-6.6-3-6.6-6.6C5.4,11,10.8,4,11.4,3.2C11.6,3.1,11.8,3,12,3s0.4,0.1,0.6,0.3c0.6,0.8,6.1,7.8,6.1,11.2C18.6,18.1,15.6,21,12,21zM12,4.8c-1.8,2.4-5.2,7.4-5.2,9.6c0,2.9,2.3,5.2,5.2,5.2s5.2-2.3,5.2-5.2C17.2,12.2,13.8,7.3,12,4.8z"/><path d="M12,18.2c-0.4,0-0.7-0.3-0.7-0.7s0.3-0.7,0.7-0.7c1.3,0,2.4-1.1,2.4-2.4c0-0.4,0.3-0.7,0.7-0.7c0.4,0,0.7,0.3,0.7,0.7C15.8,16.5,14.1,18.2,12,18.2z"/>
				</symbol>
				<symbol id="icon-search" viewBox="0 0 24 24">
					<title>search</title>
					<path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
				</symbol>
				<symbol id="icon-cross" viewBox="0 0 24 24">
					<title>cross</title>
					<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
				</symbol>
			</defs>
		</svg>

		
		
		<main class="main-wrap">
			<header class="codrops-header">
				<h1 class="codrops-header__title">STARKID</h1>
				<div class="search-wrap">
					<button id="btn-search" class="btn btn--search" style="display: none;"> <svg class="icon icon--search"><use xlink:href="#icon-search"></use></svg></button>

				</div>

				<span class="badge bg-primary" id="chatBadge">-</span>
				<button id="" class="right hamburger hamburger--elastic" type="button" aria-label="Menu" aria-controls="navigation">
				  <span class="hamburger-box">
					<span class="hamburger-inner"></span>
				  </span>
				</button>


			</header>

<!-- =================== -->
<div id="qrtroqcontainer" class=" container swiperSlide">


	<div class=" responsive-svg" id="canvas"></div>
		
</div>
<pre id="yourAddress"> </pre>
<!-- ======================= -->
 

<div id="qrresult"> </div>


	<div class="bottom-nav">
		<nav class="codrops-demos">
			<span>v 0.11 </span>
		</nav>
	</div>

<!-- FIN UI -->

</main>


<div class="search" id="chatContainer">
	<button id="btn-search-close" class="btn btn--search-close" aria-label="Close search form"><svg class="icon icon--cross"><use xlink:href="#icon-cross"></use></svg></button>

	<div id="chatheader" class="">
		<span id="chatAddress"></span>
		<span class="alignright " id="actionButtons"> </span>
	</div>


	
	<div class="search__related" id="chatBox">
		<div class="search__suggestion">
			<h3>Contacts</h3>
			<p>#drone #funny #catgif #broken #lost #hilarious #good #red #blue #nono #why #yes #yesyes #aliens #green</p>

			<h3>Blocked</h3>
			<p>#0x123456789123456786,#0x123456789123456785,#0x123456789123456784</p>

			<h3>Unapproved contacts</h3>
			<p>#0x123456789123456789,#0x123456789123456788,#0x123456789123456787</p>
		</div>
		<!-- <div class="search__suggestion">
			<h3>Unapproved contacts</h3>
			<p>#0x123456789123456789,#0x123456789123456788,#0x123456789123456787</p>
		</div>
		<div class="search__suggestion">
			<h3>Blocked</h3>
			<p>#0x123456789123456786,#0x123456789123456785,#0x123456789123456784</p>
		</div> -->
	</div>

	<!-- <div class="" id="chatBox">

	</div> -->

<!-- ---CHAT -->

<!-- <div class="swiper-slide">
	<div id="chatcontainer" class="">
		<div id="chatheader" class="">
			<span id="chatAddress"></span>
			<span class="alignright " id="actionButtons"> </span>
		</div>
		<div class="" id="chatBox">

		</div>
		<div id="chatfooter" class="">
			<div class="input-group">
				<input type="text" class="form-control" id="chatTextInput" placeholder="Type a message..."
					disabled>
				<button class="btn btn-primary" id="send-button" onclick="sendMessage()" disabled>
					<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">
						<path
							d="M440 6.5L24 246.4c-34.4 19.9-31.1 70.8 5.7 85.9L144 379.6V464c0 46.4 59.2 65.5 86.6 28.6l43.8-59.1 111.9 46.2c5.9 2.4 12.1 3.6 18.3 3.6 8.2 0 16.3-2.1 23.6-6.2 12.8-7.2 21.6-20 23.9-34.5l59.4-387.2c6.1-40.1-36.9-68.8-71.5-48.9zM192 464v-64.6l36.6 15.1L192 464zm212.6-28.7l-153.8-63.5L391 169.5c10.7-15.5-9.5-33.5-23.7-21.2L155.8 332.6 48 288 464 48l-59.4 387.3z" />
					</svg>
				</button>
			</div>
		</div>
	</div>
</div> -->
<!-- fin chat -->
	<form class="search__form" action="" id="chatfooter">
		<input   id="chatTextInput" class="search__input" name="search" type="search" placeholder="Type a message..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />

		<button class="btn btn-primary" id="send-button" onclick="sendMessage()" disabled>
			<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">
				<path
					d="M440 6.5L24 246.4c-34.4 19.9-31.1 70.8 5.7 85.9L144 379.6V464c0 46.4 59.2 65.5 86.6 28.6l43.8-59.1 111.9 46.2c5.9 2.4 12.1 3.6 18.3 3.6 8.2 0 16.3-2.1 23.6-6.2 12.8-7.2 21.6-20 23.9-34.5l59.4-387.2c6.1-40.1-36.9-68.8-71.5-48.9zM192 464v-64.6l36.6 15.1L192 464zm212.6-28.7l-153.8-63.5L391 169.5c10.7-15.5-9.5-33.5-23.7-21.2L155.8 332.6 48 288 464 48l-59.4 387.3z" />
			</svg>
		</button>

		<button class="btn btn-primary" id="send-attachment" onclick="sendAttachment()" disabled>
			<!-- <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">
				<path
					d="M440 6.5L24 246.4c-34.4 19.9-31.1 70.8 5.7 85.9L144 379.6V464c0 46.4 59.2 65.5 86.6 28.6l43.8-59.1 111.9 46.2c5.9 2.4 12.1 3.6 18.3 3.6 8.2 0 16.3-2.1 23.6-6.2 12.8-7.2 21.6-20 23.9-34.5l59.4-387.2c6.1-40.1-36.9-68.8-71.5-48.9zM192 464v-64.6l36.6 15.1L192 464zm212.6-28.7l-153.8-63.5L391 169.5c10.7-15.5-9.5-33.5-23.7-21.2L155.8 332.6 48 288 464 48l-59.4 387.3z" />
			</svg> -->

			<svg xmlns="http://www.w3.org/2000/svg"  height="1em"viewBox="0 0 448 512">
				<path d="M364.2 83.8c-24.4-24.4-64-24.4-88.4 0l-184 184c-42.1 42.1-42.1 110.3 0 152.4s110.3 42.1 152.4 0l152-152c10.9-10.9 28.7-10.9 39.6 0s10.9 28.7 0 39.6l-152 152c-64 64-167.6 64-231.6 0s-64-167.6 0-231.6l184-184c46.3-46.3 121.3-46.3 167.6 0s46.3 121.3 0 167.6l-176 176c-28.6 28.6-75 28.6-103.6 0s-28.6-75 0-103.6l144-144c10.9-10.9 28.7-10.9 39.6 0s10.9 28.7 0 39.6l-144 144c-6.7 6.7-6.7 17.7 0 24.4s17.7 6.7 24.4 0l176-176c24.4-24.4 24.4-64 0-88.4z"/></svg>
		</button>
		
		<span class="search__info">Hit enter to send or ESC to close</span>
	</form>


</div><!-- /search chat-->


<!-- MODALS -->

	<!-- Modal wallet RESTORE -->
	<div class="modal fade" data-bs-backdrop="static" id="walletRestore" tabindex="-1" role="dialog" aria-labelledby=""
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="walletrestore" id="">WALLET RESTORE</h5>
				</div>
				<div class="modal-body">
					<!-- SEED -->
					<div id="seedData">
						<div class="mb-3">
							<label for="seedTextarea" class="form-label">Paste your Starknet or ETH Private key</label>
							<textarea class="form-control" id="seedTextarea" rows="3"></textarea>
						</div>
						<!-- PASSWORD -->
						<div class="row g-3 align-items-center">
							<div class="col-auto">
								<label for="seedPassword" class="col-form-label">Password</label>
							</div>
							<div class="col-auto">
								<input type="password" id="seedPassword" class="form-control"
									aria-describedby="passwordHelpInline">
								<div class="valid-feedback">Valid.</div>
								<div class="invalid-feedback">Please set a password.</div>
							</div>

						</div>
					</div>
					<div id="displayRestoreProgress"></div>
					<div id="success_message3" class="alert alert-success" role="alert" style="display: none;"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary closeWalletBkp" id="closeWalletRestore"
						data-bs-dismiss="modal" data-translate="close">Cancel</button>
					<button type="button" class="btn btn-outline-secondary closeWalletBkp" id="setWalletRestore"
						data-translate="restore" onclick="event.stopPropagation(); restoreSeed()"
						disabled>Restore</button>
				</div>
			</div>
		</div>
	</div>
	<!-- fin walelt RESTORE WALLET-->

	<!-- SCAN MODAL -->
	<div class="modal fade" data-bs-backdrop="static" id="scanModal" tabindex="-1" role="dialog" aria-labelledby=""
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="scanqr" id="">Scan QR</h5>
				</div>

				<div class="modal-body" id="">
					<div class="">
						<div class="responsive-svg" id="qrcanvas"></div>
						<video id="qrScanVideo" width="300" height="300"></video>
						<div id="scanResult"></div>

					</div>

					<div class="modal-footer">
						<button type="button" class="btn btn-outline-secondary closeWalletBkp" id="closeScanModal"
							data-translate="close">Close</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- fin SCAN MODAL-->



	<!-- SETTINGS MODAL -->
	<div class="modal fade" id="settingsModal" data-bs-backdrop="static" tabindex="-1"
		aria-labelledby="settingsModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="settingsModalLabel">SETTINGS </h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>


				<div class="modal-body" id="settingsCardContainer">
					<h4>Keys management</h4>

					<button type="button" id="" class="btn btn-primary" onclick="event.stopPropagation(); backup()">
						<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">
							<path fill="currentColor"
								d="M512 32c0 113.6-84.6 207.5-194.2 222c-7.1-53.4-30.6-101.6-65.3-139.3C290.8 46.3 364 0 448 0h32c17.7 0 32 14.3 32 32zM0 96C0 78.3 14.3 64 32 64H64c123.7 0 224 100.3 224 224v32V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V320C100.3 320 0 219.7 0 96z" />
						</svg> Backup </button>

					<button type="button" id="" class="btn btn-primary"
						onclick="event.stopPropagation(); restoreWallet()"> <svg xmlns="http://www.w3.org/2000/svg"
							height="16" width="16" viewBox="0 0 512 512">
							<path fill="currentColor"
								d="M174.7 45.1C192.2 17 223 0 256 0s63.8 17 81.3 45.1l38.6 61.7 27-15.6c8.4-4.9 18.9-4.2 26.6 1.7s11.1 15.9 8.6 25.3l-23.4 87.4c-3.4 12.8-16.6 20.4-29.4 17l-87.4-23.4c-9.4-2.5-16.3-10.4-17.6-20s3.4-19.1 11.8-23.9l28.4-16.4L283 79c-5.8-9.3-16-15-27-15s-21.2 5.7-27 15l-17.5 28c-9.2 14.8-28.6 19.5-43.6 10.5c-15.3-9.2-20.2-29.2-10.7-44.4l17.5-28zM429.5 251.9c15-9 34.4-4.3 43.6 10.5l24.4 39.1c9.4 15.1 14.4 32.4 14.6 50.2c.3 53.1-42.7 96.4-95.8 96.4L320 448v32c0 9.7-5.8 18.5-14.8 22.2s-19.3 1.7-26.2-5.2l-64-64c-9.4-9.4-9.4-24.6 0-33.9l64-64c6.9-6.9 17.2-8.9 26.2-5.2s14.8 12.5 14.8 22.2v32l96.2 0c17.6 0 31.9-14.4 31.8-32c0-5.9-1.7-11.7-4.8-16.7l-24.4-39.1c-9.5-15.2-4.7-35.2 10.7-44.4zm-364.6-31L36 204.2c-8.4-4.9-13.1-14.3-11.8-23.9s8.2-17.5 17.6-20l87.4-23.4c12.8-3.4 26 4.2 29.4 17L182 241.2c2.5 9.4-.9 19.3-8.6 25.3s-18.2 6.6-26.6 1.7l-26.5-15.3L68.8 335.3c-3.1 5-4.8 10.8-4.8 16.7c-.1 17.6 14.2 32 31.8 32l32.2 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-32.2 0C42.7 448-.3 404.8 0 351.6c.1-17.8 5.1-35.1 14.6-50.2l50.3-80.5z" />
						</svg> Restore </button>

					<br>
					<br>
						<input type="checkbox" id="muteCheckbox" name="muteCheckbox">
						<label for="muteCheckbox">Make Insecure(doenst require a password unlock the wallet)</label>
					<hr>

					<h4>Language</h4>

					<div class="options">

						<select class="right translation" id="langswitch">
							<option value="en">en</option>
							<option value="fr">fr</option>
							<option value="es">es</option>
						</select>
					</div>


					<hr>

					<h4>Audio</h4>

					<div class="options" id="audioOptions">
						<input type="checkbox" id="muteCheckbox" name="muteCheckbox">
						<label for="muteCheckbox">Mute</label>
					</div>

					<hr>

					<h4>Chats</h4>

					<button type="button" id="" class="btn btn-primary"
					onclick="event.stopPropagation(); createGroupChat()"> 
				
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"  height="16" width="16" >
						<!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
						<path fill="currentColor" d="M72 88a56 56 0 1 1 112 0A56 56 0 1 1 72 88zM64 245.7C54 256.9 48 271.8 48 288s6 31.1 16 42.3V245.7zm144.4-49.3C178.7 222.7 160 261.2 160 304c0 34.3 12 65.8 32 90.5V416c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V389.2C26.2 371.2 0 332.7 0 288c0-61.9 50.1-112 112-112h32c24 0 46.2 7.5 64.4 20.3zM448 416V394.5c20-24.7 32-56.2 32-90.5c0-42.8-18.7-81.3-48.4-107.7C449.8 183.5 472 176 496 176h32c61.9 0 112 50.1 112 112c0 44.7-26.2 83.2-64 101.2V416c0 17.7-14.3 32-32 32H480c-17.7 0-32-14.3-32-32zm8-328a56 56 0 1 1 112 0A56 56 0 1 1 456 88zM576 245.7v84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM320 32a64 64 0 1 1 0 128 64 64 0 1 1 0-128zM240 304c0 16.2 6 31 16 42.3V261.7c-10 11.3-16 26.1-16 42.3zm144-42.3v84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM448 304c0 44.7-26.2 83.2-64 101.2V448c0 17.7-14.3 32-32 32H288c-17.7 0-32-14.3-32-32V405.2c-37.8-18-64-56.5-64-101.2c0-61.9 50.1-112 112-112h32c61.9 0 112 50.1 112 112z"/></svg>

					QR groupe Invite</button>
					<!-- scan this qr to be added to this group -->

				</div>


				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<!-- SETTINGS SETTINGS -->



	<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.29/Tone.min.js"></script>

	<script src="js/ethers-6.12.1.umd.min.js" type="application/javascript"></script>
 
		<script type="module" src="js/demo1.js"></script>
		<script type="module">
	  // XMTP
	  import { Client } from '@xmtp/xmtp-js'
		window.Client = Client;

import { Provider, Account, constants, ec, json, stark, Provider, hash, CallData ,} from 'starknet';
// import { Provider, Account, constants, ec, json, stark, Provider, hash, CallData, validateAddress, encodeShortString } from 'starknet';

			window.Provider = Provider;
			window.Account = Account;
			window.constants = constants;
			window.ec = ec;
			window.json = json;
			window.stark = stark;
			window.Provider = Provider;
			window.hash = hash;
			window.CallData = CallData;
			// window.isHex = isHex;

			// window.validateAddress = validateAddress;
			// window.encodeShortString = encodeShortString;


			import QrScanner from "qr-scanner/qr-scanner.min.js";
		window.QrScanner = QrScanner; //make global
		QrScanner.hasCamera(); // test


	


		import { Buffer } from 'buffer';
		globalThis.Buffer = Buffer;


    // import { ethPersonalSign } from '@polybase/eth'
    // window.ethPersonalSign = ethPersonalSign; //make global

	import { Polybase } from "@polybase/client";
	window.Polybase = Polybase; //make global

		// CROPPER		
		import Cropper from 'cropperjs'
		window.Cropper = Cropper; //make global
		import { throttle } from '@github/mini-throttle'
		window.throttle = throttle; //make global
		import 'cropperjs/dist/cropper.css'
		// window.throttle
</script>

		<script>

    /*********************************************************************************************
		.) SOUNDS
		**********************************************************************************************/

		function playBeep() {
		var AudioContext = window.AudioContext || window.webkitAudioContext;
		var audioCtx = new AudioContext();

		var oscillator = audioCtx.createOscillator();
		oscillator.type = "sine"; // Set the waveform type
		oscillator.frequency.value = 864; // Set the frequency (Hz)

		oscillator.connect(audioCtx.destination);
		oscillator.start();

		// Stop the oscillator after 100 milliseconds
		setTimeout(function () {
			oscillator.stop();
		}, 100);
		}


		// Initialize Tone.js
		Tone.start();
		console.log("tone started");
		// Create a simple click sound with different parameters
		const clickSynth = new Tone.Synth({
		oscillator: {
			type: "sine", // You can experiment with different oscillator types
		},
		envelope: {
			attack: 0.01,
			decay: 0.1,
			sustain: 0.1,
			release: 0.5,
		},
		}).toDestination();

		function playButtonClickSound() {
		// Trigger the synth to produce a short click sound
		clickSynth.triggerAttackRelease("C4", "8n");
		}
		
		/*********************************************************************************************
		.) MANAGE MODALS
		**********************************************************************************************/


function openModalId(id, event) {
  console.log("openingModal", id, event);
  setTimeout(() => {
    window[id + "Modal"] = new bootstrap.Modal(document.querySelector(`${id}`));
    window[id + "Modal"].show(event);

    // Check if the modal is open
    var isModalOpen = window[id + "Modal"]._isShown;
    // console.log("Is modal open?", window[id + "Modal"], isModalOpen);
  }, 50);
}

function closeModalId(id, event) {
  console.log("closing modal", id, event);
  var modal = window[id + "Modal"];
  if (modal && modal._isShown) {
    // console.log("Is modal open?", modal, modal._isShown);
    modal.hide(event);
  } else {
    console.log("Modal is not open or not defined.");
  }
}

/*********************************************************************************************
.) sweetalert2
// position: "top-right",
**********************************************************************************************/

const ToastTop = Swal.mixin({
  toast: true,
  position: "bottom-end",
  showConfirmButton: false,
  timer: 3000,
  timerProgressBar: true,
  didOpen: (toast) => {
    toast.addEventListener("mouseenter", Swal.stopTimer);
    toast.addEventListener("mouseleave", Swal.resumeTimer);
  },
  iconColor: "white",
  customClass: {
    popup: "colored-toast",
  },
});

const Toast = Swal.mixin({
  toast: true,
  position: "bottom-end",
  showConfirmButton: false,
  timer: 3000,
  timerProgressBar: true,
  didOpen: (toast) => {
    toast.addEventListener("mouseenter", Swal.stopTimer);
    toast.addEventListener("mouseleave", Swal.resumeTimer);
  },
  iconColor: "white",
  customClass: {
    popup: "colored-toast",
  },
});



    /*********************************************************************************************
    .)  SIDEBAR
    **********************************************************************************************/

    // Get the navigation button and add a click event listener
    var navBtn = document.querySelector(".hamburger");
    navBtn.addEventListener("click", plToggle);

    // Define the plToggle function
    function plToggle(event) {
      console.log("TOOGLE NAVBAR", event);
      navBtn.classList.toggle("is-active");

      // Toggle classes for elements with class 'content', 'sidebar', and 'overlay'
      document.querySelector(".sidebar").classList.toggle("isOpen");
      document.querySelector(".overlay").classList.toggle("overlayisOpen");

      // Get the container element with class 'sidebar'
      var container = document.querySelector(".sidebar");
    }

    // Add a click event listener to the overlay element
    document.querySelector(".overlay").addEventListener("click", function (event) {
      console.log("clickeado en nav li");
      plToggle();
    });


    /*********************************************************************************************
    .)  COPY
    **********************************************************************************************/

function copy2clipboard(text) {
			// let text = `${ipfsGateway}${cid}`;
			console.log('COPIED!', text)
			let textLink = `<a href="${text}">${text}</a>`;

			if (window.clipboardData && window.clipboardData.setData) {
				ToastTop.fire('Copied to Clipboard', textLink, "success");
				return window.clipboardData.setData("Text", text);
			}
			else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
				var textarea = document.createElement("textarea");
				textarea.textContent = text;
				textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in Microsoft Edge.
				document.body.appendChild(textarea);
				textarea.select();
				try {
					ToastTop.fire('Copied to Clipboard!', textLink, "success");
					return document.execCommand("copy");  // Security exception may be thrown by some browsers.
				}
				catch (ex) {
					console.warn("Copy to clipboard failed.", ex);
					return prompt("Copy to clipboard: Ctrl+C, Enter", text);
				}
				finally {
					document.body.removeChild(textarea);
				}
			}
		}

		function shortAddressETH(address) {
    if (typeof address !== 'string' || address.length < 42) {
        throw new Error('Invalid Ethereum address');
    }
    return address.substring(0, 6) + "..." + address.substring(38, 42);
}

function shortAddress(address) {
    if (typeof address !== 'string' || address.length < 64) {
        throw new Error('Invalid StarkNet address');
    }
    return address.substring(0, 6) + "..." + address.substring(address.length - 4);
}


async function createStarknetAddress(){
            console.log('createStarknetAddress()')
			
			// CREATE STARKNET PRIVATE KEY AND CALCULATE ADDRESS 
			let privateKey = localStorage.getItem('starknetPrivKey');
            if (!privateKey) {
				privateKey = stark.randomAddress();
                console.log('New OZ account:\nprivateKey=', privateKey);
                // Store the new privateKey in localStorage
                localStorage.setItem('starknetPrivKey', privateKey);
                console.log('privKey SAVED INTO LOCALSTORAGE');
            } else {
				console.log('starknetPrivKey already exists in localStorage:', privateKey);
            }
			
			
            const starkKeyPub = ec.starkCurve.getStarkKey(privateKey);  
            console.log('publicKey=', starkKeyPub);
			
            const OZaccountClassHash = '0x2794ce20e5f2ff0d40e632cb53845b9f4e526ebd8471983f7dbd355b721d5a';

				// Calculate future address of the ArgentX account FUNCIONA!
				const AXConstructorCallData = CallData.compile({ owner: starkKeyPub, guardian: '0', });
				const argentXaccountClassHash = '0x029927c8af6bccf3f6fda035981e765a7bdbf18a2dc0d630494f8758aa908e2b';
				const AXcontractAddress = hash.calculateContractAddressFromHash( starkKeyPub, argentXaccountClassHash, AXConstructorCallData, 0 );
				console.log('Precalculated account address= ✅', AXcontractAddress);
			
            
				let modifiedAXcontractAddress = AXcontractAddress.slice(0, 2) + '0' + AXcontractAddress.slice(2);

			// 3- SHOW QR
			setAddress(modifiedAXcontractAddress)
			
			// - CREATE ETH ADDRESS
			
			return 
			
            ////////
            // 2
			const provider = new Provider({ sequencer: { network: constants.NetworkName.SN_GOERLI } });
            const OZaccount = new Account(provider, OZcontractAddress, privateKey);
            console.log('now PUBLISH',OZaccount)
return 

			console.log('DEPLOY ACCOUNT...')
			const { transaction_hash, contract_address } = await OZaccount.deployAccount({
			classHash: OZaccountClassHash,
			constructorCalldata: OZaccountConstructorCallData,
			addressSalt: starkKeyPub,
			});

			await provider.waitForTransaction(transaction_hash);
			console.log('✅ New OpenZeppelin account created.\n   address =', contract_address);



}


		/*********************************************************************************************
		.)  QR
		**********************************************************************************************/

		async function showqr(addr) {
			const qrColor = getComputedStyle(document.body).getPropertyValue('--qr');

			var isMobile = window.matchMedia("only screen and (max-width: 768px)");

			// let qrSize
			if (isMobile.matches) {
				console.log("Mobile screen detected");
				
				//get container width
				// var containerWidth = document.getElementById('qrtroqcontainer').offsetWidth;
				
				// // Code for mobile screens
				// qrSize = containerWidth - 50 ;
				// console.log("Mobile'scontainerWidth: ",containerWidth);
				qrSize = 310;
				window.scrollTo(0, 0);


			} else {
				// Code for larger screens
				console.log("Not a mobile screen");
				qrSize = 370

			}

			//QR
			const qrCode = new QRCodeStyling({
				width: `${qrSize}`, height: `${qrSize}`, type: "png", data: addr, image: `./logo4.png`,
				// dotsOptions: { color: "#1568B0", type: "extra-rounded" }, 
				dotsOptions: { color: `${qrColor}`, type: "extra-rounded" },
				backgroundOptions: { color: "var(--qrbackground)", },
				imageOptions: { crossOrigin: "anonymous", margin: 0 }
			});
			qrCode.append(document.getElementById("canvas"));
			console.log('qr code APPENDED')
			document.querySelector('.main-wrap').style.backgroundImage = 'none';
			loader.style.display= 'none'

		}


			async function init(){
				
				console.log(`
				
				███████╗████████╗ █████╗ ██████╗ ██╗  ██╗██╗██████╗ 
				██╔════╝╚══██╔══╝██╔══██╗██╔══██╗██║ ██╔╝██║██╔══██╗
				███████╗   ██║   ███████║██████╔╝█████╔╝ ██║██║  ██║
				╚════██║   ██║   ██╔══██║██╔══██╗██╔═██╗ ██║██║  ██║
				███████║   ██║   ██║  ██║██║  ██║██║  ██╗██║██████╔╝
				╚══════╝   ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═════╝ 
				
				`);
				console.log('init()')


				createStarknetAddress()
				await createXMPTchat()
			// -----------------------------------------
			//  CHECK IF USER COMES FROM A LINK
			const urlParams = new URLSearchParams(window.location.search);
			const t2AddrValue = urlParams.get('T2Addr');
			if (t2AddrValue !== null) {
				console.warn(`T2Addr FOUND! TRYING TO CHAT WITH: ${t2AddrValue}`);


				if(isValidStarkNetAddress(t2AddrValue)){
					console.log('This is a STARKNET address ==> well get the ETH address from the did')
				} else {
					console.log('not a valid STARKNET address')
					return
				}


				await chatWith(t2AddrValue)
				// openSearch()
			} else {
				console.warn('T2Addr parameter not found in the URL');
			}
			// -----------------------------------------

				await getChatAddresses()
				loadContacts()
				await listenAllNewAddresses()
				
				
			 
			
			}
			init()
			

 
 

function displayQR(data) {
    console.log('displayQR(data)')
            const qrCode = new QRCodeStyling({
                width: 500, height: 500, type: "png", data: data, image: `id5.svg`,
                dotsOptions: { color: "#1568B0", type: "extra-rounded" },
                backgroundOptions: { color: "var(--qrbackground)", },
                imageOptions: { crossOrigin: "anonymous", margin: 3 }
            });
            qrCode.append(document.getElementById("canvas"));
            // canvas.classList.add('animate')




        }

		function setAddress(userAddress) {
			console.log('setAddress()',userAddress)
			// https://192.168.43.129:4444/
			// var currentURL = window.location.href;
			// var currentURL = 'https://starkid.web.app/';
			// var baseUrl = window.location.protocol + '//' + window.location.host + '/';
			
			
			var baseUrl = 'https://192.168.43.129:4444' + '/';
			// var baseUrl = 'https://starkid.web.app' + '/';
			const parameters = { T2Addr: userAddress, };
			const urlParams = createURLParams(parameters);
			const url = `${baseUrl}?${urlParams}`;

			// 3- SHOW QR
			canvas.innerHTML = '';
			showqr(url);
			let shortAddr = userAddress.substring(0, 6) + "..." + userAddress.substring(38, 42);

			var preElement = document.getElementById('yourAddress');
			preElement.setAttribute('address', userAddress);

			yourAddress.innerHTML = `${shortAddr} <svg id='copyAddress' onclick="event.stopPropagation();copy2clipboard('${userAddress}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill='currentColor' d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"/></svg> <svg id='shareAddress' onclick="event.stopPropagation();copy2clipboard('${url}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><path fill='currentColor'  d="M352 224c53 0 96-43 96-96s-43-96-96-96s-96 43-96 96c0 4 .2 8 .7 11.9l-94.1 47C145.4 170.2 121.9 160 96 160c-53 0-96 43-96 96s43 96 96 96c25.9 0 49.4-10.2 66.6-26.9l94.1 47c-.5 3.9-.7 7.8-.7 11.9c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-25.9 0-49.4 10.2-66.6 26.9l-94.1-47c.5-3.9 .7-7.8 .7-11.9s-.2-8-.7-11.9l94.1-47C302.6 213.8 326.1 224 352 224z"/></svg>`;
			console.log(`Your address: ${userAddress} `)
		}


		/*********************************************************************************************
		.)  URL
		**********************************************************************************************/
		// Function to create URL parameters from an object
		function createURLParams(params) {
			console.log('createURLParams', params)

			const keys = Object.keys(params);
			const encodedParams = keys.map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`);
			return encodedParams.join('&');
		}

			/*********************************************************************************************
		.) QR SCAN
		**********************************************************************************************/
		async function scanAddress() {
			console.log('SCANNING FOR A NEW USER ADDRESS')
			var audioContext = new AudioContext();

			// open modal
			openModalId('#scanModal')
			document.getElementById('scanResult').innerHTML = ''
			setTimeout(() => {
				var videoElem = document.getElementById("qrScanVideo");
				window.qrScanner = new QrScanner(videoElem, result => qrscanned(result), {
					highlightScanRegion: true,
					highlightCodeOutline: true,
				});

				qrScanner.setInversionMode('invert');
				qrScanner.start();

			}, 1000);

		}

		async function qrscanned(result) {
			console.log('scanned decoded qr code:', result.data)
			x1 = result.data;
			document.getElementById('scanResult').innerHTML = ` <div class="success-message"> <svg viewBox="0 0 76 76" class="success-message__icon icon-checkmark"> <circle cx="38" cy="38" r="36"/> <path fill="none" stroke="#FFFFFF" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M17.7,40.9l10.9,10.9l28.7-28.7"/> </svg> <h1 class="success-message__title">SCANED!</h1> <div class="success-message__content"> <p>${result.data}</p> </div> </div> `
			qrScanner.stop();
			qrScanner.destroy();
			qrScanner = null;
			playBeep();
			await setTimeout(() => {
				closeModalId('#scanModal')
			}, 1500);
			console.log('KEEP DOING SOMETHING', result.data)

			// SEARCH FOR T2Addr
			const url = new URL(result.data);
			const urlParams = new URLSearchParams(url.search);
			const t2AddrValue = urlParams.get('T2Addr');
			if (t2AddrValue !== null) {
				console.log(`Value of T2Addr parameter: ${t2AddrValue}`);

				address2.value = t2AddrValue;
				Toast.fire({ icon: 'info', title: 'CHAT WITH:', text: t2AddrValue });

				// close nav
				plToggle()
				// NOW SETUP THE CHAT AND OPEN IT
				await chatWith(t2AddrValue)

				// const swiperEl = document.getElementById('troqContainer');
				// swiperEl.swiper.slideNext();

			} else {
				console.log('T2Addr parameter not found in the URL');
			}


		}




		async function selectChat(el) {
			const address = el.dataset.address;
			console.log('CLICKED CONTACT (selectChat()):', address);
			var imgElement = el.querySelector("img");
			let imgSrc = imgElement.getAttribute("src");
			console.log('imgSrc: ',imgSrc.length)
			// 1- close navbar
			plToggle()

			// 2- chat with address funciton 
			
			let currentChat = document.body.getAttribute('currentChat');
			console.warn('CURRENTCHAT', currentChat)
			
			// if(currentChat==address)?alreadyChatting==true
			let alreadyChatting = (currentChat === address) ? true : false;

			// INTENTO FIX DUPLICA Y MULTIPLICA MENSAJES
			if (alreadyChatting) {
				// Do something if alreadyChatting is true
				console.log('already chatting with this contact')
				openSearch()
			} else {
				// Do something else if alreadyChatting is false
				console.log('start chatting with new contact')
				await deleteChat()
				await chatWith(address,imgSrc)
				await updateBadge()

			}
		}


		document.getElementById("closeScanModal").onclick = () => {
			qrScanner.stop();
			closeModalId('#scanModal')
			qrScanner.destroy();
			qrScanner = null;

		}


		

		async function updateBadge() {
			// console.log('updateBadge()')
			var ulElement = document.getElementById('cwContacts');
			var newMessageElements = ulElement.getElementsByClassName('newmessage');
			var count = newMessageElements.length;
			if (count === 0) {
				// console.log('updateBadge(): No elements with class "newmessage" found.');
				document.getElementById('chatBadge').style.display = 'none'
				document.getElementById('chatBadge').innerText = ''
			} else {
				console.log('Number of elements with class "newmessage":', count);
				document.getElementById('chatBadge').style.display = 'inline'
				document.getElementById('chatBadge').innerText = `${count}`
			}

		}


		/*********************************************************************************************
		.) NEWQRCHAT
		**********************************************************************************************/
		async function createXMPTchat(){
            console.log('createXMPTchat()')

			// check if DID is needed or not

			let chatETHPrivKey = localStorage.getItem('chatETHPrivKey');
            if (!chatETHPrivKey) {
				// starknetPrivKey = stark.randomAddress();
				try { wallet = await ethers.Wallet.createRandom() }
				catch (error) { console.log(error.message);   }

                console.log('New CHAT ACCOUNT :\nprivateKey=', wallet.privateKey);
                localStorage.setItem('chatETHPrivKey', wallet.privateKey);
                console.log('chatETHPrivKey SAVED INTO LOCALSTORAGE');
            } else {
				console.log('chatETHPrivKey already exists in localStorage:', chatETHPrivKey);
				try { wallet = await new ethers.Wallet(chatETHPrivKey) }
				catch (error) { console.log(error.message);   }

            }
            console.log('<br>ETH private key:'+wallet.chatETHPrivKey)
			// window.wal =wallet;
            const starkxmtp = await Client.create(wallet)
            const conversations = starkxmtp.conversations
    
			// get eth address for chat
			 userAddress = wallet.address;
			console.log('Your chat Address (eth) : ',userAddress)

			window.starkxmtp = starkxmtp;// make GLOBAL
			window.chats= starkxmtp.conversations
			window.userAddress= userAddress

            return starkxmtp
        }

		async function  getChatAddresses(){
			const allConversations = await starkxmtp.conversations.list()
			console.log('YOU HAVE ', allConversations.length, "ADDRESSES AVAILABLE IN XMTP")

			const peerAddressesArray = [];

			allConversations.forEach(async (conversation, index) => {
				peerAddressesArray.push(conversation.peerAddress);
				console.warn('allConversations foerEach')
				// ADD ADDRESS TO AGENDA IN UI
						// Here

			})
			paa = peerAddressesArray;
			console.log('peerAddressesArray(paa) DECLARED!',peerAddressesArray)
			

		}
		
		async function chatWith(toAddr ,imgsrc) {
			console.log('chatWith()', toAddr)

			console.log('ESTABLISHING NEW CHAT WITH', toAddr)

			document.getElementById("chatBox").innerHTML='';//clear chat window
			console.log('clear chatBox window')

			// return 

		console.log(toAddr, userAddress)
		if (toAddr == userAddress) {
			console.log('CANCELING chatwith() because CANNOT WITH SELF ADDRESS')
			localStorage.removeItem('toAddress')// detele "TO" address from localStorage
			return
		}

		
		
		
		// return
		// GOT TO CHAT TAB
		console.log(' doing openSearch')
		openSearch()
		// const swiperEl = document.getElementById('troqContainer');
		// swiperEl.swiper.slideNext();
		// return
		
		
		// save "TO" to localwallet
		localStorage.setItem('toAddress', toAddr)
		
		// ---------
		// ERROR AQUI!!!!!!!!(ponerlo en addAddress())
		// checkear SI no esta ya en sus contactos

			// let contact = { address: toAddr, username: null, avatar: null, did: null }
			// SaveContactsToLocalStorage(contact)
			// ---------------
			loadContacts()
			updateBadge()

			// return


if (imgsrc != null){
	console.log('YES IMAGE SOURCE', imgsrc)

	 avatar = imgsrc;
} else {
	console.log('NO IMAGE SOURCE')
	 avatar = "./anonym.jpg"
}
// add address in UI
// let htmlData =  `<address>${toaddr}</address><br><p>no info available</p>`;
let htmlData = `<address>${toAddr} <svg id="" onclick="event.stopPropagation();customcopy2clipboard('${toAddr}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z" ></path></svg> </address><br><p>no info available</p>`;


let shortAddr = toAddr.substring(0, 6) + "..." + toAddr.substring(38, 42);

chatAddress.innerHTML = `<div class="">
	<img src='${avatar}' alt="avatar" class="rounded rounded-circle img-thumbnail" width='40px' id='avatarImage'  onclick="event.stopPropagation();openCard('${toAddr}','${avatar}')">
	<strong onclick="event.stopPropagation();openCard('${toAddr}','${avatar}')">${shortAddr}</strong>
	  </div>`;




// -------------------

actionButtons.innerHTML = `
<button type="button" id="" class="btn btn-approve" style="display: none;"
		onclick="event.stopPropagation(); openSend('${toAddr.toString()}')" disabled>
		<svg xmlns="http://www.w3.org/2000/svg" height="16" width="20" viewBox="0 0 512 512">
			<path fill="currentColor"
				d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480V396.4c0-4 1.5-7.8 4.2-10.7L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z" />
			</svg>
		SEND</button>

		<button type="button" id="" class="btn btn-reject" style="display: none;"
		onclick="event.stopPropagation(); openSend('${toAddr.toString()}')"  disabled>
		<svg height="16" width="20" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">
			<path fill="currentColor"
				d="m 506.43491,498.16358 c -7,10.1 -19.1,15.4 -31.2,13.5 l -416.000001,-64 c -9.7,-1.5 -18.2,-7.4 -23,-16 -4.8,-8.6 -5.4,-18.9 -1.6,-28 l 49.7,-119.6 -74.1,-68.5 c -9.70000029,-8.9 -12.9000003,-22.9 -8.1000003,-35.2 4.8,-12.3 16.7000003,-20.3 29.9000003,-20.3 h 83.600001 c 4,0 7.8,1.5 10.7,4.2 l 182.9,167.6 c 6.3,5.8 16,5.6 22,-0.4 6,-6 6.4,-15.7 0.7,-22 l -180.7,-203.4 44.2,-88.300001 c 5.3,-10.5999996 15.9,-17.39999965 27.7,-17.69999965 11.8,-0.3 22.8,5.90000005 28.7,16.09999965 l 256,448.000001 c 6.1,10.7 5.5,23.9 -1.4,34 z"
				id="path992" />
			</svg>
		RECEIVE</button>
	<button class="honorloanbutton btn btn-secondary" onclick="sendHonorloanRequest(${toAddr.toString()})"
		style='display:none'>Loan
		<svg xmlns="http://www.w3.org/2000/svg" height="16" width="20" viewBox="0 0 640 512" style=" fill: #7cfc00; ">
			<path
				d="M80 104c0-22.1-17.9-40-40-40S0 81.9 0 104v56 64V325.5c0 25.5 10.1 49.9 28.1 67.9L128 493.3c12 12 28.3 18.7 45.3 18.7H240c26.5 0 48-21.5 48-48V385.1c0-29.7-11.8-58.2-32.8-79.2l-25.3-25.3 0 0-15.2-15.2-32-32c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l32 32 15.2 15.2c11 11 9.2 29.2-3.7 37.8c-9.7 6.5-22.7 5.2-31-3.1L98.7 309.5c-12-12-18.7-28.3-18.7-45.3V224 144 104zm480 0v40 80 40.2c0 17-6.7 33.3-18.7 45.3l-51.1 51.1c-8.3 8.3-21.3 9.6-31 3.1c-12.9-8.6-14.7-26.9-3.7-37.8l15.2-15.2 32-32c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-32 32-15.2 15.2 0 0-25.3 25.3c-21 21-32.8 49.5-32.8 79.2V464c0 26.5 21.5 48 48 48h66.7c17 0 33.3-6.7 45.3-18.7l99.9-99.9c18-18 28.1-42.4 28.1-67.9V224 160 104c0-22.1-17.9-40-40-40s-40 17.9-40 40z">
			</path>
		</svg> 
	</button>

	`
	
	// <button type="button" id="closeChat" class="btn btn-reject" style="display: inline;"
	// 	onclick="event.stopPropagation();deleteChat((this.parentElement))">
	// 	<svg class='uiicon' height="1em" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
	// 		<path
	// 			d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z" />
	// 		</svg>
	// </button>

	// FIX HERE. AWAIT TO CONVERSATION TO BE AVAILABLE
// // ACTIVATE CHAT BUTTONS
// document.getElementById('chatTextInput').disabled = false;
// document.getElementById('send-button').disabled = false;

// // FOCUS ON INPUT
// document.getElementById('chatTextInput').focus();

// ------------------------------------
// AVOID REOPENING COMS WITH ADDRESESS
// SACAR/ si lo saco falla...
const allConversations = await starkxmtp.conversations.list()
console.log('available addresses:', allConversations.length)
const customAddressToCheck = toAddr; // Replace this with the address you want to check
let addressExists = false;
for (const conversation of allConversations) {
	if (conversation.peerAddress === customAddressToCheck) {
		addressExists = true;
		cc = conversation
		// let history = conversation.messages()
		// console.log('history:', history)
		// return conversation
		break; // Exit the loop early if the address is found
	}
}

if (addressExists) {
	console.warn(`YOU DO HAVE A CHAT HISTORY WITH ${customAddressToCheck} `);
	console.log('USER: ', userAddress)
	let h = await cc.messages()

	// CREATE THIS FUNCTON ==> loadChatHistory(h)
	for (let i = 0; i < h.length; i++) {
		// console.log('recipient address: ', h[i].recipientAddress)

		if (h[i].senderAddress === userAddress) {
			// console.log('YOU')
			let timestamp = simplifyDate(h[i].sent)
			document.getElementById('chatBox').innerHTML += `<div><strong class='who'>You:</strong> ${h[i].content}<span class="timestamp">  ${timestamp} &check; </span></div>`;


		} else {
			// console.log('NOT YOU')
			let timestamp = simplifyDate(h[i].sent)
			let shortAddr = h[i].senderAddress.substring(38, 42);

			document.getElementById('chatBox').innerHTML += `<div><strong class='who notyou'>${shortAddr}:</strong> ${h[i].content}<span class="timestamp">  ${timestamp} &check; </span></div>`;
		}

	}


	console.log('history:', history)
} else {
	console.warn(`YOU DONT HAVE A CHAT HISTORY WITH ${customAddressToCheck} `);

}
// FIN AVOID REOPENING COMS WITH ADDRESESS
// ------------------------------------

// CREATE CHAT (client was already created)
conversation = await starkxmtp.conversations.newConversation(toAddr)
console.log('conversation:', conversation)
console.warn('------- READY TO CHAT ----------');

// ADD ATTRIBUTE TO BODY(fix dup messg)
document.body.setAttribute('currentChat', toAddr);

	// ACTIVATE CHAT BUTTONS
	document.getElementById('chatTextInput').disabled = false;
document.getElementById('send-button').disabled = false;

// FOCUS ON INPUT
document.getElementById('chatTextInput').focus();
	// -----------


var chatBox = document.getElementById("chatBox");
let shortTo = toAddr.substring(38, 42);

// Listen for new messages in the conversation
for await (const message of await conversation.streamMessages()) {
	const now = new Date();
	const hours = now.getHours().toString().padStart(2, '0'); // Ensure two-digit format
	const minutes = now.getMinutes().toString().padStart(2, '0'); // Ensure two-digit format
	const timestamp = `${hours}:${minutes}`;
	console.log('logMSG:', message)
	let preferedWallet = localStorage.getItem('preferedWallet');
	if (!preferedWallet) { console.log('NO PREFERED WALLET SET') }
	if (preferedWallet) { const values = preferedWallet.split(',').map(item => item.trim()); userAddress = values[1]; }
	if (message.senderAddress === userAddress) {
		console.log('YOU')
		chatBox.innerHTML += `<div><strong class='who'>You:</strong> ${message.content}<span class="timestamp">  ${timestamp} &check; </span></div>`;
	}
	if (message.senderAddress == toAddr) {
		console.log('OTHER', shortTo)
		mm = message;
		// let timestamp = message
		// chatBox.innerHTML += `<div><strong class='who'>${shortTo}:</strong> ${message.content} </div>`;
		document.getElementById('chatBox').innerHTML += `<div><strong class='who notyou'>${shortTo}:</strong> ${message.content}<span class="timestamp">  ${timestamp} &check; </span></div>`;


	}
	// if (message.contentType.sameAs(ContentTypeMultiplyNumber)) {
	// 	return message.content; // 21
	// }
	console.log(`[${message.senderAddress}]: ${message.content}`)
	chatBox.scrollTop = chatBox.scrollHeight;

}
}




		/*********************************************************************************************
		.) CONTACTS MANAGEMENT
		**********************************************************************************************/


		async function addUnknownContact(addr, msg) {
			console.log('addUnknownContact()', addr, msg)

			// add unknown contact to  localstorage and check each time against the list if we add it or not into the contacts tab
			let shortAddr = addr.substring(0, 6) + "..." + addr.substring(38, 42);
			let shortMsg = msg.substring(0, 16);


			let unknownContacts = JSON.parse(localStorage.getItem('unknowncontacts')) || [];
			a = addr
			var index = unknownContacts.findIndex(existingUnknownContacts => existingUnknownContacts === addr);

			if (index === -1) {
				console.log('PUSH UnknownContact to localstorage')
				unknownContacts.push(addr);

				document.getElementById('cwContacts').innerHTML += `
					<li data-address="${addr}"  id="${addr}" class='newmessage'> 
						<a onclick="event.stopPropagation();selectChat((this.parentElement))" >  
							<img src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
								<span>${shortMsg} <span>
									
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"width="18" height="16" >
										<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"/></svg>
										
										
										</a> 
										</li> `
										// <i class="fa-solid fa-trash"></i>

			} else {
				console.log('OVERWRITE ALREADY EXISTENT  UnknownContact!.');

				// Search for the element with the specified ID
				var elementToModify = document.getElementById(addr);

				// Check if the element exists
				if (elementToModify) {
					// Add a new class to the element
					elementToModify.classList.add('newmessage');
					elementToModify.querySelector("span").innerText = shortMsg

				} else {
					// If the element with the specified ID is not found, you may want to handle that case
					console.warn("Element with ID '" + addr + "' not found");
					document.getElementById('cwContacts').innerHTML += ` 
					<li data-address="${addr}" id="${addr}"  class='newmessage'> 
					<a onclick="event.stopPropagation();selectChat((this.parentElement))" >  
						<img src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
						<span>${shortMsg} <span>
							</a> </li> `
							// <i class="fa-solid fa-trash"></i>
				}


			}

			localStorage.setItem('unknowncontacts', JSON.stringify(unknownContacts));

		}

		async function addknownContact(addr, msg) {
			console.log('addknownContact()', addr, msg)

			let shortAddr = addr.substring(0, 6) + "..." + addr.substring(38, 42);
			let shortMsg = msg.substring(0, 16);
			var elementToModify = document.getElementById(addr);
			if (elementToModify) {
				elementToModify.classList.add('newmessage');
				elementToModify.querySelector("span").innerText = shortMsg
			}

		}



async function loadContacts() {
			console.log('loadContacts()')
			let contct = document.getElementById('cwContacts')
			contct.innerHTML = ''
			let cwContacts = JSON.parse(window.localStorage.getItem('contacts'));
			if (cwContacts) {
				console.log('YOU HAVE', cwContacts.length, 'CONTACTS in LOCALSTORAGE')

			// Create an array to store promises for asynchronous tasks
			const promises = [];

			cwContacts.forEach((el, index) => {
				const isAddressInArray = paa.includes(el.address);// paa?
				console.log('paa?:' ,paa)

				// is in your contacts or not?
				if (isAddressInArray) {
					console.log(`Contact ${index} IS in your contacts \u2714 ${el.address}`);
				} else {
					console.log(`This address IS NOT in your contacts \u2718 ${el.address}`);
				}

				// is username set?
				if (el.username || null) {
					console.log('username is not null');
					contactInfo = `<span>${el.username} <span>`;
				} else {
					console.log('username is null');
					let shortAddr = el.address.substring(0, 6) + "..." + el.address.substring(38, 42);
					contactInfo = `<span>${shortAddr} <span>`;
				}

				// let did = `did:ethr:${el.address}`;
				let did = `did:starknet:${el.address}`;

				// Add each asynchronous operation to the promises array
				promises.push(
					new Promise((resolve, reject) => {
						readDIDRecord(did)
							.then(didresult => {
								if (didresult.data != null) {
									console.log(did + ' HAS A RECORD!!!');
									let avtr = didresult.data.avatar;
									let avatar = JSON.parse(avtr);
									document.getElementById(did).src = avatar;
								} else {
									console.log(did + ' DOESN\'T HAVE A RECORD :(');
								}
								resolve(); // Resolve the promise once the operation is done
							})
							.catch(error => {
								console.warn('Warn on DID record:', error);
								reject(error); // Reject the promise if an error occurs
							});
					})
				);

    contct.innerHTML += `<li data-address="${el.address}" id="${el.address}" class=''> 
                            <a onclick="event.stopPropagation();selectChat((this.parentElement))">  
                                <img id ="${did}" src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
                                    ${contactInfo} 
									<svg onclick="event.stopPropagation();editContact('${el.address}')" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="20" height="25" class='right'>
										<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"/>
										</svg>
										</a> 
										</li>`;
										// <i class="fa-solid fa-trash"></i>
});

// Execute all promises concurrently
Promise.all(promises)
    .then(() => {
        console.log('All DID record processing completed.');
    })
    .catch(error => {
        console.error('Error while processing DID records:', error);
    });


			}

		}// fin loadContacts





		/*********************************************************************************************
		.) OLD QRCHAT
		**********************************************************************************************/
		async function xmtp(wallet) {

		let to = localStorage.getItem('toAddress')
		if (!to) {
			console.log('NO "TO" ADDRESS')
			const xmtp = await Client.create(wallet)
			console.log('XMTP CLIENT CREATED: ', xmtp)
			// xm = xmtp;
			return
		}
		else {
			console.log('YES "TO" ADDRESS')
			const xmtp = await Client.create(wallet)
			localStorage.setItem('chatxmtp', xmtp)
			// await chatWith(to)
		}



}

document.getElementById("chatTextInput").addEventListener("keydown", function (event) {
if (event.key === "Enter") {
	var userInput = this.value.trim(); // Trim whitespace from input
	if (userInput !== "") {
		console.log("User input:", userInput);
		// Do something with the user input here
		sendMessage();
	}
	// var userInput = this.value;
	// console.log("User input:", userInput);
	// // Do something with the user input here
	// sendMessage();
	event.preventDefault(); // Prevents the default behavior of the Enter key (submitting a form)
}
});

document.getElementById("chatTextInput").addEventListener("blur", function () {
var userInput = this.value.trim(); // Trim whitespace from input
if (userInput !== "") {
	console.log("User input:", userInput);
	// Do something with the user input here
	sendMessage();
}
// var userInput = this.value;
// console.log("User input:", userInput);
// // Do something with the user input here
// sendMessage();
});

async function sendMessage() {
console.log('sendMessage()')
var userInput = document.getElementById("chatTextInput").value;
var chatBox = document.getElementById("chatBox");
var message = document.createElement("div");

if (userInput.trim() !== "") {
	// The input value is not empty
	console.log("Input is not empty");
} else {
	// The input value is empty
	console.log("Input is empty");
	return
}


// direct message?
// message.classList.add("message");
// message.innerHTML = `<strong>You:</strong> ${userInput}`;
// chatBox.appendChild(message);



document.getElementById("chatTextInput").value = "";
chatBox.scrollTop = chatBox.scrollHeight;
if(conversation){
	console.log('CONVESATION AVAILABLE NOW: ', conversation)
} else {
	console.log('NO AVAILABLE CONVESATION: ')
	
}
await conversation.send(`${userInput}`);// Send a message

}




function setToAddress() {
var toaddr = document.getElementById("toAddr").value;

console.log('setting TO adddress: ', toaddr)

// if (ethers.utils.isAddress(toaddr)) {
if (ethers.isAddress(toaddr)) {
	console.log('VALID ADDRESS')
	document.getElementById("invalid-address-alert").style.display = "none";
	localStorage.setItem('toAddress', toaddr)
	document.getElementById('results').innerHTML += `<br>TO address: ${toaddr}  <button class="btn btn-secondary" onclick="clearChat()">Clear</button>`


} else {
	console.log('INVALID ADDRESS')
	document.getElementById("invalid-address-alert").style.display = "block";

}


}


// function share(text) {
// console.log('share()', text)


// let textLink = `<a href="${text}">${text}</a>`;

// if (window.clipboardData && window.clipboardData.setData) {
// 	console.log('Copied to Clipboard', text, "success");

// 	document.getElementById('innerAddress').innerHTML = '<path fill="currentColor"  d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/><p>Copied!</p>'

// 	setTimeout(() => {
// 		document.getElementById('innerAddress').innerHTML = ' <path fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"></path>'
// 	}, 1000);
// 	return window.clipboardData.setData("Text", text);
// }
// else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
// 	var textarea = document.createElement("textarea");
// 	textarea.textContent = text;
// 	textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in Microsoft Edge.
// 	document.body.appendChild(textarea);
// 	textarea.select();
// 	try {
// 		console.log('Copied to Clipboard', text, "success");
// 		document.getElementById('innerAddress').innerHTML = '<path fill="currentColor"  d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/><p>Copied!</p>'

// 		setTimeout(() => {
// 			document.getElementById('innerAddress').innerHTML = ' <path fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"></path>'
// 		}, 1000);

// 		return document.execCommand("copy");  // Security exception may be thrown by some browsers.
// 	}
// 	catch (ex) {
// 		console.warn("Copy to clipboard failed.", ex);
// 		return prompt("Copy to clipboard: Ctrl+C, Enter", text);
// 	}
// 	finally {
// 		document.body.removeChild(textarea);
// 	}
// }


// }

function customcopy2clipboard(text) {
console.log('customcopy2clipboard()', text)

let textLink = `<a href="${text}">${text}</a>`;

if (window.clipboardData && window.clipboardData.setData) {
	console.log('Copied to Clipboard', text, "success");

	document.getElementById('innerAddress').innerHTML = '<path fill="currentColor"  d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/><p>Copied!</p>'

	setTimeout(() => {
		document.getElementById('innerAddress').innerHTML = ' <path fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"></path>'
	}, 1000);
	return window.clipboardData.setData("Text", text);
}
else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
	var textarea = document.createElement("textarea");
	textarea.textContent = text;
	textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in Microsoft Edge.
	document.body.appendChild(textarea);
	textarea.select();
	try {
		console.log('Copied to Clipboard', text, "success");
		document.getElementById('innerAddress').innerHTML = '<path fill="currentColor"  d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/><p>Copied!</p>'

		setTimeout(() => {
			document.getElementById('innerAddress').innerHTML = ' <path fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"></path>'
		}, 1000);

		return document.execCommand("copy");  // Security exception may be thrown by some browsers.
	}
	catch (ex) {
		console.warn("Copy to clipboard failed.", ex);
		return prompt("Copy to clipboard: Ctrl+C, Enter", text);
	}
	finally {
		document.body.removeChild(textarea);
	}
}


}


async function addUser() {
console.log('ADDING NEW USER ADDRESS')
}



// EDIT CONTACT
// el.address
async function editContact(addr) {
console.log('editContact()')
const inputValue = '';

const { value: userName } = await Swal.fire({
	title: "Enter a name for this address",
	input: "text",
	inputLabel: "contact name",
	inputValue,
	showCancelButton: true,
	inputValidator: (value) => {
		if (!value) {
			return "You need to write something!";
		}
	}
});
if (userName) {

	let contact = { address: addr, username: userName, avatar: null, did: null }
	SaveContactsToLocalStorage(contact)
	loadContacts()
	console.log('Contact Updated', userName)
	// Swal.fire(`Your IP address is ${userName}`);
}


}


function updateContactList(contact) {
// Retrieve existing contacts from localStorage
var contacts = JSON.parse(localStorage.getItem('contacts')) || [];

// Check if the contact already exists in the list
var existingContactIndex = contacts.findIndex(function (existingContact) {
	return existingContact.address === contact.address;
});

if (existingContactIndex !== -1) {
	// If the contact exists, update its details
	contacts[existingContactIndex] = contact;
} else {
	// If the contact doesn't exist, add it to the list
	contacts.push(contact);
}

// Save the updated contact list back to localStorage
localStorage.setItem('contacts', JSON.stringify(contacts));
}


// SAVE CONTACTS
function SaveContactsToLocalStorage(contact) {
var a = [];
a = JSON.parse(localStorage.getItem('contacts')) || [];

// Check if the address already exists
var isDuplicate = a.some(existingContact => existingContact.address === contact.address);

if (!isDuplicate) {
	a.push(contact);
	localStorage.setItem('contacts', JSON.stringify(a));
}
else {
	// console.log('Address already exists in your contacts, skipping save.');
	console.log('Address already exists in your contacts, UPDATING.');
	updateContactList(contact)
}
}




async function chatHistory(addr) {

let conversation = await starkxmtp.conversations.newConversation(addr)
const messages = await conversation.messages()

for (const message of messages) {
	console.log(message.content);
}
}



function simplifyDate(dateString) {
// Create a new Date object
var date = new Date(dateString);

// Get current date
var currentDate = new Date();

// Define months array for formatting
var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

// Format the date
var formattedDate;
if (date.toDateString() === currentDate.toDateString()) {
	// If the date is today, display only time
	var hours = date.getHours();
	var minutes = date.getMinutes().toString().padStart(2, '0');
	var seconds = date.getSeconds().toString().padStart(2, '0');
	formattedDate = hours + ':' + minutes + ':' + seconds;
} else {
	// If the date is not today, display day, month, and year
	formattedDate = date.getDate() + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
}

return formattedDate;
}

// // Example usage:
// var dateString = "Wed May 01 2024 01:17:42 GMT-0300 (Argentina Standard Time)";
// console.log(simplifyDate(dateString)); // Output: "01 May 2024"


function openCard(toAddr ,avtr) {
console.log(' openCard()', toAddr, avtr)
let a= toAddr;
let b= avtr;
console.log('OPENCARD DATA a:',a)
console.log('OPENCARD DATA b:',b)
let avatar = "./anonym.jpg"
let htmlData = `<address>${toAddr} <svg id="innerAddress" onclick="event.stopPropagation();customcopy2clipboard('${toAddr}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z" ></path></svg> </address><br><p>no more info available</p>`;
let shortAddr = toAddr.substring(0, 6) + "..." + toAddr.substring(38, 42);
// -----------

	Swal.fire({ imageUrl: avtr, 
			imageWidth: 300, 
			imageHeight: 300, 
			imageAlt: 'Avatar image', 
			html: htmlData,
			showDenyButton: true,
			showCancelButton: false,
			showCloseButton: true, 
			confirmButtonText: 'trust',
			denyButtonText: 'Block',
			customClass: {
				actions: 'my-actions',
				cancelButton: 'order-1 right-gap',
				confirmButton: 'order-2',
				denyButton: 'order-3',
},
}).then((result) => {
if (result.isConfirmed) {
	Swal.fire('Saved into your trusted contacts!', '', 'success')
} else if (result.isDenied) {
	Swal.fire('Address blocked', '', 'info')
}
})
// ---
}


// async function chatWith(toAddr ) {
async function chatWithOld(toAddr ,imgsrc) {
console.log('chatWith()', toAddr)

console.log('ESTABLISHING NEW CHAT WITH', toAddr)

document.getElementById("chatBox").innerHTML='';//clear chat window
console.log('clear chatBox window')

let preferedWallet = localStorage.getItem('preferedWallet');
if (!preferedWallet) { console.log('NO PREFERED WALLET SET') }
if (preferedWallet) {
	const values = preferedWallet.split(',').map(item => item.trim());
	walletChoice = values[0];
	// userAddress = values[1];
	// userAddress = ethers.utils.getAddress(values[1]);
	userAddress = ethers.getAddress(values[1]);
	console.log('USER ADDRESS IN CHAT WITH', userAddress)
}

console.log(toAddr, userAddress)
if (toAddr == userAddress) {
	console.log('CANCELING chatwith() because CANNOT WITH SELF ADDRESS')
	localStorage.removeItem('toAddress')// detele "TO" address from localStorage
	return
}

// GOT TO CHAT TAB
openSearch()
// const swiperEl = document.getElementById('troqContainer');
// swiperEl.swiper.slideNext();


// save "TO" to localwallet
localStorage.setItem('toAddress', toAddr)

// ---------
// ERROR AQUI
let contact = { address: toAddr, username: null, avatar: null, did: null }
SaveContactsToLocalStorage(contact)
// ---------------
loadContacts()
updateBadge()


if (imgsrc != null){
	console.log('YES IMAGE SOURCE', imgsrc)

	 avatar = imgsrc;
} else {
	console.log('NO IMAGE SOURCE')
	 avatar = "./anonym.jpg"
}
// add address in UI
// let htmlData =  `<address>${toaddr}</address><br><p>no info available</p>`;
let htmlData = `<address>${toAddr} <svg id="" onclick="event.stopPropagation();customcopy2clipboard('${toAddr}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z" ></path></svg> </address><br><p>no info available</p>`;


let shortAddr = toAddr.substring(0, 6) + "..." + toAddr.substring(38, 42);

chatAddress.innerHTML = `<div class="">
	<img src='${avatar}' alt="avatar" class="rounded rounded-circle img-thumbnail" width='40px' id='avatarImage'  onclick="event.stopPropagation();openCard('${toAddr}','${avatar}')">
	<strong onclick="event.stopPropagation();openCard('${toAddr}','${avatar}')">${shortAddr}</strong>
	  </div>`;




// -------------------

actionButtons.innerHTML = `
<button type="button" id="" class="btn btn-approve" style="display: inline;"
		onclick="event.stopPropagation(); openSend('${toAddr.toString()}')">
		<svg xmlns="http://www.w3.org/2000/svg" height="16" width="20" viewBox="0 0 512 512">
			<path
				d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480V396.4c0-4 1.5-7.8 4.2-10.7L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z" />
			</svg>
		SEND</button>

		<button type="button" id="" class="btn btn-reject" style="display: inline;"
		onclick="event.stopPropagation(); openSend('${toAddr.toString()}')">
		<svg height="16" width="20" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">
			<path
				d="m 506.43491,498.16358 c -7,10.1 -19.1,15.4 -31.2,13.5 l -416.000001,-64 c -9.7,-1.5 -18.2,-7.4 -23,-16 -4.8,-8.6 -5.4,-18.9 -1.6,-28 l 49.7,-119.6 -74.1,-68.5 c -9.70000029,-8.9 -12.9000003,-22.9 -8.1000003,-35.2 4.8,-12.3 16.7000003,-20.3 29.9000003,-20.3 h 83.600001 c 4,0 7.8,1.5 10.7,4.2 l 182.9,167.6 c 6.3,5.8 16,5.6 22,-0.4 6,-6 6.4,-15.7 0.7,-22 l -180.7,-203.4 44.2,-88.300001 c 5.3,-10.5999996 15.9,-17.39999965 27.7,-17.69999965 11.8,-0.3 22.8,5.90000005 28.7,16.09999965 l 256,448.000001 c 6.1,10.7 5.5,23.9 -1.4,34 z"
				id="path992" />
			</svg>
		RECEIVE</button>
	<button class="honorloanbutton btn btn-secondary" onclick="sendHonorloanRequest(${toAddr.toString()})"
		style='display:none'>Loan
		<svg xmlns="http://www.w3.org/2000/svg" height="16" width="20" viewBox="0 0 640 512" style=" fill: #7cfc00; ">
			<path
				d="M80 104c0-22.1-17.9-40-40-40S0 81.9 0 104v56 64V325.5c0 25.5 10.1 49.9 28.1 67.9L128 493.3c12 12 28.3 18.7 45.3 18.7H240c26.5 0 48-21.5 48-48V385.1c0-29.7-11.8-58.2-32.8-79.2l-25.3-25.3 0 0-15.2-15.2-32-32c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l32 32 15.2 15.2c11 11 9.2 29.2-3.7 37.8c-9.7 6.5-22.7 5.2-31-3.1L98.7 309.5c-12-12-18.7-28.3-18.7-45.3V224 144 104zm480 0v40 80 40.2c0 17-6.7 33.3-18.7 45.3l-51.1 51.1c-8.3 8.3-21.3 9.6-31 3.1c-12.9-8.6-14.7-26.9-3.7-37.8l15.2-15.2 32-32c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-32 32-15.2 15.2 0 0-25.3 25.3c-21 21-32.8 49.5-32.8 79.2V464c0 26.5 21.5 48 48 48h66.7c17 0 33.3-6.7 45.3-18.7l99.9-99.9c18-18 28.1-42.4 28.1-67.9V224 160 104c0-22.1-17.9-40-40-40s-40 17.9-40 40z">
			</path>
		</svg> 
	</button>

	`
	// <button type="button" id="closeChat" class="btn btn-reject" style="display: inline;"
	// 	onclick="event.stopPropagation();deleteChat((this.parentElement))">
	// 	<svg class='uiicon' height="1em" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
	// 		<path
	// 			d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z" />
	// 		</svg>
	// </button>


	// FIX HERE. AWAIT TO CONVERSATION TO BE AVAILABLE
// // ACTIVATE CHAT BUTTONS
// document.getElementById('chatTextInput').disabled = false;
// document.getElementById('send-button').disabled = false;

// // FOCUS ON INPUT
// document.getElementById('chatTextInput').focus();

// ------------------------------------
// AVOID REOPENING COMS WITH ADDRESESS
// SACAR/ si lo saco falla...
const allConversations = await starkxmtp.conversations.list()
console.log('available addresses:', allConversations.length)
const customAddressToCheck = toAddr; // Replace this with the address you want to check
let addressExists = false;
for (const conversation of allConversations) {
	if (conversation.peerAddress === customAddressToCheck) {
		addressExists = true;
		cc = conversation
		// let history = conversation.messages()
		// console.log('history:', history)
		// return conversation
		break; // Exit the loop early if the address is found
	}
}

if (addressExists) {
	console.warn(`YOU DO HAVE A CHAT HISTORY WITH ${customAddressToCheck} `);
	console.log('USER: ', userAddress)
	let h = await cc.messages()

	// CREATE THIS FUNCTON ==> loadChatHistory(h)
	for (let i = 0; i < h.length; i++) {
		// console.log('recipient address: ', h[i].recipientAddress)

		if (h[i].senderAddress === userAddress) {
			// console.log('YOU')
			let timestamp = simplifyDate(h[i].sent)
			document.getElementById('chatBox').innerHTML += `<div><strong class='who'>You:</strong> ${h[i].content}<span class="timestamp">  ${timestamp} &check; </span></div>`;


		} else {
			// console.log('NOT YOU')
			let timestamp = simplifyDate(h[i].sent)
			let shortAddr = h[i].senderAddress.substring(38, 42);

			document.getElementById('chatBox').innerHTML += `<div><strong class='who notyou'>${shortAddr}:</strong> ${h[i].content}<span class="timestamp">  ${timestamp} &check; </span></div>`;
		}

	}


	console.log('history:', history)
} else {
	console.warn(`YOU DONT HAVE A CHAT HISTORY WITH ${customAddressToCheck} `);

}
// FIN AVOID REOPENING COMS WITH ADDRESESS
// ------------------------------------

// CREATE CHAT (client was already created)
conversation = await starkxmtp.conversations.newConversation(toAddr)
console.log('conversation:', conversation)
console.warn('------- READY TO CHAT ----------');

// ADD ATTRIBUTE TO BODY(fix dup messg)
document.body.setAttribute('currentChat', toAddr);

	// ACTIVATE CHAT BUTTONS
	document.getElementById('chatTextInput').disabled = false;
document.getElementById('send-button').disabled = false;

// FOCUS ON INPUT
document.getElementById('chatTextInput').focus();
	// -----------


var chatBox = document.getElementById("chatBox");
let shortTo = toAddr.substring(38, 42);

// Listen for new messages in the conversation
for await (const message of await conversation.streamMessages()) {
	const now = new Date();
	const hours = now.getHours().toString().padStart(2, '0'); // Ensure two-digit format
	const minutes = now.getMinutes().toString().padStart(2, '0'); // Ensure two-digit format
	const timestamp = `${hours}:${minutes}`;
	console.log('logMSG:', message)
	let preferedWallet = localStorage.getItem('preferedWallet');
	if (!preferedWallet) { console.log('NO PREFERED WALLET SET') }
	if (preferedWallet) { const values = preferedWallet.split(',').map(item => item.trim()); userAddress = values[1]; }
	if (message.senderAddress === userAddress) {
		console.log('YOU')
		chatBox.innerHTML += `<div><strong class='who'>You:</strong> ${message.content}<span class="timestamp">  ${timestamp} &check; </span></div>`;
	}
	if (message.senderAddress == toAddr) {
		console.log('OTHER', shortTo)
		mm = message;
		// let timestamp = message
		// chatBox.innerHTML += `<div><strong class='who'>${shortTo}:</strong> ${message.content} </div>`;
		document.getElementById('chatBox').innerHTML += `<div><strong class='who notyou'>${shortTo}:</strong> ${message.content}<span class="timestamp">  ${timestamp} &check; </span></div>`;


	}
	// if (message.contentType.sameAs(ContentTypeMultiplyNumber)) {
	// 	return message.content; // 21
	// }
	console.log(`[${message.senderAddress}]: ${message.content}`)
	chatBox.scrollTop = chatBox.scrollHeight;

}
}

var cwContacts = document.getElementById('cwContacts');

cwContacts.addEventListener('contextmenu', function (e) {
e.preventDefault(); // Prevent the default context menu

// Check if the right-click was on an li element
if (e.target.tagName === 'LI') {
	// Increment your counter or perform any other action
	console.log('Right-clicked on li element');
}
});

async function initChatClient(wallet) {
console.log('initChatClient()')
// Create the client with your wallet. This will connect to the XMTP development network by default
// const xmtp = await Client.create(wallet)
const xmtp = await Client.create(wallet, { env: "dev", })

// REGISTER CODECS

// Support on-chain transaction references in your app built with XMTP
// https://xmtp.org/docs/build/messages/transaction
xmtp.registerCodec(new TransactionReferenceCodec());



// const starkxmtp = await Client.create(wallet)
starkxmtp = xmtp;//make global
console.warn('starkxmtp SET TO GLOBAL')
// Listen for new conversations
const stream = await starkxmtp.conversations.stream()
console.log('STREAM:', stream)

//  registerCodecs(xmtp)
await listExistingConversations(starkxmtp)
return xmtp
}


// -----------------
// LISTEN TO ALLLLLL INCOMING!
async function listenAllNewAddresses() {
console.log('listenAllNewAddresses() - *B')

for await (const message of await starkxmtp.conversations.streamAllMessages()) {
	if (message.senderAddress === starkxmtp.address) {// This message was sent from me
		continue
	}

	document.getElementById('chatBadge').style.display = 'inline'
	document.getElementById('chatBadge').innerText = '!'
	console.log(`New message from ${message.senderAddress}: ${message.content}`)
	
	try{
		await playButtonClickSound()
	}
	catch (error) {
			console.error('Error getting did:', error.message);
		}
	// peerGasPaymentAccept
	if (message.content.includes("peerGasPaymentAccepted0x21")) {
		Swal.fire({ title: "Your gas is being payed by your peer!", width: 600, padding: "3em", background: "lightgreen ", backdrop: ` rgba(0,123,123,0.4) url("./nyan-cat.gif") left top no-repeat ` });

		setTimeout(() => {
			Swal.fire("Done!", "", "success");
			closeModalId('#walletSend')
		}, 3000);
	}

	// peerGasPaymentRequest
	if (message.content.includes("peerGasPaymentReques0x20")) {
		console.log("You received a peerGasPamentRequest from: ", message.senderAddress);
		conversation = await starkxmtp.conversations.newConversation(message.senderAddress)
		Swal.fire({
			title: "Do you have some gas?",
			text: "your peer is asking you to pay for the gas",
			icon: "question",
			showDenyButton: true,
			showCancelButton: true,
			confirmButtonText: ` <i class="fa fa-thumbs-up"></i> Yes! `,
			denyButtonText: ` <i class="fa fa-thumbs-down"></i>  Decline`,
			cancelButtonText: `  Ignore`
		}).then(async (result) => {
			if (result.isConfirmed) {
				Swal.fire({ title: `You are paying for the gas for ${message.senderAddress} (it is being automaticalle discounted from your gas balance)!`, width: 600, padding: "3em", color: "#716add", background: "#fff ", backdrop: ` rgba(0,0,123,0.4) url("./nyan-cat.gif") left top no-repeat ` });
				await conversation.send(`user accepted to pay for the gas! <pre style="display: none;">peerGasPaymentAccepted0x21</pre>`);// Send a message
				setTimeout(() => {
					Swal.fire("Gas payed!(FAKE...)", "", "success");
				}, 5000);
			} else if (result.isDenied) {
				Swal.fire("You decline to pay for the gas", "", "info");
			}
		});
	}
	else { console.log("(DIRTYFIX)The message does not contain the text: 'can you pay for the gas?'"); }

	// CHECK IF ADDRESS IS ALREADY IN YOUR CONTACTS (LOCALSTORAGE)
	var storedContacts = [];
	let storedContacts = JSON.parse(localStorage.getItem('contacts')) || [];

	// Find index of the message with the same address
	var index = storedContacts.findIndex(existingContact => existingContact.address === message.senderAddress);

	if (index === -1) {
		console.log('THIS ADDRESS IS NOT IN YOUR CONTACT LIST.. Adding new UNKNOWN (and unvalidated) contact.');
		addUnknownContact(message.senderAddress, message.content)

	} 
	else {
		console.log('YES: THIS ADDRES IS IN YOUR CONTACT LIST')
		console.log('OVERWRITE last msg, INDEX:', storedContacts[index], index)
		addknownContact(message.senderAddress, message.content)

	}

	updateBadge()
}
}


 


async function listExistingConversations(xmtp) {
console.warn('listExistingConversations()')
// List existing conversations
const allConversations = await xmtp.conversations.list()
console.log('AVAILABLE CHATS:', allConversations.length)
const peerAddressesArray = [];

allConversations.forEach(async (conversation, index) => {
	peerAddressesArray.push(conversation.peerAddress);
	
	// QUITAR SOLO PARA PRUEBA
	console.warn('listenNewChats() OMITED HERE')
	// await listenNewChats(conversation.peerAddress)
})
paa = peerAddressesArray;
console.log('paa DECLARED!')

}



async function deleteChat() {
console.log('DELETING CHAT')
// clear URL
removeParam('T2Addr');
// remove body's ATTRIBUTE
	document.body.removeAttribute('currentChat');

// remove "TO" address from localStorage
localStorage.removeItem('toAddress')

// GOT TO CHAT TAB
openSearch()

//clear UI
chatAddress.innerHTML = ''
document.getElementById('chatBox').innerHTML=`<div class="container"> <div class="row justify-content-center"> <div class="col-10"> <div class="rounded-circle border border-primary p-3" style="width: 90%; height: auto;"> <div id="svg-container"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"> <image href="./nochats.svg" width="100%" height="100%"></image> </svg>  <button type="button" id="" class="btn btn-primary " style="display: inline;" onclick="event.stopPropagation(); openChat()"> CHAT </button>   </div> </div> </div> </div> </div> `

// DEACTIVATE BUTTONS
document.getElementById('chatTextInput').disabled = true;
document.getElementById('send-button').disabled = true;


}

// center.onclick = function (e) {
// console.log('GO TO MAIN')
// const swiperEl = document.getElementById('troqContainer');
// swiperEl.swiper.slidePrev();
// }

function removeParam(key) {
var url = new URL(window.location.href);
url.searchParams.delete(key);
window.history.replaceState({}, '', url);
}




async function createAlias(addr) {
// const formattedAddress = ethers.utils.getAddress(addr);
console.log('CREATE AN ALIAS FOR THIS ADDRESS', addr)
// console.log('CREATE AN ALIAS FOR THIS ADDRESS',formattedAddress)

// TEST
// await starkxmtp.registerCodec(new ContentTypeMultiplyNumberCodec());

// const numbersToMultiply = { a: 3, b: 7 };

// await conversation.send(numbersToMultiply, {
// contentType: ContentTypeMultiplyNumbers,
// });

}


 
function isValidHex(address) {
    // Regular expression to check if a string is a valid hexadecimal
    const hexRegex = /^[0-9a-fA-F]+$/;
    return hexRegex.test(address);
}

function isValidStarkNetAddress(address) {
    // Remove the '0x' prefix if it exists
    const normalizedAddress = address.startsWith('0x') ? address.slice(2) : address;

    // Check if the address is a valid hexadecimal string and has the correct length
    return isValidHex(normalizedAddress) && normalizedAddress.length === 64;
}


// // Example usage
// const address1 = '0x7a41ab1bc7b1b1d5d5b9b3b9b3b3b9b3b9b3b9b3b9b3b9b3b9b3b9b3b9b3b9b3';
// const address2 = '0xinvalidaddress';
// const address3 = '7a41ab1bc7b1b1d5d5b9b3b9b3b3b9b3b9b3b9b3b9b3b9b3b9b3b9b3b9b3b9b3b9b3';

// console.log(isValidStarkNetAddress(address1)); // Should return true
// console.log(isValidStarkNetAddress(address2)); // Should return false
// console.log(isValidStarkNetAddress(address3)); // Should return true


function validateAddressType(address) {
    // Check if it is a valid Ethereum address
    if (ethers.isAddress(address)) {
		console.log('ETH Address')
        return 'ETH Address';
    }
    

        const isValidStarkNetAddress = stark.makeAddress(address);
        if (isValidStarkNetAddress) {
		console.log('StarkNet Address')

            return 'StarkNet Address';
        }
  
		console.log('Invalid Address')
    return 'Invalid Address';
}


		async function isValidAddress(address) {
					// return ethers.utils.isAddress(address);
					return ethers.isAddress(address);
				}

				

	async function addAddress() {
	console.log('addAddress()')

			let addressToAdd = Swal.fire({
				title: "add Address",
				input: 'text',
				inputAttributes: { autocapitalize: 'off' },
				showCancelButton: true,
				confirmButtonText: 'ok',
				showLoaderOnConfirm: true,
				preConfirm: (login) => { },
				backdrop: true,
				inputValidator: async (value) => {
					if (!value) {
						return 'You need to set a password to create your wallet!'
					}


					// COMPLETAR ADDR VERIFICATION
					// IF ETH 
					// IF STARKNET
					// const checkAdddressType = await validateAddressType(value);
					// return
					const isValid = await isValidAddress(value);

					if (isValid) {
						console.log(`Address ${value} is valid.`);

						Toast.fire({ 
							icon: 'success', 
							title: 'CHAT WITH:', 
							position: 'center',
							text: value });


							// ---------------
							// / FIX
							// functiona como resetar la address
							let contact = { address: value, username: null, avatar: null, did: null }
							SaveContactsToLocalStorage(contact)
							// ---------------
						await chatWith(value)
						await deleteChat()


					} else {
						console.log(`Address ${value} is not valid.`);
						return 'Address is not valid!'

					}

				},

				allowOutsideClick: () => {
					const popup = Swal.getPopup()
					popup.classList.remove('swal2-show')
					setTimeout(() => { popup.classList.add('animate__animated', 'animate__headShake') })
					setTimeout(() => { popup.classList.remove('animate__animated', 'animate__headShake') }, 500)
					return false
				},
			})
				.then(async (result) => {
					if (result.isConfirmed) {
						console.log('result.isConfirmed:')
						// await decryptWallet(result.value)
						return result.value
					}
				})
			console.log('addressToAdd:', addressToAdd)

			// close nav
			plToggle()

		}




		/*********************************************************************************************
		.)  SETTINGS
		**********************************************************************************************/

		async function settings() {
			console.log('settings()')
			openModalId('#settingsModal')

		}


		async function backup() {
			console.log('backup()')
			openModalId('#walletBackp')
			closeModalId('#settingsModal')

			displayMnemonic.innerHTML = ` <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height='40px' width='40px' fill="currentColor"> <path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/></svg>Write down your mnemonic phrase to access your wallet in the future! :</h3> <div class="alert alert-warning alert-dismissible fade show"> <strong>${wallet.mnemonic.phrase}</strong> </div> `
			setTimeout(() => {
				const checkbox = document.getElementById('mnemonicBackedup');
				const button = document.getElementById('closeBackupmodal');
				mnemonicBackedup.disabled = false;
				checkbox.addEventListener('change', function () {
					button.disabled = !this.checked;
					mnemonicBackedup.disabled = true;
					console.log('close mnemonic activated')

					// NOW DELETE unbackedWallet
					// localStorage.removeItem('unbackedWallet')

				});
				// init();
			}, 1000);


		}

		async function restoreWallet() {
			console.log('restoreWallet()')
			openModalId('#walletRestore')
			closeModalId('#settingsModal')

			seedTextarea.addEventListener('input', function (evt) {
				console.log(this.value);

				let cntwrds = countWords(this.value)
				if (cntwrds >= 12) {
					setWalletRestore.disabled = false;
				} else {
					setWalletRestore.disabled = true;
				}

			});
		}

		function countWords(str) {
			let lngth = str.trim().split(/\s+/).length;
			console.log('countWords:', lngth)
			return lngth;
		}

		async function restoreSeed() {
			console.log('restoreSeed()')

			let seed = seedTextarea.value
			console.log('seed:', seed)

			// localStorage.setItem('unbackedWallet', seed)
			await localStorage.setItem('unbackedWallet', JSON.stringify(seed))

			await localStorage.removeItem('jsonWallet')

			closeModalId('#walletRestore')

			seedTextarea.value = ''
			await init()

		}




		/*********************************************************************************************
		.)   MANAGE DID
		**********************************************************************************************/


    // ----------------------------
    // GET SIGNER


    async function getLocalWalletSigner() {
      console.log('getLocalWalletSigner()');
      return Swal.fire({
        // title: 'Unlock your LOCALWALLET',
        title: dictionary[globalLang]["unlocklocalwallet"],
        input: 'password',
        inputAttributes: { autocapitalize: 'off' },
        showCancelButton: true,
        confirmButtonText: 'Enter',
        showLoaderOnConfirm: true,
        backdrop: true,
        preConfirm: (login) => { },
        allowOutsideClick: () => {
          const popup = Swal.getPopup();
          popup.classList.remove('swal2-show');
          setTimeout(() => {
            popup.classList.add('animate__animated', 'animate__headShake');
          });
          setTimeout(() => {
            popup.classList.remove('animate__animated', 'animate__headShake');
          }, 500);
          return false;
        },
      }).then(async (result) => {
        if (result.isConfirmed) {
          console.log('password entered!');
          if (result.value == '') {
            console.log('IS EMPTY');
            Toast.fire({ icon: 'error', title: 'Password cannot be empty' });
            return null;
          }

          let encryptedjson = localStorage.getItem('jsonWallet');
          let ew = JSON.parse(encryptedjson);
          console.log('pub key of wallet in localstorage:', ew.address);

          try {
            return ethers.Wallet.fromEncryptedJson(encryptedjson, result.value).then(async (localWallet) => {
              console.log('localWallet.publicKey:', localWallet.publicKey);
              let provider = new ethers.JsonRpcProvider(`${optionsList[0].API}`); //v6
              const signer = localWallet.connect(provider);
              console.log('SIGNER:', signer);
              return signer;
            });
          } catch (error) {
            console.error('Error during wallet decryption:', error);
            Toast.fire('Error', error.message, "error");
            Swal.fire({
              icon: "error",
              title: "Error",
              text: error.message,
            });
            // Handle the error here, you can show a toast or do something else.
            return null;
          }
        }
        return null;
      }).catch(error => {
        console.error('Error during Swal prompt:', error.reason);
        // Toast.fire('Error', error.message, "error");
        Toast.fire('Error', error.message, "error");
        Swal.fire({
          icon: "error",
          title: "Error",
          text: error.message,
        });


        // Handle the error here, you can show a toast or do something else.
        return null;
      });
    }


	// id: string;
    // avatar: string;
    // alias: string;
    // privData: string;
    // cid: string; 
    // publicKey: PublicKey;
		// async function createDIDRecord(did, avatar, cid, signer) {
			async function createDIDRecord(did, avatar, alias, privData, cid, signer) {
			if (!signer) {
				console.log('there is no signer')
				signer = await getLocalWalletSigner();
				if (!signer) {
					console.log('Handle case where signer is not obtained');
					return; // Or throw an error, or handle the case in another way
				}
			} else {
				console.log('Now you have the signer, do whatever you need with it:', signer);
				// const db = new Polybase({ defaultNamespace: "pk/0xee1b340c80295bb60ada66e0396a44b70c479a857c357b37883d27efe030aaf8baf25fde75eaf8881bb6c0f34fac20dbf6896fc373d5835e43ffe01f216feab9/IURISNATURALIS" });
				const db = new Polybase({ defaultNamespace: "pk/2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID" });

				const data = [did, avatar, cid];
				db.signer(async (data) => {
					const signature = await signer.signMessage(data);//FIXED!
					return { h: 'eth-personal-sign', sig: signature, };
				});

				const collectionReference = db.collection("STARKID");
				await collectionReference.create(data);
			}
		}

		async function readDIDRecord(id) {
			const db = new Polybase({
				defaultNamespace: "pk/0xee1b340c80295bb60ada66e0396a44b70c479a857c357b37883d27efe030aaf8baf25fde75eaf8881bb6c0f34fac20dbf6896fc373d5835e43ffe01f216feab9/IURISNATURALIS"
			});
			const collectionReference = db.collection("STARKID");
			const record = await collectionReference.record(id).get();
			const { data } = record; // or const data = record.data
			const resultRecord = record.get();
			console.log('resultRecord:', resultRecord)
			return resultRecord
		}


		// async function updateDIDavatar(id, newavatar, signer) {

		// async function updateDIDavatar(id, newavatar) {
		async function updateDIDavatar( newavatar) {
			console.log('updateDIDavatar()')

				// 0- CHECK IF UNBACKED WALLET INLOCALSTORAGE
				let unbw = localStorage.getItem('unbackedWallet')

							if (!unbw) {
								console.log('1- NO UNBACKED WALLET');
								signer = await getLocalWalletSigner();
								did = `did:ethr:${signer.address}`
								console.log('DID: ', did)
								// return //falta testear
							}
							else {
								console.log('YES THERE IS AN UNBACKED WALLET > DEDUCTING SIGNER NOW!')

								const walletData = JSON.parse(unbw);
								try { localWallet = ethers.Wallet.fromPhrase(walletData); }
								catch (error) {
									console.log(error.message, 'ERROR WALLET!');
								}
								let provider = new ethers.JsonRpcProvider(`${optionsList[0].API}`); //v5
								signer = localWallet.connect(provider);
								console.log('SIGNER!:', signer);
								//  return signer;
								did = `did:ethr:${signer.address}`
								console.log('DID: ', did)
								
							}
							


					// .............
								console.log('Now you have the signer, do whatever you need with it:', signer);
								const db = new Polybase({ defaultNamespace: "pk/0xee1b340c80295bb60ada66e0396a44b70c479a857c357b37883d27efe030aaf8baf25fde75eaf8881bb6c0f34fac20dbf6896fc373d5835e43ffe01f216feab9/IURISNATURALIS" });
								db.signer(async (newavatar) => {
									console.log('data:', newavatar)
									const signature = await signer.signMessage(newavatar);
									return { h: 'eth-personal-sign', sig: signature, };
								});
								try {
									const recordData = await db
										.collection("STARKID")
										.record(id)
										.call("updateAvatar", [newavatar]);
									console.log("recordData:", recordData);
								} catch (error) {
									console.error("An error occurred:", error);
									fixedToast.fire('Error', error.message, "error");
								}
								return true


							// }
						}




		async function deleteDID(id) {
			console.log('deleteDID()')

			Swal.fire({
				title: dictionary[globalLang]["deletedidtitle"],
				text: dictionary[globalLang]["deletediddescription"],
				icon: 'warning',
				showCancelButton: true,
				confirmButtonColor: '#3085d6',
				cancelButtonColor: '#d33',
				confirmButtonText: dictionary[globalLang]["delete"]

			}).then(async (result) => {
				if (result.isConfirmed) {



					let signer = await getLocalWalletSigner();
					if (!signer) {
						console.log('Handle case where signer is not obtained');
					}
					else {
						console.log('Now you have the signer, do whatever you need with it:', signer);
						const db = new Polybase({ defaultNamespace: "pk/0xee1b340c80295bb60ada66e0396a44b70c479a857c357b37883d27efe030aaf8baf25fde75eaf8881bb6c0f34fac20dbf6896fc373d5835e43ffe01f216feab9/IURISNATURALIS" });
						db.signer(async (id) => {
							const signature = await signer.signMessage(id);
							// const signature = await signer.signMessage(JSON.stringify(id));
							console.log('signature:', signature)
							return { h: 'eth-personal-sign', sig: signature, };
						});
						try {
							const recordData = await db
								.collection("DID")
								.record(id)
								.call("deleteDID");
							console.log(" recordData:", recordData);
						} catch (error) {
							console.error("An error occurred:", error);
							fixedToast.fire('Error', error.message, "error");
						}
						Swal.fire({
							title: "DELETED!",
							text: "Your DID was deleted",
							icon: "success"
						});
						await walletDisconnect()
					}




				}
			})
		}





		/*********************************************************************************************
		.)   UPDATE IMAGE AVATA
		**********************************************************************************************/

		// itemImgMINT=>avatarIMG
// fileCreateItemFile => avatarIMGfile 

		avatarIMG.onclick = function (e) {
			console.log('avatarIMG clicked')
			e.preventDefault()
			loadCroppedImg()
			// fileCreateItemFile.click();

		};



		async function compressImage(imageSrc, maxSizeKB) {
			return new Promise((resolve, reject) => {
				const img = new Image();
				img.onload = function () {
					const canvas = document.createElement('canvas');
					const ctx = canvas.getContext('2d');

					// Calculate new dimensions to maintain aspect ratio
					const MAX_WIDTH = 800;
					const MAX_HEIGHT = 600;
					let width = img.width;
					let height = img.height;
					if (width > height) {
						if (width > MAX_WIDTH) {
							height *= MAX_WIDTH / width;
							width = MAX_WIDTH;
						}
					} else {
						if (height > MAX_HEIGHT) {
							width *= MAX_HEIGHT / height;
							height = MAX_HEIGHT;
						}
					}

					// Set canvas dimensions
					canvas.width = width;
					canvas.height = height;

					// Draw image on canvas
					ctx.drawImage(img, 0, 0, width, height);

					// Convert canvas to Blob and compress to target size
					canvas.toBlob(function (blob) {
						// Check if compressed image is within target size
						if (blob.size / 1024 <= maxSizeKB) {
							// Resolve with the compressed data URL
							resolve(canvas.toDataURL());
						} else {
							// Reject if compressed image size exceeds target size
							reject('Compressed image size exceeds the specified limit');
						}
					}, 'image/jpeg', 0.7); // Adjust the quality factor (0.7 here) to achieve desired compression level
				};
				img.src = imageSrc;
			});
		}



		async function loadCroppedImg() {
			console.log('loadCroppedImg()');

			// openModalId('#createDIDModal')
// fileCreateItemFile => avatarIMGfile 

			await avatarIMGfile.click();
			let previewsrc;

			avatarIMGfile.onchange = async function () {
				if (avatarIMGfile.files.length == 1) {
					const data = this.files[0];
					const name = data.name;

					// Read the file and get its base64 data
					let reader = new FileReader();
					reader.readAsDataURL(data);

					reader.onload = async function () {
						previewsrc = reader.result;

						// Compress the image
						const compressedDataUrl = await compressImage(previewsrc, 100); // 100KB limit

						// Display the image in a SweetAlert2 popup
						Swal.fire({
							// title: 'crop',
							// title: dictionary[globalLang]["uploadsignature"],
							html: `
                        <img id="preview" src="${compressedDataUrl}" style="display:none">
                        <div>
                            <img id="cropperjs" src="${compressedDataUrl}">
                        </div>
                    `,
							allowOutsideClick: () => {
								const popup = Swal.getPopup();
								popup.classList.remove('swal2-show');
								setTimeout(() => {
									popup.classList.add('animate__animated', 'animate__headShake');
								});
								setTimeout(() => {
									popup.classList.remove('animate__animated', 'animate__headShake');
								}, 500);
								return false;
							},
							willOpen: () => {
								const image = document.querySelector('#cropperjs');
								const cropper = new Cropper(image, {
									aspectRatio: '4:3',
									viewMode: 1,
									crop: throttle(function () {
										const croppedCanvas = cropper.getCroppedCanvas();
										console.log('croppedCanvas:', croppedCanvas);
										const preview = document.querySelector('#preview');
										preview.src = croppedCanvas.toDataURL();
									}, 25),
								});
							},
							preConfirm: () => {
								const popup = Swal.getPopup();
								if (popup) {
									const previewElement = popup.querySelector('#preview'); // Assuming preview is the ID of the image element
									if (previewElement instanceof HTMLImageElement) {
										return previewElement.src;
									}
								}
							},
						}).then(async  function (result) {
							avatarIMG.src = result.value;
							let b64 = JSON.stringify(result.value);
							console.log('b64 image:', b64);
							localStorage.setItem('avatar', b64);
							avatarIMG.style.display = 'block';
							Toast.fire('Avatar added', '', "success");


							// ...........................................................................................
							// 3.RECORD TO ZKROLLUP
							// ..........................................................................................

							let avatar = localStorage.getItem('avatar');
							let cid = '';

							// 0- CHECK IF UNBACKED WALLET INLOCALSTORAGE
							let unbw = localStorage.getItem('unbackedWallet')

							if (!unbw) {
								console.log('1- NO UNBACKED WALLET');
								signer = await getLocalWalletSigner();
								did = `did:ethr:${signer.address}`
								console.log('DID: ', did)
								return //falta testear
							}
							else {
								console.log('YES THERE IS AN UNBACKED WALLET > DEDUCTING SIGNER NOW!')

								const walletData = JSON.parse(unbw);
								try { localWallet = ethers.Wallet.fromPhrase(walletData); }
								catch (error) {
									console.log(error.message, 'ERROR WALLET!');
									// localStorage.removeItem('unbackedWallet');
								}

								// let provider = new ethers.providers.JsonRpcProvider(`${optionsList[0].API}`); //v5
								let provider = new ethers.JsonRpcProvider(`${optionsList[0].API}`); //v5
								//  let provider = new ethers.JsonRpcProvider(`${optionsList[0].API}`); //v6
								signer = localWallet.connect(provider);
								console.log('SIGNER!:', signer);
								//  return signer;
								did = `did:ethr:${signer.address}`
								console.log('DID: ', did)
							}
							try {
								console.log('creating did RECORD, signer', signer)
								createDIDRecord(did, avatar, cid, signer);
								//  https://explorer.testnet.polybase.xyz/studio/pk%2F0xee1b340c80295bb60ada66e0396a44b70c479a857c357b37883d27efe030aaf8baf25fde75eaf8881bb6c0f34fac20dbf6896fc373d5835e43ffe01f216feab9%2FIURISNATURALIS/collections/CHATWALLETDID
							} catch (error) {
								console.error('An error occurred while creating DID record:', error);
								return
							}

							// REMOVE FROM LOCALSTORAGE
							 localStorage.removeItem('avatar');



						});
					};
				}
			};
		}


			</script>
	</body>
</html>
