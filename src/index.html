<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>IUS NATURALIS DAPP</title>
	<meta name="description"
		content="a DID managing tool to communicate your public and private data with sovereignty" />
	<meta name="keywords" content="did, starknet " />
	<meta name="author" content="Xunorus" />
	<link rel="shortcut icon" href="favicon.ico">
	<link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet">
	<script src="js/sweetalert2.all.min.js"></script>
	<script src="js/qr-code-styling.js"></script>

	<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/css/autoComplete.01.min.css"> -->

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/cropper.css" />
	<link rel="stylesheet" type="text/css" href="css/iusdapp.css" />
	<link rel="stylesheet" type="text/css" href="css/buttons.css" />
	<link rel="stylesheet" type="text/css" href="css/numbers.css" />

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
	<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/css/autoComplete.02.min.css"> -->

	<!--[if IE]>
  		<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
	<script>document.documentElement.className = 'js';</script>
</head>

<body class="demo-1">

	<div id="headerNotes"></div>

	<!-- /*********************************************************************************************
  .) OVERLAY
  **********************************************************************************************/ -->

	<div class="overlay"></div>


	<!-- /*********************************************************************************************
  .) LOCK UNLOCK BANNER
  **********************************************************************************************/ -->
	<div id='lockscreen' class="cover-container" style="display: none;">
		<img src="img/logowt.png" alt="Cover Image" class="cover-image" id="logoLockscreen">
		<button id="unlockButton" class="btn btn-primary btn-unlock"
			onclick="event.stopPropagation();unlockLocalwallet()">Unlock</button>
	</div>

	<!-- /*********************************************************************************************
  .) SIDEBAR
  **********************************************************************************************/ -->
	<div id="sidebar" class='sidebar'>
		<a class='closeonclick' href="/">
			<div class='title'> </div>
		</a>

		<input name="avatarIMG" id="avatarIMGfile" type="file" style="display:none" accept="image/*" />
		<!-- ex fileCreateItemFile -->
		<img id="avatarIMG" src="img/anonym.jpg" alt="Avatar" class=""> <!-- ex itemImgMINT -->

		<span id="userAlias" class="d-flex align-items-center justify-content-center"
			style=" word-break: break-all; "></span>

		<div class="container mt-3">
			<div class="row">
				<div class="col text-center" id="configButtons">

					<button type="button" id="" class="btn btn-primary" onclick="event.stopPropagation();addAddress()">
						<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 640 512">
							<path
								d="M96 128a128 128 0 1 1 256 0A128 128 0 1 1 96 128zM0 482.3C0 383.8 79.8 304 178.3 304h91.4C368.2 304 448 383.8 448 482.3c0 16.4-13.3 29.7-29.7 29.7H29.7C13.3 512 0 498.7 0 482.3zM504 312V248H440c-13.3 0-24-10.7-24-24s10.7-24 24-24h64V136c0-13.3 10.7-24 24-24s24 10.7 24 24v64h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H552v64c0 13.3-10.7 24-24 24s-24-10.7-24-24z" />
						</svg>
					</button>

					<!-- ESTOS DOS BOTONES PROXIMO CAMBIO  -->

					<button type="button" id="" class="btn btn-danger" onclick="event.stopPropagation(); showWallet()">
						<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">
							<path
								d="M64 32C28.7 32 0 60.7 0 96L0 416c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64l0-224c0-35.3-28.7-64-64-64L80 128c-8.8 0-16-7.2-16-16s7.2-16 16-16l368 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L64 32zM416 272a32 32 0 1 1 0 64 32 32 0 1 1 0-64z" />
						</svg>
					</button>

					<!-- <button type="button" id="" class="btn btn-danger" onclick="event.stopPropagation(); scanAddress()">
					<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512">
						<path
						d="M0 80C0 53.5 21.5 32 48 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V80zM64 96v64h64V96H64zM0 336c0-26.5 21.5-48 48-48h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V336zm64 16v64h64V352H64zM304 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H304c-26.5 0-48-21.5-48-48V80c0-26.5 21.5-48 48-48zm80 64H320v64h64V96zM256 304c0-8.8 7.2-16 16-16h64c8.8 0 16 7.2 16 16s7.2 16 16 16h32c8.8 0 16-7.2 16-16s7.2-16 16-16s16 7.2 16 16v96c0 8.8-7.2 16-16 16H368c-8.8 0-16-7.2-16-16s-7.2-16-16-16s-16 7.2-16 16v64c0 8.8-7.2 16-16 16H272c-8.8 0-16-7.2-16-16V304zM368 480a16 16 0 1 1 0-32 16 16 0 1 1 0 32zm64 0a16 16 0 1 1 0-32 16 16 0 1 1 0 32z" />
					</svg>
				</button> -->

					<!-- FIN de ESTOS DOS BOTONES PROXIMO CAMBIO  -->

					<button type="button" id="" class="btn btn-success" onclick="event.stopPropagation(); settings()">
						<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">
							<path
								d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z" />
						</svg>
					</button>
				</div>
			</div>
		</div>

		<button class="btn btn-primary fullwidth" style="display: none;" id="updateOnchain"
			onclick="event.stopPropagation(); updateOnchainDID()" disabled> Update
		</button>

		<ul id="cwContacts" class="nav"> </ul>

		<!-- id="createIPFSDelivery" -->
		<button class="btn btn-primary btn-lg fullwidth "
			onclick="event.stopPropagation();publishInDID((this.parentElement))" disabled data-translate="publicipfs">
			<i class="fa-solid fa-envelope-circle-check"></i> Preparer comme Envoi
			IPFS</button>

		<button class="btn btn-primary fullwidth" id="mintOrUpdate" onclick="event.stopPropagation(); mintOrUpdate()"
			disabled> Mint
		</button>

	</div>


	<!-----------------------------
	LOADER 
	--------------------------->
	<div class="loaderDiv" id="loader"> <span class="loader"></span> </div>

	<svg class="hidden">
		<defs>

			<!-- 1 -->
			<symbol id="icon-menu" viewBox="0 0 24 24">
				<title>menu</title>
				<image preserveAspectRatio="none" inkscape:svg-dpi="300" width="17.49" height="19.988571"
					style="image-rendering:optimizeQuality"
					xlink:href="data:image/svg+xml;base64,PHN2ZyBpZD0iaWNvbi1tZW51IiB2aWV3Qm94PSIwIDAgNDQ4IDUxMiI+CjxwYXRoIGQ9Ik0wIDk2 QzAgNzguMyAxNC4zIDY0IDMyIDY0SDQxNmMxNy43IDAgMzIgMTQuMyAzMiAzMnMtMTQuMyAzMi0z MiAzMkgzMkMxNC4zIDEyOCAwIDExMy43IDAgOTZ6TTAgMjU2YzAtMTcuNyAxNC4zLTMyIDMyLTMy SDQxNmMxNy43IDAgMzIgMTQuMyAzMiAzMnMtMTQuMyAzMi0zMiAzMkgzMmMtMTcuNyAwLTMyLTE0 LjMtMzItMzJ6TTQ0OCA0MTZjMCAxNy43LTE0LjMgMzItMzIgMzJIMzJjLTE3LjcgMC0zMi0xNC4z LTMyLTMyczE0LjMtMzIgMzItMzJINDE2YzE3LjcgMCAzMiAxNC4zIDMyIDMyeiIvPgo8L3N2Zz4K "
					id="image120" x="3.2550001" y="2.0057144" />
			</symbol>
			<!-- 1 -->
			<symbol id="icon-arrow" viewBox="0 0 24 24">
				<title>arrow</title>
				<polygon points="6.3,12.8 20.9,12.8 20.9,11.2 6.3,11.2 10.2,7.2 9,6 3.1,12 9,18 10.2,16.8 " />
			</symbol>

			<symbol id="icon-drop" viewBox="0 0 24 24">
				<title>drop</title>
				<path
					d="M12,21c-3.6,0-6.6-3-6.6-6.6C5.4,11,10.8,4,11.4,3.2C11.6,3.1,11.8,3,12,3s0.4,0.1,0.6,0.3c0.6,0.8,6.1,7.8,6.1,11.2C18.6,18.1,15.6,21,12,21zM12,4.8c-1.8,2.4-5.2,7.4-5.2,9.6c0,2.9,2.3,5.2,5.2,5.2s5.2-2.3,5.2-5.2C17.2,12.2,13.8,7.3,12,4.8z" />
				<path
					d="M12,18.2c-0.4,0-0.7-0.3-0.7-0.7s0.3-0.7,0.7-0.7c1.3,0,2.4-1.1,2.4-2.4c0-0.4,0.3-0.7,0.7-0.7c0.4,0,0.7,0.3,0.7,0.7C15.8,16.5,14.1,18.2,12,18.2z" />
			</symbol>
			<symbol id="icon-search" viewBox="0 0 24 24">
				<title>search</title>
				<path
					d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
			</symbol>
			<symbol id="icon-cross" viewBox="0 0 24 24">
				<title>cross</title>
				<path
					d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
			</symbol>
		</defs>
	</svg>



	<main class="main-wrap">
		<header class="codrops-header">
			<button id="lightButton" class="traffic-light"></button>


			<!-- <section id="userData">
					<span class="top">My Balance:</span>
					<span class="bal">-999.9999</span>
					<span class="eth">ETH</span>
				 </section> -->
			<h1 class="codrops-header__title" id="userData">IUS NATURALIS</h1>
			<div id="address"></div>
			<div id="data"></div>

			<div class="search-wrap">
				<button id="btn-search" class="btn btn--search" style="display: none;"> <svg class="icon icon--search">
						<use xlink:href="#icon-search"></use>
					</svg></button>
			</div>

			<span class="badge bg-primary" id="chatBadge">-</span>
			<button id="" class="right hamburger hamburger--elastic" type="button" aria-label="Menu"
				aria-controls="navigation">
				<span class="hamburger-box">
					<span class="hamburger-inner"></span>
				</span>
			</button>


		</header>

		<!-- =================== -->
		<div id="qrtroqcontainer" class=" container swiperSlide">


			<div class=" responsive-svg" id="canvas"></div>

		</div>
		<pre id="yourAddress"> </pre>
		<!-- ======================= -->


		<div id="qrresult"> </div>


		<!-- ADD PUBLIC DOCUMENTS -->
		<div class="bottom-nav">
			<nav class="codrops-demos">
				<span>v5.12</span>
			</nav>
		</div>

		<!-- FIN UI -->

	</main>


	<div class="search" id="chatContainer">
		<!-- <button id="btn-search-close" class="btn btn--search-close" aria-label="Close search form" onclick="event.stopPropagation();deleteChat((this.parentElement))"><svg class="icon icon--cross"><use xlink:href="#icon-cross"></use></svg></button> -->

		<div id="chatheader" class="">
			<span id="chatAddress"></span>
			<div id="singleChatlightButton" class="traffic-light"></div>
			<span class="alignright " id="actionButtons"> </span>
		</div>



		<div class="search__related" id="chatBox">
			<div class="search__suggestion">
				<h3>WELCOME</h3>
				<p>Your chat is being prepared.</p>
				<p>Please, be patient</p>
				<div class="loader"></div>

			</div>

		</div>


		<form class="search__form" action="" id="chatfooter" onsubmit="sendMessage()">

			<input id="chatTextInput" class="search__input" name="search" placeholder="Type a message..."
				autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled />

			<button class="btn btn-primary" id="send-button" onclick="sendMessage()" disabled>
				<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">
					<path
						d="M440 6.5L24 246.4c-34.4 19.9-31.1 70.8 5.7 85.9L144 379.6V464c0 46.4 59.2 65.5 86.6 28.6l43.8-59.1 111.9 46.2c5.9 2.4 12.1 3.6 18.3 3.6 8.2 0 16.3-2.1 23.6-6.2 12.8-7.2 21.6-20 23.9-34.5l59.4-387.2c6.1-40.1-36.9-68.8-71.5-48.9zM192 464v-64.6l36.6 15.1L192 464zm212.6-28.7l-153.8-63.5L391 169.5c10.7-15.5-9.5-33.5-23.7-21.2L155.8 332.6 48 288 464 48l-59.4 387.3z" />
				</svg>
			</button>

			<button class="btn btn-primary" id="send-attachment" onclick="sendAttachment()" disabled>

				<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512">
					<path
						d="M364.2 83.8c-24.4-24.4-64-24.4-88.4 0l-184 184c-42.1 42.1-42.1 110.3 0 152.4s110.3 42.1 152.4 0l152-152c10.9-10.9 28.7-10.9 39.6 0s10.9 28.7 0 39.6l-152 152c-64 64-167.6 64-231.6 0s-64-167.6 0-231.6l184-184c46.3-46.3 121.3-46.3 167.6 0s46.3 121.3 0 167.6l-176 176c-28.6 28.6-75 28.6-103.6 0s-28.6-75 0-103.6l144-144c10.9-10.9 28.7-10.9 39.6 0s10.9 28.7 0 39.6l-144 144c-6.7 6.7-6.7 17.7 0 24.4s17.7 6.7 24.4 0l176-176c24.4-24.4 24.4-64 0-88.4z" />
				</svg>
			</button>

			<span class="search__info">Hit enter to send or ESC to close</span>
			<!-- <span id="lightButton">🔴</span> -->
			<!-- <span id="lightButton" class="traffic-light"></span> -->

		</form>


	</div><!-- /search chat-->


	<!-- MODALS -->

	
	<!-- DID Minter Mdal -->

	<div class="modal fade" id="didMinterModal" tabindex="-1" aria-labelledby="didMinterModal" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="didMinterModalLabel">DID MINTER</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">

					<h1>Let's Mint your Self Soveraing DID 💪</h1>

					<div id="didMinterUpdates"></div>

					<div class="row mb-3">
						<div class="col-12">
							<label for="mintAliasName" class="form-label">Alias Name</label>
							<input type="text" class="form-control" id="mintAliasName" placeholder="Enter alias name">
							<form class="mt-3">
								<div id="additionalFields"></div>
								<button type="button" class="btn btn-secondary btn-sm" onclick="mintDID()">MINT
								</button>
							</form>
						</div>
					</div>


				</div>
			</div>
		</div>
	</div>

	<!-- fin Modal DID SAVE -->



	<!-- Modal DID SAVE -->

	<!-- Modal DID MANAGER -->
	<div class="modal fade" id="didManagerModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="didManagerModalLabel">User Information</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<!-- First row: Picture and Change Avatar button -->
					<div class="row mb-3">
						<div class="col-12 text-center">
							<img src="https://via.placeholder.com/150" id="aliasAvatar" alt="Avatar"
								class="img-thumbnail">
							<div class="mt-2">
								<button class="btn btn-secondary btn-sm" id="changeAvatar">Change Avatar</button>
							</div>
						</div>
					</div>
					<!-- Second row: Text input field and additional form -->


					<div class="row mb-3">
						<div class="col-12">
							<label for="aliasName" class="form-label">Alias Name</label>
							<div class="input-group">
								<input type="text" class="form-control" id="aliasName" placeholder="Enter alias name"
									readonly>
								<button type="button" id="editAlias" class="btn btn-secondary">Edit</button>
							</div>
						</div>
					</div>
					<!-- <div class="row mb-3">
            <div class="col-12">
              <label for="aliasName" class="form-label">Alias Name</label>
              <input type="text" class="form-control" id="aliasName" placeholder="Enter alias name">
            
			  
            </div>
		</div> -->
					<!-- <form class="mt-3">
		  <div id="additionalFields"></div>
		  <button type="button" class="btn btn-secondary btn-sm" onclick="addDoc()">Add Public Document +</button>
		</form> -->
					<!-- Third row: Save DID button -->
					<!-- PUBLIC DOCS INSERTION -->

					<section id="uploaddocs" class="container">

						<p data-translate="addDocs" class="heading">1- ADD PUBLIC DOCUMENTS</p>


						<div id="documentos">
							<div id="historial">
								<button type="button" class="btn btn-outline-secondary"
									onclick="event.stopPropagation();addDoc('#addDocument')" id='addDocumentButton'>
									<i id='plusAddDocumentButton' class="fa-solid fa-plus" aria-hidden="true"></i>
									<i id='spinAddDocumentButton' style='display:none'
										class="fas fa-circle-notch fa-spin"></i>

									<span data-translate="adddoc">Add document</span></button>

								<div id="tbody"> </div>



							</div>
						</div>
						<br>
						<div id="addDocsButtons" class="">
							<!-- <button class="btn btn-primary btn-lg " id="createIPFSDelivery"
		onclick="event.stopPropagation();publishInDID((this.parentElement))" disabled data-translate="publicipfs">
		<i class="fa-solid fa-envelope-circle-check"></i> Preparer comme Envoi
		IPFS</button>
	  <br> -->

					</section>


					<section id="createenvoi" class="container">


						<ul id="IPFSDeliveries">

						</ul>


						<p id="vosenvois"></p>
						<div id="qrcode"></div>

						<pre id="sigresult"></pre>

						<br />



					</section>


					<!-- FIN PUBLIC DOCS INSERTION -->


					<!-- <div class="row">
            <div class="col-12 text-center">
              <button type="button" class="btn btn-primary">SAVE DID</button>
            </div>
          </div> -->


				</div>
			</div>
		</div>
	</div>

	<!-- fin Modal DID MANAGER -->


	<!-- Modal PASSWORD WALLET -->
	<div class="modal fade" data-bs-backdrop="static" id="walletPassword" tabindex="-1" role="dialog" aria-labelledby=""
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="unlockWallet" id="">VIEW MNEMONIC PHRASE</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body" id="backedWalletMnemonic">


					<!-- ====== -->


					<!-- ==== -->


				</div>
				<div class="modal-footer justify-content-center">
					<a target="_blank"
						href="https://iusnaturalis.web.app/docs/index.html#/?id=la-auto-custodia">Documentation</a>
				</div>


			</div>
		</div>
	</div>

	<!-- Modal BACKUP WALLET -->
	<div class="modal fade" data-bs-backdrop="static" id="walletBackp" tabindex="-1" role="dialog" aria-labelledby=""
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="walletCreation" id="">WALLET CREATION</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

				</div>
				<div class="modal-body" id="walletHiddenContent">
					<div id="displayPubKey"></div>
					<div id="displayPK"></div>
					<!-- <div id="displayMnemonic" ></div> -->
					<div id="displayMnemonic" translate="no"></div>
					<div id="displayDecrypt"></div>
					<div id="success_message2" class="alert alert-success" role="alert" style="display: none;"></div>
				</div>
				<div class="modal-footer justify-content-center" id="walletbackpfooter">
					<!-- <a target="_blank"  href="https://iusnaturalis.web.app/docs/index.html#/?id=la-auto-custodia">Check out the wiki!</a>  -->
				</div>


			</div>
		</div>
	</div>


	<!-- Modal wallet RESTORE -->
	<div class="modal fade" data-bs-backdrop="static" id="walletRestore" tabindex="-1" role="dialog" aria-labelledby=""
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="walletrestore" id="">WALLET RESTORE</h5>
				</div>
				<div class="modal-body">
					<!-- SEED -->
					<div id="seedData">
						<div class="mb-3">
							<label for="seedTextarea" class="form-label">Paste your seed, mnemonic or Private
								key</label>
							<textarea class="form-control" id="seedTextarea" rows="3"></textarea>
						</div>
						<!-- PASSWORD -->
						<div class="row g-3 align-items-center">
							<div class="col-auto">
								<label for="seedPassword" class="col-form-label">Password</label>
							</div>
							<div class="col-auto">
								<input type="password" id="seedPassword" class="form-control"
									aria-describedby="passwordHelpInline">
								<div class="valid-feedback">Valid.</div>
								<div class="invalid-feedback">Please set a password.</div>
							</div>

							<div class=" col-auto">
								<input type="checkbox" class="form-check-input" id="wrememberPassword" checked>
								<label class="form-check-label" for="rememberPassword">Remember me</label>
							</div>


						</div>
					</div>
					<div id="displayRestoreProgress"></div>
					<div id="success_message3" class="alert alert-success" role="alert" style="display: none;"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary closeWalletBkp" id="closeWalletRestore"
						data-bs-dismiss="modal" data-translate="close">Cancel</button>
					<button type="button" class="btn btn-outline-secondary closeWalletBkp" id="setWalletRestore"
						data-translate="restore" onclick="event.stopPropagation(); restoreSeed()"
						disabled>Restore</button>
				</div>
			</div>
		</div>
	</div>
	<!-- fin walelt RESTORE WALLET-->

	<!-- SCAN MODAL -->
	<div class="modal fade" data-bs-backdrop="static" id="scanModal" tabindex="-1" role="dialog" aria-labelledby=""
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="scanqr" id="">Scan QR</h5>
				</div>

				<div class="modal-body" id="">
					<div class="">
						<div class="responsive-svg" id="qrcanvas"></div>
						<video id="qrScanVideo" width="300" height="300"></video>
						<div id="scanResult"></div>

					</div>

					<div class="modal-footer">
						<button type="button" class="btn btn-outline-secondary closeWalletBkp" id="closeScanModal"
							data-translate="close">Close</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- fin SCAN MODAL-->



	<!-- SETTINGS MODAL -->
	<div class="modal fade" id="settingsModal" data-bs-backdrop="static" tabindex="-1"
		aria-labelledby="settingsModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="settingsModalLabel">SETTINGS </h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>


				<div class="modal-body" id="settingsCardContainer">



					<h4>Keys management</h4>

					<button type="button" id="" class="btn btn-primary" onclick="event.stopPropagation(); backup()">
						<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">
							<path fill="currentColor"
								d="M512 32c0 113.6-84.6 207.5-194.2 222c-7.1-53.4-30.6-101.6-65.3-139.3C290.8 46.3 364 0 448 0h32c17.7 0 32 14.3 32 32zM0 96C0 78.3 14.3 64 32 64H64c123.7 0 224 100.3 224 224v32V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V320C100.3 320 0 219.7 0 96z" />
						</svg> Backup </button>

					<button type="button" id="" class="btn btn-primary"
						onclick="event.stopPropagation(); restoreWallet()"> <svg xmlns="http://www.w3.org/2000/svg"
							height="16" width="16" viewBox="0 0 512 512">
							<path fill="currentColor"
								d="M174.7 45.1C192.2 17 223 0 256 0s63.8 17 81.3 45.1l38.6 61.7 27-15.6c8.4-4.9 18.9-4.2 26.6 1.7s11.1 15.9 8.6 25.3l-23.4 87.4c-3.4 12.8-16.6 20.4-29.4 17l-87.4-23.4c-9.4-2.5-16.3-10.4-17.6-20s3.4-19.1 11.8-23.9l28.4-16.4L283 79c-5.8-9.3-16-15-27-15s-21.2 5.7-27 15l-17.5 28c-9.2 14.8-28.6 19.5-43.6 10.5c-15.3-9.2-20.2-29.2-10.7-44.4l17.5-28zM429.5 251.9c15-9 34.4-4.3 43.6 10.5l24.4 39.1c9.4 15.1 14.4 32.4 14.6 50.2c.3 53.1-42.7 96.4-95.8 96.4L320 448v32c0 9.7-5.8 18.5-14.8 22.2s-19.3 1.7-26.2-5.2l-64-64c-9.4-9.4-9.4-24.6 0-33.9l64-64c6.9-6.9 17.2-8.9 26.2-5.2s14.8 12.5 14.8 22.2v32l96.2 0c17.6 0 31.9-14.4 31.8-32c0-5.9-1.7-11.7-4.8-16.7l-24.4-39.1c-9.5-15.2-4.7-35.2 10.7-44.4zm-364.6-31L36 204.2c-8.4-4.9-13.1-14.3-11.8-23.9s8.2-17.5 17.6-20l87.4-23.4c12.8-3.4 26 4.2 29.4 17L182 241.2c2.5 9.4-.9 19.3-8.6 25.3s-18.2 6.6-26.6 1.7l-26.5-15.3L68.8 335.3c-3.1 5-4.8 10.8-4.8 16.7c-.1 17.6 14.2 32 31.8 32l32.2 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-32.2 0C42.7 448-.3 404.8 0 351.6c.1-17.8 5.1-35.1 14.6-50.2l50.3-80.5z" />
						</svg> Restore </button>

					<br>
					<br>
					<hr>

					<!-- -------------------------- -->
					<h4>TOKEN</h4>

					<!-- Radio Buttons -->

					<div class="form-check">
						<input class="form-check-input" type="radio" name="tokenType" id="inactiveOption"
							value="inactive">
						<label class="form-check-label" for="inactiveOption">Inactive</label>
					</div>

					<div class="form-check">
						<input class="form-check-input" type="radio" name="tokenType" id="erc20Option" value="evm">
						<label class="form-check-label" for="erc20Option">EVM( eth, erc20, etc)</label>
					</div>

					<!-- ERC-20 Options -->
					<div id="erc20Options" class="mt-3" style="display: none;">

						<select class="form-select mb-3 token-selector" id="erc20Selector"> </select>

						<button type="button" class="btn btn-primary mt-2" id="" onclick="addToken()">+ Add</button>
						<button type="button" class="btn btn-danger mt-2" id="removeErc20Address">Remove</button>
						<button type="button" class="btn btn-info mt-2" id="infoErc20Address">Info</button>

					</div>

					<!-- <div class="form-check"  style="display: none;">
						<input class="form-check-input" type="radio" name="tokenType" id="trokOption" value="trok" disabled>
						<label class="form-check-label" for="trokOption">TROK</label>
					  </div>

				<div class="form-check" style="display: none;">
					<input class="form-check-input" type="radio" name="tokenType" id="g1Option" value="g1" disabled>
					<label class="form-check-label" for="g1Option">Ğ1
					</label>
				</div>

			  <div class="form-check" style="display: none;">
				<input class="form-check-input" type="radio" name="tokenType" id="btcOption" value="btc" disabled>
				<label class="form-check-label" for="btcOption">BTC</label>
			  </div>

			  <div class="form-check" style="display: none;">
				<input class="form-check-input" type="radio" name="tokenType" id="moneroOption" value="monero" disabled>
				<label class="form-check-label" for="moneroOption">MONERO</label>
			  </div> -->





					<br>
					<br>
					<hr>

					<!-- ----------------------------- -->



					<h4>WALLET</h4>
					<!-- <div class="form-check">
						<input class="form-check-input" type="checkbox" id="stealthAddressCheckbox" name="stealthAddress">
						<label class="form-check-label" for="stealthAddressCheckbox"> 👤 Stealth Address</label>
					</div> -->

					<div class="form-check">
						<input class="form-check-input" type="checkbox" id="autoPaygas2meCheckbox"
							name="autopayGas">
						<label class="form-check-label" for="autoPaygas2meCheckbox"> ⛽ Autopay gas requests (if you are the recipient)</label>
					</div>



					<div class="form-check">
						<input class="form-check-input" type="checkbox" id="stealthaddrAlwaysOnCheckbox"
							name="stealthAddress">
						<label class="form-check-label" for="stealthaddrAlwaysOnCheckbox"> 🦹‍♂️↔️🦹‍♀️ Stealth addresses always on</label>
					</div>
					<br>
					<br>
					<hr>



					<h4>NOTIFICATIONS</h4>

					<div class="container mt-5">
						<h2>Notification Settings</h2>

						<!-- Toggle Input -->
						<div class="form-check form-switch mt-3">
							<input class="form-check-input" type="checkbox" id="notificationToggle">
							<label class="form-check-label" for="notificationToggle">Enable Notifications</label>
						</div>

						<!-- Notification Message -->
						<div id="notificationMessage" class="alert alert-success">
							Notifications are now enabled.
						</div>

					</div>

					<br>
					<br>
					<hr>

					<!-- ----------------------------- -->
					<h4>Language</h4>

					<div class="options">

						<select class="right translation" id="langswitch">
							<option value="en">en</option>
							<option value="fr">fr</option>
							<option value="es">es</option>
						</select>
					</div>
					<div style="display: block;">
						<hr>


						<h4>Contacts</h4>
						<button class="btn btn-primary" onclick="event.stopPropagation();saveContacts()"><svg
								xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">
								<path fill="currentColor"
									d="M64 32C28.7 32 0 60.7 0 96L0 416c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-242.7c0-17-6.7-33.3-18.7-45.3L352 50.7C340 38.7 323.7 32 306.7 32L64 32zm0 96c0-17.7 14.3-32 32-32l192 0c17.7 0 32 14.3 32 32l0 64c0 17.7-14.3 32-32 32L96 224c-17.7 0-32-14.3-32-32l0-64zM224 288a64 64 0 1 1 0 128 64 64 0 1 1 0-128z" />
							</svg> Save</button>


						<button class="btn btn-primary" onclick="event.stopPropagation();importContacts()">
							<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512">
								<path fill="currentColor"
									d="M128 64c0-35.3 28.7-64 64-64L352 0l0 128c0 17.7 14.3 32 32 32l128 0 0 288c0 35.3-28.7 64-64 64l-256 0c-35.3 0-64-28.7-64-64l0-112 174.1 0-39 39c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l80-80c9.4-9.4 9.4-24.6 0-33.9l-80-80c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l39 39L128 288l0-224zm0 224l0 48L24 336c-13.3 0-24-10.7-24-24s10.7-24 24-24l104 0zM512 128l-128 0L384 0 512 128z" />
							</svg>
							Import</button>
						<input type="file" id="fileInput" accept=".json" style="display: none;">


						<br>
						<!-- <div class="options" id="">
								<input type="checkbox" id="saveToDID" name="save2did">
								<label for="save2did">Save to DID</label>
							</div> -->
					</div>

					<div style="display: none;">
						<hr>


						<h4>Signatures to broadcast</h4>

						<ul class="options" id="sig2Broadcast">
							<li>lkasdmfklnsfdlkgnsdfpgioenpwnglkfdsxnclkdsnklfdnsalkfnldksanflksndfl</li>
							<li>nrew,nernpnvopxcoivopcxiovidopixcopvioxcpvocxipvoickxpvoicxopviocpx</li>


							<button class="btn btn-primary">publish</button>
							<span>
								<input type="checkbox" id="muteCheckbox" name="muteCheckbox">
								<label for="muteCheckbox">AutoPublish(when its connected to the internet)</label>
							</span>

						</ul>
					</div>

					<hr>


					<h4>Chats</h4>

					<button type="button" id="" class="btn btn-primary"
						onclick="event.stopPropagation(); createGroupChat()" disabled>

						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" height="16" width="16">
							<path fill="currentColor"
								d="M72 88a56 56 0 1 1 112 0A56 56 0 1 1 72 88zM64 245.7C54 256.9 48 271.8 48 288s6 31.1 16 42.3V245.7zm144.4-49.3C178.7 222.7 160 261.2 160 304c0 34.3 12 65.8 32 90.5V416c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V389.2C26.2 371.2 0 332.7 0 288c0-61.9 50.1-112 112-112h32c24 0 46.2 7.5 64.4 20.3zM448 416V394.5c20-24.7 32-56.2 32-90.5c0-42.8-18.7-81.3-48.4-107.7C449.8 183.5 472 176 496 176h32c61.9 0 112 50.1 112 112c0 44.7-26.2 83.2-64 101.2V416c0 17.7-14.3 32-32 32H480c-17.7 0-32-14.3-32-32zm8-328a56 56 0 1 1 112 0A56 56 0 1 1 456 88zM576 245.7v84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM320 32a64 64 0 1 1 0 128 64 64 0 1 1 0-128zM240 304c0 16.2 6 31 16 42.3V261.7c-10 11.3-16 26.1-16 42.3zm144-42.3v84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM448 304c0 44.7-26.2 83.2-64 101.2V448c0 17.7-14.3 32-32 32H288c-17.7 0-32-14.3-32-32V405.2c-37.8-18-64-56.5-64-101.2c0-61.9 50.1-112 112-112h32c61.9 0 112 50.1 112 112z" />
						</svg>

						CREATE MULTISIG GRUPAL CHAT</button>
					<!-- scan this qr to be added to this group -->


					<button type="button" id="" class="btn btn-primary"
						onclick="event.stopPropagation(); createGroupChat()" disabled>

						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" height="16" width="16">
							<path fill="currentColor"
								d="M72 88a56 56 0 1 1 112 0A56 56 0 1 1 72 88zM64 245.7C54 256.9 48 271.8 48 288s6 31.1 16 42.3V245.7zm144.4-49.3C178.7 222.7 160 261.2 160 304c0 34.3 12 65.8 32 90.5V416c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V389.2C26.2 371.2 0 332.7 0 288c0-61.9 50.1-112 112-112h32c24 0 46.2 7.5 64.4 20.3zM448 416V394.5c20-24.7 32-56.2 32-90.5c0-42.8-18.7-81.3-48.4-107.7C449.8 183.5 472 176 496 176h32c61.9 0 112 50.1 112 112c0 44.7-26.2 83.2-64 101.2V416c0 17.7-14.3 32-32 32H480c-17.7 0-32-14.3-32-32zm8-328a56 56 0 1 1 112 0A56 56 0 1 1 456 88zM576 245.7v84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM320 32a64 64 0 1 1 0 128 64 64 0 1 1 0-128zM240 304c0 16.2 6 31 16 42.3V261.7c-10 11.3-16 26.1-16 42.3zm144-42.3v84.7c10-11.3 16-26.1 16-42.3s-6-31.1-16-42.3zM448 304c0 44.7-26.2 83.2-64 101.2V448c0 17.7-14.3 32-32 32H288c-17.7 0-32-14.3-32-32V405.2c-37.8-18-64-56.5-64-101.2c0-61.9 50.1-112 112-112h32c61.9 0 112 50.1 112 112z" />
						</svg>

						JOIN GROUPE TRHOUGH QR</button>

				</div>



				<div class="modal-footer d-flex justify-content-center">
					<button type="button" class="btn btn-primary btn-lg" onclick="lock()"><svg
							xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="18" height="16">
							<path fill="currentColor"
								d="M144 144l0 48 160 0 0-48c0-44.2-35.8-80-80-80s-80 35.8-80 80zM80 192l0-48C80 64.5 144.5 0 224 0s144 64.5 144 144l0 48 16 0c35.3 0 64 28.7 64 64l0 192c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64L0 256c0-35.3 28.7-64 64-64l16 0z" />
						</svg>LOCK</button>
				</div>

			</div>
		</div>
	</div>
	<!-- SETTINGS SETTINGS -->


	<!-- walletReceive -->
	<!-- Modal WALLET RECEIVE/-->
	<div class="modal fade" id="walletReceive" tabindex="-1" aria-labelledby="walletReceiveLabel" aria-hidden="true"
		data-bs-backdrop="static">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="walletReceiveLabel">ReceiveTransaction</h5>
					<button type="button" id="walletReceiveXClose" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>


				<div class="modal-body">


					<div id="qrtreceive" class="">
						<div class="responsive-svg" id="receivecanvas"></div>
					</div>



					<ul class="nav nav-tabs" id="myReceiveTab" role="tablist" style="display: none;">
						<li class="nav-item" role="presentation">
							<button class="nav-link active" id="Receiveform-tab" data-bs-toggle="tab"
								data-bs-target="#form" type="button" role="tab" aria-controls="form"
								aria-selected="true">Form</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="Receiveconfirmation-tab" data-bs-toggle="tab"
								data-bs-target="#confirmation" type="button" role="tab" aria-controls="confirmation"
								aria-selected="false">Confirmation</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="Receiveresult-tab" data-bs-toggle="tab"
								data-bs-target="#result" type="button" role="tab" aria-controls="result"
								aria-selected="false">Result</button>
						</li>
					</ul>



					<div class="tab-content" id="walletReceiveContent">
						<div class="tab-pane fade show active" id="form" role="tabpanel" aria-labelledby="form-tab">

							<form id="ReceivetransactionForm">



								<div id="ReceivestealthInfo" class=" mb-3 list-group-item list-group-item-warning">
									<label for="receivesarecipientAddress" class="form-label">Stealth Address Balance
									</label>
									<div id="ReceivesarecipientAddress" class="wwrap"></div>
									<div id="ReceivestaddrInfo" class=""></div>
								</div>


							</form>
						</div>

						<!-- Confirmation Screen -->
						<div class="tab-pane fade" id="Receiveconfirmation" role="tabpanel"
							aria-labelledby="confirmation-tab">
							<h5>Confirm Transaction</h5>
							<p id="ReceivetransactionDetails"></p>
							<button type="button" class="btn btn-secondary"
								id="cancelReceiveTransactionBtn">Cancel</button>
							<button type="button" class="btn btn-primary"
								id="confirmReceiveTransactionBtn">Confirm</button>
						</div>

						<!-- Result Screen -->
						<div class="tab-pane fade" id="Receiveresult" role="tabpanel" aria-labelledby="result-tab">
							<h5>Receive Transaction Result</h5>
							<p id="ReceiveresultMessage"></p>
							<button type="button" class="btn btn-primary" data-bs-dismiss="modal"
								id="walletReceiveClose">Close</button>
						</div>
					</div>



				</div>
			</div>
		</div>
	</div>


	<!-- fin RECEIVE WALLET-->





	<!-- Modal WALLET SEND/-->
	<div class="modal fade" id="walletSend" tabindex="-1" aria-labelledby="walletSendLabel" aria-hidden="true"
		data-bs-backdrop="static">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<section id="bigBalanceWalletsendmodal">
						<span class="top"> Arbitrum Sepolia(461614):</span>
						<span class="bal">-999.9999</span>
						<span class="eth">ETH</span>

					</section>



					<button type="button" id="walletSendXClose" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>

				</div>


				<div class="modal-body">
					<!-- Navigation for Screens -->
					<ul class="nav nav-tabs" id="myTab" role="tablist" style="display: none;">
						<li class="nav-item" role="presentation">
							<button class="nav-link active" id="preparetx-tab" data-bs-toggle="tab"
								data-bs-target="#preparetx" type="button" role="tab" aria-controls="form"
								aria-selected="true">Form</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="confirmation-tab" data-bs-toggle="tab"
								data-bs-target="#confirmation" type="button" role="tab" aria-controls="confirmation"
								aria-selected="false">Confirmation</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="result-tab" data-bs-toggle="tab" data-bs-target="#result"
								type="button" role="tab" aria-controls="result" aria-selected="false">Result</button>
						</li>
					</ul>



					<div class="tab-content" id="walletSendContent">
						<!-- Form Screen -->
						<div class="tab-pane fade show active" id="preparetx" role="tabpanel"
							aria-labelledby="preparetx-tab">

							<form id="transactionForm">


								<div class="input-group mb-3">
									<span class="input-group-text iusbutton">Token</span>
									<select class="form-select token-selector" id="tokenType"> </select>
									<span id="fixedtokenType" style="display: none;"> </span>
								</div>


								<div class="mb-3 fullwith">
									<span class="input-group-text iusbutton" for="recipientAddress">Recipient
										Address</span>
									<input type="text" class="form-control" id="recipientAddress" placeholder="0x..."
										required readonly>
								</div>


								<!-- <div id="stealthInfo" class=" mb-3 list-group-item list-group-item-warning"> -->

								<div id="stealthSection" class=" mb-3 list-group-item list-group-item-warning">
									<!-- <input class="form-check-input" type="checkbox" id="walletmodalstealthAddressCheckbox" name="stealthAddress"> -->
									<input class="form-check-input" type="checkbox" id="stealthAddressCheckbox"
										name="stealthAddress">
									<label for="sarecipientAddress" class="form-label">🦹‍♂️ Stealth Address 🦹‍♀️ </label>
										<div id="stealthInfo">

											<div id="sarecipientAddress" class="wwrap"></div>
										</div>
									<div id="staddrInfo" class=""></div>
								</div>


								<div class="input-group mb-3" id="amountsendgroup">
									<input type="number" class="form-control" id="amount" placeholder="0.00" step="0.01"
										min="0" required="">
									<span class="input-group-text iusbutton">Amount</span>

									<div class="invalid-feedback">
										Please enter a valid amount.
									</div>
								</div>





								<div id="erc20Details" class="mb-3 d-none">
									<label for="erc20ContractAddress" class="form-label">ERC-20 Contract Address</label>
									<input type="text" class="form-control" id="erc20ContractAddress"
										placeholder="0x...">
								</div>
								<button type="button" class="btn btn-primary fullwidth" id="sendTransactionBtn">
									<svg xmlns="http://www.w3.org/2000/svg" height="16" width="20"
										viewBox="0 0 512 512">
										<path fill="currentColor"
											d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480V396.4c0-4 1.5-7.8 4.2-10.7L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z">
										</path>
									</svg>Send</button>
							</form>
						</div>

						<!-- Confirmation Screen -->
						<div class="tab-pane fade" id="confirmation" role="tabpanel" aria-labelledby="confirmation-tab">
							<h5>Confirm Transaction</h5>
							<p id="transactionDetails"></p>
							<button type="button" class="btn btn-secondary" id="cancelTransactionBtn">Cancel</button>
							<button type="button" class="btn btn-primary" id="confirmTransactionBtn">Confirm</button>
						</div>

						<!-- Result Screen -->
						<div class="tab-pane fade" id="result" role="tabpanel" aria-labelledby="result-tab">
							<h5>Transaction Result</h5>
							<p id="resultMessage"></p>
							<button type="button" class="btn btn-primary" data-bs-dismiss="modal"
								id="walletSendClose">Close</button>
						</div>
					</div>



				</div>
			</div>
		</div>
	</div>


	<!-- fin SEND WALLET-->



	<!-- ---------------------------------------------- -->
	<!--  Modal addNewToken -->
	<!-- ---------------------------------------------- -->
	<div class="modal fade" id="addNewTokenModal" tabindex="-1" aria-labelledby="addNewTokenModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="addNewTokenModalLabel">Add Token</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">


					<div class="mb-3">
						<label for="autoComplete" class="form-label">Select EVM chain</label>
						<div class="input-group">
							<span class="input-group-text">
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#d17c78"
									class="bi bi-search" viewBox="0 0 16 16">
									<path
										d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.415l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
								</svg>
							</span>
							<input type="search" class="form-control" id="autoComplete" placeholder="Enter search term"
								tabindex="1">
						</div>
					</div>



					<div class="selection"></div>

					<div class="alert alert-warning alert-dismissible fade show" id="selectionResult"
						style="display: none;"> </div>

					<!-- ERC-20 Options -->
					<div id="erc20SetContract" class="mt-3" style="display: none;">

						<!-- Contract Address Selector -->
						<div class="mb-3">
							<label for="contractAddress" class="form-label">ERC-20 Smart Contract Address</label>
							<input type="text" class="form-control" id="contractAddress" placeholder="0x..." required
								pattern="^0x[a-fA-F0-9]{40}$">
							<div class="invalid-feedback">
								Please provide a valid Ethereum smart contract address (0x followed by 40 hex
								characters).
							</div>
							<div class="valid-feedback">
								Looks good!
								<span id="validLink"></span>
							</div>
						</div>

						<button type="button" class="btn btn-primary" id="addERC20contract" onclick="addConctract()"
							style="display: none;">Add ERC-20</button>
					</div>


					<button type="button" class="btn btn-primary" id="addNativeToken" onclick="addConctract()"
						style="display: none;">Add Native Token</button>



				</div>


				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>




	<!-- ---------------------------------------------- -->
	<!--  Modal defaultToken -->
	<!-- ---------------------------------------------- -->
	<div class="modal fade" id="defaultTokenModal" tabindex="-1" aria-labelledby="defaultTokenModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="defaultTokenModalLabel">Default Token</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">





				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
	</div>






	<!-- Modal addDocument -->
	<div class="modal fade" data-bs-backdrop="static" id="addDocument" tabindex="-1" role="dialog"
		aria-labelledby="uplodad2ipfs" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" data-translate="title" id="uplodad2ipfs">Upload to IPFS</h5>
				</div>
				<div class="modal-body">

					<div id="headModal"></div>
					<div class="input-group">
						<label class="input-group-btn">
							<span class="btn btn-primary">
								Browse
								<input type="file" style="display: none;" name="Upload" class="form-control"
									accept="application/pdf" id="input_image">
							</span>
						</label>

						<input type="text" id="fileToUpload" class="form-control " readonly>
					</div>
					<input type="text" class="form-control taskInput " id="taskInput" placeholder="Title"
						aria-describedby="inputGroupPrepend3" required autocomplete="off">

					<div id="success_message" class="alert alert-success" role="alert" style="display: none;"></div>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary  " data-bs-dismiss="modal"
						data-translate="close">Close</button>
					<button type="button" class="btn btn-outline-primary  " id="submit_button"
						data-translate="upload">Upload</button>
					<button style='display: none;' type="button" class="btn btn-primary" data-translate="addanother"
						id="addAnother_button">Add another</button>

				</div>
			</div>
		</div>
	</div>
	<!-- fin MODAL -->



	<!-- WALLET BALANCES MODAL  -->
	<div class="modal fade" id="walletModal" data-bs-backdrop="static" tabindex="-1"
		aria-labelledby="settingsModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
			<!-- <h1>WALLET</h1> -->
			<h5 class="modal-title" id="">WALLET BALANCES </h5>


					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>


				<div class="modal-body" id="walletCardContainer">
					
					<section id="bigBalanceWalletmodal">
						<span class="top"> Arbitrum Sepolia(461614):</span>
						<span class="bal">-999.9999</span>
						<span class="eth">ETH</span>
						<span class="bottom">
							<a class="miniversion" target="_blank" rel="noopener noreferrer" href="">gas: 0.0002</a>
						</span>

					</section>
					<h4>TOKEN</h4>

					<select class="form-select mb-3 token-selector"  id="erc20Selectorbis"> </select>
					<!-- <select class="form-select mb-3" id="erc20Selector"> </select> -->
					<!-- <button type="button" class="btn btn-primary mt-2" id="" onclick="addToken()">+ Add</button>
					<button type="button" class="btn btn-danger mt-2" id="removeErc20Address">Remove</button>
					<button type="button" class="btn btn-info mt-2" id="infoErc20Address">Info</button> -->
					<br>
					<br>
					<hr>
					<!-- -------------------------- -->
					<h4>PUBLIC</h4>

					<p class="amount">3.493 <span class="secondary currency-name">ETH</span> <span
							class="tertiary">(arb)</span> </p>
					<p class="coin-value">0.0432 <span class="secondary  currency-name">BTC</span> </p>

					<br>
					<br>
					<hr>

					<!-- ----------------------------- -->

					<!-- -------------------------- -->
					<h4>PRIVATE</h4>
					<!-- <ul> -->

					<!-- <h4 class="tertiary">Total</h4> -->
					<p class="amount">1.493 <span class="secondary" id="currency-name">ETH</span> 👤 from Claude
						<button type="button" id="" class="sendto" onclick="event.stopPropagation(); send()" disabled>
							SEND TO </button>
						<button type="button" id="" class="claim" onclick="event.stopPropagation(); claim()" disabled>
							CLAIM </button>
					</p>
					<p class="coin-value">982.40 <span class="secondary currency-name">USD</span> 👤 from Dan
						<button type="button" id="" class="sendto" onclick="event.stopPropagation(); send()" disabled>
							SEND TO </button>
						<button type="button" id="" class="claim" onclick="event.stopPropagation(); claim()" disabled>
							CLAIM </button>
					</p>
					<p class="coin-value">0.1038 <span class="secondary  currency-name">BTC
							<button type="button" id="" class="sendto" onclick="event.stopPropagation(); send()"
								disabled> SEND TO </button>
							<button type="button" id="" class="claim" onclick="event.stopPropagation(); claim()"
								disabled> CLAIM </button>

						</span></p>

					<!-- <div id="">
								<h4 class="tertiary">Total</h4>
								<p class="amount">1.493 <span class="secondary currency-name">ETH</span></p>
								<p class="coin-value">982.40 <span class="secondary currency-name">USD</span></p>
								<p class="coin-value">0.1038 <span class="secondary currency-name">BTC</span></p>
							  </div> -->
					<!-- <li> <label class="form-check-label" for="stealthAddressCheckbox">👤  from Claude: 0.01ETH(arb-sep) </label> 
						
					<button type="button" id="" class="btn btn-primary" onclick="event.stopPropagation(); send()" disabled> SEND TO </button>
					<button type="button" id="" class="btn btn-primary" onclick="event.stopPropagation(); claim()" disabled> CLAIM </button>
						</li>
						<li> <label class="form-check-label" for="stealthAddressCheckbox">👤  from Dan: 0.0011ETH(arb-sep) </label> 
							
					<button type="button" id="" class="btn btn-primary" onclick="event.stopPropagation(); send()" disabled> SEND TO </button>
					<button type="button" id="" class="btn btn-primary" onclick="event.stopPropagation(); claim()" disabled> CLAIM </button>
						</li>
						<li> <label class="form-check-label" for="stealthAddressCheckbox">👤  from  Emily: 12 USDC(arb-sep) </label>
							
					<button type="button" id="" class="btn btn-primary" onclick="event.stopPropagation(); send()" disabled> SEND TO</button>
					<button type="button" id="" class="btn btn-primary" onclick="event.stopPropagation(); claim()" disabled> CLAIM </button>
						 </li> -->
					<!-- </ul> -->






					<br>
					<br>
					<hr>

					<!-- ----------------------------- -->






				</div>



				<div class="modal-footer d-flex justify-content-center">
					<button type="button" class="btn btn-primary btn-lg" onclick="lock()"><svg
							xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="18" height="16">
							<path fill="currentColor"
								d="M144 144l0 48 160 0 0-48c0-44.2-35.8-80-80-80s-80 35.8-80 80zM80 192l0-48C80 64.5 144.5 0 224 0s144 64.5 144 144l0 48 16 0c35.3 0 64 28.7 64 64l0 192c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64L0 256c0-35.3 28.7-64 64-64l16 0z" />
						</svg>LOCK</button>
				</div>

			</div>
		</div>
	</div>
	<!-- fin WALLET BALANCES MODAL  -->



	<!-- /*********************************************************************************************
  .) FIN MODALS
  **********************************************************************************************/ -->


	<script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/autoComplete.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.29/Tone.min.js"></script>
	<script src="js/ethers-6.13.2.umd.min.js"></script>

	<script type="module" src="js/demo1.js"></script>
	<script src="js/dictionary.js"></script>
	<script type="module">
		// XMTP
		import { Client } from '@xmtp/xmtp-js'
		window.Client = Client;

		import QrScanner from "qr-scanner/qr-scanner.min.js";
		window.QrScanner = QrScanner; //make global
		QrScanner.hasCamera(); // test

		import { Polybase } from "@polybase/client";
		window.Polybase = Polybase; //make global

		import Cropper from 'cropperjs'
		window.Cropper = Cropper; //make global
		import { throttle } from '@github/mini-throttle'
		window.throttle = throttle; //make global

		import EthCrypto from 'eth-crypto';
		window.EthCrypto = EthCrypto;

		import lighthouse from '@lighthouse-web3/sdk'
		window.lighthouse = lighthouse

		import { getPublicKey, utils } from '@noble/secp256k1';
		import * as secp from '@noble/secp256k1';
		window.getPublicKey = getPublicKey;
		window.utils = utils;
		window.secp = secp;

	</script>

	<script>


		/*********************************************************************************************
		.) VARIABLES
		// https://sepolia.etherscan.io/address/0xc4bF5CbDaBE595361438F8c6a187bDc330539c60#code

		**********************************************************************************************/
		const apiKeyLighthouse = '0e06cd16.4d3bf2536b7c4219bfb7520bd7b7346e';//lighthouse
		const INFURA_API_KEY = "9219faae2bac4d24b95c2d967b22005a"; // Replace with your actual Infura API key

		window.optionsList = [
			{
				"ERC20_TOKEN_ADDRESS": "0x3723A0d04ABDFA902d47426973E0cb49C2fC3B86",//trok arb sepolia
				"ERC20_TOKEN_ABI": 'troktoken',
				"REGISTRY_CONTRACT_ADDRESS": "0xEeF51be62Cc32e2f7c0Bf490a7ED355A2e7a0a3A",
				"TOKEN_CHAIN_NAME": 'ARBITRUM(SEPOLIA)',
				"TOKEN_NAME": "TROK",
				"SYMBOL": "TROK",
				"API": 'https://arbitrum-sepolia.blockpi.network/v1/rpc/public',
				"TOKEN_CHAINID": '421614',
				"EXPLORER": 'https://sepolia.arbiscan.io/',
				'IPFS_GATEWAY': 'https://gateway.lighthouse.storage/ipfs/',
				"POLYBASE_DB": "https://explorer.testnet.polybase.xyz/studio/pk%2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3%2FSTARKID/collections/STARKID",
				"ZK_PUBKEY": "2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3"
			},
			{
				"ERC20_TOKEN_ADDRESS": "0x6DE727032A1B2B93B430873b52eebf20FD44180E",//trok arb sepolia
				"REGISTRY_CONTRACT_ADDRESS": "0xEeF51be62Cc32e2f7c0Bf490a7ED355A2e7a0a3A",
				"TOKEN_CHAIN_NAME": 'ARBITRUM(SEPOLIA)',
				"TOKEN_NAME": "TROK",
				"SYMBOL": "TROK",
				"API": 'https://arbitrum-sepolia.blockpi.network/v1/rpc/public',
				"TOKEN_CHAINID": '421614',
				"EXPLORER": 'https://sepolia.arbiscan.io/',
				"ERC20_TOKEN_ABI": 'troktoken',
				"POLYBASE_DB": "https://explorer.testnet.polybase.xyz/studio/pk%2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3%2FSTARKID/collections/STARKID",
				"ZK_PUBKEY": "2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3"
			},
			{
				"ERC20_TOKEN_ADDRESS": "0x4874d782022507E9a4F82C6D6Df32e332A8D30fB",//trok arb sepolia
				"REGISTRY_CONTRACT_ADDRESS": "0xEeF51be62Cc32e2f7c0Bf490a7ED355A2e7a0a3A",
				"TOKEN_CHAIN_NAME": 'ARBITRUM(SEPOLIA)',
				"TOKEN_NAME": "TROK",
				"SYMBOL": "TROK",
				"API": 'https://arbitrum-sepolia.blockpi.network/v1/rpc/public',
				"TOKEN_CHAINID": '421614',
				"EXPLORER": 'https://sepolia.arbiscan.io/',
				"ERC20_TOKEN_ABI": 'troktoken',
				"POLYBASE_DB": "https://explorer.testnet.polybase.xyz/studio/pk%2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3%2FSTARKID/collections/STARKID",
				"ZK_PUBKEY": "2F0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3"
			},

		]


		ABIs = {
			troktoken: [{ "inputs": [], "stateMutability": "nonpayable", "type": "constructor" }, { "inputs": [], "name": "AccessControlBadConfirmation", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }, { "internalType": "bytes32", "name": "neededRole", "type": "bytes32" }], "name": "AccessControlUnauthorizedAccount", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "approve", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "ECDSAInvalidSignature", "type": "error" }, { "inputs": [{ "internalType": "uint256", "name": "length", "type": "uint256" }], "name": "ECDSAInvalidSignatureLength", "type": "error" }, { "inputs": [{ "internalType": "bytes32", "name": "s", "type": "bytes32" }], "name": "ECDSAInvalidSignatureS", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "allowance", "type": "uint256" }, { "internalType": "uint256", "name": "needed", "type": "uint256" }], "name": "ERC20InsufficientAllowance", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "sender", "type": "address" }, { "internalType": "uint256", "name": "balance", "type": "uint256" }, { "internalType": "uint256", "name": "needed", "type": "uint256" }], "name": "ERC20InsufficientBalance", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "approver", "type": "address" }], "name": "ERC20InvalidApprover", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "receiver", "type": "address" }], "name": "ERC20InvalidReceiver", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "sender", "type": "address" }], "name": "ERC20InvalidSender", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }], "name": "ERC20InvalidSpender", "type": "error" }, { "inputs": [{ "internalType": "uint256", "name": "deadline", "type": "uint256" }], "name": "ERC2612ExpiredSignature", "type": "error" }, { "inputs": [{ "internalType": "address", "name": "signer", "type": "address" }, { "internalType": "address", "name": "owner", "type": "address" }], "name": "ERC2612InvalidSigner", "type": "error" }, { "inputs": [{ "internalType": "bytes32", "name": "role", "type": "bytes32" }, { "internalType": "address", "name": "account", "type": "address" }], "name": "grantRole", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }, { "internalType": "uint256", "name": "currentNonce", "type": "uint256" }], "name": "InvalidAccountNonce", "type": "error" }, { "inputs": [], "name": "InvalidShortString", "type": "error" }, { "inputs": [{ "internalType": "string", "name": "str", "type": "string" }], "name": "StringTooLong", "type": "error" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "owner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "spender", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Approval", "type": "event" }, { "anonymous": false, "inputs": [], "name": "EIP712DomainChanged", "type": "event" }, { "inputs": [{ "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "mint", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "uint256", "name": "deadline", "type": "uint256" }, { "internalType": "uint8", "name": "v", "type": "uint8" }, { "internalType": "bytes32", "name": "r", "type": "bytes32" }, { "internalType": "bytes32", "name": "s", "type": "bytes32" }], "name": "permit", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "bytes32", "name": "role", "type": "bytes32" }, { "internalType": "address", "name": "callerConfirmation", "type": "address" }], "name": "renounceRole", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "bytes32", "name": "role", "type": "bytes32" }, { "internalType": "address", "name": "account", "type": "address" }], "name": "revokeRole", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "bytes32", "name": "role", "type": "bytes32" }, { "indexed": true, "internalType": "bytes32", "name": "previousAdminRole", "type": "bytes32" }, { "indexed": true, "internalType": "bytes32", "name": "newAdminRole", "type": "bytes32" }], "name": "RoleAdminChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "bytes32", "name": "role", "type": "bytes32" }, { "indexed": true, "internalType": "address", "name": "account", "type": "address" }, { "indexed": true, "internalType": "address", "name": "sender", "type": "address" }], "name": "RoleGranted", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "bytes32", "name": "role", "type": "bytes32" }, { "indexed": true, "internalType": "address", "name": "account", "type": "address" }, { "indexed": true, "internalType": "address", "name": "sender", "type": "address" }], "name": "RoleRevoked", "type": "event" }, { "inputs": [{ "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "transfer", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "from", "type": "address" }, { "indexed": true, "internalType": "address", "name": "to", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Transfer", "type": "event" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "transferFrom", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }], "name": "allowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "decimals", "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "DEFAULT_ADMIN_ROLE", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "DOMAIN_SEPARATOR", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "eip712Domain", "outputs": [{ "internalType": "bytes1", "name": "fields", "type": "bytes1" }, { "internalType": "string", "name": "name", "type": "string" }, { "internalType": "string", "name": "version", "type": "string" }, { "internalType": "uint256", "name": "chainId", "type": "uint256" }, { "internalType": "address", "name": "verifyingContract", "type": "address" }, { "internalType": "bytes32", "name": "salt", "type": "bytes32" }, { "internalType": "uint256[]", "name": "extensions", "type": "uint256[]" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "bytes32", "name": "role", "type": "bytes32" }], "name": "getRoleAdmin", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "bytes32", "name": "role", "type": "bytes32" }, { "internalType": "address", "name": "account", "type": "address" }], "name": "hasRole", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "MAX_MINT_AMOUNT", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "", "type": "address" }], "name": "mintingInfo", "outputs": [{ "internalType": "uint256", "name": "lastMintTimestamp", "type": "uint256" }, { "internalType": "uint256", "name": "amountMinted", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "name", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }], "name": "nonces", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "bytes4", "name": "interfaceId", "type": "bytes4" }], "name": "supportsInterface", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "symbol", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "totalSupply", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "VALIDATOR_ROLE", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }],
			usdctoken: [{ "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "owner", "type": "address" }, { "indexed": true, "internalType": "address", "name": "spender", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Approval", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "authorizer", "type": "address" }, { "indexed": true, "internalType": "bytes32", "name": "nonce", "type": "bytes32" }], "name": "AuthorizationCanceled", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "authorizer", "type": "address" }, { "indexed": true, "internalType": "bytes32", "name": "nonce", "type": "bytes32" }], "name": "AuthorizationUsed", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "_account", "type": "address" }], "name": "Blacklisted", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "newBlacklister", "type": "address" }], "name": "BlacklisterChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "burner", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "Burn", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "newMasterMinter", "type": "address" }], "name": "MasterMinterChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "minter", "type": "address" }, { "indexed": true, "internalType": "address", "name": "to", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "Mint", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "minter", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "minterAllowedAmount", "type": "uint256" }], "name": "MinterConfigured", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "oldMinter", "type": "address" }], "name": "MinterRemoved", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "address", "name": "previousOwner", "type": "address" }, { "indexed": false, "internalType": "address", "name": "newOwner", "type": "address" }], "name": "OwnershipTransferred", "type": "event" }, { "anonymous": false, "inputs": [], "name": "Pause", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "newAddress", "type": "address" }], "name": "PauserChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "newRescuer", "type": "address" }], "name": "RescuerChanged", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "from", "type": "address" }, { "indexed": true, "internalType": "address", "name": "to", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "Transfer", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "_account", "type": "address" }], "name": "UnBlacklisted", "type": "event" }, { "anonymous": false, "inputs": [], "name": "Unpause", "type": "event" }, { "inputs": [], "name": "CANCEL_AUTHORIZATION_TYPEHASH", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "DOMAIN_SEPARATOR", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "PERMIT_TYPEHASH", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "RECEIVE_WITH_AUTHORIZATION_TYPEHASH", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "TRANSFER_WITH_AUTHORIZATION_TYPEHASH", "outputs": [{ "internalType": "bytes32", "name": "", "type": "bytes32" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }], "name": "allowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "approve", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "authorizer", "type": "address" }, { "internalType": "bytes32", "name": "nonce", "type": "bytes32" }], "name": "authorizationState", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_account", "type": "address" }], "name": "blacklist", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "blacklister", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_amount", "type": "uint256" }], "name": "burn", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "authorizer", "type": "address" }, { "internalType": "bytes32", "name": "nonce", "type": "bytes32" }, { "internalType": "uint8", "name": "v", "type": "uint8" }, { "internalType": "bytes32", "name": "r", "type": "bytes32" }, { "internalType": "bytes32", "name": "s", "type": "bytes32" }], "name": "cancelAuthorization", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "authorizer", "type": "address" }, { "internalType": "bytes32", "name": "nonce", "type": "bytes32" }, { "internalType": "bytes", "name": "signature", "type": "bytes" }], "name": "cancelAuthorization", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "minter", "type": "address" }, { "internalType": "uint256", "name": "minterAllowedAmount", "type": "uint256" }], "name": "configureMinter", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "currency", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "decimals", "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "decrement", "type": "uint256" }], "name": "decreaseAllowance", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "increment", "type": "uint256" }], "name": "increaseAllowance", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "string", "name": "tokenName", "type": "string" }, { "internalType": "string", "name": "tokenSymbol", "type": "string" }, { "internalType": "string", "name": "tokenCurrency", "type": "string" }, { "internalType": "uint8", "name": "tokenDecimals", "type": "uint8" }, { "internalType": "address", "name": "newMasterMinter", "type": "address" }, { "internalType": "address", "name": "newPauser", "type": "address" }, { "internalType": "address", "name": "newBlacklister", "type": "address" }, { "internalType": "address", "name": "newOwner", "type": "address" }], "name": "initialize", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "string", "name": "newName", "type": "string" }], "name": "initializeV2", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "lostAndFound", "type": "address" }], "name": "initializeV2_1", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address[]", "name": "accountsToBlacklist", "type": "address[]" }, { "internalType": "string", "name": "newSymbol", "type": "string" }], "name": "initializeV2_2", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_account", "type": "address" }], "name": "isBlacklisted", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "isMinter", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "masterMinter", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_to", "type": "address" }, { "internalType": "uint256", "name": "_amount", "type": "uint256" }], "name": "mint", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "minter", "type": "address" }], "name": "minterAllowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "name", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }], "name": "nonces", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "pause", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "paused", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "pauser", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "uint256", "name": "deadline", "type": "uint256" }, { "internalType": "bytes", "name": "signature", "type": "bytes" }], "name": "permit", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "uint256", "name": "deadline", "type": "uint256" }, { "internalType": "uint8", "name": "v", "type": "uint8" }, { "internalType": "bytes32", "name": "r", "type": "bytes32" }, { "internalType": "bytes32", "name": "s", "type": "bytes32" }], "name": "permit", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "uint256", "name": "validAfter", "type": "uint256" }, { "internalType": "uint256", "name": "validBefore", "type": "uint256" }, { "internalType": "bytes32", "name": "nonce", "type": "bytes32" }, { "internalType": "bytes", "name": "signature", "type": "bytes" }], "name": "receiveWithAuthorization", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "uint256", "name": "validAfter", "type": "uint256" }, { "internalType": "uint256", "name": "validBefore", "type": "uint256" }, { "internalType": "bytes32", "name": "nonce", "type": "bytes32" }, { "internalType": "uint8", "name": "v", "type": "uint8" }, { "internalType": "bytes32", "name": "r", "type": "bytes32" }, { "internalType": "bytes32", "name": "s", "type": "bytes32" }], "name": "receiveWithAuthorization", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "minter", "type": "address" }], "name": "removeMinter", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "contract IERC20", "name": "tokenContract", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "rescueERC20", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "rescuer", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "symbol", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "totalSupply", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "transfer", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }], "name": "transferFrom", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "uint256", "name": "validAfter", "type": "uint256" }, { "internalType": "uint256", "name": "validBefore", "type": "uint256" }, { "internalType": "bytes32", "name": "nonce", "type": "bytes32" }, { "internalType": "bytes", "name": "signature", "type": "bytes" }], "name": "transferWithAuthorization", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "from", "type": "address" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "value", "type": "uint256" }, { "internalType": "uint256", "name": "validAfter", "type": "uint256" }, { "internalType": "uint256", "name": "validBefore", "type": "uint256" }, { "internalType": "bytes32", "name": "nonce", "type": "bytes32" }, { "internalType": "uint8", "name": "v", "type": "uint8" }, { "internalType": "bytes32", "name": "r", "type": "bytes32" }, { "internalType": "bytes32", "name": "s", "type": "bytes32" }], "name": "transferWithAuthorization", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_account", "type": "address" }], "name": "unBlacklist", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "unpause", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_newBlacklister", "type": "address" }], "name": "updateBlacklister", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_newMasterMinter", "type": "address" }], "name": "updateMasterMinter", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "_newPauser", "type": "address" }], "name": "updatePauser", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "newRescuer", "type": "address" }], "name": "updateRescuer", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [], "name": "version", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "pure", "type": "function" }],
		}

		erc20Abi = [
			"function totalSupply() view returns (uint256)",
			"function balanceOf(address account) view returns (uint256)",
			"function transfer(address recipient, uint256 amount) returns (bool)",
			"function transferFrom(address sender, address recipient, uint256 amount) returns (bool)",
			"function approve(address spender, uint256 amount) returns (bool)",
			"function allowance(address owner, address spender) view returns (uint256)",
			"function symbol() view returns (string)",
			"function decimals() view returns (uint8)"  // Added the decimals function
		];




		async function init(signer) {


			console.log(`

██╗██╗   ██╗███████╗
██║██║   ██║██╔════╝
██║██║   ██║███████╗
██║██║   ██║╚════██║
██║╚██████╔╝███████║
╚═╝ ╚═════╝ ╚══════╝
                    

███╗   ██╗ █████╗ ████████╗██╗   ██╗██████╗  █████╗ ██╗     ██╗███████╗
████╗  ██║██╔══██╗╚══██╔══╝██║   ██║██╔══██╗██╔══██╗██║     ██║██╔════╝
██╔██╗ ██║███████║   ██║   ██║   ██║██████╔╝███████║██║     ██║███████╗
██║╚██╗██║██╔══██║   ██║   ██║   ██║██╔══██╗██╔══██║██║     ██║╚════██║
██║ ╚████║██║  ██║   ██║   ╚██████╔╝██║  ██║██║  ██║███████╗██║███████║
╚═╝  ╚═══╝╚═╝  ╚═╝   ╚═╝    ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝╚══════╝╚═╝╚══════╝
                                                                       
                               
																				

`);
			console.log('init()')

			reloadTranslations()
			
			// PARA QUE CARGUE MAS RAPIDO///
			loadContacts()
			// await loadContacts()

			// Check if password exists in sessionStorage
			const storedPassword = sessionStorage.getItem("password");
			if (storedPassword) {
				console.log("Password found in sessionStorage!!");
			} else {
				console.log("No password found in sessionStorage.");
			}



			// Check if siger is passed at into this function
			if (typeof signer === 'undefined') {
				console.warn('No signer passed at init()');

				signer = await getSigner();
				if (signer === false) {
					console.log("The function returned false.");
					return;
				}
			} else {
				console.warn("SIGNER:", signer);
			}



			// --------------
			// SET ADDRESS
			console.warn('EVM ADDRESS (getSigner): ', signer.address)
			setAddress(signer.address)

			// CREATE CHAT
			await createXMPTchat(signer);

			// --------------
			// LOAD DEFAULT TOKENS
			// - USDC(erc20/ arbitrum sepolia) ==> FAUCET: 
			// - ETH( native token/ arbitrum sepolia) ==> FAUCET: 
			// --------------
			let storedData = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];
			if (storedData.length === 0) {
				console.log('🤷 There are no tokens (ERC20_TOKENS)  in localstorage we  add USDC(arbitrum sepolia) as default ')
				const defaultToken = {
					tokenName: "USDC",
					chainName: "Arbitrum Sepolia",
					chainId: 421614,
					contractAddr: "0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d",  // Example contract address
					rpcs: ["https://arbitrum-sepolia.infura.io/v3/9219faae2bac4d24b95c2d967b22005a"],   // Example RPC endpoint
					explorers: [{ "name": "Arbitrum Sepolia Arbiscan Testnet Explorer", "url": "https://sepolia.arbiscan.io", "standard": "EIP3091" }] // Example explorer
				};
				storedData.push(defaultToken);

				const defaultTokenB = {
					tokenName: "ETH(arb)",
					chainName: "Arbitrum Sepolia",
					chainId: 421614,
					contractAddr: "nativeToken",  // Example contract address
					rpcs: ["https://arbitrum-sepolia.infura.io/v3/9219faae2bac4d24b95c2d967b22005a"],   // Example RPC endpoint
					explorers: [{ "name": "Arbitrum Sepolia Arbiscan Testnet Explorer", "url": "https://sepolia.arbiscan.io", "standard": "EIP3091" }] // Example explorer
				};


				storedData.push(defaultTokenB);

				localStorage.setItem('ERC20_TOKENS', JSON.stringify(storedData));
			}

			// --------------
			// LOAD BALANCE
			// --------------
			let currentTokenContract = await loadToken(signer.address)
			console.log("currentTokenContract()", currentTokenContract)
			console.warn('USER ADDRESS', signer.address)

			// parece que estaba dos veces aca
			// loadContacts(signer.address)



			// POPULATE TOKEN SELECTORS
			populateTokenSelector()
			// populateSelectInput()//defaul #erc20Selector
			// populateSelectInput('tokenType');//populate selec input inside wallet send
			// populateSelectInput('erc20Selectorbis');//faltaria este
			loadSettingsPreferences()// All options in settings MODAL UI-language-notif

			// -----------

			// LOAD DID
			await loadDID(signer)




			// -----------------------------------------
			// CHECK IF USER IS ARROBED
			// -----------------------------------------

			// Get the current URL
			const currentUrl = window.location.href;
			const url = new URL(currentUrl);
			const pathname = url.pathname;
			// Define the pattern to match the "/@username" part
			const pattern = /^\/@(\w+)/;

			// Check if the pathname matches the pattern
			const match = pathname.match(pattern);

			if (match) {
				// Extract the username from the pathname
				const username = match[1];

				// Do something with the username
				console.warn(`Username detected: ${username}`);
				// Example: Redirect or load user-specific content
				// window.location.href = `/user/${username}`;
			} else {
				console.log("No username detected in the URL.");
			}
			// ----------------------------------------------------------------------------------
			//  CHECK IF USER COMES FROM A LINK
			// ----------------------------------------------------------------------------------
			const urlParams = new URLSearchParams(window.location.search);

			const chatValue = urlParams.get('chat');
			if (chatValue !== null) {

				console.warn(`( ⤵️⤵️⤵️⤵️comes from a  link)chat FOUND! TRYING TO CHAT WITH: ${chatValue}`);
				openChat()

				// check if has did
				const regexDID = /^did:ius:0x[a-fA-F0-9]{40}$/;
				const regexAddress = /^0x[a-fA-F0-9]{40}$/;
				if (regexDID.test(chatValue)) {
					// IF THIS IS A DID
					const parts = chatValue.split(':');

					// The Ethereum address is the last part
					const ethAddress = parts[parts.length - 1];

					// Optionally, validate the Ethereum address using ethers.js
					if (ethers.isAddress(ethAddress)) {
						console.log("🚀🚀🚀Valid Ethereum Address:", ethAddress);
						evmAddr = ethAddress;

					} else {
						console.log("Invalid Ethereum Address:", ethAddress);
					}

					console.warn('✅ chatValue is in the correct format, FETCHING DID: ', chatValue)

					let didData = await fetchDID(chatValue)
					dd = didData
					let avatar;



					let chatavatar;
					if (didData.data.avatar != '') {
						console.log(' HAS AAVATAR!');
						avatar = didData.data.avatar;
						chatavatar = JSON.parse(avatar)
					} else {
						console.warn(' DOESN\'T HAVE A AVATAR ');
						avatar = "./anonym.jpg"
						chatavatar = avatar
					}

					console.warn(` alias: ${didData.data.alias}`);


					// ?????????????????????????????????????????
					// HAcer aqui o en SaveContactsToLocalStorage la verificacion de si existe un did?
					// ?????????????????????????????????????????
					let contact = { address: didData.data.alias, username: null, avatar: avatar, did: chatValue }
					console.warn('CONTACTO POR URL!', contact)
					SaveContactsToLocalStorage(contact);


					console.warn('chatWith()', evmAddr, chatavatar)
					try { await chatWith(evmAddr, chatavatar) }
					catch (error) { Toast.fire('Error', error.message, "error"); }


				}

				else if (regexAddress.test(chatValue)) {
					// IF THIS IS AN ADDRESS
					console.warn('(⭐ THIS IS AN ADDRES ⭐ )chatValue is and ETH ADDress in the correct format.', chatValue);



					let didData = await fetchDID(chatValue)
					dd = didData
					let avatar;
					let chatavatar;
					if (didData.data.avatar != '') {
						console.log(' HAS AAVATAR!');
						avatar = didData.data.avatar;
						chatavatar = JSON.parse(avatar)
					} else {
						console.warn(' DOESN\'T HAVE A AVATAR ');
						avatar = "anonym.jpg"
						// avatar = "./anonym.jpg"
						chatavatar = avatar
					}

					console.warn(` alias: ${didData.data.alias}`);

					let contact = { address: didData.data.alias, username: null, avatar: avatar, did: chatValue }
					console.warn('CONTACTO POR URL!', contact)
					SaveContactsToLocalStorage(contact);

					try { await chatWith(chatValue, chatavatar) }
					catch (error) { Toast.fire('Error', error.message, "error"); }

				}

				else {
					console.warn('❌ chatValue is NOT in the correct format.');
				}

			} else {
				console.warn('chat parameter not found in the URL');
			}
			// ----------------------------------------------------------------------------------
			//  FIN CHECK IF USER COMES FROM A LINK
			// ----------------------------------------------------------------------------------

			GLOBALCHAIN = localStorage.getItem("GLOBALCHAIN");
			if (GLOBALCHAIN === null) {
				console.log('GLOBALCHAIN is null');
				localStorage.setItem("GLOBALCHAIN", 0);
				GLOBALCHAIN = 0;

			} else {
				console.log('GLOBALCHAIN :', GLOBALCHAIN);
			}
			// -----------------------------------------
			//  fin CHECK IF USER COMES FROM A LINK
			// -----------------------------------------
			await getChatAddresses()
			// return

			// recien aca carga los contactos!
			await loadContacts()
			// await loadContacts(signer.address)


			// if token is set
			// startBalanceListener();
			// setInterval(reloadBalance(), 15000);
			setInterval(loadToken, 15000);


			await listenAllNewAddresses()



		}
		init()

		// ----------------------
		// Start the balance listener

		// Function to check balance
		async function checkBalance() {
			console.log('⏰ BALANCE CHECKED! ')
			try {
				// const balance = await tokenContract.balanceOf(walletAddress);
				reloadBalance()

				console.log(`Current balance: ${ethers.formatUnits(balance, 18)} tokens`);
			} catch (error) {
				console.error('Error fetching balance:', error);
			}
		}

		// Set interval to check balance every 15 seconds
		const interval = 15000; // 15 seconds

		// Start the balance listener
		function startBalanceListener() {
			console.log('Starting balance listener...');
			setInterval(checkBalance, interval);
		}


		// ------------------------------------------------------
		// var isFullscreen = false;
		var body = document.querySelector('body');
		var lastTapTime = 0;
		var isFullscreen = false;
		// ---------------------------------------------------------

		function toggleFullscreen() {
			if (!isFullscreen) {
				// Toast.fire({ icon: 'info', title: 'full screen in on!', text:' (double click again to turn it of)'});
				Swal.fire({
					title: 'Full screen 🖵',
					position: 'top',
					timer: 1500,
					showClass: {
						popup: `
      animate__animated
      animate__fadeInDown
      animate__faster
    `,
					},
					hideClass: {
						popup: `
      animate__animated
      animate__fadeOutUp
      animate__faster
    `,
					},
					grow: 'row',
					showConfirmButton: false,
					showCloseButton: true,
				})

				if (document.documentElement.requestFullscreen) {
					document.documentElement.requestFullscreen();
				} else if (document.documentElement.msRequestFullscreen) {
					document.documentElement.msRequestFullscreen();
				} else if (document.documentElement.mozRequestFullScreen) {
					document.documentElement.mozRequestFullScreen();
				} else if (document.documentElement.webkitRequestFullscreen) {
					document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
				}
				isFullscreen = true;
			} else {
				Toast.fire({ icon: 'info', title: 'full screen in off!', text: '' });

				if (document.exitFullscreen) {
					document.exitFullscreen();
				} else if (document.msExitFullscreen) {
					document.msExitFullscreen();
				} else if (document.mozCancelFullScreen) {
					document.mozCancelFullScreen();
				} else if (document.webkitExitFullscreen) {
					document.webkitExitFullscreen();
				}
				isFullscreen = false;
			}
		}



		// You would replace this ABI with the one fetched from Etherscan or another source
		const permitToken = [
			{
				"constant": false,
				"inputs": [
					{ "name": "owner", "type": "address" },
					{ "name": "spender", "type": "address" },
					{ "name": "value", "type": "uint256" },
					{ "name": "deadline", "type": "uint256" },
					{ "name": "v", "type": "uint8" },
					{ "name": "r", "type": "bytes32" },
					{ "name": "s", "type": "bytes32" }
				],
				"name": "permit",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			}
		];

		// Check if the ERC-20 token implements the permit function
		async function checkEIP2612Compatibility() {
			const tokenInterface = new ethers.Interface(permitToken);

			try {
				const functionSignature = tokenInterface.getSighash('permit(address,address,uint256,uint256,uint8,bytes32,bytes32)');
				const hasPermitFunction = abi.some((item) => item.type === 'function' && item.signature === functionSignature);
				console.log('EIP-2612 compatible:', hasPermitFunction);
			} catch (error) {
				console.log('EIP-2612 not compatible:', error);
			}

		}


		/*********************************************************************************************
		.) SOUNDS
		**********************************************************************************************/

		function playBeep() {
			var AudioContext = window.AudioContext || window.webkitAudioContext;
			var audioCtx = new AudioContext();

			var oscillator = audioCtx.createOscillator();
			oscillator.type = "sine"; // Set the waveform type
			oscillator.frequency.value = 864; // Set the frequency (Hz)

			oscillator.connect(audioCtx.destination);
			oscillator.start();

			// Stop the oscillator after 100 milliseconds
			setTimeout(function () {
				oscillator.stop();
			}, 100);
		}


		// Initialize Tone.js
		Tone.start();
		console.log("tone started");
		// Create a simple click sound with different parameters
		const clickSynth = new Tone.Synth({
			oscillator: {
				type: "sine", // You can experiment with different oscillator types
			},
			envelope: {
				attack: 0.01,
				decay: 0.1,
				sustain: 0.1,
				release: 0.5,
			},
		}).toDestination();

		function playButtonClickSound() {
			// Trigger the synth to produce a short click sound
			clickSynth.triggerAttackRelease("C4", "8n");
		}


		// Function to play a tic sound
		function playTic() {
			// Create a ping sound using a simple synthesizer
			const synth = new Tone.Synth({
				oscillator: {
					type: 'sine' // Sine wave for a soft tic sound
				},
				envelope: {
					attack: 0.001,
					decay: 0.1,
					sustain: 0,
					release: 0.1
				}
			}).toDestination();

			// Play a high-pitched short note to mimic a tic sound
			synth.triggerAttackRelease("C6", "8n");
		}

		// Function to play a cartoonish tic sound
		function cartoonPlayTic() {
			// Create a more playful sound using a square wave oscillator
			const synth = new Tone.Synth({
				oscillator: {
					type: 'square' // Square wave for a more cartoonish sound
				},
				envelope: {
					attack: 0.001, // Very short attack for a quick sound
					decay: 0.05,   // Fast decay to give it a pluck-like feel
					sustain: 0.2,  // Brief sustain to keep it light
					release: 0.05  // Short release to avoid lingering notes
				}
			}).toDestination();

			// Play a high-pitched note for a short duration
			synth.triggerAttackRelease("G6", "16n");
		}

		// Function to play a boing or pop sound
		function playBoing() {
			const synth = new Tone.Synth({
				oscillator: {
					type: 'triangle' // Smooth waveform for a bouncing effect
				},
				envelope: {
					attack: 0.05,  // Slight delay in attack for a stretchy feel
					decay: 0.2,    // Longer decay to let the sound bounce
					sustain: 0,    // No sustain, keeping it short
					release: 0.2   // Short release to cut it off cleanly
				},
				portamento: 0.2  // This creates the pitch glide for a boing effect
			}).toDestination();

			// Start with a high note and glide downward quickly
			synth.triggerAttackRelease("C7", "8n");
		}

		/*********************************************************************************************
		.) MANAGE MODALS
		**********************************************************************************************/


		function openModalId(id, event) {
			console.log("openingModal", id, event);
			setTimeout(() => {
				window[id + "Modal"] = new bootstrap.Modal(document.querySelector(`${id}`));
				window[id + "Modal"].show(event);

				// Check if the modal is open
				var isModalOpen = window[id + "Modal"]._isShown;
				// console.log("Is modal open?", window[id + "Modal"], isModalOpen);
			}, 50);
		}

		function closeModalId(id, event) {
			console.log("closing modal", id, event);
			var modal = window[id + "Modal"];
			if (modal && modal._isShown) {
				// console.log("Is modal open?", modal, modal._isShown);
				modal.hide(event);
			} else {
				console.log("Modal is not open or not defined.");
			}
		}

		/*********************************************************************************************
		.) sweetalert2
		// position: "top-right",
		**********************************************************************************************/

		const ToastTop = Swal.mixin({
			toast: true,
			position: "bottom-end",
			showConfirmButton: false,
			timer: 3000,
			timerProgressBar: true,
			didOpen: (toast) => {
				toast.addEventListener("mouseenter", Swal.stopTimer);
				toast.addEventListener("mouseleave", Swal.resumeTimer);
			},
			iconColor: "white",
			customClass: {
				popup: "colored-toast",
			},
		});

		const Toast = Swal.mixin({
			toast: true,
			position: "bottom-end",
			showConfirmButton: false,
			timer: 3000,
			timerProgressBar: true,
			didOpen: (toast) => {
				toast.addEventListener("mouseenter", Swal.stopTimer);
				toast.addEventListener("mouseleave", Swal.resumeTimer);
			},
			iconColor: "white",
			customClass: {
				popup: "colored-toast",
			},
		});

		const superToast = Swal.mixin({
			toast: true,
			position: "bottom-end",
			showConfirmButton: false,
			timer: 1000,
			timerProgressBar: true,
			didOpen: (toast) => {
				toast.addEventListener("mouseenter", Swal.stopTimer);
				toast.addEventListener("mouseleave", Swal.resumeTimer);
			},
			iconColor: "white",
			customClass: {
				popup: "colored-toast",
			},
		});
		const newMessageToast = swal.mixin({
			toast: true,
			position: "bottom-left",
			showConfirmButton: false,
			showDenyButton: false,
			showCancelButton: false,
			timer: 7000,

			// iconColor: "white",
			customClass: {
				popup: "supercolored-toast",
			},
		});


		const fixedToast = swal.mixin({
			toast: true,
			position: "bottom-end",
			showConfirmButton: false,
			showDenyButton: false,
			showCancelButton: false,
			iconColor: "white",
			customClass: {
				popup: "colored-toast",
			},
		});


		/*********************************************************************************************
		.)  SIDEBAR
		**********************************************************************************************/

		// Get the navigation button and add a click event listener
		var navBtn = document.querySelector(".hamburger");
		navBtn.addEventListener("click", plToggle);

		// Define the plToggle function
		function plToggle(event) {
			//   console.log("TOOGLE NAVBAR", event);
			navBtn.classList.toggle("is-active");

			// Toggle classes for elements with class 'content', 'sidebar', and 'overlay'
			document.querySelector(".sidebar").classList.toggle("isOpen");
			document.querySelector(".overlay").classList.toggle("overlayisOpen");

			// Get the container element with class 'sidebar'
			var container = document.querySelector(".sidebar");
		}

		// Add a click event listener to the overlay element
		document.querySelector(".overlay").addEventListener("click", function (event) {
			console.log("clickeado en nav li");
			plToggle();
		});


		/*********************************************************************************************
		.)  COPYFadd 
		**********************************************************************************************/

		function copy2clipboard(text) {
			// let text = `${ipfsGateway}${cid}`;
			console.log('COPIED!', text)
			let textLink = `<a target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/address/${text}">${text}</a>`;

			if (window.clipboardData && window.clipboardData.setData) {
				ToastTop.fire('Copied to Clipboard', textLink, "success");
				return window.clipboardData.setData("Text", text);
			}
			else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
				var textarea = document.createElement("textarea");
				textarea.textContent = text;
				textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in Microsoft Edge.
				document.body.appendChild(textarea);
				textarea.select();
				try {
					ToastTop.fire('Copied to Clipboard!', textLink, "success");
					return document.execCommand("copy");  // Security exception may be thrown by some browsers.
				}
				catch (ex) {
					console.warn("Copy to clipboard failed.", ex);
					return prompt("Copy to clipboard: Ctrl+C, Enter", text);
				}
				finally {
					document.body.removeChild(textarea);
				}
			}
		}

		function shortAddressETH(address) {
			if (typeof address !== 'string' || address.length < 42) {
				throw new Error('Invalid Ethereum address');
			}
			return address.substring(0, 6) + "..." + address.substring(38, 42);
		}

		function shortAddressSTARK(address) {
			if (typeof address !== 'string' || address.length < 64) {
				throw new Error('Invalid StarkNet address');
			}
			return address.substring(0, 6) + "..." + address.substring(address.length - 4);
		}

		async function reloadBalance() {
			console.log('⏰ ⏰ ⏰reloadBalance()')

			let network = await checkNetwork();
			console.log('network:', network)

			if (network == false) {
				console.log('network FALSE:', network)
				headerNotes.innerHTML = `  <div class="alert alert-danger alert-dismissible fade show headerNotes"> <button type="button" class="btn-close" data-bs-dismiss="alert"></button> <strong>Danger!</strong> Error de red. </div>`

				return
			}
			else if (network == true) {
				console.log('network TRUE:', network)
			}

			let addr = document.getElementById('yourAddress').getAttribute('address');
			let balance = await checkERC20Balance(addr)
			let gasBalance = await checkGasBalance(addr)
			userData.innerHTML = `			
			<a id="" target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/address/${optionsList[0].ERC20_TOKEN_ADDRESS}">Balance: ${balance}</a>
			<svg class='hoverIcon' xmlns="http://www.w3.org/2000/svg"  width="18" height="16" viewBox="0 0 512 512" id='reloadBalance'  onclick="event.stopPropagation();reloadBalance()"> <path fill="currentColor" d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/></svg> 
			<br>
		<a id="miniversion" target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/address/${addr}">gas: ${gasBalance}</a>
			`;
		}




		async function getLocalWalletSigner() {
			console.warn('getLocalWalletSigner()');



			return Swal.fire({
				title: dictionary[globalLang]["unlockWallet"],
				input: 'password',
				inputAttributes: { autocapitalize: 'off' },
				showLoaderOnConfirm: true,
				backdrop: true,
				showCancelButton: false,
				showDenyButton: true,
				confirmButtonText: 'Enter',
				denyButtonText: `Cancel`,



				html: `
		<input type="checkbox" id="rememberPassword" name="rememberPassword" checked> 
		<label for="rememberPassword">${dictionary[globalLang]["rememberPassword"]}</label> 
		`,
				footer: '<a href="/docs/index.html#" target="_blank" rel="noopener noreferrer">Docs</a>',
				preConfirm: (value) => {
					if (!value) {
						Swal.showValidationMessage('<i class="fa fa-info-circle"></i> A password is required')
					}

				},
				allowOutsideClick: () => { const popup = Swal.getPopup(); popup.classList.remove('swal2-show'); setTimeout(() => { popup.classList.add('animate__animated', 'animate__headShake'); }); setTimeout(() => { popup.classList.remove('animate__animated', 'animate__headShake'); }, 500); return false; },
			})
				.then(async (result) => {

					if (result.isConfirmed) {

						// =========================
						//   if input rememberPassword is clicked


						const password = result.value;
						const rememberPasswordCheckbox = Swal.getPopup().querySelector('#rememberPassword');

						console.log('password entered!');

						if (rememberPasswordCheckbox.checked) {
							sessionStorage.setItem("password", password);

						} else {
							sessionStorage.removeItem("password");

						}

						// Continue with your logic using the entered password
						// return password;
						// =========================

						let encryptedjson = localStorage.getItem('encryptedWallet');
						let ew = JSON.parse(encryptedjson);
						console.log('pub key of wallet in localstorage:', ew.address);


						try {
							const localWallet = await ethers.Wallet.fromEncryptedJson(encryptedjson, result.value);
							console.log('localWallet.publicKey:', localWallet.publicKey);
							const provider = new ethers.JsonRpcProvider(`${optionsList[0].API}`);
							const signer = localWallet.connect(provider);
							console.log('SIGNER:', signer);
							return signer;
						} catch (error) {
							console.error('Error during wallet decryption:', error);
							Swal.fire({
								icon: "error",
								title: "Error 🚨",
								text: error.message,
							})
								.then((result) => {
									if (result.isConfirmed) {
										console.log('OK button clicked');
										lockscreen.style.display = 'flex'
									}

								});

							// REMOVE PASSWORD FROM SESSION 
							sessionStorage.removeItem("password");
							return null;
						}

					}


				});
		}

		// ---------------------------------------------

		function toChecksumAddress(address) {
			return ethers.getAddress(address);
		}


		// -----------------------
		// ------------------------------
		async function unlockLocalwallet() {

			console.log('unlockLocalwallet()')
			// LOAD CHAT
			let signer;
			console.log('there is no signer')
			try {
				signer = await getLocalWalletSigner();

				if (!signer || !signer.address) {
					throw new Error("Signer is undefined or does not have an address");
					document.getElementById('lockscreen').style.display = 'block'

				}

				// Use signer.address here safely
				console.log('Signer address:', signer.address);

			} catch (error) {
				console.log('Error at getLocalWalletSigner():', error.message);
				return;
			}
			lockscreen.style.display = 'none'


			await loadDID(signer)
			syncBalance()
			await init(signer)

			if (!signer) {
				console.log('Handle case where signer is not obtained');
				lockscreen.style.display = 'flex'
				return; // Or throw an error, or handle the case in another way
			}

		}

		// ---------------------------------------------

		async function getSigner() {
			console.warn('*** getSigner() ***')

			let signer;
			// 1- GET  PRIV KEY(IF not CREATE IT)
			const chatETHPrivKey = localStorage.getItem('chatETHPrivKey');
			if (!chatETHPrivKey) {
				console.warn('No chatETHPrivKey found. Checking for unbackedWallet.');

				// 2- NO PRIV KEY, IS UNBACKEDWALLET?
				const unbackedWallet = localStorage.getItem('unbackedWallet');
				if (!unbackedWallet) {
					console.warn('No unbackedWallet found. Checking for encryptedWallet.');

					// 3-  NO UNBACKED WALLET, is JSONWALLET?
					const encryptedWallet = localStorage.getItem('encryptedWallet');
					if (!encryptedWallet) {
						console.warn('No encryptedWallet found.');
						// CREATE UNBACKED WALLET
						try { signer = await ethers.Wallet.createRandom() }
						catch (error) {
							console.log(error.message);
							fixedToast.fire('Error', error.message, "error");
						}
						console.warn('RANDOM WALLET CREATED!:', signer.address, 'mnemonic:', signer.mnemonic.phrase, 'privkey:', signer.privateKey)
						localStorage.setItem('unbackedWallet', JSON.stringify(signer.mnemonic.phrase))

						setTimeout(() => {
							console.warn('ADDING REMEMBER TO BACKUP WALLET TO HEADERNOTES ^^^^^^^^^^')

							headerNotes.innerHTML = `
					<div class="alert alert-warning alert-dismissible fade show headerNotes">
						<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
						<strong>Alert!</strong> Remember to backup your wallet.
						<button type="button" class="btn btn-primary" onclick="backup()">Backup Now</button>
					</div>
					`;
						}, 5000);

						// return signer; // Return the signer here

					} else {
						// Handle encryptedWallet
						console.warn('3- encryptedWallet found. Checking for jsonWalletPassword.');
						const jsonWalletPassword = sessionStorage.getItem('password');
						if (!jsonWalletPassword) {
							console.warn('No jsonWalletPassword found.');

							// 1. get and form address from json wallet
							let addr = JSON.parse(encryptedWallet).address;
							const checksumAddress = toChecksumAddress(`0x${addr}`);

							// 2. shot it into qr
							setAddress(checksumAddress)

							// 3. display UI in lock mode
							document.getElementById("loader").style.display = "none";//flex
							lockscreen.style.display = 'flex'

							return false

						} else {
							// Handle encryptedWallet and jsonWalletPassword
							console.log('encryptedWallet and jsonWalletPassword found.');
							// FIX1?: catch the signer here?
							// let signer;
							try {
								signer = await ethers.Wallet.fromEncryptedJson(encryptedWallet, jsonWalletPassword)
								console.warn('SIGNER GLOBAL HERE ***')

							} catch (error) {
								console.warn(error.message, 'ERROR WALLET!');
								fixedToast.fire({ icon: 'error', title: error.message });
								sessionStorage.removeItem('password')
								return false
							}
							// return signer; // Return the signer here

						}

					}


				}
				else {
					// Handle unbackedWallet
					console.warn('2- YES unbackedWallet')
					const walletData = JSON.parse(unbackedWallet);
					try {
						signer = ethers.Wallet.fromPhrase(walletData);
						setTimeout(() => {
							console.warn('ADDING REMEMBER TO BACKUP WALLET TO HEADERNOTES ****************^^^^^^^^^^')
							headerNotes.innerHTML = `
					<div class="alert alert-warning alert-dismissible fade show headerNotes">
						<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
						<strong>Alert!</strong> Remember to backup your wallet.
						<button type="button" class="btn btn-primary" onclick="backup()">Backup Now</button>
					</div>
					`;
						}, 5000);
					}
					catch (error) { console.warn(error.message, 'ERROR WALLET!'); localStorage.removeItem('unbackedWallet'); }


				}

			} // fin chatETHPrivKey
			else {
				// Handle chatETHPrivKey
				console.warn('1- YES chatETHPrivKey', chatETHPrivKey)
				try {
					signer = await new ethers.Wallet(chatETHPrivKey)

				}
				catch (error) {
					console.log(error.message);
					document.getElementById("loader").style.display = "none";//flex
					lockscreen.style.display = 'flex';
				}
			}


			return signer


		}


		/*********************************************************************************************
		.)  BAKCUP
		**********************************************************************************************/
		function backupWallet(mnemonic) {
			console.log('now, (is this used?) backupWallet()', mnemonic)
			//////////////////////
			// CREATE WALLET
			Swal.fire({
				title: dictionary[globalLang]["createpasswordtoencryptwallet"],
				input: 'password',
				inputAttributes: {
					autocapitalize: 'off'
				},
				showCancelButton: true,
				confirmButtonText: 'create',
				showLoaderOnConfirm: true,
				// preConfirm: (login) => { },
				backdrop: true,

				inputValidator: (value) => {
					if (!value) {
						return 'You need to set a password to create your wallet!'
					}
				},

				allowOutsideClick: () => {
					const popup = Swal.getPopup()
					popup.classList.remove('swal2-show')
					setTimeout(() => { popup.classList.add('animate__animated', 'animate__headShake') })
					setTimeout(() => { popup.classList.remove('animate__animated', 'animate__headShake') }, 500)
					return false
				},

			})
				.then(async (result) => {
					if (result.isConfirmed) {
						// console.log('PASSWORD RESULT:',result.value)

						await makeBackup(result.value, mnemonic)
						return result.value
					}
				})


		}


		async function makeBackup(pwd, mnemonic) {

			// console.log('MAKE BACKUP address:', signer.address)
			console.log('MAKE BACKUP mnemonic:', mnemonic)


			// WRITE YOUR MNEMONIC PHRASE
			displayMnemonic.innerHTML = ` <h3><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height='40px' width='40px' fill="currentColor"> <path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/></svg>Write down your mnemonic phrase to access your wallet in the future! :</h3> <div class="alert alert-warning alert-dismissible fade show"  > <strong translate="no">${mnemonic}</strong> </div> `


			// CREATING ENCRYPTED LOCAL WALLET
			displayMnemonic.innerHTML += ` <div  id="loaderCW"  > <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span> creating encrypted wallet ... </div> `


			walletbackpfooter.innerHTML = `<a href="/docs/index.html#/?id=la-frase-mnemot%c3%a9cnica" target="_blank" rel="noopener noreferrer">Check out the documentation!</a> `

			// SAVE TO LOCALSTORAGE (encrypted?)
			console.log('password: ', pwd)
			try {
				// wallet = ethers.HDNodeWallet.fromMnemonic(mnemonic);
				wallet = ethers.Wallet.fromPhrase(mnemonic)
			}
			catch {
				console.warn(error)
			}
			const promisseJSON = wallet.encrypt(pwd);
			promisseJSON.then((encryptedWallet) => {
				console.log(encryptedWallet)
				console.log('WALLET ENCRYPTED')

				// loaderCW
				document.getElementById('loaderCW').innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
<symbol id="check-circle-fill" fill="currentColor" viewBox="0 0 16 16">
<path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
</symbol>
<symbol id="info-fill" fill="currentColor" viewBox="0 0 16 16">
<path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
</symbol>
<symbol id="exclamation-triangle-fill" fill="currentColor" viewBox="0 0 16 16">
<path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
</symbol>
</svg>

<div class="alert alert-success d-flex align-items-center" role="alert">
<svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Success:"><use xlink:href="#check-circle-fill"/></svg>
<div>
Wallet encrypted and saved into localstorage
</div>
</div>
`


				localStorage.setItem('encryptedWallet', encryptedWallet)
				console.log(' ENCRYPTED JSONWALLET SAVED INTO LOCALSTORAGE')
				//   localStorage.setItem('encryptedAddress', wallet.address)
				console.log(' ENCRYPTED ADDRESS SAVED INTO LOCALSTORAGE')

				setTimeout(() => {
					const checkbox = document.getElementById('mnemonicBackedup');
					// const button = document.getElementById('closeWalletBkp');
					const button = document.getElementById('closeBackupmodal');

					mnemonicBackedup.disabled = false;
					// closeBackupmodal
					// Add an event listener to the checkbox to track its state
					checkbox.addEventListener('change', function () {
						// If the checkbox is checked, enable the button; otherwise, disable it
						button.disabled = !this.checked;
						mnemonicBackedup.disabled = true;
						console.log('close mnemonic activated')

						// NOW DELETE unbackedWallet
						localStorage.removeItem('unbackedWallet')

					});
					// init();
				}, 1000);


			});


			setTimeout(() => {
				openModalId('#walletBackp')

			}, 50);

		}
		/*********************************************************************************************
			.)  QR
			**********************************************************************************************/
		async function showqr(addr) {
			const qrColor = getComputedStyle(document.body).getPropertyValue('--qr');

			var isMobile = window.matchMedia("only screen and (max-width: 768px)");

			// let qrSize
			if (isMobile.matches) {
				console.log("Mobile screen detected");
				qrSize = 310;
				window.scrollTo(0, 0);


			} else {
				// Code for larger screens
				console.log("Not a mobile screen");
				qrSize = 370

			}

			//QR
			// width: `${qrSize}`, height: `${qrSize}`, type: "png", data: addr, image: `./logo4.png`,
			const qrCode = new QRCodeStyling({
				width: `${qrSize}`, height: `${qrSize}`, type: "png", data: addr, image: `./logowhite.png`,
				dotsOptions: { color: `${qrColor}`, type: "extra-rounded" },
				backgroundOptions: { color: "var(--qrbackground)", },
				imageOptions: { crossOrigin: "anonymous", margin: 0 }
			});
			qrCode.append(document.getElementById("canvas"));
			console.log('qr code APPENDED')
			document.querySelector('.main-wrap').style.backgroundImage = 'none';
			loader.style.display = 'none'

		}


		function displayQR(data) {
			console.log('displayQR(data)')
			const qrCode = new QRCodeStyling({
				width: 500, height: 500, type: "png", data: data, image: `id5.svg`,
				dotsOptions: { color: "#1568B0", type: "extra-rounded" },
				backgroundOptions: { color: "var(--qrbackground)", },
				imageOptions: { crossOrigin: "anonymous", margin: 3 }
			});
			qrCode.append(document.getElementById("canvas"));
			// canvas.classList.add('animate')




		}

		function setAddress(userAddress) {
			console.log('setAddress()', userAddress)

			// v1
			// var currentURL = window.location.href;
			var baseUrl = window.location.protocol + '//' + window.location.host + '/';
			// var baseUrl = 'https://192.168.43.129:4343' + '/';
			// var baseUrl = 'https://iusnaturalis.web.app' + '/';
			let did = `did:ius:${userAddress}`
			const parameters = { chat: did };
			const urlParams = createURLParams(parameters);
			const url = `${baseUrl}?${urlParams}`;

			// 3- SHOW QR
			canvas.innerHTML = '';
			showqr(url);

			// 	// var isFullscreen = false;
			// 	var body = document.querySelector('body');
			// var lastTapTime = 0;
			// var isFullscreen = false;

			canvas.onclick = function (e) {
				console.log('CHATWALLET: clicked on QR')
				var currentTime = new Date().getTime();
				var tapLength = currentTime - lastTapTime;
				if (tapLength < 500 && tapLength > 0) {
					toggleFullscreen();
				}
				lastTapTime = currentTime;
			}

			// let shortAddr = userAddress.substring(0, 6) + "..." + userAddress.substring(38, 42);
			let shortAddr = shortAddressETH(userAddress)
			var preElement = document.getElementById('yourAddress');
			preElement.setAttribute('address', userAddress);

			yourAddress.innerHTML = `${shortAddr} <svg id='copyAddress' onclick="event.stopPropagation();copy2clipboard('${userAddress}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill='currentColor' d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"/></svg> <svg id='shareAddress' onclick="event.stopPropagation();copy2clipboard('${url}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><path fill='currentColor'  d="M352 224c53 0 96-43 96-96s-43-96-96-96s-96 43-96 96c0 4 .2 8 .7 11.9l-94.1 47C145.4 170.2 121.9 160 96 160c-53 0-96 43-96 96s43 96 96 96c25.9 0 49.4-10.2 66.6-26.9l94.1 47c-.5 3.9-.7 7.8-.7 11.9c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-25.9 0-49.4 10.2-66.6 26.9l-94.1-47c.5-3.9 .7-7.8 .7-11.9s-.2-8-.7-11.9l94.1-47C302.6 213.8 326.1 224 352 224z"/></svg>`;
			console.log(`Your address: ${userAddress} `)
			console.log(`Your did: ${did} `)
		}


		/*********************************************************************************************
		.)  URL
		**********************************************************************************************/
		// Function to create URL parameters from an object
		function createURLParams(params) {
			console.log('createURLParams', params)

			const keys = Object.keys(params);
			const encodedParams = keys.map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`);
			return encodedParams.join('&');
		}

		/*********************************************************************************************
	.) QR SCAN
	**********************************************************************************************/
		async function scanAddress() {
			console.log('SCANNING FOR A NEW USER ADDRESS')

			Swal.close(); // Close the modal

			var audioContext = new AudioContext();

			// open modal
			openModalId('#scanModal')
			document.getElementById('scanResult').innerHTML = ''
			setTimeout(() => {
				var videoElem = document.getElementById("qrScanVideo");
				window.qrScanner = new QrScanner(videoElem, result => qrscanned(result), {
					highlightScanRegion: true,
					highlightCodeOutline: true,
				});

				qrScanner.setInversionMode('invert');
				qrScanner.start();

			}, 1000);

		}

		async function qrscanned(result) {
			console.log('🔎 🔰 💬scanned decoded qr code:', result.data)
			x1 = result.data;
			document.getElementById('scanResult').innerHTML = ` <div class="success-message"> <svg viewBox="0 0 76 76" class="success-message__icon icon-checkmark"> <circle cx="38" cy="38" r="36"/> <path fill="none" stroke="#FFFFFF" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M17.7,40.9l10.9,10.9l28.7-28.7"/> </svg> <h1 class="success-message__title">SCANED!</h1> <div class="success-message__content"> <p>${result.data}</p> </div> </div> `
			qrScanner.stop();
			qrScanner.destroy();
			qrScanner = null;
			playBeep();
			await setTimeout(() => {
				closeModalId('#scanModal')
			}, 1500);
			// console.log('KEEP DOING SOMETHING', result.data)

			// SEARCH FOR chat
			const url = new URL(result.data);
			console.log('qr url:', url)
			const urlParams = new URLSearchParams(url.search);
			const chatValue = urlParams.get('chat');
			if (chatValue !== null) {
				console.log(`Value of chat parameter: ${chatValue}`);
				Toast.fire({ icon: 'info', title: 'ABOUT THIS CHAT:', text: chatValue });
				plToggle()
				let did; // Define did outside the conditional blocks
				let ethaddress;

				// CHECK THE URL TYPE (DID or address)
				if (chatValue.startsWith('did:ius:')) {//DID
					console.log('DID detected:', chatValue);
					ethaddress = chatValue.split(':').pop();

				} else if (/^0x[a-fA-F0-9]{40}$/.test(chatValue)) {//ETH ADDR
					console.log('Ethereum address detected:', chatValue);
					did = `did:ius:${chatValue}`
					address = chatValue; // Assuming chatValue is directly an Ethereum address

				}

				else {
					console.log('Unknown format or invalid input:', chatValue);
					did = chatValue
				}




				try {
					let didData = await fetchDID(did);
					console.log('didData', didData);
					if (didData && didData.data && didData.data.alias) {
						console.log('alias is not null', didData.data.alias);
					} else {
						console.log('User doesn\'t have a DID or alias is null');
					}
				} catch (error) {
					console.error('Error fetching DID data:', error);
					console.log('User doesn\'t have a DID or there was an error fetching the data');
				}


				let contact = { address: chatValue, username: null, avatar: null, did: did }
				console.log('🍧🍧🍧 SAVING NEW CONTACT TO LOCALSTORAGE', contact)
				SaveContactsToLocalStorage(contact);




				await chatWith(ethaddress)


			} else {
				console.log('chat parameter not found in the URL');
			}


		}




		async function selectChat(el) {
			console.warn('selectChat()')
			const address = el.dataset.address;
			console.log('CLICKED CONTACT (selectChat()):', address);
			var imgElement = el.querySelector("img");
			let imgSrc = imgElement.getAttribute("src");
			console.log('imgSrc: ', imgSrc.length)

			// 0- remove newmessage class
			document.getElementById(address).classList.remove('newmessage');

			// 1- close navbar
			plToggle()

			// 2- chat with address funciton 
			let currentChat = document.body.getAttribute('currentChat');
			console.warn('CURRENTCHAT', currentChat)

			// INTENTO FIX DUPLICA Y MULTIPLICA MENSAJES
			let alreadyChatting = (currentChat === address) ? true : false;
			if (alreadyChatting) {
				//  if alreadyChatting is true
				console.log('🤓 already chatting with this contact 🤓')
				openChat()
			} else {
				console.log('🤓 start chatting with new contact 🤓')
				// if not in contacts store it, else do nothing
				let contact = { address: el.dataset.address }
				SaveContactsToLocalStorage(contact);
				await chatWith(address)
				await updateBadge()

			}
		}


		document.getElementById("closeScanModal").onclick = () => {
			qrScanner.stop();
			closeModalId('#scanModal')
			qrScanner.destroy();
			qrScanner = null;

		}




		async function updateBadge() {
			// console.log('updateBadge()')
			var ulElement = document.getElementById('cwContacts');
			var newMessageElements = ulElement.getElementsByClassName('newmessage');
			var count = newMessageElements.length;
			if (count === 0) {
				// console.log('updateBadge(): No elements with class "newmessage" found.');
				document.getElementById('chatBadge').style.display = 'none'
				document.getElementById('chatBadge').innerText = ''
			} else {
				console.log('Number of elements with class "newmessage":', count);
				document.getElementById('chatBadge').style.display = 'inline'
				document.getElementById('chatBadge').innerText = `${count}`
			}

		}


		/*********************************************************************************************
		.) NEWQRCHAT
		**********************************************************************************************/
		async function createXMPTchat(signer) {
			console.log('createXMPTchat()')


			const iusnaturalisxmtp = await Client.create(signer)
			const conversations = iusnaturalisxmtp.conversations

			// get eth address for chat
			userAddress = signer.address;
			console.log('Your chat Address (eth) : ', userAddress)

			window.iusnaturalisxmtp = iusnaturalisxmtp;// make GLOBAL
			window.chats = iusnaturalisxmtp.conversations
			window.userAddress = userAddress

			return iusnaturalisxmtp
		}




		async function getChatAddresses() {
			const allConversations = await iusnaturalisxmtp.conversations.list()
			console.warn('🧸 🧸 🧸 YOU HAVE ', allConversations.length, "ADDRESSES AVAILABLE IN XMTP at getChatAddresses()")

			const peerAddressesArray = [];

			allConversations.forEach(async (conversation, index) => {
				peerAddressesArray.push(conversation.peerAddress);
				// console.log('allConversations foerEach')
				// ADD ADDRESS TO AGENDA IN UI
				// Here

			})
			paa = peerAddressesArray;
			console.log('🧶 🧶 🧶 peerAddressesArray(paa) DECLARED!', peerAddressesArray)

			// HOW MANY OF THEM ARE TRUSTED BY USER?

		}





		async function createGroupChat() {
			console.log('createGroupChat()')
			Swal.fire({
				icon: "error",
				title: "Oops...",
				text: "This is not yet implemented!",
				footer: '<a href="#">Why do I have this issue?</a>'
			});
		}



		// Initialize an empty list to store processed addresses
		let processedAddresses = [];

		// Function to create a new conversation if not already processed
		async function createConversation(toAddr) {
			if (!processedAddresses.includes(toAddr)) {
				// Address not yet processed, create a new conversation
				let conversation = await iusnaturalisxmtp.conversations.newConversation(toAddr);

				// Store the address in the list to prevent duplicate processing
				processedAddresses.push(toAddr);

				// Return the conversation or perform other actions as needed
				return conversation;
			} else {
				console.log(`Conversation with ${toAddr} already exists.`);
			}
		}


		// Initialize an empty Map to store addresses and their corresponding conversation instances
		let conversationsMap = new Map();
		cmap = conversationsMap
		// Function to get or create a conversation
		async function getOrCreateConversation(toAddr) {
			if (conversationsMap.has(toAddr)) {
				// Address already has a conversation, return the existing one
				return conversationsMap.get(toAddr);
			} else {
				// Address not found, create a new conversation
				let conversation = await iusnaturalisxmtp.conversations.newConversation(toAddr);

				// Store the new conversation in the Map
				conversationsMap.set(toAddr, conversation);

				// Return the new conversation
				return conversation;
			}
		}









		// ------------------------
		// NEW
		// 1111111111111111
		// Set to store addresses of active conversations
		// const activeChats = new Set();
		// achs = activeChats

		// OUTSIDE
		const activeChats = new Set();
		achs = activeChats

function preloadChatUI(toAddr){
	// <!-- EASY PRE LOAD UI CHAT WITH PEER -->


// let toAddr= '0x1234'
let avatar  = "./anonym.jpg";


chatAddress.innerHTML = `<div class="" id="peerAddr" data-address="${toAddr}" >
	<img src='${avatar}' alt="avatar" class="rounded rounded-circle img-thumbnail" width='40px' id='avatarImage'  onclick="event.stopPropagation();openCard('${toAddr}','${avatar}')">
	<strong onclick="event.stopPropagation();openCard('${toAddr}','${avatar}')">  (${toAddr.substring(38, 42)})</strong>
	</div>`;


actionButtons.innerHTML = `
<button type="button" id="peerSend" class="btn btn-approve item" style="display: none;"
onclick="event.stopPropagation(); openSend('${toAddr.toString()}')" disabled>
	
<svg xmlns="http://www.w3.org/2000/svg"    height="16" width="20" viewBox="0 0 512 512">
			<path fill="currentColor" d="M512 80c0 18-14.3 34.6-38.4 48c-29.1 16.1-72.5 27.5-122.3 30.9c-3.7-1.8-7.4-3.5-11.3-5C300.6 137.4 248.2 128 192 128c-8.3 0-16.4 .2-24.5 .6l-1.1-.6C142.3 114.6 128 98 128 80c0-44.2 86-80 192-80S512 35.8 512 80zM160.7 161.1c10.2-.7 20.7-1.1 31.3-1.1c62.2 0 117.4 12.3 152.5 31.4C369.3 204.9 384 221.7 384 240c0 4-.7 7.9-2.1 11.7c-4.6 13.2-17 25.3-35 35.5c0 0 0 0 0 0c-.1 .1-.3 .1-.4 .2c0 0 0 0 0 0s0 0 0 0c-.3 .2-.6 .3-.9 .5c-35 19.4-90.8 32-153.6 32c-59.6 0-112.9-11.3-148.2-29.1c-1.9-.9-3.7-1.9-5.5-2.9C14.3 274.6 0 258 0 240c0-34.8 53.4-64.5 128-75.4c10.5-1.5 21.4-2.7 32.7-3.5zM416 240c0-21.9-10.6-39.9-24.1-53.4c28.3-4.4 54.2-11.4 76.2-20.5c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 19.3-16.5 37.1-43.8 50.9c-14.6 7.4-32.4 13.7-52.4 18.5c.1-1.8 .2-3.5 .2-5.3zm-32 96c0 18-14.3 34.6-38.4 48c-1.8 1-3.6 1.9-5.5 2.9C304.9 404.7 251.6 416 192 416c-62.8 0-118.6-12.6-153.6-32C14.3 370.6 0 354 0 336l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 342.6 135.8 352 192 352s108.6-9.4 148.1-25.9c7.8-3.2 15.3-6.9 22.4-10.9c6.1-3.4 11.8-7.2 17.2-11.2c1.5-1.1 2.9-2.3 4.3-3.4l0 3.4 0 5.7 0 26.3zm32 0l0-32 0-25.9c19-4.2 36.5-9.5 52.1-16c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 10.5-5 21-14.9 30.9c-16.3 16.3-45 29.7-81.3 38.4c.1-1.7 .2-3.5 .2-5.3zM192 448c56.2 0 108.6-9.4 148.1-25.9c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 44.2-86 80-192 80S0 476.2 0 432l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 438.6 135.8 448 192 448z"/>
			</svg>

<svg xmlns="http://www.w3.org/2000/svg" height="16" width="20" viewBox="0 0 512 512">
<path fill="currentColor"
d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480V396.4c0-4 1.5-7.8 4.2-10.7L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/>
</svg>
<span>SEND</span>
</button>

<button type="button" id="peerReceive" class="btn btn-reject item" style="display: none;"
onclick="event.stopPropagation(); openReceive('${toAddr.toString()}')"  disabled>
<svg xmlns="http://www.w3.org/2000/svg"    height="16" width="20" viewBox="0 0 512 512">
			<path fill="currentColor" d="M512 80c0 18-14.3 34.6-38.4 48c-29.1 16.1-72.5 27.5-122.3 30.9c-3.7-1.8-7.4-3.5-11.3-5C300.6 137.4 248.2 128 192 128c-8.3 0-16.4 .2-24.5 .6l-1.1-.6C142.3 114.6 128 98 128 80c0-44.2 86-80 192-80S512 35.8 512 80zM160.7 161.1c10.2-.7 20.7-1.1 31.3-1.1c62.2 0 117.4 12.3 152.5 31.4C369.3 204.9 384 221.7 384 240c0 4-.7 7.9-2.1 11.7c-4.6 13.2-17 25.3-35 35.5c0 0 0 0 0 0c-.1 .1-.3 .1-.4 .2c0 0 0 0 0 0s0 0 0 0c-.3 .2-.6 .3-.9 .5c-35 19.4-90.8 32-153.6 32c-59.6 0-112.9-11.3-148.2-29.1c-1.9-.9-3.7-1.9-5.5-2.9C14.3 274.6 0 258 0 240c0-34.8 53.4-64.5 128-75.4c10.5-1.5 21.4-2.7 32.7-3.5zM416 240c0-21.9-10.6-39.9-24.1-53.4c28.3-4.4 54.2-11.4 76.2-20.5c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 19.3-16.5 37.1-43.8 50.9c-14.6 7.4-32.4 13.7-52.4 18.5c.1-1.8 .2-3.5 .2-5.3zm-32 96c0 18-14.3 34.6-38.4 48c-1.8 1-3.6 1.9-5.5 2.9C304.9 404.7 251.6 416 192 416c-62.8 0-118.6-12.6-153.6-32C14.3 370.6 0 354 0 336l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 342.6 135.8 352 192 352s108.6-9.4 148.1-25.9c7.8-3.2 15.3-6.9 22.4-10.9c6.1-3.4 11.8-7.2 17.2-11.2c1.5-1.1 2.9-2.3 4.3-3.4l0 3.4 0 5.7 0 26.3zm32 0l0-32 0-25.9c19-4.2 36.5-9.5 52.1-16c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 10.5-5 21-14.9 30.9c-16.3 16.3-45 29.7-81.3 38.4c.1-1.7 .2-3.5 .2-5.3zM192 448c56.2 0 108.6-9.4 148.1-25.9c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 44.2-86 80-192 80S0 476.2 0 432l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 438.6 135.8 448 192 448z"/>
			</svg>
<svg height="16" width="20" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">
	<path fill="currentColor"
		d="m 506.43491,498.16358 c -7,10.1 -19.1,15.4 -31.2,13.5 l -416.000001,-64 c -9.7,-1.5 -18.2,-7.4 -23,-16 -4.8,-8.6 -5.4,-18.9 -1.6,-28 l 49.7,-119.6 -74.1,-68.5 c -9.70000029,-8.9 -12.9000003,-22.9 -8.1000003,-35.2 4.8,-12.3 16.7000003,-20.3 29.9000003,-20.3 h 83.600001 c 4,0 7.8,1.5 10.7,4.2 l 182.9,167.6 c 6.3,5.8 16,5.6 22,-0.4 6,-6 6.4,-15.7 0.7,-22 l -180.7,-203.4 44.2,-88.300001 c 5.3,-10.5999996 15.9,-17.39999965 27.7,-17.69999965 11.8,-0.3 22.8,5.90000005 28.7,16.09999965 l 256,448.000001 c 6.1,10.7 5.5,23.9 -1.4,34 z"/>
</svg>
<span>RECEIVE</span>
</button>

<button id="btn-search-close" class="btn  item" aria-label="Close search form"
onclick="event.stopPropagation(); deleteChat('${toAddr.toString()}')">
<svg class="icon icon--cross">
	<use xlink:href="#icon-cross"></use>
</svg>
</button>
`


peerSend.style.display = 'inline';
peerReceive.style.display = 'inline'
// peerSend.disabled = false;
// peerReceive.disabled = false;

document.getElementById("chatBox").innerHTML = '';//clear chat window

headerNotes.innerHTML = ``

}

		async function chatWith(toAddr, imgsrc) {
			console.log('chatWith(): ESTABLISHING NEW CHAT WITH', toAddr)
			preloadChatUI(toAddr)
			headerNotes.innerHTML = ``
			document.getElementById("chatBox").innerHTML = '';//clear chat window
			console.log('clear chatBox window')
			let userAddress = document.getElementById('yourAddress').getAttribute('address');

			console.log(toAddr, userAddress)
			if (toAddr == userAddress) {
				console.warn('CANCELING chatwith() because CANNOT WITH SELF ADDRESS')
				Toast.fire('CANNOT CHAT WITH SELF ADDRESS', '', "warning");
				localStorage.removeItem('toAddress')// detele "TO" address from localStorage
				return
			}

			superToast.fire({ icon: 'success', title: '💬 CHAT WITH:', position: 'center', text: toAddr });



			// // ----------------------------------------------------
			// GOT TO CHAT TAB
			console.log(' doing openChat')
			openChat()
			console.warn('------- PREPARING CHAT ----------');
			localStorage.setItem('toAddress', toAddr)
			updateBadge()
			let shortAddr = toAddr.substring(0, 6) + "..." + toAddr.substring(38, 42);

			if (imgsrc != null) {
				try {
					new URL(imgsrc);
					console.log('YES IMAGE SOURCE: Valid URL');
					avatar = imgsrc;  // Assign if valid
				} catch (e) {
					console.log('Invalid image source URL', imgsrc);
					avatar = 'anonym.jpg';  // Use a default image if invalid
				}

			} else {
				let did = `did:ius:${toAddr}`;
				const didresult = await readDIDRecord(did);
				const avtr = didresult.data.avatar;
				const alias = didresult.data.alias;  // Check for alias

				if (avtr && avtr.trim() !== '') {
					console.log('Avatar found in DID record');
					avatar = JSON.parse(avtr);
				} else {
					console.log('NO IMAGE SOURCE or AVATAR data is empty');
					avatar = "./anonym.jpg";
				}

				// Check for alias
				if (alias && alias.trim() !== '') {
					console.log(`Alias found: ${alias}🥪🥪`);

					// check alias is not an address(if address shorten it)
					if (isNotEthereumAddress(alias)) {
						console.log("🥕🥕This is not an Ethereum address.", alias);
						shortAddr = alias
					} else {
						console.log("🥦🥦This is a valid Ethereum address.", alias);
					}

				} else {
					console.log('No alias found 🍿🍿');
					shortAddr = toAddr.substring(0, 6) + "..." + toAddr.substring(38, 42);

				}
			}
		// fin else

			// ADD ADDRESS IN UI
			let htmlData = `<address>${toAddr} <svg id="" onclick="event.stopPropagation();customcopy2clipboard('${toAddr}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z" ></path></svg> </address><br><p>no info available</p>`;
			chatAddress.innerHTML = `<div class="" id="peerAddr" data-address="${toAddr}" >
			<img src='${avatar}' alt="avatar" class="rounded rounded-circle img-thumbnail" width='40px' id='avatarImage'  onclick="event.stopPropagation();openCard('${toAddr}','${avatar}')">
			<strong onclick="event.stopPropagation();openCard('${toAddr}','${avatar}')">${shortAddr}(${toAddr.substring(38, 42)})</strong>
			</div>`;




			// -------------------
			actionButtons.innerHTML = `
                <button type="button" id="peerSend" class="btn btn-approve item" style="display: none;"
        onclick="event.stopPropagation(); openSend('${toAddr.toString()}')" disabled>
		<svg xmlns="http://www.w3.org/2000/svg"    height="16" width="20" viewBox="0 0 512 512">
			<path fill="currentColor" d="M512 80c0 18-14.3 34.6-38.4 48c-29.1 16.1-72.5 27.5-122.3 30.9c-3.7-1.8-7.4-3.5-11.3-5C300.6 137.4 248.2 128 192 128c-8.3 0-16.4 .2-24.5 .6l-1.1-.6C142.3 114.6 128 98 128 80c0-44.2 86-80 192-80S512 35.8 512 80zM160.7 161.1c10.2-.7 20.7-1.1 31.3-1.1c62.2 0 117.4 12.3 152.5 31.4C369.3 204.9 384 221.7 384 240c0 4-.7 7.9-2.1 11.7c-4.6 13.2-17 25.3-35 35.5c0 0 0 0 0 0c-.1 .1-.3 .1-.4 .2c0 0 0 0 0 0s0 0 0 0c-.3 .2-.6 .3-.9 .5c-35 19.4-90.8 32-153.6 32c-59.6 0-112.9-11.3-148.2-29.1c-1.9-.9-3.7-1.9-5.5-2.9C14.3 274.6 0 258 0 240c0-34.8 53.4-64.5 128-75.4c10.5-1.5 21.4-2.7 32.7-3.5zM416 240c0-21.9-10.6-39.9-24.1-53.4c28.3-4.4 54.2-11.4 76.2-20.5c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 19.3-16.5 37.1-43.8 50.9c-14.6 7.4-32.4 13.7-52.4 18.5c.1-1.8 .2-3.5 .2-5.3zm-32 96c0 18-14.3 34.6-38.4 48c-1.8 1-3.6 1.9-5.5 2.9C304.9 404.7 251.6 416 192 416c-62.8 0-118.6-12.6-153.6-32C14.3 370.6 0 354 0 336l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 342.6 135.8 352 192 352s108.6-9.4 148.1-25.9c7.8-3.2 15.3-6.9 22.4-10.9c6.1-3.4 11.8-7.2 17.2-11.2c1.5-1.1 2.9-2.3 4.3-3.4l0 3.4 0 5.7 0 26.3zm32 0l0-32 0-25.9c19-4.2 36.5-9.5 52.1-16c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 10.5-5 21-14.9 30.9c-16.3 16.3-45 29.7-81.3 38.4c.1-1.7 .2-3.5 .2-5.3zM192 448c56.2 0 108.6-9.4 148.1-25.9c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 44.2-86 80-192 80S0 476.2 0 432l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 438.6 135.8 448 192 448z"/>
			</svg>

        <svg xmlns="http://www.w3.org/2000/svg" height="16" width="20" viewBox="0 0 512 512">
            <path fill="currentColor"
                d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480V396.4c0-4 1.5-7.8 4.2-10.7L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/>
        </svg>
        <span>SEND</span>
		</button>

		<button type="button" id="peerReceive" class="btn btn-reject item" style="display: none;"
				onclick="event.stopPropagation(); openReceive('${toAddr.toString()}')"  disabled>
				<svg xmlns="http://www.w3.org/2000/svg"    height="16" width="20" viewBox="0 0 512 512">
			<path fill="currentColor" d="M512 80c0 18-14.3 34.6-38.4 48c-29.1 16.1-72.5 27.5-122.3 30.9c-3.7-1.8-7.4-3.5-11.3-5C300.6 137.4 248.2 128 192 128c-8.3 0-16.4 .2-24.5 .6l-1.1-.6C142.3 114.6 128 98 128 80c0-44.2 86-80 192-80S512 35.8 512 80zM160.7 161.1c10.2-.7 20.7-1.1 31.3-1.1c62.2 0 117.4 12.3 152.5 31.4C369.3 204.9 384 221.7 384 240c0 4-.7 7.9-2.1 11.7c-4.6 13.2-17 25.3-35 35.5c0 0 0 0 0 0c-.1 .1-.3 .1-.4 .2c0 0 0 0 0 0s0 0 0 0c-.3 .2-.6 .3-.9 .5c-35 19.4-90.8 32-153.6 32c-59.6 0-112.9-11.3-148.2-29.1c-1.9-.9-3.7-1.9-5.5-2.9C14.3 274.6 0 258 0 240c0-34.8 53.4-64.5 128-75.4c10.5-1.5 21.4-2.7 32.7-3.5zM416 240c0-21.9-10.6-39.9-24.1-53.4c28.3-4.4 54.2-11.4 76.2-20.5c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 19.3-16.5 37.1-43.8 50.9c-14.6 7.4-32.4 13.7-52.4 18.5c.1-1.8 .2-3.5 .2-5.3zm-32 96c0 18-14.3 34.6-38.4 48c-1.8 1-3.6 1.9-5.5 2.9C304.9 404.7 251.6 416 192 416c-62.8 0-118.6-12.6-153.6-32C14.3 370.6 0 354 0 336l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 342.6 135.8 352 192 352s108.6-9.4 148.1-25.9c7.8-3.2 15.3-6.9 22.4-10.9c6.1-3.4 11.8-7.2 17.2-11.2c1.5-1.1 2.9-2.3 4.3-3.4l0 3.4 0 5.7 0 26.3zm32 0l0-32 0-25.9c19-4.2 36.5-9.5 52.1-16c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 10.5-5 21-14.9 30.9c-16.3 16.3-45 29.7-81.3 38.4c.1-1.7 .2-3.5 .2-5.3zM192 448c56.2 0 108.6-9.4 148.1-25.9c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 44.2-86 80-192 80S0 476.2 0 432l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 438.6 135.8 448 192 448z"/>
			</svg>
				<svg height="16" width="20" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">
					<path fill="currentColor"
						d="m 506.43491,498.16358 c -7,10.1 -19.1,15.4 -31.2,13.5 l -416.000001,-64 c -9.7,-1.5 -18.2,-7.4 -23,-16 -4.8,-8.6 -5.4,-18.9 -1.6,-28 l 49.7,-119.6 -74.1,-68.5 c -9.70000029,-8.9 -12.9000003,-22.9 -8.1000003,-35.2 4.8,-12.3 16.7000003,-20.3 29.9000003,-20.3 h 83.600001 c 4,0 7.8,1.5 10.7,4.2 l 182.9,167.6 c 6.3,5.8 16,5.6 22,-0.4 6,-6 6.4,-15.7 0.7,-22 l -180.7,-203.4 44.2,-88.300001 c 5.3,-10.5999996 15.9,-17.39999965 27.7,-17.69999965 11.8,-0.3 22.8,5.90000005 28.7,16.09999965 l 256,448.000001 c 6.1,10.7 5.5,23.9 -1.4,34 z"/>
				</svg>
				<span>RECEIVE</span>
		</button>

		<button id="btn-search-close" class="btn  item" aria-label="Close search form"
				onclick="event.stopPropagation(); deleteChat('${toAddr.toString()}')">
				<svg class="icon icon--cross">
					<use xlink:href="#icon-cross"></use>
				</svg>
		</button>
		`


			// activate buttons
			peerSend.style.display = 'inline';
			peerReceive.style.display = 'inline'
			peerSend.disabled = false;
			peerReceive.disabled = false;

			// ------------------------------------
			// AVOID REOPENING COMS WITH ADDRESESS
			// SACAR/ si lo saco falla...
			const allConversations = await iusnaturalisxmtp.conversations.list()
			console.log('available addresses:', allConversations.length)
			const customAddressToCheck = toAddr; // Replace this with the address you want to check
			let addressExists = false;
			for (const conversation of allConversations) {
				if (conversation.peerAddress === customAddressToCheck) {
					addressExists = true;
					cc = conversation
					break; // Exit the loop early if the address is found
				}
			}



			if (addressExists) {
				console.warn(`YOU DO HAVE A CHAT HISTORY WITH ${customAddressToCheck} `);
				console.log('USER: ', userAddress)
				let h = await cc.messages()

				// CREATE THIS FUNCTON ==> loadChatHistory(h)
				for (let i = 0; i < h.length; i++) {

					if (h[i].senderAddress === userAddress) {
						let timestamp = simplifyDate(h[i].sent)
						document.getElementById('chatBox').innerHTML += `<div><strong class='who'>You:</strong> ${h[i].content}<span class="timestamp">  ${timestamp} &check; </span></div>`;

					} else {
						let timestamp = simplifyDate(h[i].sent)

						// 01010101001010101001010101010101010010101010101010
						// DIsplay saved name , if not set display shortAddr
						// 01010101001010101001010101010101010010101010101010
						let shortAddr = h[i].senderAddress.substring(38, 42);

						document.getElementById('chatBox').innerHTML += `<div><strong class='who notyou'>${shortAddr}:</strong> ${h[i].content}<span class="timestamp">  ${timestamp} &check; </span></div>`;
					}

				}


				console.log('history:', h.length)
				hhh = h.lengh



			} else {
				console.warn(`YOU DONT HAVE A CHAT HISTORY WITH ${customAddressToCheck} `);

			}
			// FIN AVOID REOPENING COMS WITH ADDRESESS
			// ------------------------------------

			// CREATE CHAT (client was already created)
			// 12312312312312312312312312312
			// AQUI EVITAR DUPLICADOS
			// 12312312312312312312312312312



			// 13123123123123123123123123123123
			// CAN CHAT?
			const isOnProdNetwork = await iusnaturalisxmtp.canMessage(toAddr);
			console.log("Can message?: " + isOnProdNetwork);






			// ----------------------------------------------------
			// Check if the chat is already being listened to
			if (activeChats.has(toAddr)) {
				// console.log(`📣📣📣 Already chating with toAddrsenderAddress}`);
				console.warn('------- READY TO CHAT 💬 ----------');


				// CHANGE STATUS LIGHT:
				document.getElementById('singleChatlightButton').style.backgroundColor = 'yellow'
				// document.getElementById('lightButton').innerHTML= '🟢'


				// ADD ATTRIBUTE TO BODY(fix dup messg)
				document.body.setAttribute('currentChat', toAddr);

				// ACTIVATE CHAT BUTTONS
				document.getElementById('chatTextInput').disabled = false;
				document.getElementById('send-button').disabled = false;
				document.getElementById('chatTextInput').focus();


			} else {
				// Start listening to the conversation
				activeChats.add(toAddr);

				console.warn(' 📛 📛 CREATE CHAT (client was already created)')
				conversation = await iusnaturalisxmtp.conversations.newConversation(toAddr)
				console.log('conversation:', conversation)
				console.log(`💖 💌 Started new conversation with ${toAddr}`);


				// ----------------------------------------------------


				console.warn('------- READY TO CHAT 💬 ----------');
				document.getElementById('singleChatlightButton').style.backgroundColor = 'green'

				// ADD ATTRIBUTE TO BODY(fix dup messg)
				document.body.setAttribute('currentChat', toAddr);

				// ACTIVATE CHAT BUTTONS
				document.getElementById('chatTextInput').disabled = false;
				document.getElementById('send-button').disabled = false;
				document.getElementById('chatTextInput').focus();
				// -----------


				var chatBox = document.getElementById("chatBox");
				let shortTo = toAddr.substring(38, 42);

				// Listen for new messages in the conversation
				for await (const message of await conversation.streamMessages()) {
					const now = new Date();
					const hours = now.getHours().toString().padStart(2, '0'); // Ensure two-digit format
					const minutes = now.getMinutes().toString().padStart(2, '0'); // Ensure two-digit format
					const timestamp = `${hours}:${minutes}`;
					console.log('logMSG:', message)
					let preferedWallet = localStorage.getItem('preferedWallet');
					if (!preferedWallet) { console.log('NO PREFERED WALLET SET') }
					if (preferedWallet) { const values = preferedWallet.split(',').map(item => item.trim()); userAddress = values[1]; }
					if (message.senderAddress === userAddress) {
						console.log('YOU')
						chatBox.innerHTML += `<div><strong class='who'>You:</strong> ${message.content}<span class="timestamp">  ${timestamp} &check; </span></div>`;
					}
					if (message.senderAddress == toAddr) {
						console.log('OTHER', shortTo)
						mm = message;
						// let timestamp = message
						// chatBox.innerHTML += `<div><strong class='who'>${shortTo}:</strong> ${message.content} </div>`;
						document.getElementById('chatBox').innerHTML += `<div><strong class='who notyou'>${shortTo}:</strong> ${message.content}<span class="timestamp">  ${timestamp} &check; </span></div>`;


					}
					console.log(`[${message.senderAddress}]: ${message.content}`)
					chatBox.scrollTop = chatBox.scrollHeight;


					// if (message.contentType.sameAs(ContentTypeMultiplyNumber)) {
					// 	return message.content; // 21
					// }
				}


			}





		}


		// NE MANAGEMENT INTENT
		let activeListeners = {};
		AL = activeListeners
		async function startConversation(contactAddress) {
			// Check if the listener for this contact already exists
			if (activeListeners[contactAddress]) {
				console.log('Listener already active for this conversation');
				return; // Do not create a new listener
			}

			try {
				// Start the new conversation
				const conversation = await xmtpClient.conversations.newConversation(contactAddress);

				// Set up the listener for this conversation
				const stream = await conversation.streamMessages();

				// Store the listener reference
				activeListeners[contactAddress] = stream;

				// Process messages
				for await (const message of stream) {
					console.log('New message:', message.content);
					// Handle the incoming message
				}

			} catch (error) {
				console.error('Error starting conversation:', error);
			}
		}

		function closeConversation(contactAddress) {
			// Cleanup the listener if it exists
			if (activeListeners[contactAddress]) {
				activeListeners[contactAddress].close(); // Close the message stream
				delete activeListeners[contactAddress]; // Remove from active listeners
			}
		}




		/*********************************************************************************************
		.) CONTACTS MANAGEMENT
		**********************************************************************************************/


		async function addUnknownContact(addr, msg) {
			console.warn('👤 addUnknownContact()', addr, msg)

			// add unknown contact to  localstorage and check each time against the list if we add it or not into the contacts tab
			let shortAddr = addr.substring(0, 6) + "..." + addr.substring(38, 42);
			let shortMsg = msg.substring(0, 16);


			let unknownContacts = JSON.parse(localStorage.getItem('unknowncontacts')) || [];
			a = addr
			var index = unknownContacts.findIndex(existingUnknownContacts => existingUnknownContacts === addr);

			if (index === -1) {
				console.log('PUSH UnknownContact to localstorage')
				unknownContacts.push(addr);

				document.getElementById('cwContacts').innerHTML += `
					<li data-address="${addr}"  id="${addr}" class='newmessage'> 
						<a onclick="event.stopPropagation();selectChat((this.parentElement))" >  
							<img src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
								<span>${shortMsg} <span>
									
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"width="18" height="16" >
										<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"/></svg>
										
										
										</a> 
										</li> `
				// <i class="fa-solid fa-trash"></i>

			} else {
				console.log('OVERWRITE ALREADY EXISTENT  UnknownContact!.');

				// Search for the element with the specified ID
				var elementToModify = document.getElementById(addr);

				// Check if the element exists
				if (elementToModify) {
					// Add a new class to the element
					elementToModify.classList.add('newmessage');
					elementToModify.querySelector("span").innerText = shortMsg

				} else {
					// If the element with the specified ID is not found, you may want to handle that case
					console.warn("Element with ID '" + addr + "' not found");
					document.getElementById('cwContacts').innerHTML += ` 
					<li data-address="${addr}" id="${addr}"  class='newmessage'> 
					<a onclick="event.stopPropagation();selectChat((this.parentElement))" >  
						<img src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
						<span>${shortMsg} <span>
							</a> </li> `
					// <i class="fa-solid fa-trash"></i>
				}


			}

			// CAMBIAR POR SaveContactsToLocalStorage??
			localStorage.setItem('unknowncontacts', JSON.stringify(unknownContacts));


		}

		async function addknownContact(addr, msg) {
			console.log('addknownContact()', addr, msg)

			let shortAddr = addr.substring(0, 6) + "..." + addr.substring(38, 42);
			let shortMsg = msg.substring(0, 16);
			var elementToModify = document.getElementById(addr);
			if (elementToModify) {
				elementToModify.classList.add('newmessage');
				elementToModify.querySelector("span").innerText = shortMsg
			}
			else {
				// NUEVO!
				document.getElementById('cwContacts').innerHTML += ` 
					<li data-address="${addr}" id="${addr}"  class='newmessage'> 
					<a onclick="event.stopPropagation();selectChat((this.parentElement))" >  
						<img src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
						<span>${shortMsg} <span>
							</a> </li> `
			}


		}


		async function loadHistory() {
			console.log('loadHistory()')

			// 1 check ist not in your agenda

			let chatList = await iusnaturalisxmtp.conversations.list()
			// c = chatList;
			let chatLength = chatList.length;
			console.log(chatLength, "addresses in history.")

			// Using a for loop
			for (let i = 0; i < chatLength; i++) {
				addHistoryContact(chatList[i].peerAddress, chatList[i].createdAt.toString())

			}


		}

		function isNotEthereumAddress(alias) {
			return !ethers.isAddress(alias); // Returns true if alias is NOT a valid Ethereum address
		}
		async function loadContacts() {
			console.log('loadContacts()')
			let contct = document.getElementById('cwContacts')
			contct.innerHTML = ''
			let cwContacts = JSON.parse(window.localStorage.getItem('contacts'));
			if (!cwContacts) {
				console.warn('YOU HAVE', 0, 'CONTACTS in LOCALSTORAGE at loadContacts()')

			}
			if (cwContacts) {
				console.warn('👨‍👩‍👦 👨‍👩‍👧 👨‍👩‍👧‍👦 YOU HAVE', cwContacts.length, 'CONTACTS in LOCALSTORAGE at loadContacts()')
				const promises = [];
				cwContacts.forEach((el, index) => {
					// is username set?



					if (el.username || null) {
						// username is not null
						contactInfo = `<span>${el.username} <span>`;
					} else {
						console.log('❌this ',el,'username is null');
						let shortAddr = el.address.substring(0, 6) + "..." + el.address.substring(38, 42);
						contactInfo = `<span>${shortAddr} <span>`;
					}

					let did = `did:ius:${el.address}`;
					// Add each asynchronous operation to the promises array
					promises.push(
						new Promise((resolve, reject) => {
							readDIDRecord(did)
								.then(didresult => {
									if (didresult.data != null) {
										console.log(did + ' HAS A RECORD ✅');

										let avtr = didresult.data.avatar;
										if (avtr) {
											let avatar = JSON.parse(avtr);
											document.getElementById(did).src = avatar;
										} else {
											// Handle the case where avtr is empty
											console.log('Avatar is empty 👀');
										}

										// ---
										let alias = didresult.data.alias;  // Check for alias

										if (alias && alias.trim() !== '') {
											console.log(`🗽 Alias found in DID: ${alias}🥪🏁🥪`);

											// check alias is not an eth address
											if (isNotEthereumAddress(alias)) {
												console.log("🥐🥐 This is not an Ethereum address.", alias);
											} else {
												alias = shortAddressETH(alias)
												console.log(" 🍔🍔 This is a valid Ethereum address.", alias);
												// a=alias
											}

											document.getElementById(el.address).querySelector('a span span').innerHTML = `<span class="custom-color">${alias}</span>
											<svg onclick="event.stopPropagation();editContact('${el.address}')" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="20" height="25" class='right'>
										<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"/>
										</svg>`;
										} else {
											console.log('No alias found 🍿🍿');

										}
										// ---




									} else {
										console.log(did + ' DOESN\'T HAVE A RECORD  📛 ');
									}
									resolve(); // Resolve the promise once the operation is done
								})
								.catch(error => {
									console.warn('🌰 Warn on DID record:', error);
									reject(error); // Reject the promise if an error occurs
								});
						})
					);

					contct.innerHTML += `<li data-address="${el.address}" id="${el.address}" class=''> 
                            <a onclick="event.stopPropagation();selectChat((this.parentElement))">  
                                <img id ="${did}" src="./anonym.jpg" alt="Avatar" class="rounded-circle"> 
									<span >${contactInfo}</span>
									<svg onclick="event.stopPropagation();editContact('${el.address}')" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="20" height="25" class='right'>
										<path fill="currentColor" d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H322.8c-3.1-8.8-3.7-18.4-1.4-27.8l15-60.1c2.8-11.3 8.6-21.5 16.8-29.7l40.3-40.3c-32.1-31-75.7-50.1-123.9-50.1H178.3zm435.5-68.3c-15.6-15.6-40.9-15.6-56.6 0l-29.4 29.4 71 71 29.4-29.4c15.6-15.6 15.6-40.9 0-56.6l-14.4-14.4zM375.9 417c-4.1 4.1-7 9.2-8.4 14.9l-15 60.1c-1.4 5.5 .2 11.2 4.2 15.2s9.7 5.6 15.2 4.2l60.1-15c5.6-1.4 10.8-4.3 14.9-8.4L576.1 358.7l-71-71L375.9 417z"/>
										</svg>
										</a> 
										</li>`;
					// <i class="fa-solid fa-trash"></i>
				});

				// Execute all promises concurrently
				Promise.all(promises)
					.then(() => {
						console.log('⭐⭐⭐ All DID record processing completed.⭐⭐⭐');
						// change status button
						document.getElementById('lightButton').style.backgroundColor = 'green'
					})
					.catch(error => {
						console.error('❌❌❌ Error while processing DID records:', error);
						document.getElementById('lightButton').style.backgroundColor = 'yellow'

					});


			}

		}// fin loadContacts



		async function saveContacts() {
			console.log('saveContacts()')

			// Retrieve the contacts from localStorage
			const contacts = localStorage.getItem('contacts');

			if (!contacts) {
				console.error('No contacts found in localStorage.');
				return;
			}


			// 	// encrypt contacts to store it in yourt DID
			// 	let signer = await getSigner() 
			// 		if (!signer) {
			// 		console.log('Handle case where signer is not obtained');
			// 		}
			// 	let pubkey = signer.publicKey;
			// 	let encryptedContacts = await encryptData(contacts, pubkey);
			// console.log('encryptedContacts: ', encryptedContacts)

			// return
			// Create a Blob from the contacts data
			const blob = new Blob([contacts], { type: 'application/json' });

			// Create a link element
			const link = document.createElement('a');

			// Set the download attribute with the filename
			link.download = 'contacts.json';

			// Create a URL for the Blob and set it as the href attribute
			link.href = window.URL.createObjectURL(blob);

			// Append the link to the body (it won't be visible)
			document.body.appendChild(link);

			// Programmatically click the link to trigger the download
			link.click();

			// Remove the link from the document
			document.body.removeChild(link);
			Toast.fire({ icon: 'success', title: 'Contacts saved into JSON file!', text: '' });


		}

		function importContacts() {
			const input = document.createElement('input');
			input.type = 'file';
			input.accept = '.json';

			input.onchange = function (event) {
				importJSONContacts(event);
			};

			input.click();
		}


		function importJSONContacts(event) {
			const file = event.target.files[0]; // Get the selected file

			if (!file) {
				console.error('No file selected.');
				return;
			}

			const reader = new FileReader();

			reader.onload = function (e) {
				const content = e.target.result;

				try {
					// Parse the JSON content to ensure it's valid
					const contacts = JSON.parse(content);

					// Save the parsed JSON into localStorage
					localStorage.setItem('contacts', JSON.stringify(contacts));

					console.log('Contacts successfully loaded into localStorage.');
				} catch (error) {
					console.error('Error parsing JSON:', error);
				}
			};

			// Read the file as text
			reader.readAsText(file);
			Toast.fire({ icon: 'success', title: 'Contacts imported!', text: '' });

		}

		// Example usage: Attach the function to an input element
		// document.getElementById('fileInput').addEventListener('change', loadContacts);

		// <button  class="btn btn-primary" onclick="event.stopPropagation();loadContacts()">Import</button>
		// function importContacts()
		/*********************************************************************************************
		.) OLD QRCHAT
		**********************************************************************************************/
		async function xmtp(wallet) {

			let to = localStorage.getItem('toAddress')
			if (!to) {
				console.log('NO "TO" ADDRESS')
				const xmtp = await Client.create(wallet)
				console.log('XMTP CLIENT CREATED: ', xmtp)
				// xm = xmtp;
				return
			}
			else {
				console.log('YES "TO" ADDRESS')
				const xmtp = await Client.create(wallet)
				localStorage.setItem('chatxmtp', xmtp)
				// await chatWith(to)
			}



		}

		document.getElementById("chatTextInput").addEventListener("keydown", function (event) {
			console.log('Pressed ENTER')
			if (event.key === "Enter") {
				var userInput = this.value.trim(); // Trim whitespace from input
				if (userInput !== "") {
					console.log("User input:", userInput);
					// Do something with the user input here
					sendMessage(event);
				}
				// var userInput = this.value;
				// console.log("User input:", userInput);
				// // Do something with the user input here
				// sendMessage();
				event.preventDefault(); // Prevents the default behavior of the Enter key (submitting a form)
			}
		});

		document.getElementById("chatTextInput").addEventListener("blur", function (event) {
			var userInput = this.value.trim(); // Trim whitespace from input
			if (userInput !== "") {
				console.log("User input:", userInput);
				// Do something with the user input here
				sendMessage(event);
			}
			// var userInput = this.value;
			// console.log("User input:", userInput);
			// // Do something with the user input here
			// sendMessage();
		});

		async function sendMessage() {
			console.log('sendMessage()')
			event.preventDefault();

			var userInput = document.getElementById("chatTextInput").value;
			var chatBox = document.getElementById("chatBox");
			var message = document.createElement("div");

			if (userInput.trim() !== "") {
				// The input value is not empty
				console.log("Input is not empty");
			} else {
				// The input value is empty
				console.log("Input is empty");
				return
			}



			document.getElementById("chatTextInput").value = "";
			chatBox.scrollTop = chatBox.scrollHeight;
			if (conversation) {
				console.log('CONVESATION AVAILABLE NOW: ', conversation)
			} else {
				console.log('NO AVAILABLE CONVESATION: ')

			}


			// SEND
			await conversation.send(`${userInput}`);// Send a message


			// unfocus
			document.getElementById('chatTextInput').blur();

			// event.preventDefault(); // Prevents the default behavior of the Enter key (submitting a form)

		}




		function setToAddress() {
			var toaddr = document.getElementById("toAddr").value;

			console.log('setting TO adddress: ', toaddr)

			// if (ethers.utils.isAddress(toaddr)) {
			if (ethers.isAddress(toaddr)) {
				console.log('VALID ADDRESS')
				document.getElementById("invalid-address-alert").style.display = "none";
				localStorage.setItem('toAddress', toaddr)
				document.getElementById('results').innerHTML += `<br>TO address: ${toaddr}  <button class="btn btn-secondary" onclick="clearChat()">Clear</button>`


			} else {
				console.log('INVALID ADDRESS')
				document.getElementById("invalid-address-alert").style.display = "block";

			}


		}



		function customcopy2clipboard(text) {
			console.log('customcopy2clipboard()', text)

			let textLink = `<a href="${text}">${text}</a>`;

			if (window.clipboardData && window.clipboardData.setData) {
				console.log('Copied to Clipboard', text, "success");

				document.getElementById('innerAddress').innerHTML = '<path fill="currentColor"  d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/><p>Copied!</p>'

				setTimeout(() => {
					document.getElementById('innerAddress').innerHTML = ' <path fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"></path>'
				}, 1000);
				return window.clipboardData.setData("Text", text);
			}
			else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
				var textarea = document.createElement("textarea");
				textarea.textContent = text;
				textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in Microsoft Edge.
				document.body.appendChild(textarea);
				textarea.select();
				try {
					console.log('Copied to Clipboard', text, "success");
					document.getElementById('innerAddress').innerHTML = '<path fill="currentColor"  d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/><p>Copied!</p>'

					setTimeout(() => {
						document.getElementById('innerAddress').innerHTML = ' <path fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z"></path>'
					}, 1000);

					return document.execCommand("copy");  // Security exception may be thrown by some browsers.
				}
				catch (ex) {
					console.warn("Copy to clipboard failed.", ex);
					return prompt("Copy to clipboard: Ctrl+C, Enter", text);
				}
				finally {
					document.body.removeChild(textarea);
				}
			}


		}


		async function addUser() {
			console.log('ADDING NEW USER ADDRESS')
		}



		// EDIT CONTACT
		// el.address
		async function editContact(addr) {
			console.log('editContact()')
			const inputValue = '';

			const { value: userName } = await Swal.fire({
				title: "Enter a name for this address",
				input: "text",
				inputLabel: "contact name",
				inputValue,
				showCancelButton: true,
				inputValidator: (value) => {
					if (!value) {
						return "You need to write something!";
					}
				}
			});
			if (userName) {

				// let contact = { address: addr, username: userName, avatar: null, did: null }
				// SaveContactsToLocalStorage(contact)
				await updateUsername(addr, userName)

				await loadContacts()
				console.log('Contact Updated', userName)
				// Swal.fire(`Your IP address is ${userName}`);
			}


		}

		// no usado?
		function updateContactList(contact) {
			// Retrieve existing contacts from localStorage
			var contacts = JSON.parse(localStorage.getItem('contacts')) || [];

			// Check if the contact already exists in the list
			var existingContactIndex = contacts.findIndex(function (existingContact) {
				return existingContact.address === contact.address;
			});

			if (existingContactIndex !== -1) {
				// If the contact exists, update its details
				contacts[existingContactIndex] = contact;
			} else {
				// If the contact doesn't exist, add it to the list
				contacts.push(contact);
			}

			// Save the updated contact list back to localStorage
			localStorage.setItem('contacts', JSON.stringify(contacts));
		}

		// SAVE DOCUMENTS
		function SaveDocToLocalStorage(data) {
			let documents = JSON.parse(localStorage.getItem('documents')) || [];

			// Check if the document with the same scid exists
			const existingIndex = documents.findIndex(doc => doc.cid === data.cid);

			if (existingIndex !== -1) {
				// Overwrite the existing document
				console.log('Overwrite the existing document')
				documents[existingIndex] = data;
			} else {
				// Add the new document
				console.log(' Add the new document')
				documents.push(data);
			}

			// Save the updated list back to localStorage
			localStorage.setItem('documents', JSON.stringify(documents));
		}
		// function SaveDocToLocalStorage(data) {
		//       var a = [];
		//       a = JSON.parse(localStorage.getItem('documents')) || [];


		//       a.push(data);
		//       localStorage.setItem('documents', JSON.stringify(a));
		//     }

		// // SAVE CONTACTS 
		async function SaveContactsToLocalStorage(contact) {
			console.log('SaveContactsToLocalStorage()');

			// Retrieve the contacts array from localStorage, or initialize an empty array if none exist
			var a = JSON.parse(localStorage.getItem('contacts')) || [];

			// Check if the address already exists
			var isDuplicate = a.some(existingContact => existingContact.address === contact.address);

			if (!isDuplicate) {
				console.warn('CONTACT IS ALREADY IN YOUR CONTACTS');
				a.push(contact);

				// Save the updated contacts list to localStorage
				localStorage.setItem('contacts', JSON.stringify(a));

				// Encrypt contacts to store in your DID
				let signer = await getSigner();
				if (!signer) {
					console.log('Handle case where signer is not obtained');
					return;
				}

				let pubkey = signer.publicKey;

				// Encrypt the contact list (variable 'a' instead of 'contacts')
				let encryptedContacts = await encryptData(a, pubkey);
				console.log('encryptedContacts: ', encryptedContacts);

				// Save the encrypted contacts to DID into a private field (not shown in this code)
				// ...

				return;
			} else {
				console.warn('Address already exists in your contacts, skipping save...');
				return;
			}
		}

		// async function SaveContactsToLocalStorage(contact) {
		// 			console.log('SaveContactsToLocalStorage()')
		// 			var a = [];
		// 			a = JSON.parse(localStorage.getItem('contacts')) || [];

		// 			// Check if the address already exists
		// 			var isDuplicate = a.some(existingContact => existingContact.address === contact.address);

		// 			if (!isDuplicate) {
		// 				// alert('CONTACT IS ALREDY HERE, DUPLICATE!')
		// 				console.warn('CONTACT IS ALREDY IN YOUR CONTACTS')
		// 				// console.warn('CONTACT IS ALREDY HERE, DUPLICATE!')
		// 				a.push(contact);
		// 				localStorage.setItem('contacts', JSON.stringify(a));

		// 				// encrypt contacts to store it in yourt DID
		// 				let signer = await getSigner() 
		// 				if (!signer) {
		// 					console.log('Handle case where signer is not obtained');
		// 				}
		// 				let pubkey = signer.publicKey;
		// 				let encryptedContacts = await encryptData(contacts, pubkey);
		// 				console.log('encryptedContacts: ', encryptedContacts)

		// 				//  save to did INTO PRIV FIELD


		// 				return


		// 			}
		// 			else {
		// 				// console.warn('CONTACT IS NOT IN YOUR CONTACTS??')
		// 				console.warn('Address already exists in your contacts, skipping save...');
		// 				// updateContactList(contact)
		// 				return
		// 			}
		// 		}

		function RemoveContactFromLocalStorage(address) {
			console.log('RemoveContactFromLocalStorage()');

			// Get the current contacts from local storage
			var contacts = JSON.parse(localStorage.getItem('contacts')) || [];

			// Filter out the contact with the specified address
			var updatedContacts = contacts.filter(contact => contact.address !== address);

			// Save the updated contacts back to local storage
			localStorage.setItem('contacts', JSON.stringify(updatedContacts));
			// encrypt and save to did?

			console.log('Contact removed successfully.');
			Toast.fire({ icon: 'warning', title: 'Contact removed successfully!', text: '' });
			loadContacts()
		}




		function addToAgenda() {
			console.log('addToAgenda()')
			// check if contact is already in your agenda

		}

		async function updateUsername(ethAddress, newUsername) {
			console.log('updateUsername()');
			var contacts = JSON.parse(localStorage.getItem('contacts')) || [];

			// Find the contact by address and update the username
			for (let i = 0; i < contacts.length; i++) {
				if (contacts[i].address === ethAddress) {
					contacts[i].username = newUsername;
					localStorage.setItem('contacts', JSON.stringify(contacts));
					console.log(`Username updated for contact with address ${ethAddress}`);
					Toast.fire({ icon: 'success', title: 'Contact updated!', text: '' });

					return;
				}
				else {
					console.log(`Contact with address ${ethAddress} not present`);

				}
			}

			console.log(`Contact with address ${ethAddress} not found`);
			// let contact = { address: ethAddress, username: newUsername, avatar: null, did: null }
			let contact = { address: ethAddress, username: newUsername, did: null }
			SaveContactsToLocalStorage(contact)
		}

		// Example usage
		// let ethAddress = '0x123...'; // Replace with actual Ethereum address
		// let newUsername = 'NewUsername'; // Replace with the new username you want to set

		// updateUsername(ethAddress, newUsername);



		async function chatHistory(addr) {

			let conversation = await iusnaturalisxmtp.conversations.newConversation(addr)
			const messages = await conversation.messages()

			for (const message of messages) {
				console.log(message.content);
			}
		}




		function simplifyDate(dateString) {
			// Create a new Date object
			var date = new Date(dateString);

			// Get current date
			var currentDate = new Date();

			// Define months array for formatting
			var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

			// Format the date
			var formattedDate;
			if (date.toDateString() === currentDate.toDateString()) {
				// If the date is today, display only time
				var hours = date.getHours();
				var minutes = date.getMinutes().toString().padStart(2, '0');
				var seconds = date.getSeconds().toString().padStart(2, '0');
				formattedDate = hours + ':' + minutes + ':' + seconds;
			} else {
				// If the date is not today, display day, month, and year
				formattedDate = date.getDate() + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
			}

			return formattedDate;
		}

		// // Example usage:
		// var dateString = "Wed May 01 2024 01:17:42 GMT-0300 (Argentina Standard Time)";
		// console.log(simplifyDate(dateString)); // Output: "01 May 2024"


		async function openCard(toAddr, avtr) {
			console.log('openCard()', toAddr, avtr);

			// Initial avatar image
			let avatar = "./anonym.jpg";

			// Prepare the basic HTML data
			let htmlData = `<address>${toAddr} <svg id="innerAddress" onclick="event.stopPropagation();customcopy2clipboard('${toAddr}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z" ></path></svg> </address><br>
    <p>Loading additional information  <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </p>`;

			// Show the initial modal with basic info
			Swal.fire({
				imageUrl: avtr,
				imageWidth: 300,
				imageHeight: 300,
				imageAlt: 'Avatar image',
				html: htmlData,
				showDenyButton: true,
				showCancelButton: false,
				showCloseButton: true,
				confirmButtonText: 'Trust',
				denyButtonText: 'Block',
				customClass: {
					actions: 'my-actions',
					cancelButton: 'order-1 right-gap',
					confirmButton: 'order-2',
					denyButton: 'order-3',
				},
			}).then((result) => {
				if (result.isConfirmed) {
					editContact(toAddr);
				} else if (result.isDenied) {
					RemoveContactFromLocalStorage(toAddr);
				}
			});

			// Fetch the DID record in the background
			let did = `did:ius:${toAddr}`;
			let rdid = await readDIDRecord(did);

			if (rdid.data == null) {
				console.warn('DID NULL, create ONE');
			} else {
				console.warn(`DID EXISTENT!:  ${rdid.data.id}`);

				// AVATAR
				if (rdid.data.avatar) {
					avatar = JSON.parse(rdid.data.avatar);
					console.log('We have an avatar');
				} else {
					console.log('Avatar data is empty');
				}

				// NAME
				let alias = rdid.data.alias;
				if (alias) {
					console.log('Name in DID: ', alias);
				} else {
					console.log('Alias data is empty');
				}

				// DOCUMENTS
				let docs = rdid.data.cid;
				// ds= docs
				if (docs) {
					console.log('Docs in DID: ');
					// PROCESS DOCS
					docs = await loadPublicDocsCard(docs)
					pd = docs

				} else {
					console.log('No docs in DID');
				}

				// Update the Swal modal with the fetched data
				Swal.update({
					imageUrl: avatar || "./anonym.jpg",
					html: `
                <address>${toAddr} <svg id="innerAddress" onclick="event.stopPropagation();customcopy2clipboard('${toAddr}')" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"> <path  fill="currentColor" d="M433.941 65.941l-51.882-51.882A48 48 0 0 0 348.118 0H176c-26.51 0-48 21.49-48 48v48H48c-26.51 0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51 0 48-21.49 48-48v-48h80c26.51 0 48-21.49 48-48V99.882a48 48 0 0 0-14.059-33.941zM266 464H54a6 6 0 0 1-6-6V150a6 6 0 0 1 6-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 0 1-6 6zm128-96H182a6 6 0 0 1-6-6V54a6 6 0 0 1 6-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 0 1-6 6zm6-256h-64V48h9.632c1.591 0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 0 1 1.757 4.243V112z" ></path></svg> </address><br>
                ${alias ? `<p>Name: ${alias}</p>` : '<p>Name not available</p>'}
                ${docs ? `<p>Public documents: ${docs}</p>` : '<p>No documents available</p>'}
            `
				});
			}
		}







		var cwContacts = document.getElementById('cwContacts');

		cwContacts.addEventListener('contextmenu', function (e) {
			e.preventDefault(); // Prevent the default context menu

			// Check if the right-click was on an li element
			if (e.target.tagName === 'LI') {
				// Increment your counter or perform any other action
				console.log('Right-clicked on li element');
			}
		});




		async function initChatClient(wallet) {
			console.warn(`
******************
initChatClient()
******************
`)
			// Create the client with your wallet. This will connect to the XMTP development network by default
			// const xmtp = await Client.create(wallet)
			const xmtp = await Client.create(wallet, { env: "dev", })

			// REGISTER CODECS

			// Support on-chain transaction references in your app built with XMTP
			// https://xmtp.org/docs/build/messages/transaction
			xmtp.registerCodec(new TransactionReferenceCodec());



			// const iusnaturalisxmtp = await Client.create(wallet)
			iusnaturalisxmtp = xmtp;//make global
			console.warn('iusnaturalisxmtp SET TO GLOBAL')
			// Listen for new conversations
			const stream = await iusnaturalisxmtp.conversations.stream()
			console.log('STREAM:', stream)

			//  registerCodecs(xmtp)
			await listExistingConversations(iusnaturalisxmtp)
			return xmtp
		}


		// // -----------------
		// // LISTEN TO ALLLLLL INCOMING!
		// OLD
		// 0000000000


		// -----------------
		// LISTEN TO ALLLLLL INCOMING!
		async function listenAllNewAddresses() {
			console.log('listenAllNewAddresses()')

			for await (const message of await iusnaturalisxmtp.conversations.streamAllMessages()) {

				// ppppppppppppppppppppppppppp
				// ALREADY LISTENING FIX
				// Set to store addresses of active conversations
				// const activeConversations = new Set();
				// aconv = activeConversations
				const senderAddress = message.senderAddress;
				sndadrr = senderAddress

				// Skip if the message is from yourself
				if (senderAddress === iusnaturalisxmtp.address) {
					console.log(`📣 conversation from yourself`);

					continue;
				}

				// // Check if the chat is already being listened to
				// if (activeConversations.has(senderAddress)) {
				//     console.log(`📣📣📣 Already listening to conversation with ${senderAddress}`);
				//     continue;
				// }

				// // Start listening to the conversation
				// activeConversations.add(senderAddress);
				// console.log(`Started new conversation with ${senderAddress}`);




				// ppppppppppppppppppppppp

				document.getElementById('chatBadge').style.display = 'inline'
				document.getElementById('chatBadge').innerText = '!'
				console.log(`New message from ${message.senderAddress}: ${message.content}`)
				newMessageToast.fire({ icon: 'info', title: `${message.senderAddress} says:`, text: message.content });
				showNotification(message.senderAddress, message.content)
				showNotification('new message:', ' check the dapp!')

				try {
					await playButtonClickSound()
					// addToAgenda()

				}
				catch (error) {
					console.error('Error getting did:', error.message);
				}

				// ########################
				// CHAT CODES
				// ########################
				if (message.content.includes("paymentReceived0x21")) {
					console.log("You received a payment from: ", message.senderAddress);
					m = message
					const txLinkMatch = message.content.match(/txLink="([^"]+)"/);
					let txLink;
					if (txLinkMatch && txLinkMatch[1]) {
						txLink = txLinkMatch[1];
						console.log("Transaction Link:", txLink);
					}
					else { console.log("txLink not found."); }
					Swal.fire({ icon: "success", title: `Received!🤑`, html: `<span class ="tx"> Here is the tx  <a href="${txLink}" target="_blank">Link</a> ✨✨✨</span>` });
				}

				if (message.content.includes("peerGasPaymentAccepted0x21")) {
					Swal.fire({ title: "Your gas is being payed by your peer!", width: 600, padding: "3em", background: "lightgreen ", backdrop: ` rgba(0,123,123,0.4) url("./nyan-cat.gif") left top no-repeat ` });

					setTimeout(() => {
						Swal.fire("Done!", "", "success");
						closeModalId('#walletSend')
					}, 3000);
				}

				if (message.content.includes("peerGasPaymentReques0x20")) {
					console.log("You received a peerGasPamentRequest from: ", message.senderAddress);
					conversation = await iusnaturalisxmtp.conversations.newConversation(message.senderAddress)
					Swal.fire({
						title: "Do you have some gas?",
						text: "your peer is asking you to pay for the gas",
						icon: "question",
						showDenyButton: true,
						showCancelButton: true,
						confirmButtonText: ` <i class="fa fa-thumbs-up"></i> Yes! `,
						denyButtonText: ` <i class="fa fa-thumbs-down"></i>  Decline`,
						cancelButtonText: `  Ignore`
					}).then(async (result) => {
						if (result.isConfirmed) {
							Swal.fire({ title: `You are paying for the gas for ${message.senderAddress} (it is being automaticalle discounted from your gas balance)!`, width: 600, padding: "3em", color: "#716add", background: "#fff ", backdrop: ` rgba(0,0,123,0.4) url("./nyan-cat.gif") left top no-repeat ` });
							await conversation.send(`user accepted to pay for the gas! <pre style="display: none;">peerGasPaymentAccepted0x21</pre>`);// Send a message
							setTimeout(() => {
								Swal.fire("Gas payed!(FAKE...)", "", "success");
							}, 5000);
						} else if (result.isDenied) {
							Swal.fire("You decline to pay for the gas", "", "info");
						}
					});
				}
				else { console.log("(DIRTYFIX)The message does not contain the text: 'can you pay for the gas?'"); }
				var storedContacts = [];
				let storedContacts = JSON.parse(localStorage.getItem('contacts')) || [];
				var index = storedContacts.findIndex(existingContact => existingContact.address === message.senderAddress);
				if (index === -1) {
					console.log('THIS ADDRESS IS NOT IN YOUR CONTACT LIST.. Adding new UNKNOWN (and unvalidated) contact.');
					addUnknownContact(message.senderAddress, message.content)
				}
				else {
					console.log('YES: THIS ADDRES IS IN YOUR CONTACT LIST')
					// alert('OVERWRITE last msg, INDEX:', storedContacts[index], index)
					console.log('OVERWRITE last msg, INDEX:', storedContacts[index], index)
					addknownContact(message.senderAddress, message.content)

				}

				updateBadge()
			}
		}




		// ------------------------
		// NEW
		// 1111111111111111
		// Set to store addresses of active conversations
		// const activeChats = new Set();
		// aconv = activeChats

		// Handle incoming messages
		// async function handleIncomingMessage(message) {
		//     const senderAddress = message.senderAddress;

		//     // Skip if the message is from yourself
		//     if (senderAddress === iusnaturalisxmtp.address) {
		//         console.log('📛 Skipping message from yourself.');
		//         return;
		//     }

		//     // Check if the chat is already being listened to
		//     if (activeConversations.has(senderAddress)) {
		//         console.log(`📣 Already listening to conversation with ${senderAddress}`);
		//         return;
		//     }

		//     // Start listening to the conversation
		//     activeConversations.add(senderAddress);
		//     console.log(`Started new conversation with ${senderAddress}`);

		//     // Display notification and badge
		//     document.getElementById('chatBadge').style.display = 'inline';
		//     document.getElementById('chatBadge').innerText = '!';

		//     console.log(`New message from ${senderAddress}: ${message.content}`);
		//     fixedToast.fire({ icon: 'info', title: `New message from ${senderAddress}`, text: message.content });

		//     await playButtonClickSound();
		//     await handleChatCodes(message);
		//     await updateContacts(message);
		//     updateBadge();
		// }



		/*********************************************************************************************
		.)  HANDLERS
		**********************************************************************************************/

		// Handle different chat codes
		async function handleChatCodes(message) {
			const content = message.content;

			if (content.includes("paymentReceived0x21")) {
				handlePaymentReceived(message);
			} else if (content.includes("peerGasPaymentAccepted0x21")) {
				handleGasPaymentAccepted();
			} else if (content.includes("peerGasPaymentReques0x20")) {
				await handleGasPaymentRequest(message);
			}
		}

		// Handle "paymentReceived" event
		function handlePaymentReceived(message) {
			console.log("You received a payment from: ", message.senderAddress);
			const txLinkMatch = message.content.match(/txLink="([^"]+)"/);
			let txLink = txLinkMatch ? txLinkMatch[1] : null;
			console.log("Transaction Link:", txLink || "txLink not found.");

			Swal.fire({
				icon: "success",
				title: "Received!🤑",
				html: `<span class ="tx"> Here is the tx <a href="${txLink}" target="_blank">Link</a> ✨✨✨</span>`
			});
		}

		// Handle "peerGasPaymentAccepted" event
		function handleGasPaymentAccepted() {
			Swal.fire({
				title: "Your gas is being paid by your peer!",
				width: 600,
				padding: "3em",
				background: "lightgreen",
				backdrop: `rgba(0,123,123,0.4) url("./nyan-cat.gif") left top no-repeat`
			});

			setTimeout(() => {
				Swal.fire("Done!", "", "success");
				closeModalId('#walletSend');
			}, 3000);
		}

		// Handle "peerGasPaymentRequest" event
		async function handleGasPaymentRequest(message) {
			console.log("You received a peerGasPaymentRequest from: ", message.senderAddress);
			const conversation = await iusnaturalisxmtp.conversations.newConversation(message.senderAddress);

			Swal.fire({
				title: "Do you have some gas?",
				text: "Your peer is asking you to pay for the gas",
				icon: "question",
				showDenyButton: true,
				showCancelButton: true,
				confirmButtonText: `<i class="fa fa-thumbs-up"></i> Yes!`,
				denyButtonText: `<i class="fa fa-thumbs-down"></i> Decline`,
				cancelButtonText: `Ignore`
			}).then(async (result) => {
				if (result.isConfirmed) {
					await conversation.send(`user accepted to pay for the gas! <pre style="display: none;">peerGasPaymentAccepted0x21</pre>`);
					Swal.fire({ title: `You are paying for the gas for ${message.senderAddress}!`, backdrop: `rgba(0,0,123,0.4) url("./nyan-cat.gif") left top no-repeat` });
				} else if (result.isDenied) {
					Swal.fire("You declined to pay for the gas", "", "info");
				}
			});
		}

		// Update contacts and handle new unknown contacts
		async function updateContacts(message) {
			console.warn('updateCOntacts:', message)
			const senderAddress = message.senderAddress;
			let storedContacts = JSON.parse(localStorage.getItem('contacts')) || [];

			// Check if contact already exists
			const index = storedContacts.findIndex(contact => contact.address === senderAddress);

			if (index === -1) {
				console.log('Adding new UNKNOWN contact.');
				addUnknownContact(senderAddress, message.content);
			} else {
				console.log('Updating known contact.');
				addKnownContact(senderAddress, message.content);
			}
		}






		async function listExistingConversations(xmtp) {
			console.warn('listExistingConversations() NO USADO?????')
			// List existing conversations
			const allConversations = await xmtp.conversations.list()
			console.log('AVAILABLE CHATS:', allConversations.length)
			const peerAddressesArray = [];

			allConversations.forEach(async (conversation, index) => {
				peerAddressesArray.push(conversation.peerAddress);

				// QUITAR SOLO PARA PRUEBA
				console.warn('listenNewChats() OMITED HERE')
				// await listenNewChats(conversation.peerAddress)
			})
			paa = peerAddressesArray;
			console.warn('!!!!! paa DECLARED !!!!!!!!!')

		}



		async function deleteChat(addr) {
			console.warn('👋 🔌 DELETING CHAT', addr)
			// clear URL
			removeParam('chat');
			// remove body's ATTRIBUTE
			document.body.removeAttribute('currentChat');

			// remove "TO" address from localStorage
			localStorage.removeItem('toAddress')

			// GOT TO CHAT TAB
			// openChat()
			closeSearch()

			//clear UI
			chatAddress.innerHTML = ''
			document.getElementById('chatBox').innerHTML = `<div class="container"> <div class="row justify-content-center"> <div class="col-10"> <div id="svg-container"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"> <image href="./logoius.svg" width="100%" height="100%"></image> </svg> <button type="button" id="" class="btn btn-primary " style="display: inline;" onclick="event.stopPropagation(); openChat()"> CHAT </button> </div> </div> </div> </div> `
			// DEACTIVATE BUTTONS
			document.getElementById('chatTextInput').disabled = true;
			document.getElementById('send-button').disabled = true;


			// AQUI TAMBIEN ELIMITAR CHAT
			closeConversation(addr);


		}



		function removeParam(key) {
			var url = new URL(window.location.href);
			url.searchParams.delete(key);
			window.history.replaceState({}, '', url);
		}




		async function createAlias(addr) {
			// const formattedAddress = ethers.utils.getAddress(addr);
			console.log('CREATE AN ALIAS FOR THIS ADDRESS', addr)
			// console.log('CREATE AN ALIAS FOR THIS ADDRESS',formattedAddress)

			// TEST
			// await iusnaturalisxmtp.registerCodec(new ContentTypeMultiplyNumberCodec());

			// const numbersToMultiply = { a: 3, b: 7 };

			// await conversation.send(numbersToMultiply, {
			// contentType: ContentTypeMultiplyNumbers,
			// });

		}


		// ----------------------------------
		// CHECK VALID ADDRESS


		async function isValidETHAddress(address) {
			// return ethers.utils.isAddress(address);
			return ethers.isAddress(address);
		}

		function isValidHex(address) {
			// Regular expression to check if a string is a valid hexadecimal
			const hexRegex = /^[0-9a-fA-F]+$/;
			return hexRegex.test(address);
		}

		function isValidStarkNetAddress(address) {
			// Remove the '0x' prefix if it exists
			const normalizedAddress = address.startsWith('0x') ? address.slice(2) : address;

			// Check if the address is a valid hexadecimal string and has the correct length
			return isValidHex(normalizedAddress) && normalizedAddress.length === 64;
		}

		async function getAddressType(address) {
			console.log('getAddressType()')
			// Check if it's a valid Ethereum address
			const isValidETH = await isValidETHAddress(address);
			if (isValidETH) {
				return 'ETH';
			}

			// Check if it's a valid StarkNet address
			const isValidStarkNet = isValidStarkNetAddress(address);
			if (isValidStarkNet) {
				return 'StarkNet';
			}

			// If neither, it's invalid
			return 'Invalid';
		}

		async function addAddress() {
			console.log('addAddress()')

			let cid = dictionary[globalLang]["addAddress"];

			let addressToAdd = Swal.fire({
				title: dictionary[globalLang]["addAddress"],
				footer: `
				<button type="button" id="" class="btn btn-danger" onclick="event.stopPropagation(); scanAddress()">
					${dictionary[globalLang]["scanqr"]}
            <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512">
              <path d="M0 80C0 53.5 21.5 32 48 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V80zM64 96v64h64V96H64zM0 336c0-26.5 21.5-48 48-48h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V336zm64 16v64h64V352H64zM304 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H304c-26.5 0-48-21.5-48-48V80c0-26.5 21.5-48 48-48zm80 64H320v64h64V96zM256 304c0-8.8 7.2-16 16-16h64c8.8 0 16 7.2 16 16s7.2 16 16 16h32c8.8 0 16-7.2 16-16s7.2-16 16-16s16 7.2 16 16v96c0 8.8-7.2 16-16 16H368c-8.8 0-16-7.2-16-16s-7.2-16-16-16s-16 7.2-16 16v64c0 8.8-7.2 16-16 16H272c-8.8 0-16-7.2-16-16V304zM368 480a16 16 0 1 1 0-32 16 16 0 1 1 0 32zm64 0a16 16 0 1 1 0-32 16 16 0 1 1 0 32z"></path>
            </svg>
          </button>
				`,
				input: 'text',
				inputAttributes: { autocapitalize: 'off' },
				showCancelButton: true,
				confirmButtonText: 'ok',
				showLoaderOnConfirm: true,
				preConfirm: (login) => { },
				backdrop: true,
				inputValidator: async (value) => {
					if (!value) {
						return 'You need to set a password to create your wallet!'
					}


					//  ADDR VERIFICATION
					const isValid = await getAddressType(value);

					if (isValid) {
						console.log(`Address ${value} is valid.`);
						// ---------------------
						// ANALIZE ADDRESS
						if (isValid === 'ETH') {
							console.log('Perform action for Ethereum address 🌽🌽🌽');
							let contact = { address: value, username: null, avatar: null, did: null }
							let userAddress = document.getElementById('yourAddress').getAttribute('address');
							console.log(value, userAddress)
							if (value == userAddress) {
								console.warn('🙅‍♂️ CANCELING chatwith() because CANNOT WITH SELF ADDRESS')
								Toast.fire('CANNOT CHAT WITH SELF ADDRESS', '🙅‍♂️', "warning");
								localStorage.removeItem('toAddress')// detele "TO" address from localStorage
								return
							}

							SaveContactsToLocalStorage(contact)
							// chatWith(toAddr ,imgsrc)
							// get avatar if available or get it async

							console.log('continue to chat 🍓🍓🍓');
							await chatWith(value)

							// ??????
							// console.log('NOW DELETE CHAT???? 🧂🧂🧂')
							// await deleteChat()

						}
						// ---------------
						else if (isValid === 'StarkNet') {
							console.log('Perform action for StarkNet address');
							let did = `did:starkid:${value}`
							let didData = await fetchDID(did)
							console.log('didData', didData)
							if (didData.data.alias || null) {
								console.log('alias is not null', didData.data.alias);
								let contact = { address: didData.data.alias, username: null, avatar: null, did: did }
								SaveContactsToLocalStorage(contact);
								await chatWith(didData.data.alias)
								await deleteChat()

							} else {
								console.log('alias is null');
							}

						}


						else {
							console.warn('Invalid address');
						}

					} else {
						console.log(`Address ${value} is not valid.`);
						return 'Address is not valid!'

					}

				},

				allowOutsideClick: () => {
					const popup = Swal.getPopup()
					popup.classList.remove('swal2-show')
					setTimeout(() => { popup.classList.add('animate__animated', 'animate__headShake') })
					setTimeout(() => { popup.classList.remove('animate__animated', 'animate__headShake') }, 500)
					return false
				},
			})
				.then(async (result) => {
					if (result.isConfirmed) {
						console.log('result.isConfirmed:')
						// await decryptWallet(result.value)
						return result.value
					}
				})
			console.log('addressToAdd:', addressToAdd)

			// close nav
			plToggle()

		}


		/*********************************************************************************************
		.)  Show Password Toggle
		**********************************************************************************************/

		function showPassToggle() {
			console.log('showPassToggle()')

			var ShowPasswordToggle = document.querySelector("[type='password']");
			ShowPasswordToggle.onclick = function () {
				document.querySelector("[type='password']").classList.add("input-password");
				document.getElementById("toggle-password").classList.remove("d-none");

				const passwordInput = document.querySelector("[type='password']");
				const togglePasswordButton = document.getElementById("toggle-password");

				togglePasswordButton.addEventListener("click", togglePassword);
				function togglePassword() {
					if (passwordInput.type === "password") {
						passwordInput.type = "text";
						togglePasswordButton.setAttribute("aria-label", "Hide password.");
					} else {
						passwordInput.type = "password";
						togglePasswordButton.setAttribute(
							"aria-label",
							"Show password as plain text. Warning: this will display your password on the screen."
						);
					}
				}
			};

		}




		// -------

		// 2. Store the Password Securely Using Biometrics
		async function storePasswordWithBiometrics(password, walletAddress) {
			console.log('storePasswordWithBiometrics: ', password, walletAddress)
			const passwordBuffer = new TextEncoder().encode(password);

			const publicKey = {
				challenge: new Uint8Array(32), // Dummy challenge
				rp: { name: "Web3 App" },
				user: {
					id: new TextEncoder().encode(walletAddress),
					name: walletAddress,
					displayName: "User with Wallet " + walletAddress
				},
				pubKeyCredParams: [{ alg: -7, type: "public-key" }],
				authenticatorSelection: {
					authenticatorAttachment: "platform",
					userVerification: "required"
				},
				timeout: 60000,
				attestation: "direct"
			};

			// Create a new biometric credential
			const credential = await navigator.credentials.create({ publicKey });

			// Encrypt the password with the public key (or just store it if using symmetric encryption)
			const encryptedPassword = btoa(String.fromCharCode(...passwordBuffer));
			localStorage.setItem('encryptedPassword', encryptedPassword);
			localStorage.setItem('credentialID', btoa(String.fromCharCode(...new Uint8Array(credential.rawId))));
		}



		// 3. Recall the Password Using Biometrics
		async function recallPasswordWithBiometrics(walletAddress) {
			const credentialID = Uint8Array.from(atob(localStorage.getItem('credentialID')), c => c.charCodeAt(0));

			const publicKey = {
				challenge: new Uint8Array(32), // Dummy challenge
				allowCredentials: [{
					id: credentialID,
					type: "public-key"
				}],
				timeout: 60000,
				userVerification: "required"
			};

			const assertion = await navigator.credentials.get({ publicKey });

			// Retrieve and decrypt the password
			const encryptedPassword = localStorage.getItem('encryptedPassword');
			const password = atob(encryptedPassword);

			console.warn('password:', password)
			return password;
		}

		// -------

		let currentStep = 1;
		let mnemonicPhrase = ""; // This should be generated and set when creating the wallet
		const displayMnemonic = document.getElementById('displayMnemonic');


		async function prevStep() {
			currentStep--;
			showStep(currentStep);
		}


		async function nextStep() {
			console.log('nextStep: ', currentStep);

			if (currentStep == 1) {
				console.log('check password and remember options')

				const form = document.getElementById('passwordForm');
				const passwordInput = document.getElementById('password');
				const rememberPassword = document.getElementById('rememberPassword').checked;
				const rememberPasswordwithBiometry = document.getElementById('rememberWithBiometry').checked;

				// Trigger validation
				if (!form.checkValidity()) {
					form.classList.add('was-validated');
					document.getElementById('rememberPassword').checked = false; // Uncheck the checkbox if validation fails
					document.getElementById('rememberWithBiometry').checked = false; // Uncheck the checkbox if validation fails
					return
				} else {

					let password = document.getElementById('password').value;

					if (rememberPasswordwithBiometry) {
						// Execute your function when the checkbox is checked and password is valid
						console.warn("Remember password with BIOMETRY activated .");

						// let password =  passwordInput.value 
						let password = document.getElementById('password').value;
						let walletAddress = document.getElementById('yourAddress').getAttribute('address');

						try {
							await storePasswordWithBiometrics(password, walletAddress)
						} catch (error) {
							console.error("Password cannot be stored with Biometrics:", error);
							document.getElementById('rememberWithBiometry').checked = false
							return

						}


					} else {
						console.log("Remember password with BIOMETRY deactivated.");
						// BORRAR CREDENCIALES BIOMETRICAS
						localStorage.removeItem("encryptedPassword");
						localStorage.removeItem("credentialID");

					}

					if (rememberPassword) {
						console.warn("Remember password with SESSION_STORAGE activated.");
						// let password = document.getElementById('password').value;

						try {
							// await storePasswordInSession(password)
							sessionStorage.setItem("password", password);

						} catch (error) {
							console.error("Password cannot be stored with SESSION_STORAGE:", error);
							document.getElementById('rememberPassword').checked = false
							return

						}
					} else {
						console.log("Remember password with SESSION_STORAGE deactivated.");
						sessionStorage.removeItem("password");

					}

					// remember to delete this later in the code
					sessionStorage.setItem("tempPassword", password);

				}
			}



			currentStep++;
			showStep(currentStep);
		}

		async function getMnemonic() {
			// Replace this with actual mnemonic generation logic
			// return "example mnemonic phrase generated by your wallet";
			// const unbackedWallet = localStorage.getItem('unbackedWallet');
			// let mnemonicPhrase = JSON.parse(unbackedWallet)
			// return mnemonicPhrase
			const unbackedWallet = localStorage.getItem('unbackedWallet');

			if (unbackedWallet) {
				try {
					let mnemonicPhrase = JSON.parse(unbackedWallet);
					return mnemonicPhrase;
				} catch (e) {
					console.error('Error parsing JSON from localStorage:', e);
					// Handle parsing error or provide fallback
					return null; // or some default value
				}
			} else {
				console.warn('unbackedWallet is not present in localStorage.');
				// Handle the case when unbackedWallet is not found
				// let pass = 	sessionStorage.getItem("tempPassword");
				// const encryptedWallet = localStorage.getItem('encryptedWallet');
				// let wallet =  await ethers.Wallet.fromEncryptedJson(encryptedWallet, pass)
				// let mnemonic = wallet.mnemonic.phrase;
				// return mnemonic

				try {
					let pass = sessionStorage.getItem("tempPassword");
					const encryptedWallet = localStorage.getItem('encryptedWallet');
					let wallet = await ethers.Wallet.fromEncryptedJson(encryptedWallet, pass)
					let mnemonic = wallet.mnemonic.phrase;
					return mnemonic
					// return mnemonicPhrase;
				} catch (e) {
					console.error('Error parsing  encryptedWallet:', e);
					// Handle parsing error or provide fallback
					return null; // or some default value
				}
				// return ethers.Wallet.fromEncryptedJson(encryptedWallet, pass)
				// return null; // or some default value
			}
			// return JSON.parse(unbackedWallet)
		}


		async function showStep(step) {
			switch (step) {


				case 1:

					displayMnemonic.innerHTML = `
						<form id="passwordForm" class="needs-validation" novalidate>
							<label for="password" class="form-label">SET YOUR Password</label>
							<div class="input-group">
								<input type="password" id="password" class="form-control rounded" required>
								<button id="toggle-password" type="button" class="d-none"
									aria-label="Show password as plain text. Warning: this will display your password on the screen.">
								</button>
								<div class="invalid-feedback">
									Please enter your password.
								</div>
							</div>
							<br>
							<div class="mb-3 form-check">
								<input type="checkbox" class="form-check-input" id="rememberPassword" checked>
								<label class="form-check-label" for="rememberPassword">Remember me</label>
							</div>
								<div class="mb-3 form-check">
								<input type="checkbox" class="form-check-input" id="rememberWithBiometry" >
								<label class="form-check-label" for="rememberWithBiometry">Use your device biometrics to store password</label>
							</div>
							<button class="btn btn-primary" type="button" onclick="nextStep()">Next</button>
						</form>
					`;
					showPassToggle()
					// toggleRememberPassword()
					break;


				case 2:
					mnemonicPhrase = await getMnemonic(); // Generate or retrieve the mnemonic phrase
					randomIndices = generateRandomIndices(mnemonicPhrase.split(" ").length); // Generate indices once
					displayMnemonic.innerHTML = `
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height='40px' width='40px' fill="currentColor">
                        <path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/>
                    </svg>
                    Write down your mnemonic phrase to access your wallet in the future!
                </h3>
                <div class="alert alert-warning alert-dismissible fade show">
                    <strong>${mnemonicPhrase}</strong>
                </div>
				<button class="btn btn-primary" type="button" onclick="prevStep()" >Prev</button>
                <button class="btn btn-primary" onclick="nextStep()">Next</button>
            `;
					break;
				case 3:
					// let mnemonicPhrase = await getMnemonic(); // Generate or retrieve the mnemonic phrase
					console.log('mnemonic in step 3:', mnemonicPhrase)
					displayMnemonic.innerHTML = `
                <form id="mnemonicForm" class="needs-validation" novalidate>
                    <h3>Verify your mnemonic phrase</h3>
                    <div id="mnemonicVerification">
                        ${generateVerificationFields(mnemonicPhrase)}
                    </div>
				<button class="btn btn-primary" type="button" onclick="prevStep()" >Prev</button>

                    <button class="btn btn-primary" type="submit">Verify</button>
                </form>
            `;

					const mnemonicForm = document.getElementById('mnemonicForm');
					mnemonicForm.addEventListener('input', verifyMnemonic, false); // Verify on each input
					mnemonicForm.addEventListener('submit', function (event) {

						const isValid = verifyMnemonic(); // Call the function to check if all words are correct

						if (!mnemonicForm.checkValidity() || !isValid) {
							event.preventDefault();
							event.stopPropagation();
						} else {
							event.preventDefault();
							// Action to perform when all mnemonic words are correct
							console.log("All words are correct!"); // Example action: log a message

							Toast.fire({ icon: 'success', title: 'All words are correct' });



							// You can replace the console log with any other action, such as:
							let tempPass = sessionStorage.getItem("tempPassword");
							encryptAndStoreWallet(tempPass)
							// mnemonicPhrase unbackedWallet or encryptedWallet?
							// - Navigating to the next step
							// - Displaying a success message
							// - Storing the information in local storage
							// - Triggering an API call

							// For example, to move to the next step:
							nextStep();



						}

						mnemonicForm.classList.add('was-validated');

					}, false);
					break;
				default:
					displayMnemonic.innerHTML = `
			<h3>✅ Mnemonic phrase backup completed! </h3>
			<button class="btn btn-secondary center"  onclick="closeModalId('#walletBackp')">Close</button>
			`;
					sessionStorage.removeItem("tempPassword");


			}
		}

		async function encryptAndStoreWallet(password) {
			console.log('encryptAndStoreWallet()')
			// recreate unbacked wallet
			const unbackedWallet = localStorage.getItem('unbackedWallet');
			const walletData = JSON.parse(unbackedWallet);

			let wallet = ethers.Wallet.fromPhrase(walletData);

			// now encrypt the json wallet and save it lo localstorage
			let encSigner = await wallet.encrypt(password)
			// }
			// catch (error) { console.warn(error.message, 'ERROR 2 WALLET!');  }

			localStorage.setItem('encryptedWallet', encSigner)

			// Now delete unbackedWallet and create encryptedWallet/encryptedJsonWallet
			console.log('unbackedWallet deleted from localStorage')
			localStorage.removeItem('unbackedWallet')
		}


		function generateRandomIndices(length) {
			// Generate a unique set of indices
			const indices = new Set();
			while (indices.size < 3) {
				indices.add(Math.floor(Math.random() * length));
			}
			return Array.from(indices);
		}

		function generateVerificationFields(mnemonic) {
			const words = mnemonic.split(" ");
			let verificationFields = "";

			randomIndices.forEach(index => {
				verificationFields += `
            <div class="form-group">
                <label for="word${index}">Enter word #${index + 1}</label>
                <input type="text" id="word${index}" class="form-control" required>
                <div class="invalid-feedback">
                    Please enter the correct word.
                </div>
            </div>
        `;
			});

			return verificationFields;
		}

		function verifyMnemonic() {
			console.log('verifyMnemonic()')

			const words = mnemonicPhrase.split(" ");
			let allCorrect = true;

			randomIndices.forEach(index => {
				const input = document.getElementById(`word${index}`);
				if (input) {
					if (input.value.trim() !== words[index]) {
						allCorrect = false;
						input.classList.add("is-invalid");
						// Toast.fire({ icon: 'error', title: 'Please verify the mnemonic phrase again' });

					} else {
						input.classList.remove("is-invalid");
						input.classList.add("is-valid");
					}
				} else {
					allCorrect = false;
					Toast.fire({ icon: 'error', title: 'allCorrect = false' });

				}
			});

			// Toast.fire({ icon: 'info', title: `allCorrect = ${allCorrect}`});

			return allCorrect;
		}



		/*********************************************************************************************
		.)  SETTINGS
		**********************************************************************************************/
		async function getPasswordWithModal() {
			console.warn('getPasswordWithModal()')
			return Swal.fire({
				title: dictionary[globalLang]["unlockWallet"],
				showCancelButton: false,
				showDenyButton: true,

				confirmButtonText: 'Enter',
				denyButtonText: `Cancel`,

				showLoaderOnConfirm: true,
				// backdrop: true,

				input: 'password',
				inputAttributes: { autocapitalize: 'off' },
				backdrop: true,
				html: `				
					<br>
					<input type="checkbox" id="rememberPassword" name="rememberPassword" checked> 
					<label for="rememberPassword">Remember password</label> 
					`,
				footer: '<a href="/docs/index.html#" target="_blank" rel="noopener noreferrer">Docs</a>',
				preConfirm: (value) => {
					if (!value) {
						Swal.showValidationMessage('<i class="fa fa-info-circle"></i> A password is required')
					}

				},
				allowOutsideClick: () => { const popup = Swal.getPopup(); popup.classList.remove('swal2-show'); setTimeout(() => { popup.classList.add('animate__animated', 'animate__headShake'); }); setTimeout(() => { popup.classList.remove('animate__animated', 'animate__headShake'); }, 500); return false; },
			})
				.then(async (result) => {
					if (result.isConfirmed) {

						const password = result.value;
						const rememberCheckbox = Swal.getPopup().querySelector('#rememberPassword');
						console.log('password entered!', result.value);
						// console.log('rememberPasswordCheckboxentered!',rememberCheckbox.value);
						console.log('checked?', rememberCheckbox.checked);

						return { password, rememberCheckbox }
					}
					if (result.isDenied) {
						console.log('cancelled');
						return false

					}

					// return result.value

				})

		}

		async function settings() {
			console.log('settings()')
			openModalId('#settingsModal')
			loadSettingsPreferences()

		}



		/*********************************************************************************************
		.)  BACKUP
		**********************************************************************************************/

		async function backup(mnemonicPhrase) {
			console.warn('backup()')
			// openModalId('#walletBackp')
			// closeModalId('#settingsModal')
			walletbackpfooter.innerHTML = `<a href="/docs/index.html#/?id=la-frase-mnemot%c3%a9cnica" target="_blank" rel="noopener noreferrer">Check out the documentation!</a> `

			// REMOVE HEADER ALERT 
			headerNotes.innerHTML = ``

			// -----------------
			// get mnemonicphrase
			// -----------------

			//  IS UNBACKEDWALLET?
			const unbackedWallet = localStorage.getItem('unbackedWallet');
			if (!unbackedWallet) {
				console.warn('No unbackedWallet found. Checking for encryptedWallet.');

				// 3-  NO UNBACKED WALLET, is JSONWALLET?
				const encryptedWallet = localStorage.getItem('encryptedWallet');
				if (!encryptedWallet) {
					console.warn('No encryptedWallet found.');

				} else {
					// console.warn('3- YES JSON WALLET')
					console.warn('YES encryptedWallet found. Checking for jsonWalletPassword.');
					const jsonWalletPassword = sessionStorage.getItem('password');
					if (!jsonWalletPassword) {
						console.warn('No password found.');
						console.error('No password found.');

						// return

					} else {
						console.warn('encryptedWallet and jsonWalletPassword found.');
						// THIS IS FOR JUST BACKING UP THE MNEMONIC(as the unbacked wallet was already backed up)
						// GET password to decript the wallet
						// --------------------------------------------------------
					}
					closeModalId('#settingsModal')

					let getPassword = await getPasswordWithModal()
					if (!getPassword) {
						console.log("Password retrieval failed.");
						return
					} else {
						console.log("Password retrieved successfully.");
						console.log('PASSWORDDDDDD: ', getPassword)
						gp = getPassword
					}

					//  return
					openModalId('#walletPassword')

					//  let password= getPassword.value.backupPassword.value;
					let password = getPassword.password;
					let encryptedjson = localStorage.getItem('encryptedWallet');
					let ew = JSON.parse(encryptedjson);
					console.log('pub key of wallet in localstorage:', ew.address);
					let wallet;
					try {
						wallet = await ethers.Wallet.fromEncryptedJson(encryptedjson, password)
						w = wallet

					}
					catch (error) {
						console.error('Error during wallet decryption:', error);
						// Toast.fire('Error', error.message, "error");
						backedWalletMnemonic.innerHTML = `
								<div class="alert alert-danger alert-dismissible fade show" role="alert">
								<strong>Error!</strong> Something went wrong. Please try again.
								</div>

								`

						return null;
						// return null;
					}

					const rememberPasswordCheckbox = getPassword.rememberCheckbox

					if (rememberPasswordCheckbox.checked) {
						sessionStorage.setItem("password", password);

					} else {
						sessionStorage.removeItem("password");

					}

					console.warn('MNEMONIC: ', wallet.mnemonic.phrase)

					backedWalletMnemonic.innerHTML = `
									<h3>
										<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height='40px' width='40px' fill="currentColor">
											<path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/>
										</svg>
										Write down your mnemonic phrase to access your wallet in the future!
									</h3>
									<div class="alert alert-warning alert-dismissible fade show">
										<strong>${wallet.mnemonic.phrase}</strong>
									</div>
									<button class="btn btn-secondary center"  onclick="closeModalId('#walletPassword')">Close</button>
								
								`;
					// class="alert alert-danger alert-dismissible fade show"
					return
					// --------------------------------------------------------

					// }

				}
			} else {
				// Handle unbackedWallet
				console.warn('2- YES unbackedWallet')
				openModalId('#walletBackp')
				closeModalId('#settingsModal')
				showStep(currentStep);

			}

			// -----------------
			// Initialize the first step
			// showStep(currentStep);


			return

		}

		async function restoreWallet() {
			console.warn('restoreWallet()')
			openModalId('#walletRestore')
			closeModalId('#settingsModal')



			// DETECT IF ARE WORDS OR PRIVATE KEYS
			const input = document.getElementById("seedTextarea").value.trim();
			const privateKeyRegex = /^0x[a-fA-F0-9]{64}$/;
			const seedPhraseRegex = /^(\b[A-Za-z]+\b\s){11}(\b[A-Za-z]+\b)$/;

			seedTextarea.addEventListener('input', function (evt) {
				console.log(this.value);

				// IF PRIVATE KEY
				if (privateKeyRegex.test(this.value)) {
					console.warn("Private Key Detected");
					seedTextarea.classList.add("is-valid");
				}

				// IF SEEDPHRASE
				// else if (seedPhraseRegex.test(this.value)) {
				else if (seedPhraseRegex.test(this.value.trim())) {

					let cntwrds = countWords(this.value)

					if (cntwrds >= 12) {
						console.warn("Seed Phrase complete!");
						setWalletRestore.disabled = true;
						seedTextarea.classList.add("is-valid");
						// HERE
						setWalletRestore.disabled = false;


					} else {
						console.warn("less than 12 words");
						setWalletRestore.disabled = false;
						setWalletRestore.disabled = true;

					}
				}

				else {
					console.warn("not valid");
					seedTextarea.classList.remove("is-valid");

				}


			});
		}

		function successAnim() {

			function PathLoader(el) {
				this.el = el;
				this.strokeLength = el.getTotalLength();
				// set dash offset to 0
				this.el.style.strokeDasharray =
					this.el.style.strokeDashoffset = this.strokeLength;
			}

			PathLoader.prototype._draw = function (val) {
				this.el.style.strokeDashoffset = this.strokeLength * (1 - val);
			}

			PathLoader.prototype.setProgress = function (val, cb) {
				this._draw(val);
				if (cb && typeof cb === 'function') cb();
			}

			PathLoader.prototype.setProgressFn = function (fn) {
				if (typeof fn === 'function') fn(this);
			}

			var body = document.body,
				svg = document.querySelector('svg path');

			if (svg !== null) {
				svg = new PathLoader(svg);

				setTimeout(function () {
					document.body.classList.add('active');
					svg.setProgress(1);
				}, 200);
			}

			document.addEventListener('click', function () {

				if (document.body.classList.contains('active')) {
					document.body.classList.remove('active');
					svg.setProgress(0);
					return;
				}
				document.body.classList.add('active');
				svg.setProgress(1);
			});
		}

		function countWords(str) {
			let lngth = str.trim().split(/\s+/).length;
			console.log('countWords:', lngth)
			return lngth;
		}

		// not usded?
		async function restoreSeed() {
			console.warn('restoreSeed()')

			// check if password is set
			// #seedPassword
			const passwordInput = document.getElementById('seedPassword');

			// Check if the input is empty
			if (passwordInput.value.trim() === '') {
				passwordInput.classList.add('is-invalid');
				passwordInput.classList.remove('is-valid');
				return
			} else {
				passwordInput.classList.remove('is-invalid');
				passwordInput.classList.add('is-valid');
			}

			// CREATE WALLET:
			let seed = seedTextarea.value.trimStart().trimEnd();
			let wallet
			try {
				wallet = await ethers.Wallet.fromPhrase(seed);

			} catch (error) {

			}
			w = wallet


			// ..............................................
			// if selected save password to sessionStorage
			let password = passwordInput.value.trim();
			let rememberPasswordCheckbox = document.getElementById('wrememberPassword')
			console.log('password entered!');

			if (rememberPasswordCheckbox.checked) {
				console.log("password checked");
				sessionStorage.setItem("password", password);

			} else {
				console.log("password NOT checked");
				sessionStorage.removeItem("password");

			}

			// now encrypt the json wallet and save it lo localstorage
			let encWallet = await wallet.encrypt(password)
			console.log('encWallet:', encWallet)
			localStorage.setItem('encryptedWallet', encWallet)
			await localStorage.removeItem('unbackedWallet')
			console.log('unbackedWallet deleted from localStorage')


			// RECREATE THE SIGNER
			// return
			// let decryptedWallet = ethers.Wallet.fromEncryptedJson()
			// let signer = wallet.connect
			closeModalId('#walletRestore')
			seedTextarea.value = ''
			console.log('signer:! ', wallet)

			headerNotes.innerHTML = ``
			setAddress(wallet.address)
			await loadDID(wallet)
			syncBalance()


			// remove xmtp from localstorage
			const prefix = 'xmtp/dev/';
			for (let i = localStorage.length - 1; i >= 0; i--) {
				const key = localStorage.key(i);
				if (key && key.startsWith(prefix)) {
					localStorage.removeItem(key);
				}
			}
			await init(wallet)

		}




		/*********************************************************************************************
		.)   MANAGE DID
		**********************************************************************************************/
		// id: string; 
		// avatar: string; 
		// alias: string; 
		// privData: string; 
		// cid: string; 
		// publicKey: PublicKey;


		async function loadDID(signer) {
			let did = `did:ius:${signer.address}`

			// IF. READ DID 
			console.log('💬 READ YOUR DID:', did)
			let rdid = await readDIDRecord(did);
			rd = rdid
			if (rdid.data == null) {
				console.warn('DID NULL, creatre ONE')
				let avatar = '';
				let alias = signer.address;
				let privData = '';
				let cid = '';
				try {
					const result = await createDIDRecord(did, avatar, alias, privData, cid, signer);
					if (result) {
						console.log('The DID record was created successfully.');
					} else {
						console.warn('Failed to create the DID record.');
					}
				} catch (error) {
					console.error('An error occurred while creating the DID record:', error);
				}

			} else {
				console.warn(`DID EXISTENT!:  ${rdid.data.id}`);

				// CHECK if avatar
				let avtr = rdid.data.avatar;
				if (avtr) {
					let avatar = JSON.parse(avtr);
					document.getElementById('avatarIMG').src = avatar;
					document.getElementById('aliasAvatar').src = avatar;
				} else {
					console.log('Avatar data is empty');
				}

				let alias = rdid.data.alias;
				if (alias) {
					// let alias = JSON.parse(alias);
					// document.getElementById('avatarIMG').src = avatar;
					// document.getElementById('aliasAvatar').src = avatar;
					document.getElementById('aliasName').value = alias;
					document.getElementById('userAlias').innerText = alias;



				} else {
					console.log('aliasName data is empty');
				}

				// ACTIVATE BUTTON TO MINT OR UPDATE
				document.getElementById('mintOrUpdate').disabled = false;

			}
		}

		async function fetchDID(did) {
			try {
				const didresult = await readDIDRecord(did);

				if (didresult.data != null) {
					console.log(did + ' HAS A RECORD!!!');
					return didresult
				} else {
					console.log(did + ' DOESN\'T HAVE A RECORD :(');
					return
				}
			} catch (error) {
				console.error('An error occurred while fetching the DID record:', error);
			}
		}

		async function fetchDIDRecord(did) {
			try {
				const didresult = await readDIDRecord(did);

				if (didresult.data) {
					console.log(`${did} HAS A RECORD!!!`);

					const avtr = didresult.data.avatar;
					if (avtr) {
						const avatar = JSON.parse(avtr);
						//   document.getElementById(did).src = avatar;
						return avatar
					}
					// else {
					//   console.log('Avatar data is empty');
					// }
				} else {
					console.log(`${did} DOESN'T HAVE A RECORD `);
				}
			} catch (error) {
				console.warn('Warn on DID record:', error);
				throw error;
			}
		}

		async function createDIDRecord(did, avatar, alias, privData, cid, signer) {
			console.log('Now you have the signer, do whatever you need with it:', signer);
			const db = new Polybase({ defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID", });
			const data = [did, avatar, alias, privData, cid];
			db.signer(async (data) => {
				const signature = await signer.signMessage(data);//FIXED!
				return { h: 'eth-personal-sign', sig: signature, };
			});

			const collectionReference = db.collection("STARKID");
			await collectionReference.create(data);

		}

		async function readDIDRecord(id) {
			const db = new Polybase({
				defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
			});

			const collectionReference = db.collection("STARKID");
			const record = await collectionReference.record(id).get();
			const { data } = record; // or const data = record.data
			const resultRecord = record.get();
			// console.log('resultRecord:', resultRecord)
			return resultRecord
		}

		async function deleteDID(did, signer) {
			console.log('deleteDID()')

			const db = new Polybase({
				defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
			});

			db.signer(async (did) => {
				console.log('data:', did)
				const signature = await signer.signMessage(did);
				return { h: 'eth-personal-sign', sig: signature, };
			});
			try {
				const recordData = await db
					.collection("STARKID")
					.record(did)
					.call("deleteDID");
			} catch (error) {
				console.error("An error occurred:", error);
			}
			return true

		}

		async function updateAvatarDID(did, newdata, signer) {
			console.log('updateDID()')

			const db = new Polybase({
				defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
			});

			// const newdatab = [did, newdata];

			db.signer(async (newdata) => {
				console.log('data:', newdata)
				const signature = await signer.signMessage(newdata);
				return { h: 'eth-personal-sign', sig: signature, };
			});
			try {
				const recordData = await db
					.collection("STARKID")
					.record(did)
					.call("updateAvatar", [newdata]);
				console.log("recordData:", recordData);
				console.warn('suscesfully updated DID')
				Toast.fire({ icon: 'success', title: 'suscesfully updated DID' });


			} catch (error) {
				console.error("An error occurred:", error);
				fixedToast.fire('Error', error.message, "error");

			}
			return true

		}

		async function updateAliasDID(did, newdata, signer) {
			console.log('updateDID()')

			const db = new Polybase({
				defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
			});

			// const newdatab = [did, newdata];

			db.signer(async (newdata) => {
				console.log('data:', newdata)
				const signature = await signer.signMessage(newdata);
				return { h: 'eth-personal-sign', sig: signature, };
			});
			try {
				const recordData = await db
					.collection("STARKID")
					.record(did)
					.call("updateAlias", [newdata]);
				console.log("recordData:", recordData);
			} catch (error) {
				console.error("An error occurred:", error);
			}
			return true
		}

		async function updatePrivDataDID(did, newdata, signer) {
			console.log('updateDID()')

			const db = new Polybase({
				defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
			});

			// const newdatab = [did, newdata];

			db.signer(async (newdata) => {
				console.log('data:', newdata)
				const signature = await signer.signMessage(newdata);
				return { h: 'eth-personal-sign', sig: signature, };
			});
			try {
				const recordData = await db
					.collection("STARKID")
					.record(did)
					.call("updatePrivData", [newdata]);
				console.log("recordData:", recordData);
			} catch (error) {
				console.error("An error occurred:", error);
			}
			return true


		}


		async function updateDIDdocs(id, newdocs) {
			console.log('updateDIDdocs()')

			//   let signer = await getLocalWalletSigner();
			let signer = await getSigner()

			if (!signer) {
				console.log('Handle case where signer is not obtained');
			}
			else {
				console.log('Now you have the signer, do whatever you need with it:', signer);
				// defaultNamespace: "pk/0xee1b340c80295bb60ada66e0396a44b70c479a857c357b37883d27efe030aaf8baf25fde75eaf8881bb6c0f34fac20dbf6896fc373d5835e43ffe01f216feab9/IURISNATURALIS" 
				const db = new Polybase({
					defaultNamespace: "pk/0x97eab0841786aeae14135af5e26750626e46e2e15a412b6a319dd2ce7f323c805d67fcfb0f8ea1f27959e486e11e49926fbf4b1c2b9252daa20283e200e3b1b3/STARKID",
				});

				db.signer(async (newdocs) => {
					console.log('docs to sign:', newdocs)

					const hash = ethers.sha256(ethers.toUtf8Bytes(newdocs));
					console.log('sha-256', hash);

					const signature = await signer.signMessage(newdocs);
					console.log('signature:', signature)

					return { h: 'eth-personal-sign', sig: signature, };
				});

				try {
					const recordData = await db
						.collection("STARKID")
						.record(id)
						.call("updateCID", [newdocs]);
					console.log(" updateCID:", recordData);

				} catch (error) {
					console.error("An error occurred:", error);
					console.error("Error:", error.reason);
					fixedToast.fire('Error', error.message, "error");
				}
			}
		}



		/*********************************************************************************************
		.)   ENCRYPT FUNCITONS
		**********************************************************************************************/

		async function encryptPrivkey(privkey, pubkey, toEncrypt) {
			console.log('encryptPrivkey()', toEncrypt)
			// 0. coniverte en estring la eth priv key
			const secretMessage = EthCrypto.cipher.stringify(toEncrypt);
			console.log('ethPrivKeyString: ', secretMessage)

			// 1.
			const signature = EthCrypto.sign(privkey, EthCrypto.hash.keccak256(secretMessage));
			console.log('signature: ', signature)

			// 2.
			const payload = { message: secretMessage, signature };

			// 3.
			const encrypted = await EthCrypto.encryptWithPublicKey(pubkey, JSON.stringify(payload));

			console.log('Alice encrypted ETH private key to store in registry:', encrypted)

			// 4.
			// we convert the object into a smaller string-representation
			const encryptedString = EthCrypto.cipher.stringify(encrypted);
			console.log('Alice encrypted ETH private key to store in registry STRING: ', encryptedString)
			// return encryptedString
			return encryptedString

		}

		async function decryptPrivData(privkey, pubkey, toDecrypt) {
			console.log('encryptPrivkey()', toDecrypt)

			// ---------------
			// DECRYPTING
			// we parse the string into the object again
			const encryptedObject = EthCrypto.cipher.parse(toDecrypt);
			const decrypted = await EthCrypto.decryptWithPrivateKey(privkey, encryptedObject);
			const decryptedPayload = JSON.parse(decrypted);
			console.log('DECRYPRED✅!!!', decryptedPayload)
			// check signature
			const senderAddress = EthCrypto.recover(decryptedPayload.signature, EthCrypto.hash.keccak256(decryptedPayload.message));
			console.log('ETH Private key stored  by  ' + senderAddress + '<br>is: ' + decryptedPayload.message);
			// result.innerHTML = '<br><br>✅✅✅ STARKNET Private key DECRYPTED  ✅✅✅  by  ' + senderAddress + ' is: <br> ' + decryptedPayload.message

			return [decryptedPayload.message, senderAddress]


		}




		/*********************************************************************************************
		.)   UPDATE IMAGE AVATAR
		**********************************************************************************************/

		avatarIMG.onclick = function (e) {
			console.log('avatarIMG clicked')
			e.preventDefault()

			openModalId('#didManagerModal')
			// loadCroppedImg()
			loadDocs();

		};

		changeAvatar.onclick = function (e) {
			console.log('aliasAvatar clicked')
			e.preventDefault()

			loadCroppedImg()

		};

		async function compressImage(imageSrc, maxSizeKB) {
			return new Promise((resolve, reject) => {
				const img = new Image();
				img.onload = function () {
					const canvas = document.createElement('canvas');
					const ctx = canvas.getContext('2d');

					// Calculate new dimensions to maintain aspect ratio
					const MAX_WIDTH = 800;
					const MAX_HEIGHT = 600;
					let width = img.width;
					let height = img.height;
					if (width > height) {
						if (width > MAX_WIDTH) {
							height *= MAX_WIDTH / width;
							width = MAX_WIDTH;
						}
					} else {
						if (height > MAX_HEIGHT) {
							width *= MAX_HEIGHT / height;
							height = MAX_HEIGHT;
						}
					}

					// Set canvas dimensions
					canvas.width = width;
					canvas.height = height;

					// Draw image on canvas
					ctx.drawImage(img, 0, 0, width, height);

					// Convert canvas to Blob and compress to target size
					canvas.toBlob(function (blob) {
						// Check if compressed image is within target size
						if (blob.size / 1024 <= maxSizeKB) {
							// Resolve with the compressed data URL
							resolve(canvas.toDataURL());
						} else {
							// Reject if compressed image size exceeds target size
							reject('Compressed image size exceeds the specified limit');
						}
					}, 'image/jpeg', 0.7); // Adjust the quality factor (0.7 here) to achieve desired compression level
				};
				img.src = imageSrc;
			});
		}

		async function loadCroppedImg() {
			console.log('loadCroppedImg()');

			// openModalId('#createDIDModal')
			// fileCreateItemFile => avatarIMGfile 

			await avatarIMGfile.click();
			let previewsrc;

			avatarIMGfile.onchange = async function () {
				if (avatarIMGfile.files.length == 1) {
					const data = this.files[0];
					const name = data.name;

					// Read the file and get its base64 data
					let reader = new FileReader();
					reader.readAsDataURL(data);

					reader.onload = async function () {
						previewsrc = reader.result;

						// Compress the image
						const compressedDataUrl = await compressImage(previewsrc, 100); // 100KB limit

						// Display the image in a SweetAlert2 popup
						Swal.fire({
							html: `
                        <img id="preview" src="${compressedDataUrl}" style="display:none">
                        <div>
                            <img id="cropperjs" src="${compressedDataUrl}">
                        </div>
                    `,
							allowOutsideClick: () => {
								const popup = Swal.getPopup();
								popup.classList.remove('swal2-show');
								setTimeout(() => {
									popup.classList.add('animate__animated', 'animate__headShake');
								});
								setTimeout(() => {
									popup.classList.remove('animate__animated', 'animate__headShake');
								}, 500);
								return false;
							},
							willOpen: () => {
								const image = document.querySelector('#cropperjs');
								// const cropper = new Cropper(image, {
								cropper = new Cropper(image, {
									// aspectRatio: '4:3',
									aspectRatio: 1 / 1,
									viewMode: 1,
									crop: throttle(function () {
										const croppedCanvas = cropper.getCroppedCanvas();
										// console.log('croppedCanvas:', croppedCanvas);

										const preview = document.querySelector('#preview');
										preview.src = croppedCanvas.toDataURL();

										let cropperinfo = cropper.getContainerData()
										// console.log("cropperinfo:",cropperinfo)
									}, 25),
								});
							},
							preConfirm: () => {
								const popup = Swal.getPopup();
								if (popup) {
									const previewElement = popup.querySelector('#preview'); // Assuming preview is the ID of the image element
									if (previewElement instanceof HTMLImageElement) {
										return previewElement.src;
									}
								}
							},
						}).then(async function (result) {
							avatarIMG.src = result.value;
							aliasAvatar.src = result.value;
							let b64 = JSON.stringify(result.value);
							console.log('b64 image:', b64);
							localStorage.setItem('avatar', b64);
							avatarIMG.style.display = 'block';
							// Toast.fire('Avatar added', '', "success");


							// ...........................................................................................
							// 3.RECORD TO ZKROLLUP DB
							// ..........................................................................................

							let avatar = localStorage.getItem('avatar');
							let cid = '';

							// ------------------------------------
							// GET SIGNER
							let presigner = await getSigner()
							let provider = new ethers.JsonRpcProvider(`${optionsList[0].API}`); //v5
							let signer = presigner.connect(provider);
							console.log('SIGNER!:', signer);
							let did = `did:ius:${signer.address}`
							console.log('DID: ', did)

							// ---------------

							try {
								console.log('creating did RECORD, signer', signer)
								await updateAvatarDID(did, avatar, signer)
							} catch (error) {
								console.error('An error occurred while creating DID record:', error);
								return
							}

							// REMOVE FROM LOCALSTORAGE
							localStorage.removeItem('avatar');
							console.warn('AVATAR REMOVED FROM LOCALSTORAGE!🚫')


						});
					};
				}
			};
		}





		/*********************************************************************************************
		.)  MINT OR UPDATE ONCHAIN DID
		**********************************************************************************************/

		async function mintOrUpdate() {
			console.log('mintOrUpdate()')

			openModalId('#didMinterModal')

			return
			// Example CID to register
			const cid = "QmYwAPJzv5CZsnAztbqiXLypCQzqJGdUJwHThYro4Mwdd2";

			// Call the function
			await registerOnchainDID(cid);

		}


		async function registerOnchainDID(cid) {

			const provider = new ethers.JsonRpcProvider(optionsList[0].API);
			let chatETHPrivKey = localStorage.getItem('chatETHPrivKey');
			let signer = await new ethers.Wallet(chatETHPrivKey)
			const contractAddress = optionsList[0].REGISTRY_CONTRACT_ADDRESS
			const contractABI = [
				"function registerDID(string memory _cid) public",
				"event DIDRegistered(bytes32 indexed didHash, string cid)"
			];


			const connectedSigner = await signer.connect(provider);

			// Create contract instance
			const contract = new ethers.Contract(contractAddress, contractABI, connectedSigner);


			try {
				// Call the registerDID function
				const tx = await contract.registerDID(cid);

				console.log("Transaction sent:", tx.hash);

				// Wait for the transaction to be mined
				const receipt = await tx.wait();
				console.log("Transaction mined:", receipt);

				Swal.fire({
					icon: "success",
					title: "Done",
					text: "Tx succesfull!",
					footer: `<a target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/tx/${receipt.hash}">Tx link</a>`
				});


			} catch (error) {
				console.error("Error registering DID:", error);
				console.error("Error message:", error.error.message);
				e = error;
			}
		}


		async function updateOnchainDID(cid) {

			const provider = new ethers.JsonRpcProvider(optionsList[0].API);
			let chatETHPrivKey = localStorage.getItem('chatETHPrivKey');
			let signer = await new ethers.Wallet(chatETHPrivKey)
			const contractAddress = optionsList[0].REGISTRY_CONTRACT_ADDRESS
			const contractABI = [
				"function registerDID(string memory _cid) public",
				"event DIDRegistered(bytes32 indexed didHash, string cid)"
			];


			const connectedSigner = await signer.connect(provider);

			// Create contract instance
			const contract = new ethers.Contract(contractAddress, contractABI, connectedSigner);


			try {
				// Call the registerDID function
				const tx = await contract.registerDID(cid);

				console.log("Transaction sent:", tx.hash);

				// Wait for the transaction to be mined
				const receipt = await tx.wait();
				console.log("Transaction mined:", receipt);

				Swal.fire({
					icon: "success",
					title: "Done",
					text: "Tx succesfull!",
					footer: `<a target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/tx/${receipt.hash}">Tx link</a>`
				});


			} catch (error) {
				console.error("Error registering DID:", error);
			}
		}


		async function getDID() {
			const provider = new ethers.JsonRpcProvider(optionsList[0].API);
			let chatETHPrivKey = localStorage.getItem('chatETHPrivKey');
			let signer = await new ethers.Wallet(chatETHPrivKey)
			const contractAddress = optionsList[0].REGISTRY_CONTRACT_ADDRESS
			const contractABI = ["function cids(address) view returns (string)"];

			// Create contract instance
			const contract = new ethers.Contract(contractAddress, contractABI, provider);

			// Address to query
			let addressToQuery = signer.address;
			try {
				// Call the cids function
				const cid = await contract.cids(addressToQuery);
				console.log("CID:", cid);

			} catch (error) {
				console.error("Error querying CID:", error);
			}
		}





		/*********************************************************************************************
		.)  BALANCE
		**********************************************************************************************/

		async function syncBalance() {
			console.log('syncBalance()')
			let addr = document.getElementById('yourAddress').getAttribute('address');
			let balance = await checkERC20Balance(addr)
			let gasBalance = await checkGasBalance(addr)
			userData.innerHTML = `			
			<a id="" target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/address/${optionsList[0].ERC20_TOKEN_ADDRESS}">Balance: ${balance}</a>
			<svg class='hoverIcon' xmlns="http://www.w3.org/2000/svg"  width="18" height="16" viewBox="0 0 512 512" id='reloadBalance'  onclick="event.stopPropagation();reloadBalance()"> <path fill="currentColor" d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/></svg> 
			<br>
			<a id="miniversion" target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/address/${addr}">gas: ${gasBalance}</a>
			`;

		}



		async function syncTokenBalance() {
			console.log('syncTokenBalance()')

			let explorer = preferredToken.explorers[0].url
			let tokenAddress = preferredToken.contractAddr
			let userAddress = addr


			userData.innerHTML = ` <svg  class="rounded rounded-circle " width="40px"  height="40px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" onclick="event.stopPropagation();openModalId('#defaultTokenModal')" style=" position: absolute; left: 0; "> <path fill='#d17c78' d="M311.9 260.8L160 353.6 8 260.8 160 0l151.9 260.8zM160 383.4L8 290.6 160 512l152-221.4-152 92.8z"/></svg> <a id="" target="_blank" rel="noopener noreferrer" href="${explorer}/address/${tokenAddress}">Balance: ${balance} </a> <svg class='hoverIcon' xmlns="http://www.w3.org/2000/svg"  width="18" height="16" viewBox="0 0 512 512" id='reloadBalance'  onclick="event.stopPropagation();reloadBalance()"> <path  fill='#d17c78' d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/></svg> <br> <div id="miniversion"> <a  target="_blank" rel="noopener noreferrer" href="${explorer}/address/${userAddress}">gas: ${gasBalance} </a> </div> `;

		}


		async function getRandomProvider() {
			// console.log('getRandomProvider(#5879)')
			let isCurrentProvider = localStorage.getItem('currentProvider');

			if (isCurrentProvider !== null) {
				// console.log('currentProvider exists:', isCurrentProvider);
			} else {
				console.warn('📛📛📛 📛📛📛currentProvider does not exist', isCurrentProvider);
				// return
			}


			// get index
			let preferredIndex = localStorage.getItem('preferredTokenIndex');
			if (preferredIndex === null) {
				preferredIndex = 0;
			} else {
				preferredIndex = parseInt(preferredIndex, 10); // Convert the stored value to an integer
			}

			// get token data
			let storedData = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];
			let preferredToken = storedData[preferredIndex];

			// get random provider
			const length = preferredToken.rpcs.length;
			const randomnumber = Math.floor(Math.random() * length);
			const selectedProvider = preferredToken.rpcs[randomnumber];
			console.log('⚙️ selectedProvider:', selectedProvider, 'from ', length, 'providers.');

			// localStorage.setItem('currentProvider', selectedProvider)
			return selectedProvider
		}



		async function checkGasBalance(walletAddress) {
			console.log('checkGasBalance() of ', walletAddress)

			// Retrieve selector index  from localStorage
			let preferredIndex = localStorage.getItem('preferredTokenIndex');
			if (preferredIndex === null) {
				preferredIndex = 0;
			} else {
				preferredIndex = parseInt(preferredIndex, 10); // Convert the stored value to an integer
			}

			// Retrieve the stored data from localStorage
			let storedData = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];

			// If the preferred index is within the range of stored tokens, return the corresponding token details
			if (storedData[preferredIndex]) {
				preferredToken = storedData[preferredIndex];
				//  pref= preferredToken
			} else {
				console.log('some problem in checkERC20Balance')
				return
			}

			const length = preferredToken.rpcs.length;
			const randomnumber = Math.floor(Math.random() * length);
			const selectedProvider = preferredToken.rpcs[randomnumber];
			console.log('selectedProvider(at checkGasBalance()):', selectedProvider);
			let provider;
			try { provider = await new ethers.JsonRpcProvider(selectedProvider); }
			catch (error) { console.warn('error creating provider', error) }
			console.log('provider to check gas :', provider);
			try {
				const balance = await provider.getBalance(walletAddress);
				console.log(`GAS bal (crudo) : ${balance} GAS`);

				const gasBalance = ethers.formatEther(balance);
				console.log(`GAS Balance : ${gasBalance} GAS`);
				// console.log(`GAS Balance of ${optionsList[0].ERC20_TOKEN_ADDRESS}: ${gasBalance} GAS`);

				return gasBalance;
			} catch (error) {
				console.error('Error checking balance:', error.reason);
				return null;
			}
		}


		async function checkERC20Balance(userAddress) {
			console.log('checkERC20Balance() of ', userAddress)

			// Retrieve selector index  from localStorage
			let preferredIndex = localStorage.getItem('preferredTokenIndex');
			if (preferredIndex === null) {
				preferredIndex = 0;
			} else {
				preferredIndex = parseInt(preferredIndex, 10); // Convert the stored value to an integer
			}

			// Retrieve the stored data from localStorage
			let storedData = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];

			// If the preferred index is within the range of stored tokens, return the corresponding token details
			if (storedData[preferredIndex]) {
				preferredToken = storedData[preferredIndex];
				pref = preferredToken
			} else {
				console.log('some problem in checkERC20Balance')
				return
			}

			const length = preferredToken.rpcs.length;
			const randomnumber = Math.floor(Math.random() * length);
			const selectedProvider = preferredToken.rpcs[randomnumber];
			console.log('selectedProvider:', selectedProvider);
			let provider;
			try { provider = await new ethers.JsonRpcProvider(selectedProvider); }
			catch (error) { console.warn('error creating provider', error) }
			console.log('provider*?:', provider);
			p = provider

			let contractAddr = preferredToken.contractAddr
			const tokenContract = await new ethers.Contract(contractAddr, erc20Abi, provider);
			t = tokenContract;
			const formattedAddress = ethers.getAddress(userAddress);
			let balance;
			try { balance = await tokenContract.balanceOf(formattedAddress); }
			catch (error) {
				if (error.message.includes('Failed to fetch')) { console.warn('Error getting balance: Network or fetch issue. refetch?'); }
				else { console.warn('Error getting balance:', error); }
			}
			b = balance
			const decimals = await tokenContract.decimals();
			console.log('decimals:', decimals)
			d = decimals
			let formatedBalance = ethers.formatUnits(balance, decimals);
			console.warn(`ERC-20 Balance of ${preferredToken.tokenName}: ${formatedBalance} `);
			return formatedBalance
			try {
				return formatedBalance
			} catch (error) {

				console.error('Error checking balance:', error);
				return null;
			}

		}



		async function checkNetwork() {
			console.log('CHEKGINS NETWORK!')
			let provider = await new ethers.JsonRpcProvider(`${optionsList[0].API}`);
			var selectElement = document.getElementById('userData');
			try {
				const blockNumber = await provider.getBlockNumber();
				console.log('Connected to network. Latest block number:', blockNumber);
				selectElement.style.color = 'green';
				return true
			} catch (error) {
				console.error('Error connecting to network:', error.message);
				selectElement.style.color = 'red';

				return false
			}

		}




		function lock() {
			console.log('lock()')
			document.getElementById("loader").style.display = "none";//flex
			lockscreen.style.display = 'flex'
			closeModalId('#settingsModal')
			document.querySelector(".sidebar").classList.remove("isOpen");
			document.querySelector(".overlay").classList.remove("overlayisOpen");
			sessionStorage.removeItem('password')
		}


		/*********************************************************************************************
	  .) BALANCES
	  **********************************************************************************************/
		async function reloadBalances(){
    console.warn('reloadBalances()')


}
		/*********************************************************************************************
	  .) TOKEN
	  **********************************************************************************************/

	  async function selectRandomProvider(rpcs){
            console.log('selectRandomProvider');

            let providerLength = rpcs.length;
            let randomProvider = Math.floor(Math.random() * providerLength);
            let selectedProvider = rpcs[randomProvider];
            console.log('👁️‍🗨️selectedProvider 👁️‍🗨️:', selectedProvider);

            if (selectedProvider.includes("INFURA_API_KEY")) {
                    let INFURA_API_KEY = globalOptionsList[0].INFURA_API_KEY;
                    selectedProvider = `https://arbitrum-mainnet.infura.io/v3/${INFURA_API_KEY}`;
                    console.log("INFURA:", selectedProvider);
            
            } else if (selectedProvider.includes("ALCHEMY_API_KEY")) {
                    let ALCHEMY_API_KEY = globalOptionsList[0].ALCHEMY_API_KEY;
                    selectedProvider = `https://arb-mainnet.g.alchemy.com/v2/${ALCHEMY_API_KEY}`;
                    console.log("ALCHEMY:", selectedProvider);

                    // return "Alchemy";
                }  else {
                console.log("URL does not contain INFURA_API_KEY placeholder.");
            }
   

            return selectedProvider

        }
	       
	  async function loadToken(addr) {
            console.warn('loadToken()')
            
            const storedTokenType = localStorage.getItem('selectedTokenType');
            userData.innerHTML = '... LOADING ...'


		/*********************************************************************************************
		.)  NATIVE 
		**********************************************************************************************/

            // ETHEREUM
            if (storedTokenType === 'native') {
                console.warn('💛💛 LOADING ETHEREUM 💛💛 ')

                let token = await getPreferredToken()
                tok = token
                console.log('TOkEN PREFERIDO:', token)
                if (token ===null ){
                    console.log('TOKEN NULL:');
                    return;
                    }

                let tokenname = token.tokenName
                let chainid = token.chainId
                let chainname = token.chainName
        

                let selectedProvider= await selectRandomProvider(token.rpcs)

                // let provider = await new ethers.JsonRpcProvider(selectedProvider);
                let provider
try {
    provider = await new ethers.JsonRpcProvider(selectedProvider);
    console.log("🤓Provider initialized successfully:", provider);
} catch (error) {
    console.warn("🤬Failed to initialize provider:", error.message || error);
}

                let balance = await provider.getBalance(addr);
                let nativeBalance = ethers.formatEther(balance);
                let gasName = token.tokenName;
                console.log(`GAS Balance: ${nativeBalance} `);

                let explorerLengh  =token.explorers.length;
                let randomExplorer = Math.floor(Math.random() * explorerLengh);
                let explorer = token.explorers[randomExplorer].url;
                console.log('explorer:', explorer)

                userData.innerHTML = ` 
                <a id="" target="_blank" rel="noopener noreferrer" href="${explorer}/address/${addr}">${nativeBalance} ${tokenname}</a> <svg class='hoverIcon' xmlns="http://www.w3.org/2000/svg"  width="18" height="16" viewBox="0 0 512 512" id='reloadBalance'  onclick="event.stopPropagation();reloadBalances()"> <path  fill='#d17c78' d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/></svg> </div> `;                



            }

		/*********************************************************************************************
		.)  ERC20 
		**********************************************************************************************/

            else if (storedTokenType === 'erc20') {
                console.warn('💚💚 LOADING ERC20 💚💚 ')

                // ..............................
                // Carga el token
                // ..............................
                let token = await getPreferredToken()
                tok = token
                console.log('TOkEN PREFERIDO:', token)
                if (token ===null ){
                    console.log('TOKEN NULL:');
                    return;
                    }

                let tokenname = token.tokenName
                let chainid = token.chainId
                let chainname = token.chainName
                let contractAddr = token.contractAddr
                
                
                // let providerLength = token.rpcs.length;
                // let randomProvider = Math.floor(Math.random() * providerLength);
                //  let selectedProvider = token.rpcs[randomProvider];
                // console.log('selectedProvider:', selectedProvider);

                let selectedProvider= await selectRandomProvider(token.rpcs)

                // let provider = await new ethers.JsonRpcProvider(selectedProvider);
let provider
try {
    provider = await new ethers.JsonRpcProvider(selectedProvider);
    console.log("🤓Provider initialized successfully:", provider);
} catch (error) {
    console.warn("🤬Failed to initialize provider:", error.message || error);
}

                console.log('provider:', provider); 
                // let   tokenContract = await new ethers.Contract(contractAddr, erc20Abi, provider);

let tokenContract; 
try {
    tokenContract = await new ethers.Contract(contractAddr, erc20Abi, provider);
    console.log("Token contract initialized successfully:", tokenContract);
} catch (error) {
    console.error("Failed to initialize token contract:", error.message || error);
}
console.log('tokenContract:', tokenContract);




                // let erc20balance = await tokenContract.balanceOf(addr);
                
let erc20balance
try {
    erc20balance = await tokenContract.balanceOf(addr);
    console.log("ERC20 Balance gotten successfully:", erc20balance);
} catch (error) {
    console.warn("🤬Failed to get ERC20 Balance:", error.message || error);
    userData.innerHTML = `${error.message}`

    // retryWithAnotherProvider()
}
                

                let erc20Name = token.tokenName;
                console.log(`ERC-20 Balance: ${erc20balance} `);

                // let balance = await provider.getBalance(addr);

let balance
try {
    balance = await provider.getBalance(addr);
    console.log("Gas/native Balance gotten successfully:", balance);
} catch (error) {
    console.warn("🤬Failed to get GAS/native Balance:", error.message || error);
    userData.innerHTML += `<pre>${error.message}</pre>`
    // retryWithAnotherProvider()
}



                let gasBalance = ethers.formatEther(balance);
                let gasName = token.tokenName;
                console.log(`GAS Balance: ${gasBalance} `);

                let explorerLengh  =token.explorers.length;
                let randomExplorer = Math.floor(Math.random() * explorerLengh);
                let explorer = token.explorers[randomExplorer].url;
                console.log('explorer:', explorer)

			userData.innerHTML = ` <a id="" target="_blank" rel="noopener noreferrer" href="${explorer}/address/${contractAddr}">Balance: ${erc20balance} ${erc20Name}</a> <svg class='hoverIcon' xmlns="http://www.w3.org/2000/svg"  width="18" height="16" viewBox="0 0 512 512" id='reloadBalance'  onclick="event.stopPropagation();reloadBalances()"> <path fill="currentColor" d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/></svg> <br> <a id="miniversion" target="_blank" rel="noopener noreferrer" href="${explorer}/address/${addr}">gas: ${gasBalance}</a> `;
                

                
            }


        }



		// async function loadToken(addr) {
		// 	// console.warn('loadToken()')
		// 	console.log('🥳🥳 LOADING /RELOADING TOKEN')

		// 	const storedTokenType = localStorage.getItem('selectedTokenType');
		// 	data.innerHTML = ''



		// 	//   // If a token type was previously selected, set it accordingly
		// 	if (storedTokenType) {

		// 		// #$#$#$#$#$#$#$#$#$#$##$#$#$#$#$#$#$#$#$#$##$#$#$#$#$#$#$#$#$#$#
		// 		if (storedTokenType === 'inactive') {
		// 			console.warn('inactive selected (wallet is off)')
		// 			userData.innerHTML = `IUS NATURALIS`;

		// 		}
		// 		// else if erc-20 FIX
		// 		else if (storedTokenType === 'erc20') {
		// 			// rewrite to evm
		// 			localStorage.setItem('selectedTokenType', 'evm');  // Optionally store the default
		// 			console.warn('🥳🥳 BUG FIXED>> RELOAD THE PAGE')
		// 			fixedToast.fire('🚧 BUG AUTOFIXED ✅', `PLEASE RELOAD THE PAGE <button onclick="location.reload();">🔄</button>`, "error");

		// 		}

		// 		else if (storedTokenType === 'evm') {
		// 			// console.log('🥳🥳 LOADING EVM')
		// 			// ..............................
		// 			// Carga el token
		// 			// ..............................
		// 			let preferredToken = await recallStoredToken();
		// 			p = preferredToken
		// 			if (preferredToken) {
		// 				// console.warn('Preferred Token*:', preferredToken);
		// 				// You can now use preferredToken.tokenName, preferredToken.chainName, etc.
		// 			} else {
		// 				console.warn('No preferred token stored or index out of range.');
		// 				Toast.fire({ title: "No prefered token set!", text: "No preferred token stored or index out of range.", icon: "warning" });
		// 				// LOAD DEFAULT TOKENS

		// 			}

		// 			if (!addr) {
		// 				// console.warn('No address provided to loadToken function');
		// 				addr = document.getElementById('yourAddress').getAttribute('address');
		// 			}

		// 			// Continue with the rest of your function if addr is provided
		// 			// console.log(`Loading token for address: ${addr}`);


		// 			// SELECT RANDOM PROVIDER
		// 			let selectedProvider = await getRandomProvider()
		// 			// console.warn('selectedProvider:', selectedProvider)
		// 			if (selectedProvider === undefined) {
		// 				// console.warn('selectedProvider:', selectedProvider)
		// 				return
		// 			}
		// 			// console.warn('selectedProvider', selectedProvider)

		// 			// GET PROVIDER
		// 			let provider;
		// 			try { provider = await new ethers.JsonRpcProvider(selectedProvider); }
		// 			catch (error) {
		// 				console.warn('error creating provider', error)
		// 				// store current provider  and store it to filter it before selecting a new one
		// 			}
		// 			// console.warn('provider', provider)

		// 			// CHECK GAS


		// 			console.warn('💎 preferredToken.contractAddr:', preferredToken.contractAddr)
		// 			if (preferredToken.contractAddr == 'nativeToken') {
		// 				// -------------------------------------
		// 				// NATIVE TOKEN				
		// 				// -------------------------------------
		// 				console.warn('💎💎💎 LOADING NATIVE TOKEN!')
		// 				const amountInput = document.getElementById('amount');
		// 				let stepValue = 0.01; // Minimum step of 0.01 for tokens with decimals
		// 				stepValue = Math.max(Math.min(stepValue, 1), 0.01);
		// 				amountInput.setAttribute('step', stepValue.toString());
		// 				console.warn('🔢  DECIMALS (stepvalue): ', stepValue)
		// 				let gasBalance
		// 				const balance = await provider.getBalance(addr);
		// 				console.log(`NATIVE GAS bal (crudo) : ${balance} GAS`);
		// 				nativeBalance = Math.round(ethers.formatEther(balance) * 1000000) / 1000000; // Rounds to 6 decimal places
		// 				console.log(`NATIVE GAS Balance : ${nativeBalance} GAS`);
		// 				let explorer = preferredToken.explorers[0].url
		// 				let tokenName = preferredToken.tokenName
		// 				let userAddress = addr
		// 				userData.innerHTML = ` 
		// 				<a id="" target="_blank" rel="noopener noreferrer" href="${explorer}/address/${userAddress}">${nativeBalance} ${tokenName}</a> <svg class='hoverIcon' xmlns="http://www.w3.org/2000/svg"  width="18" height="16" viewBox="0 0 512 512" id='reloadBalance'  onclick="event.stopPropagation();reloadBalance()"> <path  fill='#d17c78' d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/></svg> </div> `;
		// 				let chainName = preferredToken.chainName
		// 				let chainId = preferredToken.chainId
		// 				adjustBalances(explorer, userAddress, nativeBalance, tokenName, chainName, chainId)

		// 			} else {
		// 				// -------------------------------------
		// 				// ERC20 TOKEN				
		// 				// -------------------------------------
		// 				let gasBalance
		// 				try {
		// 					const balance = await provider.getBalance(addr);
		// 					gasBalance = Math.round(ethers.formatEther(balance) * 1000000) / 1000000; // Rounds to 6 decimal places
		// 					console.warn(`GAS Balance : ${gasBalance} GAS`);
		// 				} catch (error) {
		// 					console.error('Error checking gas  balance:', error.reason);
		// 					return null;
		// 				}

		// 				let contractAddr = preferredToken.contractAddr
		// 				const tokenContract = await new ethers.Contract(contractAddr, erc20Abi, provider);
		// 				let balance;
		// 				try { balance = await tokenContract.balanceOf(addr); }
		// 				catch (error) {
		// 					if (error.message.includes('Failed to fetch')) { console.warn('Error getting balance: Network or fetch issue. refetch?'); }
		// 					else { console.warn('Error getting balance:', error); }
		// 				}
		// 				console.warn('erc20Balance:', balance);
		// 				const decimals = await tokenContract.decimals();
		// 				const tokenDecimals = Number(decimals);
		// 				let stepValue;
		// 				if (tokenDecimals === 0) {
		// 					stepValue = 1; // Only whole numbers
		// 				} else {
		// 					stepValue = 0.01; // Minimum step of 0.01 for tokens with decimals
		// 				}
		// 				const amountInput = document.getElementById('amount');
		// 				stepValue = Math.max(Math.min(stepValue, 1), 0.01);
		// 				amountInput.setAttribute('step', stepValue.toString());
		// 				console.warn('decimals:', decimals)
		// 				let erc20Balance = ethers.formatUnits(balance, decimals);
		// 				console.warn(`ERC-20 Balance of ${preferredToken.tokenName}: ${erc20Balance} `);
		// 				let explorer = preferredToken.explorers[0].url
		// 				let tokenAddress = preferredToken.contractAddr
		// 				let tokenName = preferredToken.tokenName
		// 				let userAddress = addr
		// 				userData.innerHTML = ` <a id="" target="_blank" rel="noopener noreferrer" href="${explorer}/address/${tokenAddress}">ERC20: ${erc20Balance} ${tokenName}</a> <svg class='hoverIcon' xmlns="http://www.w3.org/2000/svg"  width="18" height="16" viewBox="0 0 512 512" id='reloadBalance'  onclick="event.stopPropagation();reloadBalance()"> <path  fill='#d17c78' d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/></svg> <br> <div id="miniversion"> <a  target="_blank" rel="noopener noreferrer" href="${explorer}/address/${userAddress}">gas: ${gasBalance} </a> </div> `;
		// 				let chainName = preferredToken.chainName
		// 				let chainId = preferredToken.chainId

		// 				// SEND MODAL
		// 				document.getElementById('bigBalanceWalletsendmodal').innerHTML = ` <span class="top">${chainName} (${chainId})</span> <span class="bal" >${erc20Balance}</span> <span class="eth">${tokenName}</span> <span class="bottom"> <a class="miniversion" target="_blank" rel="noopener noreferrer" href="${explorer}/address/${tokenAddress}">gas: ${gasBalance}</a> </span>`

		// 				// WALLET MODAL
		// 				document.getElementById('bigBalanceWalletmodal').innerHTML = ` <span class="top">${chainName} (${chainId})</span> <span class="bal" >${erc20Balance}</span> <span class="eth">${tokenName}</span> <span class="bottom"> <a class="miniversion" target="_blank" rel="noopener noreferrer" href="${explorer}/address/${tokenAddress}">gas: ${gasBalance}</a> </span>`

		// 				// ..............................
		// 				// FIN Carga el token
		// 				// ..............................
		// 			}


		// 		}

		// 		document.querySelector(`input[name="tokenType"][value="${storedTokenType}"]`).checked = true;


		// 	}
		// 	else {
		// 		console.warn('No token type selected in localStorage, setting default to INACTIVE');
		// 		document.querySelector('input[name="tokenType"][value="inactive"]').checked = true;
		// 		localStorage.setItem('selectedTokenType', 'inactive');  // Optionally store the default
		// 		erc20Options.style.display = 'none';

		// 	}






		// }


		//  https://sepolia.arbiscan.io 0xFb1cb5a6dADDcE008d86f72057265A3afC82d539 11 PDTROK
		//  adjustBalances('https://sepolia.arbiscan.io', '0xFb1cb5a6dADDcE008d86f72057265A3afC82d539',  11 , 'PDTROK')

		function adjustBalances(explorer, userAddress, nativeBalance, tokenName, chainName, chainId) {
			// adjustBalances(explorer,userAddress,nativeBalance,tokenName,chainName,chainId)

			document.getElementById('userData').innerHTML = ` 
				<a id="" target="_blank" rel="noopener noreferrer" href="${explorer}/address/${userAddress}">
					${nativeBalance} ${tokenName}
					</a> <svg class='hoverIcon' xmlns="http://www.w3.org/2000/svg"  width="18" height="16" viewBox="0 0 512 512" id='reloadBalance'  onclick="event.stopPropagation();reloadBalance()"> <path  fill='#d17c78' d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/></svg> 
					</div> `;


			// SEND MODAL
			document.getElementById('bigBalanceWalletsendmodal').innerHTML = `
					<span class="top">${chainName} (${chainId})</span>
					<span class="bal" >${nativeBalance}</span>
					<span class="eth">${tokenName}</span>
					`

			// WALLET MODAL
			document.getElementById('bigBalanceWalletmodal').innerHTML = `
					<span class="top">${chainName} (${chainId})</span>
					<span class="bal" >${nativeBalance}</span>
					<span class="eth">${tokenName}</span>
					`
 

		}

		function addToken() {
			closeModalId('#defaultTokenModal')
			openModalId('#addNewTokenModal')
		}


		const autoCompleteJS = new autoComplete({
			data: {
				src: async () => {
					try {
						document
							.getElementById("autoComplete")
							.setAttribute("placeholder", "Loading...");
						// const source = await fetch( "https://chainid.network/chains.json" );
						const source = await fetch("chainsv1.json");
						const data = await source.json();
						document
							.getElementById("autoComplete")
							.setAttribute("placeholder", autoCompleteJS.placeHolder);
						return data;
					} catch (error) {
						return error;
					}
				},
				keys: ["name", "chainId"],
				cache: true,
				filter: (list) => {
					const filteredResults = Array.from(
						new Set(list.map((value) => value.match))
					).map((token) => {
						return list.find((value) => value.match === token);
					});

					return filteredResults;
				}
			},
			placeHolder: "Search for name or chainID!",
			resultsList: {
				element: (list, data) => {
					const info = document.createElement("p");
					if (data.results.length > 0) {
						info.innerHTML = `Displaying <strong>${data.results.length}</strong> out of <strong>${data.matches.length}</strong> results`;
					} else {
						info.innerHTML = `Found <strong>${data.matches.length}</strong> matching results for <strong>"${data.query}"</strong>`;
					}
					list.prepend(info);
				},
				noResults: true,
				maxResults: 65,
				tabSelect: true,
				// searchEngine: "loose"
				searchEngine: "strict"
			},
			resultItem: {
				element: (item, data) => {
					item.style = "display: flex; justify-content: space-between;";
					item.innerHTML = `
                      <span class="hoverable" style="text-overflow: ellipsis; white-space: nowrap; overflow: hidden; cursor: pointer;">
                            ${data.match}
                        </span>
                        <span style="display: flex; align-items: center; font-size: 13px; font-weight: 100; text-transform: uppercase; color: rgba(0,0,0,.2);">
                            ${data.key}
                        </span>`;
				},
				highlight: true,
			},
			events: {
				input: {
					focus: () => {
						if (autoCompleteJS.input.value.length) {
							console.log('autoCompleteJS value', autoCompleteJS.input.value)
							autoCompleteJS.start();
						}
					}
				}
			}
		});



		autoCompleteJS.input.addEventListener("selection", function (event) {
			console.warn('SELECT: ', event.detail.selection)
			selectionResult.style.display = 'block'
			const feedback = event.detail;
			let resultado = event.detail.selection.value;
			r = resultado;
			// localStorage.setItem('chainFeedback', JSON.stringify(feedback))
			localStorage.setItem('chainResult', JSON.stringify(event.detail.selection))
			f = feedback
			autoCompleteJS.input.blur();
			const selection = feedback.selection.value[feedback.selection.key];

			// ----
			//   const httpsRpcAddresses = resultado.rpc.filter((address) =>
			//     address.startsWith("https://") && !address.includes("${INFURA_API_KEY}")
			//   );


			// const INFURA_API_KEY = "9219faae2bac4d24b95c2d967b22005a"; // Replace with your actual Infura API key
			const httpsRpcAddresses = resultado.rpc.map((address) => {
				if (address.startsWith("https://") && address.includes("${INFURA_API_KEY}")) {
					return address.replace("${INFURA_API_KEY}", INFURA_API_KEY);
				}
				return address;
			});



			const rpclength = httpsRpcAddresses.length;
			const randomnumber = Math.floor(Math.random() * rpclength);
			const selectedProvider = httpsRpcAddresses[randomnumber];
			console.log('selectedProvider:', selectedProvider);

			document.getElementById("selectionResult").innerHTML = `
		<strong>Chain:</strong> ${resultado.chain}
		<br><strong>Name:</strong> ${resultado.name}
		<br><strong>chainId:</strong> ${resultado.chainId}
		<br><strong>Short:</strong> ${resultado.shortName}
		<br><strong>Explorers[${resultado.explorers.length}]:</strong> ${resultado.explorers[0].url}
		<br><strong>Gas token:</strong> ${resultado.nativeCurrency.name}
		<br> <strong>RPC [${rpclength}]:</strong> ${httpsRpcAddresses[randomnumber]}
		<br><strong>Native Currency:</strong> ${resultado.nativeCurrency.symbol}`;

			autoCompleteJS.input.value = selection;
			console.warn('selection REDULT: ', selection)
			console.log("feedback: ", feedback);
			console.warn("resultado: ", resultado);


			erc20SetContract.style.display = 'inline'
			addNativeToken.style.display = 'inline'


		});



		const action = (action) => {
			console.log('action()')
			const title = document.querySelector("h5");
			const selection = document.querySelector(".selection");

			if (action === "dim") {
				title.style.opacity = 1;
				// mode.style.opacity = 1;
				selection.style.opacity = 1;
			} else {
				title.style.opacity = 0.3;
				// mode.style.opacity = 0.2;
				selection.style.opacity = 0.1;
			}
		};



		["focus", "blur"].forEach((eventType) => {
			autoCompleteJS.input.addEventListener(eventType, () => {
				if (eventType === "blur") {
					action("dim");
				} else if (eventType === "focus") {
					action("light");
				}
			});
		});



	
		/*********************************************************************************************
		 .) POPULATE TOKENS
		 **********************************************************************************************/

		async function createProv() {
			console.log('createProv()')
			// let feedback = JSON.parse(localStorage.getItem('chainFeedback'))
			let result = JSON.parse(localStorage.getItem('chainResult'))
			const httpsRpcAddresses = result.value.rpc.filter((address) => address.startsWith("https://") && !address.includes("${INFURA_API_KEY}"));
			// const httpsRpcAddresses = feedback.results[0].value.rpc.filter((address) => address.startsWith("https://") && !address.includes("${INFURA_API_KEY}"));
			const length = httpsRpcAddresses.length;
			const randomnumber = Math.floor(Math.random() * length);
			const selectedProvider = httpsRpcAddresses[randomnumber];
			console.log('selectedProvider:', selectedProvider);
			let provider = await new ethers.JsonRpcProvider(selectedProvider);
			console.log('provider:', provider);
			return provider
		}



		async function checkContract(addr) {
			console.log('checkContract()')
			let provider;
			try {
				provider = await createProv();
				const network = await provider.getNetwork();
				console.log('network:', network);
				// return
			} catch (error) {
				console.error('Could not create provider:', error);
				document.getElementById('validLink').innerHTML = `<br>❌ Could not create provider`
			}

			const tokenContract = await new ethers.Contract(addr, erc20Abi, provider);
			console.log('tokenContract:', tokenContract)

			let result = await JSON.parse(localStorage.getItem('chainResult'))
			let explorerLink = `<a target="_blank" rel="noopener noreferrer" href="${result.value.explorers[0].url}/address/${addr}">${addr}</a>`;
			document.getElementById('validLink').innerHTML = `<br>${explorerLink}`

			const symbol = await tokenContract.symbol();
			console.log("Token Symbol:", symbol);
			document.getElementById('validLink').innerHTML += `<br>Token Symbol: ${symbol}`
			document.getElementById('validLink').setAttribute('symbol', symbol);
			document.getElementById('validLink').setAttribute('address', addr);

			let ts = await tokenContract.totalSupply()
			console.log('TOTAL SUPPLY: ', ts)
			document.getElementById('validLink').innerHTML += `<br>Total Supply: ${ts}`

			return

		}






		// Function to validate Ethereum address
		function isValidEthAddress(address) {
			const pattern = /^0x[a-fA-F0-9]{40}$/;
			return pattern.test(address);
		}


		const { isAddress } = ethers;

		// Event listener for the input field
		document.getElementById('contractAddress').addEventListener('input', function () {
			const address = this.value;

			// Check if the address is valid
			if (isAddress(address)) {

				this.classList.remove('is-invalid');
				this.classList.add('is-valid');
				addERC20contract.style.display = 'inline'
				addNativeToken.style.display = 'none';// ocultar eth aqui

				// Call your function here when the address is valid
				checkContract(address)
			} else {
				this.classList.remove('is-valid');
				this.classList.add('is-invalid');
				addERC20contract.style.display = 'none'
				addNativeToken.style.display = 'inline'

			}
		});


		function addConctract() {
			console.log('addConctract() ')
			// Retrieve and parse existing chain data from localStorage
			let storedResult = JSON.parse(localStorage.getItem('chainResult')) || { results: [] };
			st = storedResult
			// Get the relevant elements and their values
			let tokenName = document.getElementById('validLink').getAttribute('symbol');
			const chainName = storedResult.value.name;
			const chainId = storedResult.value.chainId;
			let contractAddr = document.getElementById('contractAddress').value;
			const rpcs = storedResult.value.rpc.filter((address) => address.startsWith("https://") && !address.includes("${INFURA_API_KEY}"));
			const explorers = storedResult.value.explorers;
			//   const nativeToken =


			// let tokenName;
			// let contractAddr;

			if (contractAddr == '') {
				tokenName = storedResult.value.nativeCurrency.name;
				contractAddr = 'nativeToken';
			}

			// Create a new chain entry
			const newToken = {
				tokenName,
				chainName,
				chainId,
				contractAddr,
				rpcs,
				explorers
			};

			storeToken(newToken)

			// repopupulate select
			populateSelectInput()
			populateSelectInput('tokenType');//populate selec input inside wallet send


		}


		// STORE TOKEN 
		function storeToken(token) {
			console.log('storeToken()', token)
			var tkn = [];
			tkn = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];

			// Check if the address already exists
			//   var isDuplicate = tkn.some(existingToken => existingToken.contractAddr === token.contractAddr);
			var isDuplicate = tkn.some(existingToken =>
				existingToken.contractAddr === token.contractAddr &&
				existingToken.chainId === token.chainId
			);

			if (!isDuplicate) {
				console.warn('NEW TOKEN!')
				tkn.push(token);
				localStorage.setItem('ERC20_TOKENS', JSON.stringify(tkn));
			}
			else {
				console.warn('Token already exists , skipping save.');
				return
			}

			// REMOVE chainFeedback and clear UI
			localStorage.removeItem('chainResult');
			console.warn('chainResult removed from localStorage')

			// set prefered token index to this token
			const length = document.getElementById('erc20Selector').length;
			let newindex = length - 1;
			localStorage.setItem('preferredTokenIndex', newindex);

			// CLEAR UI
			document.getElementById("autoComplete").value = "";
			document.getElementById("contractAddress").value = "";
			document.getElementById("selectionResult").innerHTML = "";
			document.getElementById("validLink").innerHTML = "";
			document.getElementById("selectionResult").style.display = "none";
			document.getElementById("contractAddress").classList.remove('is-valid');

			closeModalId('#addNewTokenModal')

			Toast.fire({ title: "Token added!", text: "A new Token has been added.", icon: "success" });

		}

		function removeToken(contractAddr) {
			console.log('removeToken()');
			var tkn = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];

			// Filter out the token with the matching contractAddr
			var newTkn = tkn.filter(existingToken => existingToken.contractAddr !== contractAddr);

			if (newTkn.length === tkn.length) {
				console.warn('Token not found , skipping removal.');
				return;
			}

			localStorage.setItem('ERC20_TOKENS', JSON.stringify(newTkn));

			// REMOVE chainFeedback and clear UI
			localStorage.removeItem('chainResult');


		}




		
		/*********************************************************************************************
		 .) POPULATE TOKENS
		 **********************************************************************************************/
	 // Function to set the preferred token in localStorage
	 function setPreferredToken(chainId, contractAddr) {
	   console.warn('🤠 🤠 🤠prefered token CHANGED!')

	   const preferredTokenKey = `${chainId}-${contractAddr}`;
	   localStorage.setItem('PREFERRED_TOKEN', preferredTokenKey);
   }

        // Function to populate all selectors with options, marking the preferred token as selected
        function populateTokenSelector() {
                let storedTokens = JSON.parse(localStorage.getItem('EVM_TOKENS')) || [];
                const preferredTokenKey = localStorage.getItem('PREFERRED_TOKEN');
                const selectElements = document.querySelectorAll('.token-selector');

                selectElements.forEach(selectElement => {
                    // Clear existing options
                    selectElement.innerHTML = '';
                    
                    // Populate options
                    storedTokens.forEach(token => {
                        const option = document.createElement('option');
                        option.value = `${token.chainId}-${token.contractAddr}`;
                        option.textContent = `${token.tokenName} ${token.chainName} (${token.chainId})`;

                        // Mark the option as selected if it matches the preferred token key
                        const tokenKey = `${token.chainId}-${token.contractAddr}`;
                        if (tokenKey === preferredTokenKey) {
                            option.selected = true;
                        }

                        selectElement.appendChild(option);
                    });
                });
            }
		function updateAllTokenSelectors(newToken) {
			console.log('👨‍👩‍👦‍👦👨‍👩‍👦‍👦👨‍👩‍👦‍👦 updateAllTokenSelectors()')
			const storedTokenType = localStorage.getItem('selectedTokenType');

      // Loop through all selectors and set their value to the new token
      document.querySelectorAll('.token-selector').forEach(selector => {
        selector.value = newToken;
      });
    }

	
		// function populateSelectInput(selectId) {
		// 	console.log('👨‍👩‍👦‍👦 populateSelectInput()')

		// 	return 
		// 	const storedTokenType = localStorage.getItem('selectedTokenType');

			 

		// 	 if (storedTokenType === 'evm') {
		// 		console.log('🧩do something if EVM')
		// 		document.getElementById('tokenType').style.display = 'block'
		// 		document.getElementById('erc20Options').style.display = 'block';
		// 		document.getElementById('fixedtokenType').style.display = 'none'


		// 		// 1. get storedData (storedTokens/evm_tokens)
		// 		let storedData = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];
			
			
		// 		// 2. get index of prefered token // quizas AQUI usar el la info del token en vez del indice
		// 		// Retrieve the preferred selection from localStorage or default to 0
		// 		let preferredIndex = localStorage.getItem('preferredTokenIndex');
		// 		preferredIndex = preferredIndex !== null ? parseInt(preferredIndex, 10) : 0;

		// 		// Set default value if no argument is passed
		// 		selectId = selectId || 'erc20Selector';
		// 		const selectElement = document.getElementById(selectId);

		// 		// Clear the existing options
		// 		selectElement.innerHTML = '';

		// 		// Populate the select input with the stored data
		// 		storedData.forEach((token, index) => {
		// 			const option = document.createElement('option');
		// 			option.value = index;
		// 			option.textContent = `${token.tokenName} ${token.chainName} (${token.chainId})`;
		// 			if (preferredIndex === index) {
		// 				option.selected = true; // Set the preferred item as selected
		// 			}
		// 			selectElement.appendChild(option);

		// 		});
		// 	}

		// }







		// Event listener to store the selected option
		document.getElementById('erc20Selector').addEventListener('change', async function () {
			console.warn('erc20MainSelector() changed!')
			let selectedIndex = this.value;
			localStorage.setItem('preferredTokenIndex', selectedIndex);

			// borrar contenedor
			data.innerHTML = ''

			await loadToken()


		});




		function recallStoredToken() {
			// Retrieve the preferred token index from localStorage
			let preferredIndex = localStorage.getItem('preferredTokenIndex');

			// Set the default index to 0 if no preferred index is stored
			if (preferredIndex === null) {
				preferredIndex = 0;
			} else {
				preferredIndex = parseInt(preferredIndex, 10); // Convert the stored value to an integer
			}

			// Retrieve the stored data from localStorage
			let storedData = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];

			// If the preferred index is within the range of stored tokens, return the corresponding token details
			if (storedData[preferredIndex]) {
				return storedData[preferredIndex];
			} else {
				// Handle the case where the index is out of range
				return null;
			}
		}








		/*********************************************************************************************
		.) STEALTH WALLET
		**********************************************************************************************/


		//  createStealthWallet(privateKey, publicKey) 
		async function createStealthWallet(privateKey, publicKey) {

			console.warn('🦸‍♂️createStealthWallet()', privateKey, publicKey)
			const publicKeyHexWithoutPrefix = removeHexPrefix(publicKey);
			const pubPoint = secp.ProjectivePoint.fromHex(publicKeyHexWithoutPrefix);
			const sharedSecret = pubPoint.multiply(BigInt(privateKey)).toHex();
			console.log('👫sharedSecret  (at createStealthWallet ):', sharedSecret);
			const hashedSecret = ethers.keccak256('0x' + sharedSecret).slice(0, 42);


			// BOB can comput the private key to the stealth addres
			// b +hs
			const hprivkeyBigInt = BigInt(privateKey);  // hs should already be in hex or BigInt format
			b = hprivkeyBigInt

			const hsBigInt = BigInt(hashedSecret);  // hs should already be in hex or BigInt format
			hs = hsBigInt

			computedPrivKey = hprivkeyBigInt + hsBigInt

			console.warn('🛰️ computedPrivKey: ', computedPrivKey)


			eth2bigint = ethers.toBigInt(computedPrivKey)

			const stealthPrivateKey = ethers.zeroPadValue(ethers.toBeHex(computedPrivKey), 32);
			console.warn(' 🚁 stealthPrivateKey: ', stealthPrivateKey)
			const stealthwallet = new ethers.Wallet(stealthPrivateKey);
			const derivedStealthPubKey = stealthwallet.publicKey;
			console.warn(' 🪂🦹‍♂️ stealthPrivateKey: ', stealthPrivateKey)
			console.warn(' 🪂 stealthAddress: ', stealthwallet.address)


			return stealthwallet

		}







		// claim stealth address funds to self wallet
		// claimStealthAddrFunds()
		// async function claimBob(destAddress){
		async function claimStealthAddrFunds(destAddress) {
			console.log('claimStealthAddrFunds()')



			// 0 get user  priv key and peer pub key
			// --------------
			// PEER COMPRESSED PUB KEY
			// ---

			let peerAddr = document.getElementById('peerAddr').getAttribute('data-address')
			console.log('🤼‍♀️ peerAddr: ', peerAddr)
			let didData = await fetchDID(peerAddr)
			let peerPublicKey = didData.data.publicKey
			console.log('🤸‍♀️ peerPublicKey: ', peerPublicKey)
			const publicKeyJWK = peerPublicKey
			const xBase64 = base64UrlToBase64(publicKeyJWK.x);
			const yBase64 = base64UrlToBase64(publicKeyJWK.y);
			const xBytes = ethers.decodeBase64(xBase64);
			const yBytes = ethers.decodeBase64(yBase64);
			const yBigInt = BigInt(ethers.hexlify(yBytes));//quizas no es necesario bigint..
			const prefix = yBigInt % 2n === 0n ? 0x02 : 0x03;
			const precompressedPublicKey = ethers.concat([new Uint8Array([prefix]), xBytes]);
			const peerCompressedPublicKey = ethers.hexlify(precompressedPublicKey);
			console.log("Compressed Public Key:", peerCompressedPublicKey);

			// --------------
			// USER PRIVKEY
			// ---
			let signer = await getSigner()
			// let userPrivateKey  = signer.privateKey// your priv key


			// 1 generate bob stealthWallet
			// alicePublicKeyHex
			// let bobStealthWallet = await createStealthWallet(bobPrivateKeyHex, alicePublicKeyHex)
			console.log('createStealthWallet', signer.privateKey, peerCompressedPublicKey)
			let userStealthWallet = await createStealthWallet(signer.privateKey, peerCompressedPublicKey)

			let stealthAddress = userStealthWallet.address
			// 2. move funds to bob original wallet

			// Attach a provider to the stealth wallet so it can interact with the network
			let provider = await new ethers.JsonRpcProvider(optionsList[0].API);

			let userStealthWalletwithProvider = userStealthWallet.connect(provider);




			// If no destAddress is passed, perform some logic to set it
			if (!destAddress) {
				destAddress = signer.address; // Replace with Bob's actual address
				console.log(`CLAIM TO SEND to ${destAddress}  `);

			}
			let balance = await provider.getBalance(stealthAddress);
			console.log("Stealth wallet balance:", ethers.formatEther(balance));
			let formatedBalance = ethers.formatEther(balance)



			// SEND MAXIMUM MINUS ESTIMATED GAS
			// Create transaction object
			const pretx = {
				to: destAddress,          // Bob's current address
				value: balance,          // Amount of ETH to send (here it's all balance)SEND MAXIMUM MINUS ESTIMATED GAS
				gasLimit: undefined      // Will be estimated next
			};

			// pppppppppp

			// Estimate gas required for the transaction
			const gasLimit = await provider.estimateGas(pretx);
			console.log("⛽ Estimated gas:", gasLimit.toString());

			// Get the current gas price
			const feeData = await provider.getFeeData();
			let gasPrice = feeData.gasPrice;
			if (!gasPrice) {
				throw new Error('Gas price is not available');
			}
			console.log(`⛽ Gas Price: ${ethers.formatUnits(gasPrice, 'gwei')} gwei`);


			// Convert gasLimit and gasPrice to BigInt for arithmetic
			const gasLimitBigInt = BigInt(gasLimit);
			const gasPriceBigInt = BigInt(gasPrice);

			// 5. Calculate the gas fee in wei (gas limit * gas price)
			const gasFee = gasLimitBigInt * gasPriceBigInt;
			console.log("⛽ Gas Fee (wei):", gasFee.toString());

			// 6. Calculate the maximum amount of ETH to send after deducting gas fees
			maxAmountToSend = BigInt(balance) - gasFee;
			if (maxAmountToSend <= 0) {
				console.log("Not enough funds to cover gas fees.");
				return;
			}
			console.log(`💸 Max amount to send: ${ethers.formatEther(maxAmountToSend)} ETH`);


			// 6b. Apply a margin to the maxAmountToSend (e.g., reduce by 2%)
			const marginPercentage = 0.01; // 1% margin
			// const marginPercentage = 0.02; // 2% margin
			const marginAmount = maxAmountToSend * BigInt(marginPercentage * 100) / 100n;
			const adjustedAmountToSend = maxAmountToSend - marginAmount;

			document.getElementById('ReceivestealthInfo').innerHTML += `💸 Max amount to send with margin: ${ethers.formatEther(adjustedAmountToSend)} ETH`;
			console.log(`💸 Max amount to send with margin: ${ethers.formatEther(adjustedAmountToSend)} ETH`);

			// return 

			// 7. Update the transaction object with the correct amount
			const tx = {
				to: destAddress,
				value: adjustedAmountToSend, // Maximum ETH we can send
				gasLimit: gasLimit // Use the estimated gas limit
			};

			console.log('Sending transaction:', tx);
			try {
				// 8. Send the transaction
				const txResponse = await userStealthWalletwithProvider.sendTransaction(tx);
				console.log("Transaction sent:", txResponse.hash);

				// 9. Wait for the transaction to be mined
				const receipt = await txResponse.wait();
				let txLink = `<a target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/tx/${txResponse.hash}">Tx link</a>`;
				console.log("Transaction confirmed:", receipt);

				document.getElementById('ReceivestealthInfo').innerHTML += `✅ TRANSACTION SUCCESSFUL <a target="_blank" rel="noopener noreferrer" href="${optionsList[0].EXPLORER}/tx/${txResponse.hash}">Tx link</a>`;
			} catch (error) {
				console.error("Transaction error:", error);
			}


		}



		// Function triggered by the initial button click
		function sendStAdrrFunds() {
			// Check if the input and send button have already been added
			if (!document.getElementById('sendFundsContainer')) {
				// Add an input field for entering the recipient's Ethereum address and a "Send" button
				document.getElementById('ReceivestaddrInfo').innerHTML += `
<div id="sendFundsContainer">
	<br>
	<input type="text" id="customrecipientAddress" placeholder="Enter recipient address" class="input-primary" required>
	<button class="button-primary" type="button" onclick="confirmSend()">Send Funds</button>
</div>
`;
			}
		}


		// Function to handle the confirmation and transaction sending
		function confirmSend() {
			const recipientAddress = document.getElementById('customrecipientAddress').value;

			if (ethers.isAddress(recipientAddress)) {
				// Add your logic to send funds to the recipient address here
				console.log(`Sending funds to: ${recipientAddress}`);

				// Example of sending funds logic (replace with your transaction logic)
				// await signer.sendTransaction({ to: recipientAddress, value: ethers.parseEther('0.01') });

				alert(`Sending fundsto ${recipientAddress}`);
				claimStealthAddrFunds(recipientAddress)
				// send
			} else {
				alert('Invalid Ethereum address');
			}
		}


		/*********************************************************************************************
		.)  SEND / RECEIVE TOKENS ERC20
		**********************************************************************************************/

		// Helper function to convert Base64 URL to Base64
		function base64UrlToBase64(base64Url) {
			return base64Url.replace(/-/g, '+').replace(/_/g, '/').padEnd(base64Url.length + (base64Url.length % 4), '=');
		}


		async function prepareStealthAddr (){
			console.log('preparing Stealth address');
			document.getElementById('sarecipientAddress').innerHTML = ` <p>Calculating stealth address  <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </p>`
				document.getElementById('stealthInfo').style.display = 'block'; // Example action

				// get peer publickey
				let peerAddr = document.getElementById('peerAddr').getAttribute('data-address')
				console.log('🤼‍♀️ peerAddr: ', peerAddr)
				let peerDId = `did:ius:${peerAddr}`;
				let didData = await fetchDID(peerDId)
				let peerPublicKey = didData.data.publicKey
				console.log('🤸‍♀️ peerPublicKey: ', peerPublicKey)

				// ---
				// convert public key
				// Step 0: Convert Base64 URL to Base64
				// Step 1: Decode base64 to raw bytes using ethers.decodeBase64 for Ethers.js v6
				// Step 2: Convert yBytes to a BigInt to check if it's even or odd
				// Step 3: Determine the prefix: 0x02 if y is even, 0x03 if y is odd
				// Step 4: Compress the public key (prefix + x coordinate)
				// ---
				const publicKeyJWK = peerPublicKey
				const xBase64 = base64UrlToBase64(publicKeyJWK.x);
				const yBase64 = base64UrlToBase64(publicKeyJWK.y);
				const xBytes = ethers.decodeBase64(xBase64);
				const yBytes = ethers.decodeBase64(yBase64);
				const yBigInt = BigInt(ethers.hexlify(yBytes));//quizas no es necesario bigint..
				const prefix = yBigInt % 2n === 0n ? 0x02 : 0x03;
				const precompressedPublicKey = ethers.concat([new Uint8Array([prefix]), xBytes]);
				const compressedPublicKey = ethers.hexlify(precompressedPublicKey);
				// console.log("Compressed Public Key:", compressedPublicKey);

				// ---------
				// PRIVKEY
				// ---------
				let signer = await getSigner()
				let alicePrivateKey = signer.privateKey
				let stealthAddress = await generateStealthAddress(alicePrivateKey, compressedPublicKey)
				console.log(`<br>👩👻Stealth address generated by YOU (A) to pay your PEER(B): ${stealthAddress.stealthAddress} <br>👫sharedSecret: ${stealthAddress.sharedSecret}`)
				document.getElementById('sarecipientAddress').innerHTML = stealthAddress.stealthAddress
 
				// CHECK STEALTH ADDRESS BALANCE (FOR NATIVE ONLY!)
				let provider = await new ethers.JsonRpcProvider(optionsList[0].API);
				let staddrBalance = await provider.getBalance(stealthAddress.stealthAddress);
				console.log("native token balance:", ethers.formatEther(staddrBalance));
				let stddrformatedBalance = ethers.formatEther(staddrBalance)
				document.getElementById('staddrInfo').innerHTML = `Peer Stealth's Balance: ${stddrformatedBalance} `

		}
		async function generateStealthAddress(privateKeyHex, publicKey) {

			console.warn('🏰 generateStealthAddress()')

			const hexPublicKey = publicKey.startsWith('0x') ? publicKey.slice(2) : publicKey;
			const pubPoint = secp.ProjectivePoint.fromHex(hexPublicKey);
			console.log('pubPoint:', pubPoint)

			const sharedSecret = pubPoint.multiply(BigInt(privateKeyHex)).toHex();
			console.log('👫sharedSecret( at generateStealthAddress):', sharedSecret);
			const hashedSecret = ethers.keccak256('0x' + sharedSecret).slice(0, 42);

			// 1.Multiply hs by the curve generator point (G): You can use the secp256k1 generator point (which is a constant) to compute the point hs * G.
			const G = secp.ProjectivePoint.BASE;  // Generator point G
			const hsBigInt = BigInt(hashedSecret);  // hs should already be in hex or BigInt format
			const hsPoint = G.multiply(hsBigInt);  // hs * G

			// 2.Add Bob’s public key: You now add Bob’s public key as an elliptic curve point to hs * G. Ensure Bob's public key is in the correct format for the addition.
			const stealthPubPoint = hsPoint.add(pubPoint);  // hs * G + Bob's public key

			// 3.Convert the resulting point to an Ethereum address: Finally, you convert the resulting elliptic curve point to an Ethereum address. This is typically done by compressing the point to its x-coordinate, hashing it, and then converting it to an Ethereum address.
			const stealthPubKey = stealthPubPoint.toHex();  // Convert to hex
			const stealthAddress = ethers.computeAddress('0x' + stealthPubKey);  // Convert to Ethereum address
			console.log('👻Stealth Address:', stealthAddress);
			return { stealthAddress, sharedSecret }
		}


		async function openSend(addr) {
			console.warn('openSend', addr)

			// if 🦹‍♂️↔️🦹‍♀️ Stealth addresses always on
			const checkbox = document.getElementById("stealthAddressCheckbox");

			const stealthAddressOn = localStorage.getItem('stealthAddressAlwaysOn');
			if (stealthAddressOn === 'true') {
				console.log('stealthAddressAlwaysOn is on')
				// To check the checkbox
				checkbox.checked = true;
				// also run de function to load the stealth
				prepareStealthAddr()
			} else {
				console.log('stealthAddressAlwaysOn is off')
				checkbox.checked = false;

			}

			if (addr) {
				console.log('there is address', addr)
			}
			else {
				console.log('there is not addr')
			}


			// // open modal
			openModalId('#walletSend')

			// // get recipient address
			document.getElementById("recipientAddress").value = addr;

			// fill token selector (tokenType)
			// populateSelectInput('tokenType');

			// get token balance




		}



		// document.getElementById('tokenType').addEventListener('change', function () {
		// 	console.log('TOKEN TYPE CHANGED')

		// 	const selectedType = this.value;
		// 	const erc20Selector = document.getElementById('erc20Selector');
		// 	const erc20Details = document.getElementById('erc20Details');
		// 	if (this.value === 'erc20') {
		// 		erc20Details.classList.remove('d-none');
		// 	} else {
		// 		erc20Details.classList.add('d-none');
		// 	}
		// });





		///////////////////////////////////////
		// 1. SEND
		///////////////////////////////////////
		document.getElementById('sendTransactionBtn').addEventListener('click', async function (event) {
			console.log('CLICKED sendTransactionBtn')


			// clear ui
			document.getElementById('transactionDetails').innerHTML =''

			// disable CONFIRM button until gas estimation is loaded
			document.getElementById('confirmTransactionBtn').disabled = true
			document.getElementById('confirmTransactionBtn').innerHTML = `<div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> `
			const amountInput = document.getElementById('amount');
			const amount = document.getElementById('amount').value;

			if (!amountInput.value) {
				amountInput.classList.add('is-invalid');
				event.preventDefault();
				return	
			} else {
				amountInput.classList.remove('is-invalid');
			}
			let transactionDetails = `Recipient: ${recipientAddress}\nAmount: ${amount} ${tokenType === 'eth' ? 'ETH' : 'Tokens'}`;
			const storedTokenType = localStorage.getItem('selectedTokenType');











			// is EVM TOKEN (hay que cambiar erc20 a EVM para hacerlo menos confuso)
			// if (storedTokenType === 'erc20') {
			if (storedTokenType === 'evm') {
				console.log(' IS ERC20 / EVM OTKEN')
			}


			// Switch to confirmation tab
			const tab = new bootstrap.Tab(document.getElementById('confirmation-tab'));
			tab.show();
			let addr = document.getElementById('yourAddress').getAttribute('address');
			let toAddress = document.getElementById('peerAddr').getAttribute('data-address')

			// ----------------
			let preferredIndex = localStorage.getItem('preferredTokenIndex');
			// Set the default index to 0 if no preferred index is stored
			if (preferredIndex === null) {
				preferredIndex = 0;
			} else {
				preferredIndex = parseInt(preferredIndex, 10); // Convert the stored value to an integer
			}
			// Retrieve the stored data from localStorage
			let storedData = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];

			// If the preferred index is within the range of stored tokens, return the corresponding token details
			if (storedData[preferredIndex]) {
				preferredToken = storedData[preferredIndex];
				pref = preferredToken
			} else {
				console.log('some problem in checkERC20Balance')
				return
			}

			const length = preferredToken.rpcs.length;
			const randomnumber = Math.floor(Math.random() * length);
			const selectedProvider = preferredToken.rpcs[randomnumber];
			console.log('selectedProvider:', selectedProvider);
			let provider;
			try { provider = await new ethers.JsonRpcProvider(selectedProvider); }
			catch (error) { console.warn('error creating provider', error) }
			console.warn('Provider', provider)









			// ................................................................................................
			// IF NATIVE 
			// NATIVE-BALANCE
			//  ELSE
			// ERC20-BALANCE
			// ................................................................................................
			const formattedAddress = ethers.getAddress(userAddress);

			let signer = await getSigner()
			let cws;
			let amountToSend;
			let txGasEstimage;
			let s;



			// NATIVE TOKEN 1
			if (preferredToken.contractAddr == 'nativeToken') {
				console.log('NATIVE TOKEN')
				document.getElementById('transactionDetails').innerHTML = `<br><span id="txbal"> NATIVE TOKEN balance:  <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </span> `;
				amountToSend = ethers.parseUnits(amountInput.value);  // 18 is the number of decimals for Ether

				//  let signer = await getSigner() 

				// ................................
				// GAS BALANCE
				// ................................
				const gasBalance = await provider.getBalance(signer.address);
				const formatedgasBalance = ethers.formatEther(gasBalance);
				console.log(`GAS Balance : ${formatedgasBalance} GAS`);
				s = signer.connect(provider);//signer(wallet connected to provider)
				console.log('connected signer to provider:', provider)
				// let s = signer.connect(provider);//signer(wallet connected to provider)
				// let cws;


				// ................................
				// NOW ESTIMATE GAS FEES
				// ................................

				const precurrentNonce = await provider.getTransactionCount(signer.address);
				console.log('CALCULATE NONCE: ', precurrentNonce)
				// let txGasEstimage

				console.log(' Estimated Gas for NATIVE TOKEN')
				document.getElementById('txbal').innerHTML = `Native Token balance: ✅${formatedgasBalance}  `;
				document.getElementById('transactionDetails').innerHTML += `<br><span id="estgas"> 🔮 Estimating gas <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </span> `;

				const pretx = {
					to: recipientAddress,          // Bob's current address
					value: amountToSend,          // Amount of ETH to send (here it's all balance)SEND MAXIMUM MINUS ESTIMATED GAS
					gasLimit: undefined      // Will be estimated next
				};
				console.log('pretx', pretx)

				//  txGasEstimage = await s.estimateGas(pretx);
				let txGasEstimate;

				try {
					txGasEstimate = await s.estimateGas(pretx);
					console.log('Estimated gas:', txGasEstimate.toString());
				} catch (error) {
					console.error('Error estimating gas:', error);
					document.getElementById('estgas').innerHTML = `<span class="text-danger">⛽📛 Gas estimation error: ${error.shortMessage}</span>`;
					document.getElementById('confirmTransactionBtn').disabled = true
					document.getElementById('confirmTransactionBtn').innerHTML = `Confirm`
					return

				}

				tge = txGasEstimate;
				if (txGasEstimate) {
					// You can now use txGasEstimate outside the try...catch block
					console.log('Gas estimate available:', txGasEstimate.toString());
					document.getElementById('estgas').innerHTML = `Gas estimated for this tx ⛽: ${ethers.formatEther(txGasEstimate)}`
				}
				// console.log('txGasEstimage' ,txGasEstimage)





			}
			else {
				console.log('if ERC20 TOKEN')

				let contractAddr = preferredToken.contractAddr
				const tokenContract = await new ethers.Contract(contractAddr, erc20Abi, provider);
				tk = tokenContract;
				console.log('CONTRACT READY!');
				console.log('GETTING ERC20 BALANCE ...');
				document.getElementById('transactionDetails').innerHTML += `<br><span id="txbal"> ERC-20 balance:  <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </span> `;



				let erc20balance;
				try { erc20balance = await tokenContract.balanceOf(formattedAddress); }
				catch (error) {
					document.getElementById('txbal').innerHTML = `❌ Error getting ERC-20 balance: ${error.reason}, using provider ${selectedProvider}`;
					if (error.message.includes('Failed to fetch')) { console.warn('Error getting balance: Network or fetch issue. refetch?'); }
					else { console.warn('Error getting balance:', error); }
				}
				const decimals = await tokenContract.decimals();
				console.log('decimals:', decimals);
				let formatedBalance = ethers.formatUnits(erc20balance, decimals);
				console.log('formatedBalance:', formatedBalance);
				console.warn(`ERC-20 Balance of ${preferredToken.tokenName}: ${formatedBalance} `);
				document.getElementById('txbal').innerHTML = `ERC-20 balance:  ${formatedBalance}`;
				// document.getElementById('transactionDetails').innerHTML += `<br><span id="estgas">🤠 Estimating gas <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </span> `;

				// ................................
				// CHECK IF ERC20 BALANCE >= AMOUNT
				// ................................
				amountToSend = ethers.parseUnits(amountInput.value, decimals);  // 18 is the number of decimals for Ether
				console.log('amountToSend:', amountToSend);
				if (erc20balance >= amountToSend) {
					document.getElementById('txbal').innerHTML += ` <br>✅ Enough ERC-20 balance to cover this transaction`;
				}
				else {
					document.getElementById('confirmTransactionBtn').innerHTML = `Confirm`
					document.getElementById('txbal').innerHTML = `Insufficient ERC-20 balance:  ${formatedBalance} ❌`;
					return
				}

				// ................................
				// GAS BALANCE
				// ................................
				document.getElementById('transactionDetails').innerHTML += `<br><span id="estgas">🤠 Estimating gas <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </span> `;

				const gasBalance = await provider.getBalance(signer.address);
				const formatedgasBalance = ethers.formatEther(gasBalance);
				console.log(`GAS Balance : ${formatedgasBalance} GAS`);
				let s = signer.connect(provider);//signer(wallet connected to provider)
				console.log('connected signer to provider:', provider)
				// ................................
				// NOW ESTIMATE GAS FEES
				// ................................

				const precurrentNonce = await provider.getTransactionCount(signer.address);
				console.log('CALCULATE NONCE: ', precurrentNonce)
				console.log('Estimated Gas for ERC20 TOKEN')
				cws = await tokenContract.connect(s);// connect tokenContract to signer(contract with signer)
				txGasEstimage = await cws.transfer.estimateGas(recipientAddress, amountToSend);
				const formatedtxGasEstimage = ethers.formatEther(txGasEstimage);
				console.log(`Estimated Gas: ${txGasEstimage.toString()}`);
				document.getElementById('txbal').innerHTML += `<br><br>Gas balance: ⛽${formatedgasBalance}  `;
				document.getElementById('estgas').innerHTML = `<br>Estimated gas: ⛽${formatedtxGasEstimage} `;

				const feeData = await provider.getFeeData();
				const gasPrice = feeData.gasPrice;
				if (!gasPrice) {
					throw new Error('Gas price is not available');
				}
				console.log(`Gas Price: ${ethers.formatUnits(gasPrice, 'gwei')} gwei`);

				// Calculate the total gas cost in ETH
				const gasCostInEth = gasPrice * txGasEstimage;
				const gasCostInEthFormatted = ethers.formatUnits(gasCostInEth, 'ether');
				console.log(`Gas Cost in ETH: ${gasCostInEthFormatted}`);
				// Get the ETH to USD conversion rate
				const ethUsdPrice = await getEthUsdPrice();
				console.log(`ETH to USD: $${ethUsdPrice}`);

				// Convert gas cost to USD
				const gasCostInUsd = parseFloat(gasCostInEthFormatted) * ethUsdPrice;
				console.log(`Estimated Gas Cost in USD: $${gasCostInUsd.toFixed(6)}`);

				// txbuilder.style.display = 'none';
				document.getElementById('estgas').innerHTML += `<br>(Gas Cost in USD: 💵 $${gasCostInUsd.toFixed(6)})`



				// ((((((((((((((((((((((((()))))))))))))))))))))))))
				// ERC20 balance and gas balance to pay for this tx
				if (gasBalance >= gasCostInEth) {
					console.log(" ✅ Sufficient balance to cover transaction and gas fees!");
					document.getElementById('estgas').innerHTML += `<br> ✅ Enough gas balance to cover  gas fees  `;
				} else {
					console.log("❌Insufficient balance to cover transaction and gas fees.");
					document.getElementById('estgas').innerHTML += `<br> ❌Insufficient balance to cover transaction and gas fees  `;
					document.getElementById('confirmTransactionBtn').innerHTML = `Confirm`
					return
				}


			} //fin ERC20 TOKEN



			// ((((((((((((((((((((((((()))))))))))))))))))))))))

			// disable button until gas estimation is loaded
			document.getElementById('confirmTransactionBtn').disabled = false
			document.getElementById('confirmTransactionBtn').innerHTML = `Confirm`



			//////////////////////////////////////////////////////////////////////////////
			// 2. CONFIRM
			// - do the tx
			//////////////////////////////////////////////////////////////////////////////
			document.getElementById('confirmTransactionBtn').addEventListener('click', async function () {
				console.log('confirmTransactionBtn CLICKED!')

				//  Show result tab
				const resultTab = new bootstrap.Tab(document.getElementById('result-tab'));
				resultTab.show();
				document.getElementById('resultMessage').innerHTML = `<span id="makingtx"> Making transaction ( do not close this modal) <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </span>`;

				//  ---------------------------
				// SEND
				// check nonce 
				const currentNonce = await provider.getTransactionCount(signer.address);
				console.log('RECALCULATE NONCE: ', currentNonce)

				// NATIVE TOKEN 2
				if (preferredToken.contractAddr == 'nativeToken') {
					// send NATIVE TOKEN
					console.log('🚀 SEND NATIVE TOKEN')
					const pretx = {
						to: recipientAddress,          // Bob's current address
						value: amountToSend,          // Amount of ETH to send (here it's all balance)SEND MAXIMUM MINUS ESTIMATED GAS
						gasLimit: undefined      // Will be estimated next
					};
					console.log('pretx', pretx)

					let txGasEstimate;

					try {
						tx = await s.sendTransaction(pretx);
						// console.log('Estimated gas:', txGasEstimate.toString());
					} catch (error) {
						console.error('Error estimating gas:', error);
						// document.getElementById('estgas').innerHTML = `<span class="text-danger">⛽📛 Gas estimation error: ${error.shortMessage}</span>`;
						// document.getElementById('confirmTransactionBtn').disabled = true
						// document.getElementById('confirmTransactionBtn').innerHTML = `Confirm`
						return

					}
					// SUCCESS
					console.log(`Transaction hash: ${tx.hash}`);

					// -------------
					// GET TOKEN EXPLORER
					// let preferredToken;
					// let tokenName;
					// let tokenExplorer;
					// console.warn('🐭 storedTokenType: ', storedTokenType)
					// return
					// if (storedTokenType === 'erc20') {
					// preferredToken = await recallStoredToken();
					tokenName = preferredToken.tokenName;
					const telength = preferredToken.explorers.length;
					const terandomnumber = Math.floor(Math.random() * telength);
					let tokenExplorer = preferredToken.explorers[terandomnumber].url;
					console.log('selectedTokenExplorer:', tokenExplorer);
					// }

					console.log('+ info: ', tokenName, tokenExplorer)

					// -------
					const receipt = await tx.wait();

					let txLink = `${tokenExplorer}/tx/${tx.hash}`;
					console.log(`Transaction link: ${txLink}`);
					document.getElementById('resultMessage').innerHTML += `✅<br><span class ="tx"> SUCCESS 🎉🎉🎉!!! Here is the tx  <a href="${txLink}" target="_blank">Link</a> ✨✨✨</span>`

					// -------------
					//close modal and reset its UI
					closeModalId("#walletSend")

					Swal.fire({
						icon: "success",
						title: `Sent ${amount} ${tokenName}!💸`,
						html: `<span class ="tx">Transaction was mined in block ${receipt.blockNumber} ✅</span><br><span class ="tx"> Here is the tx  <a href="${txLink}" target="_blank">Link</a> ✨✨✨</span>`
					});

					// ------------------------------
					// send tx information via chat
					const conversation = await iusnaturalisxmtp.conversations.newConversation(toAddress)
					let message = `sent you ${amount} ${tokenName} <a href="${txLink}" target="_blank">Link</a> <pre style="display: none;" txLink="${txLink}" preferredToken="${JSON.stringify(preferredToken)}" >paymentReceived0x21</pre> `
					await conversation.send(`${message}`, {})
					await loadToken(addr)// UPDATE BALANCE









				} else {
					// send ERC20
					console.log(' 🛫 SEND ERC20')

					try {
						const tx = await cws.transfer(recipientAddress, amountToSend, { txGasEstimage });
						console.log(`Transaction hash: ${tx.hash}`);
						document.getElementById('resultMessage').innerHTML = `<span class ="tx">Transaction hash:  ${tx.hash} ✅</span>`;
						document.getElementById('resultMessage').innerHTML += `<span class ="txdone">waiting for confirmation <div class="dots-container"> <span class="dot">.</span> <span class="dot">.</span> <span class="dot">.</span> </div> </span>`;

						// Wait for the transaction to be mined
						const receipt = await tx.wait();
						console.log(`Transaction was mined in block ${receipt.blockNumber}`);
						document.getElementById('resultMessage').innerHTML = `<span class ="tx">Transaction was mined in block ${receipt.blockNumber} ✅</span>`;

						// -------------
						let preferredToken;
						let tokenName;
						let tokenExplorer;
						console.warn('🐭 storedTokenType: ', storedTokenType)
						if (storedTokenType === 'evm') {
							// if (storedTokenType === 'erc20') {
							preferredToken = await recallStoredToken();
							tokenName = preferredToken.tokenName;
							const telength = preferredToken.explorers.length;
							const terandomnumber = Math.floor(Math.random() * telength);
							tokenExplorer = preferredToken.explorers[terandomnumber].url;
							console.log('selectedTokenExplorer:', tokenExplorer);
						}

						console.log('+ info: ', tokenName, tokenExplorer)

						// -------
						let txLink = `${tokenExplorer}/tx/${tx.hash}`;
						console.log(`Transaction link: ${txLink}`);
						document.getElementById('resultMessage').innerHTML += `✅<br><span class ="tx"> SUCCESS 🎉🎉🎉!!! Here is the tx  <a href="${txLink}" target="_blank">Link</a> ✨✨✨</span>`

						// -------------
						//close modal and reset its UI
						closeModalId("#walletSend")

						// -------------
						// display success 
						Swal.fire({
							icon: "success",
							title: `Sent ${amount} ${tokenName}!💸`,
							html: `<span class ="tx">Transaction was mined in block ${receipt.blockNumber} ✅</span><br><span class ="tx"> Here is the tx  <a href="${txLink}" target="_blank">Link</a> ✨✨✨</span>`
						});

						// ------------------------------
						// send tx information via chat
						const conversation = await iusnaturalisxmtp.conversations.newConversation(toAddress)

						let message = `sent you ${amount} ${tokenName} <a href="${txLink}" target="_blank">Link</a> <pre style="display: none;" txLink="${txLink}" preferredToken="${JSON.stringify(preferredToken)}" >paymentReceived0x21</pre> `
						await conversation.send(`${message}`, {})
						await loadToken(addr)// UPDATE BALANCE


						// -------------------------------

					} catch (error) {
						// Handle insufficient funds error
						if (error.code === 'INSUFFICIENT_FUNDS') {
							console.error('Insufficient funds for the transaction.');
							document.getElementById('resultMessage').innerHTML += `<br><span class ="tx"> Error: Insufficient funds for the transaction. 🚫</span>`;
							document.getElementById('transactionDetails').innerHTML += `<br><span class ="tx"> Error: Insufficient funds for the transaction. 🚫</span>`;
						} else {
							// Handle any other errors
							console.error(`Transaction failed: ${error.message}`);
							document.getElementById('resultMessage').innerHTML += `<br><span class ="tx"> Error: ${error.message} 🚫</span>`;
							document.getElementById('transactionDetails').innerHTML += `<span class ="tx"> Error: ${error.message} 🚫</span>`;

						}

						const tab = new bootstrap.Tab(document.getElementById('confirmation-tab'));
						tab.show();

					}

					return



				}




			});

			// return cws
		});





		document.getElementById('cancelTransactionBtn').addEventListener('click', function () {
			// Switch back to form tab if cancelled
			console.log('cancel send transaction PRESSED!')

			// const formTab = new bootstrap.Tab(document.getElementById('form-tab'));
			const formTab = new bootstrap.Tab(document.getElementById('preparetx-tab'));

			formTab.show();
		});




		// Function to get ETH to USD conversion rate from CoinGecko
		async function getEthUsdPrice() {
			const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd');
			const data = await response.json();
			return data.ethereum.usd;
		}


		// *********************************
		// ADD DOC
		// *********************************

		function addField() {
			console.log("addField()")
			const fieldContainer = document.getElementById('additionalFields');
			const newField = document.createElement('div');
			newField.classList.add('mb-2');
			newField.innerHTML = '<input type="text" class="form-control" placeholder="Enter text">';
			fieldContainer.appendChild(newField);
		}


		function addDoc(obj) {
			console.log('addDoc', obj)


			document.getElementById('input_image').click();

			document.getElementById('input_image').onchange = async function (e) {

				// 1- add 'adding document' spin to button
				addDocumentButton.disabled = true;
				plusAddDocumentButton.style.display = 'none'
				spinAddDocumentButton.style.display = 'inline'

				let name = input_image.files[0].name
				let title = name.substring(0, name.lastIndexOf('.')) || name;
				console.log('NEW title', title)

				let newStr = name.replace(/[\s-]/g, "");
				console.log('new compresed TITLE: ', newStr);

				const data = input_image.files[0]
				console.log('DATA: ', data);

				// V2 UPLOAD TO IPFS
				// let ipfsGateway = 'https://gateway.lighthouse.storage/ipfs/'
				const files = [new File([data], name, { type: 'application/pdf' })]
				console.log('files: ', files);
				const uploadResponse = await lighthouse.upload(files, apiKeyLighthouse);
				u = uploadResponse;
				console.log(uploadResponse);
				let cid = `${uploadResponse.data.Hash}`
				let ipfsGateway = optionsList[0].IPFS_GATEWAY;
				let ipfsLink = `${ipfsGateway}${uploadResponse.data.Hash}`
				const status = await lighthouse.dealStatus(`${uploadResponse.data.Hash}`)
				console.log('status:', status)
				let price = await lighthouse.getPrice(1024, "filecoin", "native")
				console.log('price:', price)

				Toast.fire(dictionary[globalLang]["fileuploaded"], '', "success");

				// ADD DOCS TO UI
				// 1-ADD TO UI(table)
				// let cid2ui = addCidToUI(title, cid)
				// console.log('cid2ui:', cid2ui)

				// ADD DOC NEW


				// RELOAD TRANSALATIONS
				reloadTranslations();


				// ADD TO LOCALSTORAGE
				let scid = cid.trim()
				let ct = [];
				let documentAttestLink = '';//null no es aceptado por polybase
				let doc = { title: title, cid: scid, courtesy_translations: ct, attestation: documentAttestLink }//NEW
				console.log('doc:', doc)
				SaveDocToLocalStorage(doc);
				d = doc

				// ADD DOCS TO UI
				loadDocs()

				// HASH OF DOCS
				const hash = ethers.sha256(ethers.toUtf8Bytes(JSON.stringify(doc)));
				console.log('sha-256', hash);


				// ADD TO DID
				let did = `did:ius:${userAddress}`;
				// getDocsFromLocalstorage
				let docsFromLS = localStorage.getItem('documents');

				await updateDIDdocs(did, docsFromLS)

				// activate envoi button
				console.log('ACTIVA BOTON ENVOI')
				// document.getElementById('createIPFSDelivery').disabled = false;// DESACTIVAR BOTON createIPFSDelivery
				// document.querySelector('#cancelAttesting').disabled = false;


				// RETORE toggleButton
				// 1- add 'adding document' spin to button
				addDocumentButton.disabled = false;
				plusAddDocumentButton.style.display = 'inline'
				spinAddDocumentButton.style.display = 'none'


			}




		}




		function addCidToUI(title, cid) {
			let o = `  <div class="card mb-3"> <div class="card-body"> 
        <h5 class="card-title">
          ${title}
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"  onclick="event.stopPropagation();editTitle('${title}',event)" height="13px">
              <path fill='currentColor' d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/></svg>
          </h5>
           <p class="card-text"></p> <p class="card-link" onclick="copyItem(event,innerHTML)"> ${cid}</p> </div> <div class="card-footer text-muted"><span> 
                
                <button type="button" class="btn btn-outline-info px-3 waves-effect" onclick="event.stopPropagation();viewItem('${cid}')"> <svg width="18" height="16" class="svg-inline--fa fa-eye" aria-hidden="true" data-prefix="fas" data-icon="eye" role="img" viewBox="0 0 576 512"> <path fill="currentColor" d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7 0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zm144 224c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zm-144-64c0 35.3-28.7 64-64 64-11.5 0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4 0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8 0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"> </path> </svg> </button>
                
                <button type="button" class="btn btn-outline-info waves-effect px-3"
                  onclick="event.stopPropagation();deleteItem((this.parentElement))">
                  <svg xmlns="http://www.w3.org/2000/svg"  width="18" height="16" viewBox="0 0 512 512">
                <path fill="currentColor" d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>
                    </button>
                    
                <button type="button" class="btn btn-outline-info waves-effect px-3"
                  onclick="event.stopPropagation();showCIDQR('${cid}','${title} ')"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="16" viewBox="0 0 512 512">
                <path fill="currentColor" d="M0 80C0 53.5 21.5 32 48 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V80zM64 96v64h64V96H64zM0 336c0-26.5 21.5-48 48-48h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V336zm64 16v64h64V352H64zM304 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H304c-26.5 0-48-21.5-48-48V80c0-26.5 21.5-48 48-48zm80 64H320v64h64V96zM256 304c0-8.8 7.2-16 16-16h64c8.8 0 16 7.2 16 16s7.2 16 16 16h32c8.8 0 16-7.2 16-16s7.2-16 16-16s16 7.2 16 16v96c0 8.8-7.2 16-16 16H368c-8.8 0-16-7.2-16-16s-7.2-16-16-16s-16 7.2-16 16v64c0 8.8-7.2 16-16 16H272c-8.8 0-16-7.2-16-16V304zM368 480a16 16 0 1 1 0-32 16 16 0 1 1 0 32zm64 0a16 16 0 1 1 0-32 16 16 0 1 1 0 32z"/></svg></button>
                
                <button type="button" class="btn btn-outline-info waves-effect px-3"
				onclick="event.stopPropagation();testifyDocument('${cid}','${title} ')"><i class="fa-solid fa-plus" aria-hidden="true"></i>
				<span data-translate="testifyDocument">Add</span></button>
                
				</span></div> </div>  `;
			document.getElementById('tbody').innerHTML += o;
			// <button type="button" class="btn btn-outline-info waves-effect px-3" onclick="event.stopPropagation();uploadCourtesyTranslation(this.parentElement)"><i class="fa-solid fa-plus" aria-hidden="true"></i> <span data-translate="addcourtesytranslation">Add</span></button>

		}



		/*********************************************************************************************
		.) EDIT TABLE ITEMS
		**********************************************************************************************/



		function viewItem(cid) {
			let ipfsGateway = optionsList[0].IPFS_GATEWAY;
			let ipfslink = `${ipfsGateway}${cid}`;
			console.log('ipfslink:', ipfslink);
			window.open(ipfslink, '_blank', 'fullscreen=yes');
			return false;
		}

		function openLink(link) {
			console.log('openLink:', link);
			window.open(link, '_blank', 'fullscreen=yes');
			return false;
		}

		function shareItem(cid) {
			// Logic to share the document by its CID (Content Identifier)
			// This could involve copying a link to the clipboard, sharing via an API, etc.

			// Example: Copy a link to the clipboard
			const shareLink = `https://example.com/ipfs/${cid}`;

			navigator.clipboard.writeText(shareLink).then(() => {
				alert('Link copied to clipboard!');
			}).catch(err => {
				console.error('Failed to copy link: ', err);
			});
		}



		async function showCIDQR(cid, title) {
			let ipfsGateway = optionsList[0].IPFS_GATEWAY;
			let linkIPFS = `${ipfsGateway}${cid}`
			console.log(cid, title, linkIPFS)
			const cidqr = new QRCodeStyling({
				width: 300, height: 300, type: "png", data: linkIPFS, image: `logo4.png`,
				dotsOptions: { color: "#41307c", type: "extra-rounded" }, backgroundOptions: { color: "#fff", }, imageOptions: {
					crossOrigin: "anonymous", margin: 0
				}
			});
			let cidqrRaw = await cidqr.getRawData('png')
			console.log(' WATCH showCIDQR cidqrRaw: ', cidqrRaw)
			let cidqrURL = URL.createObjectURL(cidqrRaw)

			console.log('xqr: ', cidqr)


			Swal.fire({
				text: title,
				imageUrl: cidqrURL,
				imageWidth: 300,
				imageHeight: 300,
				imageAlt: 'QR Code image',
			})
		}



		function editTitle(title, event) {
			console.log(title, event, event.target, event.target.parentNode)
			let curtitle = title
			Swal.fire({
				html: ` <h1>Current title: <span id="currenttitle">${curtitle}</span></h1> 
        
        <br>
        
        <h1>
        ${dictionary[globalLang]["newtitle"]}
        </h1>
        `,
				input: 'text',
				inputAttributes: {
					autocapitalize: 'off'
				},
				showCancelButton: true,
				confirmButtonText: 'change',
				showLoaderOnConfirm: true,
				preConfirm: (login) => { },
				allowOutsideClick: () => {
					const popup = Swal.getPopup()
					popup.classList.remove('swal2-show')
					setTimeout(() => { popup.classList.add('animate__animated', 'animate__headShake') })
					setTimeout(() => { popup.classList.remove('animate__animated', 'animate__headShake') }, 500)
					return false
				},

			})
				.then((result) => {
					if (result.isConfirmed) {
						console.log('RESULT:', result.value)
						let title = result.value;
						let htmlcontent = `${title} <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"  onclick="event.stopPropagation();editTitle('${title}',event)" height="13px"> <path fill='currentColor' d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/></svg> `
						event.target.parentNode.innerHTML = htmlcontent;
						setTimeout(() => { updateArray(); console.log(' saved!') }, 1000);
						return
					}
				})
		}



		async function loadPublicDocsCard(docs) {
			console.log('loadPublicDocsCard()', docs);

			let LoadDocs = JSON.parse(docs);
			let htmlContent = '';

			if (LoadDocs) {
				LoadDocs.forEach((e) => {
					let t = e.title,
						n = e.cid,
						i = e.courtesy_translations,
						at = e.attestation;

					var s = [];

					i.forEach((e, t) => {
						let n = e.lang,
							i = `<button type="button" class="btn btn-outline-info px-3 waves-effect" onclick="event.stopPropagation(); viewItem('${e.cid}')">  <span>${n} </span><svg width="18" height="16" class="svg-inline--fa fa-language" aria-hidden="true" data-prefix="fas" data-icon="language" role="img" viewBox="0 0 640 512"> <path fill="currentColor" d="M0 128c0-35.3 28.7-64 64-64h512c35.3 0 64 28.7 64 64v256c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128zm320 0v256h256V128H320zm-141.7 47.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2l19 42.8h-38l19-42.8zM448 164c11 0 20 9 20 20v4h60c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5 0-28.3s20.5-7.8 28.3 0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z" /> </svg></button>`;
						s.push(i);
					});

					let o = `<div class="card mb-3">
                <div class="card-body">
                  <h5 class="card-title">${t}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" onclick="event.stopPropagation();editTitle('${t}',event)" height="13px"> 
                      <path fill='currentColor' d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/>
                    </svg>
                  </h5>
                  <p class="card-text"></p>
                  <p class="card-link" onclick="copyItem(event,innerHTML)">${n}</p>
                </div>
                <div class="card-footer text-muted">
                  <span>
                    <button type="button" class="btn btn-outline-info px-3 waves-effect" onclick="event.stopPropagation();viewItem('${n}')"> 
                      <svg width="18" height="16" class="svg-inline--fa fa-eye" aria-hidden="true" data-prefix="fas" data-icon="eye" role="img" viewBox="0 0 576 512"> 
                        <path fill="currentColor" d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7 0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zm144 224c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zm-144-64c0 35.3-28.7 64-64 64-11.5 0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4 0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8 0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z">
                        </path>
                      </svg>
                    </button>
             
                    <button type="button" class="btn btn-outline-info waves-effect px-3" onclick="event.stopPropagation();copy2clipboard('${n}')">
                      <svg xmlns="http://www.w3.org/2000/svg"  width="18" height="16"  viewBox="0 0 512 512"> 
                        <path fill="currentColor" d="M352 320c-22.1 0-42.1 8.6-57.4 22.7l-126-78.3c.9-5 1.4-10.1 1.4-15.4s-.5-10.4-1.4-15.4l126-78.3C309.9 183.4 329.9 192 352 192c44.2 0 80-35.8 80-80s-35.8-80-80-80-80 35.8-80 80c0 5.3.5 10.4 1.4 15.4l-126 78.3c-15.3-14.1-35.3-22.7-57.4-22.7-44.2 0-80 35.8-80 80s35.8 80 80 80c22.1 0 42.1-8.6 57.4-22.7l126 78.3c-.9 5-1.4 10.1-1.4 15.4 0 44.2 35.8 80 80 80s80-35.8 80-80-35.8-80-80-80z">
                        </path>
                      </svg>
                    </button>

					</span>
					</div>
					</div>`;
					htmlContent += o;
				});
			}

			return htmlContent;
		}

		// <button type="button" class="btn btn-outline-info waves-effect px-3">${s.join("")}</button>

		async function loadDocs() {
			console.log('DOCS FUNCTION')
			document.getElementById('tbody').innerHTML = '';

			let LoadDocs = JSON.parse(window.localStorage.getItem('documents'));
			if (LoadDocs) {

				LoadDocs.forEach((e) => {
					let t = e.title,
						n = e.cid,
						i = e.courtesy_translations;

					var s = [];

					i.forEach((e, t) => {
						let n = e.lang,
							i = `<button type="button" class="btn btn-outline-info px-3 waves-effect" onclick="event.stopPropagation(); viewItem('${e.cid}')">  <span>${n} </span><svg width="18" height="16" class="svg-inline--fa fa-language" aria-hidden="true" data-prefix="fas" data-icon="language" role="img" viewBox="0 0 640 512"> <path fill="currentColor" d="M0 128c0-35.3 28.7-64 64-64h512c35.3 0 64 28.7 64 64v256c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128zm320 0v256h256V128H320zm-141.7 47.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2l19 42.8h-38l19-42.8zM448 164c11 0 20 9 20 20v4h60c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5 0-28.3s20.5-7.8 28.3 0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z" /> </svg></button>
                   `;
						s.push(i);
					});


					let o = `  <div class="card mb-3"> <div class="card-body"> 
                <h5 class="card-title"> ${t}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"  onclick="event.stopPropagation();editTitle('${t}',event)" height="13px"> <path fill='currentColor' d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/></svg> </h5>
                <p class="card-text"></p> <p class="card-link" onclick="copyItem(event,innerHTML)"> ${n}</p> </div> <div class="card-footer text-muted"><span> 
                
                <button type="button" class="btn btn-outline-info px-3 waves-effect" onclick="event.stopPropagation();viewItem('${n}')"> <svg width="18" height="16" class="svg-inline--fa fa-eye" aria-hidden="true" data-prefix="fas" data-icon="eye" role="img" viewBox="0 0 576 512"> <path fill="currentColor" d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7 0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zm144 224c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zm-144-64c0 35.3-28.7 64-64 64-11.5 0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4 0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8 0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"> </path> </svg> </button>
                
                <button type="button" class="btn btn-outline-info waves-effect px-3"
                  onclick="event.stopPropagation();deleteItem((this.parentElement))">
                  <svg xmlns="http://www.w3.org/2000/svg"  width="18" height="16" viewBox="0 0 512 512">
                <path fill="currentColor" d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>
                    </button>
                    
                <button type="button" class="btn btn-outline-info waves-effect px-3"
                  onclick="event.stopPropagation();showCIDQR('${n}','${t} ')"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="16" viewBox="0 0 512 512">
                <path fill="currentColor" d="M0 80C0 53.5 21.5 32 48 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V80zM64 96v64h64V96H64zM0 336c0-26.5 21.5-48 48-48h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V336zm64 16v64h64V352H64zM304 32h96c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H304c-26.5 0-48-21.5-48-48V80c0-26.5 21.5-48 48-48zm80 64H320v64h64V96zM256 304c0-8.8 7.2-16 16-16h64c8.8 0 16 7.2 16 16s7.2 16 16 16h32c8.8 0 16-7.2 16-16s7.2-16 16-16s16 7.2 16 16v96c0 8.8-7.2 16-16 16H368c-8.8 0-16-7.2-16-16s-7.2-16-16-16s-16 7.2-16 16v64c0 8.8-7.2 16-16 16H272c-8.8 0-16-7.2-16-16V304zM368 480a16 16 0 1 1 0-32 16 16 0 1 1 0 32zm64 0a16 16 0 1 1 0-32 16 16 0 1 1 0 32z"/></svg></button>
                <button type="button" class="btn btn-outline-info waves-effect px-3"
                  onclick="event.stopPropagation();uploadCourtesyTranslation(this.parentElement)"><i class="fa-solid fa-plus"
                    aria-hidden="true"></i> <span data-translate="addcourtesytranslation">Add</span></button>
                <button type="button" class="btn btn-outline-info waves-effect px-3"
                  onclick="event.stopPropagation();testifyDocument('${n}','${t} ')"><i class="fa-solid fa-plus" aria-hidden="true"></i>
                  <span data-translate="testifyDocument">Add</span></button>
                
                ${s.join("")} </span></div> </div>  `;
					document.getElementById('tbody').innerHTML += o;
				});

			}
		}




		async function deleteItem(obj) {
			console.log('deleteItem()', obj)
			Swal.fire({
				title: dictionary[globalLang]["sure"],
				text: dictionary[globalLang]["wontbeabletorevertthis"],
				icon: 'warning',
				showCancelButton: true,
				confirmButtonColor: '#3085d6',
				cancelButtonColor: '#d33',
				confirmButtonText: dictionary[globalLang]["yes"]
			})
				.then((result) => {
					if (result.isConfirmed) {

						// 1- GET INDEX
						let rowid = obj.parentNode.getAttribute('data-index');
						console.log('riwid: ', rowid)

						// 2- DELETE FROM LOCALSTORAGE
						let docs = Array.from(document.getElementById('uploadedDocuments').children);//HECHO GLOBAL TEMPORALMENTE.
						let docNames = [];
						docs.forEach(function (docs, index) {
							let t = docs.children[0].children[0].innerText//title
							let c = docs.children[0].children[2].innerText.trim();// cid
							let att = docs.children[0].children[3];// attestation
							let ctc = docs.children[0].children[4];// courtesy translations
							let ct = [];

							// Check if ctc is defined before proceeding
							if (ctc !== undefined) {
								var newArray = Array.from(ctc)
									.filter(function (item) {
										let x = item.hasAttribute('data-cid');
										if (item.hasAttribute('data-cid')) {
											let y = item.dataset.lang; // lang
											let z = item.dataset.cid.trim(); //cid
											let courtesytranslations = { lang: y, cid: z };
											ct.push(courtesytranslations);
										}
									});
							} else {
								// Handle the case where ctc is undefined
								console.warn("Courtesy translations are undefined");
							}

							let doc = { title: t, cid: c, courtesy_translations: ct }
							docNames.push(doc);
						});

						let updatedDocNames = docNames.filter(item => item !== docNames[rowid])
						localStorage.setItem('documents', JSON.stringify(updatedDocNames));


						// UPDATE DID
						let did = `did:ius:${userAddress}`;
						updateDIDdocs(did, updatedDocNames)

						// 4- SEND SWEET MESSAGE
						Toast.fire(dictionary[globalLang]["documentdeleted"], '', "success");

					}
				})
		}





		async function encryptData(msg, pubkey) {

			//1. firma el hash del mensaje
			//2. arma un payload con el mensaje + la firma 
			//3. lo encrpta
			//4. lo convierte en estring



			// 0. get priv key
			let signer = await getSigner()
			if (!signer) {
				console.log('Handle case where signer is not obtained');
			}
			let alicePrivateKeyA = signer.privateKey

			// 1.
			const signature = EthCrypto.sign(
				alicePrivateKeyA,
				EthCrypto.hash.keccak256(msg)
			);
			console.log('HASH of encryptData(): ', EthCrypto.hash.keccak256(msg))

			// 2.
			const payload = {
				message: msg,
				signature
			};
			console.log('payload:', payload)


			// 3.
			const encrypted = await EthCrypto.encryptWithPublicKey(
				ethers.getBytes(pubkey), // by encrypting with bobs publicKey, only bob can decrypt the payload with his privateKey
				JSON.stringify(payload) // we have to stringify the payload before we can encrypt it
			);


			// 4.
			const encryptedString = EthCrypto.cipher.stringify(encrypted);
			// console.log('🔒 Encrypted data:', encryptedString)

			return encryptedString
		}



		/*********************************************************************************************
		.) SHOW WALLET
		**********************************************************************************************/
		async function showWallet() {
			console.log('showWallet')

			Swal.close(); // Close the modal

			// var audioContext = new AudioContext();

			// open modal
			openModalId('#walletModal')

		}


		// DESKTOP NOTIFICATIONS
		function requestNotificationPermission() {
			if ("Notification" in window) {
				Notification.requestPermission().then(permission => {
					if (permission === "granted") {
						console.log("Notification permission granted.");
						localStorage.setItem("notificationsEnabled", "true");
						document.getElementById("notificationToggle").checked = true;
					} else {
						console.log("Notification permission denied.");
						localStorage.setItem("notificationsEnabled", "false");
						document.getElementById("notificationToggle").checked = false;
					}
				});
			} else {
				console.log("This browser does not support desktop notification.");
			}
		}

		// Set initial toggle state on page load
		function initializeNotificationToggle() {
			console.log('initializeNotificationToggle()👨‍🚀')
			// alert('initializeNotificationToggle()👨‍🚀')
			const toggle = document.getElementById("notificationToggle");
			const notificationsEnabled = localStorage.getItem("notificationsEnabled");

			// Set toggle based on stored permission state
			toggle.checked = notificationsEnabled === "true";

			// Add event listener to request permission if toggled on
			toggle.addEventListener("change", () => {
				if (toggle.checked) {
					requestNotificationPermission();
					notificationMessage.classList.remove('alert-danger');
					notificationMessage.classList.add('alert-success');
					notificationMessage.textContent = 'Notifications are now enabled.';
					notificationMessage.style.display = 'block';
				} else {
					localStorage.setItem("notificationsEnabled", "false");
					notificationMessage.classList.remove('alert-success');
					notificationMessage.classList.add('alert-danger');
					notificationMessage.textContent = 'Notifications are now disabled.';
					notificationMessage.style.display = 'block';
				}
			});
		}

		// Call initializeNotificationToggle when the page loads
		document.addEventListener("DOMContentLoaded", initializeNotificationToggle);



		function showNotification(title, body) {
			if (Notification.permission === "granted") {
				const options = {
					body: body,
					icon: "img/logowt.png"  // Optional icon
				};
				new Notification(title, options);
			}
		}




		// CUANDO TODO CARGO< CARGA ALGUNOS EVENTLISTENERS

		


		/*********************************************************************************************
		  .) DOMContentLoaded
		  **********************************************************************************************/

		  document.addEventListener('DOMContentLoaded', function () {
			console.log('👂 listen DOMContentLoaded')
			const erc20Option = document.getElementById('erc20Option');
			const erc20Options = document.getElementById('erc20Options');
			const addErc20Address = document.getElementById('addErc20Address');
			const erc20Selector = document.getElementById('erc20Selector');
			const removeErc20Address = document.getElementById('removeErc20Address');
			const infoErc20Address = document.getElementById('infoErc20Address');


			//   ------------------------------------
			// .) LISTEN TO EDIT ALIAS NAME CHANGE
			//   ------------------------------------

			const aliasInput = document.getElementById('aliasName');
			const editButton = document.getElementById('editAlias');

			function enableEditing() {
				console.log('edit alias name')
				aliasInput.readOnly = false;
				editButton.textContent = 'Save';
			}

			async function disableEditing() {
				aliasInput.readOnly = true;
				editButton.textContent = 'Edit';
				// You can add additional code here to save the changes, e.g., sending data to the server
				// GET SIGNER
				let presigner = await getSigner()
				let provider = new ethers.JsonRpcProvider(`${optionsList[0].API}`); //v5
				let signer = presigner.connect(provider);
				console.log('SIGNER!:', signer);
				let did = `did:ius:${signer.address}`
				console.log('DID: ', did)

				// ---------------

				try {
					console.log('creating did RECORD, signer', signer)
					await updateAliasDID(did, aliasInput.value, signer)
					// updateAliasDID
				} catch (error) {
					console.error('An error occurred while creating DID record:', error);
					return
				}



				console.log('Alias name saved:', aliasInput.value);
			}

			editButton.addEventListener('click', function () {
				if (aliasInput.readOnly) {
					enableEditing();
				} else {
					disableEditing();
				}
			});


			//   ------------------------------------
			// .) LISTEN  STEALTH ADDRESS ALWAYS ON CHECKBOX
			//   ------------------------------------
			document.getElementById('stealthaddrAlwaysOnCheckbox').addEventListener('change',async function () {
				if (this.checked) {
					localStorage.setItem('stealthAddressAlwaysOn', 'true');
					console.warn('Stealth Address always on is ACTIVE and stored in localStorage');
				} else {
					localStorage.setItem('stealthAddressAlwaysOn', 'false');
					console.warn('Stealth Address always on is DISABLED and stored in localStorage');
				}


			});


			//   ------------------------------------
			// .) LISTEN TO STEALTH ADDRESS CHECKBOX CHANGE
			//   ------------------------------------
			document.getElementById('stealthAddressCheckbox').addEventListener('change',async function () {

				console.log('👮‍♂️ stealthAddressCheckbox CHANGED..')
				let recipientAddress;

				if (this.checked) {
					prepareStealthAddr()

				return

			 

				} else {
					// localStorage.setItem('stealthAddressActive', 'false');
					console.warn('Stealth Address disabled and stored in localStorage');
				recipientAddress = document.getElementById('recipientAddress').value;

				}

			});

			//   ------------------------------------
			// .) LISTEN TO TOKENTYPE CHANGES
			//   ------------------------------------
			// Show or hide ERC-20 options based on the selected radio button
			document.querySelectorAll('input[name="tokenType"]').forEach(function (input) {
				input.addEventListener('change', async function () {
					console.log('🎏 tokenType CHANGED!')
					localStorage.setItem('selectedTokenType', input.value);
					populateSelectInput()
					populateSelectInput('tokenType');//populate selec input inside wallet send

					if (erc20Option.checked) {
						erc20Options.style.display = 'block';
					} else {
						erc20Options.style.display = 'none';
					}


					try {
						await loadToken()
					} catch (error) {
						console.warn(error)
					}
					Toast.fire({ title: "Token loaded!", text: "The Token has been loaded.", icon: "success" });

				});
			});

			//   ------------------------------------
			// .) REMOVE TOKEN
			//   ------------------------------------
			removeErc20Address.addEventListener('click', function () {

				Swal.fire({ title: "Are you sure?", text: "You won't be able to revert this!", icon: "warning", showCancelButton: true, confirmButtonColor: "#3085d6", cancelButtonColor: "#d33", confirmButtonText: "Yes, delete it!" })
					.then((result) => {
						if (result.isConfirmed) {

							const selectedOption = erc20Selector.options[erc20Selector.selectedIndex];
							if (selectedOption) {
								// Retrieve the stored data from localStorage
								let index = selectedOption.value
								let i = Number(index)
								let storedData = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];
								console.log(storedData[i].contractAddr)

								// remove token from localStorage
								removeToken(storedData[i].contractAddr)

								// Remove from select
								selectedOption.remove();



							} else {
								console.log('DOES NOT EXSITS')
							}

							closeModalId('#defaultTokenModal')
							Toast.fire({ title: "Deleted!", text: "Token has been deleted.", icon: "success" });
							localStorage.setItem('preferredTokenIndex', 0);
							loadToken()
						}
					});



			});

			//   ------------------------------------
			// .) INFO TOKEN
			//   ------------------------------------
			// Show information about the selected ERC-20 contract
			infoErc20Address.addEventListener('click', function () {

				const selectedOption = erc20Selector.options[erc20Selector.selectedIndex];
				let index = selectedOption.value
				let i = Number(index)

				if (selectedOption) {
					// Retrieve the stored data from localStorage
					let storedData = JSON.parse(localStorage.getItem('ERC20_TOKENS')) || [];
					console.log(storedData[i])
					alert(`Info: ${JSON.stringify(storedData[i])}`);

				}
			});

		});



		/*********************************************************************************************
		.) FIN DOMContentLoaded
		**********************************************************************************************/


		   
function loadSettingsPreferences(){
	console.log('loadSettingsPreferences()')

		//   ------------------------------------
		// .) 🦹‍♂️↔️🦹‍♀️ Stealth addresses always on
		//   ------------------------------------
		const checkbox = document.getElementById("stealthaddrAlwaysOnCheckbox");

		const stealthAddressOn = localStorage.getItem('stealthAddressAlwaysOn');
			if (stealthAddressOn === 'true') {
				console.log('stealthAddressAlwaysOn is on')
				checkbox.checked = true;
			} else {
				console.log('stealthAddressAlwaysOn is off')
				checkbox.checked = false;
			}


}

// Cargar las entradas desde localStorage o usar los datos iniciales
window.onload = () => {
            // let savedEntries = JSON.parse(localStorage.getItem("blogEntries")) || initialEntries;
            // savedEntries.forEach(entry => addEntry(entry.title, entry.link, false));
        };

		

	</script>

	<!-- <script type="module" src="js/demo1.js"></script> -->

</body>

</html>